<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>观沧海</title>
  
  <subtitle>IT学习社</subtitle>
  <link href="https://blog.gcdd.top/atom.xml" rel="self"/>
  
  <link href="https://blog.gcdd.top/"/>
  <updated>2024-01-25T11:53:48.233Z</updated>
  <id>https://blog.gcdd.top/</id>
  
  <author>
    <name>gcdd1993</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/6/"/>
    <id>https://blog.gcdd.top/p/6/</id>
    <published>2024-01-25T11:53:18.874Z</published>
    <updated>2024-01-25T11:53:48.233Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>在日常版本控制操作中，时常会遇到因混淆不同场景下的身份信息而导致的邮件地址误用问题，例如，在提交企业内部项目时意外使用了个人邮箱地址，或是在向GitHub等公共平台提交代码时采用了公司专属邮箱。<br>为解决此类问题，期望实现一种自动化机制，使得Git在执行提交操作时能根据目标远程仓库的域名智能切换相应的邮箱配置，确保与项目及环境相匹配的身份标识得以正确运用。</p><h1 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h1><h2 id="认识Git-Hooks"><a href="#认识Git-Hooks" class="headerlink" title="认识Git Hooks"></a>认识Git Hooks</h2><p>Git Hook 是 Git 仓库中的一组脚本，它们允许你在特定的Git事件发生时执行自定义操作。这些脚本放置在 <code>.git/hooks</code> 目录下，并且每个脚本对应一个特定的Git生命周期事件。</p><p>以下是一些常见的 Git Hook 类型及其触发时机：</p><ol><li><p><strong>pre-commit</strong>: 在提交信息被记录之前运行。这个钩子可以用来进行代码格式检查、linting、单元测试等，如果脚本执行失败（返回非零退出码），则会阻止这次提交。</p></li><li><p><strong>prepare-commit-msg</strong>: 在编辑提交消息文件之前运行，可以用于修改或预填充提交消息。</p></li><li><p><strong>commit-msg</strong>: 当提交消息被创建后运行，可用于验证提交消息是否符合项目规范。</p></li><li><p><strong>post-commit</strong>: 提交完成后立即运行，通常用于更新其他系统或者触发后续动作。</p></li><li><p><strong>pre-receive</strong>: 在服务器端接收到推送请求之后但在实际接受提交之前运行，可以用于实现对推送内容的全局性预检。</p></li><li><p><strong>update</strong>: 同样是服务器端的 hook，在 pre-receive 之后调用，对于每一个更新到仓库中的分支都会执行一次，常用于实现更细粒度的访问控制和策略。</p></li><li><p><strong>post-receive</strong>: 推送操作完成后在服务器上运行，可用来触发构建、部署或其他后处理任务。</p></li><li><p><strong>pre-auto-gc</strong>: 在自动垃圾回收开始前运行，可以用来定制垃圾回收的行为。</p></li><li><p><strong>post-checkout</strong>：在完成 git checkout 或 git switch 命令后触发。</p></li></ol><p>每个 hook 脚本都是可执行文件（需要设置正确的执行权限），并且在执行时会传入相应的参数，以便获取关于所执行操作的详细信息。通过 Git Hook，开发者能够根据团队需求定制工作流程，确保遵循特定的开发规范和实践。</p><blockquote><p>基于Hook机制，我们可以使用post-checkout在代码拉取时自动按照域名设置不同的提交用户名</p></blockquote><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="全局设置必须配置用户名邮箱"><a href="#全局设置必须配置用户名邮箱" class="headerlink" title="全局设置必须配置用户名邮箱"></a>全局设置必须配置用户名邮箱</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.useConfigOnly <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>并且删除全局的 user.name 和 user.email 配置，所有的全局配置都在 ~/.gitconfig 文件中，删除[user]下的用户名和邮箱配置。<br>然后使用git config查看一下是否删除成功。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br><span class="line">...</span><br><span class="line">user.useconfigonly=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="设置-git-hooks-templates-目录"><a href="#设置-git-hooks-templates-目录" class="headerlink" title="设置 git hooks templates 目录"></a>设置 git hooks templates 目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p ~/.git-templates/hooks</span><br><span class="line">git config --global init.templatedir ~/.git-templates</span><br></pre></td></tr></table></figure><h3 id="配置post-checkout脚本"><a href="#配置post-checkout脚本" class="headerlink" title="配置post-checkout脚本"></a>配置post-checkout脚本</h3><p>在<code>~/.git-templates/hooks</code>目录里新建<code>post-checkout</code>文件，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$1</span> == 00000000000* ]]; <span class="keyword">then</span></span><br><span class="line">      remote=`git remote -v | awk <span class="string">&#x27;/\(push\)$/ &#123;print $2&#125;&#x27;</span>`</span><br><span class="line">      email=xxx@gmail.com <span class="comment"># 默认邮箱</span></span><br><span class="line">      name=<span class="string">&quot;xxx&quot;</span> <span class="comment"># 默认提交用户名</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$remote</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> [[ <span class="variable">$remote</span> =~ <span class="string">&#x27;公司git域名&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        email=xxxx@xxx.com <span class="comment"># 该域名使用的邮箱</span></span><br><span class="line">        name=<span class="string">&quot;xxxx&quot;</span> <span class="comment"># 该域名使用的用户名</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      </span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;Configuring user &lt;name: <span class="variable">$name</span> email: <span class="variable">$email</span>&gt;&quot;</span></span><br><span class="line">      git config user.email <span class="string">&quot;<span class="variable">$email</span>&quot;</span></span><br><span class="line">      git config user.name  <span class="string">&quot;<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>配置完成后，测试一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> ssh://git@xxxx.com/xxxx.git</span><br><span class="line">Cloning into <span class="string">&#x27;xxxx&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 1284, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (1284/1284), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (828/828), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 265979 (delta 275), reused 423 (delta 18)</span><br><span class="line">Receiving objects: 100% (265979/265979), 61.32 MiB | 2.00 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (98214/98214), <span class="keyword">done</span>.</span><br><span class="line">ssh://git@xxxx.com/xxxx.git</span><br><span class="line">Configuring user &lt;name: xxxx email: xxxx@xxxx.com&gt;</span><br></pre></td></tr></table></figure><p>至此就配置完毕了，以后在拉取代码或切换分支的时候，会自动根据域名判断使用的用户名，不会再出错了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h1&gt;&lt;p&gt;在日常版本控制操作中，时常会遇到因混淆不同场景下的身份信息而导致的邮件地址误用问题，例如，在提交企业内部项目时意外使用了个人</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/4/"/>
    <id>https://blog.gcdd.top/p/4/</id>
    <published>2023-08-31T01:41:02.925Z</published>
    <updated>2024-01-25T09:08:27.041Z</updated>
    
    <content type="html"><![CDATA[<h1 id="树的基本定义"><a href="#树的基本定义" class="headerlink" title="树的基本定义"></a>树的基本定义</h1><p>树是我们计算机中非常重要的一种数据结构，同时使用树这种数据结构，可以描述现实生活中的很多事物，例如家谱、单位的组织架构、等等。<br>树是由n（n&gt;=1）个有限结点组成一个具有层次关系的集合。把它叫做“树”是因为它看起来像一棵倒挂的树，也就是说它是根朝上，而叶朝下的。</p><p><img src="https://img.gcdd.top/img/b6ca35a60a064d70a3c0b9c5452320c1~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228214223511"></p><p>树具有以下特点：</p><ol><li>每个结点有零个或多个子结点；</li><li>没有父结点的结点为根结点；</li><li>每一个非根结点只有一个父结点；</li><li>每个结点及其后代结点整体上可以看做是一棵树，称为当前结点的父结点的一个子树；</li></ol><h1 id="树的相关术语"><a href="#树的相关术语" class="headerlink" title="树的相关术语"></a>树的相关术语</h1><ul><li>结点的度：一个结点含有的子树的个数称为该结点的度。</li><li>树的度：树中所有结点的度的最大值。</li><li>叶子结点：度为0的结点称为叶结点，也可以叫做终端结点。</li><li>分支结点：度不为0的结点称为分支结点，也可以叫做非终端结点。</li></ul><p><img src="https://img.gcdd.top/img/545666d38e64491da9c47c59623a8a44~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228221436242"></p><ul><li>结点的层次：从根结点开始，根结点的层次为1，根的直接后继层次为2，以此类推。</li><li>结点的层序编号：将树中的结点，按照从上层到下层，同层从左到右的次序排成一个线性序列，把他们编成连续的自然数。</li><li>树的高度（深度）：树中结点的最大层次。</li></ul><p><img src="https://img.gcdd.top/img/9d1ce633f183494dbffe6fc3f25a9b97~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228221546841"></p><ul><li>森林：m（m&gt;=0）个互不相交的树的集合，将一颗非空树的根结点删去，树就变成一个森林；给森林增加一个统一的根结点，森林就变成一棵树</li></ul><p><img src="https://img.gcdd.top/img/c485ed211b894300bdcb504d5fcca37e~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228214459214"></p><ul><li>孩子结点：一个结点的直接后继结点称为该结点的孩子结点。</li><li>双亲结点（父结点）：一个结点的直接前驱称为该结点的双亲结点。</li><li>兄弟结点：同一双亲结点的孩子结点间互称兄弟结点。</li></ul><p><img src="https://img.gcdd.top/img/efa3b39f13874de09886aa18726b965b~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228221503007"></p><h1 id="二叉树的基本定义"><a href="#二叉树的基本定义" class="headerlink" title="二叉树的基本定义"></a>二叉树的基本定义</h1><p>二叉树就是度不超过2的树（每个结点最多有两个子结点）</p><p><img src="https://img.gcdd.top/img/fe2985e9f1bb4b109996d5c5da2a3801~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228222007656"></p><h2 id="满二叉树"><a href="#满二叉树" class="headerlink" title="满二叉树"></a>满二叉树</h2><p>在一棵二叉树中，如果所有分支结点都存在左子树和右子树，并且所有叶子都在同一层上，这样的二叉树称为满二叉树。</p><p><img src="https://img.gcdd.top/img/bf25082c6194438787e010d9a5cfe346~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228222025240"></p><h2 id="完全二叉树"><a href="#完全二叉树" class="headerlink" title="完全二叉树"></a>完全二叉树</h2><p>叶子节点只能出现在最下层和次下层，并且最下面一层的结点都集中在该层最左边的若干位置的二叉树。</p><p><img src="https://img.gcdd.top/img/7fa039ac2afd4baeaa99b56caa9d120f~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228222042138"></p><blockquote><p>满二叉树一定是一棵完全二叉树，但完全二叉树不一定是满的。</p></blockquote><h3 id="判断某二叉树是否是完全二叉树"><a href="#判断某二叉树是否是完全二叉树" class="headerlink" title="判断某二叉树是否是完全二叉树"></a>判断某二叉树是否是完全二叉树</h3><p>完全二叉树的特点：</p><ol><li>叶子结点只能出现在最下两层。</li><li>最下层的叶子一定集中在左部连续位置。</li><li>倒数二层，若有叶子结点，一定都在右部连续位置。</li><li>如果结点度为1，则该结点只有左孩子，即不存在只有右子树的情况。</li><li>同样结点数的二叉树，完全二叉树的深度最小。</li></ol><p>给每个结点按照满二叉树的结构逐层顺序编号，如果编号出现空档，就说明不是完全二叉树，否则就是。</p><h1 id="二叉查找树的创建"><a href="#二叉查找树的创建" class="headerlink" title="二叉查找树的创建"></a>二叉查找树的创建</h1><h2 id="二叉树的结点类"><a href="#二叉树的结点类" class="headerlink" title="二叉树的结点类"></a>二叉树的结点类</h2><p>根据对图的观察，我们发现二叉树其实就是由一个一个的结点及其之间的关系组成的，按照面向对象的思想，我们设计一个结点类来描述结点这个事物。</p><h3 id="结点类设计"><a href="#结点类设计" class="headerlink" title="结点类设计"></a>结点类设计</h3><table><thead><tr><th>类名</th><th><code>Node&lt;K, V&gt;</code></th></tr></thead><tbody><tr><td>构造方法</td><td><code>Node(K key, V value, Node&lt;K, V&gt; left, Node&lt;K, V&gt; right)</code>：创建Node对象</td></tr><tr><td>成员变量</td><td><code>private Node&lt;K, V&gt; left</code>：记录左子结点<br/><code>private Node&lt;K, V&gt; right</code>：记录右子结点<br/><code>private K key</code>：存储键<br/><code>private V value</code>：存储值</td></tr></tbody></table><h3 id="结点类代码实现"><a href="#结点类代码实现" class="headerlink" title="结点类代码实现"></a>结点类代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二叉查找树结点</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;K&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;V&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line">    <span class="keyword">private</span> V value;</span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; left;</span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="二叉查找树设计"><a href="#二叉查找树设计" class="headerlink" title="二叉查找树设计"></a>二叉查找树设计</h2><table><thead><tr><th>类名</th><th><code>BinaryTree&lt;K extends Comparable&lt;K&gt;, V&gt;</code></th></tr></thead><tbody><tr><td>构造方法</td><td><code>BinaryTree()</code>：创建<code>BinaryTree</code>对象</td></tr><tr><td>成员变量</td><td><code>private Node&lt;K, V&gt; root</code>：记录根结点<br/><code>private int n</code>：记录树中元素的个数</td></tr><tr><td>成员方法</td><td><code>public void put(K key,V value)</code>：向树中插入一个键值对<br/><code>private Node put(Node&lt;K, V&gt; x, K key, V value)</code>：给指定树x上，添加键一个键值对，并返回添加后的新树<br/><code>public V get(K key)</code>：根据key，从树中找出对应的值<br/><code>private V get(Node&lt;K, V&gt; x, K key)</code>：从指定的树x中，找出key对应的值<br/><code>public void delete(K key)</code>：根据key，删除树中对应的键值对<br/><code>private Node delete(Node&lt;K, V&gt; x, K key)</code>：删除指定树x上的键为key的键值对，并返回删除后的新树<br/><code>public int size()</code>：获取树中元素的个数</td></tr></tbody></table><h2 id="二叉查找树代码实现"><a href="#二叉查找树代码实现" class="headerlink" title="二叉查找树代码实现"></a>二叉查找树代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinaryTree</span>&lt;K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录根结点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录树中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BinaryTree</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入一个键值对</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        root = put(root, key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.如果当前树中没有任何一个结点，则直接把新结点当做根结点使用</span></span><br><span class="line"><span class="comment">     * 2.如果当前树不为空，则从根结点开始:</span></span><br><span class="line"><span class="comment">     * 2.1 如果新结点的key小于当前结点的key，则继续找当前结点的左子结点</span></span><br><span class="line"><span class="comment">     * 2.2 如果新结点的key大于当前结点的key，则继续找当前结点的右子结点</span></span><br><span class="line"><span class="comment">     * 2.3 如果新结点的key等于当前结点的key，则树中已经存在这样的结点，替换该结点的value值即可</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; <span class="title function_">put</span><span class="params">(Node&lt;K, V&gt; x, K key, V value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">            n++;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(key, value, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">cmp</span> <span class="operator">=</span> key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 找右子树</span></span><br><span class="line">            x.right = put(x.right, key, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 找左子树</span></span><br><span class="line">            x.left = put(x.left, key, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 替换值</span></span><br><span class="line">            x.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> get(root, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> V <span class="title function_">get</span><span class="params">(Node&lt;K, V&gt; x, K key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">cmp</span> <span class="operator">=</span> key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(x.right, key);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(x.left, key);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        delete(root, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 找到被删除结点</span></span><br><span class="line"><span class="comment">     * 2. 找到被删除结点右子树中的最小结点minNode</span></span><br><span class="line"><span class="comment">     * 3. 删除右子树中的最小结点</span></span><br><span class="line"><span class="comment">     * 4. 让被删除结点的左子树称为最小结点minNode的左子树，让被删除结点的右子树称为最小结点minNode的右子树</span></span><br><span class="line"><span class="comment">     * 5. 让被删除结点的父节点指向最小结点minNode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; <span class="title function_">delete</span><span class="params">(Node&lt;K, V&gt; x, K key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">cmp</span> <span class="operator">=</span> key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 找右子树</span></span><br><span class="line">            x.right = delete(x.right, key);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 找左子树</span></span><br><span class="line">            x.left = delete(x.left, key);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 先找到右子树中最小的结点</span></span><br><span class="line">            n--;</span><br><span class="line">            <span class="keyword">if</span> (x.right == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> x.left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (x.left == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> x.right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 遍历获取右子树最左结点</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">minNode</span> <span class="operator">=</span> min(x.right);</span><br><span class="line">            <span class="comment">// 删除右子树中最小的节点</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">n</span> <span class="operator">=</span> x.right;</span><br><span class="line">            <span class="keyword">while</span> (n.left != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (n.left.left == <span class="literal">null</span>) &#123;</span><br><span class="line">                    n.left = <span class="literal">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    n = n.left;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 让x结点的左子树成为minNode的左子树</span></span><br><span class="line">            minNode.left = x.left;</span><br><span class="line">            <span class="comment">// 让x结点的右子树成为minNode的右子树</span></span><br><span class="line">            minNode.right = x.right;</span><br><span class="line">            <span class="comment">// 让x节点的父节点指向minNode</span></span><br><span class="line">            x = minNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Node&lt;K, V&gt; <span class="title function_">min</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> min(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; <span class="title function_">min</span><span class="params">(Node&lt;K, V&gt; x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> min(x.left);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Node&lt;K, V&gt; <span class="title function_">max</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> max(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; <span class="title function_">max</span><span class="params">(Node&lt;K, V&gt; x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> max(x.right);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 二叉查找树结点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;K&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> K key;</span><br><span class="line">        <span class="keyword">private</span> V value;</span><br><span class="line">        <span class="keyword">private</span> Node&lt;K, V&gt; left;</span><br><span class="line">        <span class="keyword">private</span> Node&lt;K, V&gt; right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="插入方法put实现思想"><a href="#插入方法put实现思想" class="headerlink" title="插入方法put实现思想"></a>插入方法<code>put</code>实现思想</h3><ol><li><p>如果当前树中没有任何一个结点，则直接把新结点当做根结点使用</p></li><li><p>如果当前树不为空，则从根结点开始：</p><ol><li><p>如果新结点的key小于当前结点的key，则继续找当前结点的左子结点；</p></li><li><p>如果新结点的key大于当前结点的key，则继续找当前结点的右子结点；</p></li><li><p>如果新结点的key等于当前结点的key，则树中已经存在这样的结点，替换该结点的value值即可。</p></li></ol></li></ol><p><img src="https://img.gcdd.top/img/8ca4349f1b744385a3a40599c36a4f1e~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228223827687"></p><h3 id="查询方法get实现思想"><a href="#查询方法get实现思想" class="headerlink" title="查询方法get实现思想"></a>查询方法<code>get</code>实现思想</h3><p>从根节点开始：</p><ol><li>如果要查询的key小于当前结点的key，则继续找当前结点的左子结点；</li><li>如果要查询的key大于当前结点的key，则继续找当前结点的右子结点；</li><li>如果要查询的key等于当前结点的key，则树中返回当前结点的value。</li></ol><h3 id="删除方法delete实现思想"><a href="#删除方法delete实现思想" class="headerlink" title="删除方法delete实现思想"></a>删除方法<code>delete</code>实现思想</h3><ol><li>找到被删除结点；</li><li>找到被删除结点右子树中的最小结点<code>minNode</code></li><li>删除右子树中的最小结点</li><li>让被删除结点的左子树称为最小结点<code>minNode</code>的左子树，让被删除结点的右子树称为最小结点<code>minNode</code>的右子树</li><li>让被删除结点的父节点指向最小结点<code>minNode</code></li></ol><p><img src="https://img.gcdd.top/img/cadf14444ce84d1a8e9797fedabcd49a~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228224035173"></p><h1 id="二叉树的基础遍历"><a href="#二叉树的基础遍历" class="headerlink" title="二叉树的基础遍历"></a>二叉树的基础遍历</h1><p>很多情况下，我们可能需要像遍历数组数组一样，遍历树，从而拿出树中存储的每一个元素，由于树状结构和线性结构不一样，它没有办法从头开始依次向后遍历，所以存在如何遍历，也就是按照什么样的搜索路径进行遍历的问题。</p><p><img src="https://img.gcdd.top/img/9191604653ce44b1a1bf0456c7304a28~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228224259032"></p><p>我们把树简单的画作上图中的样子，由一个根节点、一个左子树、一个右子树组成，那么按照根节点什么时候被访问，我们可以把二叉树的遍历分为以下三种方式：</p><ol><li>前序遍历：先访问根结点，然后再访问左子树，最后访问右子树</li><li>中序遍历：先访问左子树，中间访问根节点，最后访问右子树</li><li>后序遍历：先访问左子树，再访问右子树，最后访问根节点</li></ol><p>如果我们分别对下面的树使用三种遍历方式进行遍历，得到的结果如下：</p><p><img src="https://img.gcdd.top/img/1d1d1bd80ee74074acba2b7245a61ace~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228224519415"></p><p>学习二叉树的遍历，一定要有<strong>递归思想</strong>，比如前序遍历，本质顺序是：根→左→右，先访问E，然后访问B，但是B也是一棵树，此时思维应该转换到以B为根结点的子树上，所以B下面是访问A。</p><h2 id="前序遍历"><a href="#前序遍历" class="headerlink" title="前序遍历"></a>前序遍历</h2><blockquote><p>根节点第一个（前面）访问，所以叫前序遍历</p></blockquote><p>实现步骤：</p><ol><li>把当前结点的key放入到队列中</li><li>找到当前结点的左子树，如果不为空，递归遍历左子树</li><li>找到当前结点的右子树，如果不为空，递归遍历右子树</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用前序遍历，获取整个树中的所有键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;K&gt; <span class="title function_">preErgodic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">keys</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;K&gt;();</span><br><span class="line">    preErgodic(root, keys);</span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用前序遍历，把指定树x中的所有键放入到keys队列中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">preErgodic</span><span class="params">(Node&lt;K, V&gt; x, Queue&lt;K&gt; keys)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把x结点的key放入queue</span></span><br><span class="line">    keys.add(x.key);</span><br><span class="line">    preErgodic(x.left, keys);</span><br><span class="line">    preErgodic(x.right, keys);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="中序遍历"><a href="#中序遍历" class="headerlink" title="中序遍历"></a>中序遍历</h2><blockquote><p>根节点在第二个（中间）访问，所以叫中序遍历</p></blockquote><p>实现步骤：</p><ol><li>找到当前结点的左子树，如果不为空，递归遍历左子树</li><li>把当前结点的key放入到队列中;</li><li>找到当前结点的右子树，如果不为空，递归遍历右子树</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用中序遍历，获取整个树中的所有键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;K&gt; <span class="title function_">midErgodic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">keys</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;K&gt;();</span><br><span class="line">    midErgodic(root, keys);</span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">midErgodic</span><span class="params">(Node&lt;K, V&gt; x, Queue&lt;K&gt; keys)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    midErgodic(x.left, keys);</span><br><span class="line">    <span class="comment">// 把x结点的key放入queue</span></span><br><span class="line">    keys.add(x.key);</span><br><span class="line">    midErgodic(x.right, keys);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="后序遍历"><a href="#后序遍历" class="headerlink" title="后序遍历"></a>后序遍历</h2><blockquote><p>根节点在第三个（后面）访问，所以叫中序遍历</p></blockquote><p>实现步骤：</p><ol><li>找到当前结点的左子树，如果不为空，递归遍历左子树</li><li>找到当前结点的右子树，如果不为空，递归遍历右子树</li><li>把当前结点的key放入到队列中</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用后序遍历，获取整个树中的所有键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;K&gt; <span class="title function_">postErgodic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">keys</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;K&gt;();</span><br><span class="line">    postErgodic(root, keys);</span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postErgodic</span><span class="params">(Node&lt;K, V&gt; x, Queue&lt;K&gt; keys)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    postErgodic(x.left, keys);</span><br><span class="line">    postErgodic(x.right, keys);</span><br><span class="line">    <span class="comment">// 把x结点的key放入queue</span></span><br><span class="line">    keys.add(x.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="二叉树的层序遍历"><a href="#二叉树的层序遍历" class="headerlink" title="二叉树的层序遍历"></a>二叉树的层序遍历</h1><p>所谓的层序遍历，就是从根节点（第一层）开始，依次向下，获取每一层所有结点的值，有二叉树如下：</p><p><img src="https://img.gcdd.top/img/4bf1a273afb04f24a6f003e7e9aff837~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228225436243"></p><p>那么层序遍历的结果是：<code>EBGADFHC</code></p><p>实现步骤：</p><ol><li><p>创建队列，存储每一层的结点；</p></li><li><p>使用循环从队列中弹出一个结点：</p><ol><li><p>获取当前结点的key；</p></li><li><p>如果当前结点的左子结点不为空，则把左子结点放入到队列中</p></li><li><p>如果当前结点的右子结点不为空，则把右子结点放入到队列中</p></li></ol></li></ol><p><img src="https://img.gcdd.top/img/28f5dda4ef1e4fa2a629e13cef0b9a04~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228225531156"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 层序遍历</span></span><br><span class="line"><span class="comment"> * 1.创建队列，存储每一层的结点；</span></span><br><span class="line"><span class="comment"> * 2.使用循环从队列中弹出一个结点：</span></span><br><span class="line"><span class="comment"> * 2.1 获取当前结点的key；</span></span><br><span class="line"><span class="comment"> * 2.2 如果当前结点的左子结点不为空，则把左子结点放入到队列中</span></span><br><span class="line"><span class="comment"> * 2.3 如果当前结点的右子结点不为空，则把右子结点放入到队列中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;K&gt; <span class="title function_">layerErgodic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">keys</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;K&gt;();</span><br><span class="line">    <span class="type">var</span> <span class="variable">nodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Node&lt;K, V&gt;&gt;();</span><br><span class="line">    nodes.add(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!nodes.isEmpty()) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">node</span> <span class="operator">=</span> nodes.pop();</span><br><span class="line">        keys.add(node.key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            nodes.add(node.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            nodes.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="二叉树的最大深度问题"><a href="#二叉树的最大深度问题" class="headerlink" title="二叉树的最大深度问题"></a>二叉树的最大深度问题</h1><p>给定一棵树，请计算树的最大深度（树的根节点到最远叶子结点的最长路径上的结点数）</p><p><img src="https://img.gcdd.top/img/f56a61dd0c5a49ce917ac88aed760679~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228225714790"></p><p>上面这棵树的最大深度为4。</p><h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><ol><li>如果根结点为空，则最大深度为0；</li><li>计算左子树的最大深度；</li><li>计算右子树的最大深度；</li><li>当前树的最大深度=左子树的最大深度和右子树的最大深度中的较大者+1</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算整个树的最大深度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxDepth</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> maxDepth(root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算指定树x的最大深度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">maxDepth</span><span class="params">(Node&lt;K, V&gt; x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">var</span> <span class="variable">maxL</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">var</span> <span class="variable">maxR</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算左子树的最大深度</span></span><br><span class="line">    <span class="keyword">if</span> (x.left != <span class="literal">null</span>) &#123;</span><br><span class="line">        maxL = maxDepth(x.left);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算右子树的最大深度</span></span><br><span class="line">    <span class="keyword">if</span> (x.right != <span class="literal">null</span>) &#123;</span><br><span class="line">        maxR = maxDepth(x.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比较左右子数的最大深度</span></span><br><span class="line">    <span class="keyword">return</span> Math.max(maxL, maxR) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="折纸问题"><a href="#折纸问题" class="headerlink" title="折纸问题"></a>折纸问题</h1><p>请把一段纸条竖着放在桌子上，然后从纸条的下边向上方对折1次，压出折痕后展开。此时折痕是凹下去的，即折痕突起的方向指向纸条的背面。如果从纸条的下边向上方连续对折2 次，压出折痕后展开，此时有三条折痕，从上到下依次是下折痕、下折痕和上折痕。</p><p>给定一 个输入参数N，代表纸条都从下边向上方连续对折n次，请从上到下打印所有折痕的方向。</p><p>例如：n=1时，打印： down；n=2时，打印： down down up</p><p><img src="https://img.gcdd.top/img/1dcba4d2f7714b6fbe2526c883650d82~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228225956562"></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>我们把对折后的纸张翻过来，让粉色朝下，这时把第一次对折产生的折痕看做是根结点，那第二次对折产生的下折痕就是该结点的左子结点，而第二次对折产生的上折痕就是该结点的右子结点，这样我们就可以使用树型数据结构来描述对折后产生的折痕。</p><p>这棵树有这样的特点：</p><ol><li>根结点为下折痕；</li><li>每一个结点的左子结点为下折痕；</li><li>每一个结点的右子结点为上折痕；</li></ol><p><img src="https://img.gcdd.top/img/f740c1d482314c51b86594c2a71e0dd7~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228230029351"></p><h2 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h2><ol><li>定义结点类</li><li>构建深度为n的折痕树；<ol><li>第一次对折，只有一条折痕，创建根结点；</li><li>如果不是第一次对折，则使用队列保存根结点；</li><li>循环遍历队列：<ol><li>从队列中拿出一个结点；</li><li>如果这个结点的左子结点不为空，则把这个左子结点添加到队列中；</li><li>如果这个结点的右子结点不为空，则把这个右子结点添加到队列中；</li><li>判断当前结点的左子结点和右子结点都不为空，如果是，则需要为当前结点创建一个值为<code>down</code>的左子结点，一个值为up的右子结点。</li></ol></li></ol></li><li>使用中序遍历，打印出树中所有结点的内容；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PagerFolding</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建深度为n的折痕树</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n 深度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 折痕树</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Node&lt;String&gt; <span class="title function_">createTree</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        Node&lt;String&gt; root = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 1.第一次对折，只有一条折痕，创建根结点；</span></span><br><span class="line">                root = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="string">&quot;down&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2.如果不是第一次对折，则使用队列保存根结点；</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">nodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Node&lt;String&gt;&gt;();</span><br><span class="line">            nodes.add(root);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.循环遍历队列：</span></span><br><span class="line">            <span class="keyword">while</span> (!nodes.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//3.1从队列中拿出一个结点</span></span><br><span class="line">                <span class="type">var</span> <span class="variable">temp</span> <span class="operator">=</span> nodes.pop();</span><br><span class="line">                <span class="comment">//3.2如果这个结点的左子结点不为空，则把这个左子结点添加到队列中；</span></span><br><span class="line">                <span class="keyword">if</span> (temp.left != <span class="literal">null</span>) &#123;</span><br><span class="line">                    nodes.add(temp.left);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.3如果这个结点的右子结点不为空，则把这个右子结点添加到队列中；</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (temp.right != <span class="literal">null</span>) &#123;</span><br><span class="line">                    nodes.add(temp.right);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.4判断当前结点的左子结点和右子结点都不为空，如果是，则需要为当前结点创建一个值为down的左子结点，一个值为up的右子结点。</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    temp.left = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="string">&quot;down&quot;</span>);</span><br><span class="line">                    temp.right = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="string">&quot;up&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用中序遍历打印结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printTree</span><span class="params">(Node&lt;String&gt; x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (x.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            printTree(x.left);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(x.value + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (x.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            printTree(x.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 二叉查找树结点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 值类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> T value;</span><br><span class="line">        <span class="keyword">private</span> Node&lt;T&gt; left;</span><br><span class="line">        <span class="keyword">private</span> Node&lt;T&gt; right;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(T value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PagerFoldingTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTree</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">pagerFolding</span> <span class="operator">=</span> PagerFolding.createTree(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">// down down up down up down up </span></span><br><span class="line">        PagerFolding.printTree(pagerFolding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;树的基本定义&quot;&gt;&lt;a href=&quot;#树的基本定义&quot; class=&quot;headerlink&quot; title=&quot;树的基本定义&quot;&gt;&lt;/a&gt;树的基本定义&lt;/h1&gt;&lt;p&gt;树是我们计算机中非常重要的一种数据结构，同时使用树这种数据结构，可以描述现实生活中的很多事物，例如家谱、单位</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/3/"/>
    <id>https://blog.gcdd.top/p/3/</id>
    <published>2023-08-30T08:28:42.937Z</published>
    <updated>2024-01-25T09:08:27.040Z</updated>
    
    <content type="html"><![CDATA[<h1 id="符号表定义"><a href="#符号表定义" class="headerlink" title="符号表定义"></a>符号表定义</h1><p>符号表最主要的目的就是将一个键和一个值联系起来，符号表能够将存储的数据元素是一个键和一个值共同组成的键值对数据，我们可以根据键来查找对应的值。</p><p><img src="https://img.gcdd.top/images/20230830/5bd964d7538b44039e5b9663bf9c17b0.png?imageView2/0/interlace/1/q/50%7Cimageslim" alt="img.png"></p><p>符号表中，键具有唯一性。<br>符号表在实际生活中的使用场景是非常广泛的，见下表：</p><table><thead><tr><th>应用</th><th>查找目的</th><th>键</th><th>值</th></tr></thead><tbody><tr><td>字典</td><td>找出单词的释义</td><td>单词</td><td>释义</td></tr><tr><td>图书索引</td><td>找出某个术语相关的页码</td><td>术语</td><td>一串页码</td></tr><tr><td>网络搜索</td><td>找出某个关键字对应的网页</td><td>关键字</td><td>网页名称</td></tr></tbody></table><h1 id="符号表实现"><a href="#符号表实现" class="headerlink" title="符号表实现"></a>符号表实现</h1><h2 id="结点类设计"><a href="#结点类设计" class="headerlink" title="结点类设计"></a>结点类设计</h2><table><thead><tr><th>类名</th><th><code>Node&lt;K, V&gt;</code></th></tr></thead><tbody><tr><td>构造方法</td><td><code>Node(K key, V value, Node&lt;K, V&gt; next)</code>：创建Node对象</td></tr><tr><td>成员变量</td><td><code>private K key</code>：存储键<br/><code>private V value</code>：存储值<br/><code>private Node&lt;K, V&gt; next</code>：存储下一个结点</td></tr></tbody></table><h2 id="结点类代码实现"><a href="#结点类代码实现" class="headerlink" title="结点类代码实现"></a>结点类代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="comment">//键</span></span><br><span class="line">    <span class="keyword">public</span> K key;</span><br><span class="line">    <span class="comment">//值</span></span><br><span class="line">    <span class="keyword">public</span> V value;</span><br><span class="line">    <span class="comment">//下一个结点</span></span><br><span class="line">    <span class="keyword">public</span> Node&lt;K, V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="符号表设计"><a href="#符号表设计" class="headerlink" title="符号表设计"></a>符号表设计</h2><table><thead><tr><th>类名</th><th><code>SymbolTable&lt;K, V&gt;</code></th></tr></thead><tbody><tr><td>成员方法</td><td><code>public V get(K key)</code>：根据键key，找对应的值<br/><code>public void put(K key,V value)</code>：向符号表中插入一个键值对<br/><code>public void delete(K key)</code>：删除键为key的键值对<br/><code>public int size()</code>：获取符号表的大小</td></tr><tr><td>成员变量</td><td><code>private Node head</code>：记录首结点<br/><code>private int n</code>：记录符号表中键值对的个数</td></tr></tbody></table><h2 id="符号表代码实现"><a href="#符号表代码实现" class="headerlink" title="符号表代码实现"></a>符号表代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SymbolTable</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K, V&gt; head;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SymbolTable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据键key，找对应的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="comment">// 符号表中存在key，找到key</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span> (node.next != <span class="literal">null</span>) &#123;</span><br><span class="line">            node = node.next;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, node.key)) &#123;</span><br><span class="line">                <span class="keyword">return</span> node.value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="comment">// 符号表中存在key，找到key替换值</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span> (node.next != <span class="literal">null</span>) &#123;</span><br><span class="line">            node = node.next;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, node.key)) &#123;</span><br><span class="line">                node.value = value;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不存在，新建结点</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">oldFirst</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(key, value, oldFirst);</span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="comment">// 符号表中存在key，找到key删除之</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span> (node.next != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(key, node.next.key)) &#123;</span><br><span class="line">                node.next = node.next.next;</span><br><span class="line">                n--;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            node = node.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt; &#123;</span><br><span class="line">        <span class="comment">//键</span></span><br><span class="line">        <span class="keyword">public</span> K key;</span><br><span class="line">        <span class="comment">//值</span></span><br><span class="line">        <span class="keyword">public</span> V value;</span><br><span class="line">        <span class="comment">//下一个结点</span></span><br><span class="line">        <span class="keyword">public</span> Node&lt;K, V&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="有序符号表实现"><a href="#有序符号表实现" class="headerlink" title="有序符号表实现"></a>有序符号表实现</h1><p>刚才实现的符号表，我们可以称之为无序符号表，因为在插入的时候，并没有考虑键值对的顺序，而在实际生活中，有时候我们需要根据键的大小进行排序，插入数据时要考虑顺序，那么接下来我们就实现一下有序符号表。</p><h2 id="泛型K实现Comparable接口"><a href="#泛型K实现Comparable接口" class="headerlink" title="泛型K实现Comparable接口"></a>泛型K实现<code>Comparable</code>接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderedSymbolTable</span>&lt;K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;, V&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="修改put方法，使插入的元素K有序"><a href="#修改put方法，使插入的元素K有序" class="headerlink" title="修改put方法，使插入的元素K有序"></a>修改<code>put</code>方法，使插入的元素K有序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">current</span> <span class="operator">=</span> head.next; <span class="comment">// 记录当前结点</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">pre</span> <span class="operator">=</span> head; <span class="comment">// 记录上一个结点</span></span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">null</span> &amp;&amp; key.compareTo(current.key) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pre = current;</span><br><span class="line">        current = current.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果key和当前节点一致，修改</span></span><br><span class="line">    <span class="keyword">if</span> (current != <span class="literal">null</span> &amp;&amp; key.compareTo(current.key) == <span class="number">0</span>) &#123;</span><br><span class="line">        current.value = value;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有找到相同的key，把新结点插入到curr之前</span></span><br><span class="line">    pre.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(key, value, current);</span><br><span class="line">    n++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试结果正确</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/beb1b1293d994db6b50d3a00135ca16d~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20221228212551550"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;符号表定义&quot;&gt;&lt;a href=&quot;#符号表定义&quot; class=&quot;headerlink&quot; title=&quot;符号表定义&quot;&gt;&lt;/a&gt;符号表定义&lt;/h1&gt;&lt;p&gt;符号表最主要的目的就是将一个键和一个值联系起来，符号表能够将存储的数据元素是一个键和一个值共同组成的键值对数据，我们</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/2/"/>
    <id>https://blog.gcdd.top/p/2/</id>
    <published>2023-08-30T04:52:53.896Z</published>
    <updated>2024-01-25T09:08:27.040Z</updated>
    
    <content type="html"><![CDATA[<h1 id="算法的特性"><a href="#算法的特性" class="headerlink" title="算法的特性"></a>算法的特性</h1><blockquote><p>算法具有五个基本特性：输入、输出、有穷性、确定性和可行性。</p></blockquote><h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><ul><li>算法具有零个或多个输入</li><li>至少有一个或多个输出：算法是一定需要输出的，不需要输出，你用这个算法干吗？</li></ul><h2 id="有穷性"><a href="#有穷性" class="headerlink" title="有穷性"></a>有穷性</h2><blockquote><p>指算法在执行有限的步骤之后，自动结束而不会出现无限循环，并且每一个步骤在可接受的时间内完成。现实中经常会写出死循环的代码，这就是不满足有穷性。</p></blockquote><p>你说你写一个算法，计算机需要算上个二十年，一定会结束，它在数学意义上是有穷了，可是媳妇都熬成婆了，算法的意义也不就大了。</p><h2 id="确定性"><a href="#确定性" class="headerlink" title="确定性"></a>确定性</h2><blockquote><p>算法的每一步骤都具有确定的含义，不会出现二义性。</p></blockquote><p>算法在一定条件下，只有一条执行路径，相同的输入只能有唯一的输出结果。算法的每个步骤被精确定义而无歧义。</p><h2 id="可行性"><a href="#可行性" class="headerlink" title="可行性"></a>可行性</h2><blockquote><p>算法的每一步都必须是可行的，也就是说，每一步都能够通过执行有限次数完成。</p></blockquote><p>可行性意味着算法可以转换为程序上机运行，并得到正确的结果。</p><h1 id="算法设计的要求"><a href="#算法设计的要求" class="headerlink" title="算法设计的要求"></a>算法设计的要求</h1><h2 id="正确性"><a href="#正确性" class="headerlink" title="正确性"></a>正确性</h2><blockquote><p>算法的正确性是指算法至少应该具有输入、输出和加工处理无歧义性、能正确反映问题的需求、能够得到问题的正确答案。</p></blockquote><h2 id="可读性"><a href="#可读性" class="headerlink" title="可读性"></a>可读性</h2><blockquote><p>算法设计的另一目的是为了便于阅读、理解和交流。</p></blockquote><p>可读性高有助于人们理解算法，晦涩难懂的算法往往隐含错误，不易被发现，并且难于调试和修改。</p><p>我们写代码的目的，一方面是为了让计算机执行，但还有一个重要的目的是为了便于他人阅读，让人理解和交流，自己将来也可能阅读，如果可读性不好，时间长了自己都不知道写了些什么。可读性是算法（也包括实现它的代码）好坏很重要的标志。</p><h2 id="健壮性"><a href="#健壮性" class="headerlink" title="健壮性"></a>健壮性</h2><blockquote><p>当输入数据不合法时，算法也能做出相关处理，而不是产生异常或莫名其妙的结果。</p></blockquote><p>一个好的算法还应该能对输入数据不合法的情况做合适的处理。比如输入的时间或者距离不应该是负数等。</p><h2 id="时间效率高和存储量低"><a href="#时间效率高和存储量低" class="headerlink" title="时间效率高和存储量低"></a>时间效率高和存储量低</h2><p>时间效率指的是算法的执行时间，对于同一个问题，如果有多个算法能够解决，执行时间短的算法效率高，执行时间长的效率低。</p><p>存储量需求指的是算法在执行过程中需要的最大存储空间，主要指算法程序运行时所占用的内存或外部硬盘存储空间。</p><p>不过，我们在实际应用中，一般更多的考虑时间效率高，以空间换取时间也是算法的常见思路。</p><h1 id="算法效率的度量方法"><a href="#算法效率的度量方法" class="headerlink" title="算法效率的度量方法"></a>算法效率的度量方法</h1><h2 id="事后统计方法"><a href="#事后统计方法" class="headerlink" title="事后统计方法"></a>事后统计方法</h2><blockquote><p>这种方法主要是通过设计好的测试程序和数据，利用计算机计时器对不同算法编制的程序的运行时间进行比较，从而确定算法效率的高低。</p></blockquote><p>事后统计方法一般了解就行，基本没人使用。因为它有很大的缺陷，比如特别复杂的算法，本身编码就很困难，更别说编码完成后再进行测试得出算法效率，万一事后发现是很糟糕的算法，不是竹篮打水一场空吗？</p><h2 id="事前分析估算方法"><a href="#事前分析估算方法" class="headerlink" title="事前分析估算方法"></a>事前分析估算方法</h2><blockquote><p>在计算机程序编制前，依据统计方法对算法进行估算。</p></blockquote><h3 id="函数渐进增长"><a href="#函数渐进增长" class="headerlink" title="函数渐进增长"></a>函数渐进增长</h3><blockquote><p>给定两个函数<code>f(n)</code>和<code>g(n)</code>,如果存在一个整数N，使得对于所有的<code>n&gt;N</code>,<code>f(n)</code>总是比<code>g(n)</code>大，那么我们说<code>f(n)</code>的增长渐近快于<code>g(n)</code>。</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225111723469.png" alt="image-20221225111723469"></p><p>我们可以这样认为，随着n值的越来越大，它们在时间效率上的差异也就越来越大。</p><p>假设两个算法的输入规模都是n，算法A要做<code>2n+3次</code>操作，你可以理解为先有一个n次的循环，执行完成后，再有一个n次循环，最后有三次赋值或运算，共<code>2n+3</code>次操作。算法B要做<code>3n+1</code>次操作。</p><p><img src="https://img.gcdd.top/img/image-20221225112037313.png" alt="image-20221225112037313"></p><p>你觉得它们谁更快呢？显然是算法A。</p><p>第二个例子，算法C是<code>4n+8</code>，算法D是<code>2n^2+1</code></p><p><img src="https://img.gcdd.top/img/image-20221225112209854.png" alt="image-20221225112209854"></p><p>这里的差距就更大了，显然是算法C更快。</p><h2 id="算法时间复杂度定义"><a href="#算法时间复杂度定义" class="headerlink" title="算法时间复杂度定义"></a>算法时间复杂度定义</h2><blockquote><p>算法的时间复杂度，也就是算法的时间量度，记作：<code>T(n)=O(f(n))</code>。它表示随问题规模n的增大，算法执行时间的增长率和f(n)的增长率相同，称作算法的渐近时间复杂度，简称为时间复杂度。其中f(n)是问题规模n的某个函数。</p></blockquote><p>用大写O( )来体现算法时间复杂度的记法，我们称之为大O记法。</p><p>一般情况下，随着n的增大，T(n)增长最慢的算法为最优算法。</p><h3 id="推导大O阶方法"><a href="#推导大O阶方法" class="headerlink" title="推导大O阶方法"></a>推导大O阶方法</h3><ol><li>用常数1取代运行时间中的所有加法常数。</li><li>在修改后的运行次数函数中，只保留最高阶项。</li><li>如果最高阶项存在且不是1，则去除与这个项相乘</li></ol><h2 id="常见的大O阶"><a href="#常见的大O阶" class="headerlink" title="常见的大O阶"></a>常见的大O阶</h2><h3 id="线性阶（O-n-）"><a href="#线性阶（O-n-）" class="headerlink" title="线性阶（O(n)）"></a>线性阶（O(n)）</h3><p>一般含有非嵌套循环涉及线性阶，线性阶就是随着输入规模的扩大，对应计算次数呈直线增长，例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ex01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;sum=&quot;</span> + sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="平方阶（O-n-2-）"><a href="#平方阶（O-n-2-）" class="headerlink" title="平方阶（O(n^2)）"></a>平方阶（O(n^2)）</h3><p>一般嵌套循环属于这种时间复杂度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ex02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>, n = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++) &#123;</span><br><span class="line">                sum += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="立方阶（O-n-3-）"><a href="#立方阶（O-n-3-）" class="headerlink" title="立方阶（O(n^3)）"></a>立方阶（O(n^3)）</h3><p>一般三层嵌套循环属于这种时间复杂度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ex03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>, n = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i; j &lt;= n; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> i; k &lt;= n; k++) &#123;</span><br><span class="line">                    x++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种复杂度已经是爆炸式增长，实际生产肯定要重新选择算法。</p><h3 id="对数阶（O-logn-）"><a href="#对数阶（O-logn-）" class="headerlink" title="对数阶（O(logn)）"></a>对数阶（O(logn)）</h3><p>对于对数阶，由于随着输入规模n的增大，不管底数为多少，他们的增长趋势是一样的，所以我们会忽略底数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ex04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>, n = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">            i = i * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一般二分法都是对数阶，二叉树的一些计算也是对数阶。对数阶相对于平方阶是巨大的提升，运行次数是折半的。</p><h3 id="常数阶（O-1-）"><a href="#常数阶（O-1-）" class="headerlink" title="常数阶（O(1)）"></a>常数阶（O(1)）</h3><p>一般不涉及循环操作的都是常数阶，因为它不会随着n的增长而增加操作次数。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Ex05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n + <span class="number">2</span>;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过我们一般也不讨论常数阶。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><table><thead><tr><th>描述</th><th>增长的数量级</th><th>说明</th><th>举例</th></tr></thead><tbody><tr><td>常数级别</td><td>1</td><td>普通语句</td><td>将两个数相加</td></tr><tr><td>对数级别</td><td><code>logN</code></td><td>二分策略</td><td>二分查找</td></tr><tr><td>线性级别</td><td><code>N</code></td><td>循环</td><td>找出最大元素</td></tr><tr><td>线性对数级别</td><td><code>NlogN</code></td><td>分治思想</td><td>归并排序</td></tr><tr><td>平方级别</td><td><code>N^2</code></td><td>双层循环</td><td>检查所有元素对</td></tr><tr><td>立方级别</td><td><code>N^3</code></td><td>三层循环</td><td>检查所有三元组</td></tr><tr><td>指数级别</td><td><code>2^N</code></td><td>穷举查找</td><td>检查所有子集</td></tr></tbody></table><p>他们的复杂程度从低到高依次为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O(1) &lt; O(logn) &lt; O(n) &lt; O(nlogn) &lt; O(n^2) &lt; O(n^3)</span><br></pre></td></tr></table></figure><p>平方级别和立方级别的算法，时间已经是爆炸式增长，而指数级别的运行时间几乎是灾难，如果发现写出的算法是平方级别、指数级别，那么肯定需要优化。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;算法的特性&quot;&gt;&lt;a href=&quot;#算法的特性&quot; class=&quot;headerlink&quot; title=&quot;算法的特性&quot;&gt;&lt;/a&gt;算法的特性&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;算法具有五个基本特性：输入、输出、有穷性、确定性和可行性。&lt;/p&gt;
&lt;/blockquot</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/5/"/>
    <id>https://blog.gcdd.top/p/5/</id>
    <published>2023-08-30T04:52:53.896Z</published>
    <updated>2024-01-25T09:08:27.042Z</updated>
    
    <content type="html"><![CDATA[<h1 id="栈与队列"><a href="#栈与队列" class="headerlink" title="栈与队列"></a>栈与队列</h1><p>我们一般把栈与队列合在一块讨论，因为他们具有相似的性质。</p><p>栈：栈是限定仅在表尾进行插入和删除操作的线性表，所以栈又称为后进先出<code>（LastIn First Out）</code>的线性表，简称LIFO结构。</p><p>队列：只允许在一端进行插入操作、而在另一端进行删除操作的线性表，队列又称为先进先出<code>（First In First Out）</code>的线性表，简称FIFO结构。</p><h1 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h1><h2 id="生活中的栈"><a href="#生活中的栈" class="headerlink" title="生活中的栈"></a>生活中的栈</h2><p>存储货物或供旅客住宿的地方,可引申为仓库、中转站 。例如我们现在生活中的酒店，在古时候叫客栈，是供旅客休息的地方，旅客可以进客栈休息，休息完毕后就离开客栈。</p><p><img src="https://img.gcdd.top/img/image-20221225223718866.png" alt="image-20221225223718866"></p><h2 id="计算机中的栈"><a href="#计算机中的栈" class="headerlink" title="计算机中的栈"></a>计算机中的栈</h2><p>我们把生活中的栈的概念引入到计算机中，就是供数据休息的地方，它是一种数据结构，数据既可以进入到栈中，又可以从栈中出去。<br>栈是一种基于先进后出(<code>FILO</code>)的数据结构，是一种只能在一端进行插入和删除操作的特殊线性表。它按照先进后出的原则存储数据，先进入的数据被压入栈底，最后的数据在栈顶，需要读数据的时候从栈顶开始弹出数据（最后一个数据被第一个读出来）。<br>我们称数据进入到栈的动作为<strong>压栈</strong>，数据从栈中出去的动作为<strong>弹栈</strong>。</p><p><img src="https://img.gcdd.top/img/image-20221225223843745.png" alt="image-20221225223843745"></p><h2 id="栈的设计"><a href="#栈的设计" class="headerlink" title="栈的设计"></a>栈的设计</h2><table><thead><tr><th>类名</th><th>Stack</th></tr></thead><tbody><tr><td>构造方法</td><td><code>Stack()</code>：创建Stack对象</td></tr><tr><td>成员方法</td><td><code>public boolean isEmpty()</code>：判断栈是否为空，是返回true，否返回false<br/><code>public int size()</code>：获取栈中元素的个数<br/><code>public T pop()</code>：弹出栈顶元素<br/><code>public void push(E e)</code>：向栈中压入元素e</td></tr><tr><td>成员变量</td><td><code>private Node head</code>：记录首结点<br/><code>private int n</code>：当前栈的元素个数</td></tr></tbody></table><p>我们一般用链表来实现栈。</p><h2 id="栈的代码实现"><a href="#栈的代码实现" class="headerlink" title="栈的代码实现"></a>栈的代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Stack</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 头结点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;E&gt; top;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 元素个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入元素e为新的栈顶元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 把当前的栈顶元素赋值给新结点的直接后继</span></span><br><span class="line">        top = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, top);</span><br><span class="line">        <span class="built_in">this</span>.count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出栈</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 若栈不空，则删除S的栈顶元素，用e返回其值，并返回OK；否则返回ERROR</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">pop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">var</span> <span class="variable">temp</span> <span class="operator">=</span> top;</span><br><span class="line">        top = top.next;</span><br><span class="line">        count--;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> temp.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断栈是否为空，是返回true，否返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取栈中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 存储元素</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> E item;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 指向下一个节点</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Node&lt;E&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="栈的应用"><a href="#栈的应用" class="headerlink" title="栈的应用"></a>栈的应用</h2><h3 id="括号匹配问题"><a href="#括号匹配问题" class="headerlink" title="括号匹配问题"></a>括号匹配问题</h3><p>给定一个字符串，里边可能包含”()”小括号和其他字符，请编写程序检查该字符串的中的小括号是否成对出现。</p><p>例如：</p><ul><li>“(上海)(长安)”：正确匹配</li><li>“上海((长安))”：正确匹配</li><li>“上海(长安(北京)(深圳)南京)”：正确匹配</li><li>“上海(长安))”：错误匹配</li><li>“((上海)长安”：错误匹配</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BracketsMatch</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;(上海(长安)())&quot;</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> isMatch(str);</span><br><span class="line">        System.out.println(str + <span class="string">&quot;中的括号是否匹配：&quot;</span> + match);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断str中的括号是否匹配</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 括号组成的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果匹配，返回true，如果不匹配，返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isMatch</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请完善<code>isMatch</code>方法</p><p>我们用栈来分析解决方案：</p><ol><li>创建一个栈用来存储左括号</li><li>从左往右遍历字符串，拿到每一个字符</li><li>判断该字符是不是左括号，如果是，放入栈中存储</li><li>判断该字符是不是右括号，如果不是，继续下一次循环</li><li>如果该字符是右括号，则从栈中弹出一个元素t；</li><li>判断元素t是否为null，如果不是，则证明有对应的左括号，如果不是，则证明没有对应的左括号</li><li>循环结束后，判断栈中还有没有剩余的左括号，如果有，则不匹配，如果没有，则匹配</li></ol><p><img src="https://img.gcdd.top/img/image-20221225225724337.png" alt="image-20221225225724337"></p><p>代码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BracketsMatch</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">LEFT_PARENTHESIS</span> <span class="operator">=</span> <span class="string">&#x27;(&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span> <span class="variable">RIGIT_PARENTHESIS</span> <span class="operator">=</span> <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断str中的括号是否匹配</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 括号组成的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果匹配，返回true，如果不匹配，返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isMatch</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">stack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;Character&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">c</span> <span class="operator">=</span> str.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (LEFT_PARENTHESIS == c) &#123;</span><br><span class="line">                stack.push(c);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RIGIT_PARENTHESIS == c) &#123;</span><br><span class="line">                <span class="comment">// 弹出一个元素，如果是NULL，那么证明没有对应的左括号</span></span><br><span class="line">                <span class="keyword">if</span> (stack.pop() == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stack.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="逆波兰（后缀）表达式求值"><a href="#逆波兰（后缀）表达式求值" class="headerlink" title="逆波兰（后缀）表达式求值"></a>逆波兰（后缀）表达式求值</h3><p>逆波兰表达式求值问题是我们计算机中经常遇到的一类问题，要研究明白这个问题，首先我们得搞清楚什么是逆波兰表达式？要搞清楚逆波兰表达式，我们得从中缀表达式说起。</p><h4 id="中缀表达式"><a href="#中缀表达式" class="headerlink" title="中缀表达式"></a>中缀表达式</h4><p>中缀表达式就是我们平常生活中使用的表达式，例如：<code>1 + 3 * 2</code>，<code>2 - (1 + 3)</code>等等，中缀表达式的特点是：二元运算符总是置于两个操作数中间。</p><p>中缀表达式是人们最喜欢的表达式方式，因为简单，易懂。但是对于计算机来说就不是这样了，因为中缀表达式的运算顺序不具有规律性。不同的运算符具有不同的优先级，如果计算机执行中缀表达式，需要解析表达式语义，做大量的优先级相关操作。</p><h4 id="逆波兰（后缀）表达式"><a href="#逆波兰（后缀）表达式" class="headerlink" title="逆波兰（后缀）表达式"></a>逆波兰（后缀）表达式</h4><p>逆波兰表达式是波兰逻辑学家J・卢卡西维兹(J・ Lukasewicz)于1929年首先提出的一种表达式的表示方法，后缀表达式的特点：运算符总是放在跟它相关的操作数之后。</p><table><thead><tr><th>中缀表达式</th><th>逆波兰表达式</th></tr></thead><tbody><tr><td><code>a+b</code></td><td><code>ab+</code></td></tr><tr><td><code>a+(b-c)</code></td><td><code>abc-+</code></td></tr><tr><td><code>a+(b-c)*d</code></td><td><code>abc-d*+</code></td></tr><tr><td><code>a*(b-c)+d</code></td><td><code>abc-*d+</code></td></tr></tbody></table><p>需求</p><p>给定一个只包含加减乘除四种运算的逆波兰表达式的数组表示方式，求出该逆波兰表达式的结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReversePolishNotation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//中缀表达式3*（17-15）+18/6的逆波兰表达式如下</span></span><br><span class="line">        String[] notation = &#123;<span class="string">&quot;3&quot;</span>, <span class="string">&quot;17&quot;</span>, <span class="string">&quot;15&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;18&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;+&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> caculate(notation);</span><br><span class="line">        System.out.println(<span class="string">&quot;逆波兰表达式的结果为：&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notaion 逆波兰表达式的数组表示方式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 逆波兰表达式的计算结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">caculate</span><span class="params">(String[] notaion)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完善<code>caculate</code>方法，计算出逆波兰表达式的结果。</p><p>我们用栈来分析解决方案：</p><ol><li>创建一个栈对象<code>oprands</code>存储操作数</li><li>从左往右遍历逆波兰表达式，得到每一个字符串</li><li>判断该字符串是不是运算符，如果不是，把该该操作数压入<code>oprands</code>栈中</li><li>如果是运算符，则从<code>oprands</code>栈中弹出两个操作数o1,o2</li><li>使用该运算符计算o1和o2，得到结果<code>result</code></li><li>把该结果压入<code>oprands</code>栈中</li><li>遍历结束后，拿出栈中最终的结果返回</li></ol><p><img src="https://img.gcdd.top/img/image-20221225232111136.png" alt="image-20221225232111136"></p><p>代码实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReversePolishNotation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notaion 逆波兰表达式的数组表示方式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 逆波兰表达式的计算结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">caculate</span><span class="params">(String[] notaion)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">oprands</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;Double&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> s : notaion) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (s) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>: &#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o1</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o2</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    oprands.push(o2 + o1);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>: &#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o1</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o2</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    oprands.push(o2 - o1);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;*&quot;</span>: &#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o1</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o2</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    oprands.push(o2 * o1);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;/&quot;</span>: &#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o1</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    <span class="type">var</span> <span class="variable">o2</span> <span class="operator">=</span> oprands.pop();</span><br><span class="line">                    oprands.push(o2 / o1);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="comment">// 非运算符，那么入栈</span></span><br><span class="line">                    oprands.push(Double.parseDouble(s));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oprands.pop().intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h1><p>你们在用电脑时有没有经历过，机器有时会处于疑似死机的状态，鼠标点什么似乎都没用，双击任何快捷方式都不动弹。就当你失去耐心，打算reset时。突然它像酒醒了一样，把你刚才点击的所有操作全部都按顺序执行了一遍。这其实是因为操作系统中的多个程序因需要通过一个通道输出，而按先后次序排队等待造成的。</p><p>再比如像移动、联通、电信等客服电话，客服人员与客户相比总是少数，在所有的客服人员都占线的情况下，客户会被要求等待，直到有某个客服人员空下来，才能让最先等待的客户接通电话。这里也是将所有当前拨打客服电话的客户进行了排队处理。操作系统和客服系统中，都是应用了一种数据结构来实现刚才提到的先进先出的排队功能，这就是队列。</p><p>队列是一种先进先出（First In First Out）的线性表，简称FIFO。允许插入的一端称为队尾，允许删除的一端称为队头。</p><p><img src="https://img.gcdd.top/img/image-20221225233503324.png" alt="image-20221225233503324"></p><h2 id="队列的设计"><a href="#队列的设计" class="headerlink" title="队列的设计"></a>队列的设计</h2><table><thead><tr><th>类名</th><th>Queue</th></tr></thead><tbody><tr><td>构造方法</td><td><code>Queue()</code>：创建Queue对象</td></tr><tr><td>成员方法</td><td><code>public boolean isEmpty()</code>：判断队列是否为空，是返回true，否返回false<br/><code>public int size()</code>：获取队列中元素的个数<br/><code>public E pop()</code>：从队列中拿出一个元素<br/><code>public void push(E e)</code>：往队列中插入一个元素</td></tr><tr><td>成员变量</td><td><code>private Node head</code>：记录首结点<br/><code>private int n</code>：当前栈的元素个数<br/><code>private Node last</code>：记录最后一个结点</td></tr></tbody></table><h2 id="队列的实现"><a href="#队列的实现" class="headerlink" title="队列的实现"></a>队列的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Queue</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队头指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队尾指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;E&gt; last;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.last = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入队</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 新节点</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">newNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (last == <span class="literal">null</span>) &#123;</span><br><span class="line">            last = newNode;</span><br><span class="line">            head.next = last;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 当前尾结点不为NULL</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">oldLast</span> <span class="operator">=</span> last;</span><br><span class="line">            last = newNode;</span><br><span class="line">            oldLast.next = last;</span><br><span class="line">        &#125;</span><br><span class="line">        last.next = newNode;</span><br><span class="line">        last = newNode;</span><br><span class="line">        <span class="built_in">this</span>.n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出队</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">pop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 无元素</span></span><br><span class="line">        <span class="keyword">if</span> (head == last) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 头结点不存储元素，所以移出的元素是头结点下一个元素</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">oldFirst</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = oldFirst.next;</span><br><span class="line">        <span class="built_in">this</span>.n--;</span><br><span class="line">        <span class="keyword">if</span> (isEmpty()) &#123;</span><br><span class="line">            last = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldFirst.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 存储元素</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> E item;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 指向下一个节点</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Node&lt;E&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;栈与队列&quot;&gt;&lt;a href=&quot;#栈与队列&quot; class=&quot;headerlink&quot; title=&quot;栈与队列&quot;&gt;&lt;/a&gt;栈与队列&lt;/h1&gt;&lt;p&gt;我们一般把栈与队列合在一块讨论，因为他们具有相似的性质。&lt;/p&gt;
&lt;p&gt;栈：栈是限定仅在表尾进行插入和删除操作的线性表，所以</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/0/"/>
    <id>https://blog.gcdd.top/p/0/</id>
    <published>2023-08-30T04:52:53.895Z</published>
    <updated>2024-01-25T11:53:48.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="什么是数据结构？"><a href="#什么是数据结构？" class="headerlink" title="什么是数据结构？"></a>什么是数据结构？</h1><p>官方解释：数据结构是一门研究非数值计算的程序设计问题中的操作对象，以及他们之间的关系和操作等相关问题的学科。<br>大白话：数据结构就是<strong>把数据元素按照一定的关系组织起来的集合</strong>，用来组织和存储数据。</p><h1 id="数据结构分类"><a href="#数据结构分类" class="headerlink" title="数据结构分类"></a>数据结构分类</h1><h2 id="按照逻辑结构分类"><a href="#按照逻辑结构分类" class="headerlink" title="按照逻辑结构分类"></a>按照逻辑结构分类</h2><blockquote><p>逻辑结构是从具体问题中抽象出来的模型，是抽象意义上的结构，按照对象中数据元素之间的相互关系分类，也是我们后面课题中需要关注和讨论的问题。</p></blockquote><h3 id="集合结构"><a href="#集合结构" class="headerlink" title="集合结构"></a>集合结构</h3><blockquote><p>集合结构中数据元素除了属于同一个集合外，他们之间没有任何其他的关系</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225100453673.png" alt="image-20221225100453673"></p><h3 id="线性结构"><a href="#线性结构" class="headerlink" title="线性结构"></a>线性结构</h3><blockquote><p>线性结构中的数据元素之间存在<strong>一对一</strong>的关系</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225101916276.png" alt="image-20221225101916276"></p><h3 id="树形结构"><a href="#树形结构" class="headerlink" title="树形结构"></a>树形结构</h3><blockquote><p>树形结构中的数据元素之间存在<strong>一对多</strong>的层次关系</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225102038909.png" alt="image-20221225102038909"></p><h3 id="图形结构"><a href="#图形结构" class="headerlink" title="图形结构"></a>图形结构</h3><blockquote><p>图形结构的数据元素是<strong>多对多</strong>的关系</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225102101516.png" alt="image-20221225102101516"></p><h2 id="按照物理结构分类"><a href="#按照物理结构分类" class="headerlink" title="按照物理结构分类"></a>按照物理结构分类</h2><p>逻辑结构在计算机中真正的表示方式（又称为映像）称为物理结构，也可以叫做存储结构。常见的物理结构有顺序存储结构、链式存储结构。</p><h3 id="顺序存储结构"><a href="#顺序存储结构" class="headerlink" title="顺序存储结构"></a>顺序存储结构</h3><blockquote><p>把数据元素放到地址连续的存储单元里面，其数据间的逻辑关系和物理关系是一致的 ，比如我们常用的数组就是顺序存储结构。</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225103351011.png" alt="image-20221225103351011"></p><p>顺序存储结构存在一定的弊端，就像生活中排时也会有人插队也可能有人有特殊情况突然离开，这时候整个结构都处于变化中，此时就需要链式存储结构。</p><h3 id="链式存储结构"><a href="#链式存储结构" class="headerlink" title="链式存储结构"></a>链式存储结构</h3><blockquote><p>是把数据元素存放在任意的存储单元里面，这组存储单元可以是连续的也可以是不连续的。此时，数据元素之间并不能反映元素间的逻辑关系，因此在链式存储结构中引进了一个指针存放数据元素的地址，这样通过地址就可以找到相关联数据元素的位置。</p></blockquote><p><img src="https://img.gcdd.top/img/image-20221225102232317.png" alt="image-20221225102232317"></p><h1 id="什么是算法？"><a href="#什么是算法？" class="headerlink" title="什么是算法？"></a>什么是算法？</h1><p>官方解释：算法是指解题方案的准确而完整的描述，是一系列解决问题的清晰指令，算法代表着用系统的方法解决问题的策略机制。也就是说，能够对一定规范的输入，在有限时间内获得所要求的输出。</p><p>大白话：根据一定的条件，对一些数据进行计算，得到需要的结果。</p><h2 id="算法初体验"><a href="#算法初体验" class="headerlink" title="算法初体验"></a>算法初体验</h2><p>在生活中，我们如果遇到某个问题，常常解决方案不是唯一的。<br>例如从西安到北京，如何去？会有不同的解决方案，我们可以坐飞机，可以坐火车，可以坐汽车，甚至可以步行，<br>不同的解决方案带来的时间成本和金钱成本是不一样的，比如坐飞机用的时间最少，但是费用最高，步行费用最<br>低，但时间最长。<br>再例如在北京二环内买一套四合院，如何付款？也会有不同的解决方案，可以一次性现金付清，也可以通过银行做<br>按揭。这两种解决方案带来的成本也不一样，一次性付清，虽然当时出的钱多，压力大，但是没有利息，按揭虽然<br>当时出的钱少，压力比较小，但是会有利息，而且30年的总利息几乎是贷款额度的一倍，需要多付钱。<br>在程序中，我们也可以用不同的算法解决相同的问题，而不同的算法的成本也是不相同的。总体上，一个优秀的算<br>法追求以下两个目标：</p><ol><li>花最少的时间完成需求；</li><li>占用最少的内存空间完成需求；</li></ol><p>下面我们用一些实际案例体验一些算法。</p><h3 id="需求一"><a href="#需求一" class="headerlink" title="需求一"></a>需求一</h3><blockquote><p>计算1到100的和，比较两种算法的时间复杂度</p></blockquote><p>第一种解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> n=<span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;sum=&quot;</span> + sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二种解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> n=<span class="number">100</span>;</span><br><span class="line">    sum = (n+<span class="number">1</span>)*n/<span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;sum=&quot;</span>+sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一种解法要完成需求，要完成以下几个动作：</p><ol><li>定义两个整型变量；</li><li>执行100次加法运算；</li><li>打印结果到控制台；</li></ol><p>第二种解法要完成需求，要完成以下几个动作：</p><ol><li>定义两个整型变量；</li><li>执行1次加法运算，1次乘法运算，一次除法运算，总共3次运算；</li><li>打印结果到控制台；</li></ol><p>很明显，第二种算法完成需求，花费的时间更少一些。</p><h3 id="需求二"><a href="#需求二" class="headerlink" title="需求二"></a>需求二</h3><blockquote><p>计算10的阶乘，比较两种算法的空间复杂度</p></blockquote><p>第一种解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//测试，计算10的阶乘</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> fun1(<span class="number">10</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算n的阶乘</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">fun1</span><span class="params">(<span class="type">long</span> n)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n*fun1(n-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二种解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//测试，计算10的阶乘</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> fun2(<span class="number">10</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算n的阶乘</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">fun2</span><span class="params">(<span class="type">long</span> n)</span>&#123;</span><br><span class="line">        <span class="type">int</span> result=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            result*=i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一种解法，使用递归完成需求，<code>fun1</code>方法会执行10次，并且第一次执行未完毕，调用第二次执行，第二次执行未完毕，调用第三次执行…最终，最多的时候，需要在栈内存同时开辟10块内存分别执行10个<code>fun1</code>方法。<br>第二种解法，使用for循环完成需求，<code>fun2</code>方法只会执行一次，最终，只需要在栈内存开辟一块内存执行<code>fun2</code>方法即可。<br>很明显，第二种算法完成需求，占用的内存空间更小。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;什么是数据结构？&quot;&gt;&lt;a href=&quot;#什么是数据结构？&quot; class=&quot;headerlink&quot; title=&quot;什么是数据结构？&quot;&gt;&lt;/a&gt;什么是数据结构？&lt;/h1&gt;&lt;p&gt;官方解释：数据结构是一门研究非数值计算的程序设计问题中的操作对象，以及他们之间的关系和操作等</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://blog.gcdd.top/p/1/"/>
    <id>https://blog.gcdd.top/p/1/</id>
    <published>2023-08-30T04:52:53.895Z</published>
    <updated>2024-01-25T09:08:27.039Z</updated>
    
    <content type="html"><![CDATA[<h1 id="线性表定义"><a href="#线性表定义" class="headerlink" title="线性表定义"></a>线性表定义</h1><p>线性表（List）：零个或多个数据元素的有限序列。</p><p>首先它是一个序列，其次，线性表强调是有限的。</p><p><img src="https://img.gcdd.top/img/image-20221225134203855.png" alt="image-20221225134203855"></p><p>前驱元素：若A元素在B元素的前面，则称A为B的前驱元素</p><p>后继元素：若B元素在A元素的后面，则称B为A的后继元素</p><h2 id="线性表的特征"><a href="#线性表的特征" class="headerlink" title="线性表的特征"></a>线性表的特征</h2><blockquote><p>数据元素之间具有一种“一对一”的逻辑关系。</p></blockquote><ul><li>第一个数据元素没有前驱，这个数据元素被称为头结点；</li><li>最后一个数据元素没有后继，这个数据元素被称为尾结点；</li><li>除了第一个和最后一个数据元素外，其他数据元素有且仅有一个前驱和一个后继。</li></ul><p>如果把线性表用数学语言来定义，则可以表示为<code>(a1,...ai-1,ai,ai+1,...an)</code>，<code>ai-1</code>领先于<code>ai</code>,<code>ai</code>领先于<code>ai+1</code>，称<code>ai-1</code>是<code>ai</code>的前驱元素，<code>ai+1</code>是<code>ai</code>的后继元素。</p><p><img src="https://img.gcdd.top/img/image-20221225134348971.png" alt="image-20221225134348971"></p><h2 id="线性表的分类"><a href="#线性表的分类" class="headerlink" title="线性表的分类"></a>线性表的分类</h2><p>线性表中数据存储的方式可以是顺序存储，也可以是链式存储，按照数据的存储方式不同，可以把线性表分为顺序表和链表。</p><h1 id="顺序表"><a href="#顺序表" class="headerlink" title="顺序表"></a>顺序表</h1><p>顺序表是在计算机内存中以数组的形式保存的线性表，线性表的顺序存储是指用<strong>一组地址连续的存储单元</strong>，依次存储线性表中的各个元素、使得线性表中再逻辑结构上相邻的数据元素存储在相邻的物理存储单元中，即通过数据元素物理存储的相邻关系来反映数据元素之间逻辑上的相邻关系。</p><p><img src="https://img.gcdd.top/img/image-20221225134539279.png" alt="image-20221225134539279"></p><h2 id="顺序表设计"><a href="#顺序表设计" class="headerlink" title="顺序表设计"></a>顺序表设计</h2><table><thead><tr><th>类名</th><th><code>SequenceList</code></th></tr></thead><tbody><tr><td>构造方法</td><td><code>SequenceList(int capacity)</code>：创建容量为<code>capacity</code>的<code>SequenceList</code>对象</td></tr><tr><td>成员方法</td><td><code>public void clear()</code>：空置线性表<br/><code>publicboolean isEmpty()</code>：判断线性表是否为空，是返回true，否返回false<br/><code>public int length()</code>：获取线性表中元素的个数<br/><code>public T get(int i)</code>：读取并返回线性表中的第i个元素的值<br/><code>public void insert(int i,E e)</code>：在线性表的第i个元素之前插入一个值为t的数据元素。<br/><code>public void insert(E e)</code>:向线性表中添加一个元素t<br/><code>public T remove(int i)</code>:删除并返回线性表中第i个数据元素。<br/><code>public int indexOf(E e)</code>:返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1。</td></tr><tr><td>成员变量</td><td><code>private T[] elements</code>：存储元素的数组<br/><code>private int n</code>:当前线性表的长度</td></tr></tbody></table><h2 id="顺序表代码实现"><a href="#顺序表代码实现" class="headerlink" title="顺序表代码实现"></a>顺序表代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequenceList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储元素的数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T[] elements;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录当前顺序表中的元素个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建容量为capacity的SequenceList对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SequenceList</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        <span class="built_in">this</span>.elements = (T[]) <span class="keyword">new</span> <span class="title class_">Object</span>[capacity];</span><br><span class="line">        <span class="comment">// 初始化长度</span></span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 空置线性表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断线性表是否为空，是返回true，否返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线性表中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取并返回线性表中的第i个元素的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前元素不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> elements[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在线性表的第i个元素之前插入一个值为t的数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> i, E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == elements.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前表已满&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 先把i索引处的元素及其后面的元素依次向后移动一位</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> n; j &gt; i; j--) &#123;</span><br><span class="line">            elements[j] = elements[j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 再把t元素放到i索引处</span></span><br><span class="line">        elements[i] = t;</span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向线性表中添加一个元素t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == elements.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前表已满&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt; n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;插入的位置不合法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        elements[n++] = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除并返回线性表中第i个数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">remove</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt; n - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前要删除的元素不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录i索引处的值</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">current</span> <span class="operator">=</span> elements[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 索引i后面元素依次向前移动一位</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i; j &lt; n - <span class="number">1</span>; j++) &#123;</span><br><span class="line">            elements[j] = elements[j + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 元素个数-1</span></span><br><span class="line">        n--;</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;查找的元素不合法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(elements[i], t)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="顺序表的遍历"><a href="#顺序表的遍历" class="headerlink" title="顺序表的遍历"></a>顺序表的遍历</h2><p>一般作为容器存储数据，都需要向外部提供遍历的方式，因此我们需要给顺序表提供遍历方式。</p><p>在Java中，遍历集合的方式一般都是用的是<code>forEach</code>循环，如果想让我们的<code>SequenceList</code>也能支持<code>forEach</code>循环，则需要做如下操作：</p><ol><li>让<code>SequenceList</code>实现<code>Iterable</code>接口，重写<code>iterator</code>方法；</li><li>在<code>SequenceList</code>内部提供一个内部类<code>SIterator</code>，实现<code>Iterator</code>接口，重写<code>hasNext</code>方法和<code>next</code>方法；</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequenceList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> cursor;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SIterator</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cursor = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cursor &lt; n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> T <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> elements[cursor++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="顺序表容量可变"><a href="#顺序表容量可变" class="headerlink" title="顺序表容量可变"></a>顺序表容量可变</h2><p>在之前的实现中，当我们使用<code>SequenceList</code>时，先<code>new SequenceList(5)</code>创建一个对象，创建对象时就需要指定容器的大小，初始化指定大小的数组来存储元素，当我们插入元素时，如果已经插入了5个元素，还要继续插入数据，则会报错，就不能插入了。这种设计不符合容器的设计理念，因此我们在设计顺序表时，应该考虑它的容量的伸缩性。<br>考虑容器的容量伸缩性，其实就是改变存储数据元素的数组的大小，那我们需要考虑什么时候需要改变数组的大小？</p><h3 id="添加元素时扩容"><a href="#添加元素时扩容" class="headerlink" title="添加元素时扩容"></a>添加元素时扩容</h3><p>添加元素时，应该检查当前数组的大小是否能容纳新的元素，如果不能容纳，则需要创建新的容量更大的数组，我们这里创建一个是原数组两倍容量的新数组存储元素。</p><p><img src="https://img.gcdd.top/img/image-20221225140942252.png" alt="image-20221225140942252"></p><h3 id="移除元素时缩容"><a href="#移除元素时缩容" class="headerlink" title="移除元素时缩容"></a>移除元素时缩容</h3><p>移除元素时，应该检查当前数组的大小是否太大，比如正在用100个容量的数组存储10个元素，这样就会造成内存空间的浪费，应该创建一个容量更小的数组存储元素。如果我们发现数据元素的数量不足数组容量的1/4，则创建一个是原数组容量的1/2的新数组存储元素。</p><p><img src="https://img.gcdd.top/img/image-20221225141009891.png" alt="image-20221225141009891"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SequenceList</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向线性表中添加一个元素t</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果当前容量已满，那么扩容2倍</span></span><br><span class="line">        <span class="keyword">if</span> (n == elements.length) &#123;</span><br><span class="line">            resize(<span class="number">2</span> * elements.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除并返回线性表中第i个数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">remove</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果当前元素数量小于容量的1/4，那么缩容为1/2</span></span><br><span class="line">        <span class="keyword">if</span> (n &lt; elements.length / <span class="number">4</span>) &#123;</span><br><span class="line">            resize(elements.length / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据newSize，重置elements的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resize</span><span class="params">(<span class="type">int</span> newSize)</span> &#123;</span><br><span class="line">        <span class="comment">// 定义一个临时数组，指向原数组</span></span><br><span class="line">        T[] temp = elements;</span><br><span class="line">        <span class="comment">// 创建新数组</span></span><br><span class="line">        elements = (T[]) <span class="keyword">new</span> <span class="title class_">Object</span>[newSize];</span><br><span class="line">        System.arraycopy(temp, <span class="number">0</span>, elements, <span class="number">0</span>, temp.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>扩缩容的原理很简单，是创建一个具有指定新容量的新数组，然后把原来的数据拷贝到新数组。</p><h2 id="顺序表的时间复杂度"><a href="#顺序表的时间复杂度" class="headerlink" title="顺序表的时间复杂度"></a>顺序表的时间复杂度</h2><ul><li><code>get(i)</code>：不论数据元素量n有多大，只需要一次<code>elements[i]</code>就可以获取到对应的元素，所以时间复杂度为O(1)。我们通常把具有这一特点的存储结构称为随机存取结构。</li><li><code>insert(int i,E e)</code>：每一次插入，都需要把i位置后面的元素移动一次，随着元素数量N的增大，移动的元素也越多，时间复杂为O(n);</li><li><code>remove(int i)</code>：每一次删除，都需要把i位置后面的元素移动一次，随着数据量N的增大,移动的元素也越多，时间复杂度为O(n);</li></ul><p>由于顺序表的底层由数组实现，数组的长度是固定的，所以在操作的过程中涉及到了容器扩容操作。这样会导致顺序表在使用过程中的时间复杂度不是线性的，在某些需要扩容的结点处，耗时会突增，尤其是元素越多，这个问题越明显。</p><h2 id="顺序表的优缺点"><a href="#顺序表的优缺点" class="headerlink" title="顺序表的优缺点"></a>顺序表的优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>无需为表示表中元素之间的逻辑关系而增加额外的存储空间</li><li>可以快速地存取表中任意位置的元素</li></ul><p>缺点</p><ul><li>插入和删除操作需要移动大量元素</li><li>当线性表长度变化较大时，难以确定存储空间的容量</li><li>造成存储空间的“碎片”</li></ul><h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><p>虽然顺序表的查询很快，时间复杂度为O(1),但是增删的效率是比较低的，因为每一次增删操作都伴随着大量的数据元素移动。这个问题有没有解决方案呢？有，我们可以使用另外一种存储结构实现线性表，链式存储结构。</p><p>链表是一种物理存储单元上非连续、非顺序的存储结构，其物理结构不能只管的表示数据元素的逻辑顺序，数据元素的逻辑顺序是通过链表中的指针链接次序实现的。链表由一系列的结点（链表中的每一个元素称为结点）组成，结点可以在运行时动态生成。</p><p><img src="https://img.gcdd.top/img/image-20221225142040985.png" alt="image-20221225142040985"></p><h2 id="链表节点设计"><a href="#链表节点设计" class="headerlink" title="链表节点设计"></a>链表节点设计</h2><table><thead><tr><th>类名</th><th>Node</th></tr></thead><tbody><tr><td>构造方法</td><td><code>Node(E e, Node next)</code>：创建Node对象</td></tr><tr><td>成员变量</td><td><code>T item</code>：存储数据<br/><code>Node next</code>：指向下一个结点</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> E item;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指向下一个节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;E&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="单向链表"><a href="#单向链表" class="headerlink" title="单向链表"></a>单向链表</h2><p>单向链表是链表的一种，它由多个结点组成，每个结点都由一个数据域和一个指针域组成，数据域用来存储数据，指针域用来指向其后继结点。链表的头结点的数据域不存储数据，指针域指向第一个真正存储数据的结点。</p><p><img src="https://img.gcdd.top/img/image-20221225142441247.png" alt="image-20221225142441247"></p><h3 id="单向链表设计"><a href="#单向链表设计" class="headerlink" title="单向链表设计"></a>单向链表设计</h3><table><thead><tr><th>类名</th><th>LinkList</th></tr></thead><tbody><tr><td>构造方法</td><td><code>LinkList()</code>：创建LinkList对象</td></tr><tr><td>成员方法</td><td><code>public void clear()</code>：空置线性表<br/><code>public boolean isEmpty()</code>：判断线性表是否为空，是返回true，否返回false<br/><code>public int length()</code>：获取线性表中元素的个数<br/><code>public T get(int i)</code>：读取并返回线性表中的第i个元素的值<br/><code>public void insert(E e)</code>：往线性表中添加一个元素；<br/><code>public void insert(int i, E e)</code>：在线性表的第i个元素之前插入一个值为t的数据元素。<br/><code>public T remove(int i)</code>：删除并返回线性表中第i个数据元素。<br/><code>public int indexOf(E e)</code>：返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1。</td></tr><tr><td>成员变量</td><td><code>private Node head</code>：记录首结点<br/><code>private int n</code>：记录链表的长度</td></tr></tbody></table><h3 id="单向链表代码实现"><a href="#单向链表代码实现" class="headerlink" title="单向链表代码实现"></a>单向链表代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkList</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录首节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;E&gt; head;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录链表的长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化头结点</span></span><br><span class="line">        head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 初始化元素个数</span></span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 空置线性表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        head.next = <span class="literal">null</span>;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断线性表是否为空，是返回true，否返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线性表中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取并返回线性表中的第i个元素的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过循环，从头结点开始往后找，依次找i次，就可以找到对应的元素</span></span><br><span class="line">        Node&lt;E&gt; n = head.next;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 往线性表中添加一个元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 找到当前最后一个节点</span></span><br><span class="line">        Node&lt;E&gt; n = head; <span class="comment">// 头节点不存储数据，所以不能算作第一个元素</span></span><br><span class="line">        <span class="keyword">while</span> (n.next != <span class="literal">null</span>) &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建新节点，保存元素t</span></span><br><span class="line">        <span class="comment">// 让当前最后一个元素指向新节点</span></span><br><span class="line">        n.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 元素个数+1</span></span><br><span class="line">        <span class="built_in">this</span>.n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在线性表的第i个元素之前插入一个值为t的数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> i, E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置前一个节点</span></span><br><span class="line">        Node&lt;E&gt; pre = head; <span class="comment">// 头节点不存储数据，所以不能算作第一个元素</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的节点</span></span><br><span class="line">        Node&lt;E&gt; current = pre.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建新节点，并且新节点需要指向原来i位置的节点</span></span><br><span class="line">        <span class="comment">// 原来i位置的前一个节点指向新节点</span></span><br><span class="line">        pre.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, current);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 元素个数+1</span></span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除并返回线性表中第i个数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置前一个节点</span></span><br><span class="line">        Node&lt;E&gt; pre = head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的节点</span></span><br><span class="line">        Node&lt;E&gt; current = pre.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的下一个节点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前一个节点指向下一个节点</span></span><br><span class="line">        pre.next = current.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 元素个数 - 1</span></span><br><span class="line">        n--;</span><br><span class="line">        <span class="keyword">return</span> current.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 从头结点开始，依次找到每一个节点，取出item，和t比较，如果相同，就返回</span></span><br><span class="line">        Node&lt;E&gt; n = head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; n.next != <span class="literal">null</span>; i++) &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">if</span> (n.item.equals(e)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储元素</span></span><br><span class="line">        T item;</span><br><span class="line">        <span class="comment">// 指向下一个节点</span></span><br><span class="line">        Node&lt;T&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(T item, Node&lt;T&gt; next) &#123;</span><br><span class="line">            <span class="built_in">this</span>.item = item;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="循环链表"><a href="#循环链表" class="headerlink" title="循环链表"></a>循环链表</h2><p>对于单向链表，由于每个结点只存储了向后的指针，到了尾标志就停止了向后链的操作，这样，当中某一结点就无法找到它的前驱结点了。</p><p>比如，你是一业务员，家在上海。需要经常出差，行程就是上海到北京一路上的城市，找客户谈生意或分公司办理业务。你从上海出发，乘火车路经多个城市停留后，再乘飞机返回上海，以后，每隔一段时间，你基本还要按照这样的行程开展业务，如图所示：</p><p><img src="https://img.gcdd.top/img/image-20221225170957533.png" alt="image-20221225170957533"></p><p>有一次，你先到南京开会，接下来要对以上的城市走一遍，此时有人对你说，不行，你得从上海开始，因为上海是第一站。你会对这人说什么？神经病。哪有这么傻的，直接回上海根本没有必要，你可以从南京开始，下一站蚌埠，直到北京，之后再考虑走完上海及苏南的几个城市。</p><p>显然这表示你是从当中一结点开始遍历整个链表，这都是原来的单链表结构解决不了的问题。事实上，把北京和上海之间连起来，形成一个环就解决了前面所面临的困难。这就是循环链表。</p><p>从刚才的例子，可以总结出，循环链表解决了一个很麻烦的问题。<strong>如何从当中一个结点出发，访问到链表的全部结点</strong>。</p><p>在单向链表中，最后一个节点的指针为NULL，不指向任何结点，因为没有下一个元素了。要实现循环链表，我们只需要让单向链表的最后一个节点的指针指向头结点即可。</p><p><img src="https://img.gcdd.top/img/image-20221225171126533.png" alt="image-20221225171126533"></p><p>如果链表中没有元素，那么头结点也需要指向自己，从而形成环</p><p><img src="https://img.gcdd.top/img/image-20221225171812749.png" alt="image-20221225171812749"></p><h3 id="循环链表代码实现"><a href="#循环链表代码实现" class="headerlink" title="循环链表代码实现"></a>循环链表代码实现</h3><p>代码实现和单向链表基本一致，只需要在插入尾结点的时候，将尾结点指向头结点即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// 找到当前最后一个节点</span></span><br><span class="line">    <span class="comment">// 头节点不存储数据，所以不能算作第一个元素</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">n</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="keyword">while</span> (n.next != <span class="literal">null</span>) &#123;</span><br><span class="line">        n = n.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建新节点，保存元素t，让当前最后一个元素指向新节点</span></span><br><span class="line">    <span class="comment">// 循环链表，最后一个元素指向头结点</span></span><br><span class="line">    n.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, head);</span><br><span class="line">    <span class="comment">// 元素个数+1</span></span><br><span class="line">    <span class="built_in">this</span>.n++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时，在构造和清空链表时，让头结点指向自己</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CycleLinkList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化头结点</span></span><br><span class="line">    head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    head.next = head;</span><br><span class="line">    <span class="comment">// 初始化元素个数</span></span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清空线性表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">    head.next = head;</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="双向链表"><a href="#双向链表" class="headerlink" title="双向链表"></a>双向链表</h2><p>继续刚才的例子，你平时都是从上海一路停留到北京的，可是这一次，你得先到北京开会，谁叫北京是首都呢，会就是多。开完会后，你需要例行公事，走访各个城市，此时你怎么办？</p><p><img src="https://img.gcdd.top/img/image-20221225194635114.png" alt="image-20221225194635114"></p><p>有人又出主意了，你可以先飞回上海，一路再乘火车走遍这几个城市，到了北京后，你再飞回上海。你会感慨，人生中为什么总会有这样出馊主意的人存在呢？真要气死人才行。哪来这么麻烦，我一路从北京坐火车或汽车回去不就完了吗。</p><p><img src="https://img.gcdd.top/img/image-20221225194724730.png" alt="image-20221225194724730"></p><p>我们的单链表，总是从头到尾找结点，难道就不可以正反遍历都可以吗？当然可以，只不过需要加点东西而已。</p><p>双向链表：在单链表的每个结点中，再设置一个指向其前驱结点的指针域。所以在双向链表中的结点都有两个指针域，一个指向直接后继，另一个指向直接前驱。</p><h3 id="双向链表结点设计"><a href="#双向链表结点设计" class="headerlink" title="双向链表结点设计"></a>双向链表结点设计</h3><table><thead><tr><th>类名</th><th>Node</th></tr></thead><tbody><tr><td>构造方法</td><td><code>Node(E e, Node pre, Node next)</code>：创建Node对象</td></tr><tr><td>成员变量</td><td><code>E item</code>：存储数据<br/><code>Node next</code>：指向下一个结点<br/><code>Node pre</code>：指向上一个结点</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">// 存储元素</span></span><br><span class="line">    E item;</span><br><span class="line">    <span class="comment">// 指向上一个节点</span></span><br><span class="line">    Node&lt;E&gt; pre;</span><br><span class="line">    <span class="comment">// 指向下一个节点</span></span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="双向链表设计"><a href="#双向链表设计" class="headerlink" title="双向链表设计"></a>双向链表设计</h3><table><thead><tr><th>类名</th><th><code>DoubleLinkList</code></th></tr></thead><tbody><tr><td>构造方法</td><td><code>DoubleLinkList()</code>：创建<code>DoubleLinkList</code>对象</td></tr><tr><td>成员方法</td><td><code>public void clear()</code>：空置线性表<br/><code>public boolean isEmpty()</code>：判断线性表是否为空，是返回true，否返回false<br/><code>public int length()</code>：获取线性表中元素的个数<br/><code>public T get(int i)</code>：读取并返回线性表中的第i个元素的值<br/><code>public void insert(E e)</code>：往线性表中添加一个元素；<br/><code>public void insert(int i, E e)</code>：在线性表的第i个元素之前插入一个值为t的数据元素。<br/><code>public T remove(int i)</code>：删除并返回线性表中第i个数据元素。<br/><code>public int indexOf(E e)</code>：返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1。<br/><code>public T getFirst()</code>：获取第一个元素<br/><code>public T getLast()</code>：获取最后一个元素</td></tr><tr><td>成员变量</td><td><code>private Node first</code>：记录首结点<br/><code>private Node last</code>：记录尾结点<br/><code>private int n</code>：记录链表的长度</td></tr></tbody></table><h3 id="双向链表代码实现"><a href="#双向链表代码实现" class="headerlink" title="双向链表代码实现"></a>双向链表代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DoubleLinkList</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录首节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;E&gt; head;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录尾节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node&lt;E&gt; last;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录链表的长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DoubleLinkList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化头结点</span></span><br><span class="line">        head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 初始化尾节点</span></span><br><span class="line">        last = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 初始化元素个数</span></span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 空置线性表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        head.next = <span class="literal">null</span>;</span><br><span class="line">        last = <span class="literal">null</span>;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断线性表是否为空，是返回true，否返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线性表中元素的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取头结点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">getFirst</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> head.next.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取尾节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">getLast</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> last.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取并返回线性表中的第i个元素的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过循环，从头结点开始往后找，依次找i次，就可以找到对应的元素</span></span><br><span class="line">        Node&lt;E&gt; n = head.next;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 往线性表中添加一个元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 如果链表为空</span></span><br><span class="line">            <span class="comment">// 创建新的节点</span></span><br><span class="line">            Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, head, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 让新节点成为尾节点</span></span><br><span class="line">            last = newNode;</span><br><span class="line">            <span class="comment">// 让头结点指向尾节点</span></span><br><span class="line">            head.next = last;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果链表不为空</span></span><br><span class="line">            Node&lt;E&gt; tempLast = last;</span><br><span class="line">            <span class="comment">// 创建新的节点</span></span><br><span class="line">            Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, tempLast, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 当前的尾节点指向新节点</span></span><br><span class="line">            tempLast.next = newNode;</span><br><span class="line">            <span class="comment">// 让新节点成为尾节点</span></span><br><span class="line">            last = newNode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 元素个数+1</span></span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在线性表的第i个元素之前插入一个值为t的数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> i, E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的前一个节点</span></span><br><span class="line">        Node&lt;E&gt; pre = head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 找到i位置的节点</span></span><br><span class="line">        Node&lt;E&gt; current = pre.next;</span><br><span class="line">        <span class="comment">// 创建新节点</span></span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;&gt;(e, pre, current);</span><br><span class="line">        <span class="comment">// 让i位置的前一个节点指向新节点</span></span><br><span class="line">        pre.next = newNode;</span><br><span class="line">        <span class="comment">// 让i位置的前一个节点变为新节点</span></span><br><span class="line">        current.pre = newNode;</span><br><span class="line">        <span class="comment">// 元素个数+1</span></span><br><span class="line">        n++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除并返回线性表中第i个数据元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;位置不合法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置前一个节点</span></span><br><span class="line">        Node&lt;E&gt; pre = head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; i; index++) &#123;</span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的节点</span></span><br><span class="line">        Node&lt;E&gt; current = pre.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到i位置的下一个节点</span></span><br><span class="line">        Node&lt;E&gt; next = current.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// i位置的前一个节点的下一个节点指向i位置的下一个节点</span></span><br><span class="line">        pre.next = next;</span><br><span class="line">        <span class="comment">// i位置的下一个节点的前一个节点指向i位置的前一个节点</span></span><br><span class="line">        next.pre = pre;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 元素个数 - 1</span></span><br><span class="line">        n--;</span><br><span class="line">        <span class="keyword">return</span> current.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回线性表中首次出现的指定的数据元素的位序号，若不存在，则返回-1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// 从头结点开始，依次找到每一个节点，取出item，和t比较，如果相同，就返回</span></span><br><span class="line">        Node&lt;E&gt; n = head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; n.next != <span class="literal">null</span>; i++) &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">if</span> (n.item.equals(e)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        <span class="comment">// 存储元素</span></span><br><span class="line">        E item;</span><br><span class="line">        <span class="comment">// 指向上一个节点</span></span><br><span class="line">        Node&lt;E&gt; pre;</span><br><span class="line">        <span class="comment">// 指向下一个节点</span></span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">LIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Node&lt;E&gt; n = head;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n.next != <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> E <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">return</span> n.item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="链表的时间复杂度"><a href="#链表的时间复杂度" class="headerlink" title="链表的时间复杂度"></a>链表的时间复杂度</h2><p><code>get(int i)</code>：每一次查询，都需要从链表的头部开始，依次向后查找，随着数据元素N的增多，比较的元素越多，时间复杂度为O(n)。<br><code>insert(int i, E e)</code>：每一次插入，需要先找到i位置的前一个元素，然后完成插入操作，随着数据元素N的增多，查找的元素越多，时间复杂度为O(n)。<br><code>remove(int i)</code>：每一次移除，需要先找到i位置的前一个元素，然后完成插入操作，随着数据元素N的增多，查找的元素越多，时间复杂度为O(n)<br>相比较顺序表，链表插入和删除的时间复杂度虽然一样，但仍然有很大的优势，因为链表的物理地址是不连续的，它<strong>不需要预先指定存储空间大小</strong>，并且在存储过程中<strong>不涉及到扩容等操作</strong>，同时它并没有涉及的元素的交换。<br>相比较顺序表，链表的查询操作性能会比较低。因此，如果我们的程序中<strong>查询操作比较多，建议使用顺序表，增删操作比较多，建议使用链表</strong>。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;线性表定义&quot;&gt;&lt;a href=&quot;#线性表定义&quot; class=&quot;headerlink&quot; title=&quot;线性表定义&quot;&gt;&lt;/a&gt;线性表定义&lt;/h1&gt;&lt;p&gt;线性表（List）：零个或多个数据元素的有限序列。&lt;/p&gt;
&lt;p&gt;首先它是一个序列，其次，线性表强调是有限的。&lt;/p</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>SKyWalking全链路追踪（二）Java应用接入SkyWalking Agent</title>
    <link href="https://blog.gcdd.top/p/17672/"/>
    <id>https://blog.gcdd.top/p/17672/</id>
    <published>2022-09-17T09:46:28.000Z</published>
    <updated>2024-01-25T09:08:27.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-Agent简介"><a href="#Java-Agent简介" class="headerlink" title="Java Agent简介"></a>Java Agent简介</h1><p>参考：<a href="https://www.cnblogs.com/Mateo-dengmin/p/15855157.html">Java Agent介绍与使用</a></p><blockquote><p>Java Agent是在Java 1.5版本之才有的东西，他可以构建一个独立Java服务外的一个代理程序，也就是Agent。通常会用它来做一下Java服务的监控，或者替换其他JVM上的程序，还可以实现虚拟机上的AOP功能。</p></blockquote><p>SkyWalking使用了Java Agent作为接入方式，实现了代码0入侵，非常方便。具体的Java Agent技术不在这过多赘述。<span id="more"></span></p><h1 id="SpringBoot接入SkyWalking"><a href="#SpringBoot接入SkyWalking" class="headerlink" title="SpringBoot接入SkyWalking"></a>SpringBoot接入SkyWalking</h1><h2 id="下载Java-Agent"><a href="#下载Java-Agent" class="headerlink" title="下载Java Agent"></a>下载Java Agent</h2><p>官方地址是：<a href="https://skywalking.apache.org/downloads/%EF%BC%8C%E4%B8%8D%E8%BF%87%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A0%AA%E5%BF%A7">https://skywalking.apache.org/downloads/，不过下载速度堪忧</a></p><p><img src="https://img.gcdd.top/img/image-20220917175552943.png" alt="image-20220917175552943"></p><p>这里准备了一个Java Agent 8.11版本的阿里云盘链接，需要的可以从这里下载：<br><a href="https://www.aliyundrive.com/s/z8sst2mgPxC">https://www.aliyundrive.com/s/z8sst2mgPxC</a> 提取码：BpcF</p><h2 id="安装Java-Agent"><a href="#安装Java-Agent" class="headerlink" title="安装Java Agent"></a>安装Java Agent</h2><p>把上面下载的好的文件解压，得到一个如下文件夹</p><p><img src="https://img.gcdd.top/img/image-20220917180038464.png" alt="image-20220917180038464"></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://skyapm.github.io/document-cn-translation-of-skywalking/zh/8.0.0/setup/service-agent/java-agent/">安装Java Agent</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Java-Agent简介&quot;&gt;&lt;a href=&quot;#Java-Agent简介&quot; class=&quot;headerlink&quot; title=&quot;Java Agent简介&quot;&gt;&lt;/a&gt;Java Agent简介&lt;/h1&gt;&lt;p&gt;参考：&lt;a href=&quot;https://www.cnblogs.com/Mateo-dengmin/p/15855157.html&quot;&gt;Java Agent介绍与使用&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Java Agent是在Java 1.5版本之才有的东西，他可以构建一个独立Java服务外的一个代理程序，也就是Agent。通常会用它来做一下Java服务的监控，或者替换其他JVM上的程序，还可以实现虚拟机上的AOP功能。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;SkyWalking使用了Java Agent作为接入方式，实现了代码0入侵，非常方便。具体的Java Agent技术不在这过多赘述。</summary>
    
    
    
    <category term="数据结构与算法入门" scheme="https://blog.gcdd.top/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/"/>
    
    
    <category term="数据结构与算法" scheme="https://blog.gcdd.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>SkyWalking全链路追踪（一）部署和初体验</title>
    <link href="https://blog.gcdd.top/p/45444/"/>
    <id>https://blog.gcdd.top/p/45444/</id>
    <published>2022-09-17T07:44:45.000Z</published>
    <updated>2024-01-25T09:08:27.036Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="SkyWalking-是什么？"><a href="#SkyWalking-是什么？" class="headerlink" title="SkyWalking 是什么？"></a>SkyWalking 是什么？</h2><blockquote><p>分布式系统的应用程序性能监视工具，专为微服务、云原生架构和基于容器（Docker、K8s、Mesos）架构而设计。<br>提供分布式追踪、服务网格遥测分析、度量聚合和可视化一体化解决方案。</p></blockquote><p>简单来说，SkyWalking是一款全链路追踪系统，可以视为OpenTracing的一种实现，类似的还有Zipkin、Jaeger等等，但是SkyWalking的接入方式采用了Java Agent的方式，达到了0代码无侵入，接入成本几乎为零。所以非常推荐使用。</p><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>参考官方文档，简要的总结下<code>DockerCompose</code>的部署方式。</p><h2 id="新建docker-compose-yaml文件"><a href="#新建docker-compose-yaml文件" class="headerlink" title="新建docker-compose.yaml文件"></a>新建docker-compose.yaml文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.17.6</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./esdata01:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [ <span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;curl --silent --fail localhost:9200/_cluster/health || exit 1&quot;</span> ]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.type=single-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">oap:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-oap-server:8.9.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oap</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">elasticsearch:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11800:11800&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;12800:12800&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [ <span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;/skywalking/bin/swctl ch&quot;</span> ]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SW_STORAGE:</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="attr">SW_STORAGE_ES_CLUSTER_NODES:</span> <span class="string">elasticsearch:9200</span></span><br><span class="line">      <span class="attr">SW_HEALTH_CHECKER:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">SW_TELEMETRY:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Xms2048m -Xmx2048m&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-ui:8.9.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ui</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">oap:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oap</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8090:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SW_OAP_ADDRESS:</span> <span class="string">http://oap:12800</span></span><br></pre></td></tr></table></figure><h2 id="运行docker-compose命令"><a href="#运行docker-compose命令" class="headerlink" title="运行docker-compose命令"></a>运行docker-compose命令</h2><p>运行一下命令就可以启动SkyWalking，存储后端是Elasticsearch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">...</span><br><span class="line">Container elasticsearch  Started</span><br><span class="line">Container elasticsearch  Waiting</span><br><span class="line">Container elasticsearch  Healthy</span><br><span class="line">Container oap  Starting</span><br><span class="line">Container oap  Started</span><br><span class="line">Container oap  Waiting</span><br><span class="line">Container oap  Healthy</span><br><span class="line">Container ui  Starting</span><br><span class="line">Container ui  Started</span><br></pre></td></tr></table></figure><p>然后打开<a href="http://localhost:8090/">http://localhost:8090/</a></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6436355a04c143c6812c22921e636b73~tplv-k3u1fbpfcp-watermark.image" alt="image.png"><br>这样就部署完成了，是不是非常简单？</p><h2 id="更换存储后端"><a href="#更换存储后端" class="headerlink" title="更换存储后端"></a>更换存储后端</h2><p>SkyWalking官方推荐使用Elasticsearch作为存储后端，但是还支持其他的作为存储后端。具体可以参考：<a href="https://skyapm.github.io/document-cn-translation-of-skywalking/zh/8.0.0/setup/backend/backend-storage.html">https://skyapm.github.io/document-cn-translation-of-skywalking/zh/8.0.0/setup/backend/backend-storage.html</a></p><p>原生支持的存储</p><ul><li>  H2</li><li>  ElasticSearch 6, 7</li><li>  MySQL</li><li>  TiDB</li><li>  InfluxDB</li></ul><p>支持存储的重分发版本。</p><ul><li>  ElasticSearch 5</li></ul><p>各个存储后端的配置如下，我们如果要更换，只需要配置<code>docker-compose.yaml</code>的环境变量即可</p><h3 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h3><blockquote><p>H2是嵌入式数据库，一般测试使用，生产禁止使用</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:h2&#125;</span></span><br><span class="line">  <span class="attr">h2:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">org.h2.jdbcx.JdbcDataSource</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:skywalking-oap-db</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">sa</span></span><br></pre></td></tr></table></figure><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:elasticsearch&#125;</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="comment"># nameSpace: $&#123;SW_NAMESPACE:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_ES_USER:&quot;&quot;&#125;</span> <span class="comment"># User needs to be set when Http Basic authentication is enabled</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_ES_PASSWORD:&quot;&quot;&#125;</span> <span class="comment"># Password to be set when Http Basic authentication is enabled</span></span><br><span class="line">    <span class="attr">clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:443&#125;</span></span><br><span class="line">    <span class="attr">trustStorePath:</span> <span class="string">$&#123;SW_SW_STORAGE_ES_SSL_JKS_PATH:&quot;../es_keystore.jks&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePass:</span> <span class="string">$&#123;SW_SW_STORAGE_ES_SSL_JKS_PASS:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:&quot;https&quot;&#125;</span></span><br><span class="line">    <span class="attr">indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:2&#125;</span></span><br><span class="line">    <span class="attr">indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:0&#125;</span></span><br><span class="line">    <span class="comment"># Batch process setting, refer to https://www.elastic.co/guide/en/elasticsearch/client/java-api/5.5/java-docs-bulk-processor.html</span></span><br><span class="line">    <span class="attr">bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:2000&#125;</span> <span class="comment"># Execute the bulk every 2000 requests</span></span><br><span class="line">    <span class="attr">bulkSize:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_SIZE:20&#125;</span> <span class="comment"># flush the bulk every 20mb</span></span><br><span class="line">    <span class="attr">flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line">    <span class="attr">concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line">    <span class="attr">advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:&quot;&quot;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:mysql&#125;</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:mysql://localhost:3306/swtest&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:root@1234&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br></pre></td></tr></table></figure><h3 id="TiDB"><a href="#TiDB" class="headerlink" title="TiDB"></a>TiDB</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:mysql&#125;</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:mysql://localhost:3306/swtest&quot;&#125;</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:root@1234&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br></pre></td></tr></table></figure><h3 id="InfluxDB"><a href="#InfluxDB" class="headerlink" title="InfluxDB"></a>InfluxDB</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:influxdb&#125;</span></span><br><span class="line">  <span class="attr">influxdb:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_URL:http://localhost:8086&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_USER:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_PASSWORD:&#125;</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DATABASE:skywalking&#125;</span></span><br><span class="line">    <span class="attr">actions:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_ACTIONS:1000&#125;</span> <span class="comment"># the number of actions to collect</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DURATION:1000&#125;</span> <span class="comment"># the time to wait at most (milliseconds)</span></span><br><span class="line">    <span class="attr">fetchTaskLogMaxSize:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000&#125;</span> <span class="comment"># the max number of fetch task log in a request</span></span><br></pre></td></tr></table></figure><p>以<code>InfluxDB</code>举例替换存储后端</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">influxdb:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bitnami/influxdb:1.8.5</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">influxdb-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8086:8086&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INFLUXDB_ADMIN_USER_TOKEN=FvSo2szLLZ88qJrk</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INFLUXDB_ADMIN_USER_PASSWORD=FvSo2szLLZ88qJrk</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INFLUXDB_USER=gcdd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INFLUXDB_USER_PASSWORD=FvSo2szLLZ88qJrk</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INFLUXDB_DB=skywalking</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data:/bitnami/influxdb&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">oap:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-oap-server:8.9.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oap</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">influxdb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;11800:11800&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;12800:12800&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SW_STORAGE:</span> <span class="string">influxdb</span></span><br><span class="line">      <span class="attr">SW_STORAGE_INFLUXDB_URL:</span> <span class="string">http://influxdb:8086</span></span><br><span class="line">      <span class="attr">SW_STORAGE_INFLUXDB_USER:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">SW_STORAGE_INFLUXDB_PASSWORD:</span> <span class="string">FvSo2szLLZ88qJrk</span></span><br><span class="line">      <span class="attr">SW_HEALTH_CHECKER:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">SW_TELEMETRY:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Xms2048m -Xmx2048m&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ui:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/skywalking-ui:8.9.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ui</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oap</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8090:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SW_OAP_ADDRESS:</span> <span class="string">http://oap:12800</span></span><br></pre></td></tr></table></figure><h1 id="初体验"><a href="#初体验" class="headerlink" title="初体验"></a>初体验</h1><p>SkyWalking的UI做的还是非常可以的，美观且实用。</p><p>参考：<a href="https://www.jianshu.com/p/055e4223d054">APM-Skywalking UI使用全攻略</a></p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-6e36b215372fdb2b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h2 id="指标仪表盘"><a href="#指标仪表盘" class="headerlink" title="指标仪表盘"></a>指标仪表盘</h2><h3 id="服务指标"><a href="#服务指标" class="headerlink" title="服务指标"></a>服务指标</h3><p>点击<strong>仪表盘</strong>，选择要查询的应用，如“is-file-store”, 再切换仪表盘为“Service”模式，即可查询对应服务的指标</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-5011ab151da60597.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h4 id="服务主要指标包括"><a href="#服务主要指标包括" class="headerlink" title="服务主要指标包括"></a>服务主要指标包括</h4><ul><li><code>ApdexScore</code>： 性能指数，Apdex(Application Performance Index)是一个国际通用标准，Apdex 是用户对应用性能满意度的量化值。它提供了一个统一的测量和报告用户体验的方法，把最终用户的体验和应用性能作为一个完整的指标进行统一度量，其中最高为1最低为0；</li><li><code>ResponseTime</code>：响应时间，即在选定时间内，服务所有请求的平均响应时间(<em>ms</em>)；</li><li><code>Throughput</code>: 吞吐量，即在选定时间内，每分钟服务响应的请求量(<em>cpm</em>)</li><li><code>SLA</code>: service level agreement，服务等级协议，SW中特指每分钟内响应成功请求的占比。</li></ul><p>大盘中会列出以上指标的当前的平均值，和历史走势。</p><h4 id="服务慢端点-Service-Slow-Endpoint"><a href="#服务慢端点-Service-Slow-Endpoint" class="headerlink" title="服务慢端点 Service Slow Endpoint"></a>服务慢端点 Service Slow Endpoint</h4><p>服务指标仪表盘会列举出当前服务响应时间最大的端点Top5，如果有端点的响应时间过高，则需要进一步关注其指标（点击可以复制端点名称）。</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-882e585e785e5a47.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1156/format/webp" alt="img"></p><h4 id="运行中的实例-Running-ServiceInstance"><a href="#运行中的实例-Running-ServiceInstance" class="headerlink" title="运行中的实例 Running ServiceInstance"></a>运行中的实例 Running ServiceInstance</h4><p>该服务目前所有实例的吞吐量情况，通过此可以推断出实例之间的负载情况。如果发现某个实例吞吐量较低，就需要查询实例指标（如查询该实例是不是发生了GC，或则CPU利用率过高）</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-08ecc2936bc9c9e7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/752/format/webp" alt="img"></p><h3 id="端点指标"><a href="#端点指标" class="headerlink" title="端点指标"></a>端点指标</h3><p>如果发现有端点的响应时间过高，可以进一步查询该端点的指标信息。和服务指标类似，端点指标也包括吞吐量、SLA、响应时间等指标，这里不再赘述。</p><p>端点仪表盘会有如下特有信息：</p><ol><li>Dependency Map: 依赖关系图，代表哪些服务在依赖（调用）该端点，如果是前端直接调用，会显示为用户（<em>User</em>）依赖中；</li><li>Slow Traces: 即慢调用请求记录，SW会自动列出当前时间段内端点最慢的调用记录和<em>TraceID</em>，通过这个ID可以在追踪功能找到具体的调用链信息，便于定位。</li></ol><p><img src="https://upload-images.jianshu.io/upload_images/3297585-1e128977c8ac20ab.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h3 id="服务实例指标"><a href="#服务实例指标" class="headerlink" title="服务实例指标"></a>服务实例指标</h3><p>选择服务的实例并切换仪表盘，即可查看服务某个实例的指标数据。除了常规的吞吐量、SLA、响应时间等指标外，实例信息中还会给出JVM的信息，如堆栈使用量，GC耗时和次数等。</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-13142c78fae5d589.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h3 id="DB-数据指标查询"><a href="#DB-数据指标查询" class="headerlink" title="DB 数据指标查询"></a>DB 数据指标查询</h3><p>除了服务本身的指标，SW也监控了服务依赖的DB指标。切换DB指标盘并选择对应DB实例，就可以看到从服务角度（client）来看该DB实例的吞吐量、SLA、响应时间等指标。</p><p>更进一步，该DB执行慢SQL会被自动列出，可以直接粘贴出来，便于定位耗时原因。</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-567a3d7e3a0e930d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h2 id="拓扑结构"><a href="#拓扑结构" class="headerlink" title="拓扑结构"></a>拓扑结构</h2><ul><li><strong>不同于仪表盘来展示单一服务的指标，拓扑图是来展示服务和服务之间的依赖关系。</strong></li><li><strong>用户可以选择单一服务查询，也可以将多个服务设定为一组同时查询。</strong></li><li><strong>点击服务图片会自动显示当前的服务指标；</strong></li><li><strong>SW会根据请求数据，自动探测出依赖的服务，DB和中间件等。</strong></li><li><strong>点击依赖线上的圆点，会显示服务之间的依赖情况，如每分钟吞吐量，平均延迟时间，和侦察端模式（client/Server）。</strong></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/3297585-a65dcaaef433ea8e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h2 id="请求追踪"><a href="#请求追踪" class="headerlink" title="请求追踪"></a>请求追踪</h2><p>当用户发现服务的SLA降低，或者某个具体的端口响应时间上扬明显，可以使用追踪功能查询具体的请求记录。</p><ul><li>最上方为搜索区，用户可以指定搜索条件，如隶属于哪个服务、哪个实例、哪个端口，或者请求是成功还是失败；也可以根据上文提到的TraceID精确查询。</li><li>整个调用链上每一个跨度的耗时和执行结果都会被列出（默认是列表，也可选择树形结构和表格的形式）；</li><li>如果有步骤失败，该步骤会标记为红色。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/3297585-a8389d054a34c0d5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><ul><li>点击跨度，会显示跨度详情，如果有异常发生，异常的种类、信息和堆栈都会被自动捕获；</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/3297585-559579a89401e66e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><ul><li>如果跨度为数据库操作，执行的SQL也会被自动记录。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/3297585-ce3ba14ea7713eb5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h2 id="性能剖析"><a href="#性能剖析" class="headerlink" title="性能剖析"></a>性能剖析</h2><p>追踪功能展示出的跨度是服务调用粒度的，如果要看应用实时的堆栈信息，可以选择性能剖析功能。</p><ul><li>新建分析任务；</li><li>选指定的服务和端点作为分析对象；</li><li>设定采样频率和次数；</li></ul><blockquote><p><strong>注意: 如果端点的响应时间小于监控间隔，可能会导致采样分析失败。</strong></p></blockquote><p><img src="https://upload-images.jianshu.io/upload_images/3297585-59ed13e92c2c640b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><p>新建任务后，SW将开始采集应用的实时堆栈信息。采样结束后，用户点击分析即可查看具体的堆栈信息。</p><ol><li>点击跨度右侧的“查看”，可以看到调用链的具体详情；</li><li>跨度目录下方是SW收集到的具体进程堆栈信息和耗时情况。</li></ol><p><img src="https://upload-images.jianshu.io/upload_images/3297585-b1d62d12a13b9b0b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><p>需要提醒的时候，性能剖析功能因为要实时高频率收集服务的JVM堆栈信息，对于服务本身有一定的性能消耗，只适用于耗时端点的行为分析。</p><h2 id="指标对比"><a href="#指标对比" class="headerlink" title="指标对比"></a>指标对比</h2><p>当用户需要对比不同端点指标的关联情况的话，可以使用性能对比功能。选择待对比的端点和指标，SW将会列出相同时间段的指标记录。如下图中，两个端点虽然属于不同的应用，但是在响应时间的指标，表现出一定的关联性。实际上两个端点有依赖关系，一个响应时间变多，另一个也会变多。</p><p><img src="https://upload-images.jianshu.io/upload_images/3297585-ea66be6e35d37238.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://skywalking.apache.org/zh/2020-04-19-skywalking-quick-start/">SkyWalking 极简入门</a></li><li><a href="https://skyapm.github.io/document-cn-translation-of-skywalking/">SkyWalking 文档中文版（社区提供）</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;h2 id=&quot;SkyWalking-是什么？&quot;&gt;&lt;a href=&quot;#SkyWalking-是什么？&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    <category term="数据结构与算法入门" scheme="https://blog.gcdd.top/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/"/>
    
    
    <category term="数据结构与算法" scheme="https://blog.gcdd.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>切换博客到七牛云</title>
    <link href="https://blog.gcdd.top/p/62528/"/>
    <id>https://blog.gcdd.top/p/62528/</id>
    <published>2022-09-02T16:41:07.000Z</published>
    <updated>2023-08-30T04:52:53.895Z</updated>
    
    <content type="html"><![CDATA[<p>很早之前就已经把博客的图床更换为了七牛云，但是博客本身还是托管在Github上面。最近，Github的访问速度是在太慢了，所以准备把博客整体迁移到七牛云上面，加快下国内的访问速度。<span id="more"></span></p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>照着<a href="https://juejin.cn/post/6844903983857811469">将hexo博客一键部署到七牛云</a>这个应该能准备妥当，这里不再赘述。</p><h1 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h1><h2 id="申请域名"><a href="#申请域名" class="headerlink" title="申请域名"></a>申请域名</h2><p>要玩七牛云，首先得有个域名（<strong>必须已备案</strong>），申请好域名，然后进行下一步</p><h2 id="新建七牛云空间"><a href="#新建七牛云空间" class="headerlink" title="新建七牛云空间"></a>新建七牛云空间</h2><p>空间管理 -&gt; 新建空间。</p><p>存储空间名称随便填，不重复就行。</p><p>访问控制选择公开，毕竟我们是做博客，总要让人访问吧。</p><p><img src="https://img.gcdd.top/img/image-20220903004700318.png" alt="image-20220903004700318"></p><h2 id="开启默认首页设置"><a href="#开启默认首页设置" class="headerlink" title="开启默认首页设置"></a>开启默认首页设置</h2><p><img src="https://img.gcdd.top/img/image-20220903004842235.png" alt="image-20220903004842235"></p><h2 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h2><blockquote><p>再次强调：七牛云要求域名必须是备案域名</p></blockquote><p>然后空间管理，点击域名，填入域名，然后选择证书，然后照着提示一步步配置就行，没什么坑。</p><p><img src="https://img.gcdd.top/img/image-20220903005021019.png" alt="image-20220903005021019"></p><p>绑定完成后如下图所示</p><blockquote><p>这边注意下，七牛云的CDN加速是收费的，但是不贵，之前做图床的时候，半年才花了5毛钱。</p><p>不知道用来做博客，费用多不多</p></blockquote><p><img src="https://img.gcdd.top/img/image-20220903005230379.png" alt="image-20220903005230379"></p><h1 id="Hexo打包一键发布到七牛云"><a href="#Hexo打包一键发布到七牛云" class="headerlink" title="Hexo打包一键发布到七牛云"></a>Hexo打包一键发布到七牛云</h1><blockquote><p>一键发布，用到了七牛云的一个官方工具，可以用于批量上传文件至七牛云空间。</p></blockquote><h2 id="下载qshell"><a href="#下载qshell" class="headerlink" title="下载qshell"></a>下载qshell</h2><p><a href="https://github.com/qiniu/qshell%EF%BC%8C%E8%BF%9B%E5%85%A5release%E6%89%BE%E4%B8%AA%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD%E5%B0%B1%E8%A1%8C">https://github.com/qiniu/qshell，进入release找个最新版本下载就行</a></p><p><img src="https://img.gcdd.top/img/image-20220903005544168.png" alt="image-20220903005544168"></p><p>下载完成之后，我们解压到hexo目录，并改名为qshell</p><h2 id="登录qshell"><a href="#登录qshell" class="headerlink" title="登录qshell"></a>登录qshell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qshell account &lt;Your AccessKey&gt; &lt;Your SecretKey&gt; &lt;Your Name&gt;</span><br></pre></td></tr></table></figure><p><code>AccessKey</code>和<code>SecretKey</code>在这里可以找到<a href="https://portal.qiniu.com/user/key">https://portal.qiniu.com/user/key</a></p><p><img src="https://img.gcdd.top/img/image-20220903005955998.png" alt="image-20220903005955998"></p><h2 id="配置upload-conf"><a href="#配置upload-conf" class="headerlink" title="配置upload.conf"></a>配置upload.conf</h2><p>在博客目录下面，新建文件<code>upload.conf</code>，然后配置信息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// 这个地址是根目录地址，不可使用相对路径</span></span><br><span class="line">  <span class="attr">&quot;src_dir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:/WorkSpace/Personal/blog-source/public&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 储存空间名称</span></span><br><span class="line">  <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gcdd-hexo&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 是否覆盖</span></span><br><span class="line">  <span class="attr">&quot;overwrite&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 检查新增文件</span></span><br><span class="line">  <span class="attr">&quot;rescan_local&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">qshell qupload upload.conf</span><br><span class="line"></span><br><span class="line">Writing upload <span class="built_in">log</span> to file C:\Users\13983\.qshell\qupload\2496be155bc149325a6994afc3b76d8f\2496be155bc149325a6994afc3b76d8f.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\404.html =&gt; 404.html [1/245, 0.4%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\CNAME =&gt; CNAME [2/245, 0.8%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\01\index.html =&gt; archives/2019/01/index.html [3/245, 1.2%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\01\page\2\index.html =&gt; archives/2019/01/page/2/index.html [4/245, 1.6%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\03\index.html =&gt; archives/2019/03/index.html [5/245, 2.0%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\04\index.html =&gt; archives/2019/04/index.html [6/245, 2.4%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\05\index.html =&gt; archives/2019/05/index.html [7/245, 2.9%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\06\index.html =&gt; archives/2019/06/index.html [8/245, 3.3%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\archives\2019\07\index.html =&gt; archives/2019/07/index.html [9/245, 3.7%] ...</span><br><span class="line">Uploading D:\WorkSpace\Personal\blog-source\public\tags\默认\index.html =&gt; tags/默认/index.html [245/245, 100.0%] ...</span><br><span class="line"></span><br><span class="line">See upload <span class="built_in">log</span> at path C:\Users\13983\.qshell\qupload\2496be155bc149325a6994afc3b76d8f\2496be155bc149325a6994afc3b76d8f.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><p>等进度条转完，也就部署完毕了，速度很快。</p><p>访问下试试：<a href="https://blog.gcdd.top/%EF%BC%8C%E5%97%AF%EF%BC%8C%E9%80%9F%E5%BA%A6%E9%9D%9E%E5%B8%B8%E5%BF%AB%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BD%93%E6%88%90%E4%B8%BB%E5%8A%9B%E5%8D%9A%E5%AE%A2%E6%9D%A5%E4%BD%BF%E7%94%A8%E4%BA%86%E3%80%82">https://blog.gcdd.top/，嗯，速度非常快，可以当成主力博客来使用了。</a></p><h2 id="一键打包上传"><a href="#一键打包上传" class="headerlink" title="一键打包上传"></a>一键打包上传</h2><p>自己写了个脚本，用用用用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">hexo clean &amp;&amp;  <span class="comment"># 清理旧的网站</span></span><br><span class="line">  hexo generate &amp;&amp; gulp &amp;&amp; <span class="comment"># 生成新的页面</span></span><br><span class="line">  hexo d &amp;&amp;    <span class="comment"># 生成新的静态网站</span></span><br><span class="line">  hexo algolia <span class="comment"># 生成搜索索引</span></span><br><span class="line">qshell qupload upload.conf <span class="comment"># 上传至七牛云</span></span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://juejin.cn/post/6844903983857811469">将hexo博客一键部署到七牛云</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;很早之前就已经把博客的图床更换为了七牛云，但是博客本身还是托管在Github上面。最近，Github的访问速度是在太慢了，所以准备把博客整体迁移到七牛云上面，加快下国内的访问速度。</summary>
    
    
    
    <category term="数据结构与算法入门" scheme="https://blog.gcdd.top/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/"/>
    
    
    <category term="数据结构与算法" scheme="https://blog.gcdd.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>切换国内源大全（收集整理）</title>
    <link href="https://blog.gcdd.top/p/14719/"/>
    <id>https://blog.gcdd.top/p/14719/</id>
    <published>2021-11-19T03:08:07.000Z</published>
    <updated>2023-08-30T04:52:53.908Z</updated>
    
    <content type="html"><![CDATA[<p>众所周知，国内的网络环境太糟糕了，所以收集整理各类服务切换国内源的方法<span id="more"></span></p><h1 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h1><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 备份系统自带的source列表</span></span><br><span class="line">sudo <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak \</span><br><span class="line">&amp;&amp; sed -i <span class="string">&#x27;s/^\(deb\|deb-src\) \([^ ]*\) \(.*\)/\1 http:\/\/mirrors.aliyun.com\/ubuntu \3/&#x27;</span> /etc/apt/sources.list \</span><br><span class="line">&amp;&amp; apt-get update</span><br></pre></td></tr></table></figure><h2 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h2><table><thead><tr><th>名称</th><th>地址</th></tr></thead><tbody><tr><td>阿里镜像源</td><td><a href="http://mirrors.aliyun.com/ubuntu">http://mirrors.aliyun.com/ubuntu</a></td></tr><tr><td>清华大学镜像源</td><td><a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu/">https://mirrors.tuna.tsinghua.edu.cn/ubuntu/</a></td></tr><tr><td>网易镜像源</td><td><a href="https://mirrors.163.com/ubuntu/">https://mirrors.163.com/ubuntu/</a></td></tr><tr><td>东北大学镜像源</td><td><a href="http://mirror.neu.edu.cn/ubuntu/">http://mirror.neu.edu.cn/ubuntu/</a></td></tr></tbody></table><h1 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h1><h2 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -e <span class="string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> \</span><br><span class="line">         -e <span class="string">&#x27;s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn|g&#x27;</span> \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo \</span><br><span class="line"><span class="comment"># 更新软件包缓存</span></span><br><span class="line">&amp;&amp; sudo yum makecache</span><br></pre></td></tr></table></figure><h2 id="国内镜像源-1"><a href="#国内镜像源-1" class="headerlink" title="国内镜像源"></a>国内镜像源</h2><table><thead><tr><th>名称</th><th>地址</th></tr></thead><tbody><tr><td>阿里镜像源</td><td><a href="http://mirrors.aliyun.com/centos">http://mirrors.aliyun.com/centos</a></td></tr><tr><td>清华大学镜像源</td><td><a href="https://mirrors.tuna.tsinghua.edu.cn/centos">https://mirrors.tuna.tsinghua.edu.cn/centos</a></td></tr><tr><td>网易镜像源</td><td><a href="https://mirrors.163.com/centos">https://mirrors.163.com/centos</a></td></tr><tr><td>东北大学镜像源</td><td><a href="http://mirror.neu.edu.cn/centos">http://mirror.neu.edu.cn/centos</a></td></tr></tbody></table><h1 id="Alpine"><a href="#Alpine" class="headerlink" title="Alpine"></a>Alpine</h1><h2 id="命令-2"><a href="#命令-2" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/apk/repositories /etc/apk/repositories.bak \</span><br><span class="line">    &amp;&amp; sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories \</span><br><span class="line">    &amp;&amp; apk update</span><br></pre></td></tr></table></figure><h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="命令-3"><a href="#命令-3" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改/etc/docker/daemon.json#registry-mirrors</span></span><br><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>:[</span><br><span class="line">    <span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://f1361db2.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirror.baidubce.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h1 id="Maven-Gradle"><a href="#Maven-Gradle" class="headerlink" title="Maven/Gradle"></a>Maven/Gradle</h1><blockquote><p>在<code>setting.gradle</code>里面修改，Gradle版本6以上</p></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        repositories &#123;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/google&#x27;</span> &#125;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/gradle-plugin&#x27;</span> &#125;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/public/&#x27;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mavenCentral()</span><br><span class="line">        gradlePluginPortal()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>) &#125; <span class="comment">// central</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span>) &#125; <span class="comment">// jcenter &amp; public</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span>) &#125; <span class="comment">// google</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/spring&quot;</span>) &#125; <span class="comment">// spring</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/spring-plugin&quot;</span>) &#125; <span class="comment">// spring plugin</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/grails-core&quot;</span>) &#125; <span class="comment">// spring plugin</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><h2 id="命令-4"><a href="#命令-4" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><h2 id="国内镜像源-2"><a href="#国内镜像源-2" class="headerlink" title="国内镜像源"></a>国内镜像源</h2><table><thead><tr><th>名称</th><th>地址</th></tr></thead><tbody><tr><td>清华源</td><td><a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></td></tr><tr><td>阿里源</td><td><a href="https://mirrors.aliyun.com/pypi/simple/">https://mirrors.aliyun.com/pypi/simple/</a></td></tr><tr><td>腾讯源</td><td><a href="http://mirrors.cloud.tencent.com/pypi/simple">http://mirrors.cloud.tencent.com/pypi/simple</a></td></tr><tr><td>豆瓣源</td><td><a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a></td></tr></tbody></table><h1 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h1><h2 id="命令-5"><a href="#命令-5" class="headerlink" title="命令"></a>命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">$ npm config get registry</span><br><span class="line">https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://developer.aliyun.com/mirror">阿里云镜像</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;众所周知，国内的网络环境太糟糕了，所以收集整理各类服务切换国内源的方法</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="运维" scheme="https://blog.gcdd.top/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第七章 类型进阶</title>
    <link href="https://blog.gcdd.top/p/23035/"/>
    <id>https://blog.gcdd.top/p/23035/</id>
    <published>2021-11-18T12:22:39.000Z</published>
    <updated>2023-08-30T04:52:53.891Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要介绍Kotlin类型一些不为人知的秘密<span id="more"></span></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118202512.png" alt="image-20211118202509898"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118202539.png" alt="image-20211118202537590"></p><h1 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h1><h2 id="构造器的基本写法"><a href="#构造器的基本写法" class="headerlink" title="构造器的基本写法"></a>构造器的基本写法</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(</span><br><span class="line">    <span class="keyword">var</span> age: <span class="built_in">Int</span>, <span class="comment">// 类内全局可见</span></span><br><span class="line">    name: String <span class="comment">// 构造器内可见（init块，属性初始化）</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="init块"><a href="#init块" class="headerlink" title="init块"></a>init块</h2><blockquote><p><code>init</code>块可以有多个</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">var</span> age: <span class="built_in">Int</span>, name: String) &#123;</span><br><span class="line">    <span class="keyword">var</span> name: String</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> firstName = name.split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="属性必须被初始化"><a href="#属性必须被初始化" class="headerlink" title="属性必须被初始化"></a>属性必须被初始化</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118202949.png" alt="Image"></p><h2 id="继承父类"><a href="#继承父类" class="headerlink" title="继承父类"></a>继承父类</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">var</span> age: <span class="built_in">Int</span>, <span class="keyword">var</span> name: String) : Animal() <span class="comment">// 调用父类构造器</span></span><br></pre></td></tr></table></figure><h2 id="副构造器"><a href="#副构造器" class="headerlink" title="副构造器"></a>副构造器</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">var</span> age: <span class="built_in">Int</span>, <span class="keyword">var</span> name: String) : Animal() &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(age: <span class="built_in">Int</span>) : <span class="keyword">this</span>(age, <span class="string">&quot;unknown&quot;</span>) <span class="comment">// 副构造器，调用主构造器，确保构造路径唯一性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="不定义主构造器（不推荐）"><a href="#不定义主构造器（不推荐）" class="headerlink" title="不定义主构造器（不推荐）"></a>不定义主构造器（不推荐）</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118203435.png" alt="Image"></p><h2 id="主构造器默认参数"><a href="#主构造器默认参数" class="headerlink" title="主构造器默认参数"></a>主构造器默认参数</h2><blockquote><p>可以为主构造器定义默认参数，使用<code>@JvmOverloads</code>可以在Java代码中以重载的形式调用</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118203609.png" alt="Image"></p><h2 id="使用同名函数作为工厂函数"><a href="#使用同名函数作为工厂函数" class="headerlink" title="使用同名函数作为工厂函数"></a>使用同名函数作为工厂函数</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> persons = HashMap&lt;String, Person&gt;()</span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">Person</span><span class="params">(name: <span class="type">String</span>)</span></span>: Person &#123;</span><br><span class="line">    <span class="keyword">return</span> persons[name]</span><br><span class="line">        ?: Person(<span class="number">1</span>, name).also &#123; persons[name] = it &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h1><h2 id="类的可见性"><a href="#类的可见性" class="headerlink" title="类的可见性"></a>类的可见性</h2><table><thead><tr><th>可见性类型</th><th>Java</th><th>Kotlin</th></tr></thead><tbody><tr><td>public</td><td>公开</td><td>与Java相同，默认</td></tr><tr><td>internal</td><td>❌</td><td>模块内可见</td></tr><tr><td>default</td><td>包内可见，默认</td><td>❌</td></tr><tr><td>protected</td><td><strong>包内</strong>及子类可见</td><td><strong>类内</strong>及子类可见</td></tr><tr><td>private</td><td><strong>类内</strong>可见</td><td><strong>类或文件内</strong>可见</td></tr></tbody></table><h2 id="修饰对象"><a href="#修饰对象" class="headerlink" title="修饰对象"></a>修饰对象</h2><table><thead><tr><th>可见性类型</th><th>顶级声明</th><th>类</th><th>成员</th></tr></thead><tbody><tr><td>public</td><td>✔️</td><td>✔️</td><td>✔️</td></tr><tr><td>internal</td><td>✔️，模块</td><td>✔️，模块</td><td>✔️，模块</td></tr><tr><td>protected</td><td>❌</td><td>❌</td><td>✔️</td></tr><tr><td>private</td><td>✔️，文件</td><td>✔️，文件</td><td>✔️，类</td></tr></tbody></table><h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>直观的讲，大致可以认为是<strong>一个Jar包、一个aar</strong></p><h2 id="internal-VS-default"><a href="#internal-VS-default" class="headerlink" title="internal VS default"></a>internal VS default</h2><ul><li>一般由<code>SDK</code>或公共组件开发者用于隐藏模块内部细节实现</li><li><code>default</code>可通过外部创建相同包名来访问，访问控制非常弱</li><li><code>default</code>会导致不同抽象层次的类聚集到相同包之下</li><li><code>internal</code>可方便处理内外隔离，提升模块内聚减少接口暴露</li><li><code>internal</code>修饰的<code>kotlin</code>类或成员在<code>Java</code>当中可直接访问</li></ul><h2 id="类的可见性-1"><a href="#类的可见性-1" class="headerlink" title="类的可见性"></a>类的可见性</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">constructor</span>(<span class="keyword">var</span> age: <span class="built_in">Int</span>, <span class="keyword">var</span> name: String) <span class="comment">// 构造器私有化</span></span><br></pre></td></tr></table></figure><h2 id="属性的可见性"><a href="#属性的可见性" class="headerlink" title="属性的可见性"></a>属性的可见性</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="keyword">var</span> age: <span class="built_in">Int</span>, <span class="keyword">var</span> name: String) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> firstName: String = <span class="string">&quot;&quot;</span> <span class="comment">// 私有化属性 firstName，外部无法访问</span></span><br><span class="line">    <span class="keyword">var</span> secondName: String = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span> <span class="comment">// 私有化属性secondName的setter，外部只能读取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">get</span> <span class="comment">// 编译器报错，getter的可见性必须与属性可见性一致</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">set</span> <span class="comment">// 编译器报错，setter的可见性不得大于属性的可见性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="顶级声明的可见性"><a href="#顶级声明的可见性" class="headerlink" title="顶级声明的可见性"></a>顶级声明的可见性</h2><ul><li>顶级声明指文件内直接定义的属性、函数、类等</li><li>顶级声明不支持<code>protected</code></li><li>顶级声明被<code>private</code>修饰标识文件内部可见</li></ul><h1 id="密封类（sealed）"><a href="#密封类（sealed）" class="headerlink" title="密封类（sealed）"></a>密封类（sealed）</h1><ul><li>密封类是一种特殊的抽象类</li><li>密封类的子类定义在与自身相同的文件中</li><li>密封类的子类个数是有限的</li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118205024.png" alt="Image"></p><h2 id="密封类的子类"><a href="#密封类的子类" class="headerlink" title="密封类的子类"></a>密封类的子类</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title class_">PlayerState</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> Idle : PlayerState()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Playing</span>(<span class="keyword">val</span> song: Song) : PlayerState() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Error</span>(<span class="keyword">val</span> errorInfo: ErrorInfo) : PlayerState() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">recover</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="子类分支"><a href="#子类分支" class="headerlink" title="子类分支"></a>子类分支</h2><blockquote><p>子类可数，分支完备，所以不需要else分支</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.state = <span class="keyword">when</span> (<span class="keyword">val</span> state = <span class="keyword">this</span>.state) &#123;</span><br><span class="line">            Idle -&gt; &#123;</span><br><span class="line">                Playing(song).also(Playing::start)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">is</span> Playing -&gt; &#123;</span><br><span class="line">                state.stop()</span><br><span class="line">                Playing(song).also(Playing::start)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">is</span> Error -&gt; &#123;</span><br><span class="line">                state.recover()</span><br><span class="line">                Playing(song).also(Playing::start)</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="密封类VS枚举类"><a href="#密封类VS枚举类" class="headerlink" title="密封类VS枚举类"></a>密封类VS枚举类</h2><table><thead><tr><th></th><th>密封类</th><th>枚举类</th></tr></thead><tbody><tr><td>状态实现</td><td>子类继承</td><td>类实例化</td></tr><tr><td>状态可数</td><td>子类可数</td><td>实例可数</td></tr><tr><td>状态差异</td><td>类型差异</td><td>值差异</td></tr></tbody></table><h1 id="内联类（inline）"><a href="#内联类（inline）" class="headerlink" title="内联类（inline）"></a>内联类（inline）</h1><ul><li>内联类是对某一个类型的包装</li><li>内联类是类似于Java装箱类型的一种类型</li><li>编译器会尽可能使用被包装的类型进行优化</li><li>内联类在1.3中处于公测阶段，谨慎使用</li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211118205435.png" alt="Image"></p><p>内联类可以实现接口，但不能继承父类，也不能被继承</p><h2 id="内联类的限制"><a href="#内联类的限制" class="headerlink" title="内联类的限制"></a>内联类的限制</h2><ul><li>主构造器必须有且只有一个只读属性</li><li>不能定义有<code>backing-field</code>的其他属性</li><li>被包装类型必须不能是泛型类型</li><li>不能继承父类也不能被继承</li><li>内联类不能定义为其他类的内部类</li></ul><h2 id="内联类-VS-类型别名"><a href="#内联类-VS-类型别名" class="headerlink" title="内联类 VS 类型别名"></a>内联类 VS 类型别名</h2><table><thead><tr><th></th><th><code>typealias</code></th><th><code>inline class</code></th></tr></thead><tbody><tr><td>类型</td><td>没有新类型</td><td>有包装类型产生</td></tr><tr><td>实例</td><td>与原类型一致</td><td>必要时使用包装类型</td></tr><tr><td>场景</td><td>类型更直观</td><td>优化包装类型性能</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要介绍Kotlin类型一些不为人知的秘密</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第六章 函数进阶</title>
    <link href="https://blog.gcdd.top/p/31745/"/>
    <id>https://blog.gcdd.top/p/31745/</id>
    <published>2021-11-17T11:06:57.000Z</published>
    <updated>2023-08-30T04:52:53.892Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要对第四章描述的函数类型进行更进一步的描述，讲解Kotlin高阶函数、内联函数等细节。<span id="more"></span></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117191505.png" alt="20211117191505"></p><h1 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h1><blockquote><p><strong>参数类型</strong>包含函数类型或<strong>返回值类型</strong>为函数类型的函数为<strong>高阶函数</strong></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">needsFunction</span><span class="params">(block: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">returnsFunction</span><span class="params">()</span></span>: () -&gt; <span class="built_in">Long</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    System.currentTimeMillis()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以<code>intArray</code>扩展函数示例</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不带返回值，参数类型为函数</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> IntArray.<span class="title">forEach</span><span class="params">(action: (<span class="type">Int</span>) -&gt; <span class="type">Unit</span>)</span></span>: <span class="built_in">Unit</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (element <span class="keyword">in</span> <span class="keyword">this</span>) action(element)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回值类型为函数</span></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R&gt;</span> IntArray.<span class="title">map</span><span class="params">(transform: (<span class="type">Int</span>) -&gt; <span class="type">R</span>)</span></span>: List&lt;R&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> mapTo(ArrayList&lt;R&gt;(size), transform) <span class="comment">// 这里进一步传递transform函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="高阶函数的调用"><a href="#高阶函数的调用" class="headerlink" title="高阶函数的调用"></a>高阶函数的调用</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">intArray.forEach&#123;</span><br><span class="line">  println(<span class="string">&quot;Hello <span class="variable">$it</span>&quot;</span>) <span class="comment">// 只有一个Lambda表达式作为参数，可省略小括号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="内联函数（减少函数调用开销）"><a href="#内联函数（减少函数调用开销）" class="headerlink" title="内联函数（减少函数调用开销）"></a>内联函数（减少函数调用开销）</h1><blockquote><p>上面的<code>IntArray</code>的示例，使用了<code>inline</code>关键字，这是内联函数的定义，内联函数会在编译器将函数定义<strong>搬运到</strong>调用处，而不是调用此函数</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117191853.png" alt="20211117191853"></p><h1 id="高阶函数内联"><a href="#高阶函数内联" class="headerlink" title="高阶函数内联"></a>高阶函数内联</h1><blockquote><p>高阶函数与内联更配</p></blockquote><ul><li>函数本身被内联到调用处</li><li>函数的函数参数被内联到调用处</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> start = System.currentTimeMillis()</span><br><span class="line">println(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">println(System.currentTimeMillis() - start)</span><br></pre></td></tr></table></figure><h2 id="内联高阶函数的返回值（return-高阶函数名称）"><a href="#内联高阶函数的返回值（return-高阶函数名称）" class="headerlink" title="内联高阶函数的返回值（return@高阶函数名称）"></a>内联高阶函数的返回值（return@高阶函数名称）</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> ints = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">ints.forEach&#123;</span><br><span class="line">  <span class="keyword">if</span>(it == <span class="number">3</span>) <span class="keyword">return</span><span class="symbol">@forEach</span></span><br><span class="line">  println(<span class="string">&quot;Hello <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码执行逻辑等同于</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> ints = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span>(element <span class="keyword">in</span> ints) &#123;</span><br><span class="line">  <span class="keyword">if</span>(it == <span class="number">3</span>) <span class="keyword">continue</span></span><br><span class="line">  println(<span class="string">&quot;Hello <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="non-local-return"><a href="#non-local-return" class="headerlink" title="non-local return"></a><code>non-local return</code></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">nonLocalReturn</span><span class="params">(block: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">  block()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  nonLocalReturn &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// 从main函数返回</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在高阶函数内部，直接跳出到main函数，显然是不对的，例如</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Runnable</span><span class="params">(block: () -&gt; <span class="type">Unit</span>)</span></span>: Runnable &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">object</span>: Runnable &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">      block() <span class="comment">// 有可能存在不合法的`non-local return`，因为block的调用处与定义处不在同一个调用上下文</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="crossinline：禁止non-local-return"><a href="#crossinline：禁止non-local-return" class="headerlink" title="crossinline：禁止non-local return"></a>crossinline：禁止<code>non-local return</code></h3><p>可以使用<code>crossinline</code>禁止<code>non-local return</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Runnable</span><span class="params">(<span class="keyword">crossinline</span> <span class="comment">/*禁止non-local return*/</span> block: () -&gt; <span class="type">Unit</span>)</span></span>: Runnable &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">object</span>: Runnable &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">      block()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="noinline：禁止函数参数被内联"><a href="#noinline：禁止函数参数被内联" class="headerlink" title="noinline：禁止函数参数被内联"></a>noinline：禁止函数参数被内联</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">Runnable</span><span class="params">(<span class="keyword">noinline</span> <span class="comment">/*禁止函数参数被内联*/</span> block: () -&gt; <span class="type">Unit</span>)</span></span>: Runnable &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">object</span>: Runnable &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">      block()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="内联属性"><a href="#内联属性" class="headerlink" title="内联属性"></a>内联属性</h1><blockquote><p>没有backing-field的属性的getter/setter可以被内联</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pocket: <span class="built_in">Double</span> = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">var</span> money: <span class="built_in">Double</span></span><br><span class="line">  <span class="keyword">inline</span> <span class="keyword">get</span>() = pocket</span><br><span class="line">  <span class="keyword">inline</span> <span class="keyword">set</span>(value) &#123;</span><br><span class="line">    pocket = value</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h1 id="内联函数的限制"><a href="#内联函数的限制" class="headerlink" title="内联函数的限制"></a>内联函数的限制</h1><ul><li><code>public/protected</code>的内联方法只能访问对应类的<code>public</code>成员</li><li>内联函数的<strong>内联函数参数</strong>不能被存储（赋值给变量）</li><li>内联函数的<strong>内联函数参数</strong>只能传递给其他内联函数参数</li></ul><h1 id="几个有用的高阶函数"><a href="#几个有用的高阶函数" class="headerlink" title="几个有用的高阶函数"></a>几个有用的高阶函数</h1><table><thead><tr><th>函数名</th><th>介绍</th><th>推荐指数</th></tr></thead><tbody><tr><td>let</td><td>val r = X.let { x -&gt; R }</td><td>⭐⭐⭐</td></tr><tr><td>run</td><td>val r = X.run { this: X -&gt; R }</td><td>⭐</td></tr><tr><td>also</td><td>val x = X.also { x -&gt; Unit }</td><td>⭐⭐⭐</td></tr><tr><td>apply</td><td>val r = X.apply { this: X -&gt; Unit }</td><td>⭐</td></tr><tr><td>use</td><td>val r = Closeable.use{ c -&gt; R }</td><td>⭐⭐⭐</td></tr></tbody></table><p>这里的推荐指数，是教程作者根据<strong>是否绑定receiver</strong>做判断的，实际上这几个函数是有各自的意义的，参考下图，明确每个函数的使用场景</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/httpss3-us-west-2.amazonaws.comsecure.notion-static.com70b52c1a-f3c9-48eb-b359-22dc519eae96Untitled.png" alt="httpss3-us-west-2.amazonaws.comsecure.notion-static.com70b52c1a-f3c9-48eb-b359-22dc519eae96Untitled"></p><h1 id="集合变换与序列"><a href="#集合变换与序列" class="headerlink" title="集合变换与序列"></a>集合变换与序列</h1><h2 id="filter-变换"><a href="#filter-变换" class="headerlink" title="filter 变换"></a>filter 变换</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.stream().filter(e -&gt; e % <span class="number">2</span> == <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.filter&#123; it % <span class="number">2</span> == <span class="number">0</span> &#125;</span><br></pre></td></tr></table></figure><p>转换为懒序列，即只有执行到该元素时，才会执行<code>filter&#123; xxx &#125;</code>的xxx函数<br>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.stream().filter(e -&gt; e % <span class="number">2</span> == <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list.asSequence() <span class="comment">// 转换为懒序列</span></span><br><span class="line">  .filter&#123; it % <span class="number">2</span> == <span class="number">0</span> &#125;</span><br></pre></td></tr></table></figure><h2 id="map变换"><a href="#map变换" class="headerlink" title="map变换"></a>map变换</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.stream().map(e -&gt; e * <span class="number">2</span> + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.map&#123; it * <span class="number">2</span> + <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure><h2 id="flatMap变换"><a href="#flatMap变换" class="headerlink" title="flatMap变换"></a>flatMap变换</h2><blockquote><p>实际上是map与flatten（展平）结合起来</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117194404.png" alt="20211117194404"></p><h1 id="集合的聚合操作"><a href="#集合的聚合操作" class="headerlink" title="集合的聚合操作"></a>集合的聚合操作</h1><table><thead><tr><th>函数名</th><th>说明</th></tr></thead><tbody><tr><td>sum</td><td>所有元素求和</td></tr><tr><td>reduce</td><td>将元素一次按规则聚合，结果与元素类型一致</td></tr><tr><td>fold</td><td>给定初始化值，将元素按规则聚合，结果与初始化值类型一致</td></tr></tbody></table><h1 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h1><blockquote><p>仅具有一种抽象方法的接口被称为功能接口，并且也被称为单一抽象方法接口（SAM接口）。一个抽象方法意味着允许使用默认方法或默认实现的抽象方法。</p></blockquote><h2 id="Java的SAM转换"><a href="#Java的SAM转换" class="headerlink" title="Java的SAM转换"></a>Java的SAM转换</h2><blockquote><p>一个参数类型为<strong>只有一个方法的接口</strong>的方法调用时可用Lambda表达式做转换作为参数</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">() -&gt; System.out.println(<span class="string">&quot;run in executor.&quot;</span>)</span><br><span class="line"><span class="comment">// SAM转换</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;run in executor.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Kotlin的SAM转换"><a href="#Kotlin的SAM转换" class="headerlink" title="Kotlin的SAM转换"></a>Kotlin的SAM转换</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">executor.submit &#123; println(<span class="string">&quot;run in executor.&quot;</span>) &#125;</span><br><span class="line"><span class="comment">// SAM转换</span></span><br><span class="line">executor.submit(<span class="keyword">object</span>: Runnable &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;run in executor.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="DSL领域特定语言"><a href="#DSL领域特定语言" class="headerlink" title="DSL领域特定语言"></a>DSL领域特定语言</h1><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117195109.png" alt="20211117195109"></p><p>建议查看示例：<a href="https://github.com/gcdd1993/kotlin-tutorials/blob/master/AdvancedFunctions/src/main/java/com/bennyhuo/kotlin/advancedfunctions/eg/Htmls.kt">AdvancedFunctions-Htmls.kt</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要对第四章描述的函数类型进行更进一步的描述，讲解Kotlin高阶函数、内联函数等细节。</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第五章 表达式</title>
    <link href="https://blog.gcdd.top/p/49764/"/>
    <id>https://blog.gcdd.top/p/49764/</id>
    <published>2021-11-17T07:21:55.000Z</published>
    <updated>2023-08-30T04:52:53.892Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要介绍Kotlin自带的一些表达式和简单使用<span id="more"></span><br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117161347.png" alt="20211117161347"></p><h1 id="常量和变量"><a href="#常量和变量" class="headerlink" title="常量和变量"></a>常量和变量</h1><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">a = <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span></span><br><span class="line">a = <span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="只读变量"><a href="#只读变量" class="headerlink" title="只读变量"></a>只读变量</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> b = <span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>Kotlin</p><ul><li>只能定义在全局范围</li><li>只能修饰基本类型</li><li>必须立即用字面量初始化<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> b = <span class="number">3</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="编译期和运行时常量"><a href="#编译期和运行时常量" class="headerlink" title="编译期和运行时常量"></a>编译期和运行时常量</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> b = <span class="number">3</span> <span class="comment">// 编译期即可确定常量的值，并用值替换调用处</span></span><br><span class="line"><span class="keyword">val</span> c: <span class="built_in">Int</span></span><br><span class="line">运行时才能确定值，调用处通过引用获取值</span><br></pre></td></tr></table></figure><h1 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h1><h2 id="if-…-else"><a href="#if-…-else" class="headerlink" title="if … else"></a>if … else</h2><p>Java</p><blockquote><p>Java支持三目运算符，所以可以使用以下语法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = a == <span class="number">3</span> ? <span class="number">4</span> : <span class="number">5</span>;</span><br></pre></td></tr></table></figure><p>Kotlin</p><blockquote><p>Kotlin中，<code>if ... else ...</code>也属于表达式，所以Kotlin开发者没有提供三目运算符，直接使用<code>if ... else ...</code>可以达到相同的效果</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = <span class="keyword">if</span>(a == <span class="number">3</span>) <span class="number">4</span> <span class="keyword">else</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><h2 id="when-…"><a href="#when-…" class="headerlink" title="when …"></a>when …</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(a) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>: c = <span class="number">5</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>: c = <span class="number">100</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>: c = <span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span>(a) &#123;</span><br><span class="line">  <span class="number">0</span> -&gt; c = <span class="number">5</span></span><br><span class="line">  <span class="number">1</span> -&gt; c = <span class="number">100</span></span><br><span class="line">  <span class="keyword">else</span> -&gt; c = <span class="number">20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Java里，<code>switch</code>表达式只支持<code>byte、short、int、char、String或者枚举</code>，但是Kotlin中，相当于Scala的模式匹配，支持的语句相当丰富，比如下面的也是可以的</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span>(person) &#123;</span><br><span class="line">  <span class="keyword">is</span> Male -&gt; println(<span class="string">&quot;<span class="subst">$&#123;person.name&#125;</span> 是男人&quot;</span>)</span><br><span class="line">  <span class="keyword">is</span> FeMale -&gt; println(<span class="string">&quot;<span class="subst">$&#123;person.name&#125;</span> 是女人&quot;</span>)</span><br><span class="line">  <span class="keyword">else</span> -&gt; println(<span class="string">&quot;<span class="subst">$&#123;person.name&#125;</span> emm...&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>条件可以转移到分支</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x: Any = ...</span><br><span class="line"><span class="keyword">when</span> &#123;</span><br><span class="line">  x <span class="keyword">is</span> String -&gt; c = x.length</span><br><span class="line">  x == <span class="number">1</span> -&gt; c = <span class="number">100</span></span><br><span class="line">  <span class="keyword">else</span> -&gt; c = <span class="number">20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于Kotlin里面，when是一个表达式，所以允许有值返回，上述也可以写成下面这样</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c = <span class="keyword">when</span> &#123;</span><br><span class="line">  x <span class="keyword">is</span> String -&gt; x.length</span><br><span class="line">  x == <span class="number">1</span> -&gt; <span class="number">100</span></span><br><span class="line">  <span class="keyword">else</span> -&gt; <span class="number">20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="try-…-catch-…"><a href="#try-…-catch-…" class="headerlink" title="try … catch …"></a>try … catch …</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  c = a / b;</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">  c = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c = <span class="keyword">try</span> &#123;</span><br><span class="line">  a / b</span><br><span class="line">&#125; <span class="keyword">catch</span>(e: Exception) &#123;</span><br><span class="line">  e.printStackTrace()</span><br><span class="line">  <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="运算符与中缀表达式"><a href="#运算符与中缀表达式" class="headerlink" title="运算符与中缀表达式"></a>运算符与中缀表达式</h1><h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><ul><li>Kotlin支持运算符重载</li><li>运算符的范围仅限官方指定的符号<h3 id="一元操作"><a href="#一元操作" class="headerlink" title="一元操作"></a>一元操作</h3><h4 id="一元前缀操作符"><a href="#一元前缀操作符" class="headerlink" title="一元前缀操作符"></a>一元前缀操作符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>+a</td><td>a.unaryPlus()</td></tr><tr><td>-a</td><td>a.unaryMinus()</td></tr><tr><td>!a</td><td>a.not()</td></tr></tbody></table></li></ul><p>当编译器处理例如表达式 +a 时，它执行以下步骤：</p><ol><li>确定<code>a</code>的类型，令其为<code>T</code>；</li><li>为接收者<code>T</code>查找一个带有<code>operator</code>修饰符的无参函数<code>unaryPlus()</code>，即成员函数或扩展函数；</li><li>如果函数不存在或不明确，则导致编译错误；</li><li>如果函数存在且其返回类型为<code>R</code>，那就表达式<code>+a</code>具有类型<code>R</code>；</li></ol><blockquote><p>注意：这些操作以及所有其他操作都针对基本类型做了优化，不会为它们引入函数调用的开销。</p></blockquote><p>以下是如何重载一元减运算符的示例</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Point</span>(<span class="keyword">val</span> x: <span class="built_in">Int</span>, <span class="keyword">val</span> y: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> Point.<span class="title">unaryMinus</span><span class="params">()</span></span> = Point(-x, -y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> point = Point(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   println(-point)  <span class="comment">// 输出“Point(x=-10, y=-20)”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="递增与递减"><a href="#递增与递减" class="headerlink" title="递增与递减"></a>递增与递减</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a++</td><td>a.inc()</td></tr><tr><td>a–</td><td>a.dec()</td></tr></tbody></table><h3 id="二元操作"><a href="#二元操作" class="headerlink" title="二元操作"></a>二元操作</h3><h4 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a + b</td><td>a.plus(b)</td></tr><tr><td>a - b</td><td>a.minus(b)</td></tr><tr><td>a * b</td><td>a.times(b)</td></tr><tr><td>a / b</td><td>a.div(b)</td></tr><tr><td>a % b</td><td>a.rem(b) 或者 a.mod(b) 已弃用</td></tr><tr><td>a..b</td><td>a.rangeTo(b)</td></tr></tbody></table><p>下面是一个从给定值起始的<code>Counter</code>类的示例，它可以使用重载的<code>+</code>运算符来增加计数</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">Counter</span>(<span class="keyword">val</span> dayIndex: <span class="built_in">Int</span>) &#123;</span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">plus</span><span class="params">(increment: <span class="type">Int</span>)</span></span>: Counter &#123;</span><br><span class="line">        <span class="keyword">return</span> Counter(dayIndex + increment)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="In操作符"><a href="#In操作符" class="headerlink" title="In操作符"></a><code>In</code>操作符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a in b</td><td>b.contains(a)</td></tr><tr><td>a !in b</td><td>!b.contains(a)</td></tr></tbody></table><h4 id="索引访问操作符"><a href="#索引访问操作符" class="headerlink" title="索引访问操作符"></a>索引访问操作符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a[i]</td><td>a.get(i)</td></tr><tr><td>a[i, j]</td><td>a.get(i, j)</td></tr><tr><td>a[i_1, ……, i_n]</td><td>a.get(i_1, ……, i_n)</td></tr><tr><td>a[i] = b</td><td>a.set(i, b)</td></tr><tr><td>a[i, j] = b</td><td>a.set(i, j, b)</td></tr><tr><td>a[i_1, ……, i_n] = b</td><td>a.set(i_1, ……, i_n, b)</td></tr></tbody></table><h4 id="调用操作符"><a href="#调用操作符" class="headerlink" title="调用操作符"></a>调用操作符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a()</td><td>a.invoke()</td></tr><tr><td>a(i)</td><td>a.invoke(i)</td></tr><tr><td>a(i, j)</td><td>a.invoke(i, j)</td></tr><tr><td>a(i_1, ……, i_n)</td><td>a.invoke(i_1, ……, i_n)</td></tr></tbody></table><h4 id="广义赋值"><a href="#广义赋值" class="headerlink" title="广义赋值"></a>广义赋值</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a += b</td><td>a.plusAssign(b)</td></tr><tr><td>a -= b</td><td>a.minusAssign(b)</td></tr><tr><td>a *= b</td><td>a.timesAssign(b)</td></tr><tr><td>a /= b</td><td>a.divAssign(b)</td></tr><tr><td>a %= b</td><td>a.remAssign(b), a.modAssign(b)（已弃用）</td></tr></tbody></table><h4 id="相等与不等操作符"><a href="#相等与不等操作符" class="headerlink" title="相等与不等操作符"></a>相等与不等操作符</h4><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a == b</td><td>a?.equals(b) ?: (b === null)</td></tr><tr><td>a != b</td><td>!(a?.equals(b) ?: (b === null))</td></tr></tbody></table><h4 id="比较操作符"><a href="#比较操作符" class="headerlink" title="比较操作符"></a>比较操作符</h4><blockquote><p>所有的比较都转换为对<code>compareTo</code>的调用，这个函数需要返回<code>Int</code>值</p></blockquote><table><thead><tr><th>表达式</th><th>翻译为</th></tr></thead><tbody><tr><td>a &gt; b</td><td>a.compareTo(b) &gt; 0</td></tr><tr><td>a &lt; b</td><td>a.compareTo(b) &lt; 0</td></tr><tr><td>a &gt;= b</td><td>a.compareTo(b) &gt;= 0</td></tr><tr><td>a &lt;= b</td><td>a.compareTo(b) &lt;= 0</td></tr></tbody></table><h4 id="属性委托操作符"><a href="#属性委托操作符" class="headerlink" title="属性委托操作符"></a>属性委托操作符</h4><h2 id="中缀表达式（infix）"><a href="#中缀表达式（infix）" class="headerlink" title="中缀表达式（infix）"></a>中缀表达式（infix）</h2><p>前面章节提到过，初始化<code>Map</code>时，可以使用<code>mapOf(1 to 2)</code>，这里的<code>x to y</code>就是中缀表达式，这个函数表现为</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">infix</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;A, B&gt;</span> A.<span class="title">to</span><span class="params">(that: <span class="type">B</span>)</span></span>: Pair&lt;A, B&gt; = Pair(<span class="keyword">this</span>, thar) <span class="comment">// 加infix关键字</span></span><br></pre></td></tr></table></figure><h2 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h2><blockquote><p>匿名函数的类型，类型与普通函数一致</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> func: () -&gt; <span class="built_in">Unit</span> = <span class="function"><span class="title">fun</span><span class="params">()</span></span> &#123;</span><br><span class="line">  println(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Lambda表达式的定义"><a href="#Lambda表达式的定义" class="headerlink" title="Lambda表达式的定义"></a>Lambda表达式的定义</h3><p>无参数无返回值<br>Java(since 1.8)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runnable</span> <span class="variable">lambda</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">  System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> lambda = &#123;</span><br><span class="line">  println(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有参数无返回值<br>Java(since 1.8)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Function1</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(<span class="type">int</span> p)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Function1</span> <span class="variable">f1</span> <span class="operator">=</span> (p) -&gt; &#123;</span><br><span class="line">  System.out.println(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> f1: (<span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span> = &#123; p: <span class="built_in">Int</span> -&gt; println(p) &#125;</span><br></pre></td></tr></table></figure><p>还可以简写为</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> f1: (<span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span> = &#123; println(it) &#125; <span class="comment">// 默认的匿名函数参数名称为`it`</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要介绍Kotlin自带的一些表达式和简单使用</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第四章 类型初步</title>
    <link href="https://blog.gcdd.top/p/58149/"/>
    <id>https://blog.gcdd.top/p/58149/</id>
    <published>2021-11-17T02:34:12.000Z</published>
    <updated>2023-08-30T04:52:53.892Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要介绍Kotlin的类型定义和简单使用<span id="more"></span><br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117161519.png" alt="20211117161519"></p><h1 id="类的定义"><a href="#类的定义" class="headerlink" title="类的定义"></a>类的定义</h1><h2 id="Kotlin类默认为public，类内无内容可省略"><a href="#Kotlin类默认为public，类内无内容可省略" class="headerlink" title="Kotlin类默认为public，类内无内容可省略"></a>Kotlin类默认为public，类内无内容可省略</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117104518.png" alt="20211117104518"></p><h2 id="Kotlin类成员变量，方法同Java类似"><a href="#Kotlin类成员变量，方法同Java类似" class="headerlink" title="Kotlin类成员变量，方法同Java类似"></a>Kotlin类成员变量，方法同Java类似</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117104610.png" alt="20211117104610"></p><h2 id="Kotlin类默认带无参构造器，如果需要定义其他构造器，使用constructor关键字创建"><a href="#Kotlin类默认带无参构造器，如果需要定义其他构造器，使用constructor关键字创建" class="headerlink" title="Kotlin类默认带无参构造器，如果需要定义其他构造器，使用constructor关键字创建"></a>Kotlin类默认带无参构造器，如果需要定义其他构造器，使用<code>constructor</code>关键字创建</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117104737.png" alt="20211117104737"></p><p>也可以直接定义到类上<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117104843.png" alt="20211117104843"></p><h1 id="类的实例化"><a href="#类的实例化" class="headerlink" title="类的实例化"></a>类的实例化</h1><blockquote><p>直观感受是，省略了<code>new</code>关键字，获得对象再也不需要<code>new</code>了</p></blockquote><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SimpleClass</span> <span class="variable">simpleClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClass</span>(<span class="number">9</span>);</span><br><span class="line">System.out.println(simpleClass.x);</span><br><span class="line">simpleClass.y();</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> simpleClass = SimpleClass(<span class="number">9</span>)</span><br><span class="line">println(simpleClass.x)</span><br><span class="line">simpleClass.y()</span><br></pre></td></tr></table></figure><h1 id="接口的定义"><a href="#接口的定义" class="headerlink" title="接口的定义"></a>接口的定义</h1><blockquote><p>基本和Java一致</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117105205.png" alt="20211117105205"></p><h1 id="接口的实现"><a href="#接口的实现" class="headerlink" title="接口的实现"></a>接口的实现</h1><ul><li><code>implements</code>关键字换成了<code>:</code></li><li><code>@override</code>注解换成了<code>override</code>关键字</li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117105309.png" alt="20211117105309"></p><h1 id="抽象类的定义"><a href="#抽象类的定义" class="headerlink" title="抽象类的定义"></a>抽象类的定义</h1><blockquote><p>由于Kotlin的类默认是final，所以需要添加open关键字，使之可以被继承</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117105425.png" alt="20211117105425"></p><h1 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h1><ul><li><code>extends</code>关键字换成了<code>:</code>，跟接口实现保持了一致</li><li>需要调用被继承方的构造器（默认为无参构造器）</li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117105546.png" alt="20211117105546"></p><h1 id="类的属性（成员变量）"><a href="#类的属性（成员变量）" class="headerlink" title="类的属性（成员变量）"></a>类的属性（成员变量）</h1><ul><li>var：默认带<code>getter</code>和<code>setter</code></li><li>val：默认带<code>getter</code></li></ul><p>也可以自己定义<code>getter</code>和<code>setter</code>方法</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(age: <span class="built_in">Int</span>, name: String) &#123;</span><br><span class="line">  <span class="keyword">var</span> age: <span class="built_in">Int</span> = age</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> field</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span>(value) &#123;</span><br><span class="line">      field = value</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">var</span> name: String = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="属性引用"><a href="#属性引用" class="headerlink" title="属性引用"></a>属性引用</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> ageRef = Person::age <span class="comment">// 未绑定 Receiver</span></span><br><span class="line">    <span class="keyword">val</span> person = Person(<span class="number">18</span>, <span class="string">&quot;Bennyhuo&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> nameRef = person::name <span class="comment">// 绑定 Receiver</span></span><br><span class="line">    <span class="comment">// 属性引用</span></span><br><span class="line">    ageRef.<span class="keyword">set</span>(person, <span class="number">20</span>)</span><br><span class="line">    nameRef.<span class="keyword">set</span>(<span class="string">&quot;Andyhuo&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="接口属性"><a href="#接口属性" class="headerlink" title="接口属性"></a>接口属性</h1><blockquote><p>接口可以定义属性，但是不能赋值</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Guy</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> moneyLeft: <span class="built_in">Double</span></span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">noMoney</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;no money called.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接口属性没有backing-field"><a href="#接口属性没有backing-field" class="headerlink" title="接口属性没有backing field"></a>接口属性没有<code>backing field</code></h2><p>我们尝试跟上面的类一样定义<code>getter</code>和<code>setter</code>方法</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Guy</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> moneyLeft: <span class="built_in">Double</span></span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> field</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">noMoney</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;no money called.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将会获得编译器提示”Property in an interface cannot have a backing field”<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117111756.png" alt="20211117111756"></p><h1 id="扩展方法"><a href="#扩展方法" class="headerlink" title="扩展方法"></a>扩展方法</h1><blockquote><p>这是Kotlin的大杀器，非常好用，一些工具类完全可以用扩展方法来替代，并且使用起来非常方便</p></blockquote><p>可以为现存的类定义新的方法</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">minus</span><span class="params">(right: <span class="type">Any</span>?)</span></span> = <span class="keyword">this</span>.replaceFirst(right.toString(), <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">times</span><span class="params">(right: <span class="type">Int</span>)</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1.</span>.right).joinToString(<span class="string">&quot;&quot;</span>) &#123; <span class="keyword">this</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> String.<span class="title">div</span><span class="params">(right: <span class="type">Any</span>?)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> right = right.toString()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.windowed(right.length, <span class="number">1</span>, transform = &#123;</span><br><span class="line">        it == right</span><br><span class="line">    &#125;) <span class="comment">// [false, false, false, false ... false, true, ..., true]</span></span><br><span class="line">        .count &#123; it &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> value = <span class="string">&quot;HelloWorld World&quot;</span></span><br><span class="line"></span><br><span class="line">    println(value - <span class="string">&quot;World&quot;</span>)</span><br><span class="line">    println(value * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> star = <span class="string">&quot;*&quot;</span></span><br><span class="line">    println(<span class="string">&quot;*&quot;</span> * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    println(value / <span class="number">3</span>)</span><br><span class="line">    println(value / <span class="string">&quot;l&quot;</span>)</span><br><span class="line">    println(value / <span class="string">&quot;ld&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="空指针安全特性"><a href="#空指针安全特性" class="headerlink" title="空指针安全特性"></a>空指针安全特性</h1><h2 id="空类型安全"><a href="#空类型安全" class="headerlink" title="空类型安全"></a>空类型安全</h2><blockquote><p>注意：String和String?不是一个类型</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nonNull: String = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">nonNull = <span class="literal">null</span> <span class="comment">// 编译器报错</span></span><br><span class="line"><span class="keyword">var</span> nullable: String? = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">nonNull = <span class="literal">null</span> <span class="comment">// 编译通过</span></span><br></pre></td></tr></table></figure><h2 id="强转为不可空类型"><a href="#强转为不可空类型" class="headerlink" title="强转为不可空类型"></a>强转为不可空类型</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nullable: String? = <span class="string">&quot;Hello&quot;</span></span><br><span class="line"><span class="keyword">val</span> length = nullable!!.length</span><br></pre></td></tr></table></figure><h2 id="安全访问"><a href="#安全访问" class="headerlink" title="安全访问"></a>安全访问</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nullable: String? = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">nullable = <span class="literal">null</span></span><br><span class="line"><span class="keyword">val</span> length = nullable?.length</span><br></pre></td></tr></table></figure><p><code>?.</code>的语法结构，我最早是在TypeScript里面看到的，基本逻辑就是，如果为空，则不会继续往下执行，一定程度上杜绝了NPE异常，而现在Kotlin把它引入了，非常棒</p><h2 id="elvis运算符"><a href="#elvis运算符" class="headerlink" title="elvis运算符(?:)"></a>elvis运算符(?:)</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nullable: String? = <span class="string">&quot;Hello&quot;</span></span><br><span class="line">nullable = <span class="literal">null</span></span><br><span class="line"><span class="keyword">val</span> length: <span class="built_in">Int</span> = nullable?.length ?: <span class="number">0</span></span><br></pre></td></tr></table></figure><ul><li><code>nullable == null</code> 时，length = 0</li><li><code>nullable != null</code> 时，length = nullable!!.length</li></ul><h1 id="平台类型"><a href="#平台类型" class="headerlink" title="平台类型"></a>平台类型</h1><p>Kotlin对于Java类库，是百分百支持的，但是Java里面没有<code>String?</code>这种类型，Kotlin怎么处理呢？是当成非空还是可空类型？<br>答案是：Kotlin编译器不判断，有用户自己来判断是否可空还是非空<br>比如在Java里面定义了一个<code>Person</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么在Kotlin里面调用时，<code>person.title</code>的类型是<code>String!</code>，这个<code>String!</code>就是平台类型，可以非空也可以可空</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> person = Person()</span><br><span class="line"><span class="keyword">val</span> title: String! = person.title</span><br></pre></td></tr></table></figure><h1 id="智能类型转换"><a href="#智能类型转换" class="headerlink" title="智能类型转换"></a>智能类型转换</h1><h2 id="自动转换为子类型"><a href="#自动转换为子类型" class="headerlink" title="自动转换为子类型"></a>自动转换为子类型</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> kotliner: Kotliner = Person(<span class="string">&quot;benny&quot;</span>, <span class="number">20</span>) <span class="comment">// Person是Kotliner的子类</span></span><br><span class="line"><span class="keyword">if</span>(kotliner <span class="keyword">is</span> Person) &#123;</span><br><span class="line">  println(kotliner.name) <span class="comment">// 自动转换类型为 Person，不用向Java一样进行强转</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="可空转非空"><a href="#可空转非空" class="headerlink" title="可空转非空"></a>可空转非空</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> value: String? = <span class="literal">null</span></span><br><span class="line">value = <span class="string">&quot;benny&quot;</span></span><br><span class="line"><span class="keyword">if</span>(value != <span class="literal">null</span>) &#123;</span><br><span class="line">  println(value.length) <span class="comment">// 可空转非空，所以我们也可以说，非空类型是对应的可空类型的子类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="不支持智能类型转换的场景"><a href="#不支持智能类型转换的场景" class="headerlink" title="不支持智能类型转换的场景"></a>不支持智能类型转换的场景</h2><blockquote><p>在线程不安全的调用下，智能类型转换失效</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tag: String? = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(tag != <span class="literal">null</span>) &#123;</span><br><span class="line">    println(tag.length) <span class="comment">// 虽然判断不为空，但是其他线程可能对它进行修改</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="类型的安全转换-as"><a href="#类型的安全转换-as" class="headerlink" title="类型的安全转换(as?)"></a>类型的安全转换(as?)</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> kotliner: Kotliner = ...</span><br><span class="line">println(kotliner <span class="keyword">as</span>? Person).name) <span class="comment">// 安全转换，失败返回null</span></span><br></pre></td></tr></table></figure><p>针对类型的智能转换，有几个建议</p><ul><li>尽可能使用val来声明不可变引用，让程序的含义更加清晰确定</li><li>尽可能减少函数对外部变量的访问，也为函数式编程提供基础（函数式编程的精髓就是拒绝副作用）</li><li>必要时创建局部变量指向外部变量，避免因它变化引起程序错误</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要介绍Kotlin的类型定义和简单使用</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第三章 Kotlin内置类型</title>
    <link href="https://blog.gcdd.top/p/16155/"/>
    <id>https://blog.gcdd.top/p/16155/</id>
    <published>2021-11-15T08:46:58.000Z</published>
    <updated>2023-08-30T04:52:53.891Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要介绍Kotlin的内置类型和简单用法<span id="more"></span><br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117161500.png" alt="20211117161500"></p><h1 id="变量的声明"><a href="#变量的声明" class="headerlink" title="变量的声明"></a>变量的声明</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> b: String = <span class="string">&quot;Hello Kotlin&quot;</span></span><br></pre></td></tr></table></figure><p>Kotlin的变量声明方式，有点类似于<code>TypeScript</code>，是比较现代的一种做法，一般形式为<code>修饰符 变量名: 类型 = 值</code>，其中，类型声明可以省略。</p><p>修饰符有两种</p><ul><li>val：只读变量</li><li>var：可读写变量，定义时必须指定值，且不可更改</li></ul><h2 id="与Java对比"><a href="#与Java对比" class="headerlink" title="与Java对比"></a>与Java对比</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">b</span> <span class="operator">=</span> <span class="string">&quot;Hello Java&quot;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span></span><br><span class="line"><span class="keyword">val</span> b = <span class="string">&quot;Hello Kotlin&quot;</span></span><br></pre></td></tr></table></figure><h1 id="易混淆的Long类型标记"><a href="#易混淆的Long类型标记" class="headerlink" title="易混淆的Long类型标记"></a>易混淆的Long类型标记</h1><p>在Java里，<code>Long</code>类型结束使用<code>l</code>是可以编译通过，只是不推荐（小写的<code>l</code>，看起来就跟数字1一样）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">1234567890l</span>; <span class="comment">// ok but not good.</span></span><br><span class="line"><span class="type">long</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">1234567890L</span>; <span class="comment">// ok</span></span><br></pre></td></tr></table></figure><p>在Kotlin里面，直接就编译不通过，强制要求修改为<code>L</code></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> c = <span class="number">1234567890l</span> <span class="comment">// compile error.</span></span><br><span class="line"><span class="keyword">val</span> d = <span class="number">1234567890L</span> <span class="comment">// ok</span></span><br></pre></td></tr></table></figure><h1 id="Kotlin数值类型转换"><a href="#Kotlin数值类型转换" class="headerlink" title="Kotlin数值类型转换"></a>Kotlin数值类型转换</h1><p>在Java里，<code>int</code>类型可以隐式转换为<code>long</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">f</span> <span class="operator">=</span> e; <span class="comment">// implicit conversion</span></span><br></pre></td></tr></table></figure><p>而到了Kotlin这，对不起，不支持</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> e: <span class="built_in">Int</span> = <span class="number">10</span></span><br><span class="line"><span class="keyword">val</span> f: <span class="built_in">Long</span> = e <span class="comment">// implicitness not allowed</span></span><br><span class="line"><span class="keyword">val</span> f: <span class="built_in">Long</span> = e.toLong() <span class="comment">// ok</span></span><br></pre></td></tr></table></figure><h1 id="无符号类型（兼容C-Native）"><a href="#无符号类型（兼容C-Native）" class="headerlink" title="无符号类型（兼容C Native）"></a>无符号类型（兼容C Native）</h1><p>从v1.3开始，Kotlin支持无符号类型<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115170915.png" alt="20211115170915"></p><h1 id="字符串定义"><a href="#字符串定义" class="headerlink" title="字符串定义"></a>字符串定义</h1><p>先看下Kotlin定义HTML字符串的代码</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> n = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;UTF-8&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Hello World&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div id=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;H1&gt;Hello World&lt;/H1&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;This is a demo page.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line"></span><br><span class="line">println(n)</span><br></pre></td></tr></table></figure><p>对比Java，简直太简洁了，使用Java定义的一段同样行为的代码，一堆换行符，看了都头大<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115171226.png" alt="20211115171226"></p><h1 id="Kotlin字符串"><a href="#Kotlin字符串" class="headerlink" title="Kotlin字符串"></a>Kotlin字符串</h1><h2 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h2><ul><li><code>a == b</code>：比较内容，等价于Java的<code>equals</code></li><li><code>a === b</code>：比较对象是否是同一个对象</li></ul><h2 id="字符串模板"><a href="#字符串模板" class="headerlink" title="字符串模板"></a>字符串模板</h2><ul><li>“hello, $name” =&gt; “Hello, 小明”</li></ul><h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><table><thead><tr><th></th><th>Kotlin</th><th>Java</th></tr></thead><tbody><tr><td>整型</td><td>IntArray</td><td>int[]</td></tr><tr><td>整型装箱</td><td>Array<Int></td><td>Integer[]</td></tr><tr><td>字符</td><td>CharArray</td><td>char[]</td></tr><tr><td>字符装箱</td><td>Array<Char></td><td>Character[]</td></tr><tr><td>字符串</td><td>Array<String></td><td>String[]</td></tr></tbody></table><h2 id="数组的创建"><a href="#数组的创建" class="headerlink" title="数组的创建"></a>数组的创建</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] c = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br></pre></td></tr></table></figure><p>在Kotlin里面，数组使用以下方式创建</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> c0 = intArrayOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">val</span> c1 = IntArray(<span class="number">5</span>)&#123; it + <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115173106.png" alt="20211115173106"></p><h2 id="数组的长度"><a href="#数组的长度" class="headerlink" title="数组的长度"></a>数组的长度</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] a = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">5</span>];</span><br><span class="line">System.out.println(a.length); <span class="comment">// only array uses &#x27;length&#x27;</span></span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> a = IntArray(<span class="number">5</span>)</span><br><span class="line">println(a.size) <span class="comment">// same with the Collections(e.g. List)</span></span><br></pre></td></tr></table></figure><h2 id="数组的读写"><a href="#数组的读写" class="headerlink" title="数组的读写"></a>数组的读写</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] d = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>&#125;;</span><br><span class="line">d[<span class="number">1</span>] = <span class="string">&quot;Java&quot;</span>;</span><br><span class="line">System.out.println(d[<span class="number">0</span>] + <span class="string">&quot;, &quot;</span> + d[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> d = arrayOf(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>)</span><br><span class="line">d[<span class="number">1</span>] = <span class="string">&quot;Kotlin&quot;</span></span><br><span class="line">println(<span class="string">&quot;<span class="subst">$&#123;d[<span class="number">0</span>]&#125;</span>, <span class="subst">$&#123;d[<span class="number">1</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="数组的遍历"><a href="#数组的遍历" class="headerlink" title="数组的遍历"></a>数组的遍历</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span>[] e = <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>&#125;;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">float</span> element : e) &#123;</span><br><span class="line">  System.out.println(element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin，有点像Python里面的元素遍历了</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> e = floatArrayOf(<span class="number">1f</span>, <span class="number">3f</span>, <span class="number">5f</span>, <span class="number">7f</span>)</span><br><span class="line"><span class="keyword">for</span> (element <span class="keyword">in</span> e) &#123;</span><br><span class="line">  println(element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者还可以使用<code>forEach</code>高阶函数</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.forEach &#123; element -&gt; println(element) &#125;</span><br></pre></td></tr></table></figure><h2 id="数组的包含关系"><a href="#数组的包含关系" class="headerlink" title="数组的包含关系"></a>数组的包含关系</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">float</span> element : e) &#123;</span><br><span class="line">  <span class="keyword">if</span>(element == <span class="number">1f</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;1f exists in variable &#x27;e&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而在Kotlin里面，简单的不行</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="number">1f</span> <span class="keyword">in</span> e) &#123;</span><br><span class="line">  println(<span class="string">&quot;1f exists in variable &#x27;e&#x27;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="区间"><a href="#区间" class="headerlink" title="区间"></a>区间</h1><p>这个Java里是没有，所以只看Kotlin的写法</p><h2 id="区间的创建"><a href="#区间的创建" class="headerlink" title="区间的创建"></a>区间的创建</h2><h3 id="闭区间（-）"><a href="#闭区间（-）" class="headerlink" title="闭区间（..）"></a>闭区间（..）</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intRange = <span class="number">1.</span><span class="number">.10</span> <span class="comment">// [1,10]</span></span><br><span class="line"><span class="keyword">val</span> charRange = <span class="string">&#x27;a&#x27;</span>..<span class="string">&#x27;z&#x27;</span></span><br><span class="line"><span class="keyword">val</span> longRange = <span class="number">1L</span>..<span class="number">100L</span></span><br></pre></td></tr></table></figure><h3 id="开闭区间，前闭后开（until）"><a href="#开闭区间，前闭后开（until）" class="headerlink" title="开闭区间，前闭后开（until）"></a>开闭区间，前闭后开（until）</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intRangeExclusive = <span class="number">1</span> until <span class="number">10</span> <span class="comment">// [1,10)</span></span><br><span class="line"><span class="keyword">val</span> charRangeExclusive = <span class="string">&#x27;a&#x27;</span> until <span class="string">&#x27;z&#x27;</span></span><br><span class="line"><span class="keyword">val</span> longRangeExclusive = <span class="number">1L</span> until <span class="number">100L</span></span><br></pre></td></tr></table></figure><h3 id="倒序区间（downTo）"><a href="#倒序区间（downTo）" class="headerlink" title="倒序区间（downTo）"></a>倒序区间（downTo）</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intRangeReverse = <span class="number">10</span> downTo <span class="number">1</span> <span class="comment">// [10,9,...,1]</span></span><br><span class="line"><span class="keyword">val</span> charRangeReverse = <span class="string">&#x27;z&#x27;</span> downTo <span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">val</span> longRangeReverse = <span class="number">100L</span> downTo <span class="number">1L</span></span><br></pre></td></tr></table></figure><h3 id="区间的步长（step）"><a href="#区间的步长（step）" class="headerlink" title="区间的步长（step）"></a>区间的步长（step）</h3><blockquote><p>在定义区间时，我们还可以定义步长，默认步长为1</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intRangeWithStep = <span class="number">1.</span><span class="number">.10</span> step <span class="number">2</span> <span class="comment">// [1, 3, 5, 7, 9]</span></span><br><span class="line"><span class="keyword">val</span> charRange = <span class="string">&#x27;a&#x27;</span>..<span class="string">&#x27;z&#x27;</span> step <span class="number">2</span></span><br><span class="line"><span class="keyword">val</span> longRange = <span class="number">1L</span>..<span class="number">100L</span> step <span class="number">5</span></span><br></pre></td></tr></table></figure><h2 id="区间的迭代"><a href="#区间的迭代" class="headerlink" title="区间的迭代"></a>区间的迭代</h2><blockquote><p>区间的迭代跟数组基本是类似的</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(element <span class="keyword">in</span> intRange) &#123;</span><br><span class="line">  println(element)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intRange.forEach&#123; println(it) &#125; <span class="comment">// 高阶函数默认的参数叫做it</span></span><br></pre></td></tr></table></figure><h2 id="区间的包含关系"><a href="#区间的包含关系" class="headerlink" title="区间的包含关系"></a>区间的包含关系</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="number">3</span> <span class="keyword">in</span> intRange) &#123;</span><br><span class="line">  println(<span class="string">&quot;3 in range &#x27;intRange&#x27;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="number">12</span> !<span class="keyword">in</span> intRange) &#123;</span><br><span class="line">  println(<span class="string">&quot;12 not in range &#x27;intRange&#x27;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="区间的应用"><a href="#区间的应用" class="headerlink" title="区间的应用"></a>区间的应用</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> array = intArrayOf(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> array.indices) &#123;</span><br><span class="line">  println(array[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，<code>array.indices</code>返回的就是数组索引范围的区间</p><h1 id="集合框架"><a href="#集合框架" class="headerlink" title="集合框架"></a>集合框架</h1><p>Kotlin在Java集合的基础上，做出了一些增强，具体表现为以下几点</p><ul><li>增加了“不可变”集合框架的接口</li><li>没有另起炉灶，复用Java Api的所有实现类型</li><li>提供了丰富医用的方法，例如<code>forEach/map/flatMap</code>等</li></ul><blockquote><p>Scala也是一门JVM语言，Kotlin很多特性都参考了Scala</p></blockquote><h2 id="集合框架的接口类型对比"><a href="#集合框架的接口类型对比" class="headerlink" title="集合框架的接口类型对比"></a>集合框架的接口类型对比</h2><table><thead><tr><th></th><th>Kotlin</th><th>Java</th></tr></thead><tbody><tr><td>不可变List</td><td>List<T></td><td>List<T></td></tr><tr><td>可变List</td><td>MutableList<T></td><td>List<T></td></tr><tr><td>不可变Map</td><td>Map&lt;K, V&gt;</td><td>Map&lt;K, V&gt;</td></tr><tr><td>可变Map</td><td>MutableMap&lt;K, V&gt;</td><td>Map&lt;K, V&gt;</td></tr><tr><td>不可变Set</td><td>Set<T></td><td>Set<T></td></tr><tr><td>可变Set</td><td>MutableSet<T></td><td>Set<T></td></tr></tbody></table><h2 id="集合框架的创建"><a href="#集合框架的创建" class="headerlink" title="集合框架的创建"></a>集合框架的创建</h2><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; intList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intList: List&lt;<span class="built_in">Int</span>&gt; = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 不能添加或者删除元素</span></span><br><span class="line"><span class="keyword">val</span> intList2: MutableList&lt;<span class="built_in">Int</span>&gt; = mutableListOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// 可以添加或者删除元素</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> map: Map&lt;String, Any&gt; = mapOf(<span class="string">&quot;name&quot;</span> to <span class="string">&quot;benny&quot;</span>, <span class="string">&quot;age&quot;</span> to <span class="number">20</span>)</span><br><span class="line"><span class="keyword">val</span> map2: Map&lt;String, Any&gt; = mutableMapOf(<span class="string">&quot;name&quot;</span> to <span class="string">&quot;benny&quot;</span>, <span class="string">&quot;age&quot;</span> to <span class="number">20</span>) <span class="comment">// 其中的 &quot;name&quot; to &quot;benny&quot; 是一个中缀表达式</span></span><br></pre></td></tr></table></figure><h2 id="集合实现类复用与类型别名"><a href="#集合实现类复用与类型别名" class="headerlink" title="集合实现类复用与类型别名"></a>集合实现类复用与类型别名</h2><p>我们来比较一下Java与Kotlin创建集合的代码<br>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// java.util.ArrayList</span></span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> stringList = ArrayList&lt;String&gt;() <span class="comment">// kotlin.collections.ArrayList</span></span><br></pre></td></tr></table></figure><p>Kotlin里面集合的类型别名定义</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.1&quot;</span>)</span> <span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">typealias</span> ArrayList&lt;E&gt; = java.util.ArrayList&lt;E&gt;</span><br><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.1&quot;</span>)</span> <span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">typealias</span> LinkedHashMap&lt;K, V&gt; = java.util.LinkedHashMap&lt;K, V&gt;</span><br><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.1&quot;</span>)</span> <span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">typealias</span> HashMap&lt;K, V&gt; = java.util.HashMap&lt;K, V&gt;</span><br><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.1&quot;</span>)</span> <span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">typealias</span> LinkedHashSet&lt;E&gt; = java.util.LinkedHashSet&lt;E&gt;</span><br><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.1&quot;</span>)</span> <span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">typealias</span> HashSet&lt;E&gt; = java.util.HashSet&lt;E&gt;</span><br></pre></td></tr></table></figure><blockquote><p>Kotlin使用类型别名，是出于跨平台的考虑，同一份代码，Kotlin不只是希望能跑在JVM平台，也可以是Native平台，所以，说不定有朝一日，Kotlin编译出来的不再是Java字节码，而是二进制机器码！</p></blockquote><h2 id="集合框架的读写"><a href="#集合框架的读写" class="headerlink" title="集合框架的读写"></a>集合框架的读写</h2><p>Kotlin还支持<strong>运算符重载</strong></p><h3 id="添加元素"><a href="#添加元素" class="headerlink" title="添加元素"></a>添加元素</h3><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  stringList.add(<span class="string">&quot;num: &quot;</span> + i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">0.</span><span class="number">.10</span>) &#123;</span><br><span class="line">  stringList += <span class="string">&quot;num: <span class="variable">$i</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除元素"><a href="#删除元素" class="headerlink" title="删除元素"></a>删除元素</h3><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  stringList.remove(<span class="string">&quot;num: &quot;</span> + i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">0.</span><span class="number">.10</span>) &#123;</span><br><span class="line">  stringList -= <span class="string">&quot;num: <span class="variable">$i</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改元素"><a href="#修改元素" class="headerlink" title="修改元素"></a>修改元素</h3><p>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stringList.set(<span class="number">5</span>, <span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">valueAt5</span> <span class="operator">=</span> stringList.get(<span class="number">5</span>);</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stringList[<span class="number">5</span>] = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line"><span class="keyword">val</span> valueAt5 = stringList[<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>如果是Map<br>Java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;Hello&quot;</span>, <span class="number">10</span>);</span><br><span class="line">System.out.println(map.get(<span class="string">&quot;Hello&quot;</span>));</span><br></pre></td></tr></table></figure><p>Kotlin</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> map = HashMap&lt;String, <span class="built_in">Int</span>&gt;()</span><br><span class="line">map[<span class="string">&quot;Hello&quot;</span>] = <span class="number">10</span></span><br><span class="line">println(map[<span class="string">&quot;Hello&quot;</span>])</span><br></pre></td></tr></table></figure><h2 id="几个重要的数据结构"><a href="#几个重要的数据结构" class="headerlink" title="几个重要的数据结构"></a>几个重要的数据结构</h2><h3 id="Pair"><a href="#Pair" class="headerlink" title="Pair"></a>Pair</h3><p>可以理解为键值对，包含<code>first</code>和<code>second</code>两个字段的数据结构</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> pair = <span class="string">&quot;Hello&quot;</span> to <span class="string">&quot;Kotlin&quot;</span></span><br><span class="line"><span class="keyword">val</span> pair2 = Pair(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Kotlin&quot;</span>) <span class="comment">// 两种创建方式</span></span><br><span class="line"><span class="keyword">val</span> first = pair.first <span class="comment">// 获取对应元素</span></span><br><span class="line"><span class="keyword">val</span> second = pair.second</span><br><span class="line"><span class="keyword">val</span> (x, y) = pair <span class="comment">// 解构表达式</span></span><br></pre></td></tr></table></figure><h3 id="Triple"><a href="#Triple" class="headerlink" title="Triple"></a>Triple</h3><p>跟<code>Pair</code>类似，不过含有三个值</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> triple = Triple(<span class="string">&quot;x&quot;</span>, <span class="number">2</span>, <span class="number">3.0</span>)</span><br><span class="line"><span class="keyword">val</span> first = triple.first <span class="comment">// 获取对应元素</span></span><br><span class="line"><span class="keyword">val</span> second = triple.second</span><br><span class="line"><span class="keyword">val</span> third = triple.third</span><br><span class="line"><span class="keyword">val</span> (x, y, z) = triple <span class="comment">// 解构表达式</span></span><br></pre></td></tr></table></figure><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><blockquote><p>在Kotlin里面，函数也是类型的一种，是一等公民，可以赋值、传递，并在合适的条件下调用</p></blockquote><h2 id="学习路线图"><a href="#学习路线图" class="headerlink" title="学习路线图"></a>学习路线图</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115185452.png" alt="20211115185452"></p><h2 id="函数的定义"><a href="#函数的定义" class="headerlink" title="函数的定义"></a>函数的定义</h2><p>一个函数包含：函数名，函数参数列表，函数返回值，函数体</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span>:<span class="built_in">Unit</span> &#123;</span><br><span class="line">  println(args.contentToString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数 VS 方法</p><ul><li>方法可以认为是函数的一种特殊类型</li><li>从形式上，有<code>receiver</code>的函数即为方法</li></ul><h2 id="函数的类型"><a href="#函数的类型" class="headerlink" title="函数的类型"></a>函数的类型</h2><blockquote><p>在Kotlin里，函数也是有类型的</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// () -&gt; Unit</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(p()</span></span>: <span class="built_in">Int</span>): String &#123; ... &#125; <span class="comment">// (Int) -&gt; String</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">bar</span><span class="params">(p0: <span class="type">String</span>, p1: <span class="type">Long</span>)</span></span>: Any &#123; ... &#125; <span class="comment">// Foo.(String, Long) -&gt; Any，其中 Foo就是bar方法的receiver，类型等同于 (Foo, String, Long) -&gt; Any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="函数的引用"><a href="#函数的引用" class="headerlink" title="函数的引用"></a>函数的引用</h2><blockquote><p>函数的引用类似于C语言中的函数指针，可用于函数传递</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// val f: () -&gt; Unit = ::foo</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">(p()</span></span>: <span class="built_in">Int</span>): String &#123; ... &#125; <span class="comment">// val g: (Int) -&gt; String = ::foo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">bar</span><span class="params">(p0: <span class="type">String</span>, p1: <span class="type">Long</span>)</span></span>: Any &#123; ... &#125; <span class="comment">// val h: (Foo, String, Long) -&gt; Any = Foo::bar</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>绑定receiver的函数引用</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> foo = Foo()</span><br><span class="line"><span class="keyword">val</span> m: (String, <span class="built_in">Long</span>) -&gt; Any = foo::bar <span class="comment">// 绑定receiver的函数引用，其中foo是对象实例</span></span><br><span class="line"></span><br><span class="line">f(r, x, y) = r * (x + y)</span><br><span class="line"><span class="comment">// 令：r = 2</span></span><br><span class="line">m(x, y) = f(<span class="number">2</span>, x, y) = <span class="number">2</span> * (x + y)</span><br></pre></td></tr></table></figure><h2 id="变长参数-vararg关键字"><a href="#变长参数-vararg关键字" class="headerlink" title="变长参数(vararg关键字)"></a>变长参数(<strong>vararg</strong>关键字)</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(<span class="keyword">vararg</span> args: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">  println(args.contentToString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="多返回值"><a href="#多返回值" class="headerlink" title="多返回值"></a>多返回值</h2><blockquote><p>Pair或Triple定义返回值，使用结构获取返回值</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">multiReturnValues</span><span class="params">()</span></span>: Triple&lt;<span class="built_in">Int</span>, <span class="built_in">Long</span>, <span class="built_in">Double</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> Triple(<span class="number">1</span>, <span class="number">3L</span>, <span class="number">4.0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> (a, b, c) = multiReturnValues() <span class="comment">// 解构获取返回值</span></span><br></pre></td></tr></table></figure><h2 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h2><blockquote><p>Kotlin允许为参数指定默认值，这样一来，就不必像Java一样定义方法重载了</p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">defaultParameter</span><span class="params">(x: <span class="type">Int</span>, y: <span class="type">String</span>, z: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123;</span><br><span class="line">  TODO()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultParameter(<span class="number">5</span>, <span class="string">&quot;Hello&quot;</span>) <span class="comment">// 这里的z使用默认的0L</span></span><br></pre></td></tr></table></figure><h2 id="具名函数"><a href="#具名函数" class="headerlink" title="具名函数"></a>具名函数</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">defaultParameter</span><span class="params">(x: <span class="type">Int</span> = <span class="number">5</span>, y: <span class="type">String</span>, z: <span class="type">Long</span> = <span class="number">0</span>L)</span></span> &#123; <span class="comment">// 不是最后的参数</span></span><br><span class="line">  TODO()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultParameter(y = <span class="string">&quot;Hello&quot;</span>) <span class="comment">// 只传递y参数，其余使用默认值</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要介绍Kotlin的内置类型和简单用法</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin从入门到精通 | 第二章 开发环境搭建</title>
    <link href="https://blog.gcdd.top/p/55865/"/>
    <id>https://blog.gcdd.top/p/55865/</id>
    <published>2021-11-15T08:26:31.000Z</published>
    <updated>2023-08-30T04:52:53.891Z</updated>
    
    <content type="html"><![CDATA[<p>本章节主要介绍Kotlin的安装和常用命令<span id="more"></span><br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211117161411.png" alt="20211117161411"></p><h1 id="Kotlin编译器"><a href="#Kotlin编译器" class="headerlink" title="Kotlin编译器"></a>Kotlin编译器</h1><h2 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h2><h3 id="直接下载安装"><a href="#直接下载安装" class="headerlink" title="直接下载安装"></a>直接下载安装</h3><p><a href="https://github.com/JetBrains/kotlin/releases">GitHub - JetBrains/kotlin: The Kotlin Programming Language.</a></p><p>1、例如在Windows平台，可以选择下载<code>kotlin-compiler-1.5.31.zip</code><br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115163244.png" alt="20211115163244"></p><p>2、下载完毕之后，解压到合适的位置，例如<code>D:\DevTools\Kotlin</code></p><p>3、配置环境变量<br>把<code>kotlinc\bin</code>添加到环境变量<code>Path</code>中，如图<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211115163420.png" alt="20211115163420"></p><p>4、确认配置完成</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kotlinc -version</span><br><span class="line">info: kotlinc-jvm 1.5.31 (JRE 11.0.11+9)</span><br></pre></td></tr></table></figure><h3 id="使用包管理器"><a href="#使用包管理器" class="headerlink" title="使用包管理器"></a>使用包管理器</h3><ul><li>Linux SDKMAN</li><li>Mac OSX: Homebrew</li><li>Windows: Scoop</li></ul><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul><li><p>kotlin：运行kotlin脚本/REPL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kotlin</span><br><span class="line">Welcome to Kotlin version 1.5.31 (JRE 11.0.11+9)</span><br><span class="line">Type :<span class="built_in">help</span> <span class="keyword">for</span> <span class="built_in">help</span>, :quit <span class="keyword">for</span> quit</span><br><span class="line">&gt;&gt;&gt; 1 + 1</span><br><span class="line">res0: kotlin.Int = 2</span><br><span class="line">&gt;&gt;&gt; :<span class="built_in">help</span></span><br><span class="line">Available commands:</span><br><span class="line">:<span class="built_in">help</span>                   show this <span class="built_in">help</span></span><br><span class="line">:quit                   <span class="built_in">exit</span> the interpreter</span><br><span class="line">:dump bytecode          dump classes to terminal</span><br><span class="line">:load &lt;file&gt;            load script from specified file</span><br></pre></td></tr></table></figure></li><li><p>kotlinc：编译kotlin源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kotlinc 1.kt</span><br></pre></td></tr></table></figure></li></ul><h1 id="使用IDE"><a href="#使用IDE" class="headerlink" title="使用IDE"></a>使用IDE</h1><p>推荐使用IDEA，开箱即用，无需配置，因为<code>Jetbrains</code>和<code>Kotlin</code>本来就是一家嘛。<br>不推荐使用<code>Eclipse</code>开发Kotlin程序，所以根本没研究怎么配置<code>Eclipse</code>下的<code>Kotlin</code>开发环境<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/Image.png" alt="Image"></p><h1 id="使用Gradle构建工具"><a href="#使用Gradle构建工具" class="headerlink" title="使用Gradle构建工具"></a>使用Gradle构建工具</h1><p><code>Gradle</code>是一个灵活高效且支持多语言多平台的构建工具，是<code>Kotlin</code>生态下推荐的构建工具，<code>Maven</code>好像没法作为<code>Kotlin</code>的构建工具？没去仔细研究，但是，既然已经用了<code>Kotlin</code>，为什么还要去使用<code>Maven</code>呢？<br>赶紧体验强大现代的<code>Gradle</code>吧！<br><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/202111151645269.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本章节主要介绍Kotlin的安装和常用命令</summary>
    
    
    
    <category term="Kotlin从入门到精通" scheme="https://blog.gcdd.top/categories/Kotlin%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"/>
    
    
    <category term="Kotlin" scheme="https://blog.gcdd.top/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>【阅读羊毛】加油鸭鸭</title>
    <link href="https://blog.gcdd.top/p/45600/"/>
    <id>https://blog.gcdd.top/p/45600/</id>
    <published>2021-10-20T15:12:33.000Z</published>
    <updated>2023-08-30T04:52:53.894Z</updated>
    
    <content type="html"><![CDATA[<p>微信阅读羊毛，<code>0.3</code>元即可提现，每天可提现次数为三次。测试环境为青龙，<code>v2p</code>自行测试<span id="more"></span></p><blockquote><p>自动提现暂时没好，但是会好的</p></blockquote><h1 id="更新日志"><a href="#更新日志" class="headerlink" title="更新日志"></a>更新日志</h1><h1 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h1><p>打开微信扫码即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008212738.png" alt="image-20211008212736694"></p><h1 id="变量抓取"><a href="#变量抓取" class="headerlink" title="变量抓取"></a>变量抓取</h1><blockquote><p>仅演示安卓小黄鸟</p></blockquote><p>先打开小黄鸟，选择目标应用 – 微信，开始抓包。</p><p>扫码进入加油鸭鸭界面，随意点击几下，或者进行一次阅读</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008213449.png" alt="image-20211008212930305"></p><p>然后返回小黄鸟，停止抓包，找到域名为<code>zhengshih5jiekou.zhuandayup.cn</code>的抓包记录，选择请求头中的<code>Authorization </code>和<code>User-Agent</code>。</p><h1 id="变量填写"><a href="#变量填写" class="headerlink" title="变量填写"></a>变量填写</h1><p>进入青龙面板，环境变量，添加变量。</p><ul><li><p>必要变量：<code>wx_jyy_token</code></p></li><li><p>可选变量：<code>wx_jyy_User_Agent</code></p></li></ul><p>多账号使用 @ 或 # 或 换行 隔开</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008213442.png" alt="image-20211008213428048"></p><h1 id="脚本拉取"><a href="#脚本拉取" class="headerlink" title="脚本拉取"></a>脚本拉取</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql raw https://raw.githubusercontent.com/gcdd1993/My-Scripts/master/yd/wx_jyy.js</span><br></pre></td></tr></table></figure><p>定时建议为（8点到22点，每一小时跑一次）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 8-22 * * *</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008213458.png" alt="image-20211008213227089"></p><h1 id="交流"><a href="#交流" class="headerlink" title="交流"></a>交流</h1><ul><li><a href="https://t.me/jd_wool">TG群</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;微信阅读羊毛，&lt;code&gt;0.3&lt;/code&gt;元即可提现，每天可提现次数为三次。测试环境为青龙，&lt;code&gt;v2p&lt;/code&gt;自行测试</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="薅羊毛" scheme="https://blog.gcdd.top/tags/%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>果冻宝盒（每天0.7R/提现5元秒到支付宝）</title>
    <link href="https://blog.gcdd.top/p/17546/"/>
    <id>https://blog.gcdd.top/p/17546/</id>
    <published>2021-10-20T07:26:30.000Z</published>
    <updated>2023-08-30T04:52:53.894Z</updated>
    
    <content type="html"><![CDATA[<p>看广告得金币，100金币提现1元，5元起提现秒到支付宝<span id="more"></span></p><h1 id="上车"><a href="#上车" class="headerlink" title="上车"></a>上车</h1><h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p>软件下载地址：<a href="https://wwa.lanzoui.com/iTPUfvk7x7i">果冻宝盒</a></p><p>邀请码：<code>3V67Q2</code></p><p>注册好后，打开小黄鸟抓包工具，筛选域名是<code>proxy.guodongbaohe.com</code>，随便选一个请求就行。</p><p>只支持安卓，<code>ios</code>的算法有变</p><p>抓取以下参数</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">x-userid</span></span><br><span class="line"><span class="attr">x-agent</span></span><br><span class="line"><span class="attr">x-platform</span></span><br><span class="line"><span class="attr">x-token</span></span><br></pre></td></tr></table></figure><h2 id="脚本配置"><a href="#脚本配置" class="headerlink" title="脚本配置"></a>脚本配置</h2><h3 id="青龙拉取命令"><a href="#青龙拉取命令" class="headerlink" title="青龙拉取命令"></a>青龙拉取命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ql raw https://raw.githubusercontent.com/gcdd1993/My-Scripts/master/other/gdbh.py</span><br><span class="line"><span class="comment"># cron 0 7 * * * 一天一次</span></span><br></pre></td></tr></table></figure><h3 id="账号配置"><a href="#账号配置" class="headerlink" title="账号配置"></a>账号配置</h3><p>创建文件<code>gdbh_token.json</code>，写入以下信息，多账号填写一样</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;userid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>然后将文件上传到<code>/ql/scripts/</code>目录即可</p><h1 id="交流"><a href="#交流" class="headerlink" title="交流"></a>交流</h1><ul><li><a href="https://t.me/jd_wool">TG群</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;看广告得金币，100金币提现1元，5元起提现秒到支付宝</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="薅羊毛" scheme="https://blog.gcdd.top/tags/%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>【阅读羊毛】金银手指（每天1.2RMB）</title>
    <link href="https://blog.gcdd.top/p/9728/"/>
    <id>https://blog.gcdd.top/p/9728/</id>
    <published>2021-10-08T02:41:48.000Z</published>
    <updated>2023-08-30T04:52:53.894Z</updated>
    
    <content type="html"><![CDATA[<p>微信阅读羊毛，<code>0.4</code>元即可提现，无邀请每天<code>1.2R</code>左右。测试环境为青龙，<code>v2p</code>自行测试<span id="more"></span></p><h1 id="更新日志"><a href="#更新日志" class="headerlink" title="更新日志"></a>更新日志</h1><h2 id="2021-10-14"><a href="#2021-10-14" class="headerlink" title="2021-10-14"></a>2021-10-14</h2><ul><li>修复”提现必须是0.4的整数倍”</li></ul><h2 id="2021-10-09"><a href="#2021-10-09" class="headerlink" title="2021-10-09"></a>2021-10-09</h2><ul><li>添加自主检测（24小时无法阅读的，自主检测一次即可回复）</li></ul><h2 id="2021-10-08"><a href="#2021-10-08" class="headerlink" title="2021-10-08"></a>2021-10-08</h2><ul><li><p>在完成阅读任务前，模拟阅读微信文章</p></li><li><p>解决青龙面板定时执行脚本异常问题</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008192028.png" alt="image-20211008192026384"></p><ul><li>新增提现通知</li></ul><p>每次4毛多，每天都可以提现2~3次</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008110352.png" alt="image-20211008110350490"></p><h1 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h1><p>打开微信扫码即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211014112117.png" alt="image-20211014112114607"></p><h1 id="变量抓取"><a href="#变量抓取" class="headerlink" title="变量抓取"></a>变量抓取</h1><blockquote><p>仅演示安卓小黄鸟</p></blockquote><p>先打开小黄鸟，选择目标应用 – 微信，开始抓包。</p><p>扫码进入金银手指界面，随意点击几下，或者进行一次阅读</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008105428.png" alt="image-20211008105426359"></p><p>然后返回小黄鸟，停止抓包，找到域名为<code>apponlie.sahaj.cn</code>的抓包记录，选择请求头中的<code>token </code>和<code>User-Agent</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008105525.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008105534.png" alt="img"></p><h1 id="变量填写"><a href="#变量填写" class="headerlink" title="变量填写"></a>变量填写</h1><p>进入青龙面板，环境变量，添加变量。</p><ul><li><p>必要变量：<code>soy_wx_jysz_token</code></p></li><li><p>可选变量：<code>soy_wx_jysz_User_Agent</code></p></li></ul><p>多账号使用 @ 或 # 或 换行 隔开</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008105703.png" alt="image-20211008105701027"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008105825.png" alt="image-20211008105823650"></p><h1 id="脚本拉取"><a href="#脚本拉取" class="headerlink" title="脚本拉取"></a>脚本拉取</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql raw https://raw.githubusercontent.com/gcdd1993/My-Scripts/master/yd/wx_jysz.js</span><br></pre></td></tr></table></figure><p>定时建议为（8点到22点，每两小时跑一次）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 8-22/2 * * *</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008110307.png" alt="image-20211008110305702"></p><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="为什么阅读没有收益？"><a href="#为什么阅读没有收益？" class="headerlink" title="为什么阅读没有收益？"></a>为什么阅读没有收益？</h2><p>手动进入微信金银手指，<strong>自主检测</strong>，即可修复</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20211008220552.png" alt="image-20211008220550089"></p><h1 id="交流"><a href="#交流" class="headerlink" title="交流"></a>交流</h1><ul><li><a href="https://t.me/jd_wool">TG群</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;微信阅读羊毛，&lt;code&gt;0.4&lt;/code&gt;元即可提现，无邀请每天&lt;code&gt;1.2R&lt;/code&gt;左右。测试环境为青龙，&lt;code&gt;v2p&lt;/code&gt;自行测试</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="薅羊毛" scheme="https://blog.gcdd.top/tags/%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>JD抓包教程</title>
    <link href="https://blog.gcdd.top/p/11998/"/>
    <id>https://blog.gcdd.top/p/11998/</id>
    <published>2021-09-05T06:44:22.000Z</published>
    <updated>2023-08-30T04:52:53.893Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安卓"><a href="#安卓" class="headerlink" title="安卓"></a>安卓</h1><p>先下载<a href="https://wwa.lanzoui.com/iLqV9r97f6j">HttpCanary_v3.3.6_Premium_Crack.apk - 蓝奏云 (lanzoui.com)</a>，然后打开准备<span id="more"></span></p><h2 id="安装CA证书"><a href="#安装CA证书" class="headerlink" title="安装CA证书"></a>安装CA证书</h2><p>打开 设置 -&gt; <code>HttpCanary</code>根证书 -&gt; 安装<code>HttpCanary</code>根证书，点击安装即可，安装完毕退回<code>HttpCanary</code>首页</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151913.png" alt="image-20210905151911769"></p><h2 id="选择目标应用为京东"><a href="#选择目标应用为京东" class="headerlink" title="选择目标应用为京东"></a>选择目标应用为京东</h2><p>右上角抽屉 -&gt; 目标应用 -&gt; 右上角+号</p><p>选择京东App</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151929.png" alt="image-20210905151927290"></p><h2 id="点击开始抓包"><a href="#点击开始抓包" class="headerlink" title="点击开始抓包"></a>点击开始抓包</h2><p>退到首页，右下角，纸飞机按钮，点击开始</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905145257.png" alt="image-20210905145254866"></p><h2 id="回到京东App，进入我的"><a href="#回到京东App，进入我的" class="headerlink" title="回到京东App，进入我的"></a>回到京东App，进入我的</h2><p>进入京东App，随便点一些内容，前提是<strong>已登录</strong></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151946.png" alt="image-20210905151944873"></p><h2 id="获取wskey"><a href="#获取wskey" class="headerlink" title="获取wskey"></a>获取wskey</h2><p>抓包完毕，回到<code>HttpCanary</code>，停止纸飞机按钮，然后右上角点击过滤</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905145917.png" alt="image-20210905145915840"></p><p>勾选<code>api.m.jd.com</code></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905145943.png" alt="image-20210905145941755"></p><p>返回首页，随便选一个，然后进入请求详情，长按复制<code>Cookie</code>即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905150232.png" alt="image-20210905150230009"></p><p>复制结果类似</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pin</span>=<span class="string">xxx;wskey=xxx;</span></span><br></pre></td></tr></table></figure><h1 id="苹果"><a href="#苹果" class="headerlink" title="苹果"></a>苹果</h1><p>App市场搜索Stream下载安装，界面打开如下</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905150421.png" alt="image-20210905150419313"></p><h2 id="安装CA证书-1"><a href="#安装CA证书-1" class="headerlink" title="安装CA证书"></a>安装CA证书</h2><p>还是一样，必须先安装CA根证书，才能抓取HTTPS请求</p><p>打开Stream，往下拉，找到HTTPS抓包，点进去，设置一下。期间会下载一个后缀为.ca的文件，按照提示下载即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905150754.png" alt="image-20210905150752273"></p><h2 id="设置抓包模式"><a href="#设置抓包模式" class="headerlink" title="设置抓包模式"></a>设置抓包模式</h2><p>进入”设置抓包模式”，切换到白名单模式，在输入框中填写<code>api.m.jd.com</code>，右上角立即生效</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151138.png" alt="image-20210905151135082"></p><h2 id="开始抓包"><a href="#开始抓包" class="headerlink" title="开始抓包"></a>开始抓包</h2><p>回到首页，开始抓包</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151607.png" alt="image-20210905151605905"></p><p>进入京东App，我的，然后退回Stream，停止抓包。</p><p>进入抓包历史，选择刚才抓取的历史记录，进去，随便点一个，切换到请求Tab，找到Cookie，复制</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151652.png" alt="image-20210905151650698"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210905151842.png" alt="image-20210905151840348"></p><h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><p><a href="https://wwa.lanzoui.com/i8scltmxz7g">wskey to pt_key.exe - 蓝奏云 (lanzoui.com)</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;安卓&quot;&gt;&lt;a href=&quot;#安卓&quot; class=&quot;headerlink&quot; title=&quot;安卓&quot;&gt;&lt;/a&gt;安卓&lt;/h1&gt;&lt;p&gt;先下载&lt;a href=&quot;https://wwa.lanzoui.com/iLqV9r97f6j&quot;&gt;HttpCanary_v3.3.6_Premium_Crack.apk - 蓝奏云 (lanzoui.com)&lt;/a&gt;，然后打开准备</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="抓包" scheme="https://blog.gcdd.top/tags/%E6%8A%93%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>点淘新毛，新人秒到账11元</title>
    <link href="https://blog.gcdd.top/p/44515/"/>
    <id>https://blog.gcdd.top/p/44515/</id>
    <published>2021-09-04T14:10:33.000Z</published>
    <updated>2023-08-30T04:52:53.894Z</updated>
    
    <content type="html"><![CDATA[<p>点淘目前在做推广，新人无需额外操作，直接秒到账支付宝11元（分三天）。</p><p>这个与其他APP的区别是，每个任务完成都可以提现，而且是支付宝秒到账。第二天签到直接给1.5元。<span id="more"></span></p><p>1 xixi:/🔐mJ9KXoDc3V7₤  第一步：去应用商店下载「點淘」APP: <a href="http://a.app.qq.com/o/simple.jsp?pkgname=com.taobao.live&amp;ckey=CK1469552291609">http://a.app.qq.com/o/simple.jsp?pkgname=com.taobao.live&amp;ckey=CK1469552291609</a><br>第二步：打开點淘搜索：LRH71W9D<br>第三步：邀请码提交成功得5yuan</p><p>或者扫描二维码下载</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904221614.png" alt="image-20210904221612172"></p><h1 id="新人任务"><a href="#新人任务" class="headerlink" title="新人任务"></a>新人任务</h1><blockquote><p>新人会有为期三天的新人任务，每完成一个任务，立即可以提现到支付宝。一共是10元，加上填写邀请码的，一共是11元，都是秒提现到账支付宝</p></blockquote><p>实测下来十几分钟即可完成，完成后将直接提现到账3元</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904234554.png" alt="image-20210904234551995"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904235823.png" alt="image-20210904235820863"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904234611.png" alt="image-20210904234608864"></p><h2 id="换红包任务"><a href="#换红包任务" class="headerlink" title="换红包任务"></a>换红包任务</h2><p>换0.1的即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904235102.png" alt="image-20210904235100726"></p><h2 id="去下单任务"><a href="#去下单任务" class="headerlink" title="去下单任务"></a>去下单任务</h2><p>点进去，买补贴价为3.8的垃圾袋，进去之后，领券0.9元，加上上面换的0.1元红包，0.8元买下，退回去，返1元现金。</p><p>尽量找低价的商品，或者是刚需也行。</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904235442.png" alt="image-20210904235439899"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210904235507.png" alt="image-20210904235504425"></p><h1 id="日常任务"><a href="#日常任务" class="headerlink" title="日常任务"></a>日常任务</h1><p>基本是以刷视频送元宝为主，也有一些小游戏，当然也是送元宝的</p><h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><p><a href="https://wwa.lanzoui.com/itCkhtm8bhc">点淘视频.apk - 蓝奏云 (lanzoui.com)</a></p><p>辅助刷视频用</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;点淘目前在做推广，新人无需额外操作，直接秒到账支付宝11元（分三天）。&lt;/p&gt;
&lt;p&gt;这个与其他APP的区别是，每个任务完成都可以提现，而且是支付宝秒到账。第二天签到直接给1.5元。</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="淘宝" scheme="https://blog.gcdd.top/tags/%E6%B7%98%E5%AE%9D/"/>
    
  </entry>
  
  <entry>
    <title>【京东薅羊毛】一键部署青龙面板 xdd扫码登录</title>
    <link href="https://blog.gcdd.top/p/35018/"/>
    <id>https://blog.gcdd.top/p/35018/</id>
    <published>2021-08-20T15:12:33.000Z</published>
    <updated>2023-08-30T04:52:53.893Z</updated>
    
    <content type="html"><![CDATA[<p>  <a href="#Travis CI"><img src="https://www.travis-ci.com/gcdd1993/qinglong-xdd.svg?branch=master" alt="Build Status"></a></p><h1 id="更新日志"><a href="#更新日志" class="headerlink" title="更新日志"></a>更新日志</h1><h2 id="2021-08-28"><a href="#2021-08-28" class="headerlink" title="2021-08-28"></a>2021-08-28</h2><ul><li>适配青龙<code>2.9.x</code></li><li>不再允许自动升级和手动升级，升级可以通过拉取新镜像</li></ul><span id="more"></span><h3 id="升级方式"><a href="#升级方式" class="headerlink" title="升级方式"></a>升级方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd</span><br><span class="line">docker-compose down</span><br><span class="line"><span class="comment"># 清理旧镜像</span></span><br><span class="line">docker rmi --force qinglong-xdd:latest</span><br><span class="line"><span class="comment"># 启动新容器</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>打开青龙，配置<code>OpenApi</code></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210828185101.png" alt="Untitled"></p><p>复制<code>Client_id</code>和<code>Client_key</code></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210828185107.png" alt="Untitled"></p><p>填入小滴滴配置文件的容器<code>username</code>和<code>password</code></p><ul><li><code>client_id</code>：相当于原来的<code>username</code></li><li><code>client_key</code>：相当于原来的<code>password</code></li></ul><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/20210828185112.png" alt="Untitled"></p><p>然后重启容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd &amp;&amp; docker-compose restart</span><br></pre></td></tr></table></figure><h3 id="全新安装"><a href="#全新安装" class="headerlink" title="全新安装"></a>全新安装</h3><blockquote><p>todo</p></blockquote><h2 id="2021-08-23更新"><a href="#2021-08-23更新" class="headerlink" title="2021-08-23更新"></a>2021-08-23更新</h2><ul><li>支持xdd容器内升级</li><li>修复启动需要重新扫码绑定机器人的问题</li></ul><p>更新步骤（重要）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝xdd/xdd.db和xdd配置到安全的地方，比如你自己的电脑</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/qinglong-xdd</span><br><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd</span><br><span class="line">wget https://ghproxy.com/https://raw.githubusercontent.com/gcdd1993/qinglong-xdd/master/docker-compose.yml</span><br><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line">docker-compose down </span><br><span class="line"><span class="comment"># 删除旧的镜像</span></span><br><span class="line">docker image <span class="built_in">ls</span> | grep xdd <span class="comment"># 记住镜像id，有多个删除多个</span></span><br><span class="line">docker rmi --force 镜像<span class="built_in">id</span></span><br><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># 还原数据</span></span><br><span class="line"><span class="built_in">cp</span> db/xdd.db xdd/.xdd.db</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210823155447173.png" alt="image-20210823155447173"></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210823160123948.png" alt="image-20210823160123948"></p><hr><p>XDD的热度🔥越来越高了，目前它的功能确实很多花样，非常有意思。但是很多人都无法自己完成编译，更不用说部署了。所以我特地编译了青龙面板+xdd一键部署镜像。</p><p><a href="https://blog.gcdd.top/p/56460/">一键部署青龙 + ninja请移步这里</a></p><p>如果想搭建但是还没有购买服务器的，可以点我的链接进行购买，<a href="https://www.aliyun.com/minisite/goods?userCode=ijsckn04&share_source=copy_link">阿里云轻量级服务器 2核2G 99/年</a>，不仅你可以获得优惠券，我也可以获得邀请人数。购买完成可以添加我的qq 1398371419，备注“青龙”，我将会全程指导你安装，如果实在不会，我也可以代为搭建。</p><!-- more --><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>部署可以说是非常简单了，只需要安装好docker和docker-compose，接下来就交给机器吧。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/qinglong-xdd</span><br><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd</span><br><span class="line">wget https://ghproxy.com/https://raw.githubusercontent.com/gcdd1993/qinglong-xdd/master/docker-compose.yml</span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># 然后修改xddconf目录下的配置文件</span></span><br><span class="line"><span class="comment"># app.conf #启动端口</span></span><br><span class="line"><span class="comment"># config.yaml #xdd配置</span></span><br><span class="line"><span class="comment"># 修改完毕重启容器</span></span><br><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure><p>以下是<code>docker-compose.yml</code>文件，如果下载不下来的，可以自行创建文件<code>docker-compose.yml</code>，写入以下内容即可</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">qinglong-xdd:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gcdd1993/qinglong-xdd:latest</span> <span class="comment"># tag（即版本）可以自己修改</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">qinglong-xdd</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5700</span><span class="string">:5700</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ENABLE_HANGUP=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ENABLE_WEB_PANEL=true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/ql/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db:/ql/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./xddconf:/ql/xdd/conf</span></span><br></pre></td></tr></table></figure><p>然后执行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br></pre></td></tr></table></figure><p>等待容器启动完毕</p><h2 id="访问青龙面板"><a href="#访问青龙面板" class="headerlink" title="访问青龙面板"></a>访问青龙面板</h2><p>地址：<a href="http://localhost:5700/">http://localhost:5700</a></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820232624916.png" alt="image-20210820232624916"></p><p>第一次打开输入账号<code>admin</code>，密码<code>admin</code>，会自动生成密码，密码在运行目录的<code>config/auth.json</code>里面可以看见</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820232806149.png" alt="image-20210820232806149"></p><h2 id="修改xdd配置"><a href="#修改xdd配置" class="headerlink" title="修改xdd配置"></a>修改xdd配置</h2><p>打开运行目录下的<code>xddconf/config.yaml</code>，修改青龙配置，有人扫码扫不上，很可能是因为这个没改</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">http://localhost:5700</span> <span class="comment"># 青龙IP地址</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Ids2i7w#Swtwp-cDSV</span> <span class="comment"># 青龙登录密码</span></span><br><span class="line">    <span class="attr">weigth:</span>  </span><br><span class="line">    <span class="attr">mode:</span> <span class="string">parallel</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><p>改完后重启容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保目录在docker-compose.yml文件所在目录</span></span><br><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure><h2 id="访问-XDD面板"><a href="#访问-XDD面板" class="headerlink" title="访问 XDD面板"></a>访问 XDD面板</h2><p>地址是<a href="http://localhost:8080/">http://localhost:8080</a></p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820232858439.png" alt="image-20210820232858439"></p><p>直接扫码登录即可（这些配置干啥的，我也不是很懂）</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820232956642.png" alt="image-20210820232956642"></p><p>然后回到青龙，看是否已经添加Cookie成功</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820235440214.png" alt="image-20210820235440214"></p><h1 id="XDD配置介绍"><a href="#XDD配置介绍" class="headerlink" title="XDD配置介绍"></a>XDD配置介绍</h1><blockquote><p>以下内容摘自<a href="https://www.kejiwanjia.com/zheteng/9392.html">群晖Docker青龙面板XDD扫码部署指南8.16更新新版编译 – 科技玩家 (kejiwanjia.com)</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mode:</span> <span class="string">balance</span> <span class="comment">#模式 balance(均衡模式)、parallel(平行模式)</span></span><br><span class="line"><span class="attr">containers:</span> <span class="comment">#容器，可配置多个</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">http://192.168.31.233:5700</span> <span class="comment">#青龙2.2、青龙2.8、v1v2v3v4v5访问地址（根据自己ip填）</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span> <span class="comment">#用户名（青龙config文件夹-auth.json文件找）</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span> <span class="comment">#密码（青龙config文件夹-auth.json文件找）</span></span><br><span class="line">    <span class="attr">weigth:</span>  <span class="comment">#权重 balance模式下权重越高分得的ck越多，默认1（看你自己，我单容器默认）</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">parallel</span> <span class="comment">#单独对容器进行模式设置（自己选）</span></span><br><span class="line">    <span class="attr">limit:</span>  <span class="comment">#限制容器ck数目 （我没限制）</span></span><br><span class="line">  <span class="comment">#- address: http://192.168.31.233:5525 ##（单容器注释，多容器保留）</span></span><br><span class="line">  <span class="comment">#  username: admin</span></span><br><span class="line">  <span class="comment">#  password: admin</span></span><br><span class="line">  <span class="comment">#- path: /Users/cdle/Desktop/jd_study/jdc/config.sh #本地配置文件路径 v1v2v3v4v5和不知名容器的配置</span></span><br><span class="line">  <span class="comment">#- path: /Users/cdle/Desktop/jd_study/jdc/list.sh</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">https://ghproxy.com/https://raw.githubusercontent.com/cdle/jd_study/main/xdd/theme/noodin.html</span> <span class="comment">#自定义主题，支持本地、网络路径（我喜欢吃面）</span></span><br><span class="line"><span class="attr">static:</span> <span class="string">./static</span> <span class="comment">#静态文件 便于自定义二维码页面时，引入css、js等文件（不用动）</span></span><br><span class="line"><span class="attr">master:</span> <span class="string">jd_xxxxx</span> <span class="comment">#管理员账户pin，有多个用&#x27;&amp;&#x27;拼接</span></span><br><span class="line"><span class="attr">database:</span> <span class="string">/ql/db/xdd.db</span>  <span class="comment">#数据库位置，默认./.jdc.db #（强迫症的我还是给它找了个家，路径按自己的来改）</span></span><br><span class="line"><span class="attr">qywx_key:</span>  <span class="comment">#企业微信推送key（这个就是企业微信机器人的key）</span></span><br><span class="line"><span class="attr">daily_push:</span> <span class="comment">#定时任务（这个我暂时没有配置）</span></span><br><span class="line"><span class="attr">resident:</span> <span class="comment">#均衡模式下所有容器共同的账号pin，有多个用&#x27;&amp;&#x27;拼接。不建议填写，后续实现指定账号助力功能。（这个我也没配置，多容器自己试试）</span></span><br><span class="line"><span class="comment">#自定义ua</span></span><br><span class="line"><span class="attr">user_agent:</span></span><br><span class="line"><span class="attr">telegram_bot_token:</span>  <span class="comment">#telegram bot token（这个应该不用再说了吧）</span></span><br><span class="line"><span class="attr">telegram_user_id:</span>  <span class="comment">#telegrame user id（这个应该不用再说了吧）</span></span><br><span class="line"><span class="attr">qquid:</span>  <span class="comment">#接收通知的qq号（这个填你的群主qq号码，和扫码配置的qq机器人分开，需要2个qq号）</span></span><br><span class="line"><span class="attr">qqgid:</span>  <span class="comment">#监听的群（把你的羊毛群号填上去）</span></span><br><span class="line"><span class="attr">default_priority:</span> <span class="comment">#新用户默认优先级（默认就行，默认是1）</span></span><br><span class="line"><span class="attr">no_ghproxy:</span> <span class="literal">true</span> <span class="comment">#更新资源是否不使用代理 默认false（看你自己的运行环境填）</span></span><br><span class="line"><span class="attr">qbot_public_mode:</span> <span class="literal">true</span>  <span class="comment">#qq机器人群聊模式，默认私聊模式（我用了群测试，所以改了true，默认false）</span></span><br><span class="line"><span class="attr">daily_asset_push_cron:</span> <span class="number">0</span> <span class="number">9</span> <span class="string">*</span> <span class="string">*</span> <span class="string">*</span> <span class="comment">#日常资产推送时间（这个应该也不用再说了吧）</span></span><br></pre></td></tr></table></figure><h1 id="更新版本"><a href="#更新版本" class="headerlink" title="更新版本"></a>更新版本</h1><blockquote><p>由于xdd是需要进行编译的，且作者并未给出编译后的二进制版本，所以暂时不支持容器内更新xdd</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新青龙</span></span><br><span class="line">docker <span class="built_in">exec</span> -it qinglong ql update</span><br></pre></td></tr></table></figure><h1 id="回退版本"><a href="#回退版本" class="headerlink" title="回退版本"></a>回退版本</h1><blockquote><p>有时候部署完毕之后，因为这样那样的原因，导致xdd扫码青龙无法识别，这时候可能需要进行回退</p></blockquote><h2 id="修改docker-compose-yml的镜像tag"><a href="#修改docker-compose-yml的镜像tag" class="headerlink" title="修改docker-compose.yml的镜像tag"></a>修改<code>docker-compose.yml</code>的镜像tag</h2><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210820235049051.png" alt="image-20210820235049051"></p><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br></pre></td></tr></table></figure><h1 id="交流"><a href="#交流" class="headerlink" title="交流"></a>交流</h1><ul><li><a href="https://t.me/jd_wool">TG群</a></li></ul><h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="为什么http-localhost-8080访问不了？"><a href="#为什么http-localhost-8080访问不了？" class="headerlink" title="为什么http://localhost:8080访问不了？"></a>为什么<a href="http://localhost:8080访问不了？">http://localhost:8080访问不了？</a></h2><p>一般是xdd启动失败了，可以通过以下命令检查xdd是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd</span><br><span class="line">docker-compose logs -f</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210821214835916.png" alt="image-20210821214835916"></p><p><code>yaml</code>文件配置错误</p><p><code>yaml</code>是标准的配置文件格式，建议使用专业的编辑器进行修改，例如<code>Notepad++</code>，其他的可能导致编辑后格式错误</p><p>而且配置键值之间，需要有一个空格</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210821215121432.png" alt="image-20210821215121432"></p><h2 id="xdd怎么配置QQ机器人？"><a href="#xdd怎么配置QQ机器人？" class="headerlink" title="xdd怎么配置QQ机器人？"></a>xdd怎么配置QQ机器人？</h2><p>由于配置机器人，需要用到数据库，以及必须以前台模式运行才能进行配置，所以需要进行以下操作</p><h3 id="修改db配置"><a href="#修改db配置" class="headerlink" title="修改db配置"></a>修改db配置</h3><blockquote><p>由于数据存储在sqllite，所以必须修改下db目录，并创建db文件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd/xddconf</span><br><span class="line">vi config.yaml</span><br><span class="line"><span class="comment"># 修改以下配置</span></span><br><span class="line">database: /ql/db/xdd.db</span><br><span class="line"><span class="comment"># 创建xdd.db</span></span><br><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd/db</span><br><span class="line"><span class="built_in">touch</span> xdd.db</span><br></pre></td></tr></table></figure><h3 id="进入容器xdd目录"><a href="#进入容器xdd目录" class="headerlink" title="进入容器xdd目录"></a>进入容器xdd目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/qinglong-xdd</span><br><span class="line">docker <span class="built_in">exec</span> -it qinglong-xdd sh <span class="comment"># 或者bash</span></span><br><span class="line"><span class="comment"># 以下命令在容器内执行</span></span><br><span class="line"><span class="built_in">cd</span> /ql/xdd</span><br></pre></td></tr></table></figure><h3 id="杀掉xdd进程并以前台模式运行"><a href="#杀掉xdd进程并以前台模式运行" class="headerlink" title="杀掉xdd进程并以前台模式运行"></a>杀掉xdd进程并以前台模式运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下命令在容器内执行</span></span><br><span class="line">ps -ajx | grep xdd <span class="comment">## 查看原程序PID</span></span><br><span class="line"><span class="built_in">kill</span> -9 <span class="variable">$&#123;PID&#125;</span></span><br><span class="line"><span class="built_in">cd</span> /ql/xdd</span><br><span class="line">./xdd</span><br></pre></td></tr></table></figure><p>前台启动后，应该会出现初始化数据库，然后QQ机器人二维码，然后扫码即可</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210821213902640.png" alt="image-20210821213902640"></p><p>扫码完成</p><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210821213946662.png" alt="image-20210821213946662"></p><h3 id="以后台模式重启xdd"><a href="#以后台模式重启xdd" class="headerlink" title="以后台模式重启xdd"></a>以后台模式重启xdd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ctrl + C退出</span></span><br><span class="line">./xdd -d</span><br><span class="line"><span class="comment"># 退出容器</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gcdd1993/image-repo/img/image-20210821214358868.png" alt="image-20210821214358868"></p><p>至此，祝贺你，QQ机器人已经配置完毕！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;
  &lt;a href=&quot;#Travis CI&quot;&gt;&lt;img src=&quot;https://www.travis-ci.com/gcdd1993/qinglong-xdd.svg?branch=master&quot; alt=&quot;Build Status&quot;&gt;&lt;/a&gt;
&lt;/p&gt;

&lt;h1 id=&quot;更新日志&quot;&gt;&lt;a href=&quot;#更新日志&quot; class=&quot;headerlink&quot; title=&quot;更新日志&quot;&gt;&lt;/a&gt;更新日志&lt;/h1&gt;&lt;h2 id=&quot;2021-08-28&quot;&gt;&lt;a href=&quot;#2021-08-28&quot; class=&quot;headerlink&quot; title=&quot;2021-08-28&quot;&gt;&lt;/a&gt;2021-08-28&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;适配青龙&lt;code&gt;2.9.x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;不再允许自动升级和手动升级，升级可以通过拉取新镜像&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="京东薅羊毛" scheme="https://blog.gcdd.top/tags/%E4%BA%AC%E4%B8%9C%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>Docker常用命令</title>
    <link href="https://blog.gcdd.top/p/7569/"/>
    <id>https://blog.gcdd.top/p/7569/</id>
    <published>2021-08-13T13:02:38.000Z</published>
    <updated>2023-08-30T04:52:53.897Z</updated>
    
    <content type="html"><![CDATA[<h1 id="操作Container"><a href="#操作Container" class="headerlink" title="操作Container"></a>操作Container</h1><h2 id="启动容器并启动bash（交互方式）"><a href="#启动容器并启动bash（交互方式）" class="headerlink" title="启动容器并启动bash（交互方式）"></a>启动容器并启动bash（交互方式）</h2><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -i -t &lt;image_name/continar_id&gt; /bin/bash</span><br></pre></td></tr></table></figure><h2 id="启动容器以后台方式运行-更通用的方式）"><a href="#启动容器以后台方式运行-更通用的方式）" class="headerlink" title="启动容器以后台方式运行(更通用的方式）"></a>启动容器以后台方式运行(更通用的方式）</h2><blockquote><p>这里的 <code>image_name</code> 包含了<code>tag</code>，例如<code>hello.demo.kdemo:v1.0</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -it  image_name</span><br></pre></td></tr></table></figure><h2 id="附着到正在运行的容器"><a href="#附着到正在运行的容器" class="headerlink" title="附着到正在运行的容器"></a>附着到正在运行的容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach &lt;<span class="built_in">id</span>、container_name&gt;</span><br></pre></td></tr></table></figure><h2 id="进入正在运行的容器内部，同时运行bash-比attach更好用"><a href="#进入正在运行的容器内部，同时运行bash-比attach更好用" class="headerlink" title="进入正在运行的容器内部，同时运行bash(比attach更好用)"></a>进入正在运行的容器内部，同时运行bash(比attach更好用)</h2><blockquote><p>这里的<code>bash</code>也可以换成具体的命令，例如<code>ping 127.0.0.1</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -t -i &lt;<span class="built_in">id</span>/container_name&gt; /bin/bash</span><br></pre></td></tr></table></figure><p><code>docker exec</code>是如此的有用，以至于我们通常是将其封装为一个脚本，放到全局可调用的地方，比如，可以写成一个<code>indocker.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> indocker.sh</span><br><span class="line">docker <span class="built_in">exec</span> -t -i <span class="variable">$1</span> /bin/bash</span><br><span class="line"><span class="comment"># 查看需要附着的容器id</span></span><br><span class="line">$ docker ps | less -S</span><br><span class="line">CONTAINER ID        IMAGE                                                 </span><br><span class="line">9cf7b563f689        hello.demo.kdemo:v160525.202747</span><br><span class="line"></span><br><span class="line">$ ./indocker.sh 9cf7b563f689</span><br></pre></td></tr></table></figure><h2 id="查看容器日志"><a href="#查看容器日志" class="headerlink" title="查看容器日志"></a>查看容器日志</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><h2 id="实时查看日志输出"><a href="#实时查看日志输出" class="headerlink" title="实时查看日志输出"></a>实时查看日志输出</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f &lt;<span class="built_in">id</span>/container_name&gt; </span><br><span class="line"><span class="comment"># 类似 tail -f [-t]带上时间戳</span></span><br></pre></td></tr></table></figure><h2 id="列出当前所有正在运行的container"><a href="#列出当前所有正在运行的container" class="headerlink" title="列出当前所有正在运行的container"></a>列出当前所有正在运行的container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><h2 id="用一行列出所有正在运行的container"><a href="#用一行列出所有正在运行的container" class="headerlink" title="用一行列出所有正在运行的container"></a>用一行列出所有正在运行的container</h2><blockquote><p>容器多的时候非常清晰</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps | less -S</span><br></pre></td></tr></table></figure><h2 id="列出所有的container"><a href="#列出所有的container" class="headerlink" title="列出所有的container"></a>列出所有的container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><h2 id="列出最近一次启动的container"><a href="#列出最近一次启动的container" class="headerlink" title="列出最近一次启动的container"></a>列出最近一次启动的container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -l</span><br></pre></td></tr></table></figure><h2 id="显示一个运行的容器里面的进程信息"><a href="#显示一个运行的容器里面的进程信息" class="headerlink" title="显示一个运行的容器里面的进程信息"></a>显示一个运行的容器里面的进程信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker top &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><h2 id="查看容器内部详情细节"><a href="#查看容器内部详情细节" class="headerlink" title="查看容器内部详情细节"></a>查看容器内部详情细节</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><h2 id="在容器中安装新的程序"><a href="#在容器中安装新的程序" class="headerlink" title="在容器中安装新的程序"></a>在容器中安装新的程序</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run &lt;<span class="built_in">id</span>/container_name&gt; apt-get install -y app_name</span><br></pre></td></tr></table></figure><h2 id="从容器里面拷贝文件-目录到本地一个路径"><a href="#从容器里面拷贝文件-目录到本地一个路径" class="headerlink" title="从容器里面拷贝文件/目录到本地一个路径"></a>从容器里面拷贝文件/目录到本地一个路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> &lt;<span class="built_in">id</span>/container_name&gt;:/container_path to_path</span><br></pre></td></tr></table></figure><h2 id="保存对容器的修改（commit）"><a href="#保存对容器的修改（commit）" class="headerlink" title="保存对容器的修改（commit）"></a>保存对容器的修改（commit）</h2><blockquote><p>当你对某一个容器做了修改之后（通过在容器中运行某一个命令），可以把对容器的修改保存下来，这样下次可以从保存后的最新状态运行该容器</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit &lt;<span class="built_in">id</span>/container_name&gt; new_image_name</span><br></pre></td></tr></table></figure><h2 id="删除单个容器"><a href="#删除单个容器" class="headerlink" title="删除单个容器"></a>删除单个容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><h2 id="删除所有容器"><a href="#删除所有容器" class="headerlink" title="删除所有容器"></a>删除所有容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> `docker ps -a -q`</span><br><span class="line"><span class="comment"># 停止所有的容器</span></span><br><span class="line">docker stop $(docker ps -aq)</span><br><span class="line"><span class="comment"># 删除所有的容器</span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br></pre></td></tr></table></figure><h2 id="停止、启动、杀死、重启一个容器"><a href="#停止、启动、杀死、重启一个容器" class="headerlink" title="停止、启动、杀死、重启一个容器"></a>停止、启动、杀死、重启一个容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stop &lt;<span class="built_in">id</span>/container_name&gt;</span><br><span class="line">docker start &lt;<span class="built_in">id</span>/container_name&gt;</span><br><span class="line">docker <span class="built_in">kill</span> &lt;<span class="built_in">id</span>/container_name&gt;</span><br><span class="line">docker restart &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><h1 id="操作Image"><a href="#操作Image" class="headerlink" title="操作Image"></a>操作Image</h1><h2 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><h2 id="从dockerhub检索image"><a href="#从dockerhub检索image" class="headerlink" title="从dockerhub检索image"></a>从dockerhub检索image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search &lt;image_name&gt;</span><br></pre></td></tr></table></figure><h2 id="下载image"><a href="#下载image" class="headerlink" title="下载image"></a>下载image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull &lt;image_name&gt;</span><br></pre></td></tr></table></figure><h2 id="删除一个或者多个镜像"><a href="#删除一个或者多个镜像" class="headerlink" title="删除一个或者多个镜像"></a>删除一个或者多个镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi &lt;image_name&gt;</span><br></pre></td></tr></table></figure><h2 id="显示一个镜像的历史"><a href="#显示一个镜像的历史" class="headerlink" title="显示一个镜像的历史"></a>显示一个镜像的历史</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> &lt;image_name&gt;</span><br></pre></td></tr></table></figure><h2 id="发布docker镜像"><a href="#发布docker镜像" class="headerlink" title="发布docker镜像"></a>发布docker镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push &lt;new_image_name&gt;</span><br></pre></td></tr></table></figure><p>要发布到私有Registry中的镜像，在镜像命名中需要带上Registry的域名（如果非80端口，同时需要带上端口号）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push dockerhub.yourdomain.com:443/hello.demo.kdemo:v1.0</span><br></pre></td></tr></table></figure><h2 id="拉取docker镜像"><a href="#拉取docker镜像" class="headerlink" title="拉取docker镜像"></a>拉取docker镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull &lt;image_name&gt;</span><br></pre></td></tr></table></figure><h1 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h1><h2 id="查看docker0的网络-宿主机上操作"><a href="#查看docker0的网络-宿主机上操作" class="headerlink" title="查看docker0的网络(宿主机上操作)"></a>查看docker0的网络(宿主机上操作)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a show docker0</span><br></pre></td></tr></table></figure><h2 id="查看容器的IP地址"><a href="#查看容器的IP地址" class="headerlink" title="查看容器的IP地址"></a>查看容器的IP地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;&#x27;</span> &lt;<span class="built_in">id</span>/container_name&gt;</span><br></pre></td></tr></table></figure><p>或者附着到容器内部查看其内部<code>ip</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it &lt;<span class="built_in">id</span>/container_name&gt; ip a show eth0</span><br></pre></td></tr></table></figure><h1 id="docker信息"><a href="#docker信息" class="headerlink" title="docker信息"></a>docker信息</h1><h2 id="查看docker版本"><a href="#查看docker版本" class="headerlink" title="查看docker版本"></a>查看docker版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           20.10.6</span><br><span class="line"> API version:       1.41</span><br><span class="line"> Go version:        go1.13.15</span><br><span class="line"> Git commit:        370c289</span><br><span class="line"> Built:             Fri Apr  9 22:46:01 2021</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Communit</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure><h2 id="查看docker系统的信息"><a href="#查看docker系统的信息" class="headerlink" title="查看docker系统的信息"></a>查看docker系统的信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker info</span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)</span><br><span class="line">  scan: Docker Scan (Docker Inc., v0.7.0)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 83</span><br><span class="line">  Running: 61</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 22</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure><h1 id="高级技巧"><a href="#高级技巧" class="headerlink" title="高级技巧"></a>高级技巧</h1><h2 id="docker-批量删除无用的容器或镜像"><a href="#docker-批量删除无用的容器或镜像" class="headerlink" title="docker 批量删除无用的容器或镜像"></a>docker 批量删除无用的容器或镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除异常停止的docker容器</span></span><br><span class="line">docker <span class="built_in">rm</span> `docker ps -a | grep Exited | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"><span class="comment"># 删除名称或标签为none的镜像</span></span><br><span class="line">docker rmi -f  `docker images | grep <span class="string">&#x27;&lt;none&gt;&#x27;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>`</span><br></pre></td></tr></table></figure><h2 id="清理所有停止运行的容器"><a href="#清理所有停止运行的容器" class="headerlink" title="清理所有停止运行的容器"></a>清理所有停止运行的容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container prune </span><br><span class="line"><span class="comment"># 或者 </span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br></pre></td></tr></table></figure><h2 id="清理所有悬挂（）镜像"><a href="#清理所有悬挂（）镜像" class="headerlink" title="清理所有悬挂（）镜像"></a>清理所有悬挂（<none>）镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker image prune</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">docker rmi $(docker images -qf <span class="string">&quot;dangling=true&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="清理所有无用数据卷"><a href="#清理所有无用数据卷" class="headerlink" title="清理所有无用数据卷"></a>清理所有无用数据卷</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume prune</span><br></pre></td></tr></table></figure><h2 id="清理所有无用镜像"><a href="#清理所有无用镜像" class="headerlink" title="清理所有无用镜像"></a>清理所有无用镜像</h2><blockquote><p>清理后再次使用需要重新下载</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune -a</span><br></pre></td></tr></table></figure><h2 id="按需批量清理容器"><a href="#按需批量清理容器" class="headerlink" title="按需批量清理容器"></a>按需批量清理容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a --filter <span class="string">&#x27;exited=0&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="目前支持的过滤器（–filter）有"><a href="#目前支持的过滤器（–filter）有" class="headerlink" title="目前支持的过滤器（–filter）有"></a>目前支持的过滤器（–filter）有</h2><ul><li>id (container’s id)</li><li>label (label=<key> or label=<key>=<value>)</li><li>name (container’s name)</li><li>exited (int - the code of exited containers. Only useful with –all)</li><li>status (created|restarting|running|removing|paused|exited|dead)</li><li>ancestor (<image-name>[:<tag>], <image id> or &lt;image@digest&gt;) - filters containers that were created from the given image or a descendant.</li><li>before (container’s id or name) - filters containers created before given id or name</li><li>since (container’s id or name) - filters containers created since given id or name</li><li>isolation (default|process|hyperv) (Windows daemon only)</li><li>volume (volume name or mount point) - filters containers that mount volumes.</li><li>network (network id or name) - filters containers connected to the provided network</li><li>health (starting|healthy|unhealthy|none) - filters containers based on healthcheck status</li></ul><h2 id="按需批量清理镜像"><a href="#按需批量清理镜像" class="headerlink" title="按需批量清理镜像"></a>按需批量清理镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 列出所有悬挂（dangling）的镜像，也就是显示为&lt;none&gt;的那些</span></span><br><span class="line">docker images --filter <span class="string">&quot;dangling=true&quot;</span></span><br><span class="line"> <span class="comment"># 清理所有悬挂（dangling）的镜像，也就是显示为&lt;none&gt;的那些</span></span><br><span class="line">docker rmi $(docker images -qf <span class="string">&quot;dangling=true&quot;</span>)</span><br><span class="line"> <span class="comment"># 清理，同上</span></span><br><span class="line">docker image prune --filter <span class="string">&#x27;exited=0&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="目前支持的过滤器（–filter）有-1"><a href="#目前支持的过滤器（–filter）有-1" class="headerlink" title="目前支持的过滤器（–filter）有"></a>目前支持的过滤器（–filter）有</h2><ul><li>dangling (boolean - true or false)</li><li>label (label=<key> or label=<key>=<value>)</li><li>before (<image-name>[:<tag>], <image id> or &lt;image@digest&gt;) - filter images created before given id or references</li><li>since (<image-name>[:<tag>], <image id> or &lt;image@digest&gt;) - filter images created since given id or references</li><li>reference (pattern of an image reference) - filter images whose reference matches the specified pattern</li></ul><h2 id="查看docker日志"><a href="#查看docker日志" class="headerlink" title="查看docker日志"></a>查看docker日志</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f `docker ps | grep qq- | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;操作Container&quot;&gt;&lt;a href=&quot;#操作Container&quot; class=&quot;headerlink&quot; title=&quot;操作Container&quot;&gt;&lt;/a&gt;操作Container&lt;/h1&gt;&lt;h2 id=&quot;启动容器并启动bash（交互方式）&quot;&gt;&lt;a href=&quot;#启动容器并启动bash（交互方式）&quot; class=&quot;headerlink&quot; title=&quot;启动容器并启动bash（交互方式）&quot;&gt;&lt;/a&gt;启动容器并启动bash（交互方式）&lt;/h2&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="docker" scheme="https://blog.gcdd.top/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>一键HTTPS并开启自动更新</title>
    <link href="https://blog.gcdd.top/p/29831/"/>
    <id>https://blog.gcdd.top/p/29831/</id>
    <published>2021-08-12T07:52:53.000Z</published>
    <updated>2023-08-30T04:52:53.907Z</updated>
    
    <content type="html"><![CDATA[<p>本文使用<code>Let&#39;s Encrypt</code>的免费<code>HTTPS</code>证书，并搭配自动续约脚本，达到<code>https</code>一劳永逸的效果。基本上部署一次，之后就再也不需要维护了，异常方便。</p><span id="more"></span><h1 id="方案简介"><a href="#方案简介" class="headerlink" title="方案简介"></a>方案简介</h1><h2 id="Let’s-Encrypt和CertBot"><a href="#Let’s-Encrypt和CertBot" class="headerlink" title="Let’s Encrypt和CertBot"></a>Let’s Encrypt和CertBot</h2><blockquote><p>我们申请和使用<code>Let&#39;s Encrypt</code>的免费<code>HTTPS</code>证书, 就需要一个证书申请和管理的工具, 然后<code>certbot</code>是官方推荐的申请工具, 我们使用这个工具申请和管理我们的证书</p></blockquote><blockquote><p><code>certbot</code>支持大部分的<code>Linux</code>发行版</p></blockquote><p>上面也提到，现在阿里云不售卖免费证书了，但是如果我们（实际上是公司）想白嫖怎么办呢？就得用到<code>Let&#39;s Encrypt</code>了。</p><p>下面我就分享下如何一键部署<code>CertBot</code>并开启自动续期。</p><h1 id="方案实施"><a href="#方案实施" class="headerlink" title="方案实施"></a>方案实施</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li><code>Docker</code>以及<code>Docker Compose</code>环境</li><li>域名<code>DNS</code>已经指向待部署的服务器，因为脚本校验证书所属权，需要访问域名</li></ul><p>废话少说，这就开始！</p><h2 id="克隆仓库"><a href="#克隆仓库" class="headerlink" title="克隆仓库"></a>克隆仓库</h2><blockquote><p>💡 提示：这一步必不可少，一定要按照仓库目录结构来执行，完成后，可以自行更改 <code>nginx/conf.d</code> 下的配置文件。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /data</span><br><span class="line">$ <span class="built_in">cd</span> /data</span><br><span class="line">$ git <span class="built_in">clone</span> https://ghproxy.com/https://github.com/gcdd1993/nginx-certbot</span><br><span class="line">$ <span class="built_in">cd</span> nginx-certbot</span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jun  8 22:01 ./</span><br><span class="line">drwxr-xr-x 5 root root 4096 Jun  8 21:49 ../</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jun  8 21:53 data/</span><br><span class="line">-rw-r--r-- 1 root root  660 Jun  8 21:49 docker-compose.yml</span><br><span class="line">drwxr-xr-x 8 root root 4096 Jun  8 21:49 .git/</span><br><span class="line">-rw-r--r-- 1 root root   14 Jun  8 21:49 .gitignore</span><br><span class="line">-rwxr-xr-x 1 root root 2286 Jun  8 22:01 init-letsencrypt.sh*</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jun  8 21:49 LICENSE</span><br><span class="line">-rw-r--r-- 1 root root 1376 Jun  8 21:49 README.md</span><br></pre></td></tr></table></figure><h2 id="修改邮箱"><a href="#修改邮箱" class="headerlink" title="修改邮箱"></a>修改邮箱</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim init-letsencrypt.sh</span><br><span class="line">...</span><br><span class="line">email=<span class="string">&quot;gcwm99@gmail.com&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="修改操作域名"><a href="#修改操作域名" class="headerlink" title="修改操作域名"></a>修改操作域名</h2><blockquote><p>修改<code>your_domain</code>为你的域名（只能是单域名，不能是泛域名）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/example.org/your_domain/g&#x27;</span> data/nginx/app.conf \</span><br><span class="line">&amp;&amp; sed -i <span class="string">&#x27;s/example.org/your_domain/g&#x27;</span> init-letsencrypt.sh</span><br></pre></td></tr></table></figure><h2 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h2><blockquote><p>出现以下内容，说明已经成功！</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./init-letsencrypt.sh</span><br><span class="line">...</span><br><span class="line">Requesting a certificate <span class="keyword">for</span> your_domain</span><br><span class="line"></span><br><span class="line">Successfully received certificate.</span><br><span class="line">Certificate is saved at: /etc/letsencrypt/live/your_domain/fullchain.pem</span><br><span class="line">Key is saved at:         /etc/letsencrypt/live/your_domain/privkey.pem</span><br><span class="line">This certificate expires on 2021-09-06.</span><br><span class="line">These files will be updated when the certificate renews.</span><br><span class="line"></span><br><span class="line">NEXT STEPS:</span><br><span class="line">- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate <span class="keyword">in</span> the background, but you may need to take steps to <span class="built_in">enable</span> that functionality. See https://certbot.org/renewal-setup <span class="keyword">for</span> instructions.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">If you like Certbot, please consider supporting our work by:</span><br><span class="line">* Donating to ISRG / Let<span class="string">&#x27;s Encrypt:   https://letsencrypt.org/donate</span></span><br><span class="line"><span class="string">* Donating to EFF:                    https://eff.org/donate-le</span></span><br><span class="line"><span class="string">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></span><br></pre></td></tr></table></figure><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><blockquote><p>将配置更改为你自己网站的配置，下面给一个示例配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mv</span> app.conf app.conf.bak <span class="comment"># 注释默认配置</span></span><br><span class="line">$ <span class="built_in">cd</span> /data/nginx-cert/data/nginx</span><br><span class="line">$ vim nginx-example.conf <span class="comment"># 编写自己的配置</span></span><br><span class="line">upstream my.site &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name your_domain;</span><br><span class="line"></span><br><span class="line">    proxy_read_timeout 600s;</span><br><span class="line">    proxy_send_timeout 600s;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        add_header X-Frame-Options deny;</span><br><span class="line">        proxy_pass http://my.site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下内容保持不变即可，只需要修改your_domain为你的域名</span></span><br><span class="line">    listen 443 ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/your_domain/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/your_domain/privkey.pem;</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;</span><br><span class="line"></span><br><span class="line">    server_tokens off;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 以下内容保持不变即可，只需要修改your_domain为你的域名</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$host</span> = your_domain) &#123;</span><br><span class="line">        <span class="built_in">return</span> 301 https://$host<span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    location /.well-known/acme-challenge/ &#123;</span><br><span class="line">        root /var/www/certbot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server_name your_domain;</span><br><span class="line">    listen 80;</span><br><span class="line">    <span class="built_in">return</span> 404; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note warning flat"><p>其中的<code>location /.well-known/acme-challenge/</code>很重要，千万不要漏了，否则在进行证书续期的时候，是无法通过网站所属验证的。</p></div><h2 id="重启Nginx服务"><a href="#重启Nginx服务" class="headerlink" title="重启Nginx服务"></a>重启Nginx服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/nginx-certbot</span><br><span class="line">$ docker-compose restart</span><br></pre></td></tr></table></figure><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="多域名操作"><a href="#多域名操作" class="headerlink" title="多域名操作"></a>多域名操作</h2><blockquote><p>步骤同上，先修改域名为待操作域名，然后执行 <code>init-letsencrypt.sh</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/your_domain/your_domain2/g&#x27;</span> data/nginx/app.conf \</span><br><span class="line">&amp;&amp; sed -i <span class="string">&#x27;s/your_domain/your_domain2/g&#x27;</span> init-letsencrypt.sh</span><br><span class="line">$ ./init-letsencrypt.sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="更新证书"><a href="#更新证书" class="headerlink" title="更新证书"></a>更新证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it nginx-certbot_certbot_1 certbot renew</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">The following certificates are not due <span class="keyword">for</span> renewal yet:</span><br><span class="line">  /etc/letsencrypt/live/my.site/fullchain.pem expires on 2021-09-06 (skipped)</span><br><span class="line">No renewals were attempted. <span class="comment"># 还未到更新时间，证明证书还是有效的</span></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br></pre></td></tr></table></figure><h2 id="修改更新间隔"><a href="#修改更新间隔" class="headerlink" title="修改更新间隔"></a>修改更新间隔</h2><blockquote><p>修改<code>docker-compose.yml</code>里面的间隔即可。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/nginx-certbot</span><br><span class="line">$ vim docker-compose.yml</span><br><span class="line">entrypoint: <span class="string">&quot;/bin/sh -c &#x27;trap exit TERM; while :; do certbot renew; sleep 12h &amp; wait $<span class="variable">$&#123;!&#125;</span>; done;&#x27;&quot;</span> <span class="comment"># 修改12h为你喜欢的值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改完毕，重启</span></span><br><span class="line">$ docker-compose restart</span><br></pre></td></tr></table></figure><p>好了，还不快试试？</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文使用&lt;code&gt;Let&amp;#39;s Encrypt&lt;/code&gt;的免费&lt;code&gt;HTTPS&lt;/code&gt;证书，并搭配自动续约脚本，达到&lt;code&gt;https&lt;/code&gt;一劳永逸的效果。基本上部署一次，之后就再也不需要维护了，异常方便。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="HTTPS" scheme="https://blog.gcdd.top/tags/HTTPS/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu一键部署Docker</title>
    <link href="https://blog.gcdd.top/p/46199/"/>
    <id>https://blog.gcdd.top/p/46199/</id>
    <published>2021-08-12T07:39:27.000Z</published>
    <updated>2023-08-30T04:52:53.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><h2 id="Docker官网方式"><a href="#Docker官网方式" class="headerlink" title="Docker官网方式"></a>Docker官网方式</h2><blockquote><p>有时候国内镜像同步不及时，可能会安装失败，此时只能通过官网来进行安装</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null &amp;&amp; sudo apt-get update &amp;&amp; sudo apt-get -y install docker-ce docker-ce-cli containerd.io &amp;&amp; sudo docker --version</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="国内方式"><a href="#国内方式" class="headerlink" title="国内方式"></a>国内方式</h2><blockquote><p>国内的网络环境众所周知，所以推荐使用镜像站进行安装</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common &amp;&amp; curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - &amp;&amp; sudo apt-key fingerprint 0EBFCD88 &amp;&amp; sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> &amp;&amp; sudo apt-get update &amp;&amp; sudo apt-get -y install docker-ce docker-ce-cli containerd.io &amp;&amp; sudo docker --version</span><br></pre></td></tr></table></figure><h2 id="安装校验"><a href="#安装校验" class="headerlink" title="安装校验"></a>安装校验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@iZbp12adskpuoxodbkqzjfZ:$ docker version</span><br><span class="line">Client:</span><br><span class="line">Version: 17.03.0-ce</span><br><span class="line">API version: 1.26</span><br><span class="line">Go version: go1.7.5</span><br><span class="line">Git commit: 3a232c8</span><br><span class="line">Built: Tue Feb 28 07:52:04 2017</span><br><span class="line">OS/Arch: linux/amd64</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">Version: 17.03.0-ce</span><br><span class="line">API version: 1.26 (minimum version 1.12)</span><br><span class="line">Go version: go1.7.5</span><br><span class="line">Git commit: 3a232c8</span><br><span class="line">Built: Tue Feb 28 07:52:04 2017</span><br><span class="line">OS/Arch: linux/amd64</span><br><span class="line">Experimental: <span class="literal">false</span></span><br></pre></td></tr></table></figure><h1 id="Docker-compose安装"><a href="#Docker-compose安装" class="headerlink" title="Docker-compose安装"></a>Docker-compose安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 自行修改version为最新版本的docker-compose</span></span><br><span class="line">sudo curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose &amp;&amp; sudo <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose &amp;&amp; docker-compose --version</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://docs.docker.com/engine/install/ubuntu/">Install Docker Engine on Ubuntu</a></li><li><a href="https://developer.aliyun.com/article/110806">Docker CE 镜像源站</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;安装Docker&quot;&gt;&lt;a href=&quot;#安装Docker&quot; class=&quot;headerlink&quot; title=&quot;安装Docker&quot;&gt;&lt;/a&gt;安装Docker&lt;/h1&gt;&lt;h2 id=&quot;Docker官网方式&quot;&gt;&lt;a href=&quot;#Docker官网方式&quot; class=&quot;headerlink&quot; title=&quot;Docker官网方式&quot;&gt;&lt;/a&gt;Docker官网方式&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;有时候国内镜像同步不及时，可能会安装失败，此时只能通过官网来进行安装&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get update &amp;amp;&amp;amp; sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common &amp;amp;&amp;amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu &lt;span class=&quot;subst&quot;&gt;$(lsb_release -cs)&lt;/span&gt; stable&amp;quot;&lt;/span&gt; | sudo &lt;span class=&quot;built_in&quot;&gt;tee&lt;/span&gt; /etc/apt/sources.list.d/docker.list &amp;gt; /dev/null &amp;amp;&amp;amp; sudo apt-get update &amp;amp;&amp;amp; sudo apt-get -y install docker-ce docker-ce-cli containerd.io &amp;amp;&amp;amp; sudo docker --version&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Docker" scheme="https://blog.gcdd.top/tags/Docker/"/>
    
    <category term="Ubuntu" scheme="https://blog.gcdd.top/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>【京东薅羊毛】一键部署青龙面板+ninja扫码登录</title>
    <link href="https://blog.gcdd.top/p/56460/"/>
    <id>https://blog.gcdd.top/p/56460/</id>
    <published>2021-08-06T12:36:18.000Z</published>
    <updated>2023-08-30T04:52:53.893Z</updated>
    
    <content type="html"><![CDATA[<p>  <a href="#Travis CI"><img src="https://www.travis-ci.com/gcdd1993/qinglong-ninja.svg?branch=main" alt="Build Status"></a></p><p>最近很流行京东挂机赚京豆，也看到很多人无法自行完成服务器端的配置！特别是青龙升级到<code>2.8</code>之后，更是难以使用。所以，特地提供青龙+<code>ninja</code>一键部署的<code>Docker</code>镜像。</p><span id="more"></span><p><a href="https://blog.gcdd.top/p/35018/">一键部署青龙 + xdd请移步这里</a></p><p>如果想搭建但是还没有购买服务器的，可以点我的链接进行购买，<a href="https://www.aliyun.com/minisite/goods?userCode=ijsckn04&share_source=copy_link">阿里云轻量级服务器 2核2G 99/年</a>，不仅你可以获得优惠券，我也可以获得邀请人数。购买完成可以添加我的qq 1398371419，备注“青龙”，我将会全程指导你安装，如果实在不会，我也可以代为搭建。</p><h1 id="一键部署Docker"><a href="#一键部署Docker" class="headerlink" title="一键部署Docker"></a>一键部署Docker</h1><blockquote><p>基于<code>Ubuntu</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common &amp;&amp; curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - &amp;&amp; sudo apt-key fingerprint 0EBFCD88 &amp;&amp; sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> &amp;&amp; sudo apt-get update &amp;&amp; sudo apt-get -y install docker-ce docker-ce-cli containerd.io &amp;&amp; sudo docker --version</span><br><span class="line"><span class="comment"># 修改/etc/docker/daemon.json，很重要，限制docker使用的磁盘资源</span></span><br><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/data/docker&quot;</span>, // 之前如果有启动过的容器，或者拉取的镜像，修改这个值，将会时效</span><br><span class="line">    <span class="string">&quot;log-driver&quot;</span>:<span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;max-size&quot;</span>:<span class="string">&quot;10m&quot;</span>,</span><br><span class="line">        <span class="string">&quot;max-file&quot;</span>:<span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;labels&quot;</span>:<span class="string">&quot;production_status&quot;</span>,</span><br><span class="line">        <span class="string">&quot;env&quot;</span>:<span class="string">&quot;os,customer&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>:[</span><br><span class="line">        <span class="string">&quot;registryhost:5000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;10.0.0.0/8&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>:[</span><br><span class="line">        <span class="string">&quot;https://mubkcb81.mirror.aliyuncs.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置docker开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p>再装上<code>docker-compose</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L <span class="string">&quot;https://github.91chifun.workers.dev/https://github.com//docker/compose/releases/download/1.29.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose &amp;&amp; sudo <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose &amp;&amp; docker-compose --version</span><br></pre></td></tr></table></figure><h1 id="一键部署青龙-ninja"><a href="#一键部署青龙-ninja" class="headerlink" title="一键部署青龙+ninja"></a>一键部署青龙+ninja</h1><blockquote><p>这一步也很简单，直接使用<code>docker-compose</code>部署即可</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/qinglong-ninja</span><br><span class="line"><span class="built_in">cd</span> /data/qinglong-ninja</span><br><span class="line">wget https://ghproxy.com/https://raw.githubusercontent.com/gcdd1993/qinglong-ninja/main/docker/docker-compose.yml</span><br><span class="line"><span class="comment"># 这里可以自行修改docker-compose.yml，但是注意，不要mount ninja的目录，不然会导致ninja启动失败</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>等待启动完成</p><h2 id="打开青龙"><a href="#打开青龙" class="headerlink" title="打开青龙"></a>打开青龙</h2><blockquote><p><a href="http://localhost:5700/">http://localhost:5700</a></p></blockquote><p><img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/image-20210806204359586.png" alt="image-20210806204359586"></p><h2 id="打开ninja"><a href="#打开ninja" class="headerlink" title="打开ninja"></a>打开ninja</h2><blockquote><p><a href="http://localhost:5701/">http://localhost:5701</a></p></blockquote><p><img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/image-20210806204416555.png" alt="image-20210806204416555"></p><h1 id="多说一句"><a href="#多说一句" class="headerlink" title="多说一句"></a>多说一句</h1><p>自从<code>lxk0306</code>跑路之后，我个人也维护了一份京东脚本，感兴趣的可以拉取我的镜像，助力码填的是我自己的，可以自行更改。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ql repo https://github.com/gcdd1993/jd_scripts <span class="string">&quot;jd_|jx_|getJDCookie&quot;</span> <span class="string">&quot;activity|backUp&quot;</span> <span class="string">&quot;^jd[^_]|USER&quot;</span></span><br></pre></td></tr></table></figure><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><ul><li><p><a href="https://github.com/whyour/qinglong">青龙面板</a></p></li><li><p><a href="https://github.com/MoonBegonia/ninja">ninja京东扫码登录</a></p></li><li><p><a href="https://hub.docker.com/repository/docker/gcdd1993/qinglong-ninja">Docker Hub</a></p></li><li><p><a href="https://github.com/gcdd1993/left1">个人维护京东脚本</a></p></li></ul><p>好了，到这结束了，有问题欢迎留言，知无不言。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;
  &lt;a href=&quot;#Travis CI&quot;&gt;&lt;img src=&quot;https://www.travis-ci.com/gcdd1993/qinglong-ninja.svg?branch=main&quot; alt=&quot;Build Status&quot;&gt;&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;最近很流行京东挂机赚京豆，也看到很多人无法自行完成服务器端的配置！特别是青龙升级到&lt;code&gt;2.8&lt;/code&gt;之后，更是难以使用。所以，特地提供青龙+&lt;code&gt;ninja&lt;/code&gt;一键部署的&lt;code&gt;Docker&lt;/code&gt;镜像。&lt;/p&gt;</summary>
    
    
    
    <category term="一起薅羊毛" scheme="https://blog.gcdd.top/categories/%E4%B8%80%E8%B5%B7%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
    
    <category term="京东薅羊毛" scheme="https://blog.gcdd.top/tags/%E4%BA%AC%E4%B8%9C%E8%96%85%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>在数字时代谈数字隐私</title>
    <link href="https://blog.gcdd.top/p/39168/"/>
    <id>https://blog.gcdd.top/p/39168/</id>
    <published>2021-07-01T02:29:02.000Z</published>
    <updated>2023-08-30T04:52:53.909Z</updated>
    
    <content type="html"><![CDATA[<p>在数字时代，如何保护个人隐私？这篇文章或许能帮到你。</p><blockquote><p>此文系转载</p></blockquote><span id="more"></span><h1 id="Manual"><a href="#Manual" class="headerlink" title="Manual"></a>Manual</h1><blockquote><p>世界上有两种密码:一种是防止你的小妹妹偷看你的文件;另一种是防止当局阅读你的文件.</p></blockquote><ul><li>Bruce Schneier《应用密码学》</li></ul><p align="center">    <a href="https://en.wikipedia.org/wiki/Wojciech_Kossak"><img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/readme.jpg"></a></p><ul><li><strong>项目起因 :</strong> 为了保护自己的隐私,慢慢的开始学习与收集各种手段方法、网站、工具,我把这种行为称作数字洁癖.这些手段方法藏着掖着也不能当传家宝,那干脆就分享出来造福大众.</li><li><strong>涉及内容 :</strong> 个人敏感信息查询,保护措施,开源信息收集(OSINT)对抗</li><li><strong>事件集合 :</strong> 还不清楚严重性？进来了解近年来的数据泄露、供应链污染事件:<a href="https://github.com/ffffffff0x/Dork-Admin">Dork-Admin</a></li><li><strong>项目地址 :</strong> <a href="https://github.com/ffffffff0x/Digital-Privacy">https://github.com/ffffffff0x/Digital-Privacy</a></li></ul><hr><h1 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h1><ol><li><code>本项目所有内容,仅供学习和研究使用,请勿使用项目的技术手段用于非法用途,任何人造成的任何负面影响,与本人无关.</code></li><li><code>本文档所有内容、新闻皆不代表本人态度、立场,如果有建议或方案,欢迎提交 issues</code></li><li><code>未收及不会收取任何广告费用,推荐的所有工具链接与本人无任何利害关系</code></li></ol><p><strong>Tips</strong></p><ol><li>对于各类平台尽量使用不同昵称、头像.</li><li>多平台不要使用统一、相似的密码,请建立一套自己的密码管理方式,推荐使用密码管理器.对于密码管理器本身的安全性,可以参考这个报告 <a href="https://www.securityevaluators.com/casestudies/password-manager-hacking/">https://www.securityevaluators.com/casestudies/password-manager-hacking/</a></li><li>管住自己的炫耀欲.</li><li>不要相信哪个公司不作恶、重视隐私.(感觉和2有冲突啊 XD)</li><li>尽量少用部分浏览器 “记住密码” 的功能, 针对浏览器的取证工具不少, 很容易就可以提取出 Cookie、浏览记录、保存的密码等。</li><li>不要以为开虚拟机、挂 vpn 就很安全,webRTC 泄露 IP,浏览器指纹,通过 DNS 判断(参考网飞),系统时间,浏览器 0day,等等等等.</li><li>定时清空你的邮件、短信、通话记录、回收站.</li><li>所以不要干坏事、不要干坏事、不要干坏事。</li></ol><hr><h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><ul><li><p><strong><a href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF">敏感信息</a></strong></p><ul><li><a href="#%E9%9A%90%E7%A7%81%E6%9F%A5%E8%AF%A2">隐私查询</a></li><li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8C%87%E7%BA%B9">浏览器指纹</a></li><li><a href="#%E5%AF%86%E7%A0%81%E6%B3%84%E9%9C%B2%E6%9F%A5%E8%AF%A2">密码泄露查询</a></li><li><a href="#dns%E4%BF%A1%E6%81%AF">DNS信息</a></li><li><a href="#%E5%AE%9A%E4%BD%8D">定位</a></li></ul></li><li><p><strong><a href="#%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD">保护措施</a></strong></p><ul><li><a href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">操作系统</a></li><li><a href="#%E8%BD%AF%E4%BB%B6-%E8%84%9A%E6%9C%AC">软件-脚本</a></li><li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%A9%E5%B1%95">浏览器扩展</a></li><li><a href="#%E5%AE%89%E5%85%A8%E5%88%A0%E9%99%A4">安全删除</a></li><li><a href="#%E5%8A%A0%E5%AF%86">加密</a></li><li><a href="#flash">flash</a></li><li><a href="#%E8%BC%B8%E5%85%A5%E6%B3%95">輸入法</a></li><li><a href="#%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E">搜索引擎</a></li><li><a href="#%E8%BA%AB%E4%BB%BD%E7%94%9F%E6%88%90">身份生成</a></li><li><a href="#%E9%82%AE%E7%AE%B1-%E4%BF%A1%E6%81%AF">邮箱-信息</a><ul><li><a href="#%E6%9F%A5%E9%82%AE%E7%AE%B1%E5%AD%98%E6%B4%BB">查邮箱存活</a></li><li><a href="#%E7%9F%AD%E4%BF%A1%E6%8E%A5%E7%A0%81">短信接码</a></li><li><a href="#%E4%B8%B4%E6%97%B6%E9%82%AE%E7%AE%B1">临时邮箱</a></li><li><a href="#%E5%8C%BF%E5%90%8D%E9%82%AE%E7%AE%B1">匿名邮箱</a></li></ul></li><li><a href="#%E5%B9%B3%E5%8F%B0%E7%AE%A1%E6%8E%A7%E8%AE%BE%E7%BD%AE">平台管控设置</a></li></ul></li><li><p><strong><a href="#osint">OSINT</a></strong></p><ul><li><a href="#%E8%AE%BE%E5%A4%87-%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B">设备-语音助手</a></li><li><a href="#%E5%B9%B3%E5%8F%B0-%E8%BD%AF%E4%BB%B6">平台-软件</a></li><li><a href="#%E7%A4%BE%E4%BA%A4%E7%BD%91%E7%BB%9C">社交网络</a></li><li><a href="#%E5%90%84%E7%B1%BB%E6%90%9C%E7%B4%A2">各类搜索</a><ul><li><a href="#%E5%B8%B8%E7%94%A8%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E">常用搜索引擎</a></li><li><a href="#%E7%BD%91%E9%A1%B5%E5%BF%AB%E7%85%A7">网页快照</a></li><li><a href="#%E5%9B%BE%E7%89%87%E5%8F%8D%E5%90%91%E6%90%9C%E7%B4%A2">图片反向搜索</a><ul><li><a href="#acg%E5%9B%BE%E7%89%87%E5%8F%8D%E5%90%91%E6%90%9C%E7%B4%A2">acg图片反向搜索</a></li></ul></li><li><a href="#%E8%88%AA%E7%8F%AD/%E9%A3%9E%E6%9C%BA%E4%BF%A1%E6%81%AF">航班/飞机信息</a></li><li><a href="#%E8%88%B9%E8%88%B6%E4%BF%A1%E6%81%AF">船舶信息</a></li><li><a href="#%E8%B4%A7%E8%BD%A6%E4%BD%8D%E7%BD%AE">货车位置</a></li><li><a href="#%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF">物流信息</a></li><li><a href="#%E8%BD%A6%E8%BE%86%E4%BF%A1%E6%81%AF">车辆信息</a><ul><li><a href="#vin%E7%A0%81">VIN码</a></li></ul></li><li><a href="#%E4%B8%AA%E4%BA%BA%E5%8F%AF%E4%BF%A1%E5%BA%A6">个人可信度</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E6%B5%8B%E7%BB%98">网络空间测绘</a></li><li><a href="#tor%E4%BF%A1%E6%81%AF">tor信息</a></li><li><a href="#%E5%AD%A6%E6%9C%AF%E4%BF%A1%E6%81%AF">学术信息</a></li><li><a href="#%E4%B8%93%E5%88%A9-%E5%95%86%E6%A0%87">专利-商标</a></li><li><a href="#%E6%8A%A5%E5%88%8A%E4%BF%A1%E6%81%AF">报刊信息</a></li><li><a href="#%E5%BC%80%E6%94%BE%E6%95%B0%E6%8D%AE%E9%9B%86">开放数据集</a></li><li><a href="#bgp%E4%BF%A1%E6%81%AF">BGP信息</a></li><li><a href="#%E7%94%B5%E5%AD%90%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3">电子硬件相关</a></li><li><a href="#%E7%A4%BE%E4%BA%A4-%E4%BA%BA%E9%99%85%E5%85%B3%E7%B3%BB">社交-人际关系</a></li><li><a href="#%E4%BC%81%E4%B8%9A%E4%BF%A1%E6%81%AF">企业信息</a></li><li><a href="#%E5%8D%9A%E5%AE%A2%E6%90%9C%E7%B4%A2">博客搜索</a></li></ul></li><li><a href="#%E6%96%87%E4%BB%B6%E8%B5%84%E6%BA%90">文件资源</a><ul><li><a href="#pdf">PDF</a></li><li><a href="#%E9%9F%B3%E4%B9%90">音乐</a></li></ul></li><li><a href="#%E5%A4%A9%E6%B0%94-%E7%8E%AF%E5%A2%83">天气-环境</a></li><li><a href="#%E5%9C%B0%E5%9B%BE">地图</a><ul><li><a href="#%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA">数据展示</a></li><li><a href="#%E7%BD%91%E7%BB%9C%E5%A8%81%E8%83%81">网络威胁</a></li></ul></li></ul></li></ul><hr><h1 id="敏感信息"><a href="#敏感信息" class="headerlink" title="敏感信息"></a>敏感信息</h1><h2 id="隐私查询"><a href="#隐私查询" class="headerlink" title="隐私查询"></a>隐私查询</h2><ul><li><p><strong>从邮箱查询</strong></p><ul><li><a href="https://www.reg007.com/">你注册过哪些网站？一搜便知</a></li><li><a href="https://hunter.io/">Find email addresses in seconds • Hunter (Email Hunter)</a> - email 信息查询工具</li></ul></li><li><p><strong>从用户名查询</strong></p><ul><li><a href="https://instantusername.com/#/">Instant Username Search</a> - 实时搜索100多个社交媒体网站的用户名。</li><li><a href="https://checkusernames.com/">CheckUsernames</a> - 测某账号是否在全球500多个社交媒体中是否有注册。</li><li><a href="https://whatsmyname.app/">WhatsMyName Web</a> - 搜索许多网站上存在的用户名。</li><li><a href="https://namecheckup.com/">NameCheckup</a> - 查找可用的用户名</li><li><a href="https://knowem.com/">Namechk</a></li><li><a href="https://namechk.com/">KnowEm Username Search</a></li><li><a href="https://github.com/sherlock-project/sherlock">sherlock-project/sherlock</a> - 在不同的社交网络上通过用户名搜寻账户</li></ul></li><li><p><strong>从IP查询</strong></p><ul><li><a href="http://iknowwhatyoudownload.com/">Torrent downloads and distributions for IP</a> - 查你这个IP下载过哪些磁力链接🔗 (太缺德了😂)</li></ul></li><li><p><strong>混合查询</strong></p><ul><li><a href="https://usersearch.org/">Username Search</a> - 找到用户名、电子邮件地址或电话号码背后的人。</li><li><a href="https://github.com/n0tr00t/Sreg">n0tr00t/Sreg</a> - 使用者通过输入 email、phone、username 的返回用户注册的所有互联网信息.</li></ul></li></ul><hr><h2 id="浏览器指纹"><a href="#浏览器指纹" class="headerlink" title="浏览器指纹"></a>浏览器指纹</h2><ul><li><p><a href="https://amiunique.org/fp">Am I unique?</a> - 显示了你的操作系统、浏览器、浏览器版本以及你的时区和语言。</p></li><li><p><a href="http://uniquemachine.org/">Unique Machine</a> - 这是一个浏览器指纹技术的项目，它不仅可以在一个浏览器内跟踪用户，还可以在同一台机器上的不同浏览器间跟踪用户。</p></li><li><p><a href="https://panopticlick.eff.org/">Panopticlick</a> - 分析你的浏览器和附加组件对在线追踪技术的保护程度。</p></li><li><p><a href="https://webbrowsertools.com/canvas-fingerprint/">Detect Canvas Fingerprint</a> - 这个页面使用不同的技术来识别是否安装了浏览器扩展来欺骗 canvas 指纹结果。</p></li><li><p><a href="https://webbrowsertools.com/useragent/">What is my User Agent</a> - 检测网站服务器和客户端代码在访问网站时看到的用户代理字符串。</p></li><li><p><a href="https://sploit.io/">Sploit.io</a> - 这个网页可以测试你在浏览网页的时候到底会暴露出哪些信息出去；从漏洞，到地理位置，到浏览器指纹，用没用代理等等。</p></li><li><p><a href="https://supercookie.me/">Supercookie</a> - 这个网站可以通过浏览器访问过的图标来识别用户指纹。</p></li><li><p><strong>相关文章</strong></p><ul><li><a href="https://wzyboy.im/post/1130.html">浏览器指纹</a></li><li><a href="https://www.freebuf.com/articles/web/139984.html">2.5代指纹追踪技术—跨浏览器指纹识别</a></li><li><a href="http://www.arkteam.net/?p=4147">浏览器指纹真的有效吗？</a></li><li><a href="https://www.solidot.org/story?sid=61446">浏览器的隐身模式有多隐身？</a></li><li><a href="http://lucb1e.com/rp/cookielesscookies/">Cookieless cookies</a> - 一种不使用 cookies 甚至是 Javascript 的方式来追踪用户。网站解释了它是如何工作的，以及如何保护自己。</li></ul></li><li><p><strong>webRTC</strong></p><ul><li><a href="https://www.freebuf.com/articles/web/166754.html"> 你的VPN泄漏IP了吗:仍有20%的VPN服务商未解决WebRTC漏洞问题 </a></li></ul></li><li><p><strong>leak HTTP</strong></p><ul><li><a href="https://github.com/cure53/HTTPLeaks">cure53/HTTPLeaks</a> - 对于网页泄漏 HTTP 请求的方法总结</li></ul></li></ul><p><strong>案例</strong></p><ul><li><a href="https://mtlynch.io/stripe-recording-its-customers/">Stripe is Silently Recording Your Movements On its Customers’ Websites</a> - Stripe 在客户网站上隐秘记录用户访问 URL 和鼠标光标移动等信息</li></ul><hr><h2 id="密码泄露查询"><a href="#密码泄露查询" class="headerlink" title="密码泄露查询"></a>密码泄露查询</h2><ul><li><a href="https://dehashed.com/">DeHashed</a> - 可通过用户名、邮箱、地址等搜索是否在该网站收集的一百多亿条信息内。</li><li><a href="https://haveibeenpwned.com/">Have I Been Pwned</a> - 通过查询用于注册的邮箱，发现是否有相关密码被盗。</li><li><a href="https://pwdquery.xyz/">pwd query</a> - 检查你的密码是否已经从数据泄露中泄露了……</li><li><a href="https://monitor.firefox.com/">Firefox Monitor</a> - 可通过邮箱搜索看看你是否已经成为了网络数据泄露的一部分。</li><li><a href="https://vigilante.pw/">Vigilante.pw</a> - 搜索数据泄露事件,数据库列表</li><li><a href="https://aleph.occrp.org/">OCCRP Aleph</a> - 可通过搜索名字、账号、邮箱等查询相关泄露信息情况。</li><li><a href="https://snusbase.com/">Snusbase</a> - 搜索电子邮件，名称和用户名，IP地址，电话，哈希或密码，检测自己的信息是否已泄露。</li><li><strong>泄露密码库</strong><ul><li><a href="https://cloud.mail.ru/public/2eHX/38Ek7Lmfx?tdsourcetag=s_pctim_aiomsg">https://cloud.mail.ru/public/2eHX/38Ek7Lmfx?tdsourcetag=s_pctim_aiomsg</a></li><li><a href="https://downloads.skullsecurity.org/passwords/">https://downloads.skullsecurity.org/passwords/</a></li></ul></li></ul><hr><h2 id="DNS信息"><a href="#DNS信息" class="headerlink" title="DNS信息"></a>DNS信息</h2><ul><li><a href="https://dnsleaktest.com/">DNS leak test</a> - 检测 DNS 泄露的网站</li><li><a href="http://www.whatsmydnsserver.com/">What’s My DNS Server?</a> - 该网站通过观察你的 DNS 请求在互联网上的处理方式，主动确定你的计算机使用的 DNS 服务器。</li></ul><hr><h2 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h2><p><strong>案例</strong></p><ul><li><a href="https://www.freebuf.com/articles/database/185954.html">看我如何通过邮箱获取IP定位</a></li><li><a href="https://www.freebuf.com/articles/web/137952.html">利用Wireshark任意获取QQ好友IP实施精准定位</a></li><li><a href="https://mp.weixin.qq.com/s/K-zFVBaSw6yThuoLdUTjdg">跨国定位手机の奥义</a></li><li><a href="https://www.washingtonpost.com/business/technology/for-sale-systems-that-can-secretly-track-where-cellphone-users-go-around-the-globe/2014/08/24/f0700e8a-f003-11e3-bf76-447a5df6411f_story.html">For sale: Systems that can secretly track where cellphone users go around the globe - The Washington Post</a> - 利用 SS7 信令漏洞跟踪全球手机用户的系统</li><li><a href="https://www.bellingcat.com/resources/2020/12/03/using-the-sun-and-the-shadows-for-geolocation/">Using the Sun and the Shadows for Geolocation</a> - 通过阳光和阴影进行定位</li></ul><p><strong>GPS 定位</strong></p><ul><li><a href="http://mygeoposition.com/">MyGeoPosition.com</a> - 免费地理编译,地理译码 / 地理元数据标记 (Geo-Metatag) / 地理标记(Geotag) / KML 文件!</li><li><a href="https://ip.rtbasia.com/">RTBAsia ODX</a> - Open Data Exchange</li><li><a href="http://api.map.baidu.com/lbsapi/getpoint/index.html">拾取坐标系统</a></li><li><a href="https://www.opengps.cn/">openGPS.cn</a> - 传统 IP 定位</li><li><a href="http://map.yanue.net/">经纬度在线查询</a></li><li><a href="https://www.bigdatacloud.com/geocoding-apis/free-reverse-geocode-to-city-api">免费的客户端反向地理编码</a></li></ul><p><strong>基站定位</strong></p><ul><li><a href="http://www.minigps.net/cellsearch.html">minigps</a> - 基站定位查询</li></ul><p><strong>手机号码查询</strong></p><ul><li><a href="http://www.ip138.com:8080/search.asp">138查</a> - 手机归属地查询</li><li><a href="http://shouji.ip38.com/">手机号码定位</a></li><li><a href="https://www.spokeo.com/reverse-phone-lookup">Reverse Phone Lookup | Phone Number Search - Spokeo</a> - 将姓名和身份与未知电话号码进行匹配</li><li><a href="https://www.carrierlookup.com/">CarrierLookup</a> - 反查电话</li></ul><p><strong>IP 信息</strong></p><ul><li><a href="https://stat.ripe.net/">RIPEstat</a> - Internet Measurements and Analysis</li><li><a href="https://ip.voidsec.com/">IP Info</a> - IP 信息</li><li><a href="https://ipleak.net/">What is your IP, what is your DNS</a> - IP/DNS Detect</li><li><a href="https://ip8.com/">ip8</a> - IP Lookup Tool</li><li><a href="https://whoer.net/zh">查看自己的IP地址</a></li><li><a href="https://iplist.cc/">IPList</a></li><li><a href="http://plotip.com/ip">Plot IP</a> - IP Addresses</li><li><a href="https://db-ip.com/">DB-IP</a> - IP Geolocation API and databases</li><li><a href="https://www.bigdatacloud.com/">BigDataCloud</a> - Essential IP Geolocation APIs</li><li><a href="https://www.ipip.net/">IPIP.NET</a> - IP 地址库</li><li><a href="http://www.123cha.com/">IP查询</a></li><li><a href="http://www.hao7188.com/">ip查询</a></li><li><a href="http://ipwhois.cnnic.net.cn/">Whois</a></li><li><a href="http://ipblock.chacuo.net/">查错网</a> - 国家 IP 段查询、全球国家 IP 段</li><li><a href="http://www.ipplus360.com/">ipplus360.com</a> - 全球 IP 地址定位平台</li><li><a href="https://www.opengps.cn/Data/IP/LocHighAcc.aspx">openGPS.cn</a> - 高精度 IP 定位</li><li><a href="http://ip38.com/">IP地址查询</a></li><li><a href="https://haoip.cn/">多数据源IP地址查询</a></li><li><a href="https://eyep.dev/">Get your IPv4 and IPv6 address instantly</a></li><li><a href="https://webbrowsertools.com/ip-address/">What is my IP Address</a></li><li><a href="https://ifconfig.me/">What Is My IP Address?</a></li><li><a href="https://ipapi.co/">ipapi</a> - IP Address Location</li><li><a href="https://ipinfo.io/">IPinfo.io</a> - IP Address API and Data Solutions</li></ul><p><strong>IPv6 信息</strong></p><ul><li><a href="http://ip.zxinc.org/ipquery/">IPv6地址查询工具</a></li><li><a href="https://dnschecker.org/ipv6-whois-lookup.php">Locate IPv6 Address Online</a> - IPv6 Whois Lookup</li><li><a href="https://findipv6.com/find/">findIPv6</a> - Lookup and locate an IPv6 address</li></ul><p><strong>邮箱</strong></p><ul><li><a href="https://www.spokeo.com/email-search">Email Search | Reverse Email Lookup - Spokeo</a> - 查询任何电子邮件以查看谁拥有它</li></ul><hr><h1 id="保护措施"><a href="#保护措施" class="headerlink" title="保护措施"></a>保护措施</h1><p><strong>文章</strong></p><ul><li><a href="https://wiki.fuckoffgoogle.de/index.php?title=GoogleAlternatives">GoogleAlternatives - FuckOffGoogle</a> -  - 谷歌工具替代品清单</li><li><a href="https://nomoregoogle.com/">No More Google</a> - 谷歌工具替代品清单</li><li><a href="https://steemit.com/life/@iyouport/7nfymr">安全手册:这里是你需要的几乎所有安全上网工具;以及为什么建议不要使用以美国为基地的网络服务</a></li><li><a href="https://privacytools.twngo.xyz/">隱私工具 - 加密安全對抗全球大規模監控</a></li><li><a href="https://securitycheckli.st/">Security Checklist</a></li><li><a href="https://www.bestvpn.com/guides/the-ultimate-privacy-guide/#avoidus">终极在线隐私指南</a></li><li><a href="https://evilcos.me/yinsi.html">隐私大爆炸,你得学几招保护自己</a></li><li><a href="https://www.iyouport.org/%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93%E6%9C%89%E4%BA%BA%E6%AD%A3%E5%9C%A8%E7%BA%BF%E4%BA%BA%E8%82%89%E4%BD%A0%EF%BC%9F6%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%B9%E6%B3%95/">如何知道有人正在线人肉你？6个简单的方法</a></li></ul><h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ul><li><a href="https://tails.boum.org/about/index.en.html">Tails</a></li><li><a href="https://www.qubes-os.org/">Qubes OS</a></li><li><a href="https://www.whonix.org/">Whonix</a></li></ul><hr><h2 id="软件-脚本"><a href="#软件-脚本" class="headerlink" title="软件-脚本"></a>软件-脚本</h2><ul><li><p><strong>浏览器</strong></p><ul><li><a href="https://github.com/Eloston/ungoogled-chromium">Eloston/ungoogled-chromium</a></li></ul></li><li><p><strong>通讯</strong></p><ul><li><a href="https://telegram.org/">telegram</a></li></ul></li><li><p><strong>网络审计</strong></p><ul><li><a href="https://www.winprivacy.de/english-home/">W10Privacy</a></li><li><a href="https://github.com/abcnews/data-life">abcnews/data-life</a></li></ul></li><li><p><strong>匿名</strong></p><ul><li><a href="https://www.torproject.org/">tor</a></li><li><a href="https://github.com/i2p/i2p.i2p">i2p/i2p.i2p</a></li></ul></li></ul><hr><h2 id="浏览器扩展"><a href="#浏览器扩展" class="headerlink" title="浏览器扩展"></a>浏览器扩展</h2><ul><li><p><strong>chrome</strong></p><ul><li><a href="https://chrome.google.com/webstore/detail/decentraleyes/ldpochfccmkkmhdbclfhpagapcfdljkj">Decentraleyes</a></li><li><a href="https://chrome.google.com/webstore/detail/cookie-autodelete/fhcgjolkccmbidfldomjliifgaodjagh">Cookie AutoDelete</a></li><li><a href="https://chrome.google.com/webstore/detail/lastpass-free-password-ma/hdokiejnpimakedhajhdlcegeplioahd">LastPass Password Manager</a></li><li><a href="https://chrome.google.com/webstore/detail/privacy-badger/pkehgijcmpdhfbdbbnkijodmdjhbjlgp">Privacy Badger</a></li><li><a href="https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg">User-Agent Switcher for Chrome</a></li><li><a href="https://chrome.google.com/webstore/detail/https-everywhere/gcbommkclmclpchllfjekcdonpmejbdp">HTTPS Everywhere</a></li><li><a href="https://chrome.google.com/webstore/detail/noscript/doojmbjmlfjjnbmnoijecmcbfeoakpjm">NoScript</a></li><li><a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm">uBlock Origin</a></li></ul></li><li><p><strong>firefox🦊</strong></p><ul><li><a href="https://addons.mozilla.org/en-US/firefox/addon/decentraleyes/">Decentraleyes</a></li><li><a href="https://addons.mozilla.org/en-US/firefox/addon/cookie-autodelete/">Cookie AutoDelete</a></li><li><a href="https://addons.mozilla.org/en-US/firefox/addon/lastpass-password-manager/?src=search">LastPass Password Manager</a></li><li><a href="https://addons.mozilla.org/en-US/firefox/addon/privacy-badger17/?src=search">Privacy Badger</a></li><li><a href="https://addons.mozilla.org/zh-CN/firefox/addon/user-agent-string-switcher/?src=search">User-Agent Switcher and Manager</a></li><li><a href="https://addons.mozilla.org/zh-CN/firefox/addon/https-everywhere/?src=search">HTTPS Everywhere</a></li><li><a href="https://addons.mozilla.org/zh-CN/firefox/addon/noscript/?src=search">NoScript</a></li><li><a href="https://addons.mozilla.org/zh-CN/firefox/addon/ublock-origin/?src=search">uBlock Origin</a></li></ul></li><li><p><strong>stylish</strong></p><ul><li><a href="https://robertheaton.com/2018/07/02/stylish-browser-extension-steals-your-internet-history/">“Stylish” browser extension steals all your internet history</a></li><li><a href="https://www.ghacks.net/2017/05/16/stylus-is-a-stylish-fork-without-analytics/">Stylus is a Stylish fork without analytics</a></li></ul></li></ul><h2 id="安全删除"><a href="#安全删除" class="headerlink" title="安全删除"></a>安全删除</h2><ul><li><a href="https://ssd.eff.org/en/module/how-delete-your-data-securely-windows">如何:在Windows上安全地删除数据</a></li></ul><hr><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><ul><li><a href="https://www.veracrypt.fr/en/Home.html">VeraCrypt</a></li><li><a href="https://bbs.kafan.cn/thread-2115703-1-1.html">VHD虚拟磁盘+BitLocker加密</a></li></ul><hr><h2 id="flash"><a href="#flash" class="headerlink" title="flash"></a>flash</h2><p><code>最好的选择就是远离flash</code></p><ul><li><a href="https://bbs.kafan.cn/thread-2123485-1-1.html">支持到32_0_0_223_Adobe{过}{滤}FlashPlayer去区域限制</a></li></ul><hr><h2 id="輸入法"><a href="#輸入法" class="headerlink" title="輸入法"></a>輸入法</h2><ul><li><a href="https://github.com/rime">RIME</a></li></ul><hr><p>某狗输入法参考文章 <a href="https://bbs.kafan.cn/thread-2169610-1-1.html">SougouCloud.exe 浅析</a></p><hr><h2 id="搜索引擎"><a href="#搜索引擎" class="headerlink" title="搜索引擎"></a>搜索引擎</h2><p><code>以下是在隐私保护方面较为优秀的搜索引擎,但其搜索质量不敢保证</code></p><ul><li><a href="https://start.duckduckgo.com/">DuckDuckGo</a></li><li><a href="https://searx.me/">searx.me</a></li><li><a href="https://www.startpage.com/">StartPage Web Search</a></li></ul><hr><h2 id="身份生成"><a href="#身份生成" class="headerlink" title="身份生成"></a>身份生成</h2><ul><li><a href="https://www.fakenamegenerator.com/">Generate a Random Name</a> - 随机身份生成</li><li><a href="https://www.fakeaddressgenerator.com/Index/index">Fake Address, Random Address Generator</a> - 随机身份生成</li><li><a href="https://www.behindthename.com/random/">Behind the Name</a> - Random Name Generator</li><li><a href="https://randomwordgenerator.com/name.php">Easy Random Name Picker</a> - Random Name Generator</li><li><a href="https://www.elfqrin.com/fakeid.php">ElfQrin</a> - Fake Identity ID Random Name Generator</li><li><a href="https://randomuser.me/">Random User Generator</a></li><li><a href="http://jbjb.zouri.jp/">在线身份证号码生成器</a></li><li><a href="http://jsrun.net/square?page=1&s=%E8%BA%AB%E4%BB%BD%E8%AF%81%E5%8F%B7">中国大陆内地姓名、身份证号、银行卡号生成器</a></li><li><a href="https://id.ifreesite.com/">在线身份证号码生成器</a></li><li><a href="https://github.com/airob0t/idcardgenerator">airob0t/idcardgenerator 身份证图片生成工具</a></li><li><a href="https://github.com/gh0stkey/RGPerson">gh0stkey/RGPerson</a> - 随机身份生成脚本</li><li><a href="https://github.com/naozibuhao/idcard">naozibuhao/idcard</a> - 身份证生成器</li><li><a href="https://backgroundchecks.org/justdeleteme/fake-identity-generator/">Just Delete Me</a> - 假身份生成器(这个网站的图标,好像在哪里看过🤔)</li><li><a href="https://fakepersongenerator.com/">Fake Person/Name Generator | User Identity, Account and Profile Generator</a></li><li><a href="https://cdn.rawgit.com/Marak/faker.js/master/examples/browser/index.html">faker.js</a></li><li><a href="https://www.fakepersongenerator.com/Index/generate">Fake Person/Name Generator</a></li><li><a href="https://names.igopaygo.com/people/full-contact">Full Contact Information Generator</a></li></ul><p><strong>图片生成</strong></p><ul><li><a href="https://thispersondoesnotexist.com/">伪造人像</a></li><li><a href="https://artbreeder.com/browse">Artbreeder</a></li><li><a href="https://comixify.ii.pw.edu.pl/">Comixify</a></li><li><a href="https://www.thiswaifudoesnotexist.net/?ref=appinn">This Waifu Does Not Exist - Gwern</a></li><li><a href="https://thiscatdoesnotexist.com/">虚拟猫咪</a></li><li><a href="http://www.whichfaceisreal.com/">Which Face is Real?</a></li><li><a href="https://nvlabs.github.io/SPADE/">SPADE Project Page</a></li><li><a href="https://selfie2anime.com/">Selfie2Anime</a></li><li><a href="https://reflect.tech/faceswap/hot">Reflect.tech</a></li><li><a href="https://generated.photos/faces">Gallery of AI Generated Faces | Generated.photos</a></li><li><a href="https://pixel-me.tokyo/en">ピクセルミー | ドット絵ジェネレーター</a></li></ul><hr><h2 id="照片信息"><a href="#照片信息" class="headerlink" title="照片信息"></a>照片信息</h2><p><strong>EXIF信息</strong></p><ul><li><a href="https://exif.tuchong.com/">EXIF信息查看器</a></li><li><a href="https://exifshot.com/app/">ExifShot App</a></li><li><a href="https://www.appinn.com/how-to-add-exif-date-for-old-picture/">如何为老照片添加 Exif 日期数据？ - 小众软件</a></li></ul><p><strong>相关文章</strong></p><ul><li><a href="https://nixintel.info/osint/the-secret-life-of-jpegs/">The Secret Life Of JPEGs – NixIntel</a></li></ul><hr><h2 id="邮箱-信息"><a href="#邮箱-信息" class="headerlink" title="邮箱-信息"></a>邮箱-信息</h2><h3 id="查邮箱存活"><a href="#查邮箱存活" class="headerlink" title="查邮箱存活"></a>查邮箱存活</h3><ul><li><a href="http://tool.chacuo.net/mailverify">Email地址检查、检测Email地址真实性、检测电子邮件地址真实性–查错网</a></li><li><a href="https://verify-email.org/">Verify Email Address Online - Free Email Verifier - Free Email Address Verification</a></li><li><a href="http://www.emailcamel.com/">免费在线批量验证邮箱有效性 - EmailCamel.com</a></li><li><a href="https://www.verifyemailaddress.org/">Email Verifier - Verify Email Address For Free With Our Verifier Tool</a></li></ul><h3 id="短信接码"><a href="#短信接码" class="headerlink" title="短信接码"></a>短信接码</h3><p><code>注:此类平台来的快,去的快,慎用</code></p><blockquote><p>以下部分内容来自 <sup>[<a href="https://www.heji.ltd/28.html#">国内外短信接码平台合集 | 合集网</a>]</sup><sup></p></blockquote><p><strong>国外免费接码平台</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http://sms.sellaite.com</span><br><span class="line">https://ch.freephonenum.com</span><br><span class="line">https://zh.mytrashmobile.com</span><br><span class="line">https://www.receive-sms-online.info</span><br><span class="line">https://sms-online.co/receive-free-sms</span><br><span class="line">https://receive-sms.com</span><br><span class="line">http://receivefreesms.com/</span><br><span class="line">https://www.receivesmsonline.net/</span><br><span class="line">https://www.freeonlinephone.org/</span><br><span class="line">https://us-phone-number.com</span><br><span class="line">https://temporary-phone-number.com</span><br><span class="line">https://www.receivesms.co/</span><br><span class="line">https://pingme.tel/receive-sms-online-cn/</span><br><span class="line">http://receivefreesms.net/</span><br><span class="line">http://receivesmsonline.in/</span><br><span class="line">https://sms-receive.net/</span><br><span class="line">https://www.receivesms.net/</span><br><span class="line">https://www.textnow.com/</span><br><span class="line">http://receive-sms-now.com/</span><br><span class="line">http://receive-sms-online.com/</span><br><span class="line">https://www.afreesms.com/freesms/</span><br><span class="line">https://textfree.us/#/login</span><br><span class="line">http://receivesmsverification.com/</span><br><span class="line">http://freereceivesmsonline.com/</span><br></pre></td></tr></table></figure><p><strong>国内免费接码平台</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">https://www.bfkdim.com/</span><br><span class="line">https://www.yinsiduanxin.com/</span><br><span class="line">https://www.materialtools.com/</span><br><span class="line">http://www.114sim.com/</span><br><span class="line">http://zg.114sim.com/</span><br><span class="line">http://z-sms.com/</span><br><span class="line">https://www.zusms.com/</span><br><span class="line">https://yunjiema.net/</span><br><span class="line">http://jiema.tech/</span><br><span class="line">https://mianfeijiema.com/</span><br><span class="line">http://www.xnsms.com/</span><br><span class="line">https://xinghai.party/</span><br><span class="line">https://jiemahao.com/</span><br><span class="line">https://www.lothelper.com/cn</span><br><span class="line">http://www.zsrq.net/</span><br><span class="line">http://www.kakasms.com/</span><br><span class="line">https://www.suiyongsuiqi.com/zh/</span><br><span class="line">http://www.z-sms.com/</span><br><span class="line">https://yunduanxin.net/</span><br></pre></td></tr></table></figure><p><strong>国外收费接码平台</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">https://sms-activate.ru/cn/ 1$起充，有中文页面</span><br><span class="line">https://5sim.net</span><br><span class="line">http://smspva.com</span><br><span class="line">http://give-sms.com 俄罗斯接码平台</span><br><span class="line">https://onlinesim.ru/zh 就俄罗斯的码便宜，每个码最少1卢布</span><br><span class="line">https://www.smsjiema.com/ 美国实体卡号码，可以注册GV</span><br><span class="line">https://www.textverified.com/ 2刀起充，接码也挺贵的</span><br><span class="line">https://autofications.com/ 不算贵也不算便宜，最低$0.5一个码</span><br><span class="line">https://service.pvaverify.com/ 美国实体卡</span><br><span class="line">https://getsms.online/ 俄罗斯接码平台</span><br></pre></td></tr></table></figure><p><strong>国内收费接码平台</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JieMa.Tech：https://f4.work</span><br><span class="line">随用随弃：https://www.suiyongsuiqi.com</span><br></pre></td></tr></table></figure><h3 id="临时邮箱"><a href="#临时邮箱" class="headerlink" title="临时邮箱"></a>临时邮箱</h3><p><code>注:此类平台来的快,去的快,慎用</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http://www.yopmail.com/zh/</span><br><span class="line">https://10minutemail.com/</span><br><span class="line">https://10minutemail.net/</span><br><span class="line">https://www.guerrillamail.com/zh/inbox</span><br><span class="line">http://www.fakemailgenerator.com/#/dayrep.com/Firly1970/</span><br><span class="line">https://temp-mail.org/en/</span><br><span class="line">https://www.guerrillamail.com/</span><br><span class="line">http://tool.chacuo.net/mailsend</span><br><span class="line">https://maildrop.cc/</span><br><span class="line">http://tool.chacuo.net/mailanonymous</span><br><span class="line">https://tempmail.altmails.com/</span><br><span class="line">https://www.snapmail.cc/</span><br><span class="line">https://www.linshi-email.com/</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="匿名邮箱"><a href="#匿名邮箱" class="headerlink" title="匿名邮箱"></a>匿名邮箱</h3><ul><li><a href="https://mail.protonmail.com/inbox">ProtonMail</a></li><li><a href="https://www.fastmail.com/">Get secure, reliable email hosting – FastMail</a></li><li><a href="https://github.com/xyfir/ptorx">xyfir/ptorx</a></li><li><a href="https://tutanota.com/">Tutanota</a></li></ul><hr><h2 id="平台管控设置"><a href="#平台管控设置" class="headerlink" title="平台管控设置"></a>平台管控设置</h2><ul><li><p><strong>baidu</strong></p><ul><li><a href="https://passport.baidu.com/accountbind?tpl=">应用授权</a></li></ul></li><li><p><strong>Facebook</strong></p><ul><li><a href="https://www.facebook.com/settings?tab=applications">应用授权</a></li></ul></li><li><p><strong>github</strong></p><ul><li><a href="https://github.com/settings/applications">应用授权</a></li></ul></li><li><p><strong>google</strong></p><ul><li><a href="https://adssettings.google.com/authenticated">广告个性化/谷歌眼中的你</a></li><li><a href="https://myactivity.google.com/myactivity">活动记录</a></li><li><a href="https://myaccount.google.com/activitycontrols?pli=1">活动控件</a></li><li><a href="https://myaccount.google.com/device-activity">最近使用过的设备</a></li><li><a href="https://myaccount.google.com/permissions">应用授权</a></li><li>扩展阅读<ul><li><a href="https://free.com.tw/google-automatically-delete-data/">自動刪除你的 Google 網路和應用程式活動紀錄設定教學</a></li></ul></li></ul></li><li><p><strong>Microsoft</strong></p><ul><li><a href="https://account.microsoft.com/privacy/activity-history">产品和服务的隐私设置,以及查看和清除 Microsoft 保存到云的数据的位置</a></li><li><a href="https://account.live.com/consent/Manage">应用授权</a></li></ul></li><li><p><strong>twitter</strong></p><ul><li>应用授权 <a href="https://twitter.com/settings/sessions">旧版</a> <a href="https://twitter.com/settings/applications">新版</a></li><li><a href="https://twitter.com/settings/your_twitter_data/ads">興趣和廣告資料</a></li><li><a href="https://twitter.com/settings/security">密碼重設保護</a></li></ul></li><li><p><strong>tencent</strong></p><ul><li><a href="https://privacy.qq.com/advertisement.htm">广告个性化</a></li><li><a href="https://connect.qq.com/manage.html#/appauth/user">应用授权</a></li><li>微信应用授权 [设置 - 隐私 - 授权管理]</li></ul></li></ul><hr><h1 id="OSINT"><a href="#OSINT" class="headerlink" title="OSINT"></a>OSINT</h1><blockquote><p>OSINT(Open-source intelligence) 指开源情报,一项从媒体、网络、博客、视频，等公开来源中进行信息收集、提取的技术。</p></blockquote><p><strong>相关的网站与资源</strong></p><ul><li><a href="http://dingba.top/">丁爸网</a></li><li>微信公众号 情报小蜜蜂 little_bee007</li><li><a href="https://www.iyouport.org/category/osint/">iYouPort OSINT专栏</a></li><li><a href="https://github.com/sinwindie/OSINT">sinwindie/OSINT</a> - 各种平台的 OSINT “一张图” 系列</li><li><a href="https://github.com/blaCCkHatHacEEkr/OSINT_TIPS">blaCCkHatHacEEkr/OSINT_TIPS</a> - OSINT 技巧合集</li><li><a href="https://inteltechniques.com/podcast.html">The Privacy, Security, &amp; OSINT Show</a> - 讲述、介绍各类 OSINT 技能的博客</li><li><a href="https://osintframework.com/">OSINT Framework</a> - 非常著名的 OSINT 框架,有着非常丰富的 OSINT 资源</li></ul><p><strong>案例</strong></p><ul><li><a href="https://nixintel.info/osint/using-flight-tracking-for-geolocation-quiztime-30th-october-2019/">Using Flight Tracking For Geolocation – Quiztime 30th October 2019 – NixIntel</a> - 通过一张照片中的飞机轨迹寻找到目标地址的案例</li><li><a href="https://www.cjr.org/tow_center_reports/guide-to-osint-and-hostile-communities.php">A Guide to Open Source Intelligence (OSINT) - Columbia Journalism Review</a> - 一份 OSINT 指南,汇总了很多案例</li><li><a href="https://www.icscybersecurityconference.com/intelligence-gathering-on-u-s-critical-infrastructure/">Intelligence Gathering on U.S. Critical Infrastructure - Industrial Control Systems (ICS) Cyber Security Conference</a> - 一篇对于美国工控领域设备的 OSINT 分析文章</li><li><a href="https://www.bellingcat.com/resources/how-tos/2019/10/15/a-beginners-guide-to-flight-tracking/">bellingcat - A Beginner’s Guide To Flight Tracking - bellingcat</a> - 一篇关于追踪飞机的文章</li><li><a href="https://www.iyouport.org/%e5%a6%82%e6%9e%9c%e5%8f%aa%e7%9f%a5%e9%81%93%e4%b8%80%e4%b8%aa%e7%94%b5%e8%af%9d%e5%8f%b7%e7%a0%81%ef%bc%8c%e4%bd%a0%e8%83%bd%e6%8c%96%e5%87%ba%e5%a4%9a%e5%b0%91%e6%9c%89%e6%95%88%e4%bf%a1%e6%81%af/">如果只知道一个电话号码，你能挖出多少有效信息？</a></li><li><a href="https://medium.com/@bearhunt38/geoprivacy-and-news-media-bc83b53dd818">GeoPrivacy and news media. Earlier this week I read a news article…</a> - 查询新闻中鬼屋的真实位置</li><li><a href="https://medium.com/@benjamindbrown/finding-mcafee-a-case-study-on-geoprofiling-and-imagery-analysis-6f16bbd5c219">Finding McAfee: A Case Study on Geoprofiling and Imagery Analysis</a> - 通过一张图片分析McAfee的位置</li><li><a href="https://medium.com/analytics-vidhya/tracking-ships-and-visualize-them-in-qgis-35c074810937">Tracking ships and visualize them in QGIS</a> - 使用QGIS可视化跟踪目标船只</li><li><a href="https://www.secjuice.com/geolocation-osint-amateur-hour/">OSINT Amateur Hour</a> - 调查照片位置的案例</li><li><a href="https://mp.weixin.qq.com/s/8J5gXf-h0V6eVHRMReW6rw">一张快递单到底能泄露多少个人信息</a></li><li><a href="https://mp.weixin.qq.com/s/XvMruURNVWBkEwxvnPSW1g">已知邮箱，求手机号码?</a></li><li><a href="https://mp.weixin.qq.com/s/D3oNR1HW8B23VqXhoNpE6Q">【图片挖掘】国外图片挖掘案例（附过程及工具）</a></li><li><a href="https://research.checkpoint.com/2020/vandathegod/">Bringing VandaTheGod down to Earth: Exposing the person behind a 7-year hacktivism campaign</a> - checkpoint 社工 VandaTheGod 的案例</li><li><a href="https://medium.com/digital-marketing-lab/subtle-information-hackers-find-in-the-background-of-your-social-media-photos-938ec1876246">Subtle Information Hackers Find in the Background of Your Social Media Photos</a> - 常见的通过图片泄露敏感信息的案例</li><li><a href="https://osintcurio.us/2020/03/17/corporate-reconnaissance/">Corporate Reconnaissance</a> - 介绍如何挖掘一家企业的相关信息</li><li><a href="https://www.iyouport.org/%E5%AF%BB%E6%89%BE%E6%97%B6%E9%97%B4%E7%9A%84%E8%B8%AA%E8%BF%B9%EF%BC%9A%E4%BE%A6%E6%8E%A2%E6%8C%91%E6%88%98%E6%B8%B8%E6%88%8F/">寻找时间的踪迹：侦探挑战游戏</a></li><li><a href="https://www.iyouport.org/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E3%80%81%E6%8C%96%E6%8E%98%E3%80%81%E5%88%86%E6%9E%90%E5%90%84%E7%A7%8D%E6%9D%A5%E6%BA%90%E7%9A%84%E8%B0%83%E6%9F%A5%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%8C%87-4/">如何获取、挖掘、分析各种来源的调查数据完整指南：解码秘密（4）- 确保真实和确保道德的技巧</a></li></ul><p><strong>OSINT 情报工具</strong></p><ul><li><a href="https://intelx.io/tools">https://intelx.io/tools</a> - 在线使用的开源情报和取证工具清单</li><li><a href="https://recontool.org/#mindmap">OSINT Recon Tool</a> - 在线的 osint 工具集合，加上思维脑图</li><li><a href="https://github.com/woj-ciech/SocialPath">woj-ciech/SocialPath</a> - 跟踪社交媒体平台上的用户</li><li><a href="https://github.com/Greenwolf/social_mapper">Greenwolf/social_mapper</a> - 通过面部识别跟踪不同社交平台目标的工具</li><li><a href="https://github.com/bhavsec/reconspider">bhavsec/reconspider</a> - 可用于扫描IP地址，电子邮件，网站，组织的 OSINT 工具</li><li><a href="https://www.spiderfoot.net/">SpiderFoot</a></li></ul><h2 id="设备-语音助手"><a href="#设备-语音助手" class="headerlink" title="设备-语音助手"></a>设备-语音助手</h2><ul><li><p><strong>Alexa</strong></p><ul><li><a href="https://cn.engadget.com/2019/07/04/amazon-keeps-alexa-transcripts/">除非手动删除,不然 Alexa 上的语音资料会被亚马逊一直保留</a></li><li><a href="https://www.thepaper.cn/newsDetail_forward_3290014">隔屏有耳调查｜亚马逊智能音箱有千人监听团队,曾听到性侵案</a></li><li><a href="https://www.solidot.org/story?sid=61594">亚马逊提供 Alexa 录音的非人工审听选项</a></li></ul></li><li><p><strong>Cortana</strong></p><ul><li><a href="https://tech.sina.com.cn/i/2019-08-08/doc-ihytcitm7662431.shtml">继苹果谷歌后:微软被曝监听用户Skype和Cortana录音</a></li><li><a href="https://www.vice.com/en_us/article/xweqbq/microsoft-contractors-listen-to-skype-calls">Revealed: Microsoft Contractors Are Listening to Some Skype Calls</a></li><li><a href="https://www.cnbeta.com/articles/tech/879681.htm">微软被指使用廉价合同工完成Cortana语音收听工作</a></li><li><a href="http://hackernews.cc/archives/26954">微软:暂不会停止对 Skype 和 Cortana 对话的人工审查</a></li></ul></li><li><p><strong>Google Home</strong></p><ul><li><a href="https://www.ithome.com/0/433/712.htm">谷歌承认通过语音助手收集用户谈话内容:仅用于开发</a></li><li><a href="https://thehill.com/policy/technology/452620-google-admits-workers-listen-to-some-smart-device-recordings">Google admits workers listen to some smart device recordings</a></li></ul></li><li><p><strong>HP printers</strong></p><ul><li><a href="https://tech.ifeng.com/c/7q1bbVclnyh">惠普打印机被发现偷偷回传数据:隐藏极深</a></li><li><a href="https://robertheaton.com/2019/09/15/hp-printers-send-data-on-what-you-print-back-to-hp/">HP printers try to send data back to HP about your devices and what you print</a></li></ul></li><li><p><strong>Siri</strong></p><ul><li><a href="https://www.ednchina.com/news/201907291202.html">Siri被曝偷偷给用户隐私录音,还上传给苹果</a></li><li><a href="https://www.pingwest.com/w/191896">苹果回应Siri录音用户谈话内容:使用了1%的用户录音</a></li><li><a href="https://www.ifanr.com/1251668">Siri 人工评估计划的员工说,自己每天要听 1000 条录音</a></li><li><a href="https://www.reuters.com/article/us-apple-privacy-siri/apple-says-to-restart-siri-reviews-with-new-controls-idUSKCN1VI1X3">Apple to stop default practice of keeping Siri recordings</a></li></ul></li><li><p><strong>Misc</strong></p><ul><li><p><a href="https://www.sohu.com/a/312245474_804262">卖二手设备一定要注意,你的信息可能并没被删除</a></p></li><li><p><img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/%E6%89%8B%E6%9C%BA%E5%8F%96%E8%AF%81.jpg"></p></li></ul></li><li><p><strong>MIUI</strong></p><ul><li><a href="https://www.solidot.org/story?sid=64260">小米被指记录用户的 Web 和手机使用数据</a></li><li>关于去广告<ul><li><a href="https://zhuanlan.zhihu.com/p/58415240">1000字够不够？小米MIUI 10去广告教程</a></li><li><a href="https://telegra.ph/How-to-disable-most-push-advertisement-on-MIUI-China-Version-02-01">How to disable most push advertisement on MIUI China Version</a></li><li>在「设置-小米账号-隐私协议等-系统广告」里关闭广告.<br><img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/xiaomiad.png"></li></ul></li></ul></li><li><p><strong>ios</strong></p><p>  设置–&gt;隐私–&gt;定位服务–&gt;系统服务–&gt;重要地点</p></li></ul><hr><h2 id="平台-软件"><a href="#平台-软件" class="headerlink" title="平台-软件"></a>平台-软件</h2><ul><li><p><strong>Airbnb</strong></p><ul><li>相关文章<ul><li><a href="https://mp.weixin.qq.com/s/J8J6atXxhG4kqtXsG_9odw">Airbnb上的OSINT信息收集</a> - 讲述了在 Airbnb 上可能造成的隐私泄露问题。</li><li><a href="https://www.vice.com/en_us/article/43k7z3/nationwide-fake-host-scam-on-airbnb">I Accidentally Uncovered a Nationwide Scam on Airbnb</a> - 一篇描述关于 Airbnb 上诈骗状况的文章,揭露了如今人们在 Airbnb 上被骗的种种方式</li></ul></li></ul></li><li><p><strong>AVAST</strong></p><ul><li><a href="https://www.landiannews.com/archives/69469.html">知名安全软件AVAST被爆收集用户各种隐私信息并公开出售给其他公司</a></li></ul></li><li><p><strong>AWS S3</strong></p><ul><li>相关工具<ul><li><a href="https://buckets.grayhatwarfare.com/">Public buckets by grayhatwarfare</a> - S3 Buckets 搜索引擎</li></ul></li></ul></li><li><p><strong>Brave</strong></p><ul><li>事件记录<ul><li><a href="https://www.solidot.org/story?sid=64593">Brave 劫持链接插入返利代码</a></li><li><a href="https://www.solidot.org/story?sid=64600">Brave 称自动插入返利代码是失误所致</a></li></ul></li></ul></li><li><p><strong>Chrome</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://www.cnbeta.com/articles/tech/873763.htm">谷歌崩溃报告究竟收集了哪些信息 个人信息如何处置</a></li><li><a href="https://www.ithome.com/0/437/940.htm">用户浏览器被互联网大厂私自[托管]？仔细一查,这事并不简单</a></li><li><a href="https://www.solidot.org/story?sid=64716">111 个 Chrome 扩展被发现秘密收集用户敏感数据</a></li></ul></li><li><p>隐身模式</p><ul><li><a href="https://mishravikas.com/articles/2019-07/bypassing-anti-incognito-detection-google-chrome.html">Bypassing anti-incognito detection in Google Chrome</a></li><li><a href="https://www.bleepingcomputer.com/news/google/google-chrome-incognito-mode-can-still-be-detected-by-these-methods/">Google Chrome Incognito Mode Can Still Be Detected by These Methods</a></li></ul></li></ul></li><li><p><strong>EDGE</strong></p><ul><li>事件记录<ul><li><a href="https://www.landiannews.com/archives/61675.html">UWP版EDGE浏览器被发现将用户安全标识符和网址发送给微软分析</a></li><li><a href="https://www.cnbeta.com/articles/tech/870695.htm">Edge被吐槽向微软发送包含用户SID和访问站点完整URL等在内的信息</a></li><li><a href="https://www.solidot.org/story?sid=64757">Microsoft Edge 被指悄悄导入了 Firefox 数据</a></li></ul></li></ul></li><li><p><strong>Flickr</strong></p><ul><li>相关文章<ul><li><a href="https://www.aware-online.com/en/email-to-flickr-account-part1/">Email to Flickr account</a></li><li><a href="https://www.aware-online.com/en/email-to-flickr-account-part2/">Email to Flickr account part 2</a></li></ul></li></ul></li><li><p><strong>firefox</strong></p><ul><li>国际版和中文版<ul><li><a href="http://www.177kan.com/html/2017033130.html">Firefox火狐国际版和中文版的区别</a></li><li><a href="http://mozilla.com.cn/forum.php?mod=viewthread&tid=330960">Firefox 如何查看和切换 本地服务 与 全球服务</a></li><li><a href="https://www.solidot.org/story?sid=63395">Mozilla 向用户展示 Firefox 收集的遥测数据</a><ul><li>在地址栏输入 <code>about:telemetry</code>，用户可以看到 Mozilla 收集的遥测数据如浏览器设置、安装的扩展、操作系统/硬件信息，浏览器会话以及运行的进程。</li></ul></li></ul></li></ul></li><li><p><strong>kaspersky</strong></p><ul><li>事件记录<ul><li><a href="http://hackernews.cc/archives/26982">卡巴斯基修复四年老漏洞 注入 HTML 源码的唯一标识符会泄露用户隐私</a><blockquote><p>安全研究人员在测试卡巴斯基杀毒软件时发现它会以安全的名义在用户访问的每一个网页注入它的脚本,而这个脚本还带有唯一 ID,这个 ID 在不同计算机上是不同的,也就是说它可以作为跟踪代码使用.研究人员将这一发现报告给了卡巴斯基.卡巴斯基承认了数据泄漏,它释出了补丁修复了编号为 CVE-2019-8286 的问题.这个补丁去除了唯一 ID,留下了相同的 ID,也就是说网站仍然会知道有安装了卡巴斯基软件的用户访问了.</p></blockquote></li><li><a href="https://www.bleepingcomputer.com/news/security/unique-kaspersky-av-user-id-allowed-3rd-party-web-tracking/">Unique Kaspersky AV User ID Allowed 3rd-Party Web Tracking</a></li></ul></li></ul></li><li><p><strong>Netflix</strong></p><ul><li>事件记录<ul><li><a href="https://cn.engadget.com/2019/08/01/netflix-physical-activity-android-test/">Netflix 解释他们追踪用户活动数据的原因</a></li></ul></li></ul></li><li><p><strong>Office 365</strong></p><ul><li>事件记录<ul><li><a href="https://www.bleepingcomputer.com/news/microsoft/microsoft-office-365-webmail-exposes-users-ip-address-in-emails/">Office 365的Webmail在电子邮件中显示用户的IP地址</a></li></ul></li></ul></li><li><p><strong>Opera</strong></p><ul><li>事件记录<ul><li><a href="https://www.solidot.org/story?sid=61874">第一次启动 Google Chrome 会发生什么？</a><blockquote><p>Brave 的 Jonathan Sampson 在 Twitter 上发表了一系列帖子,他在 Windows 机器上第一次安装了 Google Chrome、Microsoft Edge (Chromium) Beta、Opera 和 Vivaldi 、Dissenter、Brave 和 Firefox,每个浏览器在安装之后都打开几分钟,期间他会对浏览器发出的请求进行抓包,对抓包结果进行一番分析.他发现 Brave 会发出 23 个请求,访问的都是 Brave.com 域名;Firefox 会发出 26 个请求,部分与 Google 的服务有关;Edge 会发出超过 130 个请求,有微软的还有 Google、Facebook 和 Twitter 的,Edge 在首次运行之后还收集了用户系统的详细信息;Opera 发出的请求有些特别,它有 19 个请求指向了俄罗斯的 yandex.ru,还有亚马逊、ebay 和阿里巴巴,它还预加载了十多个第三方网站的 cookies,它甚至已经开始与第三方共享用户信息,许多人声称这家中国公司拥有的挪威浏览器已经变成了间谍软件.</p></blockquote></li></ul></li></ul></li><li><p><strong>Riot Games</strong></p><ul><li>事件记录<ul><li><a href="https://www.solidot.org/story?sid=64139">Riot Games 热门新作《Valorant》安装了 rootkit 去防止作弊</a></li></ul></li></ul></li><li><p><strong>Skype</strong></p><ul><li>事件记录<ul><li><a href="https://www.cnbeta.com/articles/tech/876211.htm">当Skype翻译器功能处于活动状态时 微软承包商可以获知对话内容</a></li></ul></li></ul></li><li><p><strong>Steam</strong></p><ul><li>相关工具<ul><li><a href="https://steamid.uk/">steamid</a> - 索引了个人资料过去使用的所有名称，除此之外，它还列出了可能的公众好友，为你提供了类似名称的列表，还有一些与Steam有关的其它工具。</li></ul></li></ul></li><li><p><strong>zoom</strong></p><ul><li>事件记录<ul><li><a href="https://www.solidot.org/story?sid=64555">Zoom CEO 称为配合 FBI 免费版不加密</a></li><li><a href="https://www.cnbeta.com/articles/tech/987405.htm">Zoom漏洞：超 50 万个 Zoom 账户泄露并在 Dark Web 出售</a></li></ul></li></ul></li><li><p><strong>百度云</strong></p><ul><li><p>自动备份</p><p>  说不定某时某人就给你开了个自动备份呢？</p><p>  <a href="https://pan.baidu.com/disk/discovery">https://pan.baidu.com/disk/discovery</a></p>  <p align="center">      <img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/baiduyun.png">  </p></li></ul></li><li><p><strong>滴滴</strong></p><ul><li><p>查询历史行程</p><p>  我没下过 APP 版的,在支付宝中的滴滴是可以查询历史行程的.点击头像–&gt;订单–&gt;查看历史行程</p>  <p align="center">      <img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/dd.png">  </p></li></ul></li><li><p><strong>淘宝</strong></p><ul><li><p>查看历史消费金额</p><p>  <code>淘宝搜索 : 淘宝人生 点右上角[成就]</code></p><p>  <code>淘宝搜索 : 看鬼故事</code></p></li></ul></li></ul><hr><h2 id="社交网络"><a href="#社交网络" class="headerlink" title="社交网络"></a>社交网络</h2><ul><li><p><strong>facebook</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://twitter.com/oasace/status/1149181539000864769">facebook正在你下载的照片中嵌入跟踪数据</a></li><li><a href="https://www.forbes.com/sites/zakdoffman/2019/07/14/facebook-is-embedding-hidden-codes-to-track-all-your-uploaded-photos-report/#736d099e1592">Facebook Embeds ‘Hidden Codes’ To Track Who Sees And Shares Your Photos</a></li><li><a href="http://hackernews.cc/archives/26923">Messenger 发音频安全吗？FB 承认曾转录用户音频</a></li><li><a href="https://tech.sina.com.cn/i/2019-08-14/doc-ihytcitm8999002.shtml">彭博:Facebook雇人记录用户语音通话以改善AI技术</a><blockquote><p>知情人士透露称,Facebook 付费聘请几百名外部承包商,让他们转录音频片段,这些音频来自使用 Facebook 服务的用户.</p></blockquote></li></ul></li><li><p>相关文章</p><ul><li><a href="https://osintcurio.us/2019/08/22/the-new-facebook-graph-search-part-1/">The new Facebook Graph Search – part 1</a></li><li><a href="https://osintcurio.us/2019/08/22/the-new-facebook-graph-search-part-2/">The new Facebook Graph Search – part 2</a></li><li><a href="https://osintcurio.us/2020/04/02/facebook-tips/">Facebook Tips</a></li><li><a href="https://hatless1der.com/think-private-facebook-profiles-pages-are-a-dead-end-think-again/">Think Private Facebook Profiles Pages Are A Dead End? Think Again!</a></li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/harismuneer/Ultimate-Facebook-Scraper">harismuneer/Ultimate-Facebook-Scraper</a> - 一个抓取 facebook 用户信息的 python 脚本</li><li><a href="https://data.humdata.org/organization/facebook">Humanitarian Data Exchange</a> - Facebook 的公开数据查询平台</li></ul></li></ul></li><li><p><strong>google</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://www.zdnet.com/article/google-accused-of-leaking-personal-data-to-thousands-of-advertisers/">Google accused of leaking personal data to thousands of advertisers</a></li><li><a href="https://mp.weixin.qq.com/s/h1tSXTIOK_joBqz8EdDVug">执法部门找Google查用户信息需缴费，明码标价童叟无欺</a></li></ul></li><li><p>相关文章</p><ul><li><a href="https://mp.weixin.qq.com/s/0gPCDNwDwtNM-5lC0zEbGQ">关于Google ID的OSINT信息挖掘</a></li></ul></li><li><p>相关工具</p><ul><li><a href="https://tools.epieos.com/google-account.php">Google Account Finder</a></li><li><a href="https://github.com/mxrch/GHunt">mxrch/GHunt</a> - 用电子邮件调查谷歌账户</li></ul></li></ul></li><li><p><strong>Instagram</strong></p><ul><li><p>相关文章</p><ul><li><a href="https://www.aware-online.com/en/find-an-instagram-user-id/">Find an Instagram user ID</a> - 检索 Instagram 用户 ID</li><li><a href="https://www.iyouport.org/%E5%9C%A8%E6%9C%80%E9%9A%BE%E6%90%9C%E7%B4%A2%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%9A%E8%A7%A3%E5%89%96-instagram-%E7%94%A8%E6%88%B7/">在最难搜索的地方：解剖 Instagram 用户</a></li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/sc1341/InstagramOSINT">sc1341/InstagramOSINT</a> - 对 Instagram 帐户进行基本的信息收集的 python 脚本.</li><li><a href="https://github.com/Datalux/Osintgram">Datalux/Osintgram</a></li></ul></li><li><p>相关搜索</p><ul><li><a href="https://www.gramfind.com/">Instagram Search Engine</a></li><li><a href="https://webstagram.org/">Webstagram</a> - Instagram Search Account Instagram Web Viewer</li><li><a href="https://grampages.com/">GramPages</a></li><li><a href="https://skimagram.com/">Skimagram</a> - Search engine for Instagram</li></ul></li></ul></li><li><p><strong>LinkedIn</strong></p><ul><li><p>相关文章</p><ul><li><a href="https://www.intelligencewithsteve.com/post/a-guide-to-searching-linkedin-by-email-address">A guide to searching LinkedIn by email address</a> - 教你如何通过电子邮件地址搜索 LinkedIn 个人资料</li><li><a href="https://www.hackers-arise.com/post/2019/05/28/osint-part-3-extracting-employee-names-from-companies-tesla-and-breitbart-on-linkedin">OSINT, Part 3: Extracting Employee Names from Companies (Tesla and Breitbart) on LinkedIn</a> - 提取 LinkedIn 中员工姓名和邮箱</li><li><a href="https://mp.weixin.qq.com/s/IewdFeHyDmICM0EeDjxIAw">【技巧】利用谷歌搜索引擎和手机网页检测功能查看非好友领英网页</a></li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/0x09AL/raven">0x09AL/raven</a> - Linkedin信息收集工具，渗透测试人员可以使用该工具收集有关使用Linkedin的组织员工的信息。</li></ul></li><li><p>相关搜索</p><ul><li><a href="https://freepeoplesearchtool.com/">Free People Search Tool</a></li><li><a href="https://recruitmentgeek.com/tools/linkedin/">FREE LinkedIn Xray Search Tool</a></li><li><a href="https://sourcinglab.io/search/linkedin">LinkedIn X-Ray Search Tool | Sourcinglab</a></li><li><a href="http://trevisansocial.com/linkedtool/">Trevisan LinkedIn Boolean Search Generator</a></li><li><a href="https://lisearcher.com/">LinkedIn X-Ray Search Tool</a></li></ul></li></ul></li><li><p><strong>QQ</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://www.v2ex.com/t/745030">QQ 正在尝试读取你的浏览记录</a></li><li><a href="https://bbs.pediy.com/thread-265359.htm">关于QQ读取Chrome历史记录的澄清</a></li><li><a href="https://www.zhihu.com/question/439768601">如何看待 QQ 扫描读取所有浏览器的历史记录？</a></li><li><a href="https://www.solidot.org/story?sid=66688">腾讯官方声称扫描浏览器历史数据是防止恶意登陆</a></li></ul></li><li><p>查看历史头像</p><p>  貌似只有 QQ 可以,TIM 不行</p>  <p align="center">      <img src="https://raw.githubusercontent.com/gcdd1993/gcdd1993.github.io/feature/imageRepo/img/qq.jpg">  </p></li></ul></li><li><p><strong>telegram</strong></p><ul><li><p>相关文章</p><ul><li><a href="https://owlspace.xyz/cybersec/tg-nearby/">MODIFYING TELEGRAM’S “PEOPLE NEARBY” FEATURE TO PINPOINT PEOPLE’S HOMES</a> - 利用 Telegram 的 “PEOPLE NEARBY” 功能 (技术上) 精确定位全球各地的人</li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/paulpierre/informer">paulpierre/informer</a> - 一个机器人库，可以让你在telegram上伪装成多个真实用户，并对每个账号500多个telegram频道进行监视。</li><li><a href="https://github.com/th3unkn0n/TeleGram-Scraper">th3unkn0n/TeleGram-Scraper</a> - 电报群组扫描器工具</li></ul></li><li><p>相关搜索</p><ul><li><a href="https://combot.org/">Combot</a> - 分析聊天情况,活跃情况.</li><li><a href="https://tele.me/">tele.me</a> - 分析聊天情况,活跃情况.</li><li><a href="https://tgstat.com/">tgstat</a> - 频道索引</li><li><a href="https://telegram.im/tools/index.php">Statistics and Telegram Tools</a> - 发现telegram用户、群组、频道、机器人</li><li><a href="https://en.tgchannels.org/">Telegram channels online web catalog and bot for news reading</a> - 发现telegram用户、群组、频道、机器人</li><li><a href="https://telemetr.io/">Telegram channels rating</a> - Telegram channels 排名</li><li><a href="https://telegramchannels.me/">18000+ Telegram Channels, Groups, Bots and Stickers List</a> - Discover Telegram Channels</li><li><a href="https://www.telegram-group.com/en/">Telegram Group</a> - Find Telegram Channels, Bots &amp; Groups</li><li><a href="https://search.buzz.im/">Search.buzz.im</a> - 深度搜索 telegram 信息</li><li><a href="https://tgstat.ru/en/search">Telegram Search. Search for posts</a> - 整合搜索</li><li><a href="https://github.com/goq/telegram-list">goq/telegram-list</a> - 群组列表</li><li><a href="https://telegramic.org/">Telegramic</a></li><li><a href="https://telegroups.info/">Telegroups</a></li><li><a href="https://tgram.io/">Telegram Groups List</a></li><li><a href="https://botsfortelegram.com/">Bots for Telegram</a></li><li><a href="https://lyzem.com/">Lyzem Search</a></li></ul></li><li><p>Tips</p><ul><li>Telegram 账号的”数字 id”是注册时间越晚就越大吗？<ul><li>不是.如果多注册一些账号,可以发现有可能后注册的账号数字 id 是要小于先期注册的,因此通过数字 id 来判断一个账号是否为新号是没有依据的.出现这种现象,应该是由于旧账号注销后,该账号的数字 id 又被重新分配给新注册的账号.Telegram 官方客户端无法显示账号数字 id,若想查询自己的账号数字id可以用过机器人 @getidsbot ,还有其他的机器人也有类似的功能,某些第三方客户端也可以显示账号的数字id(请谨慎使用第三方客户端).</li></ul></li></ul></li></ul></li><li><p><strong>tiktok</strong></p><ul><li><p>相关文章</p><ul><li><a href="https://medium.com/@BTF117/tiktok-osint-targeted-user-investigation-9e206f8bb794">TikTok OSINT: targeted user investigation (Part 1/3: User)</a> - 针对 Tiktok 用户的的开源调查案例</li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/sc1341/TikTok-OSINT">sc1341/TikTok-OSINT</a> - 用于 tiktok 信息收集的开源工具集</li></ul></li></ul></li><li><p><strong>Twitter</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://www.cnbeta.com/articles/tech/877047.htm">Twitter承认未经允许将用户数据与广告商共享</a></li></ul></li><li><p>相关文章</p><ul><li><a href="https://www.iyouport.org/%e4%bb%8e%e6%8e%a8%e7%89%b9%e4%b8%ad%e6%8c%96%e6%8e%98%e7%9c%9f%e7%9b%b8%e4%b8%8d%e9%9c%80%e8%a6%81%e5%a4%aa%e5%a4%8d%e6%9d%82%e7%9a%84%e5%b7%a5%e5%85%b7%ef%bc%9a%e4%b8%80%e4%b8%aa%e5%b8%b8%e7%94%a8/">从推特中挖掘真相不需要太复杂的工具：一个常用工具的全面指南</a> - 介绍如何在 twitter 进行 osint 的教程</li><li><a href="https://www.aware-online.com/en/email-to-twitter-account/">Email to Twitter account</a> - 通过邮箱找到 twitter 账户</li></ul></li><li><p>相关工具</p><ul><li><a href="https://github.com/twintproject/twint">twintproject/twint</a> - 使用 Python 编写,抓取 Twitter 的 OSINT 工具.</li><li><a href="https://github.com/sowdust/tafferugli">sowdust/tafferugli: Tafferugli is a Twitter Analysis Framework</a> - 一个 web 应用程序形式的 Twitter 分析框架，能够过滤、收集和分析 tweet</li></ul></li><li><p>相关搜索</p><ul><li><a href="https://tinfoleak.com/">tinfoleak</a> - 一个查 twitter 用户资料的工具</li><li><a href="https://tweetbeaver.com/index.php">TweetBeaver</a> - 帮助调查 twitter 账户的网站</li><li><a href="https://burrrd.com/">Twitter Account Analytics by burrrd.</a> - 分析 twitter 帐号的工具</li><li><a href="https://www.trendsmap.com/">Trendsmap</a> - Twitter 主题标签，关键字或位置分析</li><li><a href="https://hoaxy.iuni.iu.edu/">Hoaxy</a> - twitter分析工具,可视化文章连接和某条 twitter 被转载的次数</li><li><a href="http://twlets.com/">Twlets | Twitter to Excel</a> - 下载任何人的推文，关注者，喜欢的视频到 excel 中</li><li><a href="http://twittertroll.com/">Twitter Search Engine</a></li><li><a href="https://twitterfall.com/">Twitterfall</a> - 瀑布流版本 Twitter</li><li><a href="https://shadowban.eu/">Twitter Shadowban Test</a> - 检测指定账号状态</li><li><a href="http://searchfortweets1.com/">Twitter Search Tool - Search For Tweets</a> - 搜索</li><li><a href="https://twitter-search-engine.herokuapp.com/">Twitter Search Engine</a> - 搜索</li><li><a href="https://tweetdeck.twitter.com/">TweetDeck</a> - 在一个简单的界面中查看多个时间轴，从而提供了更便捷的 Twitter 体验。</li><li><a href="https://twimap.com/">TwiMap - Explore Twitter on the Map</a> - 查看附近用户的推文</li><li><a href="https://www.omnisci.com/demos/tweetmap">OmniSci Tweetmap</a> - 查看附近用户的推文</li><li><a href="https://onemilliontweetmap.com/">onemilliontweetmap</a> - 查看附近用户的推文</li></ul></li></ul></li><li><p><strong>whatapp</strong></p><ul><li>相关工具<ul><li><a href="https://github.com/LoranKloeze/WhatsAllApp">LoranKloeze/WhatsAllApp</a> - 通过手机号查询 whatapp 的注册信息</li></ul></li></ul></li><li><p><strong>YouTube</strong></p><ul><li>相关工具<ul><li><a href="https://intelx.io/tools?tab=youtube">YouTube DataViewer</a> - 显示 YouTube 上任意视频的所有可用元数据。</li><li><a href="https://github.com/anvaka/yasiv-youtube">anvaka/yasiv-youtube</a> - 寻找相似视频关系</li><li><a href="http://youtube.github.io/geo-search-tool/search.html">Geo Search Tool</a> - 按地理位置寻找相关视频的工具</li><li><a href="https://citizenevidence.amnestyusa.org/">Extract Meta Data</a> - 从 YouTube 的视频中提取隐藏数据</li><li><a href="https://mattw.io/youtube-geofind/location">Location Search - Discover Geo-tagged Videos - YouTube Geofind</a> - 查看附近用户的视频</li><li><a href="https://youtube.github.io/geo-search-tool/search.html">Geo Search Tool</a> - 查看指定地址范围用户上传的视频</li><li><a href="https://channelcrawler.com/">The YouTube Channel Crawler</a> - YouTube 频道爬虫</li><li><a href="https://tagsyoutube.com/">TagsYouTube</a> - Youtube 视频标签生成器和关键字在线搜索</li></ul></li></ul></li><li><p><strong>网易云</strong></p><ul><li><p>链接指纹</p><p>  试着分享一个音乐 <a href="https://music.163.com/#/song/1346907833/?userid=48353">https://music.163.com/#/song/1346907833/?userid=48353</a></p><p>  注意一下 userid 变量,构造一下链接: <code>https://music.163.com/#/user/home?id=&lt;!userid!&gt;</code></p><p>  <code>https://music.163.com/#/user/home?id=48353</code></p></li><li><p>历史评论</p><p>  ios 端、安卓端通用,账号–&gt;关于我–&gt;我的评论</p></li></ul></li><li><p><strong>微信</strong></p><ul><li><p>事件记录</p><ul><li><a href="https://www.scmp.com/news/china/politics/article/3018725/how-unwitting-users-wechat-aid-chinese-messaging-apps">How unwitting users of WeChat aid the Chinese messaging app’s blacklisting of sensitive images</a><blockquote><p>阿里巴巴旗下的南华早报引用加拿大多伦多大学公民实验室的报告报道,腾讯的微信利用实时和追溯分析的方法审查用户的图片.报告发现,微信对用户对话中发送的图片进行实时自动检测和审查,审查是基于图片中包含的文字以及目标图片与系统数据库中的敏感图片的相似度匹配;微信通过建立哈希索引(Hash Index)实现过滤,该哈希索引由微信用户在聊天对话中发送的图像的 MD5 值组成;对比微信朋友圈,一对一聊天以及群组聊天的图片审查比例,发现这三项功能的敏感图片库并不相同,其中朋友圈和群组聊天所审查的范围要远大于一对一聊天;与关键词审查一样,微信图片审查与新闻事件相关.</p></blockquote></li></ul></li><li><p>链接指纹<br>  阅读下面这个文章大致了解一下微信链接组成</p><ul><li><a href="https://soaked.in/2020/08/wechat-platform-url/">微信公众号文章URL的种类与结构</a></li></ul><p>  那么类似 <code>https://mp.weixin.qq.com/s?__biz=MzIyAAANzY0OA==&amp;mid=101111431&amp;idx=1&amp;sn=62accd1299d25d54d1f3ad3f3d7d214&amp;chksm=683d2e402f6sa2dsa2d154058807d1xxxx151213131dasdasdsadasd675ce59fae94ff9908&amp;scene=18&amp;xtrack=1&amp;key=917D458AS46D146SD14AF541DSA4FDSAF131DS31F31DSA31FDSAde153285841fdc398a67d61be441cb0e1898a08232811308bf31dfc92757c3d7d5e3SD54AD1SA1D351S3A1D31S3AD034f1cb34170ecd27b6d7d69&amp;ascene=1&amp;uin=MTk3ODkwODMxMA%3D%3D&amp;devicetype=Windows+7&amp;version=62055833&amp;lang=zh_CN&amp;pass_ticket=r6jSAD55SAF458F61A4S56F51BW2hfIQPocX2O0er0vUheGSD45ASD11DASD361SADAWDbiqW</code> 这么一串可以携带多少信息</p></li></ul></li><li><p><strong>支付宝</strong></p><ul><li><a href="https://www.douban.com/group/topic/142322388/">支fu宝可以查婚姻状况望周知</a></li></ul></li></ul><hr><h2 id="各类搜索"><a href="#各类搜索" class="headerlink" title="各类搜索"></a>各类搜索</h2><p><code>下方所有搜索引擎不保证其安全性、隐私性,仅保证其功能性</code></p><h3 id="常用搜索引擎"><a href="#常用搜索引擎" class="headerlink" title="常用搜索引擎"></a>常用搜索引擎</h3><ul><li><a href="https://www.ask.com/">https://www.ask.com/</a></li><li><a href="https://start.duckduckgo.com/">https://start.duckduckgo.com/</a></li><li><a href="https://www.ecosia.org/">https://www.ecosia.org/</a></li><li><a href="https://www.google.com/">https://www.google.com/</a></li><li><a href="https://www.qwant.com/">https://www.qwant.com/</a></li><li><a href="https://searx.me/">https://searx.me/</a></li><li><a href="https://www.startpage.com/">https://www.startpage.com/</a></li><li><a href="https://yandex.com/">https://yandex.com/</a></li><li><a href="http://search.chongbuluo.com/">http://search.chongbuluo.com/</a></li><li><a href="https://magi.com/">https://magi.com/</a></li><li><a href="https://www.onesearch.com/">https://www.onesearch.com/</a></li></ul><h3 id="网页快照"><a href="#网页快照" class="headerlink" title="网页快照"></a>网页快照</h3><ul><li><a href="http://2tool.top/">网页快照网</a> - 搜索引擎网页快照查询，支持手机移动端</li><li><a href="https://archive.org/">Internet Archive: Digital Library of Free &amp; Borrowable Books, Movies, Music &amp; Wayback Machine</a> - 互联网档案馆是一个非营利性的数字图书馆组织。提供数字数据如网站、音乐、动态图像、和数百万书籍的永久性免费存储及获取。</li><li><a href="http://cachedview.com/">CachedView</a></li><li><a href="https://cachedviews.com/">CachedViews</a></li><li><a href="https://pagecached.com/">Page Cached</a></li><li><a href="https://cache.nevkontakte.com/#!">Google Cache Browser 3.0</a></li><li><a href="https://cachearchive.com/">Cached websites check from Google webcache and Archive org</a></li><li><a href="https://arquivo.pt/?l=pt">Arquivo.pt: pesquise páginas do passado!</a></li></ul><h3 id="图片反向搜索"><a href="#图片反向搜索" class="headerlink" title="图片反向搜索"></a>图片反向搜索</h3><ul><li><a href="https://www.google.com/imghp">Google 图片</a></li><li><a href="http://exif.regex.info/exif.cgi">Jeffrey Friedl’s Image Metadata Viewer</a></li><li><a href="https://www.tineye.com/">TinEye Reverse Image Search</a></li><li><a href="https://image.baidu.com/">百度图片</a></li><li><a href="https://artsexperiments.withgoogle.com/artpalette/">Google Art &amp; Culture Experiment - Art Palette</a></li><li><a href="https://yandex.com/images/">Yandex.Images</a></li><li><a href="https://www.aliseeks.com/search">Aliseeks</a> - 支持在 AliExpress 或 eBay 列表中对产品进行反向图像搜索</li><li><a href="https://www.labnol.org/reverse/">Google Reverse Image Search for Mobile</a></li></ul><h3 id="acg图片反向搜索"><a href="#acg图片反向搜索" class="headerlink" title="acg图片反向搜索"></a>acg图片反向搜索</h3><ul><li><a href="https://iqdb.org/">Multi-service image search</a> - 多服务反向图像搜索</li><li><a href="https://saucenao.com/">SauceNAO Image Search</a> - 反向图像搜索引擎，搜 pixiv 效果极佳</li><li><a href="https://ascii2d.net/">二次元画像詳細検索</a> - 专搜二次元图片</li><li><a href="https://trace.moe/">WAIT: What Anime Is This?</a> - 动画片段搜索引擎，可以帮助用户通过截图追溯原著动漫</li></ul><h3 id="航班-飞机信息"><a href="#航班-飞机信息" class="headerlink" title="航班/飞机信息"></a>航班/飞机信息</h3><ul><li><a href="https://www.flightradar24.com/">Flight Tracker | Flightradar24 | Track Planes In Real-Time</a><ul><li><a href="https://habr.com/en/post/440596/">Flightradar24 — how it works? / Habr</a> - 一篇介绍网站如何运作的文章</li></ul></li><li><a href="https://zh.flightaware.com/">FlightAware</a> - 航班跟踪/航班状态/飞行跟踪</li><li><a href="http://flightadsb.variflight.com/">real-time flight tracking | Flightadsb | VariFlight</a></li><li><a href="https://direct-flights.com/">Direct Flights | Explore all non-stop flights from any airport</a></li><li><a href="https://www.radarbox.com/">AirNav RadarBox</a> - Live Flight Tracker and Airport Status</li><li><a href="https://tar1090.adsbexchange.com/">ADS-B Exchange</a> - tracking 2534 aircraft</li><li><a href="https://www.flightview.com/flighttracker/">FLIGHTVIEW FLIGHT TRACKER</a></li><li><a href="http://www.planeflighttracker.com/">Plane Flight Tracker</a></li><li><a href="https://www.flightstats.com/v2">FlightStats</a> - Global Flight Status &amp; Tracker, Airport Weather and Delays</li><li><a href="https://www.ifly.com/flight-tracker">iFly.com</a> - Flight Status | Track Flights</li><li><a href="https://registry.faa.gov/aircraftinquiry/Aircraft_Inquiry.aspx">FAA Registry - Aircraft - N-Number Inquiry</a> - 搜索在美国联邦航空管理局（FAA）注册的所有飞机的登记册。</li><li><a href="https://radar.freedar.uk/VirtualRadar/desktop.html">Virtual Radar</a></li></ul><h3 id="船舶信息"><a href="#船舶信息" class="headerlink" title="船舶信息"></a>船舶信息</h3><ul><li><a href="https://www.marinetraffic.com/">MarineTraffic: Global Ship Tracking Intelligence | AIS Marine Traffic</a></li><li><a href="https://www.vesselfinder.com/">Free AIS Ship Tracking of Marine Traffic - VesselFinder</a></li><li><a href="https://www.myshiptracking.com/">My Ship Tracking Free Realtime AIS Vessel Tracking Vessels Finder Map</a></li><li><a href="http://www.chinaports.com/shiptracker/olv3/index.jsp">ShipTracker</a> - 船舶动态查询_AIS船位_船舶跟踪_船舶定位_船舶位置查询</li><li><a href="https://shipsgo.com/">Global Container Shipping Platform | Container Tracking, Ocean Schedules</a></li><li><a href="https://www.marinevesseltraffic.com/">Marine Vessel Traffic</a></li><li><a href="http://www.shipfinder.com/">Live AIS Ships Map!—shipfinder</a></li><li><a href="http://cyxx.msa.gov.cn/lycx/zslycx!init.action?flag=1">船员证书查询</a></li><li><a href="http://www.shipxy.com/">船讯网</a> - 船舶动态、船舶档案、AIS船位、货物跟踪、租船、OP、航运大数据</li><li><a href="https://ship.yunlsp.com/">海管家</a> - 船舶动态查询;船舶定位;船舶跟踪</li><li><a href="https://www.fleetmon.com/">Live AIS Vessel Tracker with Ship and Port Database</a></li><li><a href="http://ship.chinaports.com/">中国港口</a></li><li><a href="https://www.myships.com/">国家水上交通信息服务平台</a></li><li><a href="https://www.whereships.com/">船问网-船舶档案，船舶在线揽货交易,运费托盘全程垫付</a></li><li><a href="http://www.igenzong.com/Port/CNTAO">青岛港区 货物跟踪 - i跟踪</a></li><li><a href="http://www.yundangnet.com/cargoTrackings/cargoTrackingSea">云当网-物流可视化-船舶轨迹定位-海运跟踪-空运货物跟踪-码头-集装箱进港查询</a></li><li><a href="https://globalfishingwatch.org/map/">Global Fishing Watch</a> - 显示商业渔船的位置</li></ul><p><strong>相关文章</strong></p><ul><li><a href="https://wondersmithrae.medium.com/osint-on-the-ocean-maritime-intelligence-gathering-techniques-2ee39e554fe1">OSINT on the Ocean: Maritime Intelligence Gathering Techniques</a></li></ul><h3 id="货车位置"><a href="#货车位置" class="headerlink" title="货车位置"></a>货车位置</h3><ul><li><a href="https://truck.yunlsp.com/map_ctn">货车定位,集卡跟踪-海管家</a></li><li><a href="http://www.huocheweizhi.com/">货车位置、货车定位软件</a></li><li><a href="http://www.huoche007.com/">货车位置实时查询</a></li></ul><h3 id="物流信息"><a href="#物流信息" class="headerlink" title="物流信息"></a>物流信息</h3><ul><li><a href="http://www.kuaidi100.com/">快递100</a> - 查快递</li><li><a href="http://www.spb.gov.cn/yzbmcx/">中华人民共和国国家邮政局</a></li><li><a href="http://www.ckd.cn/">快递查询</a></li><li><a href="https://www.17track.net/zh-cn">全球物流查询平台</a></li></ul><h3 id="车辆信息"><a href="#车辆信息" class="headerlink" title="车辆信息"></a>车辆信息</h3><ul><li><a href="https://www.nomerogram.ru/">Проверка авто по гос номеру - Поиск машины бесплатно онлайн - Номерограм</a> - 车牌号搜索引擎(仅限俄罗斯,不是你想得那种车牌)</li><li><a href="https://www.nicb.org/vincheck">VINCheck® | National Insurance Crime Bureau</a> - 协助确定车辆是否被报案为失窃但未被追回，或被NICB成员保险公司报案为残余车辆。</li></ul><h4 id="VIN码"><a href="#VIN码" class="headerlink" title="VIN码"></a>VIN码</h4><blockquote><p>VIN码是英文(Vehicle Identification Number)的缩写，VIN码是表明车辆身份的代码。VIN码由17位字符（包括英文字母和数字）组成。是制造厂为了识别而给一辆车指定的一组字码。该号码的生成有着特定的规律，对应于每一辆车，并能保证五十年内在全世界范围内不重复出现。因此又有人将其称为”汽车身份证”。车辆识别代号中含有车辆的制造厂家、生产年代、车型、车身型式、发动机以及其它装备的信息。</p></blockquote><ul><li><a href="http://www.chinacar.com.cn/vin_index.html">中国汽车网-VIN车辆识别代码查询</a></li><li><a href="http://www.yiparts.com/vin">宜配网VIN查询</a></li><li><a href="http://www.fenco.cn/">奉新行 车辆识别码(VIN)查询</a></li><li><a href="http://www.17vin.com/">17VIN 17位车架号查询</a></li><li><a href="http://www.chexinhui.com/pcIndexAction.action?method=showHelpUI&id=16725&typeId=303">车信会 VIN查询</a></li><li><a href="http://www.vin114.net/">力洋汽车信息查询</a></li><li><a href="https://www.sopei.cn/">搜配网 - VIN码识别_车架号识别_专业汽车配件数据库_车型配件精准查询</a></li><li><a href="https://www.juhe.cn/docs/api/id/283">聚合数据- VIN码查询数据接口_免费API接口调用</a></li><li><a href="https://www.jisuapi.com/api/vin/">极速数据-VIN车辆识别代码查询API接口_免费数据接口</a></li><li><a href="https://market.aliyun.com/products/56928004/cmapi013503.html#sku=yuncode750300000">易源数据-车架号VIN查询车辆信息</a></li><li><a href="https://carsowners.net/">Free VIN Code Search Service</a> - 车主姓名，地址，电话号码和汽车注册状态等信息</li><li><a href="https://www.faxvin.com/">Vehicle History Reports</a> - 车辆 VIN 码查询</li></ul><h3 id="个人可信度"><a href="#个人可信度" class="headerlink" title="个人可信度"></a>个人可信度</h3><ul><li><a href="https://www.creditchina.gov.cn/">个人信用查询搜索_企业信息查询搜索_统一社会信用代码查询-信用中国</a></li><li><a href="https://www.cods.org.cn/">统一社会信用代码查询_诚信体系实名制查询_组织机构代码-全国组织机构统一社会信用代码数据服务中心(原全国组织机构代码管理中心)</a></li><li><a href="http://zxgk.court.gov.cn/">中国执行信息公开网</a></li><li><a href="http://www.pbccrc.org.cn/">中国人民银行征信中心</a></li><li><a href="https://www.lawxin.com/">风险信息网</a> - 可查询个人和企业工商信息以及法院判决、税务、海关、市场监管等各类关联信息。并且支持批量监控，并有短信通知功能。</li><li><a href="https://www.fengxian110.com/">查企业工商_诉讼案件_失信被执行人_对外投资_催收公告信息_风险预警网</a> - 被列入失信执行人的名单将在网站上展示。</li><li><a href="https://www.cuitx.cn/">物业费催收|互联网催收平台|贷后催收系统|债务案源-催天下</a> - 可以查询被催收人信息</li><li><a href="https://www.lawxp.com/">汇法网-网上法务平台：找律师、裁判文书、法律法规、合同、法律新闻</a> - 提供法律法规及裁判文书查询</li></ul><h3 id="网络空间测绘"><a href="#网络空间测绘" class="headerlink" title="网络空间测绘"></a>网络空间测绘</h3><ul><li><a href="https://www.shodan.io/">Shodan</a> - 网络空间安全搜索引擎</li><li><a href="https://www.binaryedge.io/">BinaryEdge</a> - 网络空间安全搜索引擎，瑞士Shodan</li><li><a href="https://fofa.so/">FOFA Pro</a> - 网络空间安全搜索引擎,国产Shodan</li><li><a href="https://www.zoomeye.org/">ZoomEye</a> - 网络空间安全搜索引擎,国产Shodan</li><li><a href="https://censys.io/">Censys</a> - 搜索IP地址、设备、网站和证书配置、部署信息的搜索引擎</li><li><a href="https://spyse.com/search/cert">Spyse</a> - SSL证书搜索引擎</li><li><a href="https://searchcode.com/">searchcode</a> - 开源代码搜索引擎</li><li><a href="https://zhifeng.io/monitor">知风</a> - 互联网联网工控资产搜索引擎</li></ul><h3 id="tor信息"><a href="#tor信息" class="headerlink" title="tor信息"></a>tor信息</h3><ul><li><a href="https://as.onionsearchengine.com/">Onion Search Engine</a></li><li><a href="http://darksearch.io/">DarkSearch</a> - Dark Web search engine</li><li><a href="http://dnmugu4755642434.onion/">kilos</a></li><li><a href="http://www.dargle.net/search">Dargle</a></li><li><a href="https://boogle.store/">Genesis Search</a></li><li><a href="https://www.bullmask.com/">Bullmask</a></li><li><a href="https://onionsearchengine.com/">Onion Search Engine</a></li><li><a href="https://onionlandsearchengine.com/">OnionLand Search</a></li><li><a href="https://ahmia.fi/">Ahmia</a></li><li><a href="https://tor2web.onionsearchengine.com/">haystak</a></li><li><a href="http://haystakvxad7wbk5.onion.ws/">Tor2Web</a></li><li><a href="http://boogle.store/">Genesis Search</a></li></ul><hr><ul><li><a href="https://hakin9.org/torbot-open-source-intelligence-tool-for-the-dark-web/">TorBot - Open Source Intelligence Tool for the Dark Web</a> - 用于暗网的开源情报工具</li></ul><h3 id="学术信息"><a href="#学术信息" class="headerlink" title="学术信息"></a>学术信息</h3><ul><li><a href="https://libgen.pw/">libgen</a> - 有关书籍、插画、文章的搜索引擎</li><li><a href="https://www.semanticscholar.org/">Semantic Scholar</a> - 科学文章的学术搜索引擎</li><li><a href="https://yuanjian.cnki.net/">远见搜索</a> - 知网提供的搜索引擎</li><li><a href="https://libgen.is/">Library Genesis</a> - 創世紀圖書館是科學論文及書籍的搜尋引擎，可以免費提供被擋在付費牆後的內容。</li><li><a href="https://www.wolframalpha.com/">Wolfram|Alpha</a></li></ul><h3 id="专利-商标"><a href="#专利-商标" class="headerlink" title="专利-商标"></a>专利-商标</h3><ul><li><a href="https://www.patexplorer.com/">佰腾网</a></li><li><a href="http://www.innojoy.com/search/index.html">Dawei Innojoy Patent Search Engine</a></li><li><a href="http://www1.soopat.com/Home/IIndex">SooPAT 专利搜索</a></li><li><a href="https://www.rainpat.com/">润桐RainPat专利检索</a></li><li><a href="http://search.cnipr.com/">专利信息服务平台</a></li><li><a href="https://www.qccip.com/">权查查</a> - 商标查询-商标注册-商标监控-商标品牌保护-知识产权服务平台</li></ul><h3 id="报刊信息"><a href="#报刊信息" class="headerlink" title="报刊信息"></a>报刊信息</h3><ul><li><a href="http://headlinespot.com/">HeadlineSpot</a> - 世界新闻头条</li><li><a href="https://www.refdesk.com/paper.html">refdesk</a> - 全球报纸</li><li><a href="https://www.newspapers-list.com/">Newspapers List</a> - 聚集全球各地的报纸（在线版）</li><li><a href="http://en.newsconc.com/">News Conc</a> - 全球报纸</li></ul><h3 id="开放数据集"><a href="#开放数据集" class="headerlink" title="开放数据集"></a>开放数据集</h3><ul><li><a href="https://data.worldbank.org.cn/">World Bank Open Data</a> - 免费并公开获取世界各国的发展数据</li><li><a href="https://databasd.com/">Databasd</a> - 开放数据集的搜索引擎</li><li><a href="https://offshoreleaks.icij.org/">ICIJ Offshore Leaks Database</a> - OFFSHORE LEAKS DATABASE</li><li><a href="https://qresear.ch/">QResear.ch</a> - 该网站收录了很多小众话题、板块和文章，包含了从人口贩卖到白宫访客，从8Chan到Epstein的黑名单等等。</li><li><a href="https://www.judyrecords.com/">judyrecords</a> - 可对来自美国的3.6亿多个逮捕记录和法院文件进行索引</li><li><a href="https://boardreader.com/">Boardreader</a> - 搜索全球各个论坛平台的内容</li></ul><h3 id="BGP信息"><a href="#BGP信息" class="headerlink" title="BGP信息"></a>BGP信息</h3><ul><li><a href="http://bgp.potaroo.net/index-upd.html">BGP Update Reports</a></li><li><a href="http://www.routeviews.org/routeviews/index.php/collectors/">Collectors – Routeviews</a></li></ul><h3 id="电子硬件相关"><a href="#电子硬件相关" class="headerlink" title="电子硬件相关"></a>电子硬件相关</h3><ul><li><a href="https://fccid.io/search.php">Search FCC ID Database</a> - 通过 FCC ID、CMIIT ID 或 KCC MSIP 搜索。</li><li><a href="https://bios-pw.org/#">BIOS Master Password Generator for Laptops</a> - 笔记本电脑的 BIOS 密码恢复</li><li><a href="http://www.srrc.org.cn/WP_Search.aspx">无线电设备查询</a></li><li><a href="https://zwfw.miit.gov.cn/miit/resultSearch?categoryTreeId=300">行政许可结果公开系统</a> - 电信设备进网许可证查询</li></ul><h3 id="社交-人际关系"><a href="#社交-人际关系" class="headerlink" title="社交-人际关系"></a>社交-人际关系</h3><ul><li><a href="https://www.golgozar.org/index.php">Golgozar</a> - 社交搜索引擎</li><li><a href="https://www.genesreunited.co.uk/">Genes Reunited</a> - 通过族谱、家庭故事寻找家人的网站</li><li><a href="http://www.ukbirthadoptionregister.com/search.php">UK Birth Adoption Register</a> - 英国出生收养登记册</li><li><a href="https://www.social-searcher.com/">Social Searcher</a> - 社交媒体搜索引擎</li><li><a href="https://buzzglobe.com/">Buzzglobe.com</a> - 社交媒体搜索引擎</li><li><a href="https://www.theenginuity.com/search/">Enginuity Social Search</a> - 社交媒体搜索引擎</li><li><a href="https://www.social-searcher.com/google-social-search/">Google Social Search</a> - 社交媒体搜索引擎</li><li><a href="http://www.findwith.me/">Findwith.me</a> - 社交媒体搜索引擎</li><li><a href="https://anymailfinder.com/">Anymail finder</a> - 输入人名和公司名称，查找任何人的email地址</li><li><a href="https://littlesis.org/">LittleSis</a></li></ul><h3 id="企业信息"><a href="#企业信息" class="headerlink" title="企业信息"></a>企业信息</h3><ul><li><a href="https://www.qichacha.com/">企查查</a> - 工商信息查询_公司企业注册信息查询_全国企业信用信息公示系统</li><li><a href="http://www.gsxt.gov.cn/index.html">国家企业信用信息公示系统</a></li><li><a href="https://www.tianyancha.com/">天眼查</a> - 企业信息调查工具_企业信息查询_公司查询_工商查询_信用查询平台</li><li><a href="https://www.qixin.com/">启信宝</a> - 企业注册信息查询|企业工商信息查询|企业信用信息查询平台</li><li><a href="http://www.ixy360.com/">企业信用信息查询</a></li><li><a href="http://www.xizhi.com/">悉知</a> - 企业信息查询</li><li><a href="https://www.x315.com/">信用视界</a> - 企业信息查询_公司查询_企业信用信息查询_企业工商信息查询_企业注册信息查询_工商登记信息查询</li><li><a href="http://credit.customs.gov.cn/">中国海关企业进出口信用信息公示平台</a></li><li><a href="https://www.kanzhun.com/">看准网</a> - 查工资|聊面试|评公司|搜职位</li><li><a href="https://www.jobui.com/">职友集</a></li><li><a href="https://www.crunchbase.com/">Crunchbase: Discover innovative companies and the people behind them</a></li><li><a href="https://www.corporationwiki.com/">Corporation Wiki</a></li><li><a href="https://us.kompass.com/">Global B2B Online Directory</a></li><li><a href="https://www.manta.com/">Manta</a></li><li><a href="https://opencorporates.com/">OpenCorporates</a> - 世界上最大的企业开放数据库</li><li><a href="https://www.brownbook.net/">brownbook</a></li><li><a href="https://www.spokeo.com/">Spokeo</a></li><li><a href="https://biznar.com/biznar/desktop/en/search.html">Biznar</a></li><li><a href="https://www.northdata.de/">North Data Smarte Recherche</a> - 德国公司注册和公告（付费）信息</li><li><a href="https://find-and-update.company-information.service.gov.uk/">Companies House service</a> - 英国公司信息</li><li><a href="http://opengazettes.com/">OpenGazettes</a> - 欧洲商业活动的情报</li><li><a href="https://enigma.com/">Enigma</a></li><li><a href="https://www.sec.gov/edgar/searchedgar/companysearch.html">SEC.gov | Company Search Page</a> - 证券交易委员会文件的数据库</li></ul><p><strong>供应商</strong></p><ul><li><a href="https://www.thomasnet.com/">Thomasnet®</a></li></ul><h3 id="博客搜索"><a href="#博客搜索" class="headerlink" title="博客搜索"></a>博客搜索</h3><ul><li><a href="https://blogs.botw.org/">Best of the Web Blog Directory</a></li><li><a href="http://www.blogdire.com/">Blog Directory - BlogDire</a></li><li><a href="https://blogville.us/">Blog Directory - Submit Your Blog to the Blogville Directory</a></li><li><a href="http://blog-directory.org/">Blog Directory, Submit your blogs today, Blog directories search engine</a></li><li><a href="http://blogflux.com/">Blog Flux</a></li><li><a href="https://www.blog-search.com/">Blog Search : Blog Search Engine Directory</a></li><li><a href="http://blogtopsites.com/">Blog Top Sites - Directory of the Best Blog Sites</a></li><li><a href="https://www.blogarama.com/">Blogarama - Blog directory</a></li><li><a href="https://www.blogs-collection.com/">Blogs Directory - Blogs-Collection.com</a></li><li><a href="http://www.blogdumps.com/index.php">Social Network, Blog Directory, Blog Search Engine, Free Blog Hosting</a></li><li><a href="https://createandgo.com/blog-search/">Blog Search</a></li><li><a href="https://www.bloggingfusion.com/">Blogging Fusion - Blog Directory - Article Directory - RSS Directory - Web Directory</a></li><li><a href="https://blawgsearch.justia.com/">Justia Blawg Search - Law Blogs, Lawyer Blogs, Legal Blogs Directory &amp; Search Engine</a></li><li><a href="https://searchblogspot.com/">Blogspot Blog Search</a></li><li><a href="https://yougotblogs.com/">Prepare for Meetings - Selling Intel Search Engine</a></li></ul><hr><h1 id="文件资源"><a href="#文件资源" class="headerlink" title="文件资源"></a>文件资源</h1><h2 id="PDF"><a href="#PDF" class="headerlink" title="PDF"></a>PDF</h2><ul><li><a href="https://www.pdfsearch.io/">PDFSEARCH.IO - Document Search Engine</a></li><li><a href="https://freefullpdf.com/#gsc.tab=0">PDF search engine for free scientific publications - FreeFullPDF</a></li><li><a href="https://pdfsecret.com/">Documents Free Download PDF</a></li><li><a href="https://pdfbook-s.com/">PDF Books for Download</a></li><li><a href="https://printfu.org/">PDF Search Engine, free search, PDF download</a></li><li><a href="https://search.pdf-archive.com/">PDF Search engine | Find public PDF documents</a></li><li><a href="https://pdfsearches.com/">PDF Search Engine - Free download PDF files</a></li><li><a href="https://www.pdfdrive.com/">PDF Drive - Search and download PDF files for free.</a></li><li><a href="http://www.pdfgeni.com/">Free PDF Search Engine</a></li></ul><h2 id="音乐"><a href="#音乐" class="headerlink" title="音乐"></a>音乐</h2><ul><li><a href="https://www.midomi.com/">midomi</a></li></ul><hr><h1 id="天气-环境"><a href="#天气-环境" class="headerlink" title="天气-环境"></a>天气-环境</h1><ul><li><a href="https://bennettfeely.com/antiweather/">Antiweather</a> - 寻找对蹠点(位于地球直径两端的点)</li><li><a href="https://aqicn.org/map/cn/">亚洲空气污染</a> - 实时空气质量指数地图</li><li><a href="https://earth.nullschool.net/">earth</a> - 风、天气和海洋状况全球地图</li><li><a href="https://www.windy.com/">Windy</a> - 风向图和天气预报</li><li><a href="http://typhoon.zjwater.gov.cn/default.aspx">台风路径实时发布系统</a></li><li><a href="https://www.lightpollutionmap.info/">Light pollution map</a> - 光污染地图</li><li><a href="https://www2.purpleair.com/">PurpleAir</a> - 实时空气质量监测</li></ul><hr><h1 id="地图"><a href="#地图" class="headerlink" title="地图"></a>地图</h1><ul><li><a href="http://map.tianditu.gov.cn/">天地图</a> - 国家测绘地理信息局建设的地理信息综合服务网站</li><li><a href="https://www.amap.com/">高德地图</a></li><li><a href="https://map.baidu.com/">百度地图</a></li><li><a href="https://cn.bing.com/ditu/">Bing 地图</a></li><li><a href="https://www.google.cn/maps/">Google Maps</a></li><li><a href="https://www.google.com/earth/">Google Earth</a><ul><li><a href="https://earthengine.google.com/timelapse/">Google Earth Timelapse</a> - 查看数十年来世界变化的地图</li></ul></li><li><a href="https://www.openstreetmap.org/">OpenStreetMap</a> - OpenStreetMap是由一个地图绘制者社区建立的，他们提供并维护世界各地的道路、小径、咖啡馆、火车站等数据。</li><li><a href="https://www.waze.com/live-map">Waze</a></li></ul><h2 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h2><ul><li><a href="https://he.net/3d-map/">HE 3D Network Map</a> - 3D版海底电缆地图</li><li><a href="https://umap.openstreetmap.fr/zh-tw/map/japan-night-life_245233#6/37.892/140.361">Japan Night Life - uMap</a> - 日本夜遊地圖</li><li><a href="https://earthexplorer.usgs.gov/">EarthExplorer</a> - 在线访问美国遥感数据</li><li><a href="https://www.submarinecablemap.com/">Submarine Cable Map</a> - 海底电缆地图</li><li><a href="https://www.carbonbrief.org/mapped-the-worlds-nuclear-power-plants">Carbon Brief</a> - 世界上的核电站</li><li><a href="https://www.ageeye.cn/">发现中国</a></li><li><a href="https://mega.nz/file/o34z3aZY#nnA8_AioA35c-Jtq3dY0nqr52aH0PuU218Oa8ocoBJY">俄罗斯军事基地的位置</a></li><li><a href="https://soar.earth/">Soar</a> - 提供卫星，航空和无人机图像</li><li><a href="https://mrdata.usgs.gov/mrds/map-us.html">Mineral Resources Data System: US</a> - 美国地质调查局(USGS)提供全球矿产资源的历史数据，包括矿山所有权的信息</li></ul><h2 id="网络威胁"><a href="#网络威胁" class="headerlink" title="网络威胁"></a>网络威胁</h2><p><code>偷偷告诉你,这里面,好几个,都是假的</code></p><ul><li><a href="https://threatmap.fortiguard.com/">Fortinet Threat Map</a> - Fortinet 威胁地图</li><li><a href="https://threatmap.checkpoint.com/ThreatPortal/livemap.html">Live Cyber Attack Threat Map</a> - checkpoint 网络威胁地图</li><li><a href="https://www.fireeye.com/cyber-map/threat-map.html">FireEye Cyber Threat Map</a> - FireEye 网络威胁地图</li><li><a href="https://www.akamai.com/cn/zh/resources/visualizing-akamai">可视化全球互联网性能</a> - Akamai 提供的互联网监控器</li><li><a href="https://cybermap.kaspersky.com/">Kaspersky Cyberthreat real-time map</a> - Kaspersky 网络威胁实时地图</li><li><a href="https://www.digitalattackmap.com/">Digital Attack Map</a> - 展示全球每天最多的 DDoS 攻击(巨卡无比!!!)</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;在数字时代，如何保护个人隐私？这篇文章或许能帮到你。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;此文系转载&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Privacy" scheme="https://blog.gcdd.top/tags/Privacy/"/>
    
  </entry>
  
  <entry>
    <title>Apereo CAS | Rest API实践</title>
    <link href="https://blog.gcdd.top/p/2526/"/>
    <id>https://blog.gcdd.top/p/2526/</id>
    <published>2021-06-23T08:03:24.000Z</published>
    <updated>2023-08-30T04:52:53.896Z</updated>
    
    <content type="html"><![CDATA[<p>本文整理了单点登录系统 <a href="https://apereo.github.io/cas">CAS</a> 提供的<code>Rest API</code>，并给出了示例。</p><blockquote><p>本文基于<code>CAS 6.3.4</code>，并基于<a href="https://github.com/apereo/cas-overlay-template">cas-overlay-template</a>搭建的<code>cas</code>项目</p></blockquote><span id="more"></span>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文整理了单点登录系统 &lt;a href=&quot;https://apereo.github.io/cas&quot;&gt;CAS&lt;/a&gt; 提供的&lt;code&gt;Rest API&lt;/code&gt;，并给出了示例。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本文基于&lt;code&gt;CAS 6.3.4&lt;/code&gt;，并基于&lt;a href=&quot;https://github.com/apereo/cas-overlay-template&quot;&gt;cas-overlay-template&lt;/a&gt;搭建的&lt;code&gt;cas&lt;/code&gt;项目&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="SSO" scheme="https://blog.gcdd.top/tags/SSO/"/>
    
    <category term="CAS" scheme="https://blog.gcdd.top/tags/CAS/"/>
    
  </entry>
  
  <entry>
    <title>Apereo CAS | 修改登录页样式</title>
    <link href="https://blog.gcdd.top/p/63354/"/>
    <id>https://blog.gcdd.top/p/63354/</id>
    <published>2021-06-23T02:42:17.000Z</published>
    <updated>2023-08-30T04:52:53.896Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍单点登录系统<a href="https://apereo.github.io/cas">CAS</a>自定义登录页样式。</p><blockquote><p>本文基于<code>CAS 6.3.4</code>，并基于<a href="https://github.com/apereo/cas-overlay-template">cas-overlay-template</a>搭建的<code>cas</code>项目</p></blockquote><span id="more"></span><h1 id="1、下载源码"><a href="#1、下载源码" class="headerlink" title="1、下载源码"></a>1、下载源码</h1><p>去<a href="https://github.com/apereo/cas">官网</a>下载<code>cas</code>源码</p><p><img src="/asserts/images/Apereo-CAS%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E9%A1%B5%E6%A0%B7%E5%BC%8F/image-20210623104839468.png" alt="image-20210623104839468"></p><p>国内的朋友，可以试试这款<code>Github</code><a href="https://github.com/fhefh2015/Fast-GitHub">加速插件</a></p><h1 id="2、解压源码，找到cas-server-support-thymeleaf"><a href="#2、解压源码，找到cas-server-support-thymeleaf" class="headerlink" title="2、解压源码，找到cas-server-support-thymeleaf"></a>2、解压源码，找到<code>cas-server-support-thymeleaf</code></h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> cas-master</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">api/          core/  gradle/            gradlew.bat    NOTICE       settings.gradle  testcas.sh*</span><br><span class="line">build.gradle  docs/  gradle.properties  LICENSE        README.md    style/           webapp/</span><br><span class="line">ci/           etc/   gradlew*           lombok.config  release.sh*  support/</span><br><span class="line">$ <span class="built_in">cd</span> support/cas-server-support-thymeleaf/src/main/resources/</span><br><span class="line">cas-theme-default.properties --&gt; cas主题配置</span><br><span class="line">messages_fr.properties --&gt; </span><br><span class="line">...</span><br><span class="line">META-INF/ </span><br><span class="line">static/ --&gt; 静态内容</span><br><span class="line">templates/ --&gt; thymeleaf模板</span><br><span class="line">$ <span class="built_in">cd</span> static</span><br><span class="line">css/  favicon.ico  images/  js/</span><br><span class="line">$ <span class="built_in">cd</span> ../templates/</span><br><span class="line">...</span><br><span class="line">layout.html</span><br><span class="line">error.html</span><br></pre></td></tr></table></figure><p><img src="/asserts/images/Apereo-CAS%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E9%A1%B5%E6%A0%B7%E5%BC%8F/image-20210623105623581.png" alt="image-20210623105623581"></p><h1 id="3、复制到项目，修改"><a href="#3、复制到项目，修改" class="headerlink" title="3、复制到项目，修改"></a>3、复制到项目，修改</h1><blockquote><p>修改的时候，遵循以下原则</p><ul><li>只复制需要修改的文件到<code>src/main/resources/</code>，避免项目冗余和向上兼容</li><li>尽量不更改模板文件结构，例如<code>id</code>，<code>class</code>元素</li><li>不使用的部分，用注释代替删除，方便还原</li></ul></blockquote><p>一般来说，我们只需要修改以下几个文件即可</p><ul><li><code>cas-master/support/cas-server-support-thymeleafsrc/main/resources/static/css/cas.css</code>\</li><li><code>cas-master/support/cas-server-support-thymeleaf/src/main/resources/templates/layout.html</code></li><li><code>cas-master/support/cas-server-support-thymeleaf/src/main/resources/templates/login/casLoginView.html</code></li></ul><p>注意，虽然<code>login/casLoginView.html</code>位于<code>login</code>目录下，但是复制到<code>cas-overlay</code>时，需要位于<code>src/main/resources</code></p><p>最终<code>cas-overlay</code>的目录结构</p><p><img src="/asserts/images/Apereo-CAS%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E9%A1%B5%E6%A0%B7%E5%BC%8F/image-20210623154807590.png" alt="image-20210623154807590"></p><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://apereo.github.io/cas/6.3.x/ux/User-Interface-Customization.html">User-Interface-Customization</a></li><li><a href="https://www.thymeleaf.org/">Thymeleaf</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍单点登录系统&lt;a href=&quot;https://apereo.github.io/cas&quot;&gt;CAS&lt;/a&gt;自定义登录页样式。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本文基于&lt;code&gt;CAS 6.3.4&lt;/code&gt;，并基于&lt;a href=&quot;https://github.com/apereo/cas-overlay-template&quot;&gt;cas-overlay-template&lt;/a&gt;搭建的&lt;code&gt;cas&lt;/code&gt;项目&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="SSO" scheme="https://blog.gcdd.top/tags/SSO/"/>
    
    <category term="CAS" scheme="https://blog.gcdd.top/tags/CAS/"/>
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes部署csi-driver</title>
    <link href="https://blog.gcdd.top/p/20900/"/>
    <id>https://blog.gcdd.top/p/20900/</id>
    <published>2021-06-19T18:52:38.000Z</published>
    <updated>2023-08-30T04:52:53.900Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍在<code>k8s</code>集群中部署<code>nfs-csi-driver</code></p><span id="more"></span><h1 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h1><ul><li>Docker</li><li>Kubernetes（本文是基于Rancher的RKE集群）</li></ul><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>csi-driver</code>是非常丰富的，新搭建的集群，推荐使用阿里云的<code>NAS</code>作为存储后端（<code>NAS</code>对比云盘，扩展性高、费用低、容错好），使用阿里云提供的<a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/nas.md">NAS CSI Plugin</a>进行<code>csi-driver</code>的安装。</p><p>对于有云盘的<code>ECS</code>或者本地服务器来说，可以使用<code>NFS</code>作为存储后端，k8s官方提供了<a href="https://github.com/kubernetes-csi/csi-driver-nfs">nfs-csi-driver</a></p><p>如果是阿里的<code>ECS</code>，还可以使用阿里提供的<a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/disk.md">disk-csi-driver</a>，使用云盘作为存储后端（有<strong>单机故障</strong>的风险）</p><h1 id="部署nfs-csi-driver"><a href="#部署nfs-csi-driver" class="headerlink" title="部署nfs-csi-driver"></a>部署<code>nfs-csi-driver</code></h1><h2 id="1、安装nfs-server"><a href="#1、安装nfs-server" class="headerlink" title="1、安装nfs-server"></a>1、安装<code>nfs-server</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择一台主机，安装nfs-server</span></span><br><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install nfs-kernel-server</span><br><span class="line">$ <span class="built_in">mkdir</span> -p /data/nfs</span><br><span class="line">$ sudo vim /etc/fstab</span><br><span class="line">172.16.1.23:/data/nfs /data/nfs    nfs defaults,timeo=900,retrans=5,_netdev    0 0</span><br><span class="line">$ sudo vim /etc/exports</span><br><span class="line">/data/nfs    172.16.1.23/12(rw,<span class="built_in">sync</span>,all_squash,anonuid=1001,anongid=1001,no_subtree_check) <span class="comment"># 这里设置anonuid和anongid，是为了便于部署bitnami提供的helm charts</span></span><br><span class="line">$ sudo exportfs -ra</span><br><span class="line"><span class="comment"># bitnami提供的helm-chart的fsGroup默认是1001，如果1001的用户被占用，可以修改用户的uid和gid，将1001空出来给bitnami使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他主机，配置nfs-client</span></span><br><span class="line">$ apt install nfs-common</span><br><span class="line">$ sudo mount -t nfs -o vers=4 172.16.1.23:/data/nfs /data/nfs</span><br><span class="line"></span><br><span class="line">$ sudo vim /etc/fstab</span><br><span class="line">172.16.1.23:/data/nfs /data/nfs    nfs defaults,timeo=900,retrans=5,_netdev    0 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试nfs访问</span></span><br><span class="line"><span class="comment"># 在任意一台机器上创建、修改、删除文件，在其他机器上会对应列出修改</span></span><br></pre></td></tr></table></figure><h2 id="2、安装nfs-csi-driver"><a href="#2、安装nfs-csi-driver" class="headerlink" title="2、安装nfs-csi-driver"></a>2、安装<code>nfs-csi-driver</code></h2><p>这里有个小插曲，由于国内的网络环境，无法下载谷歌的docker镜像，所以只能一个个的把它们转到dockerhub上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker pull k8s.gcr.io/sig-storage/livenessprobe:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker tag k8s.gcr.io/sig-storage/livenessprobe:v2.1.0 qq1398371419/gcr.sig-storage.livenessprobe:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker push qq1398371419/gcr.sig-storage.livenessprobe:v2.1.0</span><br><span class="line"></span><br><span class="line">docker pull k8s.gcr.io/sig-storage/csi-provisioner:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker tag k8s.gcr.io/sig-storage/csi-provisioner:v2.1.0 qq1398371419/gcr.sig-storage.csi-provisioner:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker push qq1398371419/gcr.sig-storage.csi-provisioner:v2.1.0</span><br><span class="line">    </span><br><span class="line">docker pull k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker tag k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.1.0 qq1398371419/gcr.sig-storage.csi-node-driver-registrar:v2.1.0 \</span><br><span class="line">    &amp;&amp; docker push qq1398371419/gcr.sig-storage.csi-node-driver-registrar:v2.1.0</span><br></pre></td></tr></table></figure><p>安装<code>nfs-csi-driver</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -skSL https://gitee.com/qq1398371419/csi-driver-nfs/raw/master/deploy/install-driver.sh | bash -s master --</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/06/20/lLBaReX3HkDdiur.png" alt="Image"></p><h2 id="3、安装StorageClass"><a href="#3、安装StorageClass" class="headerlink" title="3、安装StorageClass"></a>3、安装<code>StorageClass</code></h2><p><code>nfs-sc.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-csi</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs.csi.k8s.io</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.23</span> <span class="comment"># 这里改成自己的内网IP</span></span><br><span class="line">  <span class="attr">share:</span> <span class="string">/data/nfs</span> <span class="comment"># 这里改成自己的nfs共享目录</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">Immediate</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f nfs-sc.yaml</span><br></pre></td></tr></table></figure><h2 id="4、测试部署Redis"><a href="#4、测试部署Redis" class="headerlink" title="4、测试部署Redis"></a>4、测试部署<code>Redis</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ vim redis-test.yaml</span><br><span class="line">---</span><br><span class="line">master:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: nfs-csi</span><br><span class="line">  service:</span><br><span class="line">    nodePort: 30001</span><br><span class="line">    <span class="built_in">type</span>: NodePort</span><br><span class="line">replica:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: nfs-csi</span><br><span class="line">auth:</span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm install my-release bitnami/redis -f redis-test.yaml</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/06/20/dDX954OPA3nBKmi.png" alt="image-20210620031253181"></p><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><blockquote><p>前面提到的设置anonuid和anongid，是因为部署<code>bitnami</code>提供的<code>helm charts</code>遇到了无法写入文件的问题，之所以设置为1001，因为bitnami默认的uid是1001</p></blockquote><p><img src="https://i.loli.net/2021/06/20/ybG6rDFjchtZHla.png" alt="Image"></p><p>容器对于mount的路径的访问权限问题，可以参考<a href="https://www.cnblogs.com/sammyliu/p/10129670.html">https://www.cnblogs.com/sammyliu/p/10129670.html</a></p><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://kubernetes-csi.github.io/docs/drivers.html">Kubernetes CSI Developer Documentation</a></li><li><a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver">alibaba-cloud-csi-driver</a></li><li><a href="https://github.com/kubernetes-csi">Kubernetes CSI</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍在&lt;code&gt;k8s&lt;/code&gt;集群中部署&lt;code&gt;nfs-csi-driver&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Kubernetes" scheme="https://blog.gcdd.top/tags/Kubernetes/"/>
    
    <category term="Docker" scheme="https://blog.gcdd.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Dubbo使用Kryo序列化协议的思考</title>
    <link href="https://blog.gcdd.top/p/13982/"/>
    <id>https://blog.gcdd.top/p/13982/</id>
    <published>2021-06-19T18:04:07.000Z</published>
    <updated>2023-08-30T04:52:53.898Z</updated>
    
    <content type="html"><![CDATA[<p>本文是使用<code>Dubbo</code>过程中的一些思考，不足以作为参考，只为留存记录。</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Dubbo</code>官方推荐使用<code>kryo</code>或者<code>fst</code>作为<code>RPC</code>序列化协议，原因是这两款序列化协议，性能显著优于其他序列化协议。虽然高效，但其实<code>Dubbo</code>对这两款的支持却不是那么理想，导致使用过程中出现了一些问题</p><h1 id="多服务下kryo序列化问题"><a href="#多服务下kryo序列化问题" class="headerlink" title="多服务下kryo序列化问题"></a>多服务下<code>kryo</code>序列化问题</h1><h2 id="Q1、无法使用kryo类索引红利"><a href="#Q1、无法使用kryo类索引红利" class="headerlink" title="Q1、无法使用kryo类索引红利"></a>Q1、无法使用<code>kryo</code>类索引红利</h2><blockquote><p>在多模块协作的系统中，无法保证服务提供方和消费方<code>DTO</code>数量以及注册顺序的一致，可能A作为服务提供方，提供了<code>DTO</code>，而B作为消费方，可能同时消费A、C的服务，同时自身也对外提供服务，在使用<code>Kryo</code>序列化时，需要同时注册A、B、C服务的<code>DTO</code>。</p></blockquote><p>例如A系统的<code>SerializationOptimizer</code>实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASerializationOptimizerImpl</span> <span class="keyword">implements</span> <span class="title class_">SerializationOptimizer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> A1.class;</span><br><span class="line">        <span class="keyword">return</span> A2.class;</span><br><span class="line">        <span class="keyword">return</span> A3.class;</span><br><span class="line">        <span class="keyword">return</span> A4.class;</span><br><span class="line">        <span class="keyword">return</span> C1.class;</span><br><span class="line">        <span class="keyword">return</span> C2.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>B系统的<code>SerializationOptimizer</code>实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BSerializationOptimizerImpl</span> <span class="keyword">implements</span> <span class="title class_">SerializationOptimizer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> A1.class;</span><br><span class="line">        <span class="keyword">return</span> A2.class;</span><br><span class="line">        <span class="keyword">return</span> A3.class;</span><br><span class="line">        <span class="keyword">return</span> A4.class;</span><br><span class="line">        <span class="keyword">return</span> B1.class;</span><br><span class="line">        <span class="keyword">return</span> B2.class;</span><br><span class="line">        <span class="keyword">return</span> C1.class;</span><br><span class="line">        <span class="keyword">return</span> C2.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要说明的是，<code>kryo</code>之所以高效，不仅仅是因为其二进制序列化，更由于其可以预先为待序列化的类指定索引，在<code>RPC</code>传输过程中，只需要使用索引代替全类名，在类使用非常频繁的情况下，可以节省大量字节，从而大大提升传输效率。</p><p>而<code>Dubbo</code>似乎也意识到了这个问题，所以将一些使用频繁的类进行了预处理，见<code>org.apache.dubbo.common.serialize.kryo.utils.AbstractKryoFactory#create</code></p><p>但是其中很重要的一处</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SerializableClassRegistry.getRegisteredClasses().forEach((clazz, ser) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ser == <span class="literal">null</span>) &#123;</span><br><span class="line">        kryo.register(clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        kryo.register(clazz, (Serializer) ser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>使用的是<code>kryo.register(clazz)</code>，无法指定<code>kryo class index</code>，这里我分析了一下，可能是为了兼容老的序列化协议，比如<code>json</code>等，而且<code>SerializableClassRegistry</code>是很早就有的接口，并没有考虑到类索引的问题。</p><p>所以这里要注册的话，只能将项目内所有类都写到同一个<code>jar</code>中，然后写一个统一的<code>SerializationOptimizer</code>实现。</p><p>这在微服务系统中是无法实现的，因为每个服务必然会提供自己的<code>dto.jar</code>和<code>dubbo-service.jar</code>，而且服务之间也不可能依赖其他所有的服务，所以这一条无法满足。</p><p>这样一来，类的注册顺序不能保证，类的数量也无法保证，所以<code>Dubbo</code>的<code>kryo</code>序列化只能说在一定程度上提升了效率，但是并没有完全发挥出<code>kryo</code>的性能优势。</p><h2 id="Q2、社区不活跃"><a href="#Q2、社区不活跃" class="headerlink" title="Q2、社区不活跃"></a>Q2、社区不活跃</h2><blockquote><p>虽然阿里重启了<code>Dubbo</code>，并且加入了<code>Apache</code>进行孵化，但是社区相较于<code>Spring Cloud</code>，还是不够活跃，而且阿里的开源产品，多多少少带了点阿里内部的味道，不如<code>Spring Cloud</code>通用和考虑周全。一些功能我们不需要（比如<code>dubbo</code>注册时的一堆参数，很多都是需要阿里的一套开发体系才能使用到），我们需要的又迟迟不添加（<code>kryo</code>的<code>ClassId</code>支持）。</p></blockquote><p>所以目前项目已经全面切换到<code>Spring Cloud Kubernetes</code>，有时间也会总结一下<code>Dubbo</code>切换到<code>Spring Cloud</code>的经验，以及在云原生时代<code>Spring Cloud</code>所做出的努力。</p><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://github.com/apache/dubbo/issues/7015">Dubbo Issue</a></li><li><a href="https://dubbo.apache.org/zh/docs/v2.7/user/serialization/">Kryo 和 FST 序列化</a></li><li><a href="https://github.com/EsotericSoftware/kryo">Kryo序列化协议</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文是使用&lt;code&gt;Dubbo&lt;/code&gt;过程中的一些思考，不足以作为参考，只为留存记录。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Dubbo" scheme="https://blog.gcdd.top/tags/Dubbo/"/>
    
  </entry>
  
  <entry>
    <title>Gradle 配置片段</title>
    <link href="https://blog.gcdd.top/p/9306/"/>
    <id>https://blog.gcdd.top/p/9306/</id>
    <published>2021-06-19T17:29:55.000Z</published>
    <updated>2023-08-30T04:52:53.898Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍<code>Gradle</code>常用配置，本人很早就开始使用<code>Gradle</code>代替<code>Maven</code>作为项目构建工具，<code>Gradle</code>相较于<code>Maven</code>繁琐的XML配置来说，确实更为先进，依托于<code>Groovy</code>脚本的强大，也更加灵活。</p><span id="more"></span><h1 id="1、Jetbrains-IDEA设置Gradle不自动创建模块"><a href="#1、Jetbrains-IDEA设置Gradle不自动创建模块" class="headerlink" title="1、Jetbrains IDEA设置Gradle不自动创建模块"></a>1、<code>Jetbrains IDEA</code>设置<code>Gradle</code>不自动创建模块</h1><blockquote><p>在IDEA某个版本之后，创建或导入Gradle项目的时候，无法再取消勾选<code>Create separate module per source set</code>，多少有点强加的意思，因为自动为每个资源文件夹创建一个目录，模块多了以后，会出现意料之外的错误，比如某个依赖无法加载等问题</p></blockquote><p><img src="https://i.loli.net/2021/06/20/B7wOGUqHK62mQ9C.png"></p><p>编辑<code>.idea/gradle.xml</code>，加上一行<code>&lt;option name=&quot;resolveModulePerSourceSet&quot; value=&quot;false&quot; /&gt;</code>就行</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">version</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;GradleMigrationSettings&quot;</span> <span class="attr">migrationVersion</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;GradleSettings&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;linkedExternalProjectsSettings&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">GradleProjectSettings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;delegatedBuild&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;testRunner&quot;</span> <span class="attr">value</span>=<span class="string">&quot;GRADLE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;distributionType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;LOCAL&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;externalProjectPath&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$PROJECT_DIR$&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;gradleHome&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$PROJECT_DIR$/../../../../DevTools/Gradle/gradle-6.8.3&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;gradleJvm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#JAVA_HOME&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;resolveModulePerSourceSet&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">GradleProjectSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后重新导入<code>Gradle</code>项目</p><h1 id="2、使用阿里云Maven仓库加速依赖下载"><a href="#2、使用阿里云Maven仓库加速依赖下载" class="headerlink" title="2、使用阿里云Maven仓库加速依赖下载"></a>2、使用阿里云<code>Maven</code>仓库加速依赖下载</h1><blockquote><p><code>Gradle 6.8.3</code>即以上适用</p></blockquote><p>编辑<code>settings.gradle</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        repositories &#123;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/google&#x27;</span> &#125;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/gradle-plugin&#x27;</span> &#125;</span><br><span class="line">            maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/public/&#x27;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mavenCentral()</span><br><span class="line">        gradlePluginPortal()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenLocal()</span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>) &#125; <span class="comment">// central</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span>) &#125; <span class="comment">// jcenter &amp; public</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span>) &#125; <span class="comment">// google</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/spring&quot;</span>) &#125; <span class="comment">// spring</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/spring-plugin&quot;</span>) &#125; <span class="comment">// spring plugin</span></span><br><span class="line">        maven &#123; url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/grails-core&quot;</span>) &#125; <span class="comment">// spring plugin</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">rootProject.name = <span class="string">&#x27;my-prject&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="3、maven-publish-gradle"><a href="#3、maven-publish-gradle" class="headerlink" title="3、maven-publish.gradle"></a>3、<code>maven-publish.gradle</code></h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jar添加以下插件</span></span><br><span class="line"><span class="comment">//plugins &#123;</span></span><br><span class="line"><span class="comment">//    id &#x27;java-library&#x27;</span></span><br><span class="line"><span class="comment">//    id &#x27;maven-publish&#x27;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">// bom添加以下插件</span></span><br><span class="line"><span class="comment">//plugins &#123;</span></span><br><span class="line"><span class="comment">//    id &#x27;java-platform&#x27;</span></span><br><span class="line"><span class="comment">//    id &#x27;maven-publish&#x27;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> artifactory = <span class="string">&#x27;https://packages.aliyun.com/maven/repository/&#x27;</span></span><br><span class="line"><span class="keyword">def</span> releasePath = <span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="keyword">def</span> snapshotsPath = <span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="keyword">def</span> mavenName = <span class="string">&#x27;my-project&#x27;</span></span><br><span class="line">afterEvaluate &#123; Project project -&gt;</span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(<span class="string">&quot;maven-publish&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (project.plugins.hasPlugin(<span class="string">&quot;java&quot;</span>)) &#123;</span><br><span class="line">            java &#123;</span><br><span class="line">                withSourcesJar()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        publishing &#123;</span><br><span class="line">            repositories &#123;</span><br><span class="line">                maven &#123;</span><br><span class="line">                    name <span class="string">&quot;$&#123;mavenName&#125;&quot;</span></span><br><span class="line">                    url = <span class="string">&quot;$&#123;artifactory&#125;$&#123;(version.endsWith(&#x27;SNAPSHOT&#x27;) ? snapshotsPath : releasePath)&#125;&quot;</span></span><br><span class="line">                    credentials &#123;</span><br><span class="line">                        username <span class="string">&quot;$&#123;maven_username&#125;&quot;</span></span><br><span class="line">                        password <span class="string">&quot;$&#123;maven_password&#125;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    authentication &#123;</span><br><span class="line">                        basic(BasicAuthentication)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            publications &#123;</span><br><span class="line">                omac(MavenPublication) &#123;</span><br><span class="line">                    from components.java</span><br><span class="line">                    versionMapping &#123;</span><br><span class="line">                        usage(<span class="string">&#x27;java-api&#x27;</span>) &#123;</span><br><span class="line">                            fromResolutionOf(<span class="string">&#x27;runtimeClasspath&#x27;</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        usage(<span class="string">&#x27;java-runtime&#x27;</span>) &#123;</span><br><span class="line">                            fromResolutionResult()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>build.gradle</code>引入即可</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">&quot;$&#123;rootDir&#125;/gradle/maven-publish.gradle&quot;</span></span><br></pre></td></tr></table></figure><h1 id="4、docker-gradle"><a href="#4、docker-gradle" class="headerlink" title="4、docker.gradle"></a>4、<code>docker.gradle</code></h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">afterEvaluate &#123;</span><br><span class="line">    <span class="keyword">if</span> (pluginManager.hasPlugin(<span class="string">&quot;application&quot;</span>)) &#123;</span><br><span class="line">        task archiveDeps(<span class="attr">type:</span> Tar) &#123; task -&gt;</span><br><span class="line">            <span class="keyword">def</span> dependencies = task.project.configurations.runtimeClasspath.fileCollection &#123; <span class="literal">true</span> &#125;</span><br><span class="line">            from dependencies.sort()</span><br><span class="line">            compression = Compression.GZIP</span><br><span class="line">            archiveFileName = <span class="string">&quot;dep-libs.tar.gz&quot;</span></span><br><span class="line">            from jar.archiveFile</span><br><span class="line">            destinationDirectory = file(<span class="string">&quot;$buildDir/docker&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        task copyDeps(<span class="attr">type:</span> Copy) &#123;</span><br><span class="line">            dependsOn(archiveDeps)</span><br><span class="line">            from tarTree(resources.gzip(<span class="string">&quot;$buildDir/docker/dep-libs.tar.gz&quot;</span>))</span><br><span class="line">            into <span class="string">&quot;$buildDir/docker/libs/&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        task copyApp(<span class="attr">type:</span> Copy) &#123;</span><br><span class="line">            dependsOn(jar, startScripts)</span><br><span class="line">            from <span class="string">&quot;$buildDir/scripts/&quot;</span></span><br><span class="line">            from jar.outputs</span><br><span class="line">            into <span class="string">&quot;$buildDir/docker/&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        task prepare() &#123;</span><br><span class="line">            dependsOn(copyApp, copyDeps)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加插件<code>application</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&quot;application&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并配合以下<code>Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># First stage: complete build environment</span></span><br><span class="line"><span class="keyword">FROM</span> registry.cn-shanghai.aliyuncs.com/halmawork/gradle:<span class="number">6.8</span>.<span class="number">3</span>-jdk11-openj9 AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> MAVEN_USERNAME</span><br><span class="line"><span class="keyword">ARG</span> MAVEN_PASSWORD</span><br><span class="line"><span class="keyword">ARG</span> MODULE</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;org.gradle.daemon=false&quot;</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;org.gradle.parallel=true&quot;</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;maven_username=<span class="variable">$MAVEN_USERNAME</span>&quot;</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;maven_password=<span class="variable">$MAVEN_PASSWORD</span>&quot;</span> &gt;&gt; ~/.gradle/gradle.properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /builder</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /builder</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># package jar</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gradle :<span class="variable">$MODULE</span>:clean :<span class="variable">$MODULE</span>:prepare</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Second stage: minimal runtime environment</span></span><br><span class="line"><span class="keyword">FROM</span> adoptopenjdk/openjdk11:jre</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MODULE <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> name=<span class="variable">$MODULE</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -fs /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; dpkg-reconfigure -f noninteractive tzdata</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /builder/build/docker/libs/*.jar /app/lib/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /builder/build/docker/<span class="variable">$MODULE</span> /app/bin/run</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /builder/build/docker/<span class="variable">$MODULE</span>-*.jar /app/lib/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/app/bin/run&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>打包<code>docker</code>镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -f gradle/Dockerfile -t gcdd1993/demo:latest-snapshot .</span><br></pre></td></tr></table></figure><h1 id="5、支持kotlin"><a href="#5、支持kotlin" class="headerlink" title="5、支持kotlin"></a>5、支持<code>kotlin</code></h1><p><code>gradle.properties</code></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kotlin_version</span>=<span class="string">1.5.10</span></span><br></pre></td></tr></table></figure><p><code>build.gradle</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&quot;org.jetbrains.kotlin.jvm&quot;</span> version <span class="string">&quot;$&#123;kotlin_version&#125;&quot;</span> apply <span class="literal">false</span> <span class="comment">// jvm 插件</span></span><br><span class="line">    id <span class="string">&quot;org.jetbrains.kotlin.plugin.spring&quot;</span> version <span class="string">&quot;$&#123;kotlin_version&#125;&quot;</span> apply <span class="literal">false</span> <span class="comment">// spring 插件，allopen 插件</span></span><br><span class="line">    id <span class="string">&quot;org.jetbrains.kotlin.kapt&quot;</span> version <span class="string">&quot;$&#123;kotlin_version&#125;&quot;</span> apply <span class="literal">false</span> <span class="comment">// kapt，代替annotationProcessor</span></span><br><span class="line">    id <span class="string">&quot;org.jetbrains.kotlin.plugin.noarg&quot;</span> version <span class="string">&quot;$&#123;kotlin_version&#125;&quot;</span> apply <span class="literal">false</span> <span class="comment">// 用于自定义注解生成no arg constructor</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.jetbrains.kotlin.jvm&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.jetbrains.kotlin.plugin.spring&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.jetbrains.kotlin.kapt&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.jetbrains.kotlin.plugin.noarg&quot;</span></span><br><span class="line"></span><br><span class="line">compileKotlin &#123;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        freeCompilerArgs = [<span class="string">&quot;-Xjsr305=warn&quot;</span>]</span><br><span class="line">        jvmTarget = <span class="string">&quot;11&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">noArg &#123;</span><br><span class="line">    annotation(<span class="string">&quot;io.github.gcdd1993.NoArg&quot;</span>) <span class="comment">// 该注解注释的class，会生成NoArg Constructor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="6、限制项目JDK版本"><a href="#6、限制项目JDK版本" class="headerlink" title="6、限制项目JDK版本"></a>6、限制项目<code>JDK</code>版本</h1><blockquote><p>对于多人协同时，很有用，避免因为<code>JDK</code>版本不一导致的各种问题</p></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> javaVersion = System.getProperty(<span class="string">&quot;java.version&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (!javaVersion.startsWith(<span class="string">&quot;11&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Incompatible JRE version: &quot;</span> + javaVersion + <span class="string">&quot;. Use JRE 11 instead.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="7、为项目编译jar文件添加项目编译信息"><a href="#7、为项目编译jar文件添加项目编译信息" class="headerlink" title="7、为项目编译jar文件添加项目编译信息"></a>7、为项目编译<code>jar</code>文件添加项目编译信息</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&quot;org.springframework.boot&quot;</span> version <span class="string">&quot;$&#123;spring_boot_version&#125;&quot;</span> apply <span class="literal">false</span></span><br><span class="line">    id <span class="string">&quot;com.gorylenko.gradle-git-properties&quot;</span> version <span class="string">&quot;2.2.4&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;io.spring.dependency-management&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.springframework.boot&quot;</span></span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    enabled = <span class="literal">true</span></span><br><span class="line">    manifest &#123;</span><br><span class="line">        attributes(</span><br><span class="line">            <span class="string">&quot;Implementation-Title&quot;</span>: project.name,</span><br><span class="line">            <span class="string">&quot;Implementation-Version&quot;</span>: project.version,</span><br><span class="line">            <span class="string">&quot;Built-By&quot;</span>: System.properties[<span class="string">&quot;user.name&quot;</span>],</span><br><span class="line">            <span class="string">&quot;Build-Timestamp&quot;</span>: <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSSZ&quot;</span>).format(<span class="keyword">new</span> Date()),</span><br><span class="line">            <span class="string">&quot;Created-By&quot;</span>: <span class="string">&quot;Gradle $&#123;gradle.gradleVersion&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Build-Jdk&quot;</span>: <span class="string">&quot;$&#123;System.properties[&quot;</span>java.version<span class="string">&quot;]&#125; ($&#123;System.properties[&quot;</span>java.vendor<span class="string">&quot;]&#125; $&#123;System.properties[&quot;</span>java.vm.version<span class="string">&quot;]&#125;)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Build-OS&quot;</span>: <span class="string">&quot;$&#123;System.properties[&quot;</span>os.name<span class="string">&quot;]&#125; $&#123;System.properties[&quot;</span>os.arch<span class="string">&quot;]&#125; $&#123;System.properties[&quot;</span>os.version<span class="string">&quot;]&#125;&quot;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">springBoot &#123;</span><br><span class="line">    buildInfo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果是<code>Spring Boot</code>项目，还可以通过以下方法，在程序启动时，打印出编译信息</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在应用启动时，打印应用基本信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcdd1993</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/2/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppInfoPreviewAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> log = LoggerFactory.getLogger(javaClass)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> gitProperties: GitProperties? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> buildProperties: BuildProperties? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;\$&#123;spring.application.name&#125;&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> name: String? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener(ApplicationStartedEvent::class)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onBootUp</span><span class="params">(event: <span class="type">ApplicationStartedEvent</span>?)</span></span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125; Started.&quot;</span>, name)</span><br><span class="line">        <span class="keyword">if</span> (buildProperties != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;build.name : &#123;&#125;&quot;</span>, buildProperties.name)</span><br><span class="line">            log.info(<span class="string">&quot;build.artifact : &#123;&#125;&quot;</span>, buildProperties.artifact)</span><br><span class="line">            log.info(<span class="string">&quot;build.group : &#123;&#125;&quot;</span>, buildProperties.group)</span><br><span class="line">            log.info(<span class="string">&quot;build.version : &#123;&#125;&quot;</span>, buildProperties.version)</span><br><span class="line">            log.info(<span class="string">&quot;build.time : &#123;&#125;&quot;</span>, buildProperties.time.atZone(ZoneId.systemDefault()).toLocalDateTime())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;cannot find any build properties file from this project. please reference: https://stackoverflow.com/questions/47283048/how-to-capture-build-info-using-gradle-and-spring-boot.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (gitProperties != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;commit.branch : &#123;&#125;&quot;</span>, gitProperties.branch)</span><br><span class="line">            log.info(<span class="string">&quot;commit.commit.id : &#123;&#125;&quot;</span>, gitProperties.commitId)</span><br><span class="line">            log.info(<span class="string">&quot;commit.commit.time : &#123;&#125;&quot;</span>, gitProperties.commitTime.atZone(ZoneId.systemDefault()).toLocalDateTime())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;cannot find any git properties file from this project. please add gradle plugin: https://plugins.gradle.org/plugin/com.gorylenko.gradle-git-properties.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>未完待续。。。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍&lt;code&gt;Gradle&lt;/code&gt;常用配置，本人很早就开始使用&lt;code&gt;Gradle&lt;/code&gt;代替&lt;code&gt;Maven&lt;/code&gt;作为项目构建工具，&lt;code&gt;Gradle&lt;/code&gt;相较于&lt;code&gt;Maven&lt;/code&gt;繁琐的XML配置来说，确实更为先进，依托于&lt;code&gt;Groovy&lt;/code&gt;脚本的强大，也更加灵活。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Gradle" scheme="https://blog.gcdd.top/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>使用certbot给网站上免费的SSL证书</title>
    <link href="https://blog.gcdd.top/p/16060/"/>
    <id>https://blog.gcdd.top/p/16060/</id>
    <published>2021-06-19T16:55:06.000Z</published>
    <updated>2023-08-30T04:52:53.907Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍使用<a href="">certbot</a>为网站添加HTTPS支持，并自动更新</p><span id="more"></span><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><ul><li>docker</li><li>docker-compose</li></ul><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="克隆仓库"><a href="#克隆仓库" class="headerlink" title="克隆仓库"></a>克隆仓库</h2><blockquote><p>这一步必不可少，一定要按照作者的仓库目录结构来执行，完成后，可以自行更改<code>nginx/conf.d</code>下的配置文件。</p><p>具体原因我也不知，但是不照做，会出现一些奇怪的问题。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /data</span><br><span class="line">$ <span class="built_in">cd</span> /data</span><br><span class="line">$ git <span class="built_in">clone</span> https://ghproxy.com/https://github.com/gcdd1993/nginx-certbot</span><br><span class="line">$ <span class="built_in">cd</span> nginx-certbot</span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jun  8 22:01 ./</span><br><span class="line">drwxr-xr-x 5 root root 4096 Jun  8 21:49 ../</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jun  8 21:53 data/</span><br><span class="line">-rw-r--r-- 1 root root  660 Jun  8 21:49 docker-compose.yml</span><br><span class="line">drwxr-xr-x 8 root root 4096 Jun  8 21:49 .git/</span><br><span class="line">-rw-r--r-- 1 root root   14 Jun  8 21:49 .gitignore</span><br><span class="line">-rwxr-xr-x 1 root root 2286 Jun  8 22:01 init-letsencrypt.sh*</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jun  8 21:49 LICENSE</span><br><span class="line">-rw-r--r-- 1 root root 1376 Jun  8 21:49 README.md</span><br></pre></td></tr></table></figure><h2 id="为域名添加证书"><a href="#为域名添加证书" class="headerlink" title="为域名添加证书"></a>为域名添加证书</h2><blockquote><p>💡在这一步执行前，请确认已经将需要添加证书的域名指向本机公网IP，因为在执行过程中，会进行服务器所属权校验，需要访问你所操作的域名</p></blockquote><h3 id="1、修改init-letsencrypt-sh的email为你的邮箱"><a href="#1、修改init-letsencrypt-sh的email为你的邮箱" class="headerlink" title="1、修改init-letsencrypt.sh的email为你的邮箱"></a>1、修改<code>init-letsencrypt.sh</code>的<code>email</code>为你的邮箱</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim init-letsencrypt.sh</span><br><span class="line">...</span><br><span class="line">email=<span class="string">&quot;gcwm99@gmail.com&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="2、修改操作域名"><a href="#2、修改操作域名" class="headerlink" title="2、修改操作域名"></a>2、修改操作域名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/example.org/your_domain/g&#x27;</span> data/nginx/app.conf \</span><br><span class="line">&amp;&amp; sed -i <span class="string">&#x27;s/example.org/your_domain/g&#x27;</span> init-letsencrypt.sh</span><br></pre></td></tr></table></figure><h3 id="3、执行init-letsencrypt-sh"><a href="#3、执行init-letsencrypt-sh" class="headerlink" title="3、执行init-letsencrypt.sh"></a>3、执行<code>init-letsencrypt.sh</code></h3><blockquote><p>直到出现以下内容，说明已经完成</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./init-letsencrypt.sh</span><br><span class="line">...</span><br><span class="line">Requesting a certificate <span class="keyword">for</span> your_domain</span><br><span class="line"></span><br><span class="line">Successfully received certificate.</span><br><span class="line">Certificate is saved at: /etc/letsencrypt/live/your_domain/fullchain.pem</span><br><span class="line">Key is saved at:         /etc/letsencrypt/live/your_domain/privkey.pem</span><br><span class="line">This certificate expires on 2021-09-06.</span><br><span class="line">These files will be updated when the certificate renews.</span><br><span class="line"></span><br><span class="line">NEXT STEPS:</span><br><span class="line">- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate <span class="keyword">in</span> the background, but you may need to take steps to <span class="built_in">enable</span> that functionality. See https://certbot.org/renewal-setup <span class="keyword">for</span> instructions.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">If you like Certbot, please consider supporting our work by:</span><br><span class="line">* Donating to ISRG / Let<span class="string">&#x27;s Encrypt:   https://letsencrypt.org/donate</span></span><br><span class="line"><span class="string">* Donating to EFF:                    https://eff.org/donate-le</span></span><br><span class="line"><span class="string">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></span><br></pre></td></tr></table></figure><h3 id="4、多域名操作"><a href="#4、多域名操作" class="headerlink" title="4、多域名操作"></a>4、多域名操作</h3><blockquote><p>步骤同上，先修改域名为待操作域名，然后执行<code>init-letsencrypt.sh</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">&#x27;s/your_domain/your_domain2/g&#x27;</span> data/nginx/app.conf \</span><br><span class="line">&amp;&amp; sed -i <span class="string">&#x27;s/your_domain/your_domain2/g&#x27;</span> init-letsencrypt.sh</span><br><span class="line">$ ./init-letsencrypt.sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="5、启动你的网站"><a href="#5、启动你的网站" class="headerlink" title="5、启动你的网站"></a>5、启动你的网站</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释app.conf</span></span><br><span class="line">$ <span class="built_in">cd</span> data/nginx</span><br><span class="line">$ <span class="built_in">mv</span> app.conf app.conf.bak</span><br><span class="line"><span class="comment"># 添加你的网站配置</span></span><br></pre></td></tr></table></figure><p>示例配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> my.site &#123;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> your_domain;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">600s</span>;</span><br><span class="line">    <span class="attribute">proxy_send_timeout</span> <span class="number">600s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">add_header</span> X-Frame-Options deny;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://my.site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/your_domain/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/your_domain/privkey.pem;</span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> = your_domain) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> your_domain;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>; <span class="comment"># managed by Certbot</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="更新证书"><a href="#更新证书" class="headerlink" title="更新证书"></a>更新证书</h1><blockquote><p>作者给出的<code>docker-compose.yml</code>已经默认12小时检查并更新一次，所以非常省心</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it nginx-certbot_certbot_1 certbot renew</span><br><span class="line">...</span><br><span class="line">The following certificates are not due <span class="keyword">for</span> renewal yet:</span><br><span class="line">  /etc/letsencrypt/live/your_domain/fullchain.pem expires on 2021-09-06 (skipped)</span><br><span class="line">No renewals were attempted.</span><br></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://github.com/certbot/certbot">certbot</a></li><li><a href="https://github.com/gcdd1993/nginx-certbot">nginx-certbot</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文介绍使用&lt;a href=&quot;&quot;&gt;certbot&lt;/a&gt;为网站添加HTTPS支持，并自动更新&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="默认" scheme="https://blog.gcdd.top/tags/%E9%BB%98%E8%AE%A4/"/>
    
  </entry>
  
  <entry>
    <title>在Dubbo中使用Kryo序列化协议</title>
    <link href="https://blog.gcdd.top/p/34460/"/>
    <id>https://blog.gcdd.top/p/34460/</id>
    <published>2020-12-09T03:43:12.000Z</published>
    <updated>2023-08-30T04:52:53.909Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kryo是什么？"><a href="#Kryo是什么？" class="headerlink" title="Kryo是什么？"></a>Kryo是什么？</h1><p>Kryo是用于Java的<strong>快速高效</strong>的二进制对象图序列化框架。</p><blockquote><p>该项目的目标是高速，小尺寸和易于使用的API。不管是将对象持久保存到文件、数据库还是通过网络传输时，都可以尝试Kryo。</p></blockquote><p>Kryo还可以执行自动的深浅复制/克隆。这是从对象到对象的直接复制，而不是从对象到字节的复制。</p><span id="more"></span><p>具体可以参考<a href="https://github.com/EsotericSoftware/kryo">Kryo官网</a></p><h1 id="在Dubbo中使用Kryo"><a href="#在Dubbo中使用Kryo" class="headerlink" title="在Dubbo中使用Kryo"></a>在Dubbo中使用Kryo</h1><blockquote><p>本文基于Dubbo版本2.7.8</p></blockquote><p>Dubbo支持非常多的序列化方式，如<code>hession2</code>、<code>avro</code>、<code>FST</code>等等，其中Dubbo官网推荐的序列化方式是<code>Kryo</code>，因为<code>Kryo</code>是一种非常成熟的序列化实现，已经在Twitter、Groupon、Yahoo以及多个著名开源项目（如Hive、Storm）中广泛的使用。</p><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>在Dubbo中使用Kryo非常方便，首先引入依赖</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决一些Kryo特殊序列化，https://github.com/magro/kryo-serializers</span></span><br><span class="line">implementation  <span class="string">&#x27;de.javakaffee:kryo-serializers:0.43&#x27;</span></span><br><span class="line"><span class="comment">// 高性能序列化框架, https://github.com/EsotericSoftware/kryo</span></span><br><span class="line">implementation <span class="string">&#x27;com.esotericsoftware:kryo:4.0.2&#x27;</span></span><br></pre></td></tr></table></figure><p>如果只是简单使用，引入<a href="https://github.com/EsotericSoftware/kryo">kryo</a>即可，如果要支持一些例如List接口，则需要引入<a href="https://github.com/magro/kryo-serializers">kryo-serializers</a>，它针对一些特殊类为Kryo做了适配。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在Dubbo中启用Kryo序列化方式，这里使用SpringBoot YML配置方式</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">protocol:</span></span><br><span class="line">    <span class="attr">serialization:</span> <span class="string">kryo</span></span><br><span class="line">    <span class="attr">optimizer:</span> <span class="string">org.hmwebframework.microservice.dubbo.serialize.SerializationOptimizerImpl</span></span><br></pre></td></tr></table></figure><p>其中<code>org.hmwebframework.microservice.dubbo.serialize.SerializationOptimizerImpl</code>是指定Kryo序列化类，例如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationOptimizerImpl</span> <span class="keyword">implements</span> <span class="title class_">SerializationOptimizer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Class&gt; <span class="title function_">getSerializableClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Class&gt; classes = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Class&gt;();</span><br><span class="line">        classes.add(BidRequest.class);</span><br><span class="line">        classes.add(BidResponse.class);</span><br><span class="line">        classes.add(Device.class);</span><br><span class="line">        classes.add(Geo.class);</span><br><span class="line">        classes.add(Impression.class);</span><br><span class="line">        classes.add(SeatBid.class);</span><br><span class="line">        <span class="keyword">return</span> classes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这，Dubbo使用Kryo就已经OK了。</p><h2 id="为什么要定义SerializationOptimizer实现类？"><a href="#为什么要定义SerializationOptimizer实现类？" class="headerlink" title="为什么要定义SerializationOptimizer实现类？"></a>为什么要定义SerializationOptimizer实现类？</h2><p>首先我们分析下SerializationOptimizer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SerializationOptimizer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get serializable classes</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> serializable classes</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提供了一个接口方法，用于获取序列化的java类型列表，在<code>DubboProtocol#optimizeSerialization</code>中被使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">optimizeSerialization</span><span class="params">(URL url)</span> <span class="keyword">throws</span> RpcException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(className);</span><br><span class="line">        <span class="comment">// 判断是否为SerializationOptimizer实现类</span></span><br><span class="line">        <span class="keyword">if</span> (!SerializationOptimizer.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(<span class="string">&quot;The serialization optimizer &quot;</span> + className + <span class="string">&quot; isn&#x27;t an instance of &quot;</span> + SerializationOptimizer.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SerializationOptimizer</span> <span class="variable">optimizer</span> <span class="operator">=</span> (SerializationOptimizer) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (optimizer.getSerializableClasses() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将SerializationOptimizer中定义的类型列表，注册到SerializableClassRegistry</span></span><br><span class="line">        <span class="keyword">for</span> (Class c : optimizer.getSerializableClasses()) &#123;</span><br><span class="line">            SerializableClassRegistry.registerClass(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        optimizers.add(className);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着，从<code>SerializableClassRegistry</code>中拿出注册的类型，进行Kryo的类型注册，可以看到<code>SerializableClassRegistry#getRegisteredClasses</code>被FST和Kryo使用，证明FST和Kryo都需要进行序列化类的注册，当然FST也支持不注册序列化类型。<br><img src="https://i.loli.net/2020/12/09/OXdnskMZFKvjUHz.png"></p><p>Kryo类注册的具体细节，<code>AbstractKryoFactory#create</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">for</span> (Class clazz : registrations) &#123;</span><br><span class="line">    kryo.register(clazz);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遍历取出SerializableClassRegistry的注册类，依次将类注册到Kryo</span></span><br><span class="line">SerializableClassRegistry.getRegisteredClasses().forEach((clazz, ser) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ser == <span class="literal">null</span>) &#123;</span><br><span class="line">        kryo.register(clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        kryo.register(clazz, (Serializer) ser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>循环取出SerializableClassRegistry中的注册类进行注册，看到这里也能明白，为什么Dubbo官网的SerializationOptimizer例子需要使用LinkedList。</p><h1 id="为什么Kryo需要进行类的注册，且保持顺序？"><a href="#为什么Kryo需要进行类的注册，且保持顺序？" class="headerlink" title="为什么Kryo需要进行类的注册，且保持顺序？"></a>为什么Kryo需要进行类的注册，且保持顺序？</h1><h2 id="类的注册"><a href="#类的注册" class="headerlink" title="类的注册"></a>类的注册</h2><p>在Dubbo这样的RPC框架进行通信时，性能瓶颈往往在于RPC传输过程中的网络IO耗时，提升网络IO的办法，一是加大带宽，二是减小传输的字节数，而高性能序列化框架可以做到的就是减小传输的字节数。</p><p>Kryo注册类的时候，使用了一个int类型的ID来与类进行关联，在序列化该类的实例时，用int ID来标识类型，反序列化该类时，同样通过int ID来找到类型，这比写出类名高效的多。</p><h2 id="维持类注册顺序"><a href="#维持类注册顺序" class="headerlink" title="维持类注册顺序"></a>维持类注册顺序</h2><p>Kryo注册类的时候，可以指定类关联的int ID，例如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kryo</span>();</span><br><span class="line">kryo.register(SomeClass.class, <span class="number">10</span>);</span><br><span class="line">kryo.register(AnotherClass.class, <span class="number">11</span>);</span><br><span class="line">kryo.register(YetAnotherClass.class, <span class="number">12</span>);</span><br></pre></td></tr></table></figure><p>但是上面我们讲到，Dubbo对Kryo做了相当程度的集成，导致我们没法给类指定int ID，但是我们可以保证服务提供方和消费方类注册顺序的一致，间接地保证了int ID的一致性。</p><h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="反射获取代注册的类"><a href="#反射获取代注册的类" class="headerlink" title="反射获取代注册的类"></a>反射获取代注册的类</h2><blockquote><p>在Dubbo中使用Kryo时，我们需要实现一个SerializationOptimizer，并提供一个注册类列表。随着项目规模扩大，不可能时时刻刻想着维护这个注册类列表，所以我们可以使用反射来自动获取这个注册类列表</p></blockquote><p>引入依赖</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java反射工具包</span></span><br><span class="line">implementation <span class="string">&#x27;org.reflections:reflections:0.9.11&#x27;</span></span><br></pre></td></tr></table></figure><p>编写接口，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">KryoDubboSerializable</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写SerializationOptimizer实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractSerializationOptimizerImpl</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">SerializationOptimizer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; classList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractSerializationOptimizerImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConfigurationBuilder</span>()</span><br><span class="line">                        .forPackages(basePackage())</span><br><span class="line">                        .addScanners(<span class="keyword">new</span> <span class="title class_">SubTypesScanner</span>())</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">this</span>.classList = reflections.getSubTypesOf(KryoDubboSerializable.class)</span><br><span class="line">                .stream()</span><br><span class="line">            <span class="comment">// Kryo序列化协议要求类注册顺序一致</span></span><br><span class="line">                .sorted(Comparator.comparing(Class::getSimpleName))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        log.info(<span class="string">&quot;load &#123;&#125; classes to use kryo serializable&quot;</span>, <span class="built_in">this</span>.classList.size());</span><br><span class="line">        log.debug(<span class="string">&quot;kryo serializable classes: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.classList.stream().map(Class::getSimpleName).collect(Collectors.joining(<span class="string">&quot;,&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> classList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描包路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> packages</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String[] basePackage();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次使用时，只需要继承AbstractSerializationOptimizerImpl，并提供待注册包路径（支持多个），待注册的类需要实现KryoDubboSerializable接口，这是为了在一定程度上提升灵活性（如果不需要注册到Kryo，不实现该接口即可）。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://dubbo.apache.org/zh/docs/v2.7/user/serialization/">https://dubbo.apache.org/zh/docs/v2.7/user/serialization/</a></li><li><a href="https://github.com/EsotericSoftware/kryo">https://github.com/EsotericSoftware/kryo</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Kryo是什么？&quot;&gt;&lt;a href=&quot;#Kryo是什么？&quot; class=&quot;headerlink&quot; title=&quot;Kryo是什么？&quot;&gt;&lt;/a&gt;Kryo是什么？&lt;/h1&gt;&lt;p&gt;Kryo是用于Java的&lt;strong&gt;快速高效&lt;/strong&gt;的二进制对象图序列化框架。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;该项目的目标是高速，小尺寸和易于使用的API。不管是将对象持久保存到文件、数据库还是通过网络传输时，都可以尝试Kryo。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Kryo还可以执行自动的深浅复制/克隆。这是从对象到对象的直接复制，而不是从对象到字节的复制。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>掘金解绑方案（已成功解绑微信）</title>
    <link href="https://blog.gcdd.top/p/34461/"/>
    <id>https://blog.gcdd.top/p/34461/</id>
    <published>2020-12-09T03:43:12.000Z</published>
    <updated>2023-08-30T04:52:53.910Z</updated>
    
    <content type="html"><![CDATA[<p>掘金的绑定限制为同一个第三方账号只能绑定一个掘金账号，且必须留存一个第三方绑定。</p><p>比如，我只绑定了微信，想要解绑微信，对不起，不支持。</p><span id="more"></span><p><img src="https://i.loli.net/2020/02/10/XqgsL2DYIkCoapr.png"></p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>我突然想到，既然必须留存一个第三方绑定，那我留存一个<strong>邮箱绑定</strong>不就好了吗？</p><p>思路就是<a href="https://temp-mail.org/zh/">临时电子邮件地址</a>，通过绑定一个邮箱账号，来绑定邮箱，从而将我们的账号解放出来，绑定我们的大号或者其他账号。</p><h2 id="获取临时电子邮件地址"><a href="#获取临时电子邮件地址" class="headerlink" title="获取临时电子邮件地址"></a>获取临时电子邮件地址</h2><p>打开<a href="https://temp-mail.org/zh/">临时电子邮件地址</a>，你将会获取到一个临时电子邮件地址，我们将使用这个邮件绑定我们的掘金账号。</p><p><img src="https://i.loli.net/2020/02/10/WU5CKnDcYlrwLZp.png"></p><h2 id="绑定临时邮箱"><a href="#绑定临时邮箱" class="headerlink" title="绑定临时邮箱"></a>绑定临时邮箱</h2><p>点击绑定邮箱，输入我们上一步获取到的临时邮件地址，返回<a href="https://temp-mail.org/zh/">临时电子邮件地址</a>网站，耐心等待10s左右。</p><p><img src="https://i.loli.net/2020/02/10/MCRXaSIbO2KTHfr.png"></p><p>你将会受到掘金的邮箱绑定验证邮件，打开并点击，直到绑定成功。</p><p><img src="https://i.loli.net/2020/02/10/sQpovuOjaEJwkbR.png"></p><h2 id="解绑"><a href="#解绑" class="headerlink" title="解绑"></a>解绑</h2><p>接下来我们就可以开心的解绑我们自己的账号了。我要解绑的是微信，试一下吧。</p><p><img src="https://i.loli.net/2020/02/10/GL2yaCp7AsWZQiT.png"></p><h1 id="友情提醒"><a href="#友情提醒" class="headerlink" title="友情提醒"></a>友情提醒</h1><blockquote><p>由于使用的是一次性邮件地址，该做法可能会导致你解绑的账号登录不上，请谨慎操作！</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;掘金的绑定限制为同一个第三方账号只能绑定一个掘金账号，且必须留存一个第三方绑定。&lt;/p&gt;
&lt;p&gt;比如，我只绑定了微信，想要解绑微信，对不起，不支持。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="技巧" scheme="https://blog.gcdd.top/tags/%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>算法很美（蓝桥） | 位运算的奇技淫巧</title>
    <link href="https://blog.gcdd.top/p/60563/"/>
    <id>https://blog.gcdd.top/p/60563/</id>
    <published>2020-11-20T15:12:33.000Z</published>
    <updated>2023-08-30T04:52:53.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="我有话说"><a href="#我有话说" class="headerlink" title="我有话说"></a>我有话说</h1><p>前阵子跑去面试，有家公司是做电商广告数据分析的，很有意思，上来先做了三道算法题（答得不好），然后面试官花了很长时间为我解答了三道题目，一度让我以为已经是这家公司的员工了。临了，征求了下面试官对我的建议，“不是科班出身（我本科学的物理），计算机基础和算法是偏弱些，这两块要好好打磨打磨。”<span id="more"></span></p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote><p>在学习算法很美课程的时候，学习到了一些位运算的奇技淫巧，收录在此</p></blockquote><h2 id="判断奇偶数"><a href="#判断奇偶数" class="headerlink" title="判断奇偶数"></a>判断奇偶数</h2><h3 id="判断奇数1-amp-x-1"><a href="#判断奇数1-amp-x-1" class="headerlink" title="判断奇数1 &amp; x == 1"></a>判断奇数<code>1 &amp; x == 1</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println((<span class="number">1991</span> &amp; <span class="number">1</span>) == <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>判断偶数<code>1 &amp; x == 0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println((<span class="number">1990</span> &amp; <span class="number">1</span>) == <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="获取二进制数x位y是1还是0"><a href="#获取二进制数x位y是1还是0" class="headerlink" title="获取二进制数x位y是1还是0"></a>获取二进制数x位y是1还是0</h2><blockquote><p>将x右移<code>y - 1</code>位，与1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0b010110010</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> (x &gt;&gt; (y - <span class="number">1</span>)) &amp; <span class="number">1</span>;</span><br><span class="line">System.out.println(res);</span><br></pre></td></tr></table></figure><h2 id="交换两个整数变量的值"><a href="#交换两个整数变量的值" class="headerlink" title="交换两个整数变量的值"></a>交换两个整数变量的值</h2><h2 id="不用判断语句，求整数的绝对值"><a href="#不用判断语句，求整数的绝对值" class="headerlink" title="不用判断语句，求整数的绝对值"></a>不用判断语句，求整数的绝对值</h2><blockquote><p>异或，可以理解为不进位加法，<code>1 + 1 = 0，0 + 0 = 0，1 + 0 = 1</code></p></blockquote><h3 id="异或的性质"><a href="#异或的性质" class="headerlink" title="异或的性质"></a>异或的性质</h3><ul><li>交换律：可任意交换运算因子的位置，结果不变</li><li>结合律：即<code>（a ^ b）^ c == a ^ ( b ^ c )</code></li><li>对于任何数x，都有<code>x ^ x = 0, x ^ 0 = x</code>，同自己求异或为0，同0求异或为自己</li><li>自反性：<code>A ^ B ^ B = A ^ 0 = A</code>，连续和同一个因子做异或运算，最终结果为自己</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">100</span>;</span><br><span class="line"><span class="comment">// a为正数，a &gt;&gt; 31 = 00000000 00000000 00000000 00000000，求绝对值就是自己</span></span><br><span class="line"><span class="comment">// a为负数，a &gt;&gt; 31 = 11111111 11111111 11111111 11111111，求绝对值就是自己 * -1（00000000 00000000 00000000 00000001）</span></span><br><span class="line">System.out.println((a + (a &gt;&gt; <span class="number">31</span>) ^ (a &gt;&gt; <span class="number">31</span>)));</span><br></pre></td></tr></table></figure><p>这边课程讲的不是很明白，可以参考下<a href="https://blog.csdn.net/weixin_37490221/article/details/91044963">位运算求整数的绝对值</a>，写的很好。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;我有话说&quot;&gt;&lt;a href=&quot;#我有话说&quot; class=&quot;headerlink&quot; title=&quot;我有话说&quot;&gt;&lt;/a&gt;我有话说&lt;/h1&gt;&lt;p&gt;前阵子跑去面试，有家公司是做电商广告数据分析的，很有意思，上来先做了三道算法题（答得不好），然后面试官花了很长时间为我解答了三道题目，一度让我以为已经是这家公司的员工了。临了，征求了下面试官对我的建议，“不是科班出身（我本科学的物理），计算机基础和算法是偏弱些，这两块要好好打磨打磨。”</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="algorithm" scheme="https://blog.gcdd.top/tags/algorithm/"/>
    
  </entry>
  
  <entry>
    <title>Scala学习笔记</title>
    <link href="https://blog.gcdd.top/p/37757/"/>
    <id>https://blog.gcdd.top/p/37757/</id>
    <published>2020-02-02T05:49:38.000Z</published>
    <updated>2023-08-30T04:52:53.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>Scala是一门优秀的编程语言，它是一门纯面向对象的语言，且支持函数式编程。</p><p>Scala运行于Jvm，所有Scala的代码，都需要经过编译为字节码，然后交由Java虚拟机来运行。<strong>Scala和Java是可以无缝互操作的。Scala可以任意调用Java的代码</strong>。</p><span id="more"></span><h1 id="安装Scala"><a href="#安装Scala" class="headerlink" title="安装Scala"></a>安装Scala</h1><ol><li><p>从Scala官方网站下载，<a href="http://www.scala-lang.org/download/%EF%BC%8Cwindows%E7%89%88%E6%9C%AC%E7%9A%84%E5%AE%89%E8%A3%85%E5%8C%85%E6%98%AF%60scala-2.11.7.msi%60%E3%80%82">http://www.scala-lang.org/download/，windows版本的安装包是`scala-2.11.7.msi`。</a></p></li><li><p>使用下载下来的安装包安装Scala。</p></li><li><p>在PATH环境变量中，配置$SCALA_HOME/bin目录。</p></li></ol><p><img src="https://i.loli.net/2020/02/02/Zmrv5iPFe2N3hwu.png"></p><ol start="2"><li>在windows命令行内即可直接键入scala，打开scala命令行，进行scala编程。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ scala</span><br><span class="line">Welcome to Scala 2.11.12 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_231).</span><br><span class="line">Type <span class="keyword">in</span> expressions <span class="keyword">for</span> evaluation. Or try :<span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><h2 id="Scala解释器的使用"><a href="#Scala解释器的使用" class="headerlink" title="Scala解释器的使用"></a>Scala解释器的使用</h2><h3 id="REPL"><a href="#REPL" class="headerlink" title="REPL"></a>REPL</h3><blockquote><p>scala解释器也被称为REPL，会快速编译scala代码为字节码，然后交给JVM来执行。</p></blockquote><p>Read（取值）-&gt; Evaluation（求值）-&gt; Print（打印）-&gt; Loop（循环）。</p><h3 id="计算表达式"><a href="#计算表达式" class="headerlink" title="计算表达式"></a>计算表达式</h3><blockquote><p>在scala&gt;命令行内，键入scala代码，解释器会直接返回结果给你。如果你没有指定变量来存放这个值，那么值默认的名称为res，而且会显示结果的数据类型，比如Int、Double、String等等。</p></blockquote><p>例如，输入1 + 1，会看到res0: Int = 2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; 1 + 1</span><br><span class="line">res0: Int = 2</span><br></pre></td></tr></table></figure><h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><blockquote><p>在后面可以继续使用res这个变量，以及它存放的值。</p></blockquote><p>例如，2.0 * res0，返回res1: Double = 4.0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; 2.0 * res0</span><br><span class="line">res1: Double = 4.0</span><br></pre></td></tr></table></figure><p>例如，”Hi, “ + res0，返回res2: String = Hi, 2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="string">&quot;Hi, &quot;</span> + res0</span><br><span class="line">res2: String = Hi, 2</span><br></pre></td></tr></table></figure><h3 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h3><blockquote><p>在scala&gt;命令行内，可以使用Tab键进行自动补全。</p></blockquote><p>例如，输入res2.to，敲击Tab键，解释器会显示出以下选项，toCharArray，toLowerCase，toString，toUpperCase。因为此时无法判定你需要补全的是哪一个，因此会提供给你所有的选项。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res2.to</span><br><span class="line">to          toCharArray    toIterable    toMap ...</span><br></pre></td></tr></table></figure><p>例如，输入res2.toU，敲击Tab键，直接会给你补全为res2.toUpperCase。</p><h2 id="声明变量"><a href="#声明变量" class="headerlink" title="声明变量"></a>声明变量</h2><h3 id="声明val变量"><a href="#声明val变量" class="headerlink" title="声明val变量"></a>声明val变量</h3><blockquote><p>可以声明val变量来存放表达式的计算结果。</p></blockquote><ul><li>例如，val result = 1 + 1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val result = 1 + 1</span><br><span class="line">result: Int = 2</span><br></pre></td></tr></table></figure><ul><li>后续这些常量是可以继续使用的，例如，2 * result</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; 2 * result</span><br><span class="line">res6: Int = 4</span><br></pre></td></tr></table></figure><ul><li>但是常量声明后，是无法改变它的值的，例如，result = 1，会返回error: reassignment to val的错误信息。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; result = 1</span><br><span class="line">&lt;console&gt;:12: error: reassignment to val</span><br><span class="line">       result = 1</span><br><span class="line">              ^</span><br></pre></td></tr></table></figure><h3 id="声明var变量"><a href="#声明var变量" class="headerlink" title="声明var变量"></a>声明var变量</h3><blockquote><p>如果要声明值可以改变的引用，可以使用var变量。</p></blockquote><ul><li><p>例如，<code>val myresult = 1，myresult = 2</code></p></li><li><p>但是在Scala程序中，通常建议使用val，也就是常量，<strong>因此比如类似于spark的大型复杂系统中，需要大量的网络传输数据，如果使用var，可能会担心值被错误的更改。</strong></p></li><li><p>在Java的大型复杂系统的设计和开发中，也使用了类似的特性，我们通常会将传递给其他模块 / 组件 / 服务的对象，设计成不可变类（Immutable Class）。在里面也会使用Java的常量定义，比如final，阻止变量的值被改变。<strong>从而提高系统的健壮性（robust，鲁棒性），和安全性</strong>。</p></li></ul><h2 id="指定类型"><a href="#指定类型" class="headerlink" title="指定类型"></a>指定类型</h2><blockquote><p>无论声明val变量，还是声明var变量，都可以手动指定其类型，<strong>如果不指定的话，Scala会自动根据值，进行类型的推断</strong>。</p></blockquote><ul><li><p>例如，<code>val name: String = null</code></p></li><li><p>例如，<code>val name: Any = &quot;leo&quot;</code></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;Scala是一门优秀的编程语言，它是一门纯面向对象的语言，且支持函数式编程。&lt;/p&gt;
&lt;p&gt;Scala运行于Jvm，所有Scala的代码，都需要经过编译为字节码，然后交由Java虚拟机来运行。&lt;strong&gt;Scala和Java是可以无缝互操作的。Scala可以任意调用Java的代码&lt;/strong&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Scala" scheme="https://blog.gcdd.top/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>MacOs使用CleanMyMac X清除可清除空间</title>
    <link href="https://blog.gcdd.top/p/46997/"/>
    <id>https://blog.gcdd.top/p/46997/</id>
    <published>2019-10-11T10:41:15.000Z</published>
    <updated>2023-08-30T04:52:53.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>本文介绍如何使用<code>CleanMyMac X</code>清除可清除的空间</p><p><img src="https://i.loli.net/2019/10/11/GdSBlzQMhTfY2Ha.png"></p><span id="more"></span><p>可以看到，可清除的空间达到了125.79GB，虽然说不影响系统的使用，但是在使用时间机器进行备份的时候，仍然会将可清除空间当成备份的一部分，造成备份文件过大，首次备份时间过长。</p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>清除可清除空间，你只需要<strong>CleanMyMac X</strong>这个工具即可，我分享下我使用的版本，当然有能力的建议使用正版。</p><p><a href="https://pan.baidu.com/s/1L05kBwZIghM73IRC8rMpMw">https://pan.baidu.com/s/1L05kBwZIghM73IRC8rMpMw</a></p><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>安装完毕后，打开<strong>CleanMyMac X</strong></p><p><img src="https://i.loli.net/2019/10/11/E8BRFzlvLo4bcZU.png"></p><p>点击”维护“，你可以使用“<strong>释放可清除空间</strong>”或者是“<strong>时间机器快照瘦身</strong>”，我使用的是“时间机器快照瘦身”</p><div class="note warning flat"><p>建议先使用“时间机器快照瘦身”，如果不行，再释放可清除空间，因为释放可清除空间耗时较长</p></div><p><img src="https://i.loli.net/2019/10/11/VTihB8LqlUebrJY.png"></p><p>点击运行，稍作等待即可</p><p><img src="https://i.loli.net/2019/10/11/tUKvGurohTwY4fV.png"></p><p>这时候，我们回到磁盘工具，再次查看可清除空间，可以发现，可清除空间小了不少！</p><p><img src="https://i.loli.net/2019/10/11/fPV35Zvj8oznWqm.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;本文介绍如何使用&lt;code&gt;CleanMyMac X&lt;/code&gt;清除可清除的空间&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2019/10/11/GdSBlzQMhTfY2Ha.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="macOs" scheme="https://blog.gcdd.top/tags/macOs/"/>
    
  </entry>
  
  <entry>
    <title>TamperMonkey 使用指南以及脚本推荐</title>
    <link href="https://blog.gcdd.top/p/29031/"/>
    <id>https://blog.gcdd.top/p/29031/</id>
    <published>2019-10-07T12:56:20.000Z</published>
    <updated>2023-08-30T04:52:53.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>Chrome浏览器是最适合开发者使用的浏览器，不仅仅是因为Chrome对于Js的友好支持，更是由于Chrome支持丰富且功能强大的插件，扩展了浏览器的功能和使用体验。</p><p>在这些插件里面，相信你一定使用过<a href="https://www.tampermonkey.net/">TamperMonkey</a>，他可以让你加速下载百度网盘，跟百度限速说拜拜，也可以让你免费观看VIP影视和音乐，反正一句话，黑科技！</p><span id="more"></span><h1 id="TamperMonkey使用"><a href="#TamperMonkey使用" class="headerlink" title="TamperMonkey使用"></a>TamperMonkey使用</h1><p>TamperMonkey的官网是：<a href="https://www.tampermonkey.net,支持各类chrome内核的浏览器以及火狐浏览器(firefox)./">https://www.tampermonkey.net，支持各类Chrome内核的浏览器以及火狐浏览器（FireFox）。</a></p><div class="note info flat"><p>以下以Chrome浏览器为例。</p></div><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装非常简单，打开<a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=zh-CN">Chrome商店</a>，点击”添加到Chrome”</p><p><img src="https://i.loli.net/2019/10/07/KqbsVxP5To4HdQC.png"></p><h2 id="安装脚本"><a href="#安装脚本" class="headerlink" title="安装脚本"></a>安装脚本</h2><ol><li>点击”获取新脚本”</li></ol><p><img src="https://i.loli.net/2019/10/07/XLHZqzFdVToacyE.png"></p><ol start="2"><li>选择合适的脚本源，这里推荐GreasyFork</li></ol><p><img src="https://i.loli.net/2019/10/07/gkvSFHfrldBV5pD.png"></p><ol start="3"><li>安装脚本，以VIP视频解析为例</li></ol><p><img src="https://i.loli.net/2019/10/07/yMhfdDBZJegvxE1.png"></p><p>我们点击第一个脚本（有时候会比较慢，请耐心等待下），点击”安装此脚本”</p><p><img src="https://i.loli.net/2019/10/07/z9NQ21heM4YXJpT.png"></p><p>点击安装</p><p><img src="https://i.loli.net/2019/10/07/Ffz6a1P7YehwcsS.png"></p><p>下面可以直接看到脚本的源码，有能力的话，可以自己修改或者编写脚本。</p><ol start="4"><li>看看脚本的效果</li></ol><p>我们打开爱奇艺，找个vip电影，比如最近热播的银河补习班</p><p><img src="https://i.loli.net/2019/10/07/bmUQz5aGqKrCu3L.png"></p><p><img src="https://i.loli.net/2019/10/07/Mqw8XZ1WeOpnYRA.png"></p><h1 id="TamperMonkey脚本推荐"><a href="#TamperMonkey脚本推荐" class="headerlink" title="TamperMonkey脚本推荐"></a>TamperMonkey脚本推荐</h1><p>在TamperMonkey的管理面板中，可以看到已经安装的所有脚本</p><p><img src="https://i.loli.net/2019/10/07/ctFHYj9ERJTg4eu.png"></p><p>下面列举出我常用的脚本</p><ul><li><p><a href="https://greasyfork.org/zh-CN/scripts/373956-52pojie%E5%90%BE%E7%88%B1%E7%A0%B4%E8%A7%A3%E8%AE%BA%E5%9D%9B%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0%E5%8A%A9%E6%89%8B-%E5%85%8D%E6%89%93%E6%89%B0">52pojie吾爱破解论坛自动签到助手-免打扰</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/30117-%E5%90%BE%E7%88%B1%E7%A0%B4%E8%A7%A3%E8%AE%BA%E5%9D%9B-%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E9%93%BE%E6%8E%A5%E6%BF%80%E6%B4%BB-%E6%8F%90%E5%8F%96%E7%A0%81%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8">吾爱破解论坛-百度网盘链接激活-提取码自动补全</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/14178-ac-baidu-%E9%87%8D%E5%AE%9A%E5%90%91%E4%BC%98%E5%8C%96%E7%99%BE%E5%BA%A6%E6%90%9C%E7%8B%97%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2-%E5%8E%BB%E5%B9%BF%E5%91%8A-favicon-%E5%8F%8C%E5%88%97">ac-baidu-重定向优化百度搜狗谷歌搜索-去广告-favicon-双列</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/368418-ac-baidu-%E4%BC%98%E5%8C%96%E7%99%BE%E5%BA%A6-%E6%90%9C%E7%8B%97-%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E4%B9%8B%E5%85%B3%E9%94%AE%E8%AF%8D%E8%87%AA%E5%8A%A8%E9%AB%98%E4%BA%AE">ac-baidu-优化百度-搜狗-谷歌搜索结果之关键词自动高亮</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/372452-csdn%E8%87%AA%E5%8A%A8%E5%B1%95%E5%BC%80-%E5%8E%BB%E5%B9%BF%E5%91%8A-%E5%87%80%E5%8C%96%E5%89%AA%E8%B4%B4%E6%9D%BF-%E5%85%8D%E7%99%BB%E9%99%86">csdn自动展开-去广告-净化剪贴板-免登陆</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/384538-%E4%B8%80%E9%94%AEvip%E8%A7%86%E9%A2%91%E8%A7%A3%E6%9E%90-%E5%8E%BB%E5%B9%BF%E5%91%8A-%E5%85%A8%E7%BD%91-%E4%B8%80%E7%AB%99%E5%BC%8F%E9%9F%B3%E4%B9%90%E6%90%9C%E7%B4%A2%E4%B8%8B%E8%BD%BD-%E7%99%BE%E5%BA%A6%E4%BA%91%E7%A6%BB%E7%BA%BF%E8%B7%B3%E8%BD%AC-%E8%8E%B7%E5%8F%96b%E7%AB%99%E5%B0%81%E9%9D%A2-%E6%B7%98%E5%AE%9D%E4%BA%AC%E4%B8%9C%E4%BC%98%E6%83%A0%E5%88%B8-2019-10-01-%E6%9B%B4%E6%96%B0-%E6%8A%A5%E9%94%99%E8%AF%B7%E5%8F%8A%E6%97%B6%E5%8F%8D%E9%A6%88">一键vip视频解析-去广告-全网-一站式音乐搜索下载-百度云离线跳转-获取b站封面-淘宝京东优惠券-2019-10-01-更新-报错请及时反馈</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/387360-%E5%9F%8E%E9%80%9A%E7%BD%91%E7%9B%98-%E7%9A%AE%E7%9A%AE%E7%9B%98-%E7%89%9B%E7%9B%98%E6%98%BE%E7%A4%BA%E6%AD%A3%E7%A1%AE%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80">城通网盘-皮皮盘-牛盘显示正确下载地址</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/379893-%E7%99%BE%E5%BA%A6%E6%96%87%E5%BA%93%E6%96%87%E6%A1%A3%E5%85%8D%E8%B4%B9%E4%B8%8B%E8%BD%BD-%E5%8E%9F%E6%96%87%E6%A1%A3-%E8%BD%AC%E6%8D%A2%E6%8F%90%E5%8F%96%E6%96%87%E6%A1%A3-%E6%96%87%E6%A1%A3%E5%86%85%E5%AE%B9%E8%87%AA%E7%94%B1%E5%A4%8D%E5%88%B6-%E7%A7%BB%E9%99%A4%E5%B9%BF%E5%91%8A-%E8%B1%86%E4%B8%81%E7%BD%91%E6%96%87%E6%A1%A3%E4%B8%8B%E8%BD%BD-%E8%A7%A3%E9%99%A4%E5%A4%A7%E9%83%A8%E5%88%86%E7%BD%91%E7%AB%99%E6%93%8D%E4%BD%9C%E9%99%90%E5%88%B6-%E5%85%A8%E7%BD%91vip%E8%A7%86%E9%A2%91%E5%85%8D%E8%B4%B9%E5%9C%A8%E7%BA%BF%E7%9C%8B-%E6%94%AF%E6%8C%81%E7%94%B5%E8%A7%86%E5%89%A7%E5%85%8D%E8%B7%B3%E5%87%BA%E9%80%89%E9%9B%86">百度文库文档免费下载-原文档-转换提取文档-文档内容自由复制-移除广告-豆丁网文档下载-解除大部分网站操作限制-全网vip视频免费在线看-支持电视剧免跳出选集</a></p></li><li><p><a href="https://github.com/syhyz1990/baiduyun">百度网盘直链下载助手</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/384172-%E7%9F%A5%E4%B9%8E%E7%BD%91%E9%A1%B5%E5%8A%A9%E6%89%8B-5%E5%A4%A7%E5%8A%9F%E8%83%BD%E9%9B%86%E4%BA%8E%E4%B8%80%E8%BA%AB">知乎网页助手-5大功能集于一身</a></p></li><li><p><a href="https://greasyfork.org/zh-CN/scripts/26992-%E8%B4%B4%E5%90%A7%E5%85%A8%E8%83%BD%E5%8A%A9%E6%89%8B">贴吧全能助手</a></p></li></ul><h1 id="TamperMonkey脚本同步"><a href="#TamperMonkey脚本同步" class="headerlink" title="TamperMonkey脚本同步"></a>TamperMonkey脚本同步</h1><p>TamperMonkey提供了非常方便的方法让我们同步脚本，从而避免每次安装都要重新安装脚本的烦恼。</p><p><img src="https://i.loli.net/2019/10/07/yRtBhKbsLzGdTXP.png"></p><ol><li>进入TamperMonkey插件设置页</li><li>配置模式选择”初学者”</li><li>勾选”启用 TESLA”，类型选择”浏览器同步”</li><li>点击保存</li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;Chrome浏览器是最适合开发者使用的浏览器，不仅仅是因为Chrome对于Js的友好支持，更是由于Chrome支持丰富且功能强大的插件，扩展了浏览器的功能和使用体验。&lt;/p&gt;
&lt;p&gt;在这些插件里面，相信你一定使用过&lt;a href=&quot;https://www.tampermonkey.net/&quot;&gt;TamperMonkey&lt;/a&gt;，他可以让你加速下载百度网盘，跟百度限速说拜拜，也可以让你免费观看VIP影视和音乐，反正一句话，黑科技！&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Chrome" scheme="https://blog.gcdd.top/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>MacOs科学上网</title>
    <link href="https://blog.gcdd.top/p/709/"/>
    <id>https://blog.gcdd.top/p/709/</id>
    <published>2019-10-06T15:47:37.000Z</published>
    <updated>2023-08-30T04:52:53.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前使用Windows的时候，有非常优秀的全局代理软件<a href="https://www.sockscap64.com/forums/forum/sstap/">SSTap</a>用来翻墙，但是到了MacOs上，没有找到类似SSTap的全局翻墙神器。</p><p>最终采取的方案是<a href="https://github.com/shadowsocks/ShadowsocksX-NG">ShadowsocksX-NG R8</a>+<a href="">Proxifier</a>的方式来实现。</p><span id="more"></span><h1 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h1><h2 id="ShadowsocksX-NG-R8"><a href="#ShadowsocksX-NG-R8" class="headerlink" title="ShadowsocksX-NG R8"></a>ShadowsocksX-NG R8</h2><blockquote><p>ShadowsocksX-NG是Mac下的SSR工具，具有和Windows下同样的体验，使用起来也非常方便，支持服务器订阅。</p></blockquote><p><img src="https://i.loli.net/2019/10/06/FZbVImyYedEHQvl.png"></p><p>配置就不多说了，唯一要注意的是，Socks5的监听地址是：<code>127.0.0.1:1086</code>，这个我们一会要用到。</p><p><img src="https://i.loli.net/2019/10/07/cCX4p8debKNvYrG.png"></p><h2 id="Proxifier"><a href="#Proxifier" class="headerlink" title="Proxifier"></a>Proxifier</h2><blockquote><p>Proxifier是Mac下的全局代理工具，可以将流量统统都转到代理上，配合ShadowsocksX-NG，我们很轻松的就可以实现全局翻墙</p></blockquote><p>软件本身是收费的，当然了，在<code>Xclient.info</code>上可以找到破解版：<a href="https://xclient.info/s/proxifier.html">https://xclient.info/s/proxifier.html</a></p><p>安装完毕之后，我们只需要简单的配置一下，就可以实现全局科学上网了！</p><h2 id="添加Socks5代理"><a href="#添加Socks5代理" class="headerlink" title="添加Socks5代理"></a>添加Socks5代理</h2><ol><li>点击Proxies</li></ol><p><img src="https://i.loli.net/2019/10/07/tebRvEfDKZN16JA.png"></p><ol start="2"><li>点击Add，添加代理</li></ol><p><img src="https://i.loli.net/2019/10/07/iLXBoKFwah4HuWP.png"></p><ol start="3"><li>添加完毕后，回到主界面，点击Rules，修改默认规则，将动作指向我们新添加的Socks5代理</li></ol><p><img src="https://i.loli.net/2019/10/07/JRd6ekxHYwan4um.png"></p><ol start="4"><li>测试</li></ol><p>打开ITerm2测试下，在终端输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl www.google.com</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/10/07/xEgSoUw9Bk6ODT5.png"></p><p>同时，Proxifier也打印出了ITerm2的流量信息</p><p><img src="https://i.loli.net/2019/10/07/WNVMbpnF3OiZmkQ.png"></p><p>另外，Proxifier也支持指定软件走代理，具体步骤如下</p><ol><li>在Rules标签中点击Add，新建一个规则</li></ol><p><img src="https://i.loli.net/2019/10/07/u2keChKzrvGdoZF.png"></p><ol start="2"><li>添加完成后勾选使用，同时，不要忘记把Default规则的动作设置为Direct，不然的话，还是全局都走代理的。</li></ol><p><img src="https://i.loli.net/2019/10/07/6z2jaPkOGN4QVnc.png"></p><h1 id="相关软件"><a href="#相关软件" class="headerlink" title="相关软件"></a>相关软件</h1><ul><li>ShadowsocksX-NG：链接:<a href="https://pan.baidu.com/s/10i6PZZIParFRkvaVu5KhxA">https://pan.baidu.com/s/10i6PZZIParFRkvaVu5KhxA</a>  密码:jvzx</li><li>Proxifier：链接:<a href="https://pan.baidu.com/s/1ymZZRDJrjrIXXFrYfIxV_w">https://pan.baidu.com/s/1ymZZRDJrjrIXXFrYfIxV_w</a>  密码:exns</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;之前使用Windows的时候，有非常优秀的全局代理软件&lt;a href=&quot;https://www.sockscap64.com/forums/forum/sstap/&quot;&gt;SSTap&lt;/a&gt;用来翻墙，但是到了MacOs上，没有找到类似SSTap的全局翻墙神器。&lt;/p&gt;
&lt;p&gt;最终采取的方案是&lt;a href=&quot;https://github.com/shadowsocks/ShadowsocksX-NG&quot;&gt;ShadowsocksX-NG R8&lt;/a&gt;+&lt;a href=&quot;&quot;&gt;Proxifier&lt;/a&gt;的方式来实现。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="科学上网" scheme="https://blog.gcdd.top/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>Dell 工作站M4800 安装macOs Mojave</title>
    <link href="https://blog.gcdd.top/p/62106/"/>
    <id>https://blog.gcdd.top/p/62106/</id>
    <published>2019-10-01T01:43:12.000Z</published>
    <updated>2023-08-30T04:52:53.897Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近，入手了一台二手Dell工作站M4800，价格为3600，配置如下</p><p><img src="https://i.loli.net/2019/10/01/Fhne1JBNAqUXGmM.png"></p><span id="more"></span><p>个人感觉还是很好用的，配置够用，关键是用料真的足！虽然是16年的机器，但是做工吊打一众游戏本。</p><p>然后，重点来了，我安装上了黑苹果macOs Mojave，等于说花了3600买了台MBP，而且是非常的高配。</p><p><img src="https://i.loli.net/2019/10/01/dUagmkJoTqQic5P.png"></p><p><img src="https://i.loli.net/2019/10/01/YqyRE68VKmMgtSe.png"></p><p>目前使用上基本完美，除了无线网卡（买了免驱内置无线网卡在路上），HDMI（暂时不怎么用，不过不是无解）。</p><h1 id="黑苹果安装记录"><a href="#黑苹果安装记录" class="headerlink" title="黑苹果安装记录"></a>黑苹果安装记录</h1><blockquote><p>以下内容仅作记录，不保证能安装成功。</p></blockquote><p>安装教程都大差不差，主要是要找到适用机型的EFI文件，然后替换就可以，当然了，如果你有能力，可以自己适配EFI，然后贡献给大家👍👍👍。</p><p>如果机型跟我一致，可以使用我整理好的：<a href="https://github.com/gcdd1993/Dell-M4800-Hackintosh">https://github.com/gcdd1993/Dell-M4800-Hackintosh</a></p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><blockquote><p>我也是小白，不班门弄斧，放上我装的时候的参考链接，照着装，一般都能搞定</p></blockquote><ul><li><a href="https://zhih.me/hackintosh-install-guide/">单硬盘单系统（推荐）</a></li><li><a href="http://ju.outofmemory.cn/entry/369297">单硬盘双系统（不推荐，可能出现各种各样的问题）</a></li></ul><div class="note warning flat"><p>启动U盘装好后，不要忘记替换适配机型的EFI </p></div><p>然后正式进入黑苹果的安装。</p><h2 id="修改BIOS设置（开机按F2）"><a href="#修改BIOS设置（开机按F2）" class="headerlink" title="修改BIOS设置（开机按F2）"></a>修改BIOS设置（开机按F2）</h2><ul><li><p>Advanced Boot Options = Enable Legacy</p></li><li><p>Integrated NIC = Enable</p></li><li><p>Parallel Ports = AT</p></li><li><p>Serial Ports = Disabled ( If you are using Dock station then Enable it - Expermental )</p></li><li><p>Sata Operation = AHCI</p></li><li><p>Drivers = Check all</p></li><li><p>Switchable Graphics = Enable Switchable Graphics</p></li><li><p>Secure Boot = Disabled</p></li><li><p>Virtualization = Disable</p></li></ul><p>完成后退出重启</p><h2 id="重启选择从U盘启动（开机按F12）"><a href="#重启选择从U盘启动（开机按F12）" class="headerlink" title="重启选择从U盘启动（开机按F12）"></a>重启选择从U盘启动（开机按F12）</h2><p>按照教程，抹盘–安装–进入系统</p><p>要注意的是，安装会经历3次重启</p><ul><li>第一次是安装剩余2分钟的时候，这里要选择<strong>硬盘启动（Clover界面会出现Boot install macos from 硬盘分区名）</strong>，如果你选了U盘启动，那就要再来一次了。</li><li>第二次重启，还是选择硬盘启动</li><li>第三次重启，可以选择<strong>Boot macos from 硬盘分区名</strong>，启动macOs了</li></ul><p>成功进入系统后，执行最后一步，也是最重要的一步，那就是安装驱动</p><h2 id="替换驱动文件"><a href="#替换驱动文件" class="headerlink" title="替换驱动文件"></a>替换驱动文件</h2><p>这里要用到<a href="https://pan.baidu.com/s/1yFDn_w5y2pdC5EYhhB7Y_w">Clover Configurator</a>密码:zcyj</p><ul><li>打开Clover Configurator，选择挂载分区，然后打开分区</li></ul><p><img src="https://i.loli.net/2019/10/01/HMcTaAL9jCvGUEN.png"></p><ul><li>替换EFI文件夹（先移除原先的，将大佬们提供的EFI复制进去）</li></ul><p><img src="https://i.loli.net/2019/10/01/uNq51A3lDJMpx2d.png"></p><ul><li>替换驱动文件（kexts）</li></ul><p><img src="https://i.loli.net/2019/10/01/49IG2XpBxtQWdOR.png"></p><p><img src="https://i.loli.net/2019/10/01/wmtiFH9qBCfQWpv.png"></p><p>最后重启试下吧，可以摆脱U盘了</p><h1 id="Clover主题修改"><a href="#Clover主题修改" class="headerlink" title="Clover主题修改"></a>Clover主题修改</h1><p>黑苹果每次开机都会进入Clover引导界面，但是默认的Clover主题是黑黑的，丑丑的，所以我们要替换掉，换一个高大上的引导界面。</p><p>这里推荐工具<a href="https://mac.softpedia.com/get/System-Utilities/Clover-Theme-Manager.shtml">CloverThemeManager</a></p><p><img src="https://i.loli.net/2019/10/01/FqUTSyxY3QncR2H.png"></p><p><img src="https://i.loli.net/2019/10/01/ZKd3kNiwYc4EnWz.png"></p><hr><h1 id="WIFI"><a href="#WIFI" class="headerlink" title="WIFI"></a>WIFI</h1><p>网卡已安装上，使用的是BCM43224，不带蓝牙，免驱，淘宝25块钱左右，mSata接口，使用无异常。</p><p><img src="https://i.loli.net/2019/10/11/Q1Wzw83uKBlkaod.png"></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://zuiyu1818.cn/posts/Hac_Clover.html">Clover 更新和界面美化</a></li><li><a href="https://osxlatitude.com/forums/topic/11182-final-dell-precision-m6800-m4800-fully-working-high-sierra-or-mojave/">macOs Mojave on M4800</a></li><li><a href="https://github.com/daliansky/Hackintosh">Hackintosh黑苹果长期维护机型EFI及安装教程整理</a></li><li><a href="https://www.chajian110.com/97.html">Mojave硬件支持列表（持续更新中）</a></li><li><a href="https://zhih.me/hackintosh-install-guide/">黑苹果安装教程</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;最近，入手了一台二手Dell工作站M4800，价格为3600，配置如下&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2019/10/01/Fhne1JBNAqUXGmM.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="黑苹果" scheme="https://blog.gcdd.top/tags/%E9%BB%91%E8%8B%B9%E6%9E%9C/"/>
    
  </entry>
  
  <entry>
    <title>SpringJpa CRUD代码生成器</title>
    <link href="https://blog.gcdd.top/p/30009/"/>
    <id>https://blog.gcdd.top/p/30009/</id>
    <published>2019-09-10T16:34:19.000Z</published>
    <updated>2023-08-30T04:52:53.904Z</updated>
    
    <content type="html"><![CDATA[<p>利用业余时间撸了一个Spring Jpa代码生成器<a href="https://github.com/gcdd1993/jpa-codegen">jpa-codegen</a>。</p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>这是一款基于<code>Freemarker</code>模板驱动的代码生成器。</p><p>依据现有的实体类代码，自动生成CRUD代码，解放双手，加快开发速度。</p><p>生成的代码包括但不仅限于（可以自定义生成模块）</p><span id="more"></span><ul><li>Form表单代码</li><li>Repository代码</li><li>Service代码</li><li>Controller代码</li></ul><h1 id="SpringBoot使用示例"><a href="#SpringBoot使用示例" class="headerlink" title="SpringBoot使用示例"></a>SpringBoot使用示例</h1><p>克隆<a href="https://github.com/gcdd1993/jpa-codegen-sample">示例项目</a>，体会解放双手的美妙感受！</p><h1 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h1><h2 id="导入仓库"><a href="#导入仓库" class="headerlink" title="导入仓库"></a>导入仓库</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">maven &#123;</span><br><span class="line">    url <span class="string">&#x27;https://dl.bintray.com/gcdd1993/maven&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// jpa code generator</span></span><br><span class="line">    testCompile <span class="string">&#x27;io.github.gcdd1993:jpa-codegen:v1.0.1&#x27;</span></span><br><span class="line">    testCompile <span class="string">&#x27;org.freemarker:freemarker:2.3.28&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置代码生成器"><a href="#配置代码生成器" class="headerlink" title="配置代码生成器"></a>配置代码生成器</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 作者</span></span><br><span class="line"><span class="attr">author</span>=<span class="string">gcdd1993</span></span><br><span class="line"><span class="comment">## 代码注释</span></span><br><span class="line"><span class="attr">comments</span>=<span class="string">code generated by jpa-codegen</span></span><br><span class="line"><span class="comment">## 是否覆盖原文件，除非特殊情况，不然请不要覆盖</span></span><br><span class="line"><span class="attr">cover</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">## 代码模板目录</span></span><br><span class="line"><span class="attr">template.dir</span>=<span class="string">src/test/resources/template/</span></span><br><span class="line"><span class="comment">## 实体类包名 Deprecated从v1.0.1开始从配置文件中移除</span></span><br><span class="line"><span class="attr">-</span> <span class="string">entity.package=com.maxtropy.sample.entity</span></span><br><span class="line"><span class="comment">## 实体类标识符 Deprecated从v1.0.1开始从配置文件中移除</span></span><br><span class="line"><span class="attr">-</span> <span class="string">entity.flag=entity</span></span><br><span class="line"><span class="comment">## 以下配置是模块配置(格式 模块名.配置名)，必须在模板目录下提供与模块名相同的模板</span></span><br><span class="line"><span class="comment">## 生成的代码后缀</span></span><br><span class="line"><span class="attr">repository.suffix</span>=<span class="string">Repository</span></span><br><span class="line"><span class="comment">## 模板名称</span></span><br><span class="line"><span class="attr">repository.template</span>=<span class="string">repository.ftl</span></span><br><span class="line"><span class="comment">## 模块标识符</span></span><br><span class="line"><span class="attr">repository.flag</span>=<span class="string">entity.repo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service.suffix</span>=<span class="string">Service</span></span><br><span class="line"><span class="attr">service.template</span>=<span class="string">service.ftl</span></span><br><span class="line"><span class="attr">service.flag</span>=<span class="string">service</span></span><br><span class="line"><span class="attr">form.suffix</span>=<span class="string">Form</span></span><br><span class="line"><span class="attr">form.template</span>=<span class="string">form.ftl</span></span><br><span class="line"><span class="attr">form.flag</span>=<span class="string">form</span></span><br><span class="line"><span class="attr">controller.suffix</span>=<span class="string">Controller</span></span><br><span class="line"><span class="attr">controller.template</span>=<span class="string">controller.ftl</span></span><br><span class="line"><span class="attr">controller.flag</span>=<span class="string">web</span></span><br></pre></td></tr></table></figure><p>其中</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">repository.suffix</span>=<span class="string">Repository</span></span><br><span class="line"><span class="attr">repository.template</span>=<span class="string">repository.ftl</span></span><br><span class="line"><span class="attr">repository.flag</span>=<span class="string">entity.repo</span></span><br></pre></td></tr></table></figure><p>是模块配置，<a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E5%9D%97%EF%BC%9F">什么是模块？</a></p><h2 id="编写代码模板"><a href="#编写代码模板" class="headerlink" title="编写代码模板"></a>编写代码模板</h2><p>模板主要基于<code>Freemarker</code>，如<code>Spring Boot2.x</code>代码模板可以像下面这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> $&#123;packageName&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> $&#123;entity.packageName&#125;.$&#123;entity.className&#125;;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.querydsl.QuerydslPredicateExecutor;</span><br><span class="line">&lt;#list imports as <span class="keyword">import</span>&gt;</span><br><span class="line"><span class="keyword">import</span> $&#123;<span class="keyword">import</span>&#125;;</span><br><span class="line">&lt;/#list&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * repository for $&#123;entity.className&#125; generated by jpa-codegen</span></span><br><span class="line"><span class="comment"> * $&#123;comments&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> $&#123;author&#125;</span></span><br><span class="line"><span class="comment"> * Created On $&#123;date&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">$</span>&#123;className&#125; <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;$&#123;entity.className&#125;, $&#123;entity.id.className&#125;&gt;, QuerydslPredicateExecutor&lt;$&#123;entity.className&#125;&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><a href="https://github.com/gcdd1993/jpa-codegen/tree/master/src/main/resources/template/spring2">Spring Boot 2.x模板</a></p></li><li><p><a href="#%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF">如何编写模板?</a></p></li></ul><h2 id="编写生成器入口"><a href="#编写生成器入口" class="headerlink" title="编写生成器入口"></a>编写生成器入口</h2><p>在test模块中编写生成器入口，如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Codegen</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">CodeGenerator</span>(<span class="string">&quot;src/test/resources/codegen.properties&quot;</span>)</span><br><span class="line">                .registerRender(<span class="string">&quot;repository&quot;</span>)</span><br><span class="line">                .generate();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后运行<code>generate()</code>，在项目目录下将会生成</p><p><img src="https://i.imgur.com/WTg4qMx.png" alt="Imgur"></p><p><img src="https://i.imgur.com/yJJ1d59.png" alt="Imgur"></p><p>生成的代码完全由模板以及实体类信息决定。</p><h1 id="如何编写模板？"><a href="#如何编写模板？" class="headerlink" title="如何编写模板？"></a>如何编写模板？</h1><p>模板完全基于<code>FreeMarker</code>以及实体类信息，<code>FreeMarker</code>参考<a href="https://freemarker.apache.org/docs/index.html">FreeMarker Docs</a></p><p>支持的元素定义如下</p><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><table><thead><tr><th>Freemarker元素</th><th>解释</th><th>示例输出</th></tr></thead><tbody><tr><td><code>$&#123;ftlName&#125;</code></td><td>模板名称</td><td><code>controller.ftl</code></td></tr><tr><td><code>$&#123;ftlPath&#125;</code></td><td>模板目录</td><td><code>src/main/resources/template/</code></td></tr><tr><td><code>$&#123;savePath&#125;</code></td><td>保存路径</td><td><code>src/main/resources/io/github/gcdd1993/controller</code></td></tr><tr><td><code>$&#123;packageName&#125;</code></td><td>java文件包名</td><td><code>io.github.gcdd1993.controller</code></td></tr><tr><td><code>$&#123;className&#125;</code></td><td>java文件类名</td><td><code>UserController</code></td></tr><tr><td><code>$&#123;author&#125;</code></td><td>作者</td><td><code>gaochen</code></td></tr><tr><td><code>$&#123;date&#125;</code></td><td>创建日期，默认为当前日期</td><td><code>2019/6/23</code></td></tr><tr><td><code>$&#123;comments&#125;</code></td><td>注释信息</td><td><code>generated by jpa-codegen</code></td></tr><tr><td><code>$&#123;imports&#125;</code></td><td>java文件引入信息</td><td><code>org.springframework.beans.factory.annotation.Autowired</code></td></tr></tbody></table><h2 id="实体信息"><a href="#实体信息" class="headerlink" title="实体信息"></a>实体信息</h2><table><thead><tr><th>Freemarker元素</th><th>解释</th><th>示例输出</th></tr></thead><tbody><tr><td><code>$&#123;entity.className&#125;</code></td><td>实体类名，<code>class.getSimpleName()</code></td><td>User</td></tr><tr><td><code>$&#123;entity.packageName&#125;</code></td><td>实体包名，<code>class.getPackage().getName()</code></td><td>io.github.gcdd1993</td></tr><tr><td><code>$&#123;entity.tableName&#125;</code></td><td>实体表名，<code>@Table(name=&quot;&quot;)</code></td><td>sys_user</td></tr><tr><td><code>$&#123;entity.id.className&#125;</code></td><td>实体主键类名，<code>@Id</code>注释的字段的类名</td><td>Integer</td></tr><tr><td><code>$&#123;entity.id.packageName&#125;</code></td><td>实体主键包名，<code>@Id</code>注释的字段的包名</td><td>java.lang</td></tr><tr><td><code>$&#123;entity.fields.className&#125;</code></td><td>实体所有字段（只支持基本类型）类名</td><td>String</td></tr><tr><td><code>$&#123;entity.fields.packageName&#125;</code></td><td>实体所有字段（只支持基本类型）包名</td><td>java.lang</td></tr><tr><td><code>$&#123;entity.fields.name&#125;</code></td><td>实体所有字段（只支持基本类型）属性名</td><td>name</td></tr><tr><td><code>$&#123;entity.fields.annotations.className&#125;</code></td><td>实体所有字段注解的类名</td><td>Id</td></tr><tr><td><code>$&#123;entity.fields.annotations.packageName&#125;</code></td><td>实体所有字段注解的包名</td><td>javax.persistence</td></tr></tbody></table><h2 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h2><p>除了以上默认的信息之外，可能会有额外的信息需要填入生成的代码中，jpa-codegen提供直接将配置文件中的配置渲染到模板的能力。</p><p>例如在配置文件<code>autogen.properties</code>写下一行</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom.additional.comment</span>=<span class="string">this is additional comment</span></span><br></pre></td></tr></table></figure><p>在模板中可以使用<code>$&#123;otherParams.additional_comment&#125;</code>获取到该配置。</p><p>要注意的是：自定义配置<strong>使用<code>custom</code>开头</strong>，后面的**配置会将.替换为_**作为<code>FreeMarker</code>模板的key，例如上述的<code>additional.comment</code>使用<code>$&#123;otherParams.additional_comment&#125;</code>获取。</p><h1 id="什么是模块？"><a href="#什么是模块？" class="headerlink" title="什么是模块？"></a>什么是模块？</h1><p>由于代码千变万化，为了尽可能的做到通用性，<a href="https://github.com/gcdd1993/jpa-codegen">jpa-codegen</a>将每一种类型的代码抽象为模块，每一个模块将使用各自的模板，依照实体信息生成代码。</p><p>需要为模板配置一下信息：</p><ul><li>repository.suffix=Repository</li></ul><p>模块类名后缀，生成的类名规则由<strong>实体类名+后缀构成</strong></p><ul><li>repository.template=repository.ftl</li></ul><p>模块使用的<code>Freemarker</code>模板</p><ul><li>repository.flag=entity.repo</li></ul><p>模块标识符，生成的代码包名由<strong>实体类将实体标识符替换为模块标识符</strong>来确认。</p><p>如</p><ul><li>实体包名：<code>io.github.gcdd1993.entity</code></li><li>实体标识符：<code>entity</code></li><li>模块标识符：<code>entity.repo</code></li></ul><p>则生成的<code>repository</code>代码包名为  –&gt; <code>io.github.gcdd1993.entity.repo</code></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;利用业余时间撸了一个Spring Jpa代码生成器&lt;a href=&quot;https://github.com/gcdd1993/jpa-codegen&quot;&gt;jpa-codegen&lt;/a&gt;。&lt;/p&gt;
&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;这是一款基于&lt;code&gt;Freemarker&lt;/code&gt;模板驱动的代码生成器。&lt;/p&gt;
&lt;p&gt;依据现有的实体类代码，自动生成CRUD代码，解放双手，加快开发速度。&lt;/p&gt;
&lt;p&gt;生成的代码包括但不仅限于（可以自定义生成模块）&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu禁用root账号，开启Ubuntu密钥登录</title>
    <link href="https://blog.gcdd.top/p/46186/"/>
    <id>https://blog.gcdd.top/p/46186/</id>
    <published>2019-09-10T04:08:44.000Z</published>
    <updated>2023-08-30T04:52:53.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="新建普通用户"><a href="#新建普通用户" class="headerlink" title="新建普通用户"></a>新建普通用户</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 新建普通用户</span></span><br><span class="line">$ adduser ubuntu</span><br><span class="line">$ apt-get install sudo</span><br><span class="line"><span class="comment">## 将用户加入sudo组</span></span><br><span class="line">$ usermod -a -G sudo ubuntu</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="为普通用户添加公钥"><a href="#为普通用户添加公钥" class="headerlink" title="为普通用户添加公钥"></a>为普通用户添加公钥</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ su ubuntu</span><br><span class="line">$ <span class="built_in">mkdir</span> -p ~/.ssh</span><br><span class="line">$ <span class="built_in">cd</span> ~/.ssh</span><br><span class="line"><span class="comment">## 添加公钥</span></span><br><span class="line">$ <span class="built_in">touch</span> authorized_keys</span><br><span class="line">$ <span class="built_in">cat</span> <span class="string">&#x27;你的公钥字符串&#x27;</span> &gt;&gt; authorized_keys</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> 600 authorized_keys</span><br><span class="line">$ <span class="built_in">chmod</span> 700 ~/.ssh</span><br></pre></td></tr></table></figure><h1 id="设置-SSH，打开密钥登录"><a href="#设置-SSH，打开密钥登录" class="headerlink" title="设置 SSH，打开密钥登录"></a>设置 SSH，打开密钥登录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/ssh/sshd_config</span><br><span class="line">RSAAuthentication <span class="built_in">yes</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 禁用root账号登录</span></span><br><span class="line">PermitRootLogin no</span><br><span class="line"><span class="comment">## 禁用密码登录</span></span><br><span class="line">PasswordAuthentication no</span><br><span class="line"></span><br><span class="line">$ service sshd restart</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;新建普通用户&quot;&gt;&lt;a href=&quot;#新建普通用户&quot; class=&quot;headerlink&quot; title=&quot;新建普通用户&quot;&gt;&lt;/a&gt;新建普通用户&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## 新建普通用户&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ adduser ubuntu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apt-get install sudo&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## 将用户加入sudo组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ usermod -a -G sudo ubuntu&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Ubuntu" scheme="https://blog.gcdd.top/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Java设计模式（四）工厂方法模式</title>
    <link href="https://blog.gcdd.top/p/30626/"/>
    <id>https://blog.gcdd.top/p/30626/</id>
    <published>2019-07-28T15:52:33.000Z</published>
    <updated>2023-08-30T04:52:53.900Z</updated>
    
    <content type="html"><![CDATA[<h1 id="定义与类型"><a href="#定义与类型" class="headerlink" title="定义与类型"></a>定义与类型</h1><ul><li>定义：定义一个创建对象的接口，但让实现这个接口的类来决定实例化哪个类，工厂方法<strong>让类的实例化推迟到子类中进行。</strong></li><li>类型：创建型<span id="more"></span></li></ul><h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><ul><li>创建对象需要大量重复的代码</li><li>客户端(应用层)不依赖于产品类实例如何被创建、实现等细节</li><li>一个类通过其子类来指定创建哪个对象</li></ul><h1 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h1><ul><li>用户只需要关心所需产品对应的工厂，无须关心创建细节</li><li>加入新产品符合开闭原则，提高可扩展性</li></ul><h1 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h1><ul><li>类的个数容易过多，增加复杂度</li><li>增加了系统的抽象性和理解难度</li></ul><h1 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h1><p>工厂方法模式从一定意义上讲是从简单工厂模式衍生过来的，创建产品抽象类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建具体产品</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaVideo</span> <span class="keyword">extends</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;录制Java课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PythonVideo</span> <span class="keyword">extends</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;录制Python视频&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建产品工厂方法抽象类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Video <span class="title function_">getVideo</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建产品工厂方法实现类（每个产品都有对应的实现类）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaVideoFactory</span> <span class="keyword">extends</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Video <span class="title function_">getVideo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaVideo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PythonVideoFactory</span> <span class="keyword">extends</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Video <span class="title function_">getVideo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PythonVideo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">VideoFactory</span> <span class="variable">javaVideoFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaVideoFactory</span>();</span><br><span class="line">        <span class="type">VideoFactory</span> <span class="variable">pythonVideoFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PythonVideoFactory</span>();</span><br><span class="line">        <span class="type">Video</span> <span class="variable">video</span> <span class="operator">=</span> javaVideoFactory.getVideo();</span><br><span class="line">        video.produce();</span><br><span class="line"></span><br><span class="line">        video = pythonVideoFactory.getVideo();</span><br><span class="line">        video.produce();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">录制Java课程</span><br><span class="line">录制Python视频</span><br></pre></td></tr></table></figure><p>如果我们现在新增一个产品–前端课程，我们需要创建产品类，产品工厂类，但是无需改动其他代码，做到了对扩展开放，对修改关闭，符合开闭原则。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FEVideo</span> <span class="keyword">extends</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;录制前端课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FEVideoFactory</span> <span class="keyword">extends</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Video <span class="title function_">getVideo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FEVideo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，我们也不难看出工厂方法模式的缺点–类的个数容易过多，增加复杂度。</p><p>因为一旦我们需要现在产品，就需要创建产品对应的产品实现类，以及产品工厂方法类，无疑增加了类的个数和系统的复杂度。</p><p>完整的UML类图</p><p><img src="https://i.loli.net/2019/07/29/5d3dcbfabe70f65083.png"></p><h1 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h1><h2 id="Collection源码"><a href="#Collection源码" class="headerlink" title="Collection源码"></a><code>Collection</code>源码</h2><p>jdk中典型的工厂方法模式体现为<code>java.util.Collection</code></p><p>抽象产品为<code>java.util.Iterator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>抽象工厂定义了创建产品族的方法<code>java.util.Collection.#iterator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>由子类来定义具体创建产品的逻辑，如<code>java.util.ArrayList.#iterator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Itr</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而具体的产品定义为<code>java.util.ArrayList$Itr</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Itr</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UML类图</p><p><img src="https://i.loli.net/2019/07/29/5d3dcda8d25df62223.png"></p><h2 id="URLStreamHandlerFactory源码"><a href="#URLStreamHandlerFactory源码" class="headerlink" title="URLStreamHandlerFactory源码"></a><code>URLStreamHandlerFactory</code>源码</h2><p>再来看一个典型例子，<code>java.net.URLStreamHandlerFactory</code>作为工厂方法抽象类，定义了创建产品的抽象方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">URLStreamHandlerFactory</span> &#123;</span><br><span class="line">    URLStreamHandler <span class="title function_">createURLStreamHandler</span><span class="params">(String protocol)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>产品抽象类就是<code>java.net.URLStreamHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>产品的工厂方法实现类为<code>sun.misc.Launcher$Factory</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Factory</span> <span class="keyword">implements</span> <span class="title class_">URLStreamHandlerFactory</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> URLStreamHandler <span class="title function_">createURLStreamHandler</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;sun.net.www.protocol&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">Factory</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> URLStreamHandler <span class="title function_">createURLStreamHandler</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> PREFIX + <span class="string">&quot;.&quot;</span> + var1 + <span class="string">&quot;.Handler&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 通过反射创建指定类型的产品</span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">var3</span> <span class="operator">=</span> Class.forName(var2);</span><br><span class="line">                <span class="keyword">return</span> (URLStreamHandler)var3.newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ReflectiveOperationException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(<span class="string">&quot;could not load &quot;</span> + var1 + <span class="string">&quot;system protocol handler&quot;</span>， var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现，工厂实现类通过反射类创建具体的产品实现类，而产品实现类非常多</p><p><img src="https://i.loli.net/2019/07/29/5d3dcf7262c4150474.png"></p><p>这样满足了开闭原则，也没有过多的增加类的数量，值得我们学习。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;定义与类型&quot;&gt;&lt;a href=&quot;#定义与类型&quot; class=&quot;headerlink&quot; title=&quot;定义与类型&quot;&gt;&lt;/a&gt;定义与类型&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;定义：定义一个创建对象的接口，但让实现这个接口的类来决定实例化哪个类，工厂方法&lt;strong&gt;让类的实例化推迟到子类中进行。&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;类型：创建型</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="设计模式" scheme="https://blog.gcdd.top/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Java设计模式（三）简单工厂模式</title>
    <link href="https://blog.gcdd.top/p/21710/"/>
    <id>https://blog.gcdd.top/p/21710/</id>
    <published>2019-07-28T15:14:04.000Z</published>
    <updated>2023-08-30T04:52:53.900Z</updated>
    
    <content type="html"><![CDATA[<h1 id="定义与类型"><a href="#定义与类型" class="headerlink" title="定义与类型"></a>定义与类型</h1><ul><li>定义:由一个工厂对象决定创建出哪一种产品类的实例</li><li>类型:创建型，但不属于GOF23种设计模式</li></ul><span id="more"></span><h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><ul><li>工厂类负责创建的对象比较少</li><li>客户端(应用层)只知道传入工厂类的参数，对于如何创建对象(逻辑)不关心</li></ul><h1 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h1><p>只需要传入一个正确的参数，就可以获取你所需要的对象，而无须知道其创建细节</p><h1 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h1><p>工厂类的<strong>职责相对过重</strong>，增加新的产品，需要修改工厂类的判断逻辑，<strong>违背开闭原则</strong></p><h1 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h1><p>创建一个抽象产品类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>产品实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaVideo</span> <span class="keyword">extends</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;录制Java课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PythonVideo</span> <span class="keyword">extends</span> <span class="title class_">Video</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;录制Python视频&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建产品对应的简单工厂，通过产品类型来创建产品，应用方无需知道创建产品的细节</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Video <span class="title function_">getVideo</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;java&quot;</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaVideo</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;python&quot;</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PythonVideo</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">VideoFactory</span> <span class="variable">videoFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoFactory</span>();</span><br><span class="line">        <span class="type">Video</span> <span class="variable">video</span> <span class="operator">=</span> videoFactory.getVideo(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">        video.produce();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">录制Java课程</span><br></pre></td></tr></table></figure><p>如果增加产品，我们不仅需要修改产品对应的产品类，还需要修改工厂类，违反了开闭原则。</p><p>我们可以通过反射来优化下我们的工厂类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Video <span class="title function_">getVideo</span><span class="params">(Class&lt;? extends Video&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样一来，添加产品的时候不用再修改我们的工厂类，而是直接添加产品即可。</p><p>最终的UML类图</p><p><img src="https://i.loli.net/2019/07/28/5d3dc0457904825584.png"></p><h1 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h1><h2 id="JDK源码"><a href="#JDK源码" class="headerlink" title="JDK源码"></a><code>JDK</code>源码</h2><p>在JDK中，使用简单工厂模式的例子如<code>java.util.Calendar</code>，一组<code>getInstance</code>的重载方法，提供了创建<code>Calendar</code>产品的简单工厂方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Calendar <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Calendar <span class="title function_">getInstance</span><span class="params">(TimeZone zone)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Calendar <span class="title function_">getInstance</span><span class="params">(Locale aLocale)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Calendar <span class="title function_">getInstance</span><span class="params">(TimeZone zone，Locale aLocale)</span></span><br></pre></td></tr></table></figure><p>核心方法为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Calendar <span class="title function_">createCalendar</span><span class="params">(TimeZone zone，Locale aLocale)</span></span><br></pre></td></tr></table></figure><p>源码较长，不贴了，有兴趣的可以去看下源码。</p><p><code>Calendar</code>的UML类图如下</p><p><img src="https://i.loli.net/2019/07/28/5d3dc14d34d8244148.png"></p><h2 id="Logback源码"><a href="#Logback源码" class="headerlink" title="Logback源码"></a><code>Logback</code>源码</h2><p><code>logback</code>类中的简单工厂模式主要体现在<code>ch.qos.logback.classic.LoggerContext#getLogger(String)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Logger <span class="title function_">getLogger</span><span class="params">(<span class="keyword">final</span> String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;name argument cannot be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断log类型返回root节点的logger</span></span><br><span class="line">    <span class="keyword">if</span> (Logger.ROOT_LOGGER_NAME.equalsIgnoreCase(name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果缓存中已经存在的指定的logger，直接返回childLogger</span></span><br><span class="line">    <span class="type">Logger</span> <span class="variable">childLogger</span> <span class="operator">=</span> (Logger) loggerCache.get(name);</span><br><span class="line">    <span class="comment">// if we have the child， then let us return it without wasting time</span></span><br><span class="line">    <span class="keyword">if</span> (childLogger != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> childLogger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下是创建logger的逻辑</span></span><br><span class="line">    String childName;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> LoggerNameUtil.getSeparatorIndexOf(name， i);</span><br><span class="line">        <span class="keyword">if</span> (h == -<span class="number">1</span>) &#123;</span><br><span class="line">            childName = name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            childName = name.substring(<span class="number">0</span>， h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// move i left of the last point</span></span><br><span class="line">        i = h + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (logger) &#123;</span><br><span class="line">            childLogger = logger.getChildByName(childName);</span><br><span class="line">            <span class="keyword">if</span> (childLogger == <span class="literal">null</span>) &#123;</span><br><span class="line">                childLogger = logger.createChildByName(childName);</span><br><span class="line">                loggerCache.put(childName， childLogger);</span><br><span class="line">                incSize();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger = childLogger;</span><br><span class="line">        <span class="keyword">if</span> (h == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> childLogger;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是一个典型的简单工厂方法</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;定义与类型&quot;&gt;&lt;a href=&quot;#定义与类型&quot; class=&quot;headerlink&quot; title=&quot;定义与类型&quot;&gt;&lt;/a&gt;定义与类型&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;定义:由一个工厂对象决定创建出哪一种产品类的实例&lt;/li&gt;
&lt;li&gt;类型:创建型，但不属于GOF23种设计模式&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="设计模式" scheme="https://blog.gcdd.top/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Java设计模式（二）设计模式原则</title>
    <link href="https://blog.gcdd.top/p/64818/"/>
    <id>https://blog.gcdd.top/p/64818/</id>
    <published>2019-07-27T17:34:12.000Z</published>
    <updated>2023-08-30T04:52:53.900Z</updated>
    
    <content type="html"><![CDATA[<p>学习Java设计模式之前，有必要先了解设计模式原则。<span id="more"></span></p><h1 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ul><li><p>一个软件实体如类、模块和函数应该对扩展开放，对修改关闭</p></li><li><p>用抽象构建框架，用实现扩展细节</p></li><li><p>优点：提高软件系统的可复用性及可维护性</p></li></ul><h2 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h2><p>创建接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line">    Integer <span class="title function_">getId</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Double <span class="title function_">getPrice</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaCourse</span> <span class="keyword">implements</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ICourse</span> <span class="variable">iCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaCourse</span>(<span class="number">96</span>， <span class="string">&quot;我的Java课程&quot;</span>， <span class="number">348d</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;课程ID: &quot;</span> + iCourse.getId() + <span class="string">&quot; 课程名称： &quot;</span> + iCourse.getName() + <span class="string">&quot;课程价格： &quot;</span> + iCourse.getPrice());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">课程ID: 96 课程名称： 我的Java课程课程价格： 348.0</span><br></pre></td></tr></table></figure><p>如果现在要打折出售课程，按照开闭原则来设计，对扩展开放，对修改关闭。</p><p>创建打折类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaDiscountCourse</span> <span class="keyword">extends</span> <span class="title class_">JavaCourse</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaDiscountCourse</span><span class="params">(Integer id， String name， Double price)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(id， name， price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getOriginPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getPrice();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getPrice() * <span class="number">0.8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改应用类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ICourse</span> <span class="variable">javaCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaDiscountCourse</span>(<span class="number">96</span>， <span class="string">&quot;我的Java课程&quot;</span>， <span class="number">348d</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JavaDiscountCourse</span> <span class="variable">iCourse</span> <span class="operator">=</span> (JavaDiscountCourse) javaCourse;</span><br><span class="line">        System.out.println(<span class="string">&quot;课程ID: &quot;</span> + iCourse.getId() + <span class="string">&quot; 课程名称： &quot;</span> + iCourse.getName() + <span class="string">&quot;课程原价： &quot;</span> + iCourse.getOriginPrice() + <span class="string">&quot; 课程折后价格： &quot;</span> + iCourse.getPrice());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">课程ID: 96 课程名称： 我的Java课程课程原价： 348.0 课程折后价格： 278.40000000000003</span><br></pre></td></tr></table></figure><p>这里有个要注意的地方，<code>Double * 0.8</code>后输出的浮点数精度有丢失的情况，可以使用<code>BigDecimal</code>的<code>String</code>构造器<code>public BigDecimal(String val)</code>来解决。</p><p>修改<code>JavaDiscountCourse</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaDiscountCourse</span> <span class="keyword">extends</span> <span class="title class_">JavaCourse</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaDiscountCourse</span><span class="params">(Integer id， String name， Double price)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(id， name， price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getOriginPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getPrice();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="built_in">super</span>.getPrice().toString()).multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.8&quot;</span>)).doubleValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">课程ID: 96 课程名称： 我的Java课程课程原价： 348.0 课程折后价格： 278.4</span><br></pre></td></tr></table></figure><h1 id="依赖倒置原则"><a href="#依赖倒置原则" class="headerlink" title="依赖倒置原则"></a>依赖倒置原则</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><ul><li>高层模块不应该依赖低层模块，二者都应该依赖其抽象</li><li>抽象不应该依赖细节;细节应该依赖抽象</li><li>针对接口编程，不要针对实现编程</li><li>优点:可以减少类间的耦合性、提高系统稳定性，提高代码可读性和可维护性，可降低修改程序所造成的风险</li></ul><h2 id="Coding-1"><a href="#Coding-1" class="headerlink" title="Coding"></a>Coding</h2><h3 id="反例"><a href="#反例" class="headerlink" title="反例"></a>反例</h3><p>创建类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Geely</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyJavaCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习Java课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyFECourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习FE课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyPythonCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习Python课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="comment">// v1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Geely</span> <span class="variable">geely</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Geely</span>();</span><br><span class="line">        geely.studyFECourse();</span><br><span class="line">        geely.studyJavaCourse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Geely在学习FE课程</span><br><span class="line">Geely在学习Java课程</span><br></pre></td></tr></table></figure><p>这时候，如果我们要让Geely学习Ruby课程，我们只能在<code>Geely</code>类中添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyRubyCourse</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Geely在学习Ruby课程&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，在Test类中添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geely.studyRubyCourse();</span><br></pre></td></tr></table></figure><div class="note warning flat"><p>不符合依赖倒置原则</p></div><h3 id="正例"><a href="#正例" class="headerlink" title="正例"></a>正例</h3><p>创建接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建类，带有成员变量<code>ICourse course</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Geely</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> ICourse course;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyImoocCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        course.studyCourse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FECourse</span> <span class="keyword">implements</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习FE课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaCourse</span> <span class="keyword">implements</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习Java课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PythonCourse</span> <span class="keyword">implements</span> <span class="title class_">ICourse</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Geely在学习Python课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Geely</span> <span class="variable">geely</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Geely</span>(<span class="keyword">new</span> <span class="title class_">JavaCourse</span>());</span><br><span class="line">        geely.studyImoocCourse();</span><br><span class="line"></span><br><span class="line">        geely.setCourse(<span class="keyword">new</span> <span class="title class_">FECourse</span>());</span><br><span class="line">        geely.studyImoocCourse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Geely在学习Java课程</span><br><span class="line">Geely在学习FE课程</span><br></pre></td></tr></table></figure><p>这样一来，如果要添加新的课程，只需要创建实现类即可。然后应用类设置实现类，无需改动其他代码，符合依赖倒置原则。</p><h1 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h1><h2 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h2><ul><li>不要存在多于一个导致类变更的原因</li><li>一个类/接口/方法只负责一项职责</li><li>优点:降低类的复杂度、提高类的可读性、提高系统的可维护性、降低变更引起的风险</li></ul><h2 id="Coding-2"><a href="#Coding-2" class="headerlink" title="Coding"></a>Coding</h2><h3 id="反例-1"><a href="#反例-1" class="headerlink" title="反例"></a>反例</h3><p>创建类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMoveMode</span><span class="params">(String birdName)</span> &#123;</span><br><span class="line">        System.out.println(birdName + <span class="string">&quot; 用翅膀飞&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Bird</span> <span class="variable">bird</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bird</span>();</span><br><span class="line">        bird.mainMoveMode(<span class="string">&quot;大雁&quot;</span>);</span><br><span class="line">        bird.mainMoveMode(<span class="string">&quot;鸵鸟&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">大雁 用翅膀飞</span><br><span class="line">鸵鸟 用翅膀飞</span><br></pre></td></tr></table></figure><p>鸵鸟是用脚走的，所以我们更改Bird类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMoveMode</span><span class="params">(String birdName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;鸵鸟&quot;</span>.equals(birdName)) &#123;</span><br><span class="line">            System.out.println(birdName + <span class="string">&quot; 用脚走&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(birdName + <span class="string">&quot; 用翅膀飞&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果有更多的鸟类，我们还要写更多的else代码。</p><h3 id="正例-1"><a href="#正例-1" class="headerlink" title="正例"></a>正例</h3><p>我们修改下反例中的例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlyBird</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMoveMode</span><span class="params">(String birdName)</span> &#123;</span><br><span class="line">        System.out.println(birdName + <span class="string">&quot; 用翅膀飞&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WalkBird</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMoveMode</span><span class="params">(String birdName)</span> &#123;</span><br><span class="line">        System.out.println(birdName + <span class="string">&quot; 用脚走&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FlyBird</span> <span class="variable">flyBird</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlyBird</span>();</span><br><span class="line">        flyBird.mainMoveMode(<span class="string">&quot;大雁&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">WalkBird</span> <span class="variable">walkBird</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WalkBird</span>();</span><br><span class="line">        walkBird.mainMoveMode(<span class="string">&quot;鸵鸟&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">大雁 用翅膀飞</span><br><span class="line">鸵鸟 用脚走</span><br></pre></td></tr></table></figure><p>再举一个例子</p><p>创建接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * Created on 2019/7/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICourseContent</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getCoursName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] getCourseVideo();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程管理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * Created on 2019/7/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICourseManager</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">refundCourse</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建实现类，有着课程内容和课程管理两种职能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseImpl</span> <span class="keyword">implements</span> <span class="title class_">ICourseContent</span>， ICourseManager &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCoursName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getCourseVideo() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">studyCourse</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refundCourse</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h1><h2 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h2><ul><li>用多个专门的接口，而不使用单一的总接口，客户端不应该依赖它不需要的接口</li><li>一个类对一个类的依赖应该建立在最小的接口上</li><li>建立单一接口，不要建立庞大臃肿的接口</li><li>尽量细化接口，接口中的方法尽量少</li><li>优点:符合我们常说的高内聚低耦合的设计思想，从而使得类具有很好的可读性、可扩展性和可维护性。</li></ul><div class="note warning flat"><p>注意适度原则，一定要适度</p></div><h2 id="Coding-3"><a href="#Coding-3" class="headerlink" title="Coding"></a>Coding</h2><h3 id="反例-2"><a href="#反例-2" class="headerlink" title="反例"></a>反例</h3><p>创建接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IAnimalAction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">implements</span> <span class="title class_">IAnimalAction</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;鸟 吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;鸟 飞&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 鸟不会游泳，空实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">IAnimalAction</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;狗 吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 狗不会飞，空实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;狗 游泳&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以看出，鸟和狗实现了接口后，各自都有无用的接口，所以违反了接口隔离原则，只能采取空实现的方式。但是对于使用方来说，还是可以调用狗的fly方法，得到空的实现。</p><h3 id="正例-2"><a href="#正例-2" class="headerlink" title="正例"></a>正例</h3><p>将反例中的接口接口拆分为三个独立的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IEatAnimalAction</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IFlyAnimalAction</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISwimAnimalAction</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Dog</code>改为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">IEatAnimalAction</span>，ISwimAnimalAction &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;狗 吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;狗 游泳&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Bird</code>改为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bird</span> <span class="keyword">implements</span> <span class="title class_">IEatAnimalAction</span>，IFlyAnimalAction &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;鸟 吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;鸟 飞&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就成功的将一个大接口，优化为分摊职责的小接口，实现类可以根据需要实现多个职能接口。</p><h1 id="迪米特原则"><a href="#迪米特原则" class="headerlink" title="迪米特原则"></a>迪米特原则</h1><h2 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h2><ul><li>一个对象应该对其他对象保持最少的了解。又叫最少知道原则</li><li>尽量降低类与类之间的耦合</li><li>优点:降低类之间的耦合</li></ul><h2 id="Coding-4"><a href="#Coding-4" class="headerlink" title="Coding"></a>Coding</h2><h3 id="反例-3"><a href="#反例-3" class="headerlink" title="反例"></a>反例</h3><p>创建课程类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Course</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建项目经理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeamLeader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkNumberOfCourse</span><span class="params">(List&lt;Course&gt; courseList)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;在线课程的数量是 ：&quot;</span> + courseList.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建老板类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commandCheckNumber</span><span class="params">(TeamLeader teamLeader)</span> &#123;</span><br><span class="line">        List&lt;Course&gt; courseList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            courseList.add(<span class="keyword">new</span> <span class="title class_">Course</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        teamLeader.checkNumberOfCourse(courseList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在线课程的数量是 ：<span class="number">20</span></span><br></pre></td></tr></table></figure><p>我们仔细分析一下，其实老板并不需要知道课程的细节，只需要问一下项目经理，有多少课程，项目经理直接告诉老板有20节在线课程。而不是老板将课程列出，让项目经理统计。</p><p>我们看下UML类图</p><p><img src="https://i.loli.net/2019/07/28/5d3c9e390ca6837252.png"></p><h3 id="正例-3"><a href="#正例-3" class="headerlink" title="正例"></a>正例</h3><p>项目经理类修改为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeamLeader</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkNumberOfCourse</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Course&gt; courseList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            courseList.add(<span class="keyword">new</span> <span class="title class_">Course</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;在线课程的数量是 ：&quot;</span> + courseList.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>老板类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commandCheckNumber</span><span class="params">(TeamLeader teamLeader)</span> &#123;</span><br><span class="line">        teamLeader.checkNumberOfCourse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时候运行一下，结果一样。但是从UML类图上来看，是有很大的优化的。</p><p><img src="https://i.loli.net/2019/07/28/5d3c9cf88cb0392036.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;学习Java设计模式之前，有必要先了解设计模式原则。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="设计模式" scheme="https://blog.gcdd.top/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="UML" scheme="https://blog.gcdd.top/tags/UML/"/>
    
  </entry>
  
  <entry>
    <title>Java设计模式（一）UML总结</title>
    <link href="https://blog.gcdd.top/p/63230/"/>
    <id>https://blog.gcdd.top/p/63230/</id>
    <published>2019-07-27T16:02:06.000Z</published>
    <updated>2023-08-30T04:52:53.899Z</updated>
    
    <content type="html"><![CDATA[<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>统一建模语言(英语: Unified Modeling Language ，缩写UML)是非专利的第三代建模和规约语言。</p><span id="more"></span><h1 id="UML特点"><a href="#UML特点" class="headerlink" title="UML特点"></a>UML特点</h1><ul><li>UML是一种开放的方法</li><li>用于说明、可视化、构建和编写一个正在开发的面向对象的、软件密集系统的制品的开放方法。</li><li>UML展现了一系列最佳工程实践，这些最佳实践在对大规模，复杂系统进行建模方面，特别是在软件架构层次已经被验证有效。</li></ul><h1 id="UML2-2分类"><a href="#UML2-2分类" class="headerlink" title="UML2.2分类"></a>UML2.2分类</h1><p>UML2.2中一共定义了14种图示，分类如下:</p><ul><li>结构式图形：强调的是系统式的建模<ul><li>静态图(类图，对象图，包图)</li><li>实现图(组件图，部署图)</li><li>剖面图</li><li>复合结构图</li></ul></li><li>行为式图形：强调系统模型中触发的事件<ul><li>活动图</li><li>状态图</li><li>用例图</li></ul></li><li>交互式图形：属于行为式图形子集合，强调系统模型中的资料流程<ul><li>通信图</li><li>交互概述图(UML2.0)</li><li>时序图(UML2.0)</li><li>时间图(UML2.0)</li></ul></li></ul><h1 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><p>Class Diagram:用于表示类、接口、实例等之间相互的静态关系。虽然名字叫类图，但类图中并不只有类（也包括权限，属性，方法等）。</p><h2 id="记忆技巧"><a href="#记忆技巧" class="headerlink" title="记忆技巧"></a>记忆技巧</h2><h3 id="箭头方向"><a href="#箭头方向" class="headerlink" title="箭头方向"></a>箭头方向</h3><ul><li>定义子类时需要通过extends关键字指定父类</li><li>子类一定是知道父类定义的，但父类并不知道子类的定义</li><li>只有知道对方信息时才能指向对方</li><li>所以箭头方向是<strong>从子类指向父类</strong></li></ul><h3 id="实线-继承-虚线-实现"><a href="#实线-继承-虚线-实现" class="headerlink" title="实线-继承|虚线-实现"></a>实线-继承|虚线-实现</h3><p><img src="https://i.loli.net/2019/07/28/5d3c7b0d81dbf76419.png"></p><ul><li>空心三角箭头:继承或实现</li><li>实线继承， is a关系，扩展目的，不虚，很结实</li><li>虚线-实现，虚线代表“虚”，无实体</li></ul><h3 id="实线-关联-虚线-依赖"><a href="#实线-关联-虚线-依赖" class="headerlink" title="实线-关联|虚线-依赖"></a>实线-关联|虚线-依赖</h3><p><img src="https://i.loli.net/2019/07/28/5d3c7b7e556e646414.png"></p><ul><li>实线-关联关系:关系稳定，实打实的关系，铁哥们</li><li>表示一个类对象和另一个类对象有关联</li><li>通常是一个类中有另一个类对象做为属性</li></ul><p><img src="https://i.loli.net/2019/07/28/5d3c7b8f3d0d786176.png"></p><ul><li>虚线-依赖关系:临时用一下，若即若离，虚无缥缈，若有若无</li><li>表示一种使用关系，一个类需要借助另一个类来实现功能</li><li>一般是一个类使用另一个类做为参数使用，或作为返回值</li></ul><h3 id="空心菱形-聚合-实心菱形-组合"><a href="#空心菱形-聚合-实心菱形-组合" class="headerlink" title="空心菱形-聚合|实心菱形-组合"></a>空心菱形-聚合|实心菱形-组合</h3><ul><li>菱形就是一个盛东西的器皿(例如盘子)</li><li>聚合:代表空器皿里可以放很多相同东西，聚在一起(箭头方向所指的类)</li><li>组合:代表满器皿里已经有实体结构的存在，生死与共</li></ul><p><img src="https://i.loli.net/2019/07/28/5d3c7eaf0d25040127.png"></p><ul><li>整体和局部的关系，两者有着独立的生命周期，是has a的关系</li><li>弱关系</li><li>消极的词:弱-空</li></ul><p><img src="https://i.loli.net/2019/07/28/5d3c7ed2ce90136239.png"></p><ul><li>整体与局部的关系，和聚合的关系相比，关系更加强烈</li><li>两者有相同的生命周期， contains-a的关系</li><li>强关系</li><li>积极的词:强-满</li></ul><h4 id="常见数字表达及含义，假设有A类和B类，数字标记在A类侧"><a href="#常见数字表达及含义，假设有A类和B类，数字标记在A类侧" class="headerlink" title="常见数字表达及含义，假设有A类和B类，数字标记在A类侧"></a>常见数字表达及含义，假设有A类和B类，数字标记在A类侧</h4><ul><li>0..1:0或1个实例.</li><li>0..*:0或多个实例.</li><li>1..1:1个实例.</li><li>1:只能有一个实例.</li><li>1..*:至少有一个实例.</li></ul><h2 id="类图详解"><a href="#类图详解" class="headerlink" title="类图详解"></a>类图详解</h2><p><img src="https://i.loli.net/2019/07/28/5d3c82bc3713e90509.png"></p><p>类图从上到下包含：</p><ul><li>类名：抽象类使用斜体表示，接口用&lt;<interface xxx>&gt;表示</li><li>属性：访问权限+属性名：属性类型<ul><li><code>+：public</code></li><li><code>-：private</code></li><li><code>#：protected</code></li><li><code>~：default</code></li><li>下横线表示static</li></ul></li><li>方法: 访问权限+方法名：返回值类型<ul><li><code>+：public</code></li><li><code>-：private</code></li><li><code>#：protected</code></li><li><code>~：default</code></li><li>下横线表示static</li><li>斜体表示抽象方法</li></ul></li></ul><p>典型的类图表示：</p><p><img src="https://i.loli.net/2019/07/28/5d3c8422bfd5d69590.png"></p><h1 id="UML时序图"><a href="#UML时序图" class="headerlink" title="UML时序图"></a>UML时序图</h1><p>Sequence Diagram :是显示对象之间交互的图，这些对象是按时间顺序排列的。</p><p>时序图中包括的建模元素主要有:</p><ul><li>对象(Actor)</li><li>生命线(Lifeline)</li><li>控制焦点(Focus of control)</li><li>消息(Message)等</li></ul><p>典型的一个时序图如下：</p><p><img src="https://i.loli.net/2019/07/28/5d3c82384ae5224680.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h1&gt;&lt;p&gt;统一建模语言(英语: Unified Modeling Language ，缩写UML)是非专利的第三代建模和规约语言。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="设计模式" scheme="https://blog.gcdd.top/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="UML" scheme="https://blog.gcdd.top/tags/UML/"/>
    
  </entry>
  
  <entry>
    <title>Spring Mvc Http 400 Bad Request问题排查</title>
    <link href="https://blog.gcdd.top/p/6604/"/>
    <id>https://blog.gcdd.top/p/6604/</id>
    <published>2019-07-26T10:32:46.000Z</published>
    <updated>2023-08-30T04:52:53.903Z</updated>
    
    <content type="html"><![CDATA[<p>如果遇到了Spring MVC报错400，而且没有返回任何信息的情况下该如何排查问题？<span id="more"></span></p><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>一直都没毛病的接口，今天测试的时候突然报错<code>400 Bad Request</code>，而且Response没有返回任何信息。</p><p><img src="https://i.loli.net/2019/07/26/5d3ae61b24ab372943.png"></p><p><img src="https://i.loli.net/2019/07/26/5d3ad97a0da2b22891.png"></p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>尝试了一下午，终于找到了排查这类问题的办法。</p><p>我们知道，在Spring MVC里面，<br><code>org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler</code><br>负责所有异常的统一处理。我们只要在方法<code>handleException</code>打上断点即可。</p><p><img src="https://i.loli.net/2019/07/26/5d3ada319940784853.png"></p><p>点开发现，原来是Lombok的问题。报错如下</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Could not read JSON document: Can not construct instance of xxx: no suitable constructor found, can not deserialize from Object value (missing default constructor or creator, or perhaps need to add/enable type information?)</span><br><span class="line"> at [Source: java.io.PushbackInputStream@12544acd; line: 2, column: 5]</span><br></pre></td></tr></table></figure><p>Lombok没有为我们自动生成类的构造函数。我们在目标类加上<code>@NoArgsConstructor</code>即可解决。</p><h1 id="刨根问底"><a href="#刨根问底" class="headerlink" title="刨根问底"></a>刨根问底</h1><p>为什么Lombok自动生成的类，没有可供Jackson反序列化的构造函数呢？我看了一下生成的字节码文件，里面确实不存在无参构造和全参构造函数，唯一的构造函数是带一个参数的。</p><p>目标类使用了<code>@Data</code>注解，而<code>@Data</code>注解的声明如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates getters for all fields, a useful toString method, and hashCode and equals implementations that check</span></span><br><span class="line"><span class="comment"> * all non-transient fields. Will also generate setters for all non-final fields, as well as a constructor.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Equivalent to &#123;<span class="doctag">@code</span> <span class="doctag">@Getter</span> <span class="doctag">@Setter</span> <span class="doctag">@RequiredArgsConstructor</span> <span class="doctag">@ToString</span> <span class="doctag">@EqualsAndHashCode</span>&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Complete documentation is found at &lt;a href=&quot;https://projectlombok.org/features/Data&quot;&gt;the project lombok features page for &amp;#64;Data&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Getter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Setter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> RequiredArgsConstructor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ToString</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EqualsAndHashCode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> lombok.Value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Data &#123;</span><br><span class="line">String <span class="title function_">staticConstructor</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单来说，<code>@Data</code>包含了以下注解的功能</p><ul><li>@Getter</li><li>@Setter</li><li>@RequiredArgsConstructor</li><li>@ToString</li><li>@EqualsAndHashCode</li></ul><p>而“罪魁祸首”就是<code>@RequiredArgsConstructor</code>了，它的作用是</p><blockquote><p>为每个需要特殊处理的字段（final修饰的或者是@NotNull注释的字段）生成一个带有1个参数的构造函数。</p></blockquote><p>而目标类恰巧有一个字段就是<code>@NotNull</code>注解修饰的，所以生成了单参构造函数。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://projectlombok.org/features/all">Lombok Features</a></li><li><a href="https://www.baeldung.com/global-error-handler-in-a-spring-rest-api">Spring MVC自定义全局异常处理</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;如果遇到了Spring MVC报错400，而且没有返回任何信息的情况下该如何排查问题？</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Nginx配置Https指南</title>
    <link href="https://blog.gcdd.top/p/17023/"/>
    <id>https://blog.gcdd.top/p/17023/</id>
    <published>2019-07-24T08:42:05.000Z</published>
    <updated>2023-08-30T04:52:53.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文是对Nginx配置SSL证书的总结。<span id="more"></span></p><h1 id="申请SSL证书"><a href="#申请SSL证书" class="headerlink" title="申请SSL证书"></a>申请SSL证书</h1><blockquote><p>你可以从任何证书提供商处申请证书，这里以<a href="https://console.aliyun.com/">阿里云</a>为例。</p></blockquote><h2 id="打开阿里云SSL证书控制台，点击购买证书"><a href="#打开阿里云SSL证书控制台，点击购买证书" class="headerlink" title="打开阿里云SSL证书控制台，点击购买证书"></a>打开阿里云SSL证书控制台，点击购买证书</h2><p><img src="https://i.loli.net/2019/07/24/5d381c3210a9e21599.png"></p><h2 id="选择免费型一年期的证书，点击立即购买"><a href="#选择免费型一年期的证书，点击立即购买" class="headerlink" title="选择免费型一年期的证书，点击立即购买"></a>选择免费型一年期的证书，点击立即购买</h2><div class="note warning flat"><p>注意，1年到期后别忘记重新申请证书！</p></div><p><img src="https://i.loli.net/2019/07/24/5d381c61c4d0546560.png"></p><h2 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h2><p>放心大胆的支付吧，不用钱！</p><p><img src="https://i.loli.net/2019/07/24/5d381d0b2668081706.png"></p><h1 id="验证SSL证书"><a href="#验证SSL证书" class="headerlink" title="验证SSL证书"></a>验证SSL证书</h1><h2 id="购买完成之后，返回SSL证书控制台，你应该会看到刚才购买的证书。我们点击申请"><a href="#购买完成之后，返回SSL证书控制台，你应该会看到刚才购买的证书。我们点击申请" class="headerlink" title="购买完成之后，返回SSL证书控制台，你应该会看到刚才购买的证书。我们点击申请"></a>购买完成之后，返回SSL证书控制台，你应该会看到刚才购买的证书。我们点击申请</h2><p><img src="https://i.loli.net/2019/07/24/5d381d59ca32b79031.png"></p><h2 id="填写域名（必须是你自己的或者有管理权的域名）和相关信息，完成后点击下一步。"><a href="#填写域名（必须是你自己的或者有管理权的域名）和相关信息，完成后点击下一步。" class="headerlink" title="填写域名（必须是你自己的或者有管理权的域名）和相关信息，完成后点击下一步。"></a>填写域名（必须是你自己的或者有管理权的域名）和相关信息，完成后点击下一步。</h2><div class="note warning flat"><p>注意，免费型证书只支持单个域名！例如你要为<a href="http://www.example.com申请证书,你必须填写www.example.com,而不能是example.com./">www.example.com申请证书，你必须填写www.example.com，而不能是example.com。</a></p></div><p><img src="https://i.loli.net/2019/07/24/5d381dd8a4b6091205.png"></p><h2 id="在DNS服务商处配置阿里云提供的验证信息。"><a href="#在DNS服务商处配置阿里云提供的验证信息。" class="headerlink" title="在DNS服务商处配置阿里云提供的验证信息。"></a>在DNS服务商处配置阿里云提供的验证信息。</h2><p>例如<a href="https://www.dnspod.cn/console/dashboard">DNSPod</a>，填写主机记录，记录值和记录类型，然后点击保存。</p><p><img src="https://i.loli.net/2019/07/24/5d381f607ee9d69062.png"></p><div class="note info flat"><p>耐心等待TTL刷新（一般为10分钟，也可能花不了10分钟）。</p></div><p>回到阿里云SSL证书申请页面，点击验证。</p><p><img src="https://i.loli.net/2019/07/24/5d381ebc2cb3f86338.png"></p><h2 id="签发域名"><a href="#签发域名" class="headerlink" title="签发域名"></a>签发域名</h2><p>验证通过后，证书提供商将会为你的域名颁发证书。在阿里云SSL证书控制台的已签发列表下可以找到你的域名对应的SSL证书。</p><p><img src="https://i.loli.net/2019/07/24/5d382048c586e43053.png"></p><h2 id="下载证书"><a href="#下载证书" class="headerlink" title="下载证书"></a>下载证书</h2><p>下载Nginx对应的SSL证书<code>xx_nginx.zip</code>，准备配置Nginx。</p><p><img src="https://i.loli.net/2019/07/24/5d3821f82182787100.png"></p><h1 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h1><div class="note info flat"><p>如果你还没有安装Nginx，可以参考<a href="https://gcdd1993.github.io/p/8505/#Nginx">部署Nginx</a></p></div><h2 id="上传证书"><a href="#上传证书" class="headerlink" title="上传证书"></a>上传证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> /etc/nginx/certs</span><br><span class="line">$ sudo <span class="built_in">cd</span> /etc/nginx/certs</span><br><span class="line"><span class="comment">## 上传你的证书至此目录</span></span><br><span class="line">$ sudo <span class="built_in">ls</span> -l</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jul 24 17:15 ./</span><br><span class="line">drwxr-xr-x 7 root root 4096 Jul 24 17:15 ../</span><br><span class="line">-rw-r--r-- 1 root root 4053 Jul 24 16:49 xx_nginx.zip</span><br><span class="line">$ sudo unzip xx_nginx.zip</span><br><span class="line">$ sudo <span class="built_in">ls</span> -l</span><br><span class="line">-rw-r--r-- 1 root root 1679 Jul 24 16:48 xx.key <span class="comment">## ssl cert key</span></span><br><span class="line">-rw-r--r-- 1 root root 3667 Jul 24 16:48 xx.pem <span class="comment">## ssl cert</span></span><br></pre></td></tr></table></figure><p>一切准备就绪后，可以开始修改我们的<code>Nginx</code>配置文件了。</p><h2 id="修改Nginx配置文件"><a href="#修改Nginx配置文件" class="headerlink" title="修改Nginx配置文件"></a>修改Nginx配置文件</h2><p>将Http修改为Https非常简单，只需要修改一处内容，并添加若干代码。</p><ol><li>将<code>listen 80;</code>修改为<code>listen 443;</code></li><li>在<code>server</code>块中添加以下代码</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_certificate</span> certs/xx.pem;</span><br><span class="line"><span class="attribute">ssl_certificate_key</span> certs/xx.key;</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br></pre></td></tr></table></figure><p>修改完成后，重启Nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service nginx reload</span><br><span class="line">$ sudo service nginx restart</span><br></pre></td></tr></table></figure><p>好了，使用Https访问你的网站吧。</p><h2 id="Http强制转向Https"><a href="#Http强制转向Https" class="headerlink" title="Http强制转向Https"></a>Http强制转向Https</h2><div class="note warning flat"><p>注意，以上修改完成后，只能使用Https访问了，但是往往我们不希望用户使用Http访问的时候出现404的情况。那么，我们可以简单的将80端口的用户转发到443端口，来达到Http和Https共存的状态。</p></div><p>在Nginx配置文件中添加</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> xx.xx.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启Nginx</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;本文是对Nginx配置SSL证书的总结。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Nginx" scheme="https://blog.gcdd.top/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>使用Hyper-V替代VMware</title>
    <link href="https://blog.gcdd.top/p/14834/"/>
    <id>https://blog.gcdd.top/p/14834/</id>
    <published>2019-07-19T05:52:46.000Z</published>
    <updated>2023-08-30T04:52:53.907Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hyper-V是什么"><a href="#Hyper-V是什么" class="headerlink" title="Hyper-V是什么"></a>Hyper-V是什么</h1><blockquote><p>Hyper-V硬件要求为Windows 10 企业版、专业版或教育版，如果你使用的是Mac或者Linux的电脑，可以不往下看了。</p></blockquote><p>虚拟机大家都懂吧，简单来说，Hyper-V就是虚拟机管理工具。如果你使用过<a href="https://www.vmware.com/products/workstation-pro.html">VMware Workstation Pro</a>或者是<a href="https://www.virtualbox.org/">VirtualBox</a>，那你一定不陌生了。</p><span id="more"></span><p>具体来说，Hyper-V 提供硬件虚拟化。 这意味着每个虚拟机都在虚拟硬件上运行。 Hyper-V 允许你创建虚拟硬盘驱动器、虚拟交换机以及许多其他虚拟设备，所有这些都可以添加到虚拟机中。</p><h1 id="为什么要使用Hyper-V而不是VMware？"><a href="#为什么要使用Hyper-V而不是VMware？" class="headerlink" title="为什么要使用Hyper-V而不是VMware？"></a>为什么要使用Hyper-V而不是VMware？</h1><p>首先为什么要使用虚拟机？</p><ul><li>运行需要早期版本的Windows 操作系统或非Windows 操作系统的软件。</li><li>实验其他操作系统。 通过虚拟机，可轻松创建和删除不同的操作系统。</li><li>使用多个虚拟机在多个操作系统上测试软件。 通过虚拟机，可以在一部台式机或便携式计算机上运行所有内容。</li></ul><p>那么，为什么要使用Hyper-V？</p><ol><li>首先，Hyper-V是Windows 10 专业版自带的功能，无需安装其他任何工具</li><li><a href="https://hub.docker.com/?overlay=onboarding">Docker for Windows</a>推荐使用Hyper-V作为虚拟化方案</li><li>免费</li></ol><p>所以，在Hyper-V能胜任的场景下，我们应该使用Hyper-V。</p><h1 id="如何使用Hyper-V"><a href="#如何使用Hyper-V" class="headerlink" title="如何使用Hyper-V"></a>如何使用Hyper-V</h1><h2 id="检查系统要求"><a href="#检查系统要求" class="headerlink" title="检查系统要求"></a>检查系统要求</h2><ul><li>Windows 10 <strong>企业版、专业版或教育版</strong>。</li><li>具有二级地址转换 (SLAT) 的 64 位处理器。</li><li>虚拟机监视器模式扩展的 CPU 支持 (Intel Cpu 上的 VT-c)。</li><li>最小 4 GB 内存。</li></ul><div class="note warning flat"><p>注意：系统必须是Windows 10企业版、专业版或教育版。</p></div><h2 id="开启Hyper-V"><a href="#开启Hyper-V" class="headerlink" title="开启Hyper-V"></a>开启Hyper-V</h2><h3 id="使用-PowerShell-启用-Hyper-V"><a href="#使用-PowerShell-启用-Hyper-V" class="headerlink" title="使用 PowerShell 启用 Hyper-V"></a>使用 PowerShell 启用 Hyper-V</h3><ol><li>以管理员身份打开 PowerShell 控制台。</li><li>运行以下命令：</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enable-WindowsOptionalFeature</span> <span class="literal">-Online</span> <span class="literal">-FeatureName</span> Microsoft<span class="literal">-Hyper-V</span> <span class="literal">-All</span></span><br></pre></td></tr></table></figure><p>如果无法找到此命令，请确保你以管理员身份运行 PowerShell。</p><div class="note warning flat"><p>安装完成后，请重启。</p></div><h3 id="使用-CMD-和-DISM-启用-Hyper-V"><a href="#使用-CMD-和-DISM-启用-Hyper-V" class="headerlink" title="使用 CMD 和 DISM 启用 Hyper-V"></a>使用 CMD 和 DISM 启用 Hyper-V</h3><p>部署映像服务和管理工具 (DISM) 可帮助配置 Windows 和 Windows 映像。 在众多应用程序中，DISM 可以在操作系统运行时启用 Windows 功能。</p><p>使用 DISM 启用 Hyper-V 角色：</p><ol><li>以管理员身份打开 PowerShell 或 CMD 会话。</li><li>键入下列命令：</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /Online /<span class="built_in">Enable-Feature</span> /All /FeatureName:Microsoft<span class="literal">-Hyper-V</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/07/19/5d316faceaaa555921.png"></p><h3 id="通过“设置”启用-Hyper-V-角色"><a href="#通过“设置”启用-Hyper-V-角色" class="headerlink" title="通过“设置”启用 Hyper-V 角色"></a>通过“设置”启用 Hyper-V 角色</h3><p>推荐使用这种方式</p><ol><li>右键单击 Windows 按钮并选择“应用和功能”。</li><li>在 “相关设置” 下的右侧选择 “<strong>程序和功能</strong>“。</li><li>选择“<strong>打开或关闭 Windows 功能</strong>”。</li><li>选择 <strong>Hyper-V</strong>，然后单击<strong>确定</strong>。</li></ol><p><img src="https://i.loli.net/2019/07/19/5d317018d187515264.png"></p><div class="note warning flat"><p>同样的，安装完成后，请重启。</p></div><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><p>在开始菜单找到并打开<strong>Hyper-V管理器</strong>，它应该位于Windows管理工具文件夹下面。</p><p>或者直接搜索<code>Hyper-V</code></p><p><img src="https://i.loli.net/2019/07/19/5d317163c37fc46784.png"></p><p>打开后界面如下，我觉得比VMware界面好看点。</p><p><img src="https://i.loli.net/2019/07/19/5d3171f62f3db74558.png"></p><h3 id="快速创建"><a href="#快速创建" class="headerlink" title="快速创建"></a>快速创建</h3><p>点击快速创建，你将会看到</p><p><img src="https://i.loli.net/2019/07/19/5d31724c78a8053748.png"></p><p>类似于在线安装，比较简单。</p><p>我尝试了导入本地安装源安装Ubuntu 16.04，但是启动报错，找不到Boot信息。</p><div class="note info flat"><p>可能原因是：我的电脑不支持第二代虚拟机世代（是一种较新的虚拟化功能）</p></div><h3 id="新建虚拟机"><a href="#新建虚拟机" class="headerlink" title="新建虚拟机"></a>新建虚拟机</h3><p>点击新建虚拟机，你将会进入一下界面</p><p><img src="https://i.loli.net/2019/07/19/5d31739e288e621269.png"></p><p>跟着一步步来吧，首先你得准备好一个系统镜像（ISO结尾的系统镜像文件）</p><p><img src="https://i.loli.net/2019/07/19/5d31745826fc036003.png"></p><p><img src="https://i.loli.net/2019/07/19/5d317487c047867319.png"></p><p><img src="https://i.loli.net/2019/07/19/5d3174d7987ff97371.png"></p><p><img src="https://i.loli.net/2019/07/19/5d317516e579835760.png"></p><p><img src="https://i.loli.net/2019/07/19/5d317561c1c2357128.png"></p><p>点击下一步，完成。</p><p><img src="https://i.loli.net/2019/07/19/5d31761f0c16026230.png"></p><p>接着，就进入了Ubuntu系统安装环节，省略了，大家应该都会装的。</p><h3 id="导入虚拟机"><a href="#导入虚拟机" class="headerlink" title="导入虚拟机"></a>导入虚拟机</h3><p>除了自己创建，我们还可以导入别人创建好的虚拟机</p><p>点击导入虚拟机</p><p><img src="https://i.loli.net/2019/07/19/5d31781f6a53f37502.png"></p><p><img src="https://i.loli.net/2019/07/19/5d31785537ce278225.png"></p><p>以下是我创建的Ubuntu 16.04虚拟机，你可以直接导入使用。</p><p><a href="https://1drv.ms/f/s!AjfBPvEeW2r2hukqwAdOrPSMPpKZ4A">https://1drv.ms/f/s!AjfBPvEeW2r2hukqwAdOrPSMPpKZ4A</a></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://docs.microsoft.com/zh-cn/virtualization/hyper-v-on-windows/about/">Windows 10 上的 Hyper-V 简介</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Hyper-V是什么&quot;&gt;&lt;a href=&quot;#Hyper-V是什么&quot; class=&quot;headerlink&quot; title=&quot;Hyper-V是什么&quot;&gt;&lt;/a&gt;Hyper-V是什么&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Hyper-V硬件要求为Windows 10 企业版、专业版或教育版，如果你使用的是Mac或者Linux的电脑，可以不往下看了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;虚拟机大家都懂吧，简单来说，Hyper-V就是虚拟机管理工具。如果你使用过&lt;a href=&quot;https://www.vmware.com/products/workstation-pro.html&quot;&gt;VMware Workstation Pro&lt;/a&gt;或者是&lt;a href=&quot;https://www.virtualbox.org/&quot;&gt;VirtualBox&lt;/a&gt;，那你一定不陌生了。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Hyper-V" scheme="https://blog.gcdd.top/tags/Hyper-V/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 搭建phpcms</title>
    <link href="https://blog.gcdd.top/p/5357/"/>
    <id>https://blog.gcdd.top/p/5357/</id>
    <published>2019-06-24T09:50:42.000Z</published>
    <updated>2023-08-30T04:52:53.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装Apache2"><a href="#安装Apache2" class="headerlink" title="安装Apache2"></a>安装Apache2</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update -y</span><br><span class="line">$ sudo apt-get install apache2 -y</span><br><span class="line">$ sudo systemctl start apache2.service</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install mysql-server -y</span><br><span class="line">$ sudo /usr/bin/mysql_secure_installation</span><br><span class="line"><span class="comment">## 都选y就行</span></span><br><span class="line">$ mysql -u root -p </span><br><span class="line">mysql&gt; CREATE DATABASE js_website;</span><br><span class="line"><span class="comment">## 导入数据</span></span><br><span class="line">mysql&gt; <span class="built_in">source</span> /tmp/jskj.sql;</span><br><span class="line">mysql&gt; \q;</span><br></pre></td></tr></table></figure><h1 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install php -y;</span><br><span class="line">$ sudo apt-get install -y php-&#123;bcmath,bz2,intl,gd,mbstring,mcrypt,mysql,zip&#125; &amp;&amp; sudo apt-get install libapache2-mod-php -y;</span><br></pre></td></tr></table></figure><h1 id="部署PHP官网"><a href="#部署PHP官网" class="headerlink" title="部署PHP官网"></a>部署PHP官网</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> /var/www/html/phpcms</span><br><span class="line">$ <span class="built_in">cd</span> /var/www/html/phpcms</span><br><span class="line"><span class="comment"># 上传phpcms.zip包至此目录</span></span><br><span class="line">$ unzip phpcms.zip</span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">drwxr-xr-x 11 root root      4096 Jun 24 17:21 ./</span><br><span class="line">drwxr-xr-x  3 root root      4096 Jun 24 17:21 ../</span><br><span class="line">-rw-r--r--  1 root root        48 Jun 24 15:53 admin.php</span><br><span class="line">drwxr-xr-x  3 root root      4096 Jun 24 15:53 api/</span><br><span class="line">-rw-r--r--  1 root root       991 Jun 24 15:53 api.php</span><br><span class="line">drwxr-xr-x 18 root root      4096 Jun 24 15:53 caches/</span><br><span class="line">-rw-r--r--  1 root root       104 Jun 24 15:53 crossdomain.xml</span><br><span class="line">drwxr-xr-x  6 root root      4096 Jun 24 15:53 custom/</span><br><span class="line">-rw-r--r--  1 root root      3158 Jun 24 15:53 favicon.ico</span><br><span class="line">drwxr-xr-x  2 root root      4096 Jun 24 15:53 html/</span><br><span class="line">-rw-r--r--  1 root root      4444 Jun 24 15:53 index.htm</span><br><span class="line">-rw-r--r--  1 root root     22758 Jun 24 15:53 index.html</span><br><span class="line">-rw-r--r--  1 root root       318 Jun 24 15:53 index.php</span><br><span class="line">-rw-r--r--  1 root root       523 Jun 24 15:53 js.html</span><br><span class="line">drwxr-xr-x  8 root root      4096 Jun 24 15:53 mes/</span><br><span class="line">drwxr-xr-x  8 root root      4096 Jun 24 15:53 phpcms/</span><br><span class="line">-rw-r--r--  1 root root 168191200 Jun 24 16:38 phpcms.zip</span><br><span class="line">drwxr-xr-x  7 root root      4096 Jun 24 15:53 phpsso_server/</span><br><span class="line">-rw-r--r--  1 root root      3621 Jun 24 15:53 plugin.php</span><br><span class="line">-rw-r--r--  1 root root       170 Jun 24 15:53 robots.txt</span><br><span class="line">drwxr-xr-x  6 root root      4096 Jun 24 15:53 statics/</span><br><span class="line">drwxr-xr-x  4 root root      4096 Jun 24 15:53 uploadfile/</span><br></pre></td></tr></table></figure><p>👉这里的zip压缩包，是已经install后的phpcms，因为项目经理给我的就是安装好的，所以就直接用了。</p><p>反正原理都一样，配置Apache解析域名指向路径就行。</p><h2 id="配置Apache"><a href="#配置Apache" class="headerlink" title="配置Apache"></a>配置Apache</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/phpcms.conf</span><br><span class="line">$ <span class="built_in">cp</span> /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/phpcms-mes.conf</span><br><span class="line">$ <span class="built_in">ln</span> -s /etc/apache2/sites-available/phpcms.conf /etc/apache2/sites-enabled/phpcms.conf</span><br><span class="line">$ <span class="built_in">ln</span> -s /etc/apache2/sites-available/phpcms-mes.conf /etc/apache2/sites-enabled/phpcms-mes.conf</span><br><span class="line">$ vim /etc/apache2/sites-available/phpcms.conf</span><br><span class="line">ServerName js.dbpe-cps.com</span><br><span class="line"><span class="comment"># ServerAdmin webmaster@localhost</span></span><br><span class="line">DocumentRoot /var/www/html/phpcms</span><br><span class="line">$ vim /etc/apache2/sites-available/phpcms-mes.conf</span><br><span class="line">ServerName mes.js.dbpe-cps.com</span><br><span class="line"><span class="comment"># ServerAdmin webmaster@localhost</span></span><br><span class="line">DocumentRoot /var/www/html/phpcms/mes</span><br><span class="line"></span><br><span class="line">$ service apache2 restart</span><br></pre></td></tr></table></figure><h1 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h1><p>配置你的域名指向你的服务器就行。这里略过。</p><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="Apache常用命令"><a href="#Apache常用命令" class="headerlink" title="Apache常用命令"></a>Apache常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 重启Apache2</span></span><br><span class="line">$ service apache2 restart </span><br><span class="line">$ service apache2 status</span><br><span class="line">$ service apache2 start</span><br></pre></td></tr></table></figure><h2 id="Apache目录"><a href="#Apache目录" class="headerlink" title="Apache目录"></a>Apache目录</h2><ul><li>配置目录：<code>/etc/apache2</code></li><li>默认www目录：<code>/var/www/html</code></li></ul><p>这一点跟其他的不一样，我也是看到配置文件才知道是这个目录的</p><p><img src="https://i.loli.net/2019/06/24/5d109f0e7b96224648.png"></p><p>/etc/apache2/apache2.conf</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;安装Apache2&quot;&gt;&lt;a href=&quot;#安装Apache2&quot; class=&quot;headerlink&quot; title=&quot;安装Apache2&quot;&gt;&lt;/a&gt;安装Apache2&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt-get update -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt-get install apache2 -y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo systemctl start apache2.service&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="phpcms" scheme="https://blog.gcdd.top/tags/phpcms/"/>
    
  </entry>
  
  <entry>
    <title>发布开源项目到Jcenter</title>
    <link href="https://blog.gcdd.top/p/53809/"/>
    <id>https://blog.gcdd.top/p/53809/</id>
    <published>2019-06-10T08:44:17.000Z</published>
    <updated>2023-08-30T04:52:53.908Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote><p>为了将<a href="https://gcdd1993.github.io/%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8/">阿里云短信开箱即用</a>发布到Jcenter仓库，前前后后花费了1天半的时间，把端午节都搭进去了。终于今天收到了Jcenter的消息，自己发布的包被添加到了Jcenter仓库，也算给开源社区做了次小贡献😁😁😁。</p></blockquote><span id="more"></span><p><img src="https://i.loli.net/2019/06/10/5cfe1b03c61ee37109.png"></p><p>现在记录下踩过的坑。</p><h1 id="注册Jcenter账号"><a href="#注册Jcenter账号" class="headerlink" title="注册Jcenter账号"></a>注册Jcenter账号</h1><p>要注意的地方，Jcenter账号跟国内一样分为社区版和企业版，企业版当然是要付费的，而且很坑的是点进Bintray官网，首先映入眼帘的就是大大的<code>Start Your Free Trial</code>（开始免费试用），一开始我就注册了企业版账号，后来删号重建了😂。我们应该点这里：</p><p><img src="https://i.loli.net/2019/06/10/5cfe1c155f37b42837.png"></p><p>填写信息后注册，我是直接使用的Github账号注册。</p><h1 id="创建Repository"><a href="#创建Repository" class="headerlink" title="创建Repository"></a>创建Repository</h1><p>点击右上角<code>View Profile</code></p><p><img src="https://i.loli.net/2019/06/10/5cfe1cd1576dc26645.png"></p><p>在账号信息下方，我们点击<code>Add New Repository</code>，创建新的仓库。</p><p><img src="https://i.loli.net/2019/06/10/5cfe1d28b975050822.png"></p><p>在填写信息的时候，选择Public（Private是需要付钱的，大家都懂），如果你是maven项目，仓库名最好填写maven，因为我在申请<code>Add To Jcenter</code>时，第一次失败了，要求我把项目放在maven路径下。</p><p><img src="https://i.loli.net/2019/06/10/5cfe224c9096c25001.png"></p><h1 id="创建Package"><a href="#创建Package" class="headerlink" title="创建Package"></a>创建Package</h1><p>创建完仓库，就是创建包了，没什么好说的，你的应用叫啥名，包就叫啥名就行。</p><p>创建完可以看到包的基本信息：</p><p><img src="https://i.loli.net/2019/06/10/5cfe238ec652b53623.png"></p><h1 id="打包上传"><a href="#打包上传" class="headerlink" title="打包上传"></a>打包上传</h1><p>这里使用的是开源项目<a href="https://github.com/novoda/bintray-release">bintray-release</a>，官方文档<a href="%5Bhttps://github.com/novoda/bintray-release/wiki/%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3HOME%5D(https://github.com/novoda/bintray-release/wiki/%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3HOME)">bintray-release/wiki</a></p><p>主要在<code>build.gradle</code>里添加如下信息</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.novoda:bintray-release:0.9.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.novoda.bintray-release&#x27;</span></span><br><span class="line"></span><br><span class="line">publish &#123;</span><br><span class="line">    userOrg = <span class="string">&#x27;你的Bintray用户名&#x27;</span></span><br><span class="line">    groupId = <span class="string">&#x27;应用的groupId，例如：io.github.gcdd1993&#x27;</span></span><br><span class="line">    artifactId = <span class="string">&#x27;应用的名称，例如：ali-sms-spring-boot-starter&#x27;</span></span><br><span class="line">    publishVersion = <span class="string">&#x27;应用的版本号，例如：1.0.0.RELEASE&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;一句话概述你的应用干啥的&#x27;</span></span><br><span class="line">    website = <span class="string">&#x27;应用链接，一般写github地址就行，例如：https://github.com/gcdd1993/ali-sms-spring-boot-starter&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以下是我自己加的</span></span><br><span class="line"><span class="comment"> * 第一个解决Gradle Task:jar skipped的问题</span></span><br><span class="line"><span class="comment"> * 第二个解决javaDoc &#x27;UTF-8&#x27;乱码问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">jar &#123;</span><br><span class="line">    enabled = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.encoding = <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来执行<code>gradle</code>命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew bintrayUpload -PbintrayUser=BINTRAY_USERNAME -PbintrayKey=BINTRAY_KEY -PdryRun=false</span><br></pre></td></tr></table></figure><p>本地测试可以把<code>-PdryRun=false</code>改为<code>-PdryRun=true</code>，这样就不会帮你上传到Bintray，其他的都执行。</p><p><img src="https://i.loli.net/2019/06/10/5cfe29fbd33a449878.png"></p><p>看到以上信息，证明发布成功了。</p><h1 id="Add-To-Jcenter"><a href="#Add-To-Jcenter" class="headerlink" title="Add To Jcenter"></a>Add To Jcenter</h1><p>发布成功后，你应该会在Package的Files标签下看到你上传的文件</p><p><img src="https://i.loli.net/2019/06/10/5cfe2aa92b4af15397.png"></p><p>我们点击右上角Actions下的Add To Jcenter</p><p><img src="https://i.loli.net/2019/06/10/5cfe2b006401429419.png"></p><p>填写信息，两个复选框我都勾选了，然后填写Group Id，填上应用说明（最好用英文），然后等着就行了。</p><p>一般来说1~3天你将会收到一封邮件，通知你的申请通过没有，如下</p><p><img src="https://i.loli.net/2019/06/10/5cfe2ba396f2386226.png"></p><p>👉如果没有通过，也会告诉你怎么改，所以不用担心。</p><p>这时候再打开Bintray的Package页面，会发现<code>Included In Jcenter</code>，证明已经被Jcenter收录了，其他人就可以正常使用啦。</p><p><img src="https://i.loli.net/2019/06/10/5cfe2c01e777524132.png"></p><h1 id="Travis-CI持续集成"><a href="#Travis-CI持续集成" class="headerlink" title="Travis CI持续集成"></a>Travis CI持续集成</h1><p>Travis CI是什么就不介绍了，不明白的可以看下<a href="http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html">阮一峰的网络日志-持续集成服务 Travis CI 教程</a>，Github公开仓库免费的持续集成工具。</p><p>项目根目录添加<code>.travis.yml</code>，填入以下信息（针对Gradle搭建的Java项目适用）</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">java</span></span><br><span class="line"><span class="attr">sudo:</span> <span class="string">required</span></span><br><span class="line"><span class="attr">dist:</span> <span class="string">xenial</span></span><br><span class="line"><span class="attr">jdk:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openjdk8</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"><span class="attr">before_cache:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-f</span>  <span class="string">$HOME/.gradle/caches/modules-2/modules-2.lock</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-fr</span> <span class="string">$HOME/.gradle/caches/*/plugin-resolution/</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$HOME/.gradle/caches/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$HOME/.gradle/wrapper/</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">gradlew</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./gradlew</span> <span class="string">jar</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./gradlew</span> <span class="string">bintrayUpload</span> <span class="string">-PbintrayUser=$&#123;bintray_user&#125;</span> <span class="string">-PbintrayKey=$&#123;bintray_key&#125;</span> <span class="string">-PdryRun=false</span></span><br></pre></td></tr></table></figure><p>其中变量<code>$&#123;bintray_user&#125;</code>和<code>$&#123;bintray_key&#125;</code>是Travis CI运行时环境变量，请到<a href="https://travis-ci.org/%7Byour-travis-ci-username%7D/ali-sms-spring-boot-starter/settings">Travis CI Settings</a>填写。</p><p><img src="https://i.loli.net/2019/06/10/5cfe28657c37a76232.png"></p><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul><li><a href="https://github.com/HailouWang/bintray-release/wiki">bintray-release-wiki</a></li><li><a href="https://docs.gradle.org/current/userguide/publishing_maven.html">Maven Publish Plugin</a></li><li><a href="http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html">阮一峰的网络日志-持续集成服务 Travis CI 教程</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;为了将&lt;a href=&quot;https://gcdd1993.github.io/%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8/&quot;&gt;阿里云短信开箱即用&lt;/a&gt;发布到Jcenter仓库，前前后后花费了1天半的时间，把端午节都搭进去了。终于今天收到了Jcenter的消息，自己发布的包被添加到了Jcenter仓库，也算给开源社区做了次小贡献😁😁😁。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Jcenter" scheme="https://blog.gcdd.top/tags/Jcenter/"/>
    
  </entry>
  
  <entry>
    <title>阿里云短信开箱即用</title>
    <link href="https://blog.gcdd.top/p/28056/"/>
    <id>https://blog.gcdd.top/p/28056/</id>
    <published>2019-06-07T15:52:16.000Z</published>
    <updated>2023-08-30T04:52:53.914Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote><p>使用<code>SpringBoot</code>自动装配简化对接阿里云短信过程。</p></blockquote><p><strong>小工具一枚，欢迎使用和Star支持，如使用过程中碰到问题，可以提出Issue，我会尽力完善该Starter。</strong></p><span id="more"></span><h1 id="版本基础"><a href="#版本基础" class="headerlink" title="版本基础"></a>版本基础</h1><p><code>aliyun-java-sdk-core:4.1.0</code></p><h1 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h1><h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.gcdd1993<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ali-sms-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;io.github.gcdd1993:ali-sms-spring-boot-starter:1.0.0.RELEASE&#x27;</span></span><br></pre></td></tr></table></figure><p>👉注意：需要引入<code>Jcenter</code>仓库</p><h2 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h2><p>以<code>application.yml</code>举例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ali:</span></span><br><span class="line">  <span class="attr">sms:</span></span><br><span class="line">  <span class="attr">domain:</span> <span class="string">&quot;dysmsapi.aliyuncs.com&quot;</span> <span class="comment">## 默认dysmsapi.aliyuncs.com</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">&quot;2017-05-25&quot;</span> <span class="comment">## 默认2017-05-25</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">&quot;SendSms&quot;</span> <span class="comment">## 默认SendSms</span></span><br><span class="line">    <span class="attr">access-key:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">&quot;$&#123;阿里云短信AccessKeyId&#125;&quot;</span></span><br><span class="line">      <span class="attr">secret:</span> <span class="string">&quot;$&#123;阿里云短信AccessKeySecret&#125;&quot;</span></span><br><span class="line">    <span class="attr">region-id:</span> <span class="string">&quot;$&#123;阿里云短信地域&#125;&quot;</span></span><br><span class="line">    <span class="attr">sign-name:</span> <span class="string">&quot;$&#123;阿里云短信签名&#125;&quot;</span> <span class="comment">## 如果不填，必须在发送方法中指定</span></span><br></pre></td></tr></table></figure><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="同步发送短信"><a href="#同步发送短信" class="headerlink" title="同步发送短信"></a>同步发送短信</h3><p>为了方便使用，接口上进行了方法的重载，提供5种不同的参数列表供选择，你可以自行选择使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送短信</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     参数1：使用的短信模板ID</span></span><br><span class="line"><span class="comment"> *     参数2：接收者的手机号，如&quot;17602526129,17602923211&quot;</span></span><br><span class="line"><span class="comment"> *     参数3：Map，key对应模板中的参数名，value对应值（这里是使用Jackson来序列化）</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSync</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SmsResponse</span> <span class="variable">smsResponse</span> <span class="operator">=</span> sendService.sendSync(TEMPLATE_ID, PHONE_NUMBER, MAP);</span><br><span class="line">    Assert.assertTrue(smsResponse.isSuccess());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送短信</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     参数1：使用的短信模板ID</span></span><br><span class="line"><span class="comment"> *     参数2：接收者的手机号，如&quot;17602526129,17602923211&quot;</span></span><br><span class="line"><span class="comment"> *     参数3：要发送的短信写入值，你可以自己进行json的拼装。注意要进行json的转义，例如：&quot;&#123;\&quot;code\&quot;:\&quot;112233\&quot;&#125;&quot;</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSync1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SmsResponse</span> <span class="variable">smsResponse</span> <span class="operator">=</span> sendService.sendSync(TEMPLATE_ID, PHONE_NUMBER, <span class="string">&quot;&#123;\&quot;code\&quot;:\&quot;112233\&quot;&#125;&quot;</span>);</span><br><span class="line">    Assert.assertTrue(smsResponse.isSuccess());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送短信</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     参数1：短信签名，适用于同一模板需要有不同短信签名的</span></span><br><span class="line"><span class="comment"> *     参数2：使用的短信模板ID</span></span><br><span class="line"><span class="comment"> *     参数3：接收者的手机号，如&quot;17602526129,17602923211&quot;</span></span><br><span class="line"><span class="comment"> *     参数4：Map，key对应模板中的参数名，value对应值（这里是使用Jackson来序列化）</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSync2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SmsResponse</span> <span class="variable">smsResponse</span> <span class="operator">=</span> sendService.sendSync(SIGN_NAME, TEMPLATE_ID, PHONE_NUMBER, MAP);</span><br><span class="line">    Assert.assertTrue(smsResponse.isSuccess());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送短信</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     参数1：短信签名，适用于同一模板需要有不同短信签名的</span></span><br><span class="line"><span class="comment"> *     参数2：使用的短信模板ID</span></span><br><span class="line"><span class="comment"> *     参数3：接收者的手机号，如&quot;17602526129,17602923211&quot;</span></span><br><span class="line"><span class="comment"> *     参数4：要发送的短信写入值，你可以自己进行json的拼装。注意要进行json的转义，例如：&quot;&#123;\&quot;code\&quot;:\&quot;112233\&quot;&#125;&quot;</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSync3</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SmsResponse</span> <span class="variable">smsResponse</span> <span class="operator">=</span> sendService.sendSync(SIGN_NAME, TEMPLATE_ID, PHONE_NUMBER, <span class="string">&quot;&#123;\&quot;code\&quot;:\&quot;112233\&quot;&#125;&quot;</span>);</span><br><span class="line">    Assert.assertTrue(smsResponse.isSuccess());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后一个提供了一个参数对象来定义短信发送请求，如果不嫌麻烦，可以使用这个。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里云短信请求体</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/6/6</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收短信的手机号码。以英文逗号（,）分隔。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phoneNumbers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信签名名称。请在控制台签名管理页面签名名称一列查看。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String signName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信模板ID，前缀为SMS_</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer templateId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 阿里云短信内容,key:短信模板中的字段名，value：短信模板字段对应值</span></span><br><span class="line"><span class="comment">     * 使用此字段需要&#123;<span class="doctag">@link</span> com.fasterxml.jackson.databind.ObjectMapper&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; params;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * json str of  &#123;<span class="doctag">@link</span> #getParams()&#125;</span></span><br><span class="line"><span class="comment">     * 使用此字段请设置params为Null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String paramStr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendSync4</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SmsRequest</span> <span class="variable">smsRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmsRequest</span>();</span><br><span class="line">    smsRequest.setPhoneNumbers(PHONE_NUMBER);</span><br><span class="line">    smsRequest.setTemplateId(TEMPLATE_ID);</span><br><span class="line">    smsRequest.setParams(MAP);</span><br><span class="line">    <span class="type">SmsResponse</span> <span class="variable">smsResponse</span> <span class="operator">=</span> sendService.sendSync(smsRequest);</span><br><span class="line">    Assert.assertTrue(smsResponse.isSuccess());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="异步发送短信"><a href="#异步发送短信" class="headerlink" title="异步发送短信"></a>异步发送短信</h3><blockquote><p>考虑到发短信的需求，一般来说都需要异步加持，对以上5种方法分别提供了异步接口<code>sendAsync</code>，使用方法基本一致，唯一不同的是，你可以异步处理短信发送返回值。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;SmsResponse&gt; smsResponse = sendService.sendAsync(TEMPLATE_ID, PHONE_NUMBER, MAP);</span><br><span class="line">smsResponse.thenAcceptAsync(sr -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (sr.isSuccess()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;发短信成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;发送到消息队列，准备重试此次短信&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="高级使用"><a href="#高级使用" class="headerlink" title="高级使用"></a>高级使用</h2><p>除了使用以上方法发送短信外，你还可以使用官方的<code>IAcsClient</code>来发送短信，如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.gcdd1993.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.CommonRequest;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.IAcsClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.request;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.CommonResponse;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.exceptions.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyuncs.http.MethodType;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> io.github.gcdd1993.alisms.domain.SmsRequest;</span><br><span class="line"><span class="keyword">import</span> io.github.gcdd1993.alisms.domain.SmsResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/6/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAcsClient acsClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SmsResponse <span class="title function_">sendSync</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CommonRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommonRequest</span>();</span><br><span class="line">            request.setMethod(MethodType.POST);</span><br><span class="line">            request.setDomain(<span class="string">&quot;dysmsapi.aliyuncs.com&quot;</span>);</span><br><span class="line">            request.setVersion(<span class="string">&quot;2017-05-25&quot;</span>);</span><br><span class="line">            request.setAction(<span class="string">&quot;SendSms&quot;</span>);</span><br><span class="line">            request.putQueryParameter(<span class="string">&quot;RegionId&quot;</span>, <span class="string">&quot;region&quot;</span>);</span><br><span class="line">            request.putQueryParameter(<span class="string">&quot;PhoneNumbers&quot;</span>, <span class="string">&quot;1771636783&quot;</span>);</span><br><span class="line">            request.putQueryParameter(<span class="string">&quot;SignName&quot;</span>, <span class="string">&quot;SignName&quot;</span>);</span><br><span class="line">            request.putQueryParameter(<span class="string">&quot;TemplateCode&quot;</span>, <span class="string">&quot;SMS_12345678&quot;</span>);</span><br><span class="line">            request.putQueryParameter(<span class="string">&quot;TemplateParam&quot;</span>, <span class="string">&quot;&#123;\&quot;code\&quot;:\&quot;112233\&quot;&#125;&quot;</span>);</span><br><span class="line">            <span class="type">CommonResponse</span> <span class="variable">commonResponse</span> <span class="operator">=</span> acsClient.getCommonResponse(request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SmsResponse.SmsResponseBuilder.build(commonResponse);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;send msg error.&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> SmsResponse.SmsResponseBuilder.buildFail(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;write json failed.&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> SmsResponse.SmsResponseBuilder.buildFail(<span class="string">&quot;短信参数在json序列化时出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Licenses"><a href="#Licenses" class="headerlink" title="Licenses"></a>Licenses</h1><p><a href="http://www.apache.org/licenses/LICENSE-2.0.txt">The Apache License, Version 2.0</a></p><h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><p><a href="https://github.com/gcdd1993/ali-sms-spring-boot-starter/issues">Issues Welcome</a></p><h1 id="支持"><a href="#支持" class="headerlink" title="支持"></a>支持</h1><ul><li>Click <a href="https://github.com/gcdd1993/ali-sms-spring-boot-starter">Github</a> to star, Thanks!</li></ul><h1 id="更多参考"><a href="#更多参考" class="headerlink" title="更多参考"></a>更多参考</h1><p><a href="https://help.aliyun.com/document_detail/101300.html">阿里云短信服务API参考</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;使用&lt;code&gt;SpringBoot&lt;/code&gt;自动装配简化对接阿里云短信过程。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;小工具一枚，欢迎使用和Star支持，如使用过程中碰到问题，可以提出Issue，我会尽力完善该Starter。&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring Boot" scheme="https://blog.gcdd.top/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>分布式任务调度XXL-JOB初体验</title>
    <link href="https://blog.gcdd.top/p/29085/"/>
    <id>https://blog.gcdd.top/p/29085/</id>
    <published>2019-06-05T05:19:33.000Z</published>
    <updated>2023-08-30T04:52:53.908Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="http://www.xuxueli.com/xxl-job/#/">XXL-JOB</a>是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。<span id="more"></span></p><p>官方文档很完善，不多赘述。本文主要是搭建<code>XXL-JOB</code>和简单使用的记录。</p><h1 id="搭建xxl-job-admin管理端"><a href="#搭建xxl-job-admin管理端" class="headerlink" title="搭建xxl-job-admin管理端"></a>搭建xxl-job-admin管理端</h1><h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><ul><li>Ubuntu 16.04 64位</li><li>Mysql 5.7</li></ul><h3 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install mysql-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置mysql，主要是安全方面的，密码策略等</span></span><br><span class="line">$ mysql_secure_installation</span><br><span class="line"><span class="comment">## 配置远程访问</span></span><br><span class="line">$ sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">$ sudo service mysql restart</span><br><span class="line">$ sudo service mysql status</span><br><span class="line">● mysql.service - MySQL Community Server</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/mysql.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Wed 2019-06-05 13:23:41 HKT; 45s ago</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; CREATE database <span class="keyword">if</span> NOT EXISTS `xxl-job` default character <span class="built_in">set</span> utf8 collate utf8_general_ci;</span><br></pre></td></tr></table></figure><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; CREATE USER <span class="string">&#x27;xxl-job&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;xxlJob2019@&#x27;</span>;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON `xxl-job`.* TO <span class="string">&#x27;xxl-job&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="本地测试xxl-job-admin"><a href="#本地测试xxl-job-admin" class="headerlink" title="本地测试xxl-job-admin"></a>本地测试xxl-job-admin</h2><h3 id="拉取最新源码"><a href="#拉取最新源码" class="headerlink" title="拉取最新源码"></a>拉取最新源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:xuxueli/xxl-job.git</span><br><span class="line">$ <span class="built_in">cd</span> xxl-job</span><br></pre></td></tr></table></figure><h3 id="导入项目"><a href="#导入项目" class="headerlink" title="导入项目"></a>导入项目</h3><p>我比较熟悉<code>Idea</code>开发工具，所以这里使用<code>Idea</code>的<code>Gradle</code>项目进行演示。</p><p>打开<code>xxl-job</code>，项目结构如下</p><p><img src="https://i.loli.net/2019/06/05/5cf75c6d3250b91960.png"></p><h3 id="测试项目"><a href="#测试项目" class="headerlink" title="测试项目"></a>测试项目</h3><p>打开<code>xxl-job-admin/resources/application.properties</code>，修改mysql连接信息</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### xxl-job, datasource</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://192.168.32.129:3306/xxl-job?Unicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">xxl-job</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">xxlJob2019@</span></span><br></pre></td></tr></table></figure><p>使用<code>/xxl-job/doc/db/tables_xxl_job.sql</code>初始化数据库，初始化完应该如下图</p><p><img src="https://i.loli.net/2019/06/05/5cf75ee24c52a19926.png"></p><p>准备就绪后，就可以启动项目了，然后打开地址<a href="http://localhost:8080/xxl-job-admin%E5%B0%86%E4%BC%9A%E7%9C%8B%E5%88%B0%E9%A6%96%E9%A1%B5">http://localhost:8080/xxl-job-admin将会看到首页</a></p><p><img src="https://i.loli.net/2019/06/05/5cf77d0844d8895768.png"></p><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="打包调度中心"><a href="#打包调度中心" class="headerlink" title="打包调度中心"></a>打包调度中心</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /xxl-job</span><br><span class="line">$ mvn install</span><br><span class="line">...</span><br><span class="line">[INFO] xxl-job ............................................ SUCCESS [  0.513 s]</span><br><span class="line">[INFO] xxl-job-core ....................................... SUCCESS [  4.258 s]</span><br><span class="line">[INFO] xxl-job-admin ...................................... SUCCESS [  5.525 s]</span><br><span class="line">[INFO] xxl-job-executor-samples ........................... SUCCESS [  0.016 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-spring ..................... SUCCESS [  2.188 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-springboot ................. SUCCESS [  0.892 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-jfinal ..................... SUCCESS [  1.753 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-nutz ....................... SUCCESS [  1.316 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-frameless .................. SUCCESS [  0.358 s]</span><br><span class="line">[INFO] xxl-job-executor-sample-jboot ...................... SUCCESS [  1.279 s]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  18.549 s</span><br><span class="line">[INFO] Finished at: 2019-06-05T14:40:25+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>看到以上信息，说明我们打包成功了，在<code>/xxl-job/xxl-job-admin</code>目录下会存在jar文件：<code>xxl-job-admin-2.1.0-SNAPSHOT.jar</code></p><h3 id="部署到服务器"><a href="#部署到服务器" class="headerlink" title="部署到服务器"></a>部署到服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install openjdk-8-jdk</span><br><span class="line">$ java -version</span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_212&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_212-8u212-b03-0ubuntu1.16.04.1-b03)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.212-b03, mixed mode)</span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">mkdir</span> -p /data/xxl-job</span><br><span class="line">$ sudo <span class="built_in">cd</span> /data/xxl-job</span><br><span class="line"><span class="comment">## 上传我们打包好的jar至此目录，并添加软连接</span></span><br><span class="line">$ sudo <span class="built_in">ln</span> -s xxl-job-admin-2.1.0-SNAPSHOT.jar current.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">## 注册为system服务，可以达到异常重启，开机自启等目的</span></span><br><span class="line">$ sudo vim /etc/systemd/system/xxl-job.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=xxl-job Service Daemon</span><br><span class="line">After=mysql.service</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;JAVA_OPTS= -Xmx1024m -Xms1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:NewRatio=3 -Dserver.port=8081&quot;</span></span><br><span class="line"><span class="comment"># java要写绝对路径</span></span><br><span class="line">ExecStart=/usr/local/jdk/bin/java -jar /data/xxl-job/current.jar</span><br><span class="line">Restart=always</span><br><span class="line">WorkingDirectory=/data/xxl-job/</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> xxl-job.service</span><br><span class="line">$ sudo service xxl-job start</span><br><span class="line">$ sudo service xxl-job status</span><br><span class="line">● xxl-job.service - xxl-job Service Daemon</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/xxl-job.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Thu 2019-07-18 18:19:08 CST; 2min 19s ago</span><br><span class="line"> Main PID: 27572 (java)</span><br><span class="line">   CGroup: /system.slice/xxl-job.service</span><br><span class="line">           └─27572 /usr/local/jdk/bin/java -jar /data/xxl-job/current.jar</span><br></pre></td></tr></table></figure><p>我们访问一下<a href="http://192.168.32.129:8080/xxl-job-admin%EF%BC%9A">http://192.168.32.129:8080/xxl-job-admin：</a></p><p><img src="https://i.loli.net/2019/06/05/5cf7706901fb080448.png"></p><h1 id="测试任务调度"><a href="#测试任务调度" class="headerlink" title="测试任务调度"></a>测试任务调度</h1><p>以上，我们的任务调度管理端已经搭建完成，接下来，让我们测试下任务调度。</p><p>直接使用自带的<code>SpringBoot</code>测试项目<code>xxl-job-executor-sample-springboot</code>进行测试，修改配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl-job-executor-sample-springboot</span>=<span class="string">http://192.168.32.129:8080/xxl-job-admin</span></span><br></pre></td></tr></table></figure><h2 id="自定义任务"><a href="#自定义任务" class="headerlink" title="自定义任务"></a>自定义任务</h2><p>编写一个简单的任务，打印100次当前序列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.executor.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.biz.model.ReturnT;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.IJobHandler;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.JobHandler;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.log.XxlJobLogger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/6/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JobHandler(value=&quot;gcddJobHandler&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GcddJobHandler</span> <span class="keyword">extends</span> <span class="title class_">IJobHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">execute</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            XxlJobLogger.log(<span class="string">&quot;XXL-JOB, print &quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="启动执行器"><a href="#启动执行器" class="headerlink" title="启动执行器"></a>启动执行器</h2><p>然后启动执行器，启动完成后，我们会发现管理页面的执行器列表会多出我们刚才启动的执行器</p><p><img src="https://i.loli.net/2019/06/05/5cf7737de7cad58644.png"></p><h2 id="添加任务"><a href="#添加任务" class="headerlink" title="添加任务"></a>添加任务</h2><p><img src="https://i.loli.net/2019/06/05/5cf776088e84c40188.png"></p><p><img src="https://i.loli.net/2019/06/05/5cf77809c3c2d16509.png"></p><h2 id="查看任务执行日志"><a href="#查看任务执行日志" class="headerlink" title="查看任务执行日志"></a>查看任务执行日志</h2><p><img src="https://i.loli.net/2019/06/05/5cf7782580be085791.png"></p><p>可以看到，任务已经按照我们的规划执行成功了，非常的方便。</p><h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>想要了解更详细的内容，请访问<a href="http://www.xuxueli.com/xxl-job/#/">xxl-job官网</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://www.xuxueli.com/xxl-job/#/&quot;&gt;XXL-JOB&lt;/a&gt;是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="xxl-job" scheme="https://blog.gcdd.top/tags/xxl-job/"/>
    
    <category term="分布式" scheme="https://blog.gcdd.top/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>手写IOC容器</title>
    <link href="https://blog.gcdd.top/p/11305/"/>
    <id>https://blog.gcdd.top/p/11305/</id>
    <published>2019-06-02T11:59:52.000Z</published>
    <updated>2023-08-30T04:52:53.910Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文是为了学习<code>Spring IOC</code>容器的执行过程而写，不能完全代表<code>Spring IOC</code>容器，只是简单实现了容器的<strong>依赖注入</strong>和<strong>控制反转</strong>功能，无法用于生产，只能说对理解Spring容器能够起到一定的作用。</p><span id="more"></span><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>创建Gradle项目，并修改<code>build.gradle</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&quot;io.franzbecker.gradle-lombok&quot;</span> version <span class="string">&quot;3.1.0&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group <span class="string">&#x27;io.github.gcdd1993&#x27;</span></span><br><span class="line">version <span class="string">&#x27;1.0-SNAPSHOT&#x27;</span></span><br><span class="line"></span><br><span class="line">sourceCompatibility = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    testCompile <span class="attr">group:</span> <span class="string">&#x27;junit&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;junit&#x27;</span>, <span class="attr">version:</span> <span class="string">&#x27;4.12&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建BeanFactory"><a href="#创建BeanFactory" class="headerlink" title="创建BeanFactory"></a>创建<code>BeanFactory</code></h2><p><code>BeanFactory</code>是IOC中用于存放bean实例以及获取bean的核心接口，它的核心方法是<code>getBean</code>以及<code>getBean</code>的重载方法，这里简单实现两个<code>getBean</code>的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.gcdd1993.ioc.bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bean factory interface</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/6/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过bean名称获取bean</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name bean名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过bean类型获取bean</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tClass bean类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;    泛型T</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; tClass)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建ApplicationContext上下文"><a href="#创建ApplicationContext上下文" class="headerlink" title="创建ApplicationContext上下文"></a>创建<code>ApplicationContext</code>上下文</h2><p><code>ApplicationContext</code>，即我们常说的应用上下文，实际就是Spring容器本身了。</p><p>我们创建<code>ApplicationContext</code>类，并实现<code>BeanFactory</code>接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContext</span> <span class="keyword">implements</span> <span class="title class_">BeanFactory</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getBean方法"><a href="#getBean方法" class="headerlink" title="getBean方法"></a><code>getBean</code>方法</h3><p>既然说是容器，那肯定要有地方装我们的bean实例吧，使用两个Map作为容器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照beanName分组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; beanByNameMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照beanClass分组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; beanByClassMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure><p>然后，我们可以先完成我们的<code>getBean</code>方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> beanByNameMap.get(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; tClass)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tClass.cast(beanByClassMap.get(tClass));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接从Map中获取bean实例，是不是很简单？当然了，在真实的Spring容器中，是不会这么简单啦，不过我们这次是要化繁为简，理解IOC容器。</p><h3 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h3><p>Spring提供了<code>@ComponentScan</code>来扫描包下的<code>Component</code>，我们为了简便，直接在构造器中指定要扫描的包。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; basePackages;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认构造器，默认扫描当前所在包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Collections.singletonList(ApplicationContext.class.getPackage().getName())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全参构造器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> basePackages 扫描的包名列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ApplicationContext</span><span class="params">(Set&lt;String&gt; basePackages)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.basePackages = basePackages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="refresh方法"><a href="#refresh方法" class="headerlink" title="refresh方法"></a><code>refresh</code>方法</h3><p>refresh的过程基本按照以下流程来走</p><p><img src="https://i.loli.net/2019/06/02/5cf3c4c4b465587417.png"></p><ol><li>扫描指定的包下所有带<code>@Bean</code>注解（Spring中是<code>@Component</code>注解）的类。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Class&gt; beanClasses = PackageScanner.findClassesWithAnnotation(packageName, Bean.class);</span><br><span class="line">System.out.println(<span class="string">&quot;scan classes with Bean annotation : &quot;</span> + beanClasses.toString());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Class beanClass : beanClasses) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        createBean(beanClass);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | IllegalAccessException | InvocationTargetException | InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>遍历类，获取类的构造器以及所有字段。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> beanClass.getDeclaredConstructor();</span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line">Field[] fields = beanClass.getDeclaredFields();</span><br></pre></td></tr></table></figure><ol start="3"><li><p>判断字段是依赖注入的还是普通字段。</p></li><li><p>如果是普通字段，通过字段类型初始化该字段，并尝试从<code>@Value</code>注解获取值塞给字段。</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Value</span> <span class="variable">value</span> <span class="operator">=</span> field.getAnnotation(Value.class);</span><br><span class="line"><span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 注入</span></span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 需要做一些类型转换，从String转为对应的类型</span></span><br><span class="line">    field.set(object, value.value());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>如果是依赖注入的字段，尝试从<code>beanByClassMap</code>中获取对应的实例，如果没有，就先要去实例化该字段对应的类型。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Autowired</span> <span class="variable">autowired</span> <span class="operator">=</span> field.getAnnotation(Autowired.class);</span><br><span class="line"><span class="keyword">if</span> (autowired != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 依赖注入</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> autowired.name();</span><br><span class="line">    <span class="comment">// 按照名称注入</span></span><br><span class="line">    Object diObj;</span><br><span class="line">    <span class="keyword">if</span> (!name.isEmpty()) &#123;</span><br><span class="line">        diObj = beanByNameMap.get(name) == <span class="literal">null</span> ?</span><br><span class="line">                createBean(name) :</span><br><span class="line">                beanByNameMap.get(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 按照类型注入</span></span><br><span class="line">        Class&lt;?&gt; aClass = field.getType();</span><br><span class="line">        diObj = beanByClassMap.get(aClass) == <span class="literal">null</span> ?</span><br><span class="line">                createBean(aClass) :</span><br><span class="line">                beanByClassMap.get(aClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注入</span></span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(object, diObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试我们的IOC容器"><a href="#测试我们的IOC容器" class="headerlink" title="测试我们的IOC容器"></a>测试我们的IOC容器</h2><p>创建<code>Address</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;2222&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String longitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;1111&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String latitude;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建<code>Person</code>并注入<code>Address</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;gaochen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;27&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建测试类<code>ApplicationContextTest</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; basePackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        basePackages.add(<span class="string">&quot;io.github.gcdd1993.ioc&quot;</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationContext</span>(basePackages);</span><br><span class="line">        ctx.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> ctx.getBean(Person.class);</span><br><span class="line">        System.out.println(person);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">person1</span> <span class="operator">=</span> ctx.getBean(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line">        System.out.println(person1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台将会输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scan classes with Bean annotation : [class io.github.gcdd1993.ioc.util.Address, class io.github.gcdd1993.ioc.util.Person]</span><br><span class="line">scan classes with Bean annotation : [class io.github.gcdd1993.ioc.util.Address, class io.github.gcdd1993.ioc.util.Person]</span><br><span class="line">Person(address=Address(longitude=2222, latitude=1111), name=gaochen, age=27)</span><br><span class="line">Person(address=Address(longitude=2222, latitude=1111), name=gaochen, age=27)</span><br></pre></td></tr></table></figure><p>可以看到，我们成功将Address实例注入到了Person实例中，并且将它们存储在了我们自己的IOC容器中。其实，Spring容器的原理大致就是如此，只不过为了应对企业级开发，提供了很多便捷的功能，例如bean的作用域、bean的自定义方法等等。</p><h1 id="获取源码"><a href="#获取源码" class="headerlink" title="获取源码"></a>获取源码</h1><p>完整源码可以在我的<code>github</code>仓库获取👉<a href="https://github.com/gcdd1993/Simple-IOC-Container">Simple-IOC-Container</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;本文是为了学习&lt;code&gt;Spring IOC&lt;/code&gt;容器的执行过程而写，不能完全代表&lt;code&gt;Spring IOC&lt;/code&gt;容器，只是简单实现了容器的&lt;strong&gt;依赖注入&lt;/strong&gt;和&lt;strong&gt;控制反转&lt;/strong&gt;功能，无法用于生产，只能说对理解Spring容器能够起到一定的作用。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>使用Tesseract-Ocr识别数字</title>
    <link href="https://blog.gcdd.top/p/5479/"/>
    <id>https://blog.gcdd.top/p/5479/</id>
    <published>2019-06-01T17:59:30.000Z</published>
    <updated>2023-08-30T04:52:53.907Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://github.com/tesseract-ocr/tesseract">Tesseract-Ocr</a>是我在编写爬虫项目中，用来识别图片（不是验证码）的本地解决方案（因为客户不想使用API识别，太贵），识别率目前达到了100%，可以说是相当了得，当然了，这取决于使用的<code>traineddata</code>。</p><span id="more"></span><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote><p>Tesseract最初是在1985年至1994年间在Hewlett-Packard Laboratories Bristol和Greeley Colorado的Hewlett-Packard Co开发的，1996年进行了一些更改，移植到Windows，并且随着C++在1998年兴起。2005年Tesseract由惠普开源，然后从2006年至今，由谷歌继续开发。</p></blockquote><p>Tesseract-Ocr并不是一个软件，它是一个软件包，包含了一个OCR引擎【libtesseract】和一个命令行程序 【tesseract】。Tesseract 4增加了一个基于OCR引擎的新神经网络（LSTM），该引擎专注于行级识别，但仍然支持Tesseract 3的传统Tesseract OCR引擎，该引擎通过识别字符模式来工作。</p><p>要启用与Tesseract 3的兼容性，你需要使用Legacy OCR Engine模式（–oem 0）。它还需要支持传统引擎的traineddata（训练好的数据文件），这些文件可以从<a href="https://github.com/tesseract-ocr/tessdata">tessdata存储库</a>的文件获取。</p><p>Tesseract支持识别unicode（UTF-8），可以“开箱即用”识别100多种语言。</p><p>Tesseract支持多种输出格式：纯文本，hOCR（HTML），PDF，TSV。主分支还具有ALTO（XML）输出的实验支持。</p><p>⭐️⭐️⭐️ 具体介绍可以上<a href="https://github.com/tesseract-ocr/tesseract/wiki">tesseract-wiki</a>查看。</p><h1 id="在Java上使用"><a href="#在Java上使用" class="headerlink" title="在Java上使用"></a>在Java上使用</h1><h2 id="创建项目，并引入Jar包"><a href="#创建项目，并引入Jar包" class="headerlink" title="创建项目，并引入Jar包"></a>创建项目，并引入Jar包</h2><h3 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/net.sourceforge.tess4j/tess4j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.tess4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tess4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;net.sourceforge.tess4j:tess4j:4.3.1&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="导入traineddata"><a href="#导入traineddata" class="headerlink" title="导入traineddata"></a>导入traineddata</h2><p><code>traineddata</code>是使用<code>Tesseract-Ocr</code>训练好的数据文件，可以直接使用。这些文件你可以去<a href="https://github.com/tesseract-ocr/tessdata">tessdata存储库</a>查找，也可以去谷歌搜索，当然了，你也可以自己训练😂。</p><p><code>traineddata</code>通常以<code>*.traineddata</code>命名，其中*指的是支持的语言类型。在<a href="https://github.com/tesseract-ocr/tesseract/wiki/Data-Files#data-files-for-version-400-november-29-2016">这里</a>你可以看到4.0.0版本支持的语言以及<code>traineddata</code>列表。</p><p>这次，我们选择<code>eng.traineddata</code>进行测试。下载<a href="https://www.lanzous.com/i4en81a">eng.traineddata</a>放入<code>/resources/traineddata</code>目录，如下图所示。</p><p><img src="https://i.loli.net/2019/06/02/5cf2c4189371f48480.png"></p><h2 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a>编写测试代码</h2><h3 id="初始化Tesseract引擎"><a href="#初始化Tesseract引擎" class="headerlink" title="初始化Tesseract引擎"></a>初始化Tesseract引擎</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TesseractTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ITesseract tesseract;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        tesseract = <span class="keyword">new</span> <span class="title class_">Tesseract</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;tesseract init done...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上，上面的代码是无法正常运行的，因为找不到指定语言版本的<code>traineddata</code>文件。</p><p><code>net.sourceforge.tess4j:tess4j:4.1.1</code>提供的API并不好，在<code>Tesseract</code>构造函数中，没有提供可选参数的构造器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tesseract</span> <span class="keyword">implements</span> <span class="title class_">ITesseract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tesseract使用的语言版本，用以选择traineddata</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> <span class="string">&quot;eng&quot;</span>;</span><br><span class="line">    <span class="comment">// traineddata目录，里面放*.traineddata数据文件</span></span><br><span class="line">    <span class="keyword">private</span> String datapath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其他代码 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tesseract</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 默认从系统环境变量获取traineddata目录</span></span><br><span class="line">            datapath = System.getenv(<span class="string">&quot;TESSDATA_PREFIX&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (datapath == <span class="literal">null</span>) &#123;</span><br><span class="line">                datapath = <span class="string">&quot;./&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets language for OCR.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> language the language code, which follows ISO 639-3 standard.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLanguage</span><span class="params">(String language)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.language = language;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets path to &lt;code&gt;tessdata&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> datapath the tessdata path to set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDatapath</span><span class="params">(String datapath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.datapath = datapath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略其他代码 ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以，我们可以选择设置环境变量<code>TESSDATA_PREFIX</code>为数据目录，或者通过Java编码的方式来设置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tesseract.setLanguage(<span class="string">&quot;eng&quot;</span>); <span class="comment">// 默认就是eng，你可以选择其他lang</span></span><br><span class="line">tesseract.setDatapath(TesseractTest.class.getResource(<span class="string">&quot;/traineddata&quot;</span>).getPath().substring(<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h3 id="OCR识别测试"><a href="#OCR识别测试" class="headerlink" title="OCR识别测试"></a>OCR识别测试</h3><p><code>tesseract</code>提供了一系列<code>doOcr</code>方法的重载，我们可以方便的进行OCR识别。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">doOCR</span><span class="params">(File imageFile)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(File imageFile, Rectangle rect)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(BufferedImage bi)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(BufferedImage bi, Rectangle rect)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(List&lt;IIOImage&gt; imageList, Rectangle rect)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(List&lt;IIOImage&gt; imageList, String filename, Rectangle rect)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(<span class="type">int</span> xsize, <span class="type">int</span> ysize, ByteBuffer buf, Rectangle rect, <span class="type">int</span> bpp)</span> <span class="keyword">throws</span> TesseractException;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">doOCR</span><span class="params">(<span class="type">int</span> xsize, <span class="type">int</span> ysize, ByteBuffer buf, String filename, Rectangle rect, <span class="type">int</span> bpp)</span> <span class="keyword">throws</span> TesseractException;</span><br></pre></td></tr></table></figure><p>可以看出，<code>doOcr</code>方法支持多种图片识别方式，如图片文件、多个图片文件、图片文件局部处理等等方式。</p><p>为了方便测试，我们选取最简单的图片文件方式测试。</p><p><a href="http://static8.ziroom.com/phoenix/pc/images/price/aacd14fbc53a106c7f0f0d667535683as.png">图片</a>是个URL链接，如下所示</p><p><img src="https://i.loli.net/2019/06/02/5cf2c992174bd56164.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOcr</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TesseractException &#123;</span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://static8.ziroom.com/phoenix/pc/images/price/aacd14fbc53a106c7f0f0d667535683as.png&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">ocr</span> <span class="operator">=</span> tesseract.doOCR(image);</span><br><span class="line">    System.out.println(<span class="string">&quot;ocr result : &quot;</span> + ocr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tesseract init done...</span><br><span class="line">ocr result : 2710386495</span><br></pre></td></tr></table></figure><p>识别准确率，主要在于<strong>你选择的训练数据文件</strong>，我使用的是数据文件是<a href="https://www.lanzous.com/i4en81a">这个</a>，对于数字的准确率基本上是100%。</p><h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>如果你遭遇<code>Invalid memory access</code>异常，这是由于找不到对应lang的<code>*.traineddata</code>文件，请修改<code>language</code>和<code>datapath</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Invalid memory access</span><br><span class="line">java.lang.Error: Invalid memory access</span><br><span class="line">at com.sun.jna.Native.invokePointer(Native Method)</span><br><span class="line">at com.sun.jna.Function.invokePointer(Function.java:470)</span><br><span class="line">at com.sun.jna.Function.invoke(Function.java:404)</span><br><span class="line">at com.sun.jna.Function.invoke(Function.java:315)</span><br><span class="line">at com.sun.jna.Library<span class="variable">$Handler</span>.invoke(Library.java:212)</span><br><span class="line">at com.sun.proxy.<span class="variable">$Proxy9</span>.TessBaseAPIGetUTF8Text(Unknown Source)</span><br><span class="line">at net.sourceforge.tess4j.Tesseract.getOCRText(Tesseract.java:495)</span><br><span class="line">at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:321)</span><br><span class="line">at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:293)</span><br><span class="line">at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:274)</span><br><span class="line">at net.sourceforge.tess4j.Tesseract.doOCR(Tesseract.java:258)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h1 id="训练工具"><a href="#训练工具" class="headerlink" title="训练工具"></a>训练工具</h1><p><a href="https://github.com/tesseract-ocr/tesseract/wiki/AddOns">https://github.com/tesseract-ocr/tesseract/wiki/AddOns</a></p><h1 id="训练数据仓库"><a href="#训练数据仓库" class="headerlink" title="训练数据仓库"></a>训练数据仓库</h1><ul><li><a href="https://github.com/tesseract-ocr/tessdata_best">tessdata_best</a>：基于LSTM引擎的训练数据，最佳最准确的</li><li><a href="https://github.com/tesseract-ocr/tessdata_fast">tessdata_fast</a>：基于LSTM引擎的训练数据，快速（精简）版本</li><li><a href="https://github.com/tesseract-ocr/tessdata">tessdata</a>：支持双引擎（LSTM和传统引擎），但LSTM训练数据不是最新的版本</li></ul><p>推荐使用<a href="https://github.com/tesseract-ocr/tessdata_best">tessdata_best</a>，虽然识别速度相对于<a href="https://github.com/tesseract-ocr/tessdata_fast">tessdata_fast</a>稍慢，但是准确率可以保证。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/tesseract-ocr/tesseract/wiki">tesseract-ocr-wiki</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/tesseract-ocr/tesseract&quot;&gt;Tesseract-Ocr&lt;/a&gt;是我在编写爬虫项目中，用来识别图片（不是验证码）的本地解决方案（因为客户不想使用API识别，太贵），识别率目前达到了100%，可以说是相当了得，当然了，这取决于使用的&lt;code&gt;traineddata&lt;/code&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Tesseract-Ocr" scheme="https://blog.gcdd.top/tags/Tesseract-Ocr/"/>
    
  </entry>
  
  <entry>
    <title>理解一致性Hash算法</title>
    <link href="https://blog.gcdd.top/p/61241/"/>
    <id>https://blog.gcdd.top/p/61241/</id>
    <published>2019-05-29T09:13:47.000Z</published>
    <updated>2023-08-30T04:52:53.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote><p>一致性哈希算法在1997年由麻省理工学院的Karger等人在解决分布式Cache中提出的，设计目标是为了解决因特网中的热点(Hot spot)问题，初衷和CARP十分类似。一致性哈希修正了CARP使用的简单哈希算法带来的问题，使得DHT可以在P2P环境中真正得到应用。</p></blockquote><p>现在一致性hash算法在分布式系统中也得到了广泛应用，研究过memcached缓存数据库的人都知道，memcached服务器端本身不提供分布式cache的一致性，而是由客户端来提供，具体在计算一致性hash时采用如下步骤：</p><span id="more"></span><ol><li><p>首先求出memcached服务器（节点）的哈希值，并将其配置到0～2^32的圆（continuum）上。</p></li><li><p>采用同样的方法求出存储数据的键的哈希值，并映射到相同的圆上。</p></li><li><p>从数据映射到的位置开始<strong>顺时针</strong>查找，将数据保存到找到的第一个服务器上。如果超过2^32仍然找不到服务器，就会保存到第一台memcached服务器上。</p></li></ol><p><img src="https://i.loli.net/2019/05/29/5cee559706c3135766.png"></p><p>从上图的状态中添加一台memcached服务器。余数分布式算法由于保存键的服务器会发生巨大变化而影响缓存的命中率，但Consistent Hashing中，只有在圆（continuum）上增加服务器的地点逆时针方向的第一台服务器上的键会受到影响，如下图所示：</p><p><img src="https://i.loli.net/2019/05/29/5cee508b7cfab34733.png"></p><h1 id="一致性Hash性质"><a href="#一致性Hash性质" class="headerlink" title="一致性Hash性质"></a>一致性Hash性质</h1><blockquote><p>考虑到分布式系统每个节点都有可能<strong>失效</strong>，并且<strong>新的节点</strong>很可能动态的增加进来，如何保证当系统的节点数目发生变化时仍然能够对外提供良好的服务，这是值得考虑的。</p><p>尤其是在设计分布式缓存系统时，如果某台服务器失效，对于整个系统来说如果不采用合适的算法来保证一致性，那么缓存于系统中的所有数据都可能会失效（即由于系统节点数目变少，客户端在请求某一对象时需要重新计算其hash值（通常与系统中的节点数目有关），由于hash值已经改变，所以很可能找不到保存该对象的服务器节点），因此一致性hash就显得至关重要。</p></blockquote><p>良好的分布式cahce系统中的一致性hash算法应该满足以下几个方面：</p><ul><li><strong>平衡性(Balance)</strong></li></ul><blockquote><p>平衡性是指<strong>哈希的结果能够尽可能分布到所有的缓冲中去</strong>，这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。</p></blockquote><ul><li><strong>单调性(Monotonicity)</strong></li></ul><blockquote><p>单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲区加入到系统中，那么哈希的结果应能够保证原有已分配的内容可以被映射到新的缓冲区中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</p><p>简单的哈希算法往往不能满足单调性的要求，如最简单的线性哈希<code>x = (ax + b) mod (P)</code>，在上式中，P表示全部缓冲的大小。不难看出，当缓冲大小发生变化时(从P1到P2)，原来所有的哈希结果均会发生变化，从而不满足单调性的要求。</p><p>哈希结果的变化意味着当缓冲空间发生变化时，所有的映射关系需要在系统内全部更新。而在P2P系统内，缓冲的变化等价于Peer加入或退出系统，这一情况在P2P系统中会频繁发生，因此会带来极大计算和传输负荷。<strong>单调性就是要求哈希算法能够应对这种情况</strong>。</p></blockquote><ul><li><strong>分散性(Spread)</strong></li></ul><blockquote><p>在分布式环境中，终端有可能看不到所有的缓冲，而是只能看到其中的一部分。</p><p>当终端希望通过哈希过程将内容映射到缓冲上时，由于不同终端所见的缓冲范围有可能不同，从而导致哈希的结果不一致，最终的结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的，因为它导致相同内容被存储到不同缓冲中去，降低了系统存储的效率。</p><p>分散性的定义就是上述情况发生的严重程度。好的哈希算法应能够尽量避免不一致的情况发生，也就是<strong>尽量降低分散性</strong>。</p></blockquote><ul><li><strong>负载(Load)</strong></li></ul><blockquote><p>负载问题实际上是从另一个角度看待分散性问题。</p><p>既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。</p><p>与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够<strong>尽量降低缓冲的负荷</strong>。</p></blockquote><ul><li><strong>平滑性(Smoothness)</strong></li></ul><blockquote><p>平滑性是指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的。</p></blockquote><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>一致性哈希算法（Consistent Hashing）最早在论文《<a href="https://link.juejin.im/?target=http://dl.acm.org/citation.cfm?id=258660">Consistent Hashing and Random Trees: Distributed Caching Protocols for Relieving Hot Spots on the World Wide Web</a>》中被提出。</p><p>简单来说，一致性哈希将整个哈希值空间组织成一个<strong>虚拟的圆环</strong>，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希空间环如下：</p><p><img src="https://i.loli.net/2019/05/29/5cee54431b19c11690.png"></p><p>整个空间按顺时针方向组织。0和2^32-1在零点中方向重合。</p><p>下一步将各个服务器使用Hash进行一个哈希，具体可以选择<strong>服务器的ip或主机名</strong>作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置，这里假设将上文中四台服务器使用ip地址哈希后在环空间的位置如下：</p><p><img src="https://i.loli.net/2019/05/29/5cee5564c55f998409.png"></p><p>接下来使用如下算法定位数据访问到相应服务器：将数据key使用相同的函数Hash计算出哈希值，并确定此数据在环上的位置，从此位置沿环<strong>顺时针</strong>“行走”，第一台遇到的服务器就是其应该定位到的服务器。</p><p>例如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：</p><p><img src="https://i.loli.net/2019/05/29/5cee55cfac53c21054.png"></p><p>根据一致性哈希算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</p><h2 id="容错性"><a href="#容错性" class="headerlink" title="容错性"></a>容错性</h2><p>现假设Node C不幸宕机，可以看到此时对象A、B、D不会受到影响，只有C对象被重定位到Node D。</p><p>一般的，在一致性哈希算法中，<strong>如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。</strong></p><h2 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h2><p>如果在系统中增加一台服务器Node X，如下图所示：</p><p><img src="https://i.loli.net/2019/05/29/5cee566ef2a4232874.png"></p><p>此时对象Object A、B、D不受影响，只有对象C需要重定位到新的Node X 。</p><p>一般的，在一致性哈希算法中，<strong>如果增加一台服务器，则受影响的数据仅仅是新服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它数据也不会受到影响。</strong></p><p>综上所述，一致性哈希算法对于节点的增减都只需重定位环空间中的一小部分数据，具有较好的容错性和可扩展性。</p><h2 id="数据倾斜问题"><a href="#数据倾斜问题" class="headerlink" title="数据倾斜问题"></a>数据倾斜问题</h2><p>另外，一致性哈希算法在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜问题。例如系统中只有两台服务器，其环分布如下：</p><p><img src="https://i.loli.net/2019/05/29/5cee56cb65e7138601.png"></p><p>此时必然造成大量数据集中到Node A上，而只有极少量会定位到Node B上。</p><p>为了解决这种数据倾斜问题，一致性哈希算法引入了<strong>虚拟节点机制</strong>，即对每一个服务节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。</p><p>具体做法可以在服务器ip或主机名的后面增加编号来实现。例如上面的情况，可以为每台服务器计算三个虚拟节点，于是可以分别计算 “Node A#1”、“Node A#2”、“Node A#3”、“Node B#1”、“Node B#2”、“Node B#3”的哈希值，于是形成六个虚拟节点：</p><p><img src="https://i.loli.net/2019/05/29/5cee56f99435a20863.png"></p><p>同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到Node A上。这样就解决了服务节点少时数据倾斜的问题。</p><p>在实际应用中，通常将虚拟节点数设置为32甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。</p><h1 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h1><p>一致性Hash模拟类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一致性Hash</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/5/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHash</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 节点的复制因子,实际节点个数 * numberOfReplicas</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numberOfReplicas;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 虚拟节点个数,存储虚拟节点的hash值到真实节点的映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;Integer, T&gt; circle = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConsistentHash</span><span class="params">(<span class="type">int</span> numberOfReplicas, Collection&lt;T&gt; nodes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numberOfReplicas = numberOfReplicas;</span><br><span class="line">        <span class="keyword">for</span> (T node : nodes) &#123;</span><br><span class="line">            add(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟添加一个节点</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 对于一个实际机器节点 node, 对应 numberOfReplicas 个虚拟节点</span></span><br><span class="line"><span class="comment">     * 不同的虚拟节点(i不同)有不同的hash值,但都对应同一个实际机器node</span></span><br><span class="line"><span class="comment">     * 虚拟node一般是均衡分布在环上的,数据存储在顺时针方向的虚拟node上</span></span><br><span class="line"><span class="comment">     * &lt;/P&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node 哈希环节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(T node)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numberOfReplicas; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">nodestr</span> <span class="operator">=</span> node.toString() + i;</span><br><span class="line">            <span class="type">int</span> <span class="variable">hashcode</span> <span class="operator">=</span> nodestr.hashCode();</span><br><span class="line">            System.out.println(<span class="string">&quot;hashcode:&quot;</span> + hashcode);</span><br><span class="line">            circle.put(hashcode, node);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除一个节点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node 待删除节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(T node)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numberOfReplicas; i++) &#123;</span><br><span class="line">            circle.remove((node.toString() + i).hashCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得一个最近的顺时针节点,根据给定的key 取Hash</span></span><br><span class="line"><span class="comment">     * 然后再取得顺时针方向上最近的一个虚拟节点对应的实际节点</span></span><br><span class="line"><span class="comment">     * 再从实际节点中取得 数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 模拟缓存Key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (circle.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// node 用String来表示,获得node在哈希环中的hashCode</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">        System.out.println(<span class="string">&quot;hashcode-----&gt;:&quot;</span> + hash);</span><br><span class="line">        <span class="comment">//数据映射在两台虚拟机器所在环之间,就需要按顺时针方向寻找机器</span></span><br><span class="line">        <span class="keyword">if</span> (!circle.containsKey(hash)) &#123;</span><br><span class="line">            SortedMap&lt;Integer, T&gt; tailMap = circle.tailMap(hash);</span><br><span class="line">            hash = tailMap.isEmpty() ? circle.firstKey() : tailMap.firstKey();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> circle.get(hash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前哈希环节点数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 哈希环节点数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circle.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看表示整个哈希环中各个虚拟节点位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//获得TreeMap中所有的Key</span></span><br><span class="line">        Set&lt;Integer&gt; sets = circle.keySet();</span><br><span class="line">        <span class="comment">//将获得的Key集合排序</span></span><br><span class="line">        SortedSet&lt;Integer&gt; sortedSets = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;Integer&gt;(sets);</span><br><span class="line">        <span class="keyword">for</span> (Integer hashCode : sortedSets) &#123;</span><br><span class="line">            System.out.println(hashCode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;----each location &#x27;s distance are follows: ----&quot;</span>);</span><br><span class="line">        <span class="comment">//查看相邻两个hashCode的差值</span></span><br><span class="line">        Iterator&lt;Integer&gt; it = sortedSets.iterator();</span><br><span class="line">        Iterator&lt;Integer&gt; it2 = sortedSets.iterator();</span><br><span class="line">        <span class="keyword">if</span> (it2.hasNext()) &#123;</span><br><span class="line">            it2.next();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> keyPre, keyAfter;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext() &amp;&amp; it2.hasNext()) &#123;</span><br><span class="line">            keyPre = it.next();</span><br><span class="line">            keyAfter = it2.next();</span><br><span class="line">            System.out.println(keyAfter - keyPre);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.hash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/5/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConsistentHash&lt;String&gt; consistentHash;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initHash</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; nodes = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        consistentHash = <span class="keyword">new</span> <span class="title class_">ConsistentHash</span>&lt;&gt;(<span class="number">2</span>, nodes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBalance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 分配三个节点</span></span><br><span class="line">        consistentHash.add(<span class="string">&quot;A1&quot;</span>);</span><br><span class="line">        consistentHash.add(<span class="string">&quot;C1&quot;</span>);</span><br><span class="line">        consistentHash.add(<span class="string">&quot;D1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;hash circle size: &quot;</span> + consistentHash.getSize());</span><br><span class="line">        System.out.println(<span class="string">&quot;location of each node are follows: &quot;</span>);</span><br><span class="line"><span class="comment">//        consistentHash.showBalance();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// hash值在当前哈希环内</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key1</span> <span class="operator">=</span> <span class="string">&quot;A31&quot;</span>;</span><br><span class="line">        <span class="comment">// hash值超出了当前哈希环</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;Apple&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; keys = Arrays.asList(key1, key2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟节点分配</span></span><br><span class="line">        showAllocate(keys);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟增加节点, A31被分配到更近的B1节点</span></span><br><span class="line">        consistentHash.add(<span class="string">&quot;B1&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;增加节点B1&quot;</span>);</span><br><span class="line">        showAllocate(keys);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">// 模拟删除节点, A31被分配到更近的C1节点</span></span><br><span class="line">        consistentHash.remove(<span class="string">&quot;B1&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;删除节点B1&quot;</span>);</span><br><span class="line">        showAllocate(keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟缓存分配</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keys 缓存键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showAllocate</span><span class="params">(List&lt;String&gt; keys)</span> &#123;</span><br><span class="line">        keys.forEach(key -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> consistentHash.get(key);</span><br><span class="line">            <span class="comment">// A31被分配到更近的C1节点</span></span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;key %s is allocated to node %s&quot;</span>, key, node));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">hashcode:64032</span><br><span class="line">hashcode:64033</span><br><span class="line">hashcode:65954</span><br><span class="line">hashcode:65955</span><br><span class="line">hashcode:66915</span><br><span class="line">hashcode:66916</span><br><span class="line"><span class="built_in">hash</span> circle size: 6</span><br><span class="line">location of each node are follows: </span><br><span class="line">hashcode-----&gt;:64095</span><br><span class="line">key A31 is allocated to node C1</span><br><span class="line">hashcode-----&gt;:63476538</span><br><span class="line">key Apple is allocated to node A1</span><br><span class="line">hashcode:64993</span><br><span class="line">hashcode:64994</span><br><span class="line">增加节点B1</span><br><span class="line">hashcode-----&gt;:64095</span><br><span class="line">key A31 is allocated to node B1</span><br><span class="line">hashcode-----&gt;:63476538</span><br><span class="line">key Apple is allocated to node A1</span><br><span class="line">-------------------------------------</span><br><span class="line">删除节点B1</span><br><span class="line">hashcode-----&gt;:64095</span><br><span class="line">key A31 is allocated to node C1</span><br><span class="line">hashcode-----&gt;:63476538</span><br><span class="line">key Apple is allocated to node A1</span><br></pre></td></tr></table></figure><p>可以看出，增加或删除节点，只会影响到节点与上一个节点之间的元素，所以一致性Hash算法在容错性和可扩展性上面较普通Hash是有巨大提升的。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://juejin.im/post/5ae1476ef265da0b8d419ef2#heading-4">五分钟看懂一致性哈希算法</a></p><p><a href="https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8">维基百科-散列函数</a></p><p><a href="http://blog.codinglabs.org/articles/consistent-hashing.html">一致性哈希算法及其在分布式系统中的应用</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;一致性哈希算法在1997年由麻省理工学院的Karger等人在解决分布式Cache中提出的，设计目标是为了解决因特网中的热点(Hot spot)问题，初衷和CARP十分类似。一致性哈希修正了CARP使用的简单哈希算法带来的问题，使得DHT可以在P2P环境中真正得到应用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;现在一致性hash算法在分布式系统中也得到了广泛应用，研究过memcached缓存数据库的人都知道，memcached服务器端本身不提供分布式cache的一致性，而是由客户端来提供，具体在计算一致性hash时采用如下步骤：&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="一致性Hash" scheme="https://blog.gcdd.top/tags/%E4%B8%80%E8%87%B4%E6%80%A7Hash/"/>
    
  </entry>
  
  <entry>
    <title>理解Nginx负载均衡</title>
    <link href="https://blog.gcdd.top/p/52703/"/>
    <id>https://blog.gcdd.top/p/52703/</id>
    <published>2019-05-29T02:30:45.000Z</published>
    <updated>2023-08-30T04:52:53.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>工作以来，一直都在使用Nginx作为负载均衡服务器，但是关于Nginx的负载均衡算法一直没有深入理解过，这次好好的整理下。</p><span id="more"></span><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><blockquote><p>搭建三台用于测试的虚拟机</p></blockquote><table><thead><tr><th>名称</th><th>IP</th><th>服务</th></tr></thead><tbody><tr><td>node01</td><td>192.168.198.131</td><td>Nginx、模拟业务（8080）</td></tr><tr><td>node02</td><td>192.168.198.130</td><td>模拟业务（8080）</td></tr><tr><td>node03</td><td>192.168.198.132</td><td>模拟业务（8080）</td></tr></tbody></table><p>修改<code>hostname</code>和<code>hosts</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/hosts</span><br><span class="line">192.168.198.131 node01</span><br><span class="line">$ vim /etc/hostname</span><br><span class="line">node01</span><br><span class="line">$ reboot</span><br><span class="line"><span class="comment">## 其余两台也改下，并重启使配置生效</span></span><br></pre></td></tr></table></figure><p>在node01上<a href="https://gcdd1993.github.io/%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/#Nginx">安装Nginx服务</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -e <span class="string">&quot;deb http://nginx.org/packages/ubuntu/ <span class="subst">$(lsb_release -cs)</span> nginx\ndeb-src http://nginx.org/packages/ubuntu/ <span class="subst">$(lsb_release -cs)</span> nginx&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nginx.list</span><br><span class="line">$ wget -O- http://nginx.org/keys/nginx_signing.key | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install nginx</span><br></pre></td></tr></table></figure><h2 id="模拟业务"><a href="#模拟业务" class="headerlink" title="模拟业务"></a>模拟业务</h2><p>使用<a href="https://start.spring.io/">https://start.spring.io</a>快速新建<code>Spring Boot</code>项目，添加Web模块，并编写以下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;this is : &quot;</span> + Inet4Address.getLocalHost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打包并部署到服务器，我使用的是<a href="https://docs.gradle.org/current/userguide/application_plugin.html">The Application Plugin</a>，部署完毕启动</p><p><img src="https://i.loli.net/2019/05/29/5cedfb9fdb17458291.png"></p><p>测试下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## node01</span></span><br><span class="line">$ curl 192.168.198.131:8080/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br><span class="line"><span class="comment">## node02</span></span><br><span class="line">$ curl 192.168.198.130:8080/test</span><br><span class="line">...</span><br><span class="line">this is : node02/192.168.198.130</span><br><span class="line"><span class="comment">## node03</span></span><br><span class="line">$ curl 192.168.198.132:8080/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br></pre></td></tr></table></figure><h1 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h1><h2 id="Round-Robin（轮询）"><a href="#Round-Robin（轮询）" class="headerlink" title="Round Robin（轮询）"></a><strong>Round Robin</strong>（轮询）</h2><blockquote><p>请求在服务器之间均匀分布，<strong>可以设置服务器权重</strong>。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">server 192.168.198.131:8080;</span><br><span class="line">server 192.168.198.132:8080;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name 192.168.198.131;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://backend;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131 <span class="comment"># node01</span></span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132 <span class="comment"># node03</span></span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.130 <span class="comment"># node02</span></span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131 <span class="comment"># node01</span></span><br></pre></td></tr></table></figure><p>可以看到，每台服务器访问到的次数是相等的。</p><h2 id="Least-Connections"><a href="#Least-Connections" class="headerlink" title="Least Connections"></a><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&_ga=2.118306121.1736170978.1559096932-1620268891.1559096932#least_conn"><strong>Least Connections</strong></a></h2><blockquote><p>请求分配到连接数最少的服务器，<strong>可以设置服务器权重</strong>。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">least_conn;</span><br><span class="line">server 192.168.198.131:8080;</span><br><span class="line">server 192.168.198.132:8080;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>这个不知道怎么模拟出连接数最少场景。</p><h2 id="IP-Hash"><a href="#IP-Hash" class="headerlink" title="IP Hash"></a><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash"><strong>IP Hash</strong></a></h2><blockquote><p>从客户端的IP地址来确定请求应该发送给哪台服务器。在这种情况下，使用IPv4地址的前三个八位字节或整个IPv6地址来计算散列值。该方法能保证来自同一地址的请求分配到同一台服务器，除非该服务器不可用。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">ip_hash;</span><br><span class="line">server 192.168.198.131:8080;</span><br><span class="line">server 192.168.198.132:8080;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br></pre></td></tr></table></figure><p>可以看到，请求都被分配到node01节点。</p><p>接下来，将node01节点关闭，看看会发生什么：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef | grep demo</span><br><span class="line">root       3343   1764  0 11:52 pts/0    00:00:23 java -jar /home/demo/demo-boot-0.0.1-SNAPSHOT/lib/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">root       4529   1764  0 13:11 pts/0    00:00:00 grep --color=auto demo</span><br><span class="line">$ <span class="built_in">kill</span> -9 3343</span><br><span class="line">$ ps -ef | grep demo</span><br><span class="line">root       4529   1764  0 13:11 pts/0    00:00:00 grep --color=auto demo</span><br><span class="line"></span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br></pre></td></tr></table></figure><p>由于node01节点不可用，请求都被分配到node03节点。</p><h2 id="Generic-Hash"><a href="#Generic-Hash" class="headerlink" title="Generic Hash"></a>Generic <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash"><strong>Hash</strong></a></h2><blockquote><p>与上面的IP_HASH类似，通用HASH按照用户定义的参数来计算散列值，参数可以是文本字符串，变量或组合。例如，参数可以是远端地址：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line"><span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">server 192.168.198.131:8080;</span><br><span class="line">server 192.168.198.132:8080;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node02/192.168.198.130</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node02/192.168.198.130</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node02/192.168.198.130</span><br></pre></td></tr></table></figure><p>可以看到，请求都被分配到了<code>node02</code>节点。</p><p>👉上面的<code>consistent</code>是可选参数，如果设置了，将采用<a href="http://blog.codinglabs.org/articles/consistent-hashing.html">Ketama一致性hash算法</a>计算散列值。</p><p>关于一致性Hash，可以查看我的另一篇博客：<a href="https://gcdd1993.github.io/%E7%90%86%E8%A7%A3%E4%B8%80%E8%87%B4%E6%80%A7Hash%E7%AE%97%E6%B3%95">理解一致性Hash算法</a></p><h2 id="Random"><a href="#Random" class="headerlink" title="Random"></a><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#random"><strong>Random</strong></a></h2><blockquote><p>请求会被随机分配到一台服务器，<strong>可以设置服务器权重</strong>。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">random;</span><br><span class="line">server 192.168.198.131:8080;</span><br><span class="line">server 192.168.198.132:8080;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node02/192.168.198.130</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.130</span><br></pre></td></tr></table></figure><p>可以看到，请求是被随机分配到三台服务器的。</p><h2 id="Weights"><a href="#Weights" class="headerlink" title="Weights"></a>Weights</h2><blockquote><p>除了设置负载均衡算法，我们还可以为服务器设置权重，权重默认值是1</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf/demo.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">server 192.168.198.131:8080 weight=5;</span><br><span class="line">server 192.168.198.132:8080 weight=10;</span><br><span class="line">server 192.168.198.130:8080;</span><br><span class="line">&#125;</span><br><span class="line">$ service nginx restart</span><br></pre></td></tr></table></figure><p>测试下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node03/192.168.198.132</span><br><span class="line">$ curl 192.168.198.131/test</span><br><span class="line">...</span><br><span class="line">this is : node01/192.168.198.131</span><br></pre></td></tr></table></figure><p>可以看到，5次请求中，<code>node03(weight=10)</code>占了3次，<code>node01(weight=5)</code>占了2次，<code>node02(weight=1)</code>1次都没有。</p><p>理论上来说，上面的配置，访问16次，node03应被分配10次，node01应被分配5次，node02应被分配1次。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#overview">http-load-balancer</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;工作以来，一直都在使用Nginx作为负载均衡服务器，但是关于Nginx的负载均衡算法一直没有深入理解过，这次好好的整理下。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Nginx" scheme="https://blog.gcdd.top/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Redis 常用命令</title>
    <link href="https://blog.gcdd.top/p/1091/"/>
    <id>https://blog.gcdd.top/p/1091/</id>
    <published>2019-05-26T03:41:40.000Z</published>
    <updated>2023-08-30T04:52:53.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Redis提供了丰富的命令（command）对数据库和各种数据类型进行操作，这些command可以在Linux终端使用。在编程时，比如各类语言包，这些命令都有对应的方法。下面将Redis提供的命令做一总结。</p><span id="more"></span> <h1 id="键值相关命令"><a href="#键值相关命令" class="headerlink" title="键值相关命令"></a>键值相关命令</h1><h2 id="keys"><a href="#keys" class="headerlink" title="keys"></a>keys</h2><blockquote><p>返回满足给定pattern的所有key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line"> 1) <span class="string">&quot;mylist4&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;myset7&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;name1&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;myset3&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;myset2&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;mylist2&quot;</span></span><br><span class="line"> 7) <span class="string">&quot;mylist6&quot;</span></span><br><span class="line"> 8) <span class="string">&quot;name&quot;</span></span><br><span class="line"> 9) <span class="string">&quot;myhash&quot;</span></span><br><span class="line">10) <span class="string">&quot;mylist7&quot;</span></span><br><span class="line">11) <span class="string">&quot;key1&quot;</span></span><br><span class="line">12) <span class="string">&quot;mylist5&quot;</span></span><br><span class="line">13) <span class="string">&quot;mylist8&quot;</span></span><br><span class="line">14) <span class="string">&quot;myzset2&quot;</span></span><br><span class="line">15) <span class="string">&quot;myzset3&quot;</span></span><br><span class="line">16) <span class="string">&quot;myzset&quot;</span></span><br><span class="line">17) <span class="string">&quot;myset5&quot;</span></span><br><span class="line">18) <span class="string">&quot;myset4&quot;</span></span><br><span class="line">19) <span class="string">&quot;mylist3&quot;</span></span><br><span class="line">20) <span class="string">&quot;myset&quot;</span></span><br><span class="line">21) <span class="string">&quot;myset6&quot;</span></span><br><span class="line">22) <span class="string">&quot;age&quot;</span></span><br><span class="line">23) <span class="string">&quot;mylist&quot;</span></span><br><span class="line">24) <span class="string">&quot;key2&quot;</span></span><br></pre></td></tr></table></figure><p>用表达式*，代表取出所有的key。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys mylist*</span><br><span class="line">1) <span class="string">&quot;mylist4&quot;</span></span><br><span class="line">2) <span class="string">&quot;mylist2&quot;</span></span><br><span class="line">3) <span class="string">&quot;mylist6&quot;</span></span><br><span class="line">4) <span class="string">&quot;mylist7&quot;</span></span><br><span class="line">5) <span class="string">&quot;mylist5&quot;</span></span><br><span class="line">6) <span class="string">&quot;mylist8&quot;</span></span><br><span class="line">7) <span class="string">&quot;mylist3&quot;</span></span><br><span class="line">8) <span class="string">&quot;mylist&quot;</span></span><br></pre></td></tr></table></figure><p>用表达式mylist*，代表取出所有以mylist开头的key。</p><h2 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h2><blockquote><p>确认一个key是否存在</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; exists HongWan</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; exists age</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><p>从结果来数据库中不存在HongWan这个key，但是age这个key是存在的。</p><h2 id="del"><a href="#del" class="headerlink" title="del"></a>del</h2><blockquote><p>删除一个key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; del age</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; exists age</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><h2 id="expire"><a href="#expire" class="headerlink" title="expire"></a>expire</h2><blockquote><p>设置一个key的过期时间(单位:秒)</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; exists addr</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl addr</span><br><span class="line">(<span class="built_in">integer</span>) -1</span><br><span class="line">127.0.0.1:6379&gt; expire addr 10</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl addr</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; ttl addr</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; ttl addr</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; ttl addr</span><br><span class="line">(<span class="built_in">integer</span>) -2</span><br><span class="line">127.0.0.1:6379&gt; exists addr</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>可以看到，未设置过期时间时，ttl值为-1，设置10s过期后，不断地使用ttl获取key的有效时长，当值为-2时，表示已过期并被删除。</p><h2 id="move"><a href="#move" class="headerlink" title="move"></a>move</h2><blockquote><p>将当前数据库中的key转移到其它数据库中</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="keyword">select</span> 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> age 30</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;30&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; move age 1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; <span class="keyword">select</span> 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; get age</span><br><span class="line"><span class="string">&quot;30&quot;</span></span><br></pre></td></tr></table></figure><p>在本例中，我先显式的选择了数据库0，然后在这个库中设置一个key，接下来我们将这个key从数据库0移到数据库1，之后我们确认在数据库0中无此key了, 但在数据库1中存在这个key，说明我们转移成功了 。</p><h2 id="persist"><a href="#persist" class="headerlink" title="persist"></a>persist</h2><blockquote><p>移除给定key的过期时间</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[1]&gt; expire age 300</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[1]&gt; ttl age</span><br><span class="line">(<span class="built_in">integer</span>) 296</span><br><span class="line">127.0.0.1:6379[1]&gt; persist age</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[1]&gt; ttl age</span><br><span class="line">(<span class="built_in">integer</span>) -1</span><br></pre></td></tr></table></figure><p>在这个例子中，我们手动的将未到过期时间的key，成功设置为过期。</p><h2 id="randomkey"><a href="#randomkey" class="headerlink" title="randomkey"></a>randomkey</h2><blockquote><p>随机返回key空间的一个key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; randomkey</span><br><span class="line"><span class="string">&quot;mylist5&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; randomkey</span><br><span class="line"><span class="string">&quot;myzset2&quot;</span></span><br></pre></td></tr></table></figure><p>通过结果可以看到取key的规则是随机的。</p><h2 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h2><blockquote><p>重命名key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[1]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;age&quot;</span></span><br><span class="line">127.0.0.1:6379[1]&gt; rename age age_new</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;age_new&quot;</span></span><br></pre></td></tr></table></figure><p>age成功的被我们改名为age_new了。</p><h2 id="type"><a href="#type" class="headerlink" title="type"></a>type</h2><blockquote><p>返回值的类型</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> name</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> myset</span><br><span class="line"><span class="built_in">set</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> myzset</span><br><span class="line">zset</span><br></pre></td></tr></table></figure><h1 id="服务器相关命令"><a href="#服务器相关命令" class="headerlink" title="服务器相关命令"></a>服务器相关命令</h1><h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h2><blockquote><p>测试连接是否存活</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">// 执行下面命令之前，我们停止redis服务器</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">Could not connect to Redis at 127.0.0.1:6379: Connection refused</span><br><span class="line">// 执行下面命令之前，我们启动redis服务器</span><br><span class="line">not connected&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure><h2 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h2><blockquote><p>在命令行打印一些内容</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">echo</span> HongWan</span><br><span class="line"><span class="string">&quot;HongWan&quot;</span></span><br></pre></td></tr></table></figure><h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><blockquote><p>选择数据库。Redis数据库编号从0~15，我们可以选择任意一个数据库来进行数据的存取</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="keyword">select</span> 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; <span class="keyword">select</span> 16</span><br><span class="line">(error) ERR invalid DB index</span><br></pre></td></tr></table></figure><h2 id="quit"><a href="#quit" class="headerlink" title="quit"></a>quit</h2><blockquote><p>退出连接</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">root@test01:~<span class="comment"># </span></span><br></pre></td></tr></table></figure><h2 id="dbsize"><a href="#dbsize" class="headerlink" title="dbsize"></a>dbsize</h2><blockquote><p>返回当前数据库中key的数目</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 23</span><br></pre></td></tr></table></figure><p>结果说明此库中有23个key。</p><h2 id="info"><a href="#info" class="headerlink" title="info"></a>info</h2><blockquote><p>获取服务器的信息和统计</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info</span><br><span class="line"><span class="comment"># Server</span></span><br><span class="line">redis_version:3.0.6</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:28b6715d3583bf8e</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 4.4.0-148-generic x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">gcc_version:5.4.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>此结果用于说明服务器的基础信息，包括版本、启动时间等。</p><h2 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h2><blockquote><p>实时转储收到的请求</p></blockquote><p>先在终端1输入monitor命令，将会进入等待状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; monitor</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>新建一个终端，输入一些redis命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line"> 1) <span class="string">&quot;myset3&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;myset2&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;mylist7&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;mylist4&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;key1&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;myset7&quot;</span></span><br><span class="line"> 7) <span class="string">&quot;name1&quot;</span></span><br><span class="line"> 8) <span class="string">&quot;mylist6&quot;</span></span><br><span class="line"> 9) <span class="string">&quot;myzset&quot;</span></span><br><span class="line">10) <span class="string">&quot;mylist2&quot;</span></span><br><span class="line">11) <span class="string">&quot;myset&quot;</span></span><br><span class="line">12) <span class="string">&quot;mylist&quot;</span></span><br><span class="line">13) <span class="string">&quot;myhash&quot;</span></span><br><span class="line">14) <span class="string">&quot;myset4&quot;</span></span><br><span class="line">15) <span class="string">&quot;name&quot;</span></span><br><span class="line">16) <span class="string">&quot;myset5&quot;</span></span><br><span class="line">17) <span class="string">&quot;myzset3&quot;</span></span><br><span class="line">18) <span class="string">&quot;mylist3&quot;</span></span><br><span class="line">19) <span class="string">&quot;mylist5&quot;</span></span><br><span class="line">20) <span class="string">&quot;myzset2&quot;</span></span><br><span class="line">21) <span class="string">&quot;mylist8&quot;</span></span><br><span class="line">22) <span class="string">&quot;key2&quot;</span></span><br><span class="line">23) <span class="string">&quot;myset6&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get addr</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>回到终端1中，我们将会看到打印出了刚才我们在终端2中敲入的redis命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; monitor</span><br><span class="line">OK</span><br><span class="line">1558844434.297954 [0 127.0.0.1:34926] <span class="string">&quot;keys&quot;</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">1558844444.673315 [0 127.0.0.1:34926] <span class="string">&quot;get&quot;</span> <span class="string">&quot;addr&quot;</span></span><br></pre></td></tr></table></figure><h2 id="config-get"><a href="#config-get" class="headerlink" title="config get"></a>config get</h2><blockquote><p>获取服务器配置信息</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get <span class="built_in">dir</span></span><br><span class="line">1) <span class="string">&quot;dir&quot;</span></span><br><span class="line">2) <span class="string">&quot;/var/lib/redis&quot;</span></span><br></pre></td></tr></table></figure><p>本例中我们获取了dir这个参数配置的值，如果想获取全部参数据的配置值也很简单，只需<br>执行”config get *”即可将全部的值都显示出来。</p><h2 id="flushdb"><a href="#flushdb" class="headerlink" title="flushdb"></a>flushdb</h2><blockquote><p>删除当前选择数据库中的所有key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 23</span><br><span class="line">127.0.0.1:6379&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>在本例中我们将0号数据库中的key都清除了。</p><h2 id="flushall"><a href="#flushall" class="headerlink" title="flushall"></a>flushall</h2><blockquote><p>删除所有数据库中的所有key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="keyword">select</span> 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[1]&gt; <span class="keyword">select</span> 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="keyword">select</span> 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>在本例中我们先查看了一个1号数据库中有一个key，然后我切换到0号库执行flushall命令，结果1号库中的key也被清除了，说明此命令工作正常。</p><h1 id="数据相关命令"><a href="#数据相关命令" class="headerlink" title="数据相关命令"></a>数据相关命令</h1><p>👉<a href="https://gcdd1993.github.io/Redis-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E6%93%8D%E4%BD%9C/">Redis-数据类型及操作</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;Redis提供了丰富的命令（command）对数据库和各种数据类型进行操作，这些command可以在Linux终端使用。在编程时，比如各类语言包，这些命令都有对应的方法。下面将Redis提供的命令做一总结。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Redis" scheme="https://blog.gcdd.top/tags/Redis/"/>
    
    <category term="NoSql" scheme="https://blog.gcdd.top/tags/NoSql/"/>
    
  </entry>
  
  <entry>
    <title>Redis 数据类型及操作</title>
    <link href="https://blog.gcdd.top/p/38807/"/>
    <id>https://blog.gcdd.top/p/38807/</id>
    <published>2019-05-25T15:59:44.000Z</published>
    <updated>2023-08-30T04:52:53.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为Key-value型数据库，Redis也提供了键（Key）和键值（Value）的映射关系。但是，除了常规的数值或<a href="#strings%EF%BC%88%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89">字符串</a>，Redis的键值还可以是以下形式之一：<span id="more"></span></p><ul><li>[Lists （可重复列表） ](#Lists （可重复列表） )</li><li>[Sets （不可重复集合） ](#Sets （不可重复集合）)</li><li>[Sorted sets （不可重复有序集合） ](#Sorted sets （不可重复有序集合）)</li><li>[Hashes （哈希表）](#Hashes （哈希表）)</li></ul><p>键值的数据类型决定了该键值支持的操作。Redis支持诸如列表、集合或有序集合的交集、并集、查集等高级原子操作；同时，如果键值的类型是普通数字，Redis则提供自增等原子操作。</p><h1 id="strings（字符串）"><a href="#strings（字符串）" class="headerlink" title="strings（字符串）"></a>strings（字符串）</h1><blockquote><p>string类型是二进制安全的。意思是redis的string可以包含任何数据，比如jpg图片或者序列化的对象。</p></blockquote><h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><blockquote><p>设置key对应的值为string类型的value。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name wwl</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h2 id="setnx"><a href="#setnx" class="headerlink" title="setnx"></a>setnx</h2><blockquote><p>设置key对应的值为string类型的value。如果key已经存在，返回0，nx是not exist的意思。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;wwl&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setnx name HongWan_new</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan&quot;</span></span><br></pre></td></tr></table></figure><p>由于原来name有一个对应的值，所以本次的修改不生效，且返回码是0。</p><h2 id="setex"><a href="#setex" class="headerlink" title="setex"></a>setex</h2><blockquote><p>设置key对应的值为string类型的value，并指定此键值对应的有效期。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setex haircolor 10 red </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get haircolor</span><br><span class="line"><span class="string">&quot;red&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get haircolor</span><br><span class="line"><span class="string">&quot;red&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get haircolor</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>可见由于最后一次的调用是10秒以后了，所以取不到haicolor这个键对应的值。</p><h2 id="setrange"><a href="#setrange" class="headerlink" title="setrange"></a>setrange</h2><blockquote><p>设置指定key的value值的子字符串。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="string">&#x27;HongWan@126.com&#x27;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan@126.com&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;  setrange name 8 gmail.com </span><br><span class="line">(<span class="built_in">integer</span>) 17</span><br><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan@gmail.com&quot;</span></span><br></pre></td></tr></table></figure><p>其中的8是指从下标为8（包含8）的字符开始替换。</p><h2 id="mset"><a href="#mset" class="headerlink" title="mset"></a>mset</h2><blockquote><p>一次设置多个key的值，成功返回ok表示所有的值都设置了，失败返回0表示没有任何值被设置。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset key1 HongWan1 key2 HongWan2 </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1 </span><br><span class="line"><span class="string">&quot;HongWan1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">&quot;HongWan2&quot;</span></span><br></pre></td></tr></table></figure><h2 id="msetnx"><a href="#msetnx" class="headerlink" title="msetnx"></a>msetnx</h2><blockquote><p>一次设置多个key的值，成功返回ok表示所有的值都设置了，失败返回0表示没有任何值被设置，但是不会覆盖已经存在的key。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;HongWan1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">&quot;HongWan2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; msetnx key2 HongWan2_new key3 HongWan3</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get key2 </span><br><span class="line"><span class="string">&quot;HongWan2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>可以看出如果这条命令返回0，那么里面操作都会回滚，都不会被执行。</p><h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><blockquote><p>获取key对应的string值,如果key不存在返回nil。 </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan_new&quot;</span></span><br><span class="line"><span class="comment">## 我们获取一个库中不存在的键name1，那么它会返回一个nil以表时无此键值对 </span></span><br><span class="line">redis 127.0.0.1:6379&gt; get name1 </span><br><span class="line">(nil) </span><br></pre></td></tr></table></figure><h2 id="getset"><a href="#getset" class="headerlink" title="getset"></a>getset</h2><blockquote><p>设置key的值，并返回key的旧值。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getset name HongWan_new </span><br><span class="line"><span class="string">&quot;HongWan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;HongWan_new&quot;</span></span><br></pre></td></tr></table></figure><p>如果key不存在，将返回nil，并会设置新值。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; getset name1 aaa</span><br><span class="line">(nil) </span><br><span class="line">127.0.0.1:6379&gt; get name1</span><br><span class="line"><span class="string">&quot;aaa&quot;</span></span><br></pre></td></tr></table></figure><h2 id="getrange"><a href="#getrange" class="headerlink" title="getrange"></a>getrange</h2><blockquote><p>获取指定key的value值的子字符串。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name </span><br><span class="line"><span class="string">&quot;HongWan_new&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getrange name 0 6 </span><br><span class="line"><span class="string">&quot;HongWan&quot;</span></span><br><span class="line"><span class="comment">## 字符串左面下标是从0开始的</span></span><br><span class="line">127.0.0.1:6379&gt; getrange name -7 -1</span><br><span class="line"><span class="string">&quot;Wan_new&quot;</span></span><br><span class="line"><span class="comment">## 字符串右面下标是从-1开始的</span></span><br><span class="line">127.0.0.1:6379&gt; getrange name 7 100 </span><br><span class="line"><span class="string">&quot;_new&quot;</span></span><br><span class="line"><span class="comment">## 当下标超出字符串长度时，将默认为是同方向的最大下标</span></span><br></pre></td></tr></table></figure><h2 id="mget"><a href="#mget" class="headerlink" title="mget"></a>mget</h2><blockquote><p>一次获取多个key的值，如果对应key不存在，则对应返回nil。 </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mget key1 key2 key3 </span><br><span class="line">1) <span class="string">&quot;HongWan1&quot;</span></span><br><span class="line">2) <span class="string">&quot;HongWan2&quot;</span></span><br><span class="line">3) (nil)</span><br><span class="line"><span class="comment">## key3由于没有这个键定义，所以返回nil。 </span></span><br></pre></td></tr></table></figure><h2 id="incr"><a href="#incr" class="headerlink" title="incr"></a>incr</h2><blockquote><p>对key的值做加加操作,并返回新的值。注意incr一个不是int的value会返回错误，incr一个不存在的key，则设置key为1 。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> age 20</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; incr age </span><br><span class="line">(<span class="built_in">integer</span>) 21</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;21&quot;</span></span><br></pre></td></tr></table></figure><h2 id="incrby"><a href="#incrby" class="headerlink" title="incrby"></a>incrby</h2><blockquote><p>同incr类似，加指定值 ，key不存在时候会设置key，并认为原来的value是 0 。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get age </span><br><span class="line"><span class="string">&quot;21&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; incrby age 5</span><br><span class="line">(<span class="built_in">integer</span>) 26</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;HongWan_new&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;26&quot;</span></span><br></pre></td></tr></table></figure><h2 id="decr"><a href="#decr" class="headerlink" title="decr"></a>decr</h2><blockquote><p>对key的值做的是减减操作，decr一个不存在key，则设置key为-1。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;26&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; decr age</span><br><span class="line">(<span class="built_in">integer</span>) 25</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;25&quot;</span></span><br></pre></td></tr></table></figure><h2 id="decrby"><a href="#decrby" class="headerlink" title="decrby"></a>decrby</h2><blockquote><p>同decr，减指定值。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;25&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; decrby age 5</span><br><span class="line">(<span class="built_in">integer</span>) 20</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br></pre></td></tr></table></figure><p>decrby完全是为了可读性，我们完全可以通过incrby一个负值来实现同样效果，反之一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; incrby age -5</span><br><span class="line">(<span class="built_in">integer</span>) 15</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;15&quot;</span></span><br></pre></td></tr></table></figure><h2 id="append"><a href="#append" class="headerlink" title="append"></a>append</h2><blockquote><p>给指定key的字符串值追加value,返回新字符串值的长度。 </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;HongWan_new&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; append name @126.com</span><br><span class="line">(<span class="built_in">integer</span>) 19</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;HongWan_new@126.com&quot;</span></span><br></pre></td></tr></table></figure><h2 id="strlen"><a href="#strlen" class="headerlink" title="strlen"></a>strlen</h2><blockquote><p>取指定key的value值的长度。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;HongWan_new@126.com&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; strlen name</span><br><span class="line">(<span class="built_in">integer</span>) 19</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line"><span class="string">&quot;15&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; strlen age</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h1 id="Lists-（可重复列表）"><a href="#Lists-（可重复列表）" class="headerlink" title="Lists （可重复列表）"></a>Lists （可重复列表）</h1><p>list是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等，操作中key理解为链表的名字。</p><p>Redis的list类型其实就是一个每个子元素都是string类型的双向链表。链表的最大长度是(2^32)。我们可以通过push,pop操作从链表的头部或者尾部添加删除元素。这使得list既可以用作栈，也可以用作队列。 </p><h2 id="lpush"><a href="#lpush" class="headerlink" title="lpush"></a>lpush</h2><blockquote><p>在key对应list的头部添加字符串元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush mylist <span class="string">&quot;world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt;  lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><p>在此处我们先插入了一个world，然后在world的头部插入了一个hello。其中lrange是用于获取mylist的内容。</p><h2 id="rpush"><a href="#rpush" class="headerlink" title="rpush"></a>rpush</h2><blockquote><p>在key对应list的尾部添加字符串元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist2 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist2 <span class="string">&quot;world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><p>在此处我们先插入了一个hello，然后在hello的尾部插入了一个world。</p><h2 id="linsert"><a href="#linsert" class="headerlink" title="linsert"></a>linsert</h2><blockquote><p>在key对应list的特定位置之前或之后添加字符串元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist3 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist3 <span class="string">&quot;world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; linsert mylist3 before <span class="string">&quot;world&quot;</span> <span class="string">&quot;there&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist3 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;there&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><p>在此处我们先插入了一个hello，然后在hello的尾部插入了一个world，然后又在world的前面插入了there。</p><h2 id="lset"><a href="#lset" class="headerlink" title="lset"></a>lset</h2><blockquote><p>设置list中指定下标的元素值(下标从0开始) 。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist4 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist4 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist4 <span class="string">&quot;three&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lset mylist4 0 <span class="string">&quot;four&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lset mylist4 -2 <span class="string">&quot;five&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist4 0 -1</span><br><span class="line">1) <span class="string">&quot;four&quot;</span></span><br><span class="line">2) <span class="string">&quot;five&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br></pre></td></tr></table></figure><p>在此处我们依次插入了one,two,three，然后将标是0的值设置为four，再将下标是-2的值设置为five。</p><h2 id="lrem"><a href="#lrem" class="headerlink" title="lrem"></a>lrem</h2><blockquote><p>从key对应list中删除count个和value相同的元素。</p></blockquote><p>count&gt;0时，按从头到尾的顺序删除。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist5 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist5 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist5 <span class="string">&quot;foo&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist5 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrem mylist5 2 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) <span class="string">&quot;foo&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure><p>count&lt;0时，按从尾到头的顺序删除。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist6 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist6 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist6 <span class="string">&quot;foo&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist6 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrem mylist6 -2 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist6 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure><p>count=0时，删除全部。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist7 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist7 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist7 <span class="string">&quot;foo&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist7 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrem mylist7 0 <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist7 0 -1</span><br><span class="line">1) <span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure><h2 id="ltrim"><a href="#ltrim" class="headerlink" title="ltrim"></a>ltrim</h2><blockquote><p>保留指定key 的值范围内的数据。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush mylist8 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist8 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist8 <span class="string">&quot;three&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist8 <span class="string">&quot;four&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; ltrim mylist8 1 -1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist8 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;three&quot;</span></span><br><span class="line">3) <span class="string">&quot;four&quot;</span></span><br></pre></td></tr></table></figure><h2 id="lpop"><a href="#lpop" class="headerlink" title="lpop"></a>lpop</h2><blockquote><p>从list的头部删除元素，并返回删除元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpop mylist</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><h2 id="rpop"><a href="#rpop" class="headerlink" title="rpop"></a>rpop</h2><blockquote><p>从list的尾部删除元素，并返回删除元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpop mylist2</span><br><span class="line"><span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure><h2 id="rpoplpush"><a href="#rpoplpush" class="headerlink" title="rpoplpush"></a>rpoplpush</h2><blockquote><p>从第一个list的尾部移除元素并添加到第二个list的头部,最后返回被移除的元素值，整个操作是原子的。如果第一个list是空或者不存在返回nil。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) <span class="string">&quot;foo&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist6 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;foo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpoplpush mylist5 mylist6</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) <span class="string">&quot;foo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist6 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure><h2 id="lindex"><a href="#lindex" class="headerlink" title="lindex"></a>lindex</h2><blockquote><p>返回名称为key的list中index位置的元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;foo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex mylist5 0</span><br><span class="line"><span class="string">&quot;three&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex mylist5 1</span><br><span class="line"><span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure><h2 id="llen"><a href="#llen" class="headerlink" title="llen"></a>llen</h2><blockquote><p>返回key对应list的长度。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; llen mylist5</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h1 id="Sets-（不可重复集合）"><a href="#Sets-（不可重复集合）" class="headerlink" title="Sets （不可重复集合）"></a>Sets （不可重复集合）</h1><p>Redis的set是string类型的无序集合。set元素最大可以包含(2^32)个元素。</p><p>set的是通过hash table实现的，所以添加、删除和查找的复杂度都是O(1)。hash table会随着添加或者删除自动的调整大小。</p><h2 id="sadd"><a href="#sadd" class="headerlink" title="sadd"></a>sadd</h2><blockquote><p>向名称为key的set中添加元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">&quot;world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset <span class="string">&quot;world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;world&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure><p>本例中，我们向myset中添加了三个元素，但由于第三个元素跟第二个元素是相同的，所以第三个元素没有添加成功，最后我们用smembers来查看myset中的所有元素。</p><h2 id="srem"><a href="#srem" class="headerlink" title="srem"></a>srem</h2><blockquote><p>删除名称为key的set中的元素member。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset2 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 <span class="string">&quot;three&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; srem myset2 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; srem myset2 <span class="string">&quot;four&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br></pre></td></tr></table></figure><p>本例中，我们向myset2中添加了三个元素后，再调用srem来删除one和four，但由于元素中没有four所以，此条srem命令执行失败。</p><h2 id="spop"><a href="#spop" class="headerlink" title="spop"></a>spop</h2><blockquote><p>随机返回并删除名称为key的set中一个元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset3 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset3 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset3 <span class="string">&quot;three&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; spop myset3</span><br><span class="line"><span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br></pre></td></tr></table></figure><p>本例中，我们向myset3中添加了三个元素后，再调用spop来随机删除一个元素，可以看到three元素被删除了。</p><h2 id="sdiff"><a href="#sdiff" class="headerlink" title="sdiff"></a>sdiff</h2><blockquote><p>返回所有给定key与第一个key的差集。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sdiff myset2 myset3</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br></pre></td></tr></table></figure><p>本例中，我们可以看到myset2中的元素与myset3中不同的只是three，所以只有three被查出来了，而不是three和one，因为one是myset3的元素。 </p><p>我们也可以将myset2和myset3换个顺序来看一下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sdiff myset3 myset2</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br></pre></td></tr></table></figure><p>这个结果中只显示了，myset3中的元素与myset2中不同的元素。</p><h2 id="sdiffstore"><a href="#sdiffstore" class="headerlink" title="sdiffstore"></a>sdiffstore</h2><p>返回所有给定key与第一个key的差集，并将结果存为另一个key。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sdiffstore myset4 myset2 myset3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset4</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br></pre></td></tr></table></figure><h2 id="sinter"><a href="#sinter" class="headerlink" title="sinter"></a>sinter</h2><blockquote><p>返回所有给定key的交集。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sinter myset2 myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例的结果可以看出, myset2和myset3的交集two被查出来了。</p><h2 id="sinterstore"><a href="#sinterstore" class="headerlink" title="sinterstore"></a>sinterstore</h2><blockquote><p>返回所有给定key的交集，并将结果存为另一个key。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sinterstore myset5 myset2 myset3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset5</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例的结果可以看出, myset2和myset3的交集被保存到myset5中了。</p><h2 id="sunion"><a href="#sunion" class="headerlink" title="sunion"></a>sunion</h2><blockquote><p>返回所有给定key的并集。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sunion myset2 myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例的结果可以看出, myset2和myset3的并集被查出来了。</p><h2 id="sunionstore"><a href="#sunionstore" class="headerlink" title="sunionstore"></a>sunionstore</h2><blockquote><p>返回所有给定key的并集，并将结果存为另一个key。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sunionstore myset6 myset2 myset3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers myset6</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例的结果可以看出, myset2和myset3的并集被保存到myset6中了。</p><h2 id="smove"><a href="#smove" class="headerlink" title="smove"></a>smove</h2><blockquote><p>从第一个key对应的set中移除member并添加到第二个对应set中。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smove myset2 myset7 three</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset7</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例可以看到，myset2的three被移到myset7中了。</p><h2 id="scard"><a href="#scard" class="headerlink" title="scard"></a>scard</h2><blockquote><p>返回名称为key的set的元素个数。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scard myset2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h2 id="sismember"><a href="#sismember" class="headerlink" title="sismember"></a>sismember</h2><blockquote><p>测试member是否是名称为key的set的元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sismember myset2 two</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sismember myset2 one</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>通过本例可以看到，two是myset2的成员，而one不是。</p><h2 id="srandmember"><a href="#srandmember" class="headerlink" title="srandmember"></a>srandmember</h2><blockquote><p>随机返回名称为key的set的一个元素，但是不删除元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers myset3</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset3</span><br><span class="line"><span class="string">&quot;three&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset3</span><br><span class="line"><span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset3</span><br><span class="line"><span class="string">&quot;one&quot;</span></span><br></pre></td></tr></table></figure><p>通过本例可以看到，第二次返回了元素”one”，但是并没有删除”one”元素。</p><h1 id="Sorted-sets-（不可重复有序集合）"><a href="#Sorted-sets-（不可重复有序集合）" class="headerlink" title="Sorted sets （不可重复有序集合）"></a>Sorted sets （不可重复有序集合）</h1><p>sorted set是set的一个升级版本，它在set的基础上增加了一个顺序属性，这一属性在添加修改元素的时候可以指定，每次指定后，zset会自动重新按新的值调整顺序。可以理解为有两列的mysql表，一列存value，一列存顺序。</p><p>和set一样sorted set也是string类型元素的集合，不同的是每个元素都会关联一个double类型的score。sorted set的实现是skip list和hash table的混合体。</p><h2 id="zadd"><a href="#zadd" class="headerlink" title="zadd"></a>zadd</h2><blockquote><p>向名称为key的zset中添加元素member，score用于排序。如果该元素已经存在，则根据score更新该元素的顺序。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myzset 1 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset 2 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset 3 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><h2 id="zrem"><a href="#zrem" class="headerlink" title="zrem"></a>zrem</h2><blockquote><p>删除名称为key的zset中的元素member。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrem myzset two</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>可以看到two被删除了。</p><h2 id="zincrby"><a href="#zincrby" class="headerlink" title="zincrby"></a>zincrby</h2><blockquote><p>如果在名称为key的zset中已经存在元素member，则该元素的score增加increment；否则向集合中添加该元素，其score的值为increment。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myzset2 1 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset2 2 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zincrby myzset2 2 <span class="string">&quot;one&quot;</span></span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrange myzset2 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;2&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><p>本例中将one的score从1增加了2，增加到了3。</p><h2 id="zrank"><a href="#zrank" class="headerlink" title="zrank"></a>zrank</h2><blockquote><p>返回名称为key的zset中member元素的排名(按score从小到大排序)即下标。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myzset3 1 <span class="string">&quot;one&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset3 2 <span class="string">&quot;two&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset3 3 <span class="string">&quot;three&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset3 5 <span class="string">&quot;five&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;2&quot;</span></span><br><span class="line">5) <span class="string">&quot;three&quot;</span></span><br><span class="line">6) <span class="string">&quot;3&quot;</span></span><br><span class="line">7) <span class="string">&quot;five&quot;</span></span><br><span class="line">8) <span class="string">&quot;5&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrank myzset3 two</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h2 id="zrevrank"><a href="#zrevrank" class="headerlink" title="zrevrank"></a>zrevrank</h2><blockquote><p>返回名称为key的zset中member元素的排名(按score从大到小排序)即下标。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;2&quot;</span></span><br><span class="line">5) <span class="string">&quot;three&quot;</span></span><br><span class="line">6) <span class="string">&quot;3&quot;</span></span><br><span class="line">7) <span class="string">&quot;five&quot;</span></span><br><span class="line">8) <span class="string">&quot;5&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrank myzset3 two</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><p>按从大到小排序的话two是第三个元素，下标是2。</p><h2 id="zrevrange"><a href="#zrevrange" class="headerlink" title="zrevrange"></a>zrevrange</h2><blockquote><p>返回名称为key的zset（按score从大到小排序）中的index从start到end的所有元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;five&quot;</span></span><br><span class="line">2) <span class="string">&quot;5&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;2&quot;</span></span><br><span class="line">7) <span class="string">&quot;one&quot;</span></span><br><span class="line">8) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><h2 id="zrangebyscore"><a href="#zrangebyscore" class="headerlink" title="zrangebyscore"></a>zrangebyscore</h2><blockquote><p>返回集合中score在给定区间的元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;1&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;2&quot;</span></span><br><span class="line">5) <span class="string">&quot;three&quot;</span></span><br><span class="line">6) <span class="string">&quot;3&quot;</span></span><br><span class="line">7) <span class="string">&quot;five&quot;</span></span><br><span class="line">8) <span class="string">&quot;5&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore myzset3 2 3 withscores</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;2&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><h2 id="zcount"><a href="#zcount" class="headerlink" title="zcount"></a>zcount</h2><blockquote><p>返回集合中score在给定区间的数量。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;five&quot;</span></span><br><span class="line">2) <span class="string">&quot;5&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;2&quot;</span></span><br><span class="line">7) <span class="string">&quot;one&quot;</span></span><br><span class="line">8) <span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zcount myzset3 2 3</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h2 id="zcard"><a href="#zcard" class="headerlink" title="zcard"></a>zcard</h2><blockquote><p>返回集合中元素个数。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;five&quot;</span></span><br><span class="line">2) <span class="string">&quot;5&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;2&quot;</span></span><br><span class="line">7) <span class="string">&quot;one&quot;</span></span><br><span class="line">8) <span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zcard myzset3</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure><h2 id="zscore"><a href="#zscore" class="headerlink" title="zscore"></a>zscore</h2><blockquote><p>返回给定元素对应的score。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;five&quot;</span></span><br><span class="line">2) <span class="string">&quot;5&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;2&quot;</span></span><br><span class="line">7) <span class="string">&quot;one&quot;</span></span><br><span class="line">8) <span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;  zscore myzset3 two</span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure><h2 id="zremrangebyrank"><a href="#zremrangebyrank" class="headerlink" title="zremrangebyrank"></a>zremrangebyrank</h2><blockquote><p>删除集合中排名在给定区间的元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;five&quot;</span></span><br><span class="line">2) <span class="string">&quot;5&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">4) <span class="string">&quot;3&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;2&quot;</span></span><br><span class="line">7) <span class="string">&quot;one&quot;</span></span><br><span class="line">8) <span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zremrangebyrank myzset3 3 3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;3&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;2&quot;</span></span><br><span class="line">5) <span class="string">&quot;one&quot;</span></span><br><span class="line">6) <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure><p>在本例中我们将myzset3中按从小到大排序结果的下标为3的元素删除了。</p><h2 id="zremrangebyscore"><a href="#zremrangebyscore" class="headerlink" title="zremrangebyscore"></a>zremrangebyscore</h2><blockquote><p>删除集合中score在给定区间的元素。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;3&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;2&quot;</span></span><br><span class="line">5) <span class="string">&quot;one&quot;</span></span><br><span class="line">6) <span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zremrangebyscore myzset3 1 2</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; zrevrange myzset3 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure><p>在本例中我们将myzset3中按从小到大排序结果的score在1~2之间的元素删除了。</p><h1 id="Hashes-（哈希表）"><a href="#Hashes-（哈希表）" class="headerlink" title="Hashes （哈希表）"></a>Hashes （哈希表）</h1><p>Redis hash是一个string类型的field和value的映射表。它的添加、删除操作都是O(1)（平均），hash特别适合用于存储对象。</p><p>相较于将对象的每个字段存成单个string类型，将一个对象存储在hash类型中会占用更少的内存，并且可以更方便的存取整个对象。</p><h2 id="hset"><a href="#hset" class="headerlink" title="hset"></a>hset</h2><blockquote><p>设置hash field为指定值，如果key不存在，则先创建。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset myhash field1 Hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h2 id="hsetnx"><a href="#hsetnx" class="headerlink" title="hsetnx"></a>hsetnx</h2><blockquote><p>设置hash field为指定值，如果key不存在，则先创建。如果field已经存在，返回0，nx是not exist的意思。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hsetnx myhash field <span class="string">&quot;Hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash field <span class="string">&quot;Hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>第一次执行是成功的，但第二次执行相同的命令失败，原因是field已经存在了。 </p><h2 id="hmset"><a href="#hmset" class="headerlink" title="hmset"></a>hmset</h2><blockquote><p>同时设置hash的多个field。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmset myhash field1 Hello field2 World</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h2 id="hget"><a href="#hget" class="headerlink" title="hget"></a>hget</h2><blockquote><p>获取指定的hash field。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hget myhash field1</span><br><span class="line"><span class="string">&quot;Hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hget myhash field2</span><br><span class="line"><span class="string">&quot;World&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hget myhash field3</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>由于数据库没有field3，所以取到的是一个空值nil。</p><h2 id="hmget"><a href="#hmget" class="headerlink" title="hmget"></a>hmget</h2><blockquote><p>获取全部指定的hash filed。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmget myhash field1 field2 field3</span><br><span class="line">1) <span class="string">&quot;Hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;World&quot;</span></span><br><span class="line">3) (nil)</span><br></pre></td></tr></table></figure><p>由于数据库没有field3，所以取到的是一个空值nil。</p><h2 id="hincrby"><a href="#hincrby" class="headerlink" title="hincrby"></a>hincrby</h2><blockquote><p>给指定的hash filed 加上给定值。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset myhash field3 20</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hget myhash field3 </span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hincrby myhash field3 -8</span><br><span class="line">(<span class="built_in">integer</span>) 12</span><br><span class="line">127.0.0.1:6379&gt; hget myhash field3</span><br><span class="line"><span class="string">&quot;12&quot;</span></span><br></pre></td></tr></table></figure><p>在本例中我们将field3的值从20降到了12，即做了一个减8的操作。</p><h2 id="hexists"><a href="#hexists" class="headerlink" title="hexists"></a>hexists</h2><blockquote><p>测试指定field是否存在。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hexists myhash field1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hexists myhash field9</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><p>通过上例可以说明field1存在，但field9是不存在的。</p><h2 id="hlen"><a href="#hlen" class="headerlink" title="hlen"></a>hlen</h2><blockquote><p>返回指定hash的field数量。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hlen myhash</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure><p>通过上例可以看到myhash中有4个field。</p><h2 id="hdel"><a href="#hdel" class="headerlink" title="hdel"></a>hdel</h2><blockquote><p>删除指定hash的指定field。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hlen myhash</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; hdel myhash field1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hlen myhash</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h2 id="hkeys"><a href="#hkeys" class="headerlink" title="hkeys"></a>hkeys</h2><blockquote><p>返回hash的所有field。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;  hkeys myhash</span><br><span class="line">1) <span class="string">&quot;field&quot;</span></span><br><span class="line">2) <span class="string">&quot;field2&quot;</span></span><br><span class="line">3) <span class="string">&quot;field3&quot;</span></span><br></pre></td></tr></table></figure><h2 id="hvals"><a href="#hvals" class="headerlink" title="hvals"></a>hvals</h2><blockquote><p>返回hash的所有value。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hvals myhash</span><br><span class="line">1) <span class="string">&quot;Hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;World&quot;</span></span><br><span class="line">3) <span class="string">&quot;12&quot;</span></span><br></pre></td></tr></table></figure><h2 id="hgetall"><a href="#hgetall" class="headerlink" title="hgetall"></a>hgetall</h2><blockquote><p>获取某个hash中全部的filed及value。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hgetall myhash</span><br><span class="line">1) <span class="string">&quot;field&quot;</span></span><br><span class="line">2) <span class="string">&quot;Hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;field2&quot;</span></span><br><span class="line">4) <span class="string">&quot;World&quot;</span></span><br><span class="line">5) <span class="string">&quot;field3&quot;</span></span><br><span class="line">6) <span class="string">&quot;12&quot;</span></span><br></pre></td></tr></table></figure><p>一下子将myhash中所有的field及对应的value都取出来了。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;作为Key-value型数据库，Redis也提供了键（Key）和键值（Value）的映射关系。但是，除了常规的数值或&lt;a href=&quot;#strings%EF%BC%88%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89&quot;&gt;字符串&lt;/a&gt;，Redis的键值还可以是以下形式之一：</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Redis" scheme="https://blog.gcdd.top/tags/Redis/"/>
    
    <category term="NoSql" scheme="https://blog.gcdd.top/tags/NoSql/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu切换为阿里镜像源</title>
    <link href="https://blog.gcdd.top/p/12805/"/>
    <id>https://blog.gcdd.top/p/12805/</id>
    <published>2019-05-25T15:45:14.000Z</published>
    <updated>2023-08-30T04:52:53.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在VM虚拟机搭建Ubuntu系统学习或者测试时，常常要使用<code>apt</code>安装测试，但是由于系统自带的下载源在国外服务器上，下载速度慢的无法忍受。所以我们需要切换为国内镜像源，能显著加快安装包下载速度。</p><span id="more"></span><h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/apt/</span><br><span class="line">$ <span class="built_in">cp</span> sources.list sources.list.bak <span class="comment">## 备份系统自带的source列表</span></span><br><span class="line"><span class="comment">## 选择合适的镜像源，如阿里云的镜像 http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s/^\(deb\|deb-src\) \([^ ]*\) \(.*\)/\1 http:\/\/mirrors.aliyun.com\/ubuntu \3/&#x27;</span> sources.list</span><br><span class="line"><span class="comment">## 更新apt</span></span><br><span class="line">$ apt-get update</span><br></pre></td></tr></table></figure><h1 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h1><table><thead><tr><th>名称</th><th>地址</th></tr></thead><tbody><tr><td>阿里镜像源</td><td><a href="http://mirrors.aliyun.com/ubuntu">http://mirrors.aliyun.com/ubuntu</a></td></tr><tr><td>清华大学镜像源</td><td><a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu/">https://mirrors.tuna.tsinghua.edu.cn/ubuntu/</a></td></tr><tr><td>网易镜像源</td><td><a href="https://mirrors.163.com/ubuntu/">https://mirrors.163.com/ubuntu/</a></td></tr><tr><td>东北大学镜像源</td><td><a href="http://mirror.neu.edu.cn/ubuntu/">http://mirror.neu.edu.cn/ubuntu/</a></td></tr></tbody></table><p>至于哪个源比较快，看个人的网络吧，可以自行测试下。本人使用的是阿里镜像源。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在VM虚拟机搭建Ubuntu系统学习或者测试时，常常要使用&lt;code&gt;apt&lt;/code&gt;安装测试，但是由于系统自带的下载源在国外服务器上，下载速度慢的无法忍受。所以我们需要切换为国内镜像源，能显著加快安装包下载速度。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Ubuntu" scheme="https://blog.gcdd.top/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Cassandra学习笔记</title>
    <link href="https://blog.gcdd.top/p/60138/"/>
    <id>https://blog.gcdd.top/p/60138/</id>
    <published>2019-05-22T07:42:04.000Z</published>
    <updated>2023-08-30T04:52:53.897Z</updated>
    
    <content type="html"><![CDATA[<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>按照<a href="https://gcdd1993.github.io/%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/#more">Cassandra集群部署</a>搭建两台测试机，环境信息如下：</p><table><thead><tr><th>名称</th><th>IP</th><th>数据中心名称</th></tr></thead><tbody><tr><td>node-01</td><td>192.168.198.130</td><td>datacenter1</td></tr><tr><td>node-02</td><td>192.168.198.131</td><td>datacenter1</td></tr></tbody></table><span id="more"></span><h1 id="Keyspace"><a href="#Keyspace" class="headerlink" title="Keyspace"></a>Keyspace</h1><h2 id="创建Keyspace"><a href="#创建Keyspace" class="headerlink" title="创建Keyspace"></a>创建Keyspace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create_keyspace_statement ::=  CREATE KEYSPACE [ IF NOT EXISTS ] keyspace_name WITH options</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## 使用SimpleStrategy复制策略</span><br><span class="line">CREATE KEYSPACE excelsior</span><br><span class="line">    WITH replication = &#123;&#x27;class&#x27;: &#x27;SimpleStrategy&#x27;, &#x27;replication_factor&#x27; : 3&#125;;</span><br><span class="line"></span><br><span class="line">## 使用NetworkTopologyStrategy复制策略</span><br><span class="line"># 1. 确认分区名称</span><br><span class="line">$ nodetool status</span><br><span class="line">Datacenter: datacenter1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 2. 使用NetworkTopologyStrategy复制策略创建keyspace</span><br><span class="line">CREATE KEYSPACE excalibur</span><br><span class="line">    WITH replication = &#123;&#x27;class&#x27;: &#x27;NetworkTopologyStrategy&#x27;, &#x27;DC1&#x27; : 1, &#x27;DC2&#x27; : 3&#125;</span><br><span class="line">    AND durable_writes = false;</span><br></pre></td></tr></table></figure><h2 id="使用Keyspace"><a href="#使用Keyspace" class="headerlink" title="使用Keyspace"></a>使用Keyspace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use_statement ::=  USE keyspace_name</span><br></pre></td></tr></table></figure><h2 id="修改Keyspace（replication-factor）"><a href="#修改Keyspace（replication-factor）" class="headerlink" title="修改Keyspace（replication factor）"></a>修改Keyspace（replication factor）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter_keyspace_statement ::=  ALTER KEYSPACE keyspace_name WITH options</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER KEYSPACE excelsior </span><br><span class="line">WITH replication = &#123;&#x27;class&#x27;: &#x27;SimpleStrategy&#x27;, &#x27;replication_factor&#x27; : 4&#125;;</span><br></pre></td></tr></table></figure><h2 id="查看Keyspace"><a href="#查看Keyspace" class="headerlink" title="查看Keyspace"></a>查看Keyspace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DESCRIBE KEYSPACE &lt;keyspace name&gt;;</span><br></pre></td></tr></table></figure><p>使用该语句查看创建的键空间是否正确：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DESCRIBE KEYSPACE excelsior;</span><br><span class="line"></span><br><span class="line">CREATE KEYSPACE excelsior WITH replication = &#123;&#x27;class&#x27;: &#x27;SimpleStrategy&#x27;, &#x27;replication_factor&#x27; : 3&#125; AND durable_writes = true;</span><br></pre></td></tr></table></figure><h2 id="删除Keyspace"><a href="#删除Keyspace" class="headerlink" title="删除Keyspace"></a>删除Keyspace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop_keyspace_statement ::=  DROP KEYSPACE [ IF EXISTS ] keyspace_name</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DROP KEYSPACE excelsior;</span><br><span class="line">DESCRIBE excelsior;</span><br><span class="line"></span><br><span class="line">&#x27;excelsior&#x27; not found in keyspaces</span><br></pre></td></tr></table></figure><h1 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h1><h2 id="创建Table"><a href="#创建Table" class="headerlink" title="创建Table"></a>创建Table</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">create_table_statement ::=  CREATE TABLE [ IF NOT EXISTS ] table_name</span><br><span class="line">                            &#x27;(&#x27;</span><br><span class="line">                                column_definition</span><br><span class="line">                                ( &#x27;,&#x27; column_definition )*</span><br><span class="line">                                [ &#x27;,&#x27; PRIMARY KEY &#x27;(&#x27; primary_key &#x27;)&#x27; ]</span><br><span class="line">                            &#x27;)&#x27; [ WITH table_options ]</span><br><span class="line">column_definition      ::=  column_name cql_type [ STATIC ] [ PRIMARY KEY]</span><br><span class="line">primary_key            ::=  partition_key [ &#x27;,&#x27; clustering_columns ]</span><br><span class="line">partition_key          ::=  column_name</span><br><span class="line">                            | &#x27;(&#x27; column_name ( &#x27;,&#x27; column_name )* &#x27;)&#x27;</span><br><span class="line">clustering_columns     ::=  column_name ( &#x27;,&#x27; column_name )*</span><br><span class="line">table_options          ::=  COMPACT STORAGE [ AND table_options ]</span><br><span class="line">                            | CLUSTERING ORDER BY &#x27;(&#x27; clustering_order &#x27;)&#x27; [ AND table_options ]</span><br><span class="line">                            | options</span><br><span class="line">clustering_order       ::=  column_name (ASC | DESC) ( &#x27;,&#x27; column_name (ASC | DESC) )*</span><br></pre></td></tr></table></figure><p>创建Table必须指定主键，主键是用于在表中唯一标识某一行，可以是一列或多列。</p><p>示例，在<code>excelsior</code>键空间创建一张名为<code>excelsior_alt_stats </code>的表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE excelsior.excelsior_alt_stats (</span><br><span class="line">id UUID PRIMARY KEY,</span><br><span class="line">lastname text,</span><br><span class="line">birthday timestamp,</span><br><span class="line">nationality text,</span><br><span class="line">weight text,</span><br><span class="line">height text</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>cassandra还支持collection（map, set, 或者 list）类型作为列：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE excelsior.whimsey ( </span><br><span class="line">    id UUID PRIMARY KEY, </span><br><span class="line">    lastname text, </span><br><span class="line">    excelsior_teams set&lt;text&gt;, </span><br><span class="line">    events list&lt;text&gt;, </span><br><span class="line">    teams map&lt;int,text&gt; </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>甚至是嵌套的元组类型（tuple）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE excelsior.route (</span><br><span class="line">    race_id int, </span><br><span class="line">    race_name text, </span><br><span class="line">    point_id int, </span><br><span class="line">    lat_long tuple&lt;text, tuple&lt;float,float&gt;&gt;, </span><br><span class="line">    PRIMARY KEY (race_id, point_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>更多数据类型请参阅下一节<a href="#Cassandra%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">Cassandra数据结构</a></p><h3 id="静态列"><a href="#静态列" class="headerlink" title="静态列"></a>静态列</h3><p>某些列可以在表定义中声明为STATIC。静态的列将由属于同一分区（具有相同分区键）的所有行“共享”。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t (</span><br><span class="line">    pk int,</span><br><span class="line">    t int,</span><br><span class="line">    v text,</span><br><span class="line">    s text static,</span><br><span class="line">    PRIMARY KEY (pk, t)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO t (pk, t, v, s) VALUES (0, 0, &#x27;val0&#x27;, &#x27;static0&#x27;);</span><br><span class="line">INSERT INTO t (pk, t, v, s) VALUES (0, 1, &#x27;val1&#x27;, &#x27;static1&#x27;);</span><br><span class="line"></span><br><span class="line">SELECT * FROM t;</span><br><span class="line">   pk | t | v      | s</span><br><span class="line">  ----+---+--------+-----------</span><br><span class="line">   0  | 0 | &#x27;val0&#x27; | &#x27;static1&#x27;</span><br><span class="line">   0  | 1 | &#x27;val1&#x27; | &#x27;static1&#x27;</span><br><span class="line">   </span><br><span class="line">## 所有记录中的静态列将永远展示最后一次更新的值   </span><br></pre></td></tr></table></figure><h2 id="修改Table"><a href="#修改Table" class="headerlink" title="修改Table"></a>修改Table</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alter_table_statement   ::=  ALTER TABLE table_name alter_table_instruction</span><br><span class="line">alter_table_instruction ::=  ADD column_name cql_type ( &#x27;,&#x27; column_name cql_type )*</span><br><span class="line">                             | DROP column_name ( column_name )*</span><br><span class="line">                             | WITH options</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE addamsFamily ADD gravesite varchar;</span><br><span class="line"></span><br><span class="line">ALTER TABLE addamsFamily</span><br><span class="line">       WITH comment = &#x27;A most excellent and useful table&#x27;;</span><br></pre></td></tr></table></figure><p>修改Table可以：</p><ol><li>向表中添加新列（通过ADD指令）。请注意，无法更改表的主键，因此新添加的列将不会成为主键的一部分。</li><li>从表中删除列。这会丢弃列及其所有内容。</li><li>更改一些表选项（通过WITH指令）。支持的选项与创建表时相同（在创建后无法更改的COMPACT STORAGE和CLUSTERING ORDER之外）。</li></ol><h2 id="删除Table"><a href="#删除Table" class="headerlink" title="删除Table"></a>删除Table</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop_table_statement ::=  DROP TABLE [ IF EXISTS ] table_name</span><br></pre></td></tr></table></figure><h2 id="截断Table（清空表数据）"><a href="#截断Table（清空表数据）" class="headerlink" title="截断Table（清空表数据）"></a>截断Table（清空表数据）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate_statement ::=  TRUNCATE [ TABLE ] table_name</span><br></pre></td></tr></table></figure><p>由于表是唯一可以在当前截断的对象，因此可以省略TABLE关键字。</p><p>截断表会永久删除表中的所有现有数据，但不会删除表本身。</p><h1 id="Cassandra数据结构"><a href="#Cassandra数据结构" class="headerlink" title="Cassandra数据结构"></a>Cassandra数据结构</h1><blockquote><p>CQL是一种类型化语言，支持丰富的数据类型集，包括本地类型，集合类型，用户定义类型，元组类型和自定义类型：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cql_type ::=  native_type | collection_type | user_defined_type | tuple_type | custom_type</span><br></pre></td></tr></table></figure><h2 id="本地类型（Native-Types）"><a href="#本地类型（Native-Types）" class="headerlink" title="本地类型（Native Types）"></a>本地类型（Native Types）</h2><table><thead><tr><th>类型</th><th>常量支持</th><th>说明</th></tr></thead><tbody><tr><td>ascii</td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>ASCII字符串</td></tr><tr><td><code>bigint</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>64位无符号整数</td></tr><tr><td><code>blob</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-blob"><code>blob</code></a></td><td>任意字节（无验证）</td></tr><tr><td><code>boolean</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-boolean"><code>boolean</code></a></td><td><code>true</code>或<code>false</code></td></tr><tr><td><code>counter</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>计数器列（64位有符号值）</td></tr><tr><td><code>date</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a>， <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>日期（没有相应的时间值）</td></tr><tr><td><code>decimal</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a>， <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-float"><code>float</code></a></td><td>十进制可变精度</td></tr><tr><td><code>double</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a> <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-float"><code>float</code></a></td><td>64位IEEE-754浮点</td></tr><tr><td><code>duration</code></td><td><code>duration</code></td><td>持续时间（纳秒精度）</td></tr><tr><td><code>float</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a>， <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-float"><code>float</code></a></td><td>32位IEEE-754浮点</td></tr><tr><td><code>inet</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>IP地址，IPv4（4字节长）或IPv6（16字节长）</td></tr><tr><td><code>int</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>32位无符号整数</td></tr><tr><td><code>smallint</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>16位有符号整数</td></tr><tr><td><code>text</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>UTF8编码的字符串</td></tr><tr><td><code>time</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a>， <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>具有纳秒精度的时间（没有相应的日期值）</td></tr><tr><td><code>timestamp</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a>， <a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>时间戳（日期和时间），精度为毫秒</td></tr><tr><td><code>timeuuid</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-uuid"><code>uuid</code></a></td><td><a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a>（版本1），通常用作“无冲突”时间戳</td></tr><tr><td><code>tinyint</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>8位有符号整数</td></tr><tr><td><code>uuid</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-uuid"><code>uuid</code></a></td><td>一个<a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a>（任何版本）</td></tr><tr><td><code>varchar</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-string"><code>string</code></a></td><td>UTF8编码的字符串</td></tr><tr><td><code>varint</code></td><td><a href="http://cassandra.apache.org/doc/latest/cql/definitions.html#grammar-token-integer"><code>integer</code></a></td><td>任意精度整数</td></tr></tbody></table><p>其中需要注意的是时间类型：</p><h3 id="timestamps"><a href="#timestamps" class="headerlink" title="timestamps"></a>timestamps</h3><blockquote><p>时间戳类型的值被编码为64位有符号整数，表示自标准基准时间（称为纪元：1970年1月1日格林威治标准时间00:00:00）以来的毫秒数。</p></blockquote><ul><li><code>1299038700000</code></li><li><code>&#39;2011-02-03 04:05+0000&#39;</code></li><li><code>&#39;2011-02-03 04:05:00+0000&#39;</code></li><li><code>&#39;2011-02-03 04:05:00.000+0000&#39;</code></li><li><code>&#39;2011-02-03T04:05+0000&#39;</code></li><li><code>&#39;2011-02-03T04:05:00+0000&#39;</code></li><li><code>&#39;2011-02-03T04:05:00.000+0000&#39;</code></li></ul><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM point</span><br><span class="line">WHERE ts = &#x27;2018-11-15 00:00:30.557+0000&#x27;;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM point</span><br><span class="line">WHERE ts = 1542211230557;</span><br></pre></td></tr></table></figure><p>其中，<code>+0000</code>是RFC 822 4-digit时区规范，<code>+0000</code>指GMT。美国太平洋标准时间为<code>-0800</code>，中国北京标准时间为<code>+8000</code>，官方建议<strong>每次插入查询都带上时区</strong>，不加的话，默认是使用Cassandra节点配置的时区，可能会出现时区不一致导致的查询失败问题。</p><h3 id="dates"><a href="#dates" class="headerlink" title="dates"></a>dates</h3><blockquote><p> 日期类型的值被编码为32位无符号整数，表示在该范围的中心处具有“纪元”的天数（2^31）。大纪元是1970年1月1日。</p></blockquote><p>至于时间戳，日期可以作为整数或使用日期字符串输入。在后一种情况下，格式应为<code>yyyy-mm-dd</code>（例如’2011-02-03’）。</p><h3 id="times"><a href="#times" class="headerlink" title="times"></a>times</h3><blockquote><p>时间类型的值被编码为64位有符号整数，表示自午夜以来的纳秒数。</p></blockquote><p>对于时间戳，可以以整数或表示时间的字符串的形式输入时间。在后一种情况下，格式应为<code>hh:mm:ss [.fffffffff]</code>（其中亚秒精度是可选的，如果提供，则可以小于纳秒）。例如，以下是一段时间内的有效输入：</p><ul><li><code>&#39;08:12:54&#39;</code></li><li><code>&#39;08:12:54.123&#39;</code></li><li><code>&#39;08:12:54.123456&#39;</code></li><li><code>&#39;08:12:54.123456789&#39;</code></li></ul><h3 id="durations"><a href="#durations" class="headerlink" title="durations"></a>durations</h3><blockquote><p>持续时间类型的值被编码为3个有符号整数的可变长度。这是因为一个月的天数可以改变，一天可以有23或25小时，具体取决于夏令时。</p><ul><li><p>第一个整数表示月数（32位整数）</p></li><li><p>第二个表示天数（32位整数）</p></li><li><p>第三个表示纳秒数（64位整数）</p></li></ul></blockquote><ol><li>支持的单位：</li></ol><ul><li><code>y</code>: 年(12 月)</li><li><code>mo</code>: 月 (1 月)</li><li><code>w</code>: 周(7 天)</li><li><code>d</code>: 天(1 天)</li><li><code>h</code>: 小时(3,600,000,000,000 纳秒)</li><li><code>m</code>: 分钟(60,000,000,000 纳)</li><li><code>s</code>: 秒(1,000,000,000 纳)</li><li><code>ms</code>: 毫秒(1,000,000 纳)</li><li><code>us</code> or <code>µs</code> : 微妙(1000 纳)</li><li><code>ns</code>: 纳秒(1 纳)</li></ul><ol start="2"><li>ISO 8601格式：<code>P[n]Y[n]M[n]DT[n]H[n]M[n]S or P[n]W</code></li><li>ISO 8601替代格式：<code>P[YYYY]-[MM]-[DD]T[hh]:[mm]:[ss]</code></li></ol><p>插入示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO RiderResults (rider, race, result) VALUES (&#x27;Christopher Froome&#x27;, &#x27;Tour de France&#x27;, 89h4m48s);</span><br><span class="line">INSERT INTO RiderResults (rider, race, result) VALUES (&#x27;BARDET Romain&#x27;, &#x27;Tour de France&#x27;, PT89H8M53S);</span><br><span class="line">INSERT INTO RiderResults (rider, race, result) VALUES (&#x27;QUINTANA Nairo&#x27;, &#x27;Tour de France&#x27;, P0000-00-00T89:09:09);</span><br></pre></td></tr></table></figure><blockquote><p>持续时间列不能作为主键。这是由于无法精确确认持续时间。如果没有日期上下文，实际上不可能知道1个月是否大于29天。</p><p>1天的持续时间也不等于24h，因为持续时间类型需要支持夏令时。</p></blockquote><h2 id="集合类型（Collections）"><a href="#集合类型（Collections）" class="headerlink" title="集合类型（Collections）"></a>集合类型（Collections）</h2><p>cassandra支持三种类型的集合：<a href="http://cassandra.apache.org/doc/latest/cql/types.html#maps">Maps</a>, <a href="http://cassandra.apache.org/doc/latest/cql/types.html#sets">Sets</a> and <a href="http://cassandra.apache.org/doc/latest/cql/types.html#lists">Lists</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">collection_type ::=  MAP &#x27;&lt;&#x27; cql_type &#x27;,&#x27; cql_type &#x27;&gt;&#x27;</span><br><span class="line">                     | SET &#x27;&lt;&#x27; cql_type &#x27;&gt;&#x27;</span><br><span class="line">                     | LIST &#x27;&lt;&#x27; cql_type &#x27;&gt;&#x27;</span><br></pre></td></tr></table></figure><p>可以这样输入集合类型的数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">collection_literal ::=  map_literal | set_literal | list_literal</span><br><span class="line">map_literal        ::=  &#x27;&#123;&#x27; [ term &#x27;:&#x27; term (&#x27;,&#x27; term : term)* ] &#x27;&#125;&#x27;</span><br><span class="line">set_literal        ::=  &#x27;&#123;&#x27; [ term (&#x27;,&#x27; term)* ] &#x27;&#125;&#x27;</span><br><span class="line">list_literal       ::=  &#x27;[&#x27; [ term (&#x27;,&#x27; term)* ] &#x27;]&#x27;</span><br></pre></td></tr></table></figure><h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><blockquote><p>Maps是一组（有序）键值对，其中键是唯一的，并且按其键排序。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE users (</span><br><span class="line">    id text PRIMARY KEY,</span><br><span class="line">    name text,</span><br><span class="line">    favs map&lt;text, text&gt; // A map of text keys, and text values</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (id, name, favs)</span><br><span class="line">           VALUES (&#x27;jsmith&#x27;, &#x27;John Smith&#x27;, &#123; &#x27;fruit&#x27; : &#x27;Apple&#x27;, &#x27;band&#x27; : &#x27;Beatles&#x27; &#125;);</span><br><span class="line"></span><br><span class="line">// Replace the existing map entirely.</span><br><span class="line">UPDATE users SET favs = &#123; &#x27;fruit&#x27; : &#x27;Banana&#x27; &#125; WHERE id = &#x27;jsmith&#x27;;</span><br></pre></td></tr></table></figure><p>另外，Maps还具有一些高级特性：</p><ul><li>更新或插入一个或多个元素</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET favs[&#x27;author&#x27;] = &#x27;Ed Poe&#x27; WHERE id = &#x27;jsmith&#x27;;</span><br><span class="line">UPDATE users SET favs = favs + &#123; &#x27;movie&#x27; : &#x27;Cassablanca&#x27;, &#x27;band&#x27; : &#x27;ZZ Top&#x27; &#125; WHERE id = &#x27;jsmith&#x27;;</span><br></pre></td></tr></table></figure><ul><li>删除一个或多个元素（如果一个元素不存在，删除它是一个无效操作但不会抛出错误）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE favs[&#x27;author&#x27;] FROM users WHERE id = &#x27;jsmith&#x27;;</span><br><span class="line">UPDATE users SET favs = favs - &#123; &#x27;movie&#x27;, &#x27;band&#x27;&#125; WHERE id = &#x27;jsmith&#x27;;</span><br></pre></td></tr></table></figure><h3 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h3><blockquote><p> Sets是唯一值的（已排序）集合。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE users (</span><br><span class="line">    id text PRIMARY KEY,</span><br><span class="line">    name text,</span><br><span class="line">    favs map&lt;text, text&gt; // A map of text keys, and text values</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (id, name, favs)</span><br><span class="line">           VALUES (&#x27;jsmith&#x27;, &#x27;John Smith&#x27;, &#123; &#x27;fruit&#x27; : &#x27;Apple&#x27;, &#x27;band&#x27; : &#x27;Beatles&#x27; &#125;);</span><br><span class="line"></span><br><span class="line">// Replace the existing map entirely.</span><br><span class="line">UPDATE users SET favs = &#123; &#x27;fruit&#x27; : &#x27;Banana&#x27; &#125; WHERE id = &#x27;jsmith&#x27;;</span><br></pre></td></tr></table></figure><p>另外，Sets也具有一些高级特性：</p><ul><li>添加一个或多个元素（因为这是一个集合，插入一个已存在的元素是一个无效操作）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE images SET tags = tags + &#123; &#x27;gray&#x27;, &#x27;cuddly&#x27; &#125; WHERE name = &#x27;cat.jpg&#x27;;</span><br></pre></td></tr></table></figure><ul><li>删除一个或多个元素（如果一个元素不存在，删除它是一个无效操作但不会抛出错误）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE images SET tags = tags - &#123; &#x27;cat&#x27; &#125; WHERE name = &#x27;cat.jpg&#x27;;</span><br></pre></td></tr></table></figure><h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><blockquote><p>Lists是非唯一值的（已排序）集合，其中元素按列表中的位置排序。它与Sets的区别就在于是否是唯一值。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE plays (</span><br><span class="line">    id text PRIMARY KEY,</span><br><span class="line">    game text,</span><br><span class="line">    players int,</span><br><span class="line">    scores list&lt;int&gt; // A list of integers</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT INTO plays (id, game, players, scores)</span><br><span class="line">           VALUES (&#x27;123-afde&#x27;, &#x27;quake&#x27;, 3, [17, 4, 2]);</span><br><span class="line"></span><br><span class="line">// Replace the existing list entirely</span><br><span class="line">UPDATE plays SET scores = [ 3, 9, 4] WHERE id = &#x27;123-afde&#x27;;</span><br></pre></td></tr></table></figure><p>另外，Lists同样也具有一些高级特性：</p><ul><li>在列表头或尾添加元素</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE plays SET players = 5, scores = scores + [ 14, 21 ] WHERE id = &#x27;123-afde&#x27;;</span><br><span class="line">UPDATE plays SET players = 6, scores = [ 3 ] + scores WHERE id = &#x27;123-afde&#x27;;</span><br></pre></td></tr></table></figure><p>💡该操作不是幂等的，特别是在其中一个操作超时时，重试操作是不安全的，可能会导致同一数据插入两次。</p><ul><li>在列表中指定下标处设置值。该列表必须长度大于此下标，否则将抛出列表太小的错误</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE plays SET scores[1] = 7 WHERE id = &#x27;123-afde&#x27;;</span><br></pre></td></tr></table></figure><ul><li>通过列表指定下标删除元素。该列表必须长度大于此下标，否则将抛出列表太小的错误。此外，当操作从列表中删除元素时，列表大小将减1，从而改变此下标之后所有元素的位置</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE scores[1] FROM plays WHERE id = &#x27;123-afde&#x27;;</span><br></pre></td></tr></table></figure><ul><li>删除列表中指定下标之间的所有元素</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE plays SET scores = scores - [ 12, 21 ] WHERE id = &#x27;123-afde&#x27;;</span><br></pre></td></tr></table></figure><p>💡以上2,3,4操作会出现内部的<code> read-before-write</code>，会比通常的更新消耗更多的资源，所以尽量使用<a href="#Sets">Sets</a>代替Lists。</p><h2 id="用户自定义类型（User-Defined-Types）"><a href="#用户自定义类型（User-Defined-Types）" class="headerlink" title="用户自定义类型（User-Defined Types）"></a>用户自定义类型（User-Defined Types）</h2><blockquote><p>CQL支持用户定义类型（以下简称UDT）。可以使用下面<code>create_type_statement</code>，<code>alter_type_statement</code>和<code>drop_type_statement</code>创建，修改和删除此类型。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user_defined_type ::=  udt_name</span><br><span class="line">udt_name          ::=  [ keyspace_name &#x27;.&#x27; ] identifier</span><br></pre></td></tr></table></figure><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create_type_statement ::=  CREATE TYPE [ IF NOT EXISTS ] udt_name</span><br><span class="line">                               &#x27;(&#x27; field_definition ( &#x27;,&#x27; field_definition )* &#x27;)&#x27;</span><br><span class="line">field_definition      ::=  identifier cql_type</span><br></pre></td></tr></table></figure><p>UDT有一个名称（用于声明该类型的列），是一组命名和类型字段。字段名称可以是任何类型，包括集合或其他UDT。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TYPE phone (</span><br><span class="line">    country_code int,</span><br><span class="line">    number text,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CREATE TYPE address (</span><br><span class="line">    street text,</span><br><span class="line">    city text,</span><br><span class="line">    zip text,</span><br><span class="line">    phones map&lt;text, phone&gt;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CREATE TABLE user (</span><br><span class="line">    name text PRIMARY KEY,</span><br><span class="line">    addresses map&lt;text, frozen&lt;address&gt;&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>💡注意</p><ul><li>尝试创建现有类型时请使用<code>IF NOT EXISTS</code>选项，否则将会抛出错误。</li><li>UDT本质上绑定到创建它的键空间，并且只能在该键空间中使用。在创建时，如果类型名称以键空间名称为前缀，则在该键空间中创建它。否则，它将在当前键空间中创建。</li><li>从Cassandra 4.0开始，在大多数情况下必须冻结UDT，因此在上面的表定义中冻结了<code>&lt;address&gt;</code>。有关详细信息，请参阅<a href="https://docs.datastax.com/en/archived/cql/3.1/cql/cql_reference/collection_type_r.html">冻结</a>部分。</li></ul><h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter_type_statement    ::=  ALTER TYPE udt_name alter_type_modification</span><br><span class="line">alter_type_modification ::=  ADD field_definition</span><br><span class="line">                             | RENAME identifier TO identifier ( identifier TO identifier )*</span><br></pre></td></tr></table></figure><p>修改一个UDT，可以：</p><ol><li>在类型中添加一个新字段</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TYPE address ADD country text</span><br></pre></td></tr></table></figure><p>请注意：新添加的字段在之前的记录中，都将被置为NULL。</p><ol start="2"><li>重命名该类型的字段</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TYPE address RENAME zip TO zipcode</span><br></pre></td></tr></table></figure><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop_type_statement ::=  DROP TYPE [ IF EXISTS ] udt_name</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">udt_literal ::=  &#x27;&#123;&#x27; identifier &#x27;:&#x27; term ( &#x27;,&#x27; identifier &#x27;:&#x27; term )* &#x27;&#125;&#x27;</span><br></pre></td></tr></table></figure><p>使用UDT有点像<a href="#Maps">Maps</a>，例如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO user (name, addresses)</span><br><span class="line">          VALUES (&#x27;z3 Pr3z1den7&#x27;, &#123;</span><br><span class="line">              &#x27;home&#x27; : &#123;</span><br><span class="line">                  street: &#x27;1600 Pennsylvania Ave NW&#x27;,</span><br><span class="line">                  city: &#x27;Washington&#x27;,</span><br><span class="line">                  zip: &#x27;20500&#x27;,</span><br><span class="line">                  phones: &#123; &#x27;cell&#x27; : &#123; country_code: 1, number: &#x27;202 456-1111&#x27; &#125;,</span><br><span class="line">                            &#x27;landline&#x27; : &#123; country_code: 1, number: &#x27;...&#x27; &#125; &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#x27;work&#x27; : &#123;</span><br><span class="line">                  street: &#x27;1600 Pennsylvania Ave NW&#x27;,</span><br><span class="line">                  city: &#x27;Washington&#x27;,</span><br><span class="line">                  zip: &#x27;20500&#x27;,</span><br><span class="line">                  phones: &#123; &#x27;fax&#x27; : &#123; country_code: 1, number: &#x27;...&#x27; &#125; &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;)</span><br></pre></td></tr></table></figure><h2 id="元组（Tuples）"><a href="#元组（Tuples）" class="headerlink" title="元组（Tuples）"></a>元组（Tuples）</h2><blockquote><p>CQL还支持元组和元组类型（元素可以是不同类型），类似于匿名的UDT或者是Scala的Tuple类型。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tuple_type    ::=  TUPLE &#x27;&lt;&#x27; cql_type ( &#x27;,&#x27; cql_type )* &#x27;&gt;&#x27;</span><br><span class="line">tuple_literal ::=  &#x27;(&#x27; term ( &#x27;,&#x27; term )* &#x27;)&#x27;</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE durations (</span><br><span class="line">    event text,</span><br><span class="line">    duration tuple&lt;int, text&gt;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT INTO durations (event, duration) VALUES (&#x27;ev1&#x27;, (3, &#x27;hours&#x27;));</span><br></pre></td></tr></table></figure><h2 id="自定义类型（Custom-Types）"><a href="#自定义类型（Custom-Types）" class="headerlink" title="自定义类型（Custom Types）"></a>自定义类型（Custom Types）</h2><blockquote><p>自定义类型主要是为了<strong>兼容老项目，不建议使用</strong>。使用已有的类型加上用户自定义类型（UDT）就够了。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">custom_type ::=  string</span><br></pre></td></tr></table></figure><h1 id="数据增删改查（CRUD）"><a href="#数据增删改查（CRUD）" class="headerlink" title="数据增删改查（CRUD）"></a>数据增删改查（CRUD）</h1><h2 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">select_statement ::=  SELECT [ JSON | DISTINCT ] ( select_clause | &#x27;*&#x27; )</span><br><span class="line">                      FROM table_name</span><br><span class="line">                      [ WHERE where_clause ]</span><br><span class="line">                      [ GROUP BY group_by_clause ]</span><br><span class="line">                      [ ORDER BY ordering_clause ]</span><br><span class="line">                      [ PER PARTITION LIMIT (integer | bind_marker) ]</span><br><span class="line">                      [ LIMIT (integer | bind_marker) ]</span><br><span class="line">                      [ ALLOW FILTERING ]</span><br><span class="line">select_clause    ::=  selector [ AS identifier ] ( &#x27;,&#x27; selector [ AS identifier ] )</span><br><span class="line">selector         ::=  column_name</span><br><span class="line">                      | term</span><br><span class="line">                      | CAST &#x27;(&#x27; selector AS cql_type &#x27;)&#x27;</span><br><span class="line">                      | function_name &#x27;(&#x27; [ selector ( &#x27;,&#x27; selector )* ] &#x27;)&#x27;</span><br><span class="line">                      | COUNT &#x27;(&#x27; &#x27;*&#x27; &#x27;)&#x27;</span><br><span class="line">where_clause     ::=  relation ( AND relation )*</span><br><span class="line">relation         ::=  column_name operator term</span><br><span class="line">                      &#x27;(&#x27; column_name ( &#x27;,&#x27; column_name )* &#x27;)&#x27; operator tuple_literal</span><br><span class="line">                      TOKEN &#x27;(&#x27; column_name ( &#x27;,&#x27; column_name )* &#x27;)&#x27; operator term</span><br><span class="line">operator         ::=  &#x27;=&#x27; | &#x27;&lt;&#x27; | &#x27;&gt;&#x27; | &#x27;&lt;=&#x27; | &#x27;&gt;=&#x27; | &#x27;!=&#x27; | IN | CONTAINS | CONTAINS KEY</span><br><span class="line">group_by_clause  ::=  column_name ( &#x27;,&#x27; column_name )*</span><br><span class="line">ordering_clause  ::=  column_name [ ASC | DESC ] ( &#x27;,&#x27; column_name [ ASC | DESC ] )*</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT name, occupation FROM users WHERE userid IN (199, 200, 207);</span><br><span class="line">SELECT JSON name, occupation FROM users WHERE userid = 199;</span><br><span class="line">SELECT name AS user_name, occupation AS user_occupation FROM users;</span><br><span class="line"></span><br><span class="line">SELECT time, value</span><br><span class="line">FROM events</span><br><span class="line">WHERE event_type = &#x27;myEvent&#x27;</span><br><span class="line">  AND time &gt; &#x27;2011-02-03&#x27;</span><br><span class="line">  AND time &lt;= &#x27;2012-01-01&#x27;</span><br><span class="line"></span><br><span class="line">SELECT COUNT (*) AS user_count FROM users;</span><br></pre></td></tr></table></figure><h3 id="Allowing-filtering"><a href="#Allowing-filtering" class="headerlink" title="Allowing filtering"></a>Allowing filtering</h3><blockquote><p>默认情况下，CQL仅允许不涉及“过滤”服务器端的选择查询，原因是那些“非过滤”查询具有可预测的性能，因为它们的查询性能与Limit成比例。</p></blockquote><p>举个例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE users (</span><br><span class="line">    username text PRIMARY KEY,</span><br><span class="line">    firstname text,</span><br><span class="line">    lastname text,</span><br><span class="line">    birth_year int,</span><br><span class="line">    country text</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CREATE INDEX ON users(birth_year);</span><br></pre></td></tr></table></figure><p>以下两种查询是不需要添加<code>ALLOW FILTERING</code>的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users;</span><br><span class="line">SELECT * FROM users WHERE birth_year = 1981;</span><br></pre></td></tr></table></figure><p>因为在这两种情况下，Cassandra都保证这些查询性能与返回的数据量成正比。</p><p>而下面的这个查询，则需要强制添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE birth_year = 1981 AND country = &#x27;FR&#x27; ALLOW FILTERING;</span><br></pre></td></tr></table></figure><p>👉🏼 关于如何定义可预测的列，可参考<a href="http://cassandra.apache.org/doc/latest/cql/indexes.html">Cassandra中的索引</a></p><h2 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">insert_statement ::=  INSERT INTO table_name ( names_values | json_clause )</span><br><span class="line">                      [ IF NOT EXISTS ]</span><br><span class="line">                      [ USING update_parameter ( AND update_parameter )* ]</span><br><span class="line">names_values     ::=  names VALUES tuple_literal</span><br><span class="line">json_clause      ::=  JSON string [ DEFAULT ( NULL | UNSET ) ]</span><br><span class="line">names            ::=  &#x27;(&#x27; column_name ( &#x27;,&#x27; column_name )* &#x27;)&#x27;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO NerdMovies (movie, director, main_actor, year)</span><br><span class="line">                VALUES (&#x27;Serenity&#x27;, &#x27;Joss Whedon&#x27;, &#x27;Nathan Fillion&#x27;, 2005)</span><br><span class="line">      USING TTL 86400;</span><br><span class="line"></span><br><span class="line">INSERT INTO NerdMovies JSON &#x27;&#123;&quot;movie&quot;: &quot;Serenity&quot;,</span><br><span class="line">                              &quot;director&quot;: &quot;Joss Whedon&quot;,</span><br><span class="line">                              &quot;year&quot;: 2005&#125;&#x27;;</span><br></pre></td></tr></table></figure><p>💡请注意</p><ol><li><p>与SQL不同，INSERT默认情况下不检查行的先前存在：如果之前不存在，则创建行，否则更新。此外，没有办法知道发生了哪些创建或更新。</p></li><li><p>如果要做到存在则不更新，可以使用<code>IF NOT EXISTS</code>条件。但请注意，使用<code>IF NOT EXISTS</code>将导致不可忽略的性能成本（内部使用Paxos），因此应谨慎使用。</p></li><li><p>INSERT的所有更新都以原子方式单独应用。</p></li></ol><h2 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">update_statement ::=  UPDATE table_name</span><br><span class="line">                      [ USING update_parameter ( AND update_parameter )* ]</span><br><span class="line">                      SET assignment ( &#x27;,&#x27; assignment )*</span><br><span class="line">                      WHERE where_clause</span><br><span class="line">                      [ IF ( EXISTS | condition ( AND condition )*) ]</span><br><span class="line">update_parameter ::=  ( TIMESTAMP | TTL ) ( integer | bind_marker )</span><br><span class="line">assignment       ::=  simple_selection &#x27;=&#x27; term</span><br><span class="line">                     | column_name &#x27;=&#x27; column_name ( &#x27;+&#x27; | &#x27;-&#x27; ) term</span><br><span class="line">                     | column_name &#x27;=&#x27; list_literal &#x27;+&#x27; column_name</span><br><span class="line">simple_selection ::=  column_name</span><br><span class="line">                     | column_name &#x27;[&#x27; term &#x27;]&#x27;</span><br><span class="line">                     | column_name &#x27;.&#x27; `field_name</span><br><span class="line">condition        ::=  simple_selection operator term</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">UPDATE NerdMovies USING TTL 400</span><br><span class="line">   SET director   = &#x27;Joss Whedon&#x27;,</span><br><span class="line">       main_actor = &#x27;Nathan Fillion&#x27;,</span><br><span class="line">       year       = 2005</span><br><span class="line"> WHERE movie = &#x27;Serenity&#x27;;</span><br><span class="line"></span><br><span class="line">UPDATE UserActions</span><br><span class="line">   SET total = total + 2</span><br><span class="line">   WHERE user = B70DE1D0-9908-4AE3-BE34-5573E5B09F14</span><br><span class="line">     AND action = &#x27;click&#x27;;</span><br></pre></td></tr></table></figure><p>💡请注意</p><ol><li><p>与SQL不同，UPDATE默认情况下不检查行的先前存在（除非通过IF）：如果之前不存在，则创建行，否则更新。此外，没有办法知道是否发生了创建或更新。</p></li><li><p>可以通过IF在某些列上使用条件，在这种情况下，除非满足条件，否则不会更新行。但请注意，使用IF条件会产生不可忽视的性能成本（内部使用Paxos），因此应谨慎使用。</p></li><li><p>在UPDATE语句中，同一分区键中的所有更新都以原子方式单独应用。</p></li></ol><p>此外，UPDATE操作针对某些数据类型有强制性要求：</p><ol><li><code>c = c + 3</code></li></ol><p>用于递增/递减计数器。 </p><p>‘=’符号后面的列名称必须与’=’符号前面的列名相同。请注意，<strong>仅在计数器上允许递增/递减，并且是计数器上允许的唯一更新操作</strong>。</p><ol start="2"><li><code>id = id + &lt;some-collection&gt;</code> 和<code>id[value1] = value2</code></li></ol><p>用于集合。</p><ol start="3"><li><code>id.field = 3</code></li></ol><p>在非冻结的用户定义类型上设置字段的值。</p><h2 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">delete_statement ::=  DELETE [ simple_selection ( &#x27;,&#x27; simple_selection ) ]</span><br><span class="line">                      FROM table_name</span><br><span class="line">                      [ USING update_parameter ( AND update_parameter )* ]</span><br><span class="line">                      WHERE where_clause</span><br><span class="line">                      [ IF ( EXISTS | condition ( AND condition )*) ]</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM NerdMovies USING TIMESTAMP 1240003134</span><br><span class="line"> WHERE movie = &#x27;Serenity&#x27;;</span><br><span class="line"></span><br><span class="line">DELETE phone FROM Users</span><br><span class="line"> WHERE userid IN (C73DE1D3-AF08-40F3-B124-3FF3E5109F22, B70DE1D0-9908-4AE3-BE34-5573E5B09F14);</span><br></pre></td></tr></table></figure><p>💡请注意</p><ol><li><p>WHERE子句指定要删除的行。使用IN运算符可以使用一个语句删除多行。可以使用不等运算符（例如&gt;=）删除一系列行。</p></li><li><p>在DELETE语句中，同一分区键中的所有删除都以原子方式单独应用。</p></li><li><p>DELETE操作可以通过使用IF子句来条件化，类似于UPDATE和INSERT语句。但是，与INSERT和UPDATE语句一样，这将导致不可忽略的性能成本（内部，将使用Paxos），因此应谨慎使用。</p></li></ol><h2 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h2><blockquote><p>批处理只允许包含UPDATE，INSERT和DELETE语句。</p><p>批处理节省客户端和服务器之间的网络资源消耗。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">batch_statement        ::=  BEGIN [ UNLOGGED | COUNTER ] BATCH</span><br><span class="line">                            [ USING update_parameter ( AND update_parameter )* ]</span><br><span class="line">                            modification_statement ( &#x27;;&#x27; modification_statement )*</span><br><span class="line">                            APPLY BATCH</span><br><span class="line">modification_statement ::=  insert_statement | update_statement | delete_statement</span><br></pre></td></tr></table></figure><p>示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BEGIN BATCH</span><br><span class="line">   INSERT INTO users (userid, password, name) VALUES (&#x27;user2&#x27;, &#x27;ch@ngem3b&#x27;, &#x27;second user&#x27;);</span><br><span class="line">   UPDATE users SET password = &#x27;ps22dhds&#x27; WHERE userid = &#x27;user3&#x27;;</span><br><span class="line">   INSERT INTO users (userid, password) VALUES (&#x27;user4&#x27;, &#x27;ch@ngem3c&#x27;);</span><br><span class="line">   DELETE name FROM users WHERE userid = &#x27;user1&#x27;;</span><br><span class="line">APPLY BATCH;</span><br></pre></td></tr></table></figure><p>💡请注意</p><ol><li>属于给定分区键的BATCH中的所有更新都是单独执行的。</li><li>默认情况下，批处理中的所有操作都按记录执行，以确保所有变更都最终完成（或不执行任何操作）。类似于SQL事务，但不完全等同于SQL事务。</li></ol><h3 id="UNLOGGED-batches"><a href="#UNLOGGED-batches" class="headerlink" title="UNLOGGED batches"></a>UNLOGGED batches</h3><p>默认情况下，Cassandra使用批处理日志来确保所有变更都最终完成（或不执行任何操作）【请注意，操作仅在单个分区中隔离】。</p><p>批处理跨越多个分区时，批处理在性能上会有所损失。可以使用UNLOGGED选项来跳过批处理日志，不过，如果批处理失败，可能会造成批处理中的任务部分成功部分失败，请谨慎选择。</p><h3 id="COUNTER-batches"><a href="#COUNTER-batches" class="headerlink" title="COUNTER batches"></a>COUNTER batches</h3><p>使用COUNTER选项进行批量计数器更新。</p><p>与Cassandra中的其他更新不同，计数器更新不是幂等的。</p><h1 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h1><p><a href="http://cassandra.apache.org/doc/latest/">Apache Cassandra Documentation</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h1&gt;&lt;p&gt;按照&lt;a href=&quot;https://gcdd1993.github.io/%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0%EF%BC%88%E9%83%A8%E7%BD%B2%E7%AF%87%EF%BC%89/#more&quot;&gt;Cassandra集群部署&lt;/a&gt;搭建两台测试机，环境信息如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;名称&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;数据中心名称&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;node-01&lt;/td&gt;
&lt;td&gt;192.168.198.130&lt;/td&gt;
&lt;td&gt;datacenter1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;node-02&lt;/td&gt;
&lt;td&gt;192.168.198.131&lt;/td&gt;
&lt;td&gt;datacenter1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Cassandra" scheme="https://blog.gcdd.top/tags/Cassandra/"/>
    
  </entry>
  
  <entry>
    <title>记一次Postgres CPU爆满故障</title>
    <link href="https://blog.gcdd.top/p/7877/"/>
    <id>https://blog.gcdd.top/p/7877/</id>
    <published>2019-05-10T05:19:22.000Z</published>
    <updated>2023-08-30T04:52:53.913Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>公司项目测试环境调用某些接口的时候，服务器立即崩溃，并一定时间内无法提供服务。<span id="more"></span></p><h1 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h1><h2 id="服务器配置不够"><a href="#服务器配置不够" class="headerlink" title="服务器配置不够"></a>服务器配置不够</h2><p>第一反应是服务器需要升配啦，花钱解决一切！毕竟测试服务器配置确实不高，2CPU + 4Gib，能干啥？不过问题是今天突然发生的，而且说崩就崩。凭着严谨的态度，还是要刨根问底地找下问题。</p><h2 id="查看服务器负载"><a href="#查看服务器负载" class="headerlink" title="查看服务器负载"></a>查看服务器负载</h2><ul><li><code>free -m</code></li></ul><p>内存占用并不大，忘记截图了，反正看下来不是内存过高导致的崩溃</p><ul><li><code>top</code></li></ul><p><img src="https://i.loli.net/2019/05/10/5cd50e714a69f.png"></p><h2 id="数据库占用CPU过高"><a href="#数据库占用CPU过高" class="headerlink" title="数据库占用CPU过高"></a>数据库占用CPU过高</h2><h3 id="连接数过多"><a href="#连接数过多" class="headerlink" title="连接数过多"></a>连接数过多</h3><blockquote><p>业务高峰活跃连接陡增，活跃的连接数是否比平时多很多</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">  COUNT(*) </span><br><span class="line">FROM </span><br><span class="line">  pg_stat_activity </span><br><span class="line">WHERE </span><br><span class="line">  STATE NOT LIKE &#x27;%idle&#x27;;</span><br></pre></td></tr></table></figure><p>查询下来只有3个连接，所以不是连接数导致的CPU过高</p><h3 id="慢SQL"><a href="#慢SQL" class="headerlink" title="慢SQL"></a>慢SQL</h3><blockquote><p>如果活跃连接数的变化处于正常范围，则可能是当时有性能很差的SQL被大量执行。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">  datname, </span><br><span class="line">  usename, </span><br><span class="line">  client_addr, </span><br><span class="line">  application_name, </span><br><span class="line">  state, </span><br><span class="line">  backend_start, </span><br><span class="line">  xact_start, </span><br><span class="line">  xact_stay, </span><br><span class="line">  query_start, </span><br><span class="line">  query_stay, </span><br><span class="line">  replace(</span><br><span class="line">    query, </span><br><span class="line">    chr(10), </span><br><span class="line">    &#x27; &#x27;</span><br><span class="line">  ) as query </span><br><span class="line">from </span><br><span class="line">  (</span><br><span class="line">    select </span><br><span class="line">      pgsa.datname as datname, </span><br><span class="line">      pgsa.usename as usename, </span><br><span class="line">      pgsa.client_addr client_addr, </span><br><span class="line">      pgsa.application_name as application_name, </span><br><span class="line">      pgsa.state as state, </span><br><span class="line">      pgsa.backend_start as backend_start, </span><br><span class="line">      pgsa.xact_start as xact_start, </span><br><span class="line">      extract(</span><br><span class="line">        epoch </span><br><span class="line">        from </span><br><span class="line">          (now() - pgsa.xact_start)</span><br><span class="line">      ) as xact_stay, </span><br><span class="line">      pgsa.query_start as query_start, </span><br><span class="line">      extract(</span><br><span class="line">        epoch </span><br><span class="line">        from </span><br><span class="line">          (now() - pgsa.query_start)</span><br><span class="line">      ) as query_stay, </span><br><span class="line">      pgsa.query as query </span><br><span class="line">    from </span><br><span class="line">      pg_stat_activity as pgsa </span><br><span class="line">    where </span><br><span class="line">      pgsa.state != &#x27;idle&#x27; </span><br><span class="line">      and pgsa.state != &#x27;idle in transaction&#x27; </span><br><span class="line">      and pgsa.state != &#x27;idle in transaction (aborted)&#x27;</span><br><span class="line">  ) idleconnections </span><br><span class="line">order by </span><br><span class="line">  query_stay desc </span><br><span class="line">limit </span><br><span class="line">  5;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/05/10/5cd513b65c46f.png"></p><p>可以看到，确实有一条慢SQL，而且属于奇慢无比，执行了接近1分钟还没执行完毕，基本可以定位，是慢SQL导致的CPU占用陡增。</p><h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><p>对于上面的方法查出来的慢SQL，首先需要做的是Kill掉他们，使业务先恢复。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select pg_cancel_backend(pid) from pg_stat_activity where  query like &#x27;%&lt;query text&gt;%&#x27; and pid != pg_backend_pid();</span><br><span class="line">select pg_terminate_backend(pid) from pg_stat_activity where  query like &#x27;%&lt;query text&gt;%&#x27; and pid != pg_backend_pid();</span><br></pre></td></tr></table></figure><p>如果这些SQL确实是业务上必需的，则需要对他们做如下优化：</p><ol><li>对查询涉及的表，执行<code>ANALYZE &lt;table&gt;</code>或<code>VACUUM ANZLYZE &lt;table&gt;</code>，更新表的统计信息，使查询计划更准确。为避免对业务影响，最好在业务低峰执行。</li><li>执行<code>explain &lt;query text&gt;</code>或<code>explain (buffers true, analyze true, verbose true) &lt;query text&gt;</code>命令，查看SQL的执行计划（前者不会实际执行SQL，后者会实际执行而且能得到详细的执行信息），对其中的Table Scan涉及的表，建立索引。</li><li>重新编写SQL，去除掉不必要的子查询、改写UNION ALL、使用JOIN CLAUSE固定连接顺序等，都是进一步深度优化SQL的手段，这里不再深入说明。</li></ol><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在查询语句中，尽量减少不必要的子查询，公司使用的ORM框架是Spring JPA，针对一些特别慢的HQL，可以采用直接执行SQL的方式来优化查询效率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;select count(*) from example_table where example_id = :exampleId&quot;, nativeQuery = true)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">exampleNativeQuery</span><span class="params">(<span class="meta">@Param(&quot;exampleId&quot;)</span> Long exampleId)</span>;</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://help.aliyun.com/knowledge_detail/43562.html">PostgreSQL/PPAS CPU使用率高的原因及解决办法</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;公司项目测试环境调用某些接口的时候，服务器立即崩溃，并一定时间内无法提供服务。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="数据库" scheme="https://blog.gcdd.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>记一次生产事故--磁盘被占满</title>
    <link href="https://blog.gcdd.top/p/58700/"/>
    <id>https://blog.gcdd.top/p/58700/</id>
    <published>2019-04-18T14:08:20.000Z</published>
    <updated>2023-08-30T04:52:53.913Z</updated>
    
    <content type="html"><![CDATA[<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>今天，跑在阿里云ECS上的生产环境，突然间访问异常，接口各种报错，无奈公司没有专业的运维人员，只能硬着头皮解决一下。<span id="more"></span></p><h1 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h1><p>先从表面看起，数据库首先报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.postgresql.util.PSQLException: ERROR: could not extend file &quot;base/16385/16587_fsm&quot;: No space left on device</span><br><span class="line">  建议：Check free disk space.</span><br></pre></td></tr></table></figure><p>直观上看，设备没有可用空间，也就是磁盘满了。</p><p>进入服务器后台，执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">udev                  7.9G     0  7.9G   0% /dev</span><br><span class="line">tmpfs                 1.6G  3.5M  1.6G   1% /run</span><br><span class="line">/dev/vda1              59G   56G     0 100% /</span><br><span class="line">tmpfs                 7.9G  4.0K  7.9G   1% /dev/shm</span><br><span class="line">tmpfs                 5.0M  4.0K  5.0M   1% /run/lock</span><br><span class="line">tmpfs                 7.9G     0  7.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/vg0-vol0 1000G   14G  937G   2% /data</span><br><span class="line">tmpfs                 1.6G     0  1.6G   0% /run/user/0</span><br></pre></td></tr></table></figure><p>发现确实磁盘满了，而且满的很彻底。系统盘占用100%，估计什么服务都跑不动了。<code>/dev/vda1              59G   56G     0 100% /</code></p><p>不过发现<code>/dev/mapper/vg0-vol0 1000G   14G  937G   2% /data</code>，1000G只用了2%</p><blockquote><p>阿里云ECS分为系统盘和数据盘，1000G的是数据盘</p></blockquote><p>第一反应，应该是搭建的PG数据库的数据没有移到数据盘上。</p><h2 id="将Postgres数据库数据目录移动到系统盘"><a href="#将Postgres数据库数据目录移动到系统盘" class="headerlink" title="将Postgres数据库数据目录移动到系统盘"></a>将Postgres数据库数据目录移动到系统盘</h2><blockquote><p>参考<a href="https://www.digitalocean.com/community/tutorials/how-to-move-a-postgresql-data-directory-to-a-new-location-on-ubuntu-16-04">如何将PostgreSQL数据目录移动到Ubuntu 16.04上的新位置</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line">postgres<span class="comment"># SHOW data_directory; # 查看当前数据目录</span></span><br><span class="line">        data_directory        </span><br><span class="line">------------------------------</span><br><span class="line"> /var/lib/postgresql/9.5/main</span><br><span class="line">(1 row)</span><br><span class="line">postgres<span class="comment"># \q; # 退出</span></span><br><span class="line"><span class="comment"># 为了确保数据的完整性，我们将在实际更改数据目录之前关闭PostgreSQL</span></span><br><span class="line">$ sudo systemctl stop postgresql</span><br><span class="line"><span class="comment"># 确保关闭完成</span></span><br><span class="line">$ sudo systemctl status postgresql</span><br><span class="line">. . .</span><br><span class="line">Jul 22 16:22:44 ubuntu-512mb-nyc1-01 systemd[1]: Stopped PostgreSQL RDBMS.</span><br><span class="line">$ sudo rsync -av /var/lib/postgresql /data <span class="comment"># /data为要迁移到的新目录</span></span><br><span class="line">$ <span class="built_in">cd</span> /data</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">... postgresql</span><br><span class="line"><span class="comment"># 删除原数据目录</span></span><br><span class="line">$ sudo <span class="built_in">rm</span> -rf /var/lib/postgresql</span><br><span class="line"><span class="comment"># 将新数据目录链接到原数据目录</span></span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /data/postgresql /var/lib/postgresql</span><br><span class="line"><span class="comment"># 重启Postgres数据库</span></span><br><span class="line">$ sudo systemctl start postgresql</span><br><span class="line">$ sudo systemctl status postgresql</span><br></pre></td></tr></table></figure><p>完成以上步骤，即将postgre数据库数据目录移到了阿里云数据盘</p><p>以为OK了，执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">udev                  7.9G     0  7.9G   0% /dev</span><br><span class="line">tmpfs                 1.6G  3.5M  1.6G   1% /run</span><br><span class="line">/dev/vda1              59G   56G   51M 100% /</span><br><span class="line">tmpfs                 7.9G  4.0K  7.9G   1% /dev/shm</span><br><span class="line">tmpfs                 5.0M  4.0K  5.0M   1% /run/lock</span><br><span class="line">tmpfs                 7.9G     0  7.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/vg0-vol0 1000G   14G  937G   2% /data</span><br><span class="line">tmpfs                 1.6G     0  1.6G   0% /run/user/0</span><br></pre></td></tr></table></figure><p>纹丝未动。。。</p><h2 id="Ubuntu查询大文件"><a href="#Ubuntu查询大文件" class="headerlink" title="Ubuntu查询大文件"></a>Ubuntu查询大文件</h2><p>猜测是存在大文件导致磁盘被占满</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /</span><br><span class="line">$ find . -<span class="built_in">type</span> f -size +800M  -print0 | xargs -0 <span class="built_in">du</span> -h</span><br><span class="line">5.6G ./var/log/syslog.1</span><br><span class="line">6.7G ./var/log/syslog</span><br><span class="line">...</span><br><span class="line">$ <span class="built_in">rm</span> ...</span><br></pre></td></tr></table></figure><p>如果发现是log字眼的大文件，我们可以毫不留情的删掉，要是遇见一些不认识的，不要贸然删掉，一定要查清楚文件的作用，能删则删，千万不要不小心删库跑路。。。</p><p>删除完毕后，再次查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">udev                  7.9G     0  7.9G   0% /dev</span><br><span class="line">tmpfs                 1.6G  3.4M  1.6G   1% /run</span><br><span class="line">/dev/vda1              59G   45G   12G  80% /</span><br><span class="line">tmpfs                 7.9G  4.0K  7.9G   1% /dev/shm</span><br><span class="line">tmpfs                 5.0M  4.0K  5.0M   1% /run/lock</span><br><span class="line">tmpfs                 7.9G     0  7.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/vg0-vol0 1000G   14G  936G   2% /data</span><br><span class="line">tmpfs                 1.6G     0  1.6G   0% /run/user/0</span><br></pre></td></tr></table></figure><p>多出了12G。</p><h2 id="查看已删除空间却没有释放的进程"><a href="#查看已删除空间却没有释放的进程" class="headerlink" title="查看已删除空间却没有释放的进程"></a>查看已删除空间却没有释放的进程</h2><p>这时候，服务应该可以恢复成功。但你马上会发现，磁盘又被占满，而这次，日志文件却不算大。</p><p>查看已经删除的文件，空间有没有释放，没有的话kill掉pid</p><blockquote><p>使用rm删除文件的时候，虽然文件已经被删除，但是由于文件被其他进程占用，空间却没有释放</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo lsof -n |grep deleted</span><br><span class="line">java      17866                  root  237r      REG              253,1    163541    1709285 /tmp/tomcat.8250394289784312179.8080/work/Tomcat/localhost/ROOT/upload_c6db0c17_6e6a_4141_bfb6_ac1b2d8a3b0b_00000000.tmp (deleted)</span><br><span class="line">...</span><br><span class="line">$ sudo <span class="built_in">kill</span> -9 17866</span><br></pre></td></tr></table></figure><p>再次使用<code>df -h</code>命令，磁盘使用率一下子减少了好多。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul><li><p>服务器系统盘被占满是非常可怕的！届时，一切服务都将变得不可用，业务系统也会莫名其妙多出奇怪的问题。所以，运维需要经常性的查看服务器磁盘占用情况，阿里云ECS用户，可以开启报警，及时发现问题，解决问题！</p></li><li><p>阿里云ECS提供了系统盘和数据盘，记住，例如Pg、Redis、Cassandra等容易占磁盘的服务，一定要将数据目录放在阿里云ECS提供的数据盘上。</p></li><li><p><code>/var/log</code>是系统日志目录，可以经常性的关注下，大容量日志尽早删除。</p></li><li><p>对待进程不停对文件写日志的操作，要释放文件占用的磁盘空间，最好的方法是在线清空这个文件，可以通过如下命令完成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># echo &quot;&quot; &gt;/var/log/syslog</span></span><br></pre></td></tr></table></figure></li></ul><blockquote><p> 通过这种方法，磁盘空间不但可以马上释放，也可保障进程继续向文件写入日志，这种方法经常用于在线清理Apache、Tomcat、Nginx等Web服务产生的日志文件。</p></blockquote><p><strong>最后，有一个专业的运维是多么重要！</strong></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;写在前面&quot;&gt;&lt;a href=&quot;#写在前面&quot; class=&quot;headerlink&quot; title=&quot;写在前面&quot;&gt;&lt;/a&gt;写在前面&lt;/h1&gt;&lt;p&gt;今天，跑在阿里云ECS上的生产环境，突然间访问异常，接口各种报错，无奈公司没有专业的运维人员，只能硬着头皮解决一下。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="运维" scheme="https://blog.gcdd.top/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>运维笔记（部署篇）</title>
    <link href="https://blog.gcdd.top/p/8505/"/>
    <id>https://blog.gcdd.top/p/8505/</id>
    <published>2019-04-16T07:43:58.000Z</published>
    <updated>2023-08-30T04:52:53.913Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>针对<code>Ubuntu 16.04</code>，汇总常用服务的搭建指南。</p><span id="more"></span><h1 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h1><blockquote><p>新买的ECS需要执行系统初始化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt dist-upgrade</span><br><span class="line">$ sudo apt autoremove</span><br><span class="line">$ sudo apt clean</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /etc/hosts <span class="comment"># 修改hosts，一般将本机需要使用的外部内网服务设置映射为名称</span></span><br><span class="line">172.16.0.192    kftest-config01</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /etc/hostname <span class="comment"># 修改hostname，便于辨认</span></span><br><span class="line">pg_1</span><br><span class="line"></span><br><span class="line">$ reboot <span class="comment"># 修改hostname需要重启生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载数据盘，例如阿里云数据盘 https://help.aliyun.com/document_detail/25446.html</span></span><br><span class="line">$ sudo fdisk -l <span class="comment"># 查看实例上的数据盘</span></span><br><span class="line">Disk /dev/vdb: 1000 GiB, 1073741824000 bytes, 2097152000 sectors</span><br><span class="line">$ sudo fdisk -u /dev/vdb</span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">... 一路enter</span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line"><span class="comment">## 更多参考 https://help.aliyun.com/document_detail/108501.html</span></span><br><span class="line">$ sudo fdisk -lu /dev/vdb</span><br><span class="line">Device     Boot Start        End    Sectors  Size Id Type</span><br><span class="line">/dev/vdb1        2048 2097151999 2097149952 1000G 83 Linux</span><br><span class="line">$ sudo mkfs.ext4 /dev/vdb1 <span class="comment"># 在新分区上创建一个文件系统</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cp</span> /etc/fstab /etc/fstab.bak <span class="comment"># 备份 etc/fstab</span></span><br><span class="line">$ <span class="built_in">echo</span> /dev/vdb1 /data ext4 defaults 0 0 &gt;&gt; /etc/fstab <span class="comment"># 向 /etc/fstab 写入新分区信息</span></span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">mkdir</span> /data</span><br><span class="line">$ sudo mount /dev/vdb1 /data <span class="comment"># 挂载文件系统</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line">/dev/vdb1       985G   72M  935G   1% /data</span><br></pre></td></tr></table></figure><h1 id="Postgresql"><a href="#Postgresql" class="headerlink" title="Postgresql"></a>Postgresql</h1><h2 id="安装Postgresql"><a href="#安装Postgresql" class="headerlink" title="安装Postgresql"></a>安装Postgresql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install ca-certificates</span><br><span class="line">$ RELEASE=$(lsb_release -cs)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deb https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ <span class="variable">$&#123;RELEASE&#125;</span>&quot;</span>-pgdg main | sudo <span class="built_in">tee</span>  /etc/apt/sources.list.d/pgdg.list</span><br><span class="line">$ wget --quiet -O - https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ACCC4CF8.asc | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install postgresql-9.6 <span class="comment"># 自行选择合适版本</span></span><br><span class="line"><span class="comment">## 更多参考 https://www.postgresql.org/download/linux/ubuntu/</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/postgresql/9.6/main/postgresql.conf</span><br><span class="line">listen_addresses = <span class="string">&#x27;*&#x27;</span></span><br><span class="line">max_connections = 1000</span><br><span class="line">logging_collector = on</span><br><span class="line">data_directory = <span class="string">&#x27;/data/postgresql&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 更多参考 https://www.postgresql.org/docs/current/static/runtime-config.html</span></span><br><span class="line"> </span><br><span class="line">$ sudo vim /etc/postgresql/9.6/main/pg_hba.conf</span><br><span class="line">host    all             all             0.0.0.0/0             md5</span><br><span class="line"><span class="comment">## 更多参考 https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html</span></span><br><span class="line">   </span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></table></figure><h2 id="修改数据目录"><a href="#修改数据目录" class="headerlink" title="修改数据目录"></a>修改数据目录</h2><p>参考：<a href="https://www.cnblogs.com/easonjim/p/9052836.html">https://www.cnblogs.com/easonjim/p/9052836.html</a></p><h2 id="修改默认用户Postgres的密码"><a href="#修改默认用户Postgres的密码" class="headerlink" title="修改默认用户Postgres的密码"></a>修改默认用户Postgres的密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql</span><br><span class="line"><span class="comment"># ALTER USER postgres WITH PASSWORD &#x27;postgres&#x27;;</span></span><br><span class="line"><span class="comment"># \q</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="搭建集群（可选）"><a href="#搭建集群（可选）" class="headerlink" title="搭建集群（可选）"></a>搭建集群（可选）</h2><table><thead><tr><th align="center">主机</th><th align="center">ip</th></tr></thead><tbody><tr><td align="center">Master节点</td><td align="center">10.10.10.10</td></tr><tr><td align="center">Slave节点</td><td align="center">10.10.10.9</td></tr></tbody></table><p>Master节点和Slave节点分别按照上述步骤安装完成<code>postgres</code>后，开始搭建集群。</p><h3 id="master节点："><a href="#master节点：" class="headerlink" title="master节点："></a>master节点：</h3><ol><li>修改配置</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/postgresql/9.6/main/postgresql.conf</span><br><span class="line">listen_addresses = &#x27;*&#x27;</span><br><span class="line">wal_level = hot_standby</span><br><span class="line">archive_mode = on</span><br><span class="line">archive_command = &#x27;test ! -f /var/lib/postgresql/9.6/archive/%f &amp;&amp; cp %p /var/lib/postgresql/9.6/archive/%f&#x27;</span><br><span class="line">max_wal_senders = 16</span><br><span class="line">wal_keep_segments = 100</span><br><span class="line">hot_standby = on</span><br><span class="line">logging_collector = on</span><br><span class="line">## 更多参考 https://www.postgresql.org/docs/current/static/runtime-config.html</span><br><span class="line"></span><br><span class="line">$ sudo vi /etc/postgresql/9.6/main/pg_hba.conf</span><br><span class="line">host    all             all             10.0.0.0/8              md5</span><br><span class="line">host    replication     repuser         10.0.0.0/8              md5</span><br><span class="line">## 更多参考 https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html</span><br><span class="line">  </span><br><span class="line">$ sudo -upostgres mkdir /var/lib/postgresql/9.6/archive</span><br><span class="line">$ sudo chmod 0700 /var/lib/postgresql/9.6/archive</span><br><span class="line">  </span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></table></figure><ol start="2"><li>创建工作账户 repuser</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -upostgres createuser --replication repuser</span><br><span class="line">$ sudo -upostgres psql</span><br><span class="line">postgres=<span class="comment"># \password repuser</span></span><br><span class="line">&lt;password&gt;</span><br><span class="line"><span class="comment">## 更多参考 https://www.postgresql.org/docs/current/static/user-manag.html</span></span><br></pre></td></tr></table></figure><h3 id="slave节点："><a href="#slave节点：" class="headerlink" title="slave节点："></a>slave节点：</h3><ol><li>先停止服务</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql stop</span><br></pre></td></tr></table></figure><ol start="2"><li>由master节点导入数据（postgres 免密码登录 repuser role）</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -upostgres vi /var/lib/postgresql/.pgpass</span><br><span class="line">10.10.10.10:5432:*:repuser:&lt;password&gt;</span><br><span class="line">127.0.0.1:5432:*:repuser:&lt;password&gt;</span><br><span class="line"> </span><br><span class="line">$ sudo <span class="built_in">chmod</span> 0600 /var/lib/postgresql/.pgpass</span><br><span class="line">$ sudo <span class="built_in">mv</span> /var/lib/postgresql/9.6/main /var/lib/postgresql/9.6/main.bak</span><br><span class="line">$ sudo -upostgres pg_basebackup -D /var/lib/postgresql/9.6/main -F p -X stream -v -R -h 10.10.10.10 -p 5432 -U repuser</span><br></pre></td></tr></table></figure><ol start="3"><li>修改配置</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /var/lib/postgresql/9.6/main/recovery.conf</span><br><span class="line">standby_mode = <span class="string">&#x27;on&#x27;</span></span><br><span class="line">primary_conninfo = <span class="string">&#x27;user=repuser host=10.10.10.10 port=5432&#x27;</span></span><br><span class="line">trigger_file = <span class="string">&#x27;failover.now&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 更多参考 https://www.postgresql.org/docs/current/static/recovery-config.html</span></span><br><span class="line">  </span><br><span class="line">$ sudo vi /etc/postgresql/9.6/main/postgresql.conf</span><br><span class="line">hot_standby = on</span><br></pre></td></tr></table></figure><ol start="4"><li>重启并检查服务</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql start</span><br><span class="line">  </span><br><span class="line">$ sudo service postgresql status</span><br><span class="line">...</span><br><span class="line">Active: active (exited)</span><br><span class="line"></span><br><span class="line">$ sudo -upostgres psql</span><br><span class="line">psql (9.6.12)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h3><p>在master节点进行增删改操作，对照看slave节点是否能够从master节点复制操作</p><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service postgresql start</span><br><span class="line">$ sudo service postgresql status</span><br><span class="line">$ sudo service postgresql restart</span><br></pre></td></tr></table></figure><p>👉 <a href="https://gcdd1993.github.io/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/PG%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">PG数据库常用命令</a></p><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="安装Redis（单机）"><a href="#安装Redis（单机）" class="headerlink" title="安装Redis（单机）"></a>安装Redis（单机）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install redis-server</span><br><span class="line">$ sudo vim /etc/redis/redis.conf</span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br><span class="line"><span class="comment"># protected-mode yes</span></span><br><span class="line">protected-mode no</span><br><span class="line">$ sudo systemctl restart redis-server</span><br></pre></td></tr></table></figure><h2 id="安装Redis（集群）"><a href="#安装Redis（集群）" class="headerlink" title="安装Redis（集群）"></a>安装Redis（集群）</h2><table><thead><tr><th align="center">主机</th><th align="center">ip</th><th align="center">redis-server</th><th align="center">sentinel</th></tr></thead><tbody><tr><td align="center">node01</td><td align="center">10.10.10.5</td><td align="center">主</td><td align="center">√</td></tr><tr><td align="center">node02</td><td align="center">10.10.10.4</td><td align="center">从</td><td align="center">√</td></tr><tr><td align="center">node03</td><td align="center">10.10.10.6</td><td align="center">从</td><td align="center">√</td></tr></tbody></table><h3 id="安装-Redis-Server"><a href="#安装-Redis-Server" class="headerlink" title="安装 Redis-Server"></a>安装 Redis-Server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">node01:</span><br><span class="line">$ sudo apt-get install redis-server</span><br><span class="line">$ sudo vi /etc/redis/redis.conf</span><br><span class="line"><span class="built_in">bind</span>: 10.10.10.5</span><br><span class="line"></span><br><span class="line">$ sudo service redis-server restart</span><br><span class="line"></span><br><span class="line">node02:</span><br><span class="line">$ sudo apt-get install redis-server</span><br><span class="line">$ sudo vi /etc/redis/redis.conf</span><br><span class="line"><span class="built_in">bind</span>: 10.10.10.4</span><br><span class="line">slaveof 10.10.10.5</span><br><span class="line"> </span><br><span class="line">$ sudo service redis-server restart</span><br><span class="line"></span><br><span class="line">node03 同node02</span><br></pre></td></tr></table></figure><h3 id="测试主从同步"><a href="#测试主从同步" class="headerlink" title="测试主从同步"></a>测试主从同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">node01:</span><br><span class="line">$ redis-cli -h 10.10.10.5 -p 6379</span><br><span class="line">10.10.10.5:6379&gt;info</span><br><span class="line">....</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=10.10.10.4,port=6379,state=online,offset=99,lag=0</span><br><span class="line">slave1:ip=10.10.10.6,port=6379,state=online,offset=99,lag=1</span><br><span class="line">master_repl_offset:99</span><br><span class="line">....</span><br><span class="line">10.10.10.5:6379&gt;<span class="built_in">set</span> testkey testvalue</span><br><span class="line">OK</span><br><span class="line">10.10.10.5:6379&gt;get testkey</span><br><span class="line"><span class="string">&quot;testvalue&quot;</span></span><br><span class="line">  </span><br><span class="line">node02:</span><br><span class="line">$ redis-cli -h 10.10.10.4 -p 6379</span><br><span class="line">10.9.8.203:6379&gt;info</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:10.10.10.5</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">...</span><br><span class="line">10.10.10.4:6379&gt;get testkey</span><br><span class="line"><span class="string">&quot;testvalue&quot;</span></span><br></pre></td></tr></table></figure><h3 id="配置-Sentinel（可选）"><a href="#配置-Sentinel（可选）" class="headerlink" title="配置 Sentinel（可选）"></a>配置 Sentinel（可选）</h3><blockquote><p>一个稳健的 <code>Redis Sentinel</code> 集群，应该使用至少 <strong>三个</strong> <code>Sentinel</code> 实例，并且保证将这些实例放到 <strong>不同的机器</strong> 上，甚至不同的 <strong>物理区域</strong>。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ sudo wget http://download.redis.io/redis-stable/sentinel.conf -O /etc/redis/sentinel.conf</span><br><span class="line">$ sudo <span class="built_in">chown</span> redis:redis /etc/redis/sentinel.conf</span><br><span class="line">$ sudo vi /etc/redis/sentinel.conf</span><br><span class="line">sentinel monitor mymaster 10.10.10.5 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"><span class="comment">## 自启动配置</span></span><br><span class="line">$ sudo vi /etc/redis/sentinel.service</span><br><span class="line">[Unit]</span><br><span class="line">Documentation=http://redis.io/topics/sentinel</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/redis-server /etc/redis/sentinel.conf --sentinel</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">  </span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /etc/redis/sentinel.service /lib/systemd/system/sentinel.service</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> sentinel.service</span><br><span class="line">$ sudo service sentinel start</span><br><span class="line"></span><br><span class="line">node02 node03 sentinel 配置同node01，所有节点配置完成，再继续下一步</span><br></pre></td></tr></table></figure><blockquote><p>配置好<code>sentinel</code>之后，<code>redis.conf</code>和<code>sentinel.conf</code>都由<code>sentinel</code>接管；<code>sentinel</code>监控主节点发生改变的话，会更改对应的配置文件<code>sentinel.conf</code>和<code>redis.conf</code>。</p></blockquote><h3 id="测试Sentinel监控、通知、自动故障转移"><a href="#测试Sentinel监控、通知、自动故障转移" class="headerlink" title="测试Sentinel监控、通知、自动故障转移"></a>测试Sentinel监控、通知、自动故障转移</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有节点哨兵配置</span></span><br><span class="line">node01,node02,node03:</span><br><span class="line">$ redis-cli -h 10.10.10.5 -p 26379</span><br><span class="line">10.10.10.5:26379&gt; info</span><br><span class="line"><span class="comment"># Server</span></span><br><span class="line">redis_version:3.0.6</span><br><span class="line">...</span><br><span class="line">config_file:/etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">master0:name=mymaster,status=ok,address=10.10.10.5:6379,slaves=2,sentinels=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在从节点查看哨兵详情，关注主节点</span></span><br><span class="line">$ redis-cli -h 10.10.10.4 -p 26379</span><br><span class="line">10.10.10.5:26379&gt; sentinel master mymaster</span><br><span class="line"> 1) <span class="string">&quot;name&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;mymaster&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;ip&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;10.10.10.5&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;port&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;6379&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止主节点所在redis-server</span></span><br><span class="line">node01:</span><br><span class="line">$ systemctl stop redis-server.service</span><br><span class="line"><span class="comment"># 查看从节点的哨兵详情，一般来说，过1分钟~2分钟，会自动选举出新的主节点，例如node03被推举为主节点</span></span><br><span class="line">node02:</span><br><span class="line">$ redis-cli -h 10.10.10.4 -p 26379</span><br><span class="line">10.10.10.4:26379&gt; info</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">master0:name=mymaster,status=ok,address=10.10.10.6:6379,slaves=2,sentinels=3</span><br><span class="line"></span><br><span class="line">$ redis-cli -h 10.10.10.6 -p 6379</span><br><span class="line">10.10.10.6:6379&gt; info</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=10.10.10.4,port=6379,state=online,offset=19874,lag=0</span><br><span class="line">master_repl_offset:19874</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动刚才被停止的原主节点redis-server，将作为从节点加入到redis集群</span></span><br><span class="line">node01:</span><br><span class="line">$ systemctl start redis-server</span><br><span class="line">$ redis-cli -h 10.10.10.5 -p 6379</span><br><span class="line">10.10.10.5:6379&gt; info</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:10.10.10.6</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ redis-cli -h 10.10.10.5 -p 26379</span><br><span class="line">10.10.10.5:26379&gt; info</span><br><span class="line">...</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">master0:name=mymaster,status=ok,address=10.10.10.6:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure><h3 id="客户端连接Sentinel"><a href="#客户端连接Sentinel" class="headerlink" title="客户端连接Sentinel"></a>客户端连接Sentinel</h3><p>配置完sentinel，客户端连接方式就改变了，拿<a href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#27-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F">Redisson</a>举例，需要增加以下配置，并删除单机模式下<code>spring.redis.host</code>配置，端口号改成哨兵的端口号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.redis.sentinel.master=mymaster</span><br><span class="line">spring.redis.sentinel.nodes=10.10.10.4:26379,10.10.10.5:26379,10.10.10.6:26379</span><br></pre></td></tr></table></figure><p>引入的jar是</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&quot;org.redisson:redisson-spring-boot-starter:3.9.1&quot;</span></span><br></pre></td></tr></table></figure><p>配置类所在位置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisProperties.Sentinel</span><br></pre></td></tr></table></figure><h2 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl start redis</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> redis</span><br><span class="line">$ sudo systemctl restart</span><br><span class="line">$ sudo systemctl stop redis</span><br></pre></td></tr></table></figure><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol><li>有时可能会遇到关闭或重启不了，这时候可以使用<code>redis-cli</code>提供的命令行来强制关闭</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h 10.10.10.5 -p 6379</span><br><span class="line">10.10.10.5:6379&gt; shutdown nosave</span><br><span class="line"><span class="comment">## 更多参考 https://redis.io/commands/SHUTDOWN</span></span><br></pre></td></tr></table></figure><ol start="2"><li>Redis is configured to save RDB snapshots, but is currently not able to persist on disk.</li></ol><blockquote><p>Redis被配置为保存数据库快照，但它目前不能持久化到硬盘。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/sysctl.conf</span><br><span class="line"><span class="comment">## 添加一行</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">$ sudo sysctl -p /etc/sysctl.conf</span><br><span class="line"><span class="comment">## 重启所有节点redis-server和sentinel</span></span><br></pre></td></tr></table></figure><p>如果改好后，还不行，就需要查看下Redis的dump文件配置是不是被更改了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h 10.10.10.5</span><br><span class="line">10.10.10.5:6379&gt; CONFIG GET dbfilename</span><br><span class="line">1) <span class="string">&quot;dbfilename&quot;</span></span><br><span class="line">2) <span class="string">&quot;.rdb&quot;</span> <span class="comment">## 默认是dump.rdb</span></span><br><span class="line">10.10.10.5:6379&gt; CONFIG GET <span class="built_in">dir</span></span><br><span class="line">1) <span class="string">&quot;dir&quot;</span></span><br><span class="line">2) <span class="string">&quot;/var/spool/cron&quot;</span> <span class="comment">## 默认是dump.rdb</span></span><br></pre></td></tr></table></figure><p>以上配置，如果不是自己更改的，则可怀疑是被黑客篡改了</p><ol><li>检查Redis端口是否在公网开放，如果是，立马关闭</li><li>设置Redis访问密码</li><li>恢复Redis默认配置</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/redis/redis.conf</span><br><span class="line">dbfilename <span class="string">&quot;dump.rdb&quot;</span></span><br><span class="line"><span class="built_in">dir</span> <span class="string">&quot;/var/lib/redis&quot;</span></span><br><span class="line">$ service redis-server restart</span><br><span class="line"></span><br><span class="line">node01 node02 node03均按此修改并重启</span><br><span class="line"><span class="comment">## 了解更多 https://serverfault.com/questions/800295/redis-spontaneously-failed-failed-opening-rdb-for-saving-permission-denied</span></span><br></pre></td></tr></table></figure><h1 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h1><h2 id="安装Consul（单机）"><a href="#安装Consul（单机）" class="headerlink" title="安装Consul（单机）"></a>安装Consul（单机）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> -p /data/consul/&#123;current/&#123;bin,etc&#125;,data&#125;</span><br><span class="line">$ sudo wget https://releases.hashicorp.com/consul/1.5.3/consul_1.5.3_linux_amd64.zip -O /data/consul/consul_1.5.3_linux_amd64.zip</span><br><span class="line">$ sudo apt-get install unzip</span><br><span class="line">$ sudo unzip /data/consul/consul_1.5.3_linux_amd64.zip -d /data/consul/current/bin</span><br><span class="line">$ sudo vi /data/consul/current/etc/consul.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;bootstrap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;datacenter&quot;</span>: <span class="string">&quot;test-datacenter&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data_dir&quot;</span>: <span class="string">&quot;/data/consul/data&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_level&quot;</span>: <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;client_addr&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ui&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;start_join&quot;</span>: [<span class="string">&quot;ip:8301&quot;</span>],</span><br><span class="line">    <span class="string">&quot;enable_syslog&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## 更多参考：https://www.consul.io/docs/agent/options.html#configuration_files</span></span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /data/consul/current/etc /data/consul/etc</span><br><span class="line"></span><br><span class="line">$ sudo vi /etc/systemd/system/consul.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=consul service</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/data/consul/current/bin/consul agent -<span class="built_in">bind</span>=&#123;ip&#125; -config-dir /data/consul/etc/consul.json</span><br><span class="line">User=root</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> consul.service</span><br><span class="line">$ sudo systemctl start consul.service</span><br></pre></td></tr></table></figure><h2 id="安装Consul（集群）"><a href="#安装Consul（集群）" class="headerlink" title="安装Consul（集群）"></a>安装Consul（集群）</h2><table><thead><tr><th align="center">主机</th><th align="center">ip</th></tr></thead><tbody><tr><td align="center">node01</td><td align="center">10.10.10.5</td></tr><tr><td align="center">node02</td><td align="center">10.10.10.4</td></tr><tr><td align="center">node03</td><td align="center">10.10.10.6</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">node01 node02 node03</span><br><span class="line">$ sudo <span class="built_in">mkdir</span> -p /data/consul/&#123;current/&#123;bin,etc&#125;,data&#125;</span><br><span class="line">$ sudo wget https://releases.hashicorp.com/consul/1.5.3/consul_1.5.3_linux_amd64.zip -O /data/consul/consul_1.5.3_linux_amd64.zip</span><br><span class="line">$ sudo apt-get install unzip</span><br><span class="line">$ sudo unzip /data/consul/consul_1.5.3_linux_amd64.zip -d /data/consul/current/bin</span><br><span class="line">$ sudo vi /data/consul/current/etc/consul.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;datacenter&quot;</span>: <span class="string">&quot;roc-datacenter&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data_dir&quot;</span>: <span class="string">&quot;/data/consul/data&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_level&quot;</span>: <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;bootstrap_expect&quot;</span>: 3,</span><br><span class="line">    <span class="string">&quot;client_addr&quot;</span>: <span class="string">&quot;10.10.10.4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ui&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;start_join&quot;</span>: [<span class="string">&quot;10.10.10.4:8301&quot;</span>,<span class="string">&quot;10.10.10.5:8301&quot;</span>,<span class="string">&quot;10.10.10.6:8301&quot;</span>],</span><br><span class="line">    <span class="string">&quot;enable_syslog&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## 更多参考：https://www.consul.io/docs/agent/options.html#configuration_files</span></span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /data/consul/current/etc /data/consul/etc</span><br><span class="line"></span><br><span class="line">$ sudo vi /etc/systemd/system/consul.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=consul service</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/data/consul/current/bin/consul agent -config-dir /data/consul/etc/consul.json</span><br><span class="line">User=root</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> consul.service</span><br><span class="line">$ sudo systemctl start consul.service</span><br></pre></td></tr></table></figure><p>需要开放的端口：8300, 8301, 8500，如果网络不通，则子节点将无法join到主节点，可能会出现</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to <span class="built_in">sync</span> remote state: No cluster leader</span><br></pre></td></tr></table></figure><p>无法选举出leader，其实是节点之间无法通信，如果通信正常，启动之时所有节点会自动推举出leader。</p><h2 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl start consul.service</span><br><span class="line">$ sudo systemctl stop consul.service</span><br><span class="line">$ sudo systemctl restart consul.service</span><br><span class="line"></span><br><span class="line"><span class="comment">## 更多参考：https://www.consul.io/docs/commands/index.html</span></span><br></pre></td></tr></table></figure><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -e <span class="string">&quot;deb http://nginx.org/packages/ubuntu/ <span class="subst">$(lsb_release -cs)</span> nginx\ndeb-src http://nginx.org/packages/ubuntu/ <span class="subst">$(lsb_release -cs)</span> nginx&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/nginx.list</span><br><span class="line">$ wget -O- http://nginx.org/keys/nginx_signing.key | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install nginx</span><br><span class="line"><span class="comment">## 更多参考：http://nginx.org/en/linux_packages.html#stable</span></span><br></pre></td></tr></table></figure><h2 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service nginx start</span><br><span class="line">$ sudo service nginx stop</span><br><span class="line">$ sudo service nginx restart</span><br><span class="line"></span><br><span class="line">$ sudo service nginx reload <span class="comment"># 重新加载配置</span></span><br></pre></td></tr></table></figure><h1 id="Cassandra集群"><a href="#Cassandra集群" class="headerlink" title="Cassandra集群"></a>Cassandra集群</h1><table><thead><tr><th>主机</th><th>IP</th></tr></thead><tbody><tr><td>cassandra-1</td><td>192.168.0.1</td></tr><tr><td>cassandra-2</td><td>192.168.0.2</td></tr></tbody></table><h2 id="安装Cassandra"><a href="#安装Cassandra" class="headerlink" title="安装Cassandra"></a>安装Cassandra</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deb http://www.apache.org/dist/cassandra/debian 39x main&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/apt/sources.list.d/cassandra.sources.list</span><br><span class="line">$ curl https://www.apache.org/dist/cassandra/KEYS | sudo apt-key add -</span><br><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt -y install cassandra</span><br><span class="line">$ sudo apt install openjdk-8-jdk-headless</span><br><span class="line"><span class="comment">## 更多参考：http://cassandra.apache.org/download/#installation-from-debian-packages</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/cassandra/cassandra.yaml</span><br><span class="line"></span><br><span class="line">seed_provider:</span><br><span class="line">          - seeds: <span class="string">&quot;192.168.0.1,192.168.0.2&quot;</span></span><br><span class="line"> </span><br><span class="line">concurrent_writes: 64</span><br><span class="line">concurrent_counter_writes: 64</span><br><span class="line">concurrent_counter_writes: 64</span><br><span class="line">concurrent_materialized_view_writes: 64</span><br><span class="line">compaction_throughput_mb_per_sec: 128</span><br><span class="line">file_cache_size_in_mb: 1024</span><br><span class="line">buffer_pool_use_heap_if_exhausted: <span class="literal">true</span></span><br><span class="line">disk_optimization_strategy: spinning</span><br><span class="line"><span class="comment">#listen_address: localhost</span></span><br><span class="line">listen_interface: eth0</span><br><span class="line"><span class="comment">#rpc_address: localhost</span></span><br><span class="line">rpc_interface: eth0</span><br><span class="line">enable_user_defined_functions: <span class="literal">true</span></span><br><span class="line">auto_bootstrap: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化cassandra jvm配置</span></span><br><span class="line">$ sudo vi /etc/cassandra/jvm.options</span><br><span class="line"><span class="comment">#-XX:+UseParNewGC</span></span><br><span class="line"><span class="comment">#-XX:+UseConcMarkSweepGC</span></span><br><span class="line"><span class="comment">#-XX:+CMSParallelRemarkEnabled</span></span><br><span class="line"><span class="comment">#-XX:SurvivorRatio=8</span></span><br><span class="line"><span class="comment">#-XX:MaxTenuringThreshold=1</span></span><br><span class="line"><span class="comment">#-XX:CMSInitiatingOccupancyFraction=75</span></span><br><span class="line"><span class="comment">#-XX:+UseCMSInitiatingOccupancyOnly</span></span><br><span class="line"><span class="comment">#-XX:CMSWaitDuration=10000</span></span><br><span class="line"><span class="comment">#-XX:+CMSParallelInitialMarkEnabled</span></span><br><span class="line"><span class="comment">#-XX:+CMSEdenChunksRecordAlways</span></span><br><span class="line"></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:G1RSetUpdatingPauseTimePercent=5</span><br><span class="line">-XX:MaxGCPauseMillis=500</span><br><span class="line">-XX:InitiatingHeapOccupancyPercent=70</span><br><span class="line">-XX:ParallelGCThreads=16</span><br><span class="line">-XX:ConcGCThreads=16</span><br><span class="line"></span><br><span class="line">$ sudo vi /etc/cassandra/cassandra-env.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置为主机内网地址</span></span><br><span class="line">JVM_OPTS=<span class="string">&quot;<span class="variable">$JVM_OPTS</span> -Djava.rmi.server.hostname=192.168.0.1&quot;</span></span><br><span class="line"><span class="comment">#if [ &quot;x$LOCAL_JMX&quot; = &quot;x&quot; ]; then</span></span><br><span class="line"><span class="comment">#      LOCAL_JMX=yes</span></span><br><span class="line"><span class="comment">#  fi</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$LOCAL_JMX</span>&quot;</span> = <span class="string">&quot;x&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      LOCAL_JMX=no</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=true&quot;</span></span><br><span class="line">JVM_OPTS=<span class="string">&quot;<span class="variable">$JVM_OPTS</span> -Dcom.sun.management.jmxremote.authenticate=false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password&quot;</span></span><br><span class="line"></span><br><span class="line">$ sudo systemctl stop cassandra</span><br></pre></td></tr></table></figure><h2 id="迁移配置导数据盘（可选）"><a href="#迁移配置导数据盘（可选）" class="headerlink" title="迁移配置导数据盘（可选）"></a>迁移配置导数据盘（可选）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mv</span> /var/lib/cassandra /data/cassandra</span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /data/cassandra /var/lib/cassandra</span><br><span class="line"></span><br><span class="line">$ sudo systemctl start cassandra</span><br></pre></td></tr></table></figure><p>集群内其余机器，重复上述步骤，修改对应IP</p><h1 id="Zookeeper集群"><a href="#Zookeeper集群" class="headerlink" title="Zookeeper集群"></a>Zookeeper集群</h1><table><thead><tr><th>主机</th><th>IP</th></tr></thead><tbody><tr><td>zk-01</td><td>192.168.0.1</td></tr><tr><td>zk-02</td><td>192.168.0.2</td></tr><tr><td>zk-03</td><td>192.168.0.3</td></tr></tbody></table><h2 id="安装Zookeeper"><a href="#安装Zookeeper" class="headerlink" title="安装Zookeeper"></a>安装Zookeeper</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install zookeeperd</span><br></pre></td></tr></table></figure><h2 id="修改配置文件-2"><a href="#修改配置文件-2" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/zookeeper/conf/zoo.cfg</span><br><span class="line">server.1=192.168.0.1:2888:3888</span><br><span class="line">server.2=192.168.0.2:2888:3888</span><br><span class="line">server.3=192.168.0.3:2888:3888</span><br><span class="line">$ sudo vim /etc/zookeeper/conf/myid</span><br><span class="line">1</span><br><span class="line"><span class="comment"># 每台主机id各不相同，比如zk-01=1,zk-02=2,zk-03=3</span></span><br><span class="line">$ sudo systemctl restart zookeeper</span><br></pre></td></tr></table></figure><h2 id="安装ZK-UI（可选）"><a href="#安装ZK-UI（可选）" class="headerlink" title="安装ZK-UI（可选）"></a>安装<a href="https://github.com/DeemOpen/zkui">ZK-UI</a>（可选）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装zkui</span></span><br><span class="line">$ <span class="built_in">cd</span> /data &amp;&amp; wget https://github.com/zifangsky/zkui/releases/download/v2.0/zkui-2.0.zip</span><br><span class="line">$ sudo unzip zkui-2.0.zip</span><br><span class="line">$ sudo vi /data/zkui/config.cfg</span><br><span class="line">  </span><br><span class="line">zkServer=192.168.0.1:2181,192.168.0.2:2181,192.168.0.3:2181</span><br><span class="line">userSet = &#123;<span class="string">&quot;users&quot;</span>: [&#123; <span class="string">&quot;username&quot;</span>:<span class="string">&quot;&lt;username&gt;&quot;</span> , <span class="string">&quot;password&quot;</span>:<span class="string">&quot;&lt;password&gt;&quot;</span>,<span class="string">&quot;role&quot;</span>: <span class="string">&quot;ADMIN&quot;</span> &#125;,&#123; <span class="string">&quot;username&quot;</span>:<span class="string">&quot;appconfig&quot;</span> , <span class="string">&quot;password&quot;</span>:<span class="string">&quot;appconfig&quot;</span>,<span class="string">&quot;role&quot;</span>: <span class="string">&quot;USER&quot;</span> &#125;]&#125;</span><br><span class="line">  </span><br><span class="line">$ <span class="built_in">cd</span> /data/zkui &amp;&amp; sudo bash start.sh</span><br></pre></td></tr></table></figure><p>集群内其余机器，重复上述步骤</p><h1 id="Kafka集群"><a href="#Kafka集群" class="headerlink" title="Kafka集群"></a>Kafka集群</h1><table><thead><tr><th>主机</th><th>IP</th></tr></thead><tbody><tr><td>zk-01</td><td>192.168.0.1</td></tr><tr><td>zk-02</td><td>192.168.0.2</td></tr><tr><td>zk-03</td><td>192.168.0.3</td></tr></tbody></table><h2 id="安装Kafka"><a href="#安装Kafka" class="headerlink" title="安装Kafka"></a>安装Kafka</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> /data/kafka &amp;&amp; <span class="built_in">cd</span> ~</span><br><span class="line">$ wget <span class="string">&quot;http://www-eu.apache.org/dist/kafka/1.0.1/kafka_2.12-1.0.1.tgz&quot;</span></span><br><span class="line">$ curl http://kafka.apache.org/KEYS | gpg --import</span><br><span class="line">$ wget https://dist.apache.org/repos/dist/release/kafka/1.0.1/kafka_2.12-1.0.1.tgz.asc</span><br><span class="line">$ gpg --verify kafka_2.12-1.0.1.tgz.asc kafka_2.12-1.0.1.tgz</span><br><span class="line">$ sudo tar -xvzf kafka_2.12-1.0.1.tgz --directory /data/kafka --strip-components 1</span><br><span class="line">$ sudo <span class="built_in">rm</span> -rf kafka_2.12-1.0.1.tgz kafka_2.12-1.0.1.tgz.asc</span><br><span class="line"><span class="comment">## 更多参考 https://tecadmin.net/install-apache-kafka-ubuntu/</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件-3"><a href="#修改配置文件-3" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> /data/kafka-logs</span><br><span class="line">$ sudo <span class="built_in">cp</span> /data/kafka/config/server.properties&#123;,.bak&#125;</span><br><span class="line">$ sudo vim /data/kafka/config/server.properties</span><br><span class="line"> </span><br><span class="line">broker.id=0    <span class="comment"># 每台主机各不相同</span></span><br><span class="line">listeners=PLAINTEXT://0.0.0.0:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://&lt;ip&gt;:9092</span><br><span class="line">delete.topic.enable = <span class="literal">true</span></span><br><span class="line">leader.imbalance.check.interval.seconds=5  <span class="comment"># leader不平衡检查间隔</span></span><br><span class="line">leader.imbalance.per.broker.percentage=1</span><br><span class="line">log.dirs=/data/kafka-logs</span><br><span class="line">offsets.topic.replication.factor=3</span><br><span class="line">log.retention.hours=72</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">zookeeper.connect=192.168.0.1:2181,192.168.0.2:2181,192.168.0.3:2181</span><br><span class="line">  </span><br><span class="line">$ sudo vim /data/kafka/bin/kafka-server-start.sh</span><br><span class="line"><span class="built_in">export</span> JMX_PORT=12345    <span class="comment"># 暴露jmx端口，留待监控使用</span></span><br></pre></td></tr></table></figure><h2 id="注册为Systemd服务"><a href="#注册为Systemd服务" class="headerlink" title="注册为Systemd服务"></a>注册为Systemd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ sudo adduser --system --no-create-home --disabled-password --disabled-login kafka</span><br><span class="line">$ sudo <span class="built_in">chown</span> -R kafka:nogroup /data/kafka</span><br><span class="line">$ sudo <span class="built_in">chown</span> -R kafka:nogroup /data/kafka-logs</span><br><span class="line">  </span><br><span class="line">$ sudo vim /etc/systemd/system/kafka.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=High-available, distributed message broker</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">User=kafka</span><br><span class="line">ExecStart=/data/kafka/bin/kafka-server-start.sh /data/kafka/config/server.properties</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启用服务</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> kafka.service</span><br><span class="line">$ sudo systemctl start kafka.service</span><br><span class="line"></span><br><span class="line"><span class="comment">## 更多参考 https://kafka.apache.org/quickstart</span></span><br></pre></td></tr></table></figure><h2 id="测试Kafka的使用（可选）"><a href="#测试Kafka的使用（可选）" class="headerlink" title="测试Kafka的使用（可选）"></a>测试Kafka的使用（可选）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ /data/kafka/bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br><span class="line">$ /data/kafka/bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line">  </span><br><span class="line">$ /data/kafka/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br><span class="line">&gt; Hello World</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 另外一个terminal</span></span><br><span class="line">$ /data/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure><h2 id="部署Kafka-manager"><a href="#部署Kafka-manager" class="headerlink" title="部署Kafka-manager"></a>部署<a href="https://github.com/yahoo/kafka-manager">Kafka-manager</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data &amp; sudo wget https://github.com/yahoo/kafka-manager/archive/1.3.3.17.zip</span><br><span class="line">$ sudo unzip kafka-manager-1.3.3.17.zip</span><br><span class="line">$ sudo <span class="built_in">mv</span> kafka-manager-1.3.3.17 kafka-manager</span><br><span class="line">$ sudo <span class="built_in">chown</span> -R kafka:nogroup /data/kafka-manager</span><br><span class="line">$ sudo vim /data/kafka-manager/conf/application.conf</span><br><span class="line">kafka-manager.zkhosts=<span class="string">&quot;192.168.0.1:2181,192.168.0.2:2181,192.168.0.3:2181&quot;</span></span><br><span class="line">basicAuthentication.enabled=<span class="literal">true</span></span><br><span class="line">basicAuthentication.username=<span class="string">&quot;&lt;username&gt;&quot;</span></span><br><span class="line">basicAuthentication.password=<span class="string">&quot;&lt;password&gt;&quot;</span></span><br><span class="line">  </span><br><span class="line">$ sudo vim /etc/systemd/system/kafka-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=High-available, distributed message broker manager</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">User=kafka</span><br><span class="line">ExecStart=/data/kafka-manager/bin/kafka-manager</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启用服务</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> kafka-manager.service</span><br><span class="line">$ sudo systemctl start kafka-manager.service</span><br></pre></td></tr></table></figure><h1 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h1><h2 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install mysql-server</span><br></pre></td></tr></table></figure><div class="note warning flat"><p>在安装过程中，系统将提示您创建root密码。请务必记住root密码</p></div><h2 id="配置Mysql"><a href="#配置Mysql" class="headerlink" title="配置Mysql"></a>配置Mysql</h2><p>运行安全脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysql_secure_installation</span><br></pre></td></tr></table></figure><p>值得一提的是，<code>Disallow root login remotely?</code>，如果你需要使用root账号进行远程连接，请选择No</p><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>接下来测试下是否安装成功了</p><ol><li>运行状态</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status mysql.service</span><br><span class="line">● mysql.service - MySQL Community Server</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/mysql.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Thu 2019-07-18 23:38:43 PDT; 11min ago</span><br><span class="line"> Main PID: 2948 (mysqld)</span><br><span class="line">    Tasks: 28</span><br><span class="line">   Memory: 142.6M</span><br><span class="line">      CPU: 545ms</span><br><span class="line">   CGroup: /system.slice/mysql.service</span><br><span class="line">           └─2948 /usr/sbin/mysqld</span><br></pre></td></tr></table></figure><ol start="2"><li>登录查看版本</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin -p -u root version</span><br><span class="line">mysqladmin  Ver 8.42 Distrib 5.7.26, <span class="keyword">for</span> Linux on x86_64</span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Server version5.7.26-0ubuntu0.16.04.1</span><br><span class="line">Protocol version10</span><br><span class="line">ConnectionLocalhost via UNIX socket</span><br><span class="line">UNIX socket/var/run/mysqld/mysqld.sock</span><br><span class="line">Uptime:12 min 18 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 36  Slow queries: 0  Opens: 121  Flush tables: 1  Open tables: 40  Queries per second avg: 0.048</span><br></pre></td></tr></table></figure><p>到这里，Mysql安装完成！</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">Systemd 入门教程：命令篇</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;针对&lt;code&gt;Ubuntu 16.04&lt;/code&gt;，汇总常用服务的搭建指南。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Ubuntu" scheme="https://blog.gcdd.top/tags/Ubuntu/"/>
    
    <category term="运维" scheme="https://blog.gcdd.top/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>Java安全笔记</title>
    <link href="https://blog.gcdd.top/p/10700/"/>
    <id>https://blog.gcdd.top/p/10700/</id>
    <published>2019-04-10T12:13:10.000Z</published>
    <updated>2023-08-30T04:52:53.899Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>后端接口开发中，涉及到用户私密信息（用户名、密码）等，我们不能传输明文，必须使用加密方式传输。这次政府项目中，安全测试组提出了明文传输漏洞，抽空研究了下Java加解密相关知识，记录下。</p><span id="more"></span><h1 id="散列函数"><a href="#散列函数" class="headerlink" title="散列函数"></a>散列函数</h1><p>Java提供了一个名为<code>MessageDigest</code>的类，它属于<code>java.security</code>包。 此类支持诸如<code>SHA-1</code>，<code>SHA 256</code>，<code>MD5</code>之类的算法，以将任意长度的消息转换为信息摘要。</p><p>散列函数返回的值称为信息摘要或简称散列值。 下图说明了散列函数。</p><p><img src="https://i.loli.net/2019/04/10/5cade05f6faf5.png"></p><p>要使用散列函数加密数据，我们通常按照以下步骤执行：</p><h2 id="创建MessageDigest对象"><a href="#创建MessageDigest对象" class="headerlink" title="创建MessageDigest对象"></a>创建MessageDigest对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p><code>MessageDigest</code>提供了<code>getInstance</code>静态方法来获得<code>MessageDigest</code>实例，支持的类型可参考<a href="https://zh.wikipedia.org/wiki/SHA%E5%AE%B6%E6%97%8F">Wiki-SHA家族</a></p></blockquote><h2 id="将数据传递给创建的MessageDigest对象"><a href="#将数据传递给创建的MessageDigest对象" class="headerlink" title="将数据传递给创建的MessageDigest对象"></a>将数据传递给创建的MessageDigest对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md.update(<span class="string">&quot;gcdd1993&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure><h2 id="生成消息摘要"><a href="#生成消息摘要" class="headerlink" title="生成消息摘要"></a>生成消息摘要</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] digest = md.digest();</span><br></pre></td></tr></table></figure><h2 id="通常我们会将其转换为Hex字符串"><a href="#通常我们会将其转换为Hex字符串" class="headerlink" title="通常我们会将其转换为Hex字符串"></a>通常我们会将其转换为Hex字符串</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringBuffer</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">byte</span> aDigest : digest) &#123;</span><br><span class="line">    hexString.append(Integer.toHexString(<span class="number">0xFF</span> &amp; aDigest));</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;Hex format : &quot;</span> + hexString.toString());</span><br></pre></td></tr></table></figure><h1 id="消息认证码"><a href="#消息认证码" class="headerlink" title="消息认证码"></a>消息认证码</h1><blockquote><p>MAC(消息认证码)算法是一种对称密钥加密技术，用于提供消息认证。要建立MAC过程，发送方和接收方共享对称密钥K。</p></blockquote><p>实质上，MAC是在基础消息上生成的加密校验和，它与消息一起发送以确保消息验证。</p><p>使用MAC进行身份验证的过程如下图所示</p><p><img src="https://i.loli.net/2019/04/10/5cade5aaeaede.png"></p><p>在Java中，<code>javax.crypto</code>包的Mac类提供了消息认证代码的功能。按照以下步骤使用此类创建消息身份验证代码。</p><h2 id="创建KeyGenerator对象"><a href="#创建KeyGenerator对象" class="headerlink" title="创建KeyGenerator对象"></a>创建KeyGenerator对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyGenerator</span> <span class="variable">keyGen</span> <span class="operator">=</span> KeyGenerator.getInstance(<span class="string">&quot;DES&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p><code>KeyGenerator</code>支持以下类型：</p><ul><li>AES (128)</li><li>DES (56)</li><li>DESede (168)</li><li>HmacSHA1</li><li>HmacSHA256</li></ul></blockquote><h2 id="创建SecureRandom对象"><a href="#创建SecureRandom对象" class="headerlink" title="创建SecureRandom对象"></a>创建SecureRandom对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SecureRandom</span> <span class="variable">secureRandom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>();</span><br></pre></td></tr></table></figure><h2 id="初始化KeyGenerator"><a href="#初始化KeyGenerator" class="headerlink" title="初始化KeyGenerator"></a>初始化KeyGenerator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyGen.init(secureRandom);</span><br></pre></td></tr></table></figure><h2 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> keyGen.generateKey();</span><br></pre></td></tr></table></figure><h2 id="使用密钥初始化Mac对象"><a href="#使用密钥初始化Mac对象" class="headerlink" title="使用密钥初始化Mac对象"></a>使用密钥初始化Mac对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Mac</span> <span class="variable">mac</span> <span class="operator">=</span> Mac.getInstance(<span class="string">&quot;HmacMD5&quot;</span>);</span><br><span class="line">mac.init(key);</span><br></pre></td></tr></table></figure><blockquote><p><code>Mac</code>支持以下类型：</p><ul><li>HmacMD5</li><li>HmacSHA1</li><li>HmacSHA256</li></ul></blockquote><h2 id="完成mac操作"><a href="#完成mac操作" class="headerlink" title="完成mac操作"></a>完成mac操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;gcdd1993&quot;</span>;</span><br><span class="line"><span class="type">byte</span>[] bytes = msg.getBytes();</span><br><span class="line"><span class="type">byte</span>[] macResult = mac.doFinal(bytes);</span><br></pre></td></tr></table></figure><h1 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h1><blockquote><p>数字签名允许验证签名的作者，日期和时间，验证消息内容。 它还包括用于其他功能的身份验证功能。</p></blockquote><p><img src="https://i.loli.net/2019/04/10/5cade8c25ab4c.png"></p><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul><li><p>认证</p><blockquote><p>数字签名有助于验证消息来源。 </p></blockquote></li><li><p>完整性</p><blockquote><p>邮件签名后，邮件中的任何更改都将使签名无效。</p></blockquote></li><li><p>不可否认</p><blockquote><p>通过此属性，任何已签署某些信息的实体都不能在以后拒绝签名。</p></blockquote></li></ul><h2 id="创建数字签名"><a href="#创建数字签名" class="headerlink" title="创建数字签名"></a>创建数字签名</h2><h3 id="创建KeyPairGenerator对象"><a href="#创建KeyPairGenerator对象" class="headerlink" title="创建KeyPairGenerator对象"></a>创建KeyPairGenerator对象</h3><blockquote><p><code>KeyPairGenerator</code>类提供<code>getInstance()</code>方法，该方法接受表示所需密钥生成算法的String变量，并返回生成密钥的<code>KeyPairGenerator</code>对象。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">keyPairGen</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="初始化KeyPairGenerator对象"><a href="#初始化KeyPairGenerator对象" class="headerlink" title="初始化KeyPairGenerator对象"></a>初始化KeyPairGenerator对象</h3><blockquote><p><code>KeyPairGenerator</code>类提供了一个名为<code>initialize()</code>的方法，该方法用于初始化密钥对生成器。 此方法接受表示密钥大小的整数值。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyPairGen.initialize(<span class="number">2048</span>);</span><br></pre></td></tr></table></figure><h3 id="生成KeyPair"><a href="#生成KeyPair" class="headerlink" title="生成KeyPair"></a>生成KeyPair</h3><blockquote><p>使用<code>generateKeyPair()</code>方法生成密钥对</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPair</span> <span class="variable">pair</span> <span class="operator">=</span> keyPairGen.generateKeyPair();</span><br></pre></td></tr></table></figure><h3 id="从密钥对中获取私钥"><a href="#从密钥对中获取私钥" class="headerlink" title="从密钥对中获取私钥"></a>从密钥对中获取私钥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> pair.getPrivate();</span><br></pre></td></tr></table></figure><h3 id="创建签名对象"><a href="#创建签名对象" class="headerlink" title="创建签名对象"></a>创建签名对象</h3><blockquote><p><code>Signature</code>类的<code>getInstance()</code>方法接受表示所需签名算法的字符串参数，并返回相应的<code>Signature</code>对象。</p><p>Signature支持以下类型：</p><ul><li>SHA1withDSA</li><li>SHA1withRSA</li><li>SHA256withRSA</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Signature</span> <span class="variable">sign</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;SHA256withDSA&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="初始化签名对象"><a href="#初始化签名对象" class="headerlink" title="初始化签名对象"></a>初始化签名对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sign.initSign(privateKey);</span><br></pre></td></tr></table></figure><h3 id="将数据添加到Signature对象"><a href="#将数据添加到Signature对象" class="headerlink" title="将数据添加到Signature对象"></a>将数据添加到Signature对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;gcdd1993&quot;</span>;</span><br><span class="line">sign.update(msg.getBytes());</span><br></pre></td></tr></table></figure><h3 id="计算签名"><a href="#计算签名" class="headerlink" title="计算签名"></a>计算签名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] signature = sign.sign();</span><br></pre></td></tr></table></figure><h2 id="验证签名"><a href="#验证签名" class="headerlink" title="验证签名"></a>验证签名</h2><blockquote><p>我们创建签名后，通常可以将私钥发送到客户端，以进行签名操作。服务端保存公钥，以进行签名验证</p></blockquote><h3 id="初始化签名对象以进行验证"><a href="#初始化签名对象以进行验证" class="headerlink" title="初始化签名对象以进行验证"></a>初始化签名对象以进行验证</h3><blockquote><p>使用公钥初始化签名对象</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sign.initVerify(pair.getPublic());</span><br></pre></td></tr></table></figure><h3 id="更新要验证的数据"><a href="#更新要验证的数据" class="headerlink" title="更新要验证的数据"></a>更新要验证的数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sign.update(msg.getBytes());</span><br></pre></td></tr></table></figure><h3 id="验证签名-1"><a href="#验证签名-1" class="headerlink" title="验证签名"></a>验证签名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">verify</span> <span class="operator">=</span> sign.verify(signature);</span><br><span class="line">Assert.assertTrue(verify);</span><br></pre></td></tr></table></figure><h1 id="公私钥加解密数据"><a href="#公私钥加解密数据" class="headerlink" title="公私钥加解密数据"></a>公私钥加解密数据</h1><blockquote><p>可以使用<code>javax.crypto</code>包的Cipher类加密给定数据。 </p></blockquote><p>获取公私钥的步骤，与签名类似</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">keyPairGen</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">keyPairGen.initialize(<span class="number">2048</span>);</span><br><span class="line"><span class="type">KeyPair</span> <span class="variable">pair</span> <span class="operator">=</span> keyPairGen.generateKeyPair();</span><br><span class="line"><span class="type">PublicKey</span> <span class="variable">publicKey</span> <span class="operator">=</span> pair.getPublic();</span><br></pre></td></tr></table></figure><h2 id="加密数据"><a href="#加密数据" class="headerlink" title="加密数据"></a>加密数据</h2><h3 id="创建一个Cipher对象"><a href="#创建一个Cipher对象" class="headerlink" title="创建一个Cipher对象"></a>创建一个Cipher对象</h3><blockquote><p><code>Cipher</code>类的<code>getInstance()</code>方法接受表示所需转换的String变量，并返回实现给定转换的<code>Cipher</code>对象。</p><p>Cipher支持以下类型：</p><ul><li>AES/CBC/NoPadding (128)</li><li>AES/CBC/PKCS5Padding (128)</li><li>AES/ECB/NoPadding (128)</li><li>AES/ECB/PKCS5Padding (128)</li><li>DES/CBC/NoPadding (56)</li><li>DES/CBC/PKCS5Padding (56)</li><li>DES/ECB/NoPadding (56)</li><li>DES/ECB/PKCS5Padding (56)</li><li>DESede/CBC/NoPadding (168)</li><li>DESede/CBC/PKCS5Padding (168)</li><li>DESede/ECB/NoPadding (168)</li><li>DESede/ECB/PKCS5Padding (168)</li><li>RSA/ECB/PKCS1Padding (1024, 2048)</li><li>RSA/ECB/OAEPWithSHA-1AndMGF1Padding (1024, 2048)</li><li>RSA/ECB/OAEPWithSHA-256AndMGF1Padding (1024, 2048)</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;RSA/ECB/PKCS1Padding&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="使用公钥初始化Cipher对象"><a href="#使用公钥初始化Cipher对象" class="headerlink" title="使用公钥初始化Cipher对象"></a>使用公钥初始化Cipher对象</h3><blockquote><p><code>Cipher</code>类的<code>init()</code>方法接受两个参数，一个表示操作模式的整数参数(加密/解密)和一个表示公钥的Key对象。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br></pre></td></tr></table></figure><h3 id="将数据添加到Cipher对象"><a href="#将数据添加到Cipher对象" class="headerlink" title="将数据添加到Cipher对象"></a>将数据添加到Cipher对象</h3><blockquote><p><code>Cipher</code>类的<code>update()</code>方法接受表示要加密的数据的字节数组，并使用给定的数据更新当前对象。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;gcdd1993&quot;</span>;</span><br><span class="line">cipher.update(msg.getBytes());</span><br></pre></td></tr></table></figure><h3 id="加密数据-1"><a href="#加密数据-1" class="headerlink" title="加密数据"></a>加密数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] cipherText = cipher.doFinal();</span><br></pre></td></tr></table></figure><h2 id="解密数据"><a href="#解密数据" class="headerlink" title="解密数据"></a>解密数据</h2><h3 id="使用私钥初始化Cipher对象"><a href="#使用私钥初始化Cipher对象" class="headerlink" title="使用私钥初始化Cipher对象"></a>使用私钥初始化Cipher对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cipher.init(Cipher.DECRYPT_MODE, pair.getPrivate());</span><br></pre></td></tr></table></figure><h3 id="解密数据-1"><a href="#解密数据-1" class="headerlink" title="解密数据"></a>解密数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] decipheredText = cipher.doFinal(cipherText);</span><br><span class="line">Assert.assertEquals(msg, <span class="keyword">new</span> <span class="title class_">String</span>(decipheredText));</span><br></pre></td></tr></table></figure><h1 id="第三方类库"><a href="#第三方类库" class="headerlink" title="第三方类库"></a>第三方类库</h1><blockquote><p>前后端适用且应用广泛的是<a href="https://github.com/brix/crypto-js"><code>Crypto-JS</code></a>,使用 <code>Crypto-JS </code>可以非常方便地在 JavaScript 进行 MD5、SHA1、SHA2、SHA3、RIPEMD-160 哈希散列，进行 AES、DES、Rabbit、RC4、Triple DES 加解密。</p></blockquote><h2 id="AES加密"><a href="#AES加密" class="headerlink" title="AES加密"></a>AES加密</h2><blockquote><p><strong>高级加密标准</strong>（英语：<strong>A</strong>dvanced <strong>E</strong>ncryption <strong>S</strong>tandard，缩写：<a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E5%8A%A0%E5%AF%86%E6%A0%87%E5%87%86">AES</a>），在密码学中又称<strong>Rijndael加密法</strong>，是美国联邦政府采用的一种<a href="https://zh.wikipedia.org/wiki/%E5%8D%80%E5%A1%8A%E5%8A%A0%E5%AF%86">区块加密</a>标准。这个标准用来替代原先的<a href="https://zh.wikipedia.org/wiki/DES">DES</a>，已经被多方分析且广为全世界所使用。</p></blockquote><p>一般来说，我们可以在服务端随机生成密钥，然后将密钥发送给客户端进行加密，上传密文到服务端，服务端进行解密。</p><p>本文只讨论Java的AES加解密方式。</p><h3 id="引入Jar包"><a href="#引入Jar包" class="headerlink" title="引入Jar包"></a>引入Jar包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile group: &#x27;org.webjars.npm&#x27;, name: &#x27;crypto-js&#x27;, version: &#x27;3.1.8&#x27;</span><br></pre></td></tr></table></figure><h3 id="生成密钥-1"><a href="#生成密钥-1" class="headerlink" title="生成密钥"></a>生成密钥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="type">byte</span>[] key = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];</span><br><span class="line">random.nextBytes(key);</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">keySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, <span class="string">&quot;AES&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="生成偏移量"><a href="#生成偏移量" class="headerlink" title="生成偏移量"></a>生成偏移量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] iv = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];</span><br><span class="line">random.nextBytes(iv);</span><br><span class="line"><span class="type">IvParameterSpec</span> <span class="variable">ivSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv);</span><br></pre></td></tr></table></figure><h3 id="创建Cipher对象"><a href="#创建Cipher对象" class="headerlink" title="创建Cipher对象"></a>创建Cipher对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5Padding&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="初始化Cipher为加密工作过程"><a href="#初始化Cipher为加密工作过程" class="headerlink" title="初始化Cipher为加密工作过程"></a>初始化Cipher为加密工作过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);</span><br></pre></td></tr></table></figure><h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] original = cipher.doFinal(encrypted1);</span><br></pre></td></tr></table></figure><h2 id="AES解密"><a href="#AES解密" class="headerlink" title="AES解密"></a>AES解密</h2><h3 id="初始化Cipher为解密工作过程"><a href="#初始化Cipher为解密工作过程" class="headerlink" title="初始化Cipher为解密工作过程"></a>初始化Cipher为解密工作过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cipher.init(Cipher.DECRYPT_MODE, keySpec, ivSpec);</span><br></pre></td></tr></table></figure><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] bytes = cipher.doFinal(original);</span><br><span class="line">Assert.assertEquals(data, <span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8));</span><br></pre></td></tr></table></figure><h2 id="AES加解密总结"><a href="#AES加解密总结" class="headerlink" title="AES加解密总结"></a>AES加解密总结</h2><p>实际项目中，可以按照以下方式实现对称加密</p><ol><li>服务端提供一个接口，该接口负责随机生成key（密码）和iv（偏移量），并将其存入redis（设置超时时间）</li><li>客户端调用接口，获得key和iv以及一个redis_key，进行数据加密，将加密后的数据以及redis_key传到服务端</li><li>服务端使用redis_key获得key和iv，进行解密</li></ol><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在Java EE安全里，主要是进行客户端加密，以及服务端解密的过程来实现数据安全传输的目的。在这个过程中，特别要注意以下几点：</p><ul><li>随机性：加密方式不可单一，可通过更换<code>Cipher.getInstance()</code>的String值来随机生成加密工人进行加密。</li><li>保密性：加密使用的密钥或者偏移量等，需要使用超时、模糊目的等手段进行隐藏，加大破解成本。</li></ul><p>没有完全有效的加密，但是只要做到破解成本大于加密成本，就是有效的加密。这样，我们可以不断地更换加密方式达到我们想要的效果。</p><p>👉 <a href="https://github.com/gcdd1993/java-security-sample">代码仓库</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;后端接口开发中，涉及到用户私密信息（用户名、密码）等，我们不能传输明文，必须使用加密方式传输。这次政府项目中，安全测试组提出了明文传输漏洞，抽空研究了下Java加解密相关知识，记录下。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
    <category term="安全" scheme="https://blog.gcdd.top/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Lombok 详解</title>
    <link href="https://blog.gcdd.top/p/12232/"/>
    <id>https://blog.gcdd.top/p/12232/</id>
    <published>2019-04-05T13:19:26.000Z</published>
    <updated>2023-08-30T04:52:53.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>lombok是一个编译级别的插件，它可以在项目编译的时候生成一些代码。通俗的说，lombok可以通过注解来标示生成<code>getter</code> <code>settter</code>等代码。</p><span id="more"></span><h1 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h1><p>创建gradle项目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile group: &#x27;org.projectlombok&#x27;, name: &#x27;lombok&#x27;, version: &#x27;1.16.20&#x27;</span><br></pre></td></tr></table></figure><h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><h2 id="NonNull"><a href="#NonNull" class="headerlink" title="@NonNull"></a>@NonNull</h2><blockquote><p>标记字段不可为null</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(<span class="meta">@NonNull</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="meta">@NonNull</span> Integer age)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (age == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Getter-Setter"><a href="#Getter-Setter" class="headerlink" title="@Getter/@Setter"></a>@Getter/@Setter</h2><blockquote><p>自动生成getter和setter方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="@Cleanup"></a>@Cleanup</h2><blockquote><p>自动关闭流代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cleanup</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(args[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>对应的字节码文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(args[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">if</span> (Collections.singletonList(in).get(<span class="number">0</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">    in.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AllArgsConstructor-NoArgsConstructor-RequiredArgsConstructor"><a href="#AllArgsConstructor-NoArgsConstructor-RequiredArgsConstructor" class="headerlink" title="@AllArgsConstructor/@NoArgsConstructor/@RequiredArgsConstructor"></a>@AllArgsConstructor/@NoArgsConstructor/@RequiredArgsConstructor</h2><blockquote><p>自动生成全参构造函数和无参构造函数</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Builder"><a href="#Builder" class="headerlink" title="@Builder"></a>@Builder</h2><blockquote><p>自动生成建造者模式的bean</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    Person(String name, Integer age) &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Person.PersonBuilder <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>.PersonBuilder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PersonBuilder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">        PersonBuilder() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Person.PersonBuilder <span class="title function_">name</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Person.PersonBuilder <span class="title function_">age</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Person <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="built_in">this</span>.name, <span class="built_in">this</span>.age);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Person.PersonBuilder(name=&quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;, age=&quot;</span> + <span class="built_in">this</span>.age + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="EqualsAndHashCode"><a href="#EqualsAndHashCode" class="headerlink" title="@EqualsAndHashCode"></a>@EqualsAndHashCode</h2><blockquote><p>自动生成equals和hashcode方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public class Person &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private Integer age;</span><br><span class="line"></span><br><span class="line">    public Person() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean equals(Object o) &#123;</span><br><span class="line">        if (o == this) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else if (!(o instanceof Person)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Person other = (Person)o;</span><br><span class="line">            if (!other.canEqual(this)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                Object this$name = this.name;</span><br><span class="line">                Object other$name = other.name;</span><br><span class="line">                if (this$name == null) &#123;</span><br><span class="line">                    if (other$name != null) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (!this$name.equals(other$name)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object this$age = this.age;</span><br><span class="line">                Object other$age = other.age;</span><br><span class="line">                if (this$age == null) &#123;</span><br><span class="line">                    if (other$age != null) &#123;</span><br><span class="line">                        return false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else if (!this$age.equals(other$age)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected boolean canEqual(Object other) &#123;</span><br><span class="line">        return other instanceof Person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int hashCode() &#123;</span><br><span class="line">        int PRIME = true;</span><br><span class="line">        int result = 1;</span><br><span class="line">        Object $name = this.name;</span><br><span class="line">        int result = result * 59 + ($name == null ? 43 : $name.hashCode());</span><br><span class="line">        Object $age = this.age;</span><br><span class="line">        result = result * 59 + ($age == null ? 43 : $age.hashCode());</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h2 id="ToString"><a href="#ToString" class="headerlink" title="@ToString"></a>@ToString</h2><blockquote><p>自动生成toString()方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person(name=&quot;</span> + <span class="built_in">this</span>.name + <span class="string">&quot;, age=&quot;</span> + <span class="built_in">this</span>.age + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h2><blockquote><p>自动生成全参构造函数、Getter方法、equals方法、hashCode法、toString方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：@Value不会生成Setter方法</p><h2 id="Synchronized"><a href="#Synchronized" class="headerlink" title="@Synchronized"></a>@Synchronized</h2><blockquote><p>自动为被标记的方法添加synchronized锁</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">readLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">answerToLife</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Synchronized(&quot;readLock&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronizedExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">$LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">$lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">readLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>($LOCK) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">answerToLife</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>($lock) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(readLock) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Delegate"><a href="#Delegate" class="headerlink" title="@Delegate"></a>@Delegate</h2><blockquote><p>为标记属性生成委托方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegateExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;show...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="meta">@Delegate</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DelegateExample delegateExample;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的字节码文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegateExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DelegateExample</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;show...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DelegateExample delegateExample;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Demo</span><span class="params">(DelegateExample delegateExample)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegateExample = delegateExample;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 委托方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegateExample.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;lombok是一个编译级别的插件，它可以在项目编译的时候生成一些代码。通俗的说，lombok可以通过注解来标示生成&lt;code&gt;getter&lt;/code&gt; &lt;code&gt;settter&lt;/code&gt;等代码。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Lombok" scheme="https://blog.gcdd.top/tags/Lombok/"/>
    
  </entry>
  
  <entry>
    <title>消息队列（三）Apache ActiveMQ</title>
    <link href="https://blog.gcdd.top/p/32495/"/>
    <id>https://blog.gcdd.top/p/32495/</id>
    <published>2019-04-02T03:33:26.000Z</published>
    <updated>2023-08-30T04:52:53.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在Ubuntu上安装ActiveMQ"><a href="#在Ubuntu上安装ActiveMQ" class="headerlink" title="在Ubuntu上安装ActiveMQ"></a>在Ubuntu上安装ActiveMQ</h1><h2 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt dist-upgrade</span><br><span class="line">$ sudo apt autoremove</span><br><span class="line">$ sudo apt clean</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="搭建activemq服务"><a href="#搭建activemq服务" class="headerlink" title="搭建activemq服务"></a>搭建activemq服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> /home/active-mq</span><br><span class="line">$ <span class="built_in">cd</span> /home/active-mq</span><br><span class="line">$ wget http://www.apache.org/dist/activemq/5.15.9/apache-activemq-5.15.9-bin.tar.gz</span><br><span class="line"><span class="comment"># 具体版本请查看http://www.apache.org/dist/activemq</span></span><br><span class="line">$ tar -zxvf apache-activemq-5.15.9-bin.tar.gz</span><br><span class="line"><span class="comment"># 如果未安装jdk，执行 sudo apt-get install openjdk-8-jdk</span></span><br><span class="line">$ ./activemq start</span><br><span class="line">INFO: Loading <span class="string">&#x27;/home/active-mq/apache-activemq-5.15.9//bin/env&#x27;</span></span><br><span class="line">INFO: Using java <span class="string">&#x27;/usr/bin/java&#x27;</span></span><br><span class="line">INFO: Starting - inspect logfiles specified <span class="keyword">in</span> logging.properties and log4j.properties to get details</span><br><span class="line">INFO: pidfile created : <span class="string">&#x27;/home/active-mq/apache-activemq-5.15.9//data/activemq.pid&#x27;</span> (pid <span class="string">&#x27;6356&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>浏览器打开<a href="http://localhost:8161/admin/%EF%BC%8C%E8%BE%93%E5%85%A5admin%EF%BC%8Cadmin">http://localhost:8161/admin/，输入admin，admin</a></p><p><img src="https://i.loli.net/2019/04/02/5ca2dc9f9f76c.png"></p><p>至此，ActiveMQ搭建完成。</p><h1 id="理解JMS-Java-Message-Service"><a href="#理解JMS-Java-Message-Service" class="headerlink" title="理解JMS( Java Message Service)"></a>理解JMS( Java Message Service)</h1><p>Java消息服务指的是两个应用程序之间进行异步通信的API，它为标准消息协议和消息服务提供了一组通用接口，包括创建、发送、读取消息等，用于支持JAVA应用程序开发。</p><h2 id="JMS模型"><a href="#JMS模型" class="headerlink" title="JMS模型"></a>JMS模型</h2><ul><li><p><a href="https://zh.wikipedia.org/wiki/%E7%82%B9%E5%AF%B9%E7%82%B9">点对点</a>（P2P）或队列模型</p><ul><li>只有一个消费者将获得消息</li><li>生产者不需要在接收者消费该消息期间处于运行状态，接收者也同样不需要在消息发送时处于运行状态。</li><li>每一个成功处理的消息都由接收者签收</li></ul></li><li><p><a href="https://zh.wikipedia.org/wiki/%E5%8F%91%E5%B8%83/%E8%AE%A2%E9%98%85">发布/订阅</a>模型</p><ul><li>多个消费者可以获得消息</li><li>在发布者和订阅者之间存在时间依赖性。发布者需要创建一个订阅（subscription），以便客户能够购订阅。订阅者必须保持持续的活动状态以接收消息，除非订阅者创建了持久的订阅。在那种情况下，在订阅者未连接时发布的消息将在订阅者重新连接时重新发布。</li></ul></li></ul><h2 id="传统API"><a href="#传统API" class="headerlink" title="传统API"></a>传统API</h2><p>传统API提供的主要接口如下：</p><ul><li><p>ConnectionFactory：客户端用来创建连接的受管对象。简化API也会使用此接口。</p></li><li><p>Connection：客户端到JMS提供者之间的活动连接。</p></li><li><p>Session：发送和接收消息的一个单线程上下文。</p></li><li><p>MessageProducer：由Session创建的对象，用于发送消息到Queue或Topic</p></li><li><p>MessageConsumer：由Session创建的对象，用于接收Queue或Topic中的消息</p></li></ul><p><img src="https://i.loli.net/2019/04/02/5ca3451b03d54.jpg"></p><h2 id="简化API"><a href="#简化API" class="headerlink" title="简化API"></a>简化API</h2><p>简化API与传统API提供的消息功能是一样的，但是它需要的接口更少、使用更方便。 简化API提供的主要接口如下：</p><ul><li>ConnectionFactory：客户端用来创建连接的受管对象。传统API也会使用此接口。</li><li>JMSContext：客户端到JMS提供者之间的活动连接，以及发送和接收消息的一个单线程上下文。</li><li>JMSProducer：由JMSContext创建的对象，用于发送消息到Queue或Topic</li><li>JMSConsumer：由JMSContext创建的对象，用于接收Queue或Topic中的消息</li></ul><p><img src="https://i.loli.net/2019/04/02/5ca3456dda534.png"></p><p>在简化API中，一个JMSContext对象封装了传统API中Connection和Session两个对象的行为。</p><h2 id="开发一个JMS客户端"><a href="#开发一个JMS客户端" class="headerlink" title="开发一个JMS客户端"></a>开发一个JMS客户端</h2><p>一个使用传统API的JMS客户端典型的使用步骤如下：</p><ul><li>使用JNDI查找一个ConnectionFactory对象</li><li>使用JNDI查找一个或多个Destination对象</li><li>使用ConnectionFactory创建一个JMS Connection对象</li><li>使用Connection创建一个或多个JMS Session对象</li><li>使用Session和Destination对象创建需要的MessageProducer和MessageConsumer对象</li><li>通知Connection对象开始投递消息</li></ul><blockquote><p>Active MQ是完全实现JMS规范的JMS客户端</p></blockquote><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><h2 id="创建Hello-World项目"><a href="#创建Hello-World项目" class="headerlink" title="创建Hello World项目"></a>创建Hello World项目</h2><p>创建gradle项目，并编辑build.gradle</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile group: &#x27;org.apache.activemq&#x27;, name: &#x27;activemq-all&#x27;, version: &#x27;5.15.9&#x27;</span><br><span class="line">compile group: &#x27;com.fasterxml.jackson.core&#x27;, name: &#x27;jackson-databind&#x27;, version: &#x27;2.9.8&#x27;</span><br></pre></td></tr></table></figure><h2 id="创建生产者"><a href="#创建生产者" class="headerlink" title="创建生产者"></a>创建生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldProducer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建连接工厂</span></span><br><span class="line">            <span class="type">ActiveMQConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(<span class="string">&quot;vm://localhost&quot;</span>);</span><br><span class="line">            <span class="comment">// 2. 创建连接</span></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.createConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// 3. 创建会话</span></span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// 4. 创建目的地（主题或队列）</span></span><br><span class="line">            <span class="type">Destination</span> <span class="variable">destination</span> <span class="operator">=</span> session.createQueue(<span class="string">&quot;TEST.FOO&quot;</span>);</span><br><span class="line">            <span class="comment">// 5. 从会话创建到目的地的消息发布者</span></span><br><span class="line">            <span class="type">MessageProducer</span> <span class="variable">producer</span> <span class="operator">=</span> session.createProducer(destination);</span><br><span class="line">            producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">            <span class="comment">// 6. 创建并发布消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;Hello world! From: &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + <span class="built_in">this</span>.hashCode();</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> session.createTextMessage(text);</span><br><span class="line">            System.out.println(<span class="string">&quot;Sent message: &quot;</span> + message.hashCode() + <span class="string">&quot; : &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            producer.send(message);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7. 销毁资源</span></span><br><span class="line">            session.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught: &quot;</span> + e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建消费者"><a href="#创建消费者" class="headerlink" title="创建消费者"></a>创建消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldConsumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, ExceptionListener &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建连接工厂</span></span><br><span class="line">            <span class="type">ActiveMQConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(<span class="string">&quot;vm://localhost&quot;</span>);</span><br><span class="line">            <span class="comment">// 2. 创建连接</span></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.createConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// 3. 创建会话</span></span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> connection.createSession(<span class="literal">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// 4. 创建目的地（主题或队列）</span></span><br><span class="line">            <span class="type">Destination</span> <span class="variable">destination</span> <span class="operator">=</span> session.createQueue(<span class="string">&quot;TEST.FOO&quot;</span>);</span><br><span class="line">            <span class="comment">// 5. 从会话创建到目的地的消息消费者</span></span><br><span class="line">            <span class="type">MessageConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> session.createConsumer(destination);</span><br><span class="line">            <span class="comment">// 6. 等待接收消息</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> consumer.receive(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">if</span> (message <span class="keyword">instanceof</span> TextMessage) &#123;</span><br><span class="line">                <span class="type">TextMessage</span> <span class="variable">textMessage</span> <span class="operator">=</span> (TextMessage) message;</span><br><span class="line">                <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> textMessage.getText();</span><br><span class="line">                System.out.println(<span class="string">&quot;Received: &quot;</span> + text);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Received: &quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7. 销毁资源</span></span><br><span class="line">            consumer.close();</span><br><span class="line">            session.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught: &quot;</span> + e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(JMSException exception)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;JMS Exception occured.  Shutting down client.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldConsumer</span>(), <span class="literal">false</span>);</span><br><span class="line">        thread(<span class="keyword">new</span> <span class="title class_">HelloWorldProducer</span>(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">thread</span><span class="params">(Runnable runnable, <span class="type">boolean</span> daemon)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">brokerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">        brokerThread.setDaemon(daemon);</span><br><span class="line">        brokerThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行我们的测试程序，控制台将会打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Sent message: 507732978 : Thread-6</span><br><span class="line">Sent message: 2056557229 : Thread-0</span><br><span class="line">Sent message: 39234146 : Thread-8</span><br><span class="line">Sent message: 1100925878 : Thread-13</span><br><span class="line">Sent message: 1566392082 : Thread-17</span><br><span class="line">Sent message: 1329793151 : Thread-1</span><br><span class="line">Sent message: 988436874 : Thread-16</span><br><span class="line">Received: Hello world! From: Thread-6 : 1442537083</span><br><span class="line">Received: Hello world! From: Thread-1 : 1531760310</span><br><span class="line">Received: Hello world! From: Thread-0 : 1817576164</span><br><span class="line">Received: Hello world! From: Thread-8 : 262381200</span><br><span class="line">Received: Hello world! From: Thread-17 : 1647178742</span><br><span class="line">Received: Hello world! From: Thread-13 : 1610404140</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;在Ubuntu上安装ActiveMQ&quot;&gt;&lt;a href=&quot;#在Ubuntu上安装ActiveMQ&quot; class=&quot;headerlink&quot; title=&quot;在Ubuntu上安装ActiveMQ&quot;&gt;&lt;/a&gt;在Ubuntu上安装ActiveMQ&lt;/h1&gt;&lt;h2 id=&quot;系统初始化&quot;&gt;&lt;a href=&quot;#系统初始化&quot; class=&quot;headerlink&quot; title=&quot;系统初始化&quot;&gt;&lt;/a&gt;系统初始化&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt dist-upgrade&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt autoremove&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt clean&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="消息中间件" scheme="https://blog.gcdd.top/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="ActiveMQ" scheme="https://blog.gcdd.top/tags/ActiveMQ/"/>
    
  </entry>
  
  <entry>
    <title>消息队列（二）RabbitMQ</title>
    <link href="https://blog.gcdd.top/p/45284/"/>
    <id>https://blog.gcdd.top/p/45284/</id>
    <published>2019-04-01T10:20:18.000Z</published>
    <updated>2023-08-30T04:52:53.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在Ubuntu上安装RabbitMQ"><a href="#在Ubuntu上安装RabbitMQ" class="headerlink" title="在Ubuntu上安装RabbitMQ"></a>在Ubuntu上安装RabbitMQ</h1><h2 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt dist-upgrade</span><br><span class="line">$ sudo apt autoremove</span><br><span class="line">$ sudo apt clean</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 127.0.0.1 mq &gt; /etc/hosts</span><br><span class="line">$ <span class="built_in">echo</span> rabbitmq &gt; /etc/hostname</span><br><span class="line">$ <span class="built_in">export</span> HOSTNAME=mq</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="搭建rabbitmq服务"><a href="#搭建rabbitmq服务" class="headerlink" title="搭建rabbitmq服务"></a>搭建rabbitmq服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;deb http://www.rabbitmq.com/debian/ testing main&#x27;</span>| sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/rabbitmq.list</span><br><span class="line">$ wget -O- https://www.rabbitmq.com/rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install rabbitmq-server</span><br></pre></td></tr></table></figure><h2 id="创建管理账户"><a href="#创建管理账户" class="headerlink" title="创建管理账户"></a>创建管理账户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rabbitmqctl add_user <span class="built_in">test</span> <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ sudo rabbitmqctl add_vhost /test</span><br><span class="line">$ sudo rabbitmqctl set_user_tags <span class="built_in">test</span> administrator</span><br><span class="line"></span><br><span class="line">$ sudo rabbitmqctl set_permissions -p /test <span class="built_in">test</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br><span class="line">$ sudo rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br></pre></td></tr></table></figure><h1 id="AMQP规范"><a href="#AMQP规范" class="headerlink" title="AMQP规范"></a>AMQP规范</h1><p>AMQP（高级消息队列协议）是一个网络协议。它支持符合要求的客户端应用（application）和消息中间件代理（messaging middleware broker）之间进行通信。</p><h2 id="消息代理和他们所扮演的角色"><a href="#消息代理和他们所扮演的角色" class="headerlink" title="消息代理和他们所扮演的角色"></a>消息代理和他们所扮演的角色</h2><p>消息代理（message brokers）从发布者（publishers）亦称生产者（producers）那儿接收消息，并根据既定的路由规则把接收到的消息发送给处理消息的消费者（consumers）。</p><p>由于AMQP是一个网络协议，所以这个过程中的发布者，消费者，消息代理 可以存在于不同的设备上。</p><h2 id="AMQP-0-9-1-模型简介"><a href="#AMQP-0-9-1-模型简介" class="headerlink" title="AMQP 0-9-1 模型简介"></a>AMQP 0-9-1 模型简介</h2><p>AMQP 0-9-1的工作过程如下图：消息（message）被发布者（publisher）发送给交换机（exchange），交换机常常被比喻成邮局或者邮箱。然后交换机将收到的消息根据路由规则分发给绑定的队列（queue）。最后AMQP代理会将消息投递给订阅了此队列的消费者，或者消费者按照需求自行获取。</p><p><img src="https://i.loli.net/2019/04/02/5ca2b9fc49b65.png"></p><blockquote><p>队列，交换机和绑定统称为AMQP实体（AMQP entities）。</p></blockquote><h2 id="交换机和交换机类型"><a href="#交换机和交换机类型" class="headerlink" title="交换机和交换机类型"></a>交换机和交换机类型</h2><p>交换机是用来发送消息的AMQP实体。交换机拿到一个消息之后将它路由给一个或零个队列。它使用哪种路由算法是由交换机类型和被称作绑定（bindings）的规则所决定的。AMQP 0-9-1的代理提供了四种交换机</p><table><thead><tr><th>Name（交换机类型）</th><th>Default pre-declared names（预声明的默认名称）</th></tr></thead><tbody><tr><td>Direct exchange（直连交换机）</td><td>(Empty string) and amq.direct</td></tr><tr><td>Fanout exchange（扇型交换机）</td><td>amq.fanout</td></tr><tr><td>Topic exchange（主题交换机）</td><td>amq.topic</td></tr><tr><td>Headers exchange（头交换机）</td><td>amq.match (and amq.headers in RabbitMQ)</td></tr></tbody></table><p>除交换机类型外，在声明交换机时还可以附带许多其他的属性，其中最重要的几个分别是：</p><ul><li>Name</li><li>Durability （消息代理重启后，交换机是否还存在）</li><li>Auto-delete （当所有与之绑定的消息队列都完成了对此交换机的使用后，删掉它）</li><li>Arguments（依赖代理本身）</li></ul><p>交换机可以有两个状态：持久（durable）、暂存（transient）。持久化的交换机会在消息代理（broker）重启后依旧存在，而暂存的交换机则不会（它们需要在代理再次上线后重新被声明）。</p><h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2><p>AMQP中的队列（queue）跟其他消息队列或任务队列中的队列是很相似的：它们存储着即将被应用消费掉的消息。</p><p>队列跟交换机共享某些属性，但是队列也有一些另外的属性。</p><ul><li>Name</li><li>Durable（消息代理重启后，队列依旧存在）</li><li>Exclusive（只被一个连接（connection）使用，而且当连接关闭后队列即被删除）</li><li>Auto-delete（当最后一个消费者退订后即被删除）</li><li>Arguments（一些消息代理用他来完成类似与TTL的某些额外功能）</li></ul><p>队列在声明（declare）后才能被使用。如果一个队列尚不存在，声明一个队列会创建它。如果声明的队列已经存在，并且属性完全相同，那么此次声明不会对原有队列产生任何影响。如果声明中的属性与已存在队列的属性有差异，那么一个错误代码为406的通道级异常就会被抛出。</p><h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><p>绑定（Binding）是交换机（exchange）将消息（message）路由给队列（queue）所需遵循的规则。</p><h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><ul><li>将消息投递给应用 (“push API”)</li><li>应用根据需要主动获取消息 (“pull API”)</li></ul><h3 id="消息确认"><a href="#消息确认" class="headerlink" title="消息确认"></a>消息确认</h3><ul><li>自动确认：当消息代理（broker）将消息发送给应用后立即删除。</li><li>显式确认：待应用（application）发送一个确认回执（acknowledgement）后再删除消息。</li></ul><h3 id="拒绝消息"><a href="#拒绝消息" class="headerlink" title="拒绝消息"></a>拒绝消息</h3><p>当拒绝一条消息时，可以</p><ul><li>销毁消息</li><li>重新放入消息队列</li></ul><p>当此队列只有一个消费者时，请确认不要由于拒绝消息并且选择了重新放入队列的行为而引起消息在同一个消费者身上无限循环的情况发生。</p><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><ul><li>生产(Producing)的意思就是发送。发送消息的程序就是一个生产者(producer)。我们一般用”P”来表示:<br><img src="https://i.loli.net/2019/04/02/5ca23898ea5b0.png"></li><li>队列(queue)就是存在于RabbitMQ中邮箱的名称。虽然消息的传输经过了RabbitMQ和你的应用程序，但是它只能被存储于队列当中。实质上队列就是个巨大的消息缓冲区，它的大小只受主机内存和硬盘限制。多个生产者（producers）可以把消息发送给同一个队列，同样，多个消费者（consumers）也能够从同一个队列（queue）中获取数据。队列可以绘制成这样（图上是队列的名称）：<br><img src="https://i.loli.net/2019/04/02/5ca238ab81f7c.png"></li><li>在这里，消费（Consuming）和接收(receiving)是同一个意思。一个消费者（consumer）就是一个等待获取消息的程序。我们把它绘制为”C”：<br><img src="https://i.loli.net/2019/04/02/5ca238bd84a4a.png"></li></ul><p>需要指出的是生产者、消费者、代理需不要待在同一个设备上；事实上大多数应用也确实不在会将他们放在一台机器上。</p><p>创建gradle项目，并配置build.gradle：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile group: <span class="string">&#x27;com.rabbitmq&#x27;</span>, name: <span class="string">&#x27;amqp-client&#x27;</span>, version: <span class="string">&#x27;5.6.0&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="创建生产者"><a href="#创建生产者" class="headerlink" title="创建生产者"></a>创建生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Send</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1. 创建RabbitMQ连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2. 设置host,rabbitmq-server的监听地址</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="comment">// 4. 创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 5. 连接到具体频道</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="comment">// 6. 发布消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建消费者"><a href="#创建消费者" class="headerlink" title="创建消费者"></a>创建消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Recv</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="comment">// 4. 创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot; [*] Waiting for messages. To exit press CTRL+C&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出，生产者和消费者需要声明是同一个队列</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>我们先执行Send.main，控制台将打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &#x27;Hello World!&#x27;</span><br></pre></td></tr></table></figure><p>然后执行Recv.main，控制台将打印：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">[x] Received &#x27;Hello World!&#x27;</span><br></pre></td></tr></table></figure><h1 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h1><p><img src="https://i.loli.net/2019/04/01/5ca21485049c7.png"></p><p>工作队列（又称：任务队列——Task Queues）是为了避免等待一些占用大量资源、时间的操作。当我们把任务（Task）当作消息发送到队列中，一个运行在后台的工作者（worker）进程就会取出任务然后处理。当你运行多个工作者（workers），任务就会在它们之间共享。</p><p>这个概念在网络应用中是非常有用的，它可以在短暂的HTTP请求中处理一些复杂的任务。</p><p>修改<a href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85">Send.java</a>代码，来间隔10秒发送一个消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> String.format(<span class="string">&quot;发送第%d条消息&quot;</span>, i);</span><br><span class="line">    <span class="comment">// 6. 发布消息</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">    System.out.println(<span class="string">&quot; [x] Sent &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改<a href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85">Recv.java</a>，来完成一个任务，这里，假装任务执行需要耗时1s：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doWork(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot; [x] Done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">(String task)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> ch : task.toCharArray()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们先开启Recv.java，然后开启Send.java，控制台将会打印</p><p>Send.java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &#x27;发送第1条消息&#x27;</span><br><span class="line">[x] Sent &#x27;发送第2条消息&#x27;</span><br><span class="line">[x] Sent &#x27;发送第3条消息&#x27;</span><br></pre></td></tr></table></figure><p>Recv.java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">[x] Received &#x27;发送第1条消息&#x27;</span><br><span class="line">[x] Done</span><br><span class="line">[x] Received &#x27;发送第2条消息&#x27;</span><br><span class="line">[x] Done</span><br><span class="line">[x] Received &#x27;发送第3条消息&#x27;</span><br></pre></td></tr></table></figure><h2 id="循环调度"><a href="#循环调度" class="headerlink" title="循环调度"></a>循环调度</h2><p>使用工作队列的一个好处就是它能够并行的处理队列。如果堆积了很多任务，我们只需要添加更多的工作者（workers）就可以了，扩展很简单。</p><p>让我们尝试同时运行两个worker实例，他们都会从队列中获取消息：</p><p>Send.java</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &#x27;发送第1条消息&#x27;</span><br><span class="line">[x] Sent &#x27;发送第2条消息&#x27;</span><br><span class="line">[x] Sent &#x27;发送第3条消息&#x27;</span><br></pre></td></tr></table></figure><p>Recv.java-1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">[x] Received &#x27;发送第1条消息&#x27;</span><br><span class="line">[x] Done</span><br><span class="line">[x] Received &#x27;发送第3条消息&#x27;</span><br><span class="line">[x] Done</span><br></pre></td></tr></table></figure><p>Recv.java-2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">[x] Received &#x27;发送第2条消息&#x27;</span><br><span class="line">[x] Done</span><br></pre></td></tr></table></figure><p>默认来说，RabbitMQ会按顺序得把消息发送给每个消费者（consumer）。平均每个消费者都会收到同等数量得消息。这种发送消息得方式叫做——轮询（round-robin）。试着添加三个或更多得工作者（workers）。</p><h2 id="消息确认-1"><a href="#消息确认-1" class="headerlink" title="消息确认"></a>消息确认</h2><p>当处理一个比较耗时得任务的时候，你也许想知道消费者（consumers）是否运行到一半就挂掉。当前的代码中，当消息被RabbitMQ发送给消费者（consumers）之后，马上就会在内存中移除。这种情况，你只要把一个工作者（worker）停止，正在处理的消息就会丢失。同时，所有发送到这个工作者的还没有处理的消息都会丢失。</p><p>我们不想丢失任何任务消息。如果一个工作者（worker）挂掉了，我们希望任务会重新发送给其他的工作者（worker）。</p><p>为了防止消息丢失，RabbitMQ提供了消息响应（acknowledgments）。消费者会通过一个ack（响应），告诉RabbitMQ已经收到并处理了某条消息，然后RabbitMQ就会释放并删除这条消息。</p><p>如果消费者（consumer）挂掉了，没有发送响应，RabbitMQ就会认为消息没有被完全处理，然后重新发送给其他消费者（consumer）。这样，及时工作者（workers）偶尔的挂掉，也不会丢失消息。</p><p>消息是没有超时这个概念的；当工作者与它断开连的时候，RabbitMQ会重新发送消息。这样在处理一个耗时非常长的消息任务的时候就不会出问题了。</p><p>消息响应默认是开启的。之前的例子中我们可以使用no_ack=True标识把它关闭。是时候移除这个标识了，当工作者（worker）完成了任务，就发送一个响应。</p><p>修改Worker.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一次只接受一条消息</span></span><br><span class="line">channel.basicQos(<span class="number">1</span>);</span><br><span class="line"><span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot; [x] Received &#x27;&quot;</span> + message + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doWork(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">channel.basicConsume(QUEUE_NAME, autoAck, deliverCallback, consumerTag -&gt; &#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>运行上面的代码，我们发现即使使用CTRL+C杀掉了一个工作者（worker）进程，消息也不会丢失。当工作者（worker）挂掉这后，所有没有响应的消息都会重新发送。</p><h2 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h2><p>如果你没有特意告诉RabbitMQ，那么在它退出或者崩溃的时候，将会丢失所有队列和消息。为了确保信息不会丢失，有两个事情是需要注意的：我们必须把“队列”和“消息”设为持久化。</p><p>首先，为了不让队列消失，需要把队列声明为持久化（durable）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">channel.queueDeclare(QUEUE_NAME, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>尽管这行代码本身是正确的，但是仍然不会正确运行。因为我们已经定义过一个叫hello的非持久化队列。RabbitMq不允许你使用不同的参数重新定义一个队列，它会返回一个错误。但我们现在使用一个快捷的解决方法——用不同的名字，例如task_queue。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;task_queue&quot;</span>, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>这时候，我们就可以确保在RabbitMq重启之后queue_declare队列不会丢失。现在我们需要将消息标记为持久性 - 通过将MessageProperties（实现BasicProperties）设置为值PERSISTENT_TEXT_PLAIN。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.MessageProperties;</span><br><span class="line"></span><br><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;task_queue&quot;</span>,</span><br><span class="line">            MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">            message.getBytes());</span><br></pre></td></tr></table></figure><h2 id="公平调度"><a href="#公平调度" class="headerlink" title="公平调度"></a>公平调度</h2><p>你应该已经发现，它仍旧没有按照我们期望的那样进行分发。比如有两个工作者（workers），处理奇数消息的比较繁忙，处理偶数消息的比较轻松。然而RabbitMQ并不知道这些，它仍然一如既往的派发消息。</p><p>这时因为RabbitMQ只管分发进入队列的消息，不会关心有多少消费者（consumer）没有作出响应。它盲目的把第n-th条消息发给第n-th个消费者。</p><p><img src="https://i.loli.net/2019/04/02/5ca238f761f47.png"></p><p>我们可以使用basicQos方法，并设置<code>prefetchCount = 1</code>。这样是告诉RabbitMQ，再同一时刻，不要发送超过1条消息给一个工作者（worker），直到它已经处理了上一条消息并且作出了响应。这样，RabbitMQ就会把消息分发给下一个空闲的工作者（worker）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">prefetchCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">channel.basicQos(prefetchCount);</span><br></pre></td></tr></table></figure><h1 id="发布／订阅"><a href="#发布／订阅" class="headerlink" title="发布／订阅"></a>发布／订阅</h1><p>在上篇教程中，我们搭建了一个工作队列，每个任务只分发给一个工作者（worker）。在本篇教程中，我们要做的跟之前完全不一样 —— 分发一个消息给多个消费者（consumers）。这种模式被称为“发布／订阅”。</p><p>为了描述这种模式，我们将会构建一个简单的日志系统。</p><h2 id="交换机（Exchanges）"><a href="#交换机（Exchanges）" class="headerlink" title="交换机（Exchanges）"></a>交换机（Exchanges）</h2><p>RabbitMQ中完整的消息模型：</p><ul><li>发布者（producer）是发布消息的应用程序。</li><li>队列（queue）用于消息存储的缓冲。</li><li>消费者（consumer）是接收消息的应用程序。</li></ul><p>RabbitMQ消息模型的核心理念是：发布者（producer）不会直接发送任何消息给队列。事实上，发布者（producer）甚至不知道消息是否已经被投递到队列。</p><p>发布者（producer）只需要把消息发送给一个交换机（exchange）。交换机非常简单，它一边从发布者方接收消息，一边把消息推送到队列。交换机必须知道如何处理它接收到的消息，是应该推送到指定的队列还是是多个队列，或者是直接忽略消息。这些规则是通过交换机类型（exchange type）来定义的。</p><p><img src="https://i.loli.net/2019/04/01/5ca22e6de6cab.png"></p><p>有几个可供选择的交换机类型：直连交换机（direct）, 主题交换机（topic）, （头交换机）headers和 扇型交换机（fanout）。我们在这里主要说明最后一个 —— 扇型交换机（fanout）。先创建一个fanout类型的交换机，命名为logs：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.exchangeDeclare(<span class="string">&quot;logs&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br></pre></td></tr></table></figure><p>扇型交换机（fanout）很简单，你可能从名字上就能猜测出来，它把消息发送给它所知道的所有队列。</p><p>现在，我们就可以发送消息到一个具名交换机了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish( <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br></pre></td></tr></table></figure><h2 id="临时队列"><a href="#临时队列" class="headerlink" title="临时队列"></a>临时队列</h2><p>要创建一个临时队列，我们需要做两件事情：</p><ol><li><p>当我们连接上RabbitMQ的时候，我们需要一个全新的、空的队列。我们可以手动创建一个随机的队列名，或者让服务器为我们选择一个随机的队列名（推荐）。</p></li><li><p>当与消费者（consumer）断开连接的时候，这个队列应当被立即删除。</p></li></ol><p>在Java客户端中，当我们没有向queueDeclare（）提供参数时，我们使用生成的名称创建一个非持久的，独占的自动删除队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务器分配的随机队列名，可能像这样 amq.gen-U0srCoW8TsaXjNh73pnVAw==</span></span><br><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br></pre></td></tr></table></figure><h2 id="绑定（Bindings）"><a href="#绑定（Bindings）" class="headerlink" title="绑定（Bindings）"></a>绑定（Bindings）</h2><p><img src="https://i.loli.net/2019/04/01/5ca230f4266fc.png"></p><p>我们已经创建了一个扇型交换机（fanout）和一个队列。现在我们需要告诉交换机如何发送消息给我们的队列。交换器和队列之间的联系我们称之为绑定（binding）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queueName, <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure><h1 id="路由-Routing"><a href="#路由-Routing" class="headerlink" title="路由(Routing)"></a>路由(Routing)</h1><p>前面的例子，我们已经创建过绑定（bindings），代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure><p>绑定（binding）是指交换机（exchange）和队列（queue）的关系。可以简单理解为：这个队列（queue）对这个交换机（exchange）的消息感兴趣。</p><p>绑定的时候可以带上一个额外的routing_key参数。为了避免与basic_publish的参数混淆，我们把它叫做绑定键（binding key）。以下是如何创建一个带绑定键的绑定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;black&quot;</span>);</span><br></pre></td></tr></table></figure><p>绑定键的意义取决于交换机（exchange）的类型。我们之前使用过的扇型交换机（fanout exchanges）会忽略这个值。</p><h2 id="直连交换机（Direct-exchange）"><a href="#直连交换机（Direct-exchange）" class="headerlink" title="直连交换机（Direct exchange）"></a>直连交换机（Direct exchange）</h2><p>我们的日志系统广播所有的消息给所有的消费者（consumers）。我们打算扩展它，使其基于日志的严重程度进行消息过滤。</p><p>我们使用的扇型交换机（fanout exchange）没有足够的灵活性 —— 它能做的仅仅是广播。</p><p>我们将会使用直连交换机（direct exchange）来代替。路由的算法很简单 —— 交换机将会对绑定键（binding key）和路由键（routing key）进行精确匹配，从而确定消息该分发到哪个队列。</p><p>下图能够很好的描述这个场景：</p><p><img src="https://i.loli.net/2019/04/01/5ca23254e4784.png"></p><p>在这个场景中，我们可以看到直连交换机 X和两个队列进行了绑定。第一个队列使用orange作为绑定键，第二个队列有两个绑定，一个使用black作为绑定键，另外一个使用green。</p><p>这样以来，当路由键为orange的消息发布到交换机，就会被路由到队列Q1。路由键为black或者green的消息就会路由到Q2。其他的所有消息都将会被丢弃。</p><h2 id="多个绑定（Multiple-bindings）"><a href="#多个绑定（Multiple-bindings）" class="headerlink" title="多个绑定（Multiple bindings）"></a>多个绑定（Multiple bindings）</h2><p><img src="https://i.loli.net/2019/04/01/5ca2330e8a92f.png"></p><p>多个队列使用相同的绑定键是合法的。这个例子中，我们可以添加一个X和Q1之间的绑定，使用black绑定键。这样一来，直连交换机就和扇型交换机的行为一样，会将消息广播到所有匹配的队列。带有black路由键的消息会同时发送到Q1和Q2。</p><h2 id="发送日志"><a href="#发送日志" class="headerlink" title="发送日志"></a>发送日志</h2><p>我们将会发送消息到一个直连交换机，把日志级别作为路由键。这样接收日志的脚本就可以根据严重级别来选择它想要处理的日志。我们先看看发送日志。</p><p>我们需要创建一个交换机（exchange）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;direct&quot;</span>);</span><br></pre></td></tr></table></figure><p>然后我们发送一则消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(EXCHANGE_NAME, severity, <span class="literal">null</span>, message.getBytes());</span><br></pre></td></tr></table></figure><h2 id="订阅"><a href="#订阅" class="headerlink" title="订阅"></a>订阅</h2><p>处理接收消息的方式和之前差不多，只有一个例外，我们将会为我们感兴趣的每个严重级别分别创建一个新的绑定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(String severity : argv)&#123;</span><br><span class="line">  channel.queueBind(queueName, EXCHANGE_NAME, severity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p><img src="https://i.loli.net/2019/04/01/5ca2339a9dd56.png"></p><p><a href="">Routing</a></p><h1 id="主题交换机"><a href="#主题交换机" class="headerlink" title="主题交换机"></a>主题交换机</h1><p>直连交换机的限制 —— 没办法基于多个标准执行路由操作。</p><p>发送到主题交换机（topic exchange）的消息不可以携带随意什么样子的路由键（routing_key），它的路由键必须是一个由<code>.</code>分隔开的词语列表。这些单词随便是什么都可以，但是最好是跟携带它们的消息有关系的词汇。以下是几个推荐的例子：”stock.usd.nyse”, “nyse.vmw”, “quick.orange.rabbit”。词语的个数可以随意，但是不要超过255字节。</p><p>绑定键也必须拥有同样的格式。主题交换机背后的逻辑跟直连交换机很相似 —— 一个携带着特定路由键的消息会被主题交换机投递给绑定键与之想匹配的队列。但是它的绑定键和路由键有两个特殊应用方式：</p><ul><li><code>*</code> (星号) 用来表示一个单词.</li><li><code>#</code> (井号) 用来表示任意数量（零个或多个）单词。</li></ul><p>下边用图说明：</p><p><img src="https://i.loli.net/2019/04/02/5ca23915b99b2.png"></p><p>我们创建了三个绑定：Q1的绑定键为 <code>*.orange.*</code>，Q2的绑定键为 <code>*.*.rabbit</code> 和 <code>lazy.#</code> 。</p><p>这三个绑定键被可以总结为：</p><ul><li>Q1 对<em>所有的桔黄色动物</em>都感兴趣。</li><li>Q2 则是对<em>所有的兔子</em>和<em>所有懒惰的动物</em>感兴趣。</li></ul><blockquote><p>主题交换机是很强大的，它可以表现出跟其他交换机类似的行为</p><p>当一个队列的绑定键为 “#”（井号） 的时候，这个队列将会无视消息的路由键，接收所有的消息。</p><p>当 <code>*</code> (星号) 和 <code>#</code> (井号) 这两个特殊字符都未在绑定键中出现的时候，此时主题交换机就拥有的直连交换机的行为。</p></blockquote><h1 id="远程过程调用（RPC）"><a href="#远程过程调用（RPC）" class="headerlink" title="远程过程调用（RPC）"></a>远程过程调用（RPC）</h1><p>如果我们需要将一个函数运行在远程计算机上并且等待从那儿获取结果时，这种模式通常被称为远程过程调用（Remote Procedure Call）或者RPC。</p><p>我们会使用RabbitMQ来构建一个RPC系统：包含一个客户端和一个RPC服务器。</p><h2 id="客户端接口"><a href="#客户端接口" class="headerlink" title="客户端接口"></a>客户端接口</h2><p>为了展示RPC服务如何使用，我们创建了一个简单的客户端类。它会暴露出一个名为“call”的方法用来发送一个RPC请求，并且在收到回应前保持阻塞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FibonacciRpcClient</span> <span class="variable">fibonacciRpc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FibonacciRpcClient</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> fibonacciRpc.call(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">System.out.println( <span class="string">&quot;fib(4) is &quot;</span> + result);</span><br></pre></td></tr></table></figure><h3 id="回调队列"><a href="#回调队列" class="headerlink" title="回调队列"></a>回调队列</h3><p>一般来说通过RabbitMQ来实现RPC是很容易的。一个客户端发送请求信息，服务器端将其应用到一个回复信息中。为了接收到回复信息，客户端需要在发送请求的时候同时发送一个回调队列（callback queue）的地址。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">callbackQueueName = channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line"><span class="type">BasicProperties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicProperties</span></span><br><span class="line">                            .Builder()</span><br><span class="line">                            .replyTo(callbackQueueName)</span><br><span class="line">                            .build();</span><br><span class="line"></span><br><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;rpc_queue&quot;</span>, props, message.getBytes());</span><br></pre></td></tr></table></figure><blockquote><h4 id="消息属性"><a href="#消息属性" class="headerlink" title="消息属性"></a>消息属性</h4><p>AMQP协议给消息预定义了一系列的14个属性。大多数属性很少会用到，除了以下几个：</p><ul><li>delivery_mode（投递模式）：将消息标记为持久的（值为2）或暂存的（除了2之外的其他任何值）。第二篇教程里接触过这个属性，记得吧？</li><li>content_type（内容类型）:用来描述编码的mime-type。例如在实际使用中常常使用application/json来描述JOSN编码类型。</li><li>reply_to（回复目标）：通常用来命名回调队列。</li><li>correlation_id（关联标识）：用来将RPC的响应和请求关联起来。</li></ul></blockquote><h3 id="关联标识"><a href="#关联标识" class="headerlink" title="关联标识"></a>关联标识</h3><p>上边介绍的方法中，我们建议给每一个RPC请求新建一个回调队列。这不是一个高效的做法，幸好这儿有一个更好的办法 —— 我们可以为每个客户端只建立一个独立的回调队列。</p><p>这就带来一个新问题，当此队列接收到一个响应的时候它无法辨别出这个响应是属于哪个请求的。<strong>correlation_id</strong> 就是为了解决这个问题而来的。我们给每个请求设置一个独一无二的值。稍后，当我们从回调队列中接收到一个消息的时候，我们就可以查看这条属性从而将响应和请求匹配起来。如果我们接手到的消息的correlation_id是未知的，那就直接销毁掉它，因为它不属于我们的任何一条请求。</p><p>为什么我们接收到未知消息的时候不抛出一个错误，而是要将它忽略掉？这是为了解决服务器端有可能发生的竞争情况。尽管可能性不大，但RPC服务器还是有可能在已将应答发送给我们但还未将确认消息发送给请求的情况下死掉。如果这种情况发生，RPC在重启后会重新处理请求。这就是为什么我们必须在客户端优雅的处理重复响应，同时RPC也需要尽可能保持幂等性。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="https://i.loli.net/2019/04/02/5ca236b2abcea.png"></p><p>我们的RPC如此工作:</p><ul><li>当客户端启动的时候，它创建一个匿名独享的回调队列。</li><li>在RPC请求中，客户端发送带有两个属性的消息：一个是设置回调队列的 <em>reply_to</em> 属性，另一个是设置唯一值的 <em>correlation_id</em> 属性。</li><li>将请求发送到一个 <em>rpc_queue</em> 队列中。</li><li>RPC工作者（又名：服务器）等待请求发送到这个队列中来。当请求出现的时候，它执行他的工作并且将带有执行结果的消息发送给reply_to字段指定的队列。</li><li>客户端等待回调队列里的数据。当有消息出现的时候，它会检查correlation_id属性。如果此属性的值与请求匹配，将它返回给应用。</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;在Ubuntu上安装RabbitMQ&quot;&gt;&lt;a href=&quot;#在Ubuntu上安装RabbitMQ&quot; class=&quot;headerlink&quot; title=&quot;在Ubuntu上安装RabbitMQ&quot;&gt;&lt;/a&gt;在Ubuntu上安装RabbitMQ&lt;/h1&gt;&lt;h2 id=&quot;系统初始化&quot;&gt;&lt;a href=&quot;#系统初始化&quot; class=&quot;headerlink&quot; title=&quot;系统初始化&quot;&gt;&lt;/a&gt;系统初始化&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt dist-upgrade&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt autoremove&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ sudo apt clean&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; 127.0.0.1 mq &amp;gt; /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; rabbitmq &amp;gt; /etc/hostname&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; HOSTNAME=mq&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="消息中间件" scheme="https://blog.gcdd.top/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="RabbitMQ" scheme="https://blog.gcdd.top/tags/RabbitMQ/"/>
    
  </entry>
  
  <entry>
    <title>消息队列（一）简介</title>
    <link href="https://blog.gcdd.top/p/27791/"/>
    <id>https://blog.gcdd.top/p/27791/</id>
    <published>2019-04-01T10:01:43.000Z</published>
    <updated>2023-08-30T04:52:53.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="消息队列-MQ-概述"><a href="#消息队列-MQ-概述" class="headerlink" title="消息队列(MQ)概述"></a>消息队列(MQ)概述</h1><p>消息队列（Message Queue），是分布式系统中重要的组件，其通用的使用场景可以简单地描述为：</p><blockquote><p>当不需要立即获得结果，但是并发量又需要进行控制的时候，差不多就是需要使用消息队列的时候。</p></blockquote><p>消息队列主要解决了应用耦合、异步处理、流量削锋等问题。</p><span id="more"></span><p>当前使用较多的消息队列有RabbitMQ、RocketMQ、ActiveMQ、Kafka、ZeroMQ、MetaMq等，而部分数据库如Redis、Mysql以及phxsql也可实现消息队列的功能。</p><h1 id="消息队列使用场景"><a href="#消息队列使用场景" class="headerlink" title="消息队列使用场景"></a>消息队列使用场景</h1><p>消息队列在实际应用中包括如下四个场景：</p><ul><li>应用耦合：多应用间通过消息队列对同一消息进行处理，避免调用接口失败导致整个过程失败；</li><li>异步处理：多应用对消息队列中同一消息进行处理，应用间并发处理消息，相比串行处理，减少处理时间；</li><li>限流削峰：广泛应用于秒杀或抢购活动中，避免流量过大导致应用系统挂掉的情况；</li><li>消息驱动的系统：系统分为消息队列、消息生产者、消息消费者，生产者负责产生消息，消费者(可能有多个)负责对消息进行处理；</li></ul><p>下面详细介绍上述四个场景以及消息队列如何在上述四个场景中使用：</p><h2 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h2><p>具体场景：用户为了使用某个应用，进行注册，系统需要发送注册邮件并验证<a href="https://cloud.tencent.com/product/sms">短信</a>。对这两个操作的处理方式有两种：串行及并行。</p><h3 id="串行方式"><a href="#串行方式" class="headerlink" title="串行方式"></a>串行方式</h3><p>新注册信息生成后，先发送注册邮件，再发送验证短信；</p><p><img src="https://i.loli.net/2019/04/01/5ca1e27b495ce.png"></p><p>在这种方式下，需要最终发送验证短信后再返回给客户端。</p><h3 id="并行处理"><a href="#并行处理" class="headerlink" title="并行处理"></a>并行处理</h3><p>新注册信息写入后，由发短信和发邮件并行处理；</p><p><img src="https://i.loli.net/2019/04/01/5ca1e29f4742c.png"></p><p>在这种方式下，发短信和发邮件 需处理完成后再返回给客户端。</p><p>假设以上三个子系统处理的时间均为50ms，且不考虑网络延迟，则总的处理时间：</p><blockquote><p>串行：50+50+50=150ms  并行：50+50 = 100ms</p></blockquote><h3 id="使用消息队列"><a href="#使用消息队列" class="headerlink" title="使用消息队列"></a>使用消息队列</h3><p><img src="https://i.loli.net/2019/04/01/5ca1e2d1891c2.png"></p><p>并在写入消息队列后立即返回成功给客户端，则总的响应时间依赖于写入消息队列的时间，而写入消息队列的时间本身是可以很快的，基本可以忽略不计，因此总的处理时间相比串行提高了2倍，相比并行提高了一倍；</p><h2 id="应用耦合"><a href="#应用耦合" class="headerlink" title="应用耦合"></a>应用耦合</h2><p>具体场景：用户使用QQ相册上传一张图片，<a href="https://cloud.tencent.com/product/facerecognition">人脸识别</a>系统会对该图片进行人脸识别，一般的做法是，服务器接收到图片后，图片上传系统立即调用人脸识别系统，调用完成后再返回成功，如下图所示：</p><p><img src="https://i.loli.net/2019/04/01/5ca1e2f60d0ce.png"></p><p>该方法有如下缺点：</p><ul><li>人脸识别系统被调失败，导致图片上传失败；</li><li>延迟高，需要人脸识别系统处理完成后，再返回给客户端，即使用户并不需要立即知道结果；</li><li>图片上传系统与人脸识别系统之间互相调用，需要做耦合；</li></ul><p>若使用消息队列：</p><p><img src="https://i.loli.net/2019/04/01/5ca1e3363239e.png"></p><p>客户端上传图片后，图片上传系统将图片信息如uin、批次写入消息队列，直接返回成功；而人脸识别系统则定时从消息队列中取数据，完成对新增图片的识别。 </p><p>此时图片上传系统并不需要关心人脸识别系统是否对这些图片信息的处理、以及何时对这些图片信息进行处理。事实上，由于用户并不需要立即知道人脸识别结果，人脸识别系统可以选择不同的调度策略，按照闲时、忙时、正常时间，对队列中的图片信息进行处理。</p><h2 id="限流削峰"><a href="#限流削峰" class="headerlink" title="限流削峰"></a>限流削峰</h2><p>具体场景：购物网站开展秒杀活动，一般由于瞬时访问量过大，服务器接收过大，会导致流量暴增，相关系统无法处理请求甚至崩溃。而加入消息队列后，系统可以从消息队列中取数据，相当于消息队列做了一次缓冲。</p><p><img src="https://i.loli.net/2019/04/01/5ca1e375ac957.png"></p><p>该方法有如下优点： </p><ol><li>请求先入消息队列，而不是由业务处理系统直接处理，做了一次缓冲,极大地减少了业务处理系统的压力； </li><li> 队列长度可以做限制，事实上，秒杀时，后入队列的用户无法秒杀到商品，这些请求可以直接被抛弃，返回活动已结束或商品已售完信息；</li></ol><h2 id="消息驱动的系统"><a href="#消息驱动的系统" class="headerlink" title="消息驱动的系统"></a>消息驱动的系统</h2><p>具体场景：用户新上传了一批照片， 人脸识别系统需要对这个用户的所有照片进行聚类，聚类完成后由对账系统重新生成用户的人脸索引(加快查询)。这三个子系统间由消息队列连接起来，前一个阶段的处理结果放入队列中，后一个阶段从队列中获取消息继续处理。</p><p><img src="https://i.loli.net/2019/04/01/5ca1e3cbaddd7.png"></p><p>该方法有如下优点：</p><ul><li>避免了直接调用下一个系统导致当前系统失败；</li><li>每个子系统对于消息的处理方式可以更为灵活，可以选择收到消息时就处理，可以选择定时处理，也可以划分时间段按不同处理速度处理；</li></ul><h1 id="消息队列的两种模式"><a href="#消息队列的两种模式" class="headerlink" title="消息队列的两种模式"></a>消息队列的两种模式</h1><p>消息队列包括两种模式，点对点模式（point to point， queue）和发布/订阅模式（publish/subscribe，topic）。</p><h2 id="点对点模式"><a href="#点对点模式" class="headerlink" title="点对点模式"></a>点对点模式</h2><ul><li>消息队列</li><li>发送者 (生产者)</li><li>接收者（消费者）</li></ul><p><img src="https://i.loli.net/2019/04/01/5ca1e40d3695e.png"></p><p>消息发送者生产消息发送到queue中，然后消息接收者从queue中取出并且消费消息。消息被消费以后，queue中不再有存储，所以消息接收者不可能消费到已经被消费的消息。</p><p>点对点模式特点：</p><ul><li>每个消息只有一个接收者（Consumer）(即一旦被消费，消息就不再在消息队列中)；</li><li>发送者和接收者间没有依赖性，发送者发送消息之后，不管有没有接收者在运行，都不会影响到发送者下次发送消息；</li><li>接收者在成功接收消息之后需向队列应答成功，以便消息队列删除当前接收的消息；</li></ul><h2 id="发布-订阅模式"><a href="#发布-订阅模式" class="headerlink" title="发布/订阅模式"></a>发布/订阅模式</h2><p>发布/订阅模式下包括三个角色：</p><ul><li>角色主题（Topic）</li><li>发布者(Publisher)</li><li>订阅者(Subscriber)</li></ul><p><img src="https://i.loli.net/2019/04/01/5ca1e45320c45.png"></p><p>发布者将消息发送到Topic,系统将这些消息传递给多个订阅者。</p><p>发布/订阅模式特点：</p><ul><li>每个消息可以有多个订阅者；</li><li>发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息；</li><li>为了消费消息，订阅者需要提前订阅该角色主题，并保持在线运行；</li></ul><h1 id="常用消息队列"><a href="#常用消息队列" class="headerlink" title="常用消息队列"></a>常用消息队列</h1><ul><li><a href="https://www.rabbitmq.com/">RabbitMQ</a></li><li><a href="http://activemq.apache.org/">ActiveMQ</a></li><li><a href="https://github.com/alibaba/RocketMQ">RocketMQ</a></li><li><a href="http://kafka.apache.org/">Apache Kafka</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;消息队列-MQ-概述&quot;&gt;&lt;a href=&quot;#消息队列-MQ-概述&quot; class=&quot;headerlink&quot; title=&quot;消息队列(MQ)概述&quot;&gt;&lt;/a&gt;消息队列(MQ)概述&lt;/h1&gt;&lt;p&gt;消息队列（Message Queue），是分布式系统中重要的组件，其通用的使用场景可以简单地描述为：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当不需要立即获得结果，但是并发量又需要进行控制的时候，差不多就是需要使用消息队列的时候。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;消息队列主要解决了应用耦合、异步处理、流量削锋等问题。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="消息中间件" scheme="https://blog.gcdd.top/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Spring IoC Container源码分析（二）-bean初始化流程</title>
    <link href="https://blog.gcdd.top/p/60483/"/>
    <id>https://blog.gcdd.top/p/60483/</id>
    <published>2019-03-29T02:11:12.000Z</published>
    <updated>2023-08-30T04:52:53.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>Person实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><p>xml bean配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.gcdd1993.spring.framework.base.domain.Person&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AbstractApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">applicationContext.getBean(<span class="string">&quot;person&quot;</span>);</span><br></pre></td></tr></table></figure><p>使用Debug进入<code>ClassPathXmlApplicationContext</code>构造函数，源码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(String[] configLocations, <span class="type">boolean</span> refresh, ApplicationContext parent)</span></span><br><span class="line">        <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    <span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="super-parent"><a href="#super-parent" class="headerlink" title="super(parent)"></a>super(parent)</h1><p>一步步向上调用父类构造函数，路径为</p><p>ClassPathXmlApplicationContext -&gt; AbstractXmlApplicationContext -&gt; AbstractRefreshableConfigApplicationContext -&gt; AbstractRefreshableApplicationContext -&gt; AbstractApplicationContext</p><p>历经整个继承体系，最终到达<code>AbstractApplicationContext</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractApplicationContext</span><span class="params">(ApplicationContext parent)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>();</span><br><span class="line">    setParent(parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后会设置当前<code>ApplicationContext</code>的父级<code>ApplicationContext</code></p><h1 id="setConfigLocations-configLocations"><a href="#setConfigLocations-configLocations" class="headerlink" title="setConfigLocations(configLocations)"></a>setConfigLocations(configLocations)</h1><p>设置配置文件路径，解析的细节参照官方文档Resource一节，不是本文讨论的重点，在此略过。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfigLocations</span><span class="params">(String... locations)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (locations != <span class="literal">null</span>) &#123;</span><br><span class="line">        Assert.noNullElements(locations, <span class="string">&quot;Config locations must not be null&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.configLocations = <span class="keyword">new</span> <span class="title class_">String</span>[locations.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; locations.length; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.configLocations[i] = resolvePath(locations[i]).trim();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configLocations = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="refresh"><a href="#refresh" class="headerlink" title="refresh()"></a>refresh()</h1><p>此方法是Spring容器的核心方法，源码(精简了try catch部分)如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">    prepareRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">    prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">    postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">    invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">    registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">    initMessageSource();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">    initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">    onRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">    registerListeners();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">    finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">    finishRefresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处可以看到Spring编码方式近似于流程图的，重点部分都抽出为了单独的方法，流程清晰，易于理解。我们一步步看：</p><h2 id="prepareRefresh"><a href="#prepareRefresh" class="headerlink" title="prepareRefresh()"></a>prepareRefresh()</h2><blockquote><p>上下文刷新前预热</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">    <span class="built_in">this</span>.closed.set(<span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">this</span>.active.set(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Refreshing &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize any placeholder property sources in the context environment</span></span><br><span class="line">    initPropertySources();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate that all properties marked as required are resolvable</span></span><br><span class="line">    <span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></span><br><span class="line">    getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow for the collection of early ApplicationEvents,</span></span><br><span class="line">    <span class="comment">// to be published once the multicaster is available...</span></span><br><span class="line">    <span class="built_in">this</span>.earlyApplicationEvents = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;ApplicationEvent&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>设置上下文基本信息，如startupDate(启动时刻)、closed(是否关闭)、active(是否存活)等等。</li><li>解析占位符资源，并验证标记为required的资源是否可用</li></ol><h2 id="obtainFreshBeanFactory"><a href="#obtainFreshBeanFactory" class="headerlink" title="obtainFreshBeanFactory()"></a>obtainFreshBeanFactory()</h2><blockquote><p>初始化beanFactory(bean工厂，实际存放bean的就是它了)</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title function_">obtainFreshBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    refreshBeanFactory();</span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心方法<code>refreshBeanFactory()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> createBeanFactory();</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>createBeanFactory();</li><li>设置beanFactory属性</li><li>loadBeanDefinitions(beanFactory);</li></ol><h2 id="loadBeanDefinitions-beanFactory"><a href="#loadBeanDefinitions-beanFactory" class="headerlink" title="loadBeanDefinitions(beanFactory)"></a>loadBeanDefinitions(beanFactory)</h2><blockquote><p>解析bean定义，有几个bean就有几个BeanDefinition。注意，Spring并不是拿到配置就直接用反射实例化bean，而是先将bean配置解析为BeanDefinition。</p></blockquote><p>BeanDefinition保存了实例化bean需要的一切信息，包括属性，依赖等。以<code>ConcurrentHashMap&lt;String, BeanDefinition&gt;</code>保存在DefaultListableBeanFactory的beanDefinitionMap里。</p><p><img src="https://i.loli.net/2019/03/29/5c9dbcecdf9e1.png"></p><h2 id="prepareBeanFactory-beanFactory"><a href="#prepareBeanFactory-beanFactory" class="headerlink" title="prepareBeanFactory(beanFactory)"></a>prepareBeanFactory(beanFactory)</h2><blockquote><p>设置beanFactory的其余属性</p></blockquote><h2 id="postProcessBeanFactory-beanFactory"><a href="#postProcessBeanFactory-beanFactory" class="headerlink" title="postProcessBeanFactory(beanFactory)"></a>postProcessBeanFactory(beanFactory)</h2><blockquote><p>空实现，给子类一个机会，自定义beanFactory后置处理器</p></blockquote><p><code>BeanFactoryPostProcessor</code>定义：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="invokeBeanFactoryPostProcessors-beanFactory"><a href="#invokeBeanFactoryPostProcessors-beanFactory" class="headerlink" title="invokeBeanFactoryPostProcessors(beanFactory)"></a>invokeBeanFactoryPostProcessors(beanFactory)</h2><blockquote><p>执行上一步中的beanFactory后置处理器的回调方法<code>void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code></p></blockquote><h2 id="registerBeanPostProcessors-beanFactory"><a href="#registerBeanPostProcessors-beanFactory" class="headerlink" title="registerBeanPostProcessors(beanFactory)"></a>registerBeanPostProcessors(beanFactory)</h2><blockquote><p>注册bean后置处理器，实现bean初始化前后的自定义逻辑</p></blockquote><p><code>BeanPostProcessor</code>定义：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="comment">// 在bean实例化前调用</span></span><br><span class="line">    Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="comment">// 在bean实例化后调用</span></span><br><span class="line">    Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource()"></a>initMessageSource()</h2><blockquote><p>注册国际化相关bean</p></blockquote><h2 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster()"></a>initApplicationEventMulticaster()</h2><blockquote><p>初始化Spring事件发布相关bean</p></blockquote><h2 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh()"></a>onRefresh()</h2><blockquote><p>空实现，给子类一个机会，初始化特殊bean</p></blockquote><h2 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners()"></a>registerListeners()</h2><blockquote><p>注册监听器</p></blockquote><h2 id="finishBeanFactoryInitialization-beanFactory"><a href="#finishBeanFactoryInitialization-beanFactory" class="headerlink" title="finishBeanFactoryInitialization(beanFactory)"></a>finishBeanFactoryInitialization(beanFactory)</h2><blockquote><p>实例化所有非懒加载的bean</p></blockquote><p>直到这里，才开始真正实例化bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 实例化bean的类型转换器</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 实例化属性占位符解析器</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(<span class="keyword">new</span> <span class="title class_">StringValueResolver</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">resolveStringValue</span><span class="params">(String strVal)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> getEnvironment().resolvePlaceholders(strVal);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 实例化LoadTimeWeaverAware</span></span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 停止使用临时ClassLoader进行类型匹配</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 禁止再修改bean定义</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 实例化所有非懒加载单例bean</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="preInstantiateSingletons"><a href="#preInstantiateSingletons" class="headerlink" title="preInstantiateSingletons()"></a>preInstantiateSingletons()</h3><ol><li>根据每一个bean定义，实例化bean</li><li>为每一个实现SmartInitializingSingleton的bean执行回调方法</li></ol><p>实例化bean部分的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">    <span class="comment">// 获取bean定义</span></span><br><span class="line">    <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">    <span class="comment">// 只有不是abstract、单例且不是懒加载的bean才在这里实例化</span></span><br><span class="line">    <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">        <span class="comment">// 如果是FactoryBean</span></span><br><span class="line">        <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">            <span class="comment">// 先实例化实例对应的FactoryBean</span></span><br><span class="line">            <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">            <span class="type">boolean</span> isEagerInit;</span><br><span class="line">            <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">                isEagerInit = AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Boolean <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, getAccessControlContext());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                        ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">                <span class="comment">// 使用FactoryBean的getObject()方法返回真正的实例</span></span><br><span class="line">                getBean(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            getBean(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getBean-String-name"><a href="#getBean-String-name" class="headerlink" title="getBean(String name)"></a>getBean(String name)</h4><p>该方法调用了一个doGetBean，doGetBean代码较长，而且有部分代码是为了解决并发场景下单例的生成，我们挑出重点的看：</p><ol><li>从父BeanFactory检查是否存在该bean的定义，如果存在，委托父BeanFactory来实例化</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">parentBeanFactory</span> <span class="operator">=</span> getParentBeanFactory();</span><br><span class="line"><span class="keyword">if</span> (parentBeanFactory != <span class="literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">    <span class="comment">// Not found -&gt; check parent.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">nameToLookup</span> <span class="operator">=</span> originalBeanName(name);</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Delegation to parent with explicit args.</span></span><br><span class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No args -&gt; delegate to standard getBean method.</span></span><br><span class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>获得bean定义，如果存在依赖，先实例化每一个依赖bean，注意：不允许循环依赖</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></span><br><span class="line">String[] dependsOn = mbd.getDependsOn();</span><br><span class="line"><span class="comment">//如果存在依赖，先实例化每一个依赖bean</span></span><br><span class="line"><span class="keyword">if</span> (dependsOn != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 实例化每一个依赖bean</span></span><br><span class="line">    <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">        <span class="comment">// 检查循环依赖</span></span><br><span class="line">        <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                    <span class="string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 实例化依赖bean</span></span><br><span class="line">        registerDependentBean(dep, beanName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getBean(dep);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                    <span class="string">&quot;&#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>实例化bean</li></ol><p>方法调用流程：</p><p>createBean &gt; doCreateBean &gt; populateBean</p><p>其中doCreateBean：</p><ol><li>从BeanDefinition生成BeanWrapper</li><li>将BeanWrapper和BeanDefinition.getPropertyValues() 传给populateBean，实例化bean</li></ol><h2 id="finishRefresh"><a href="#finishRefresh" class="headerlink" title="finishRefresh()"></a>finishRefresh()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化生命周期处理器</span></span><br><span class="line">    initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 刷新生命周期处理器状态 running = true</span></span><br><span class="line">    getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布上下文初始化完成事件ContextRefreshedEvent</span></span><br><span class="line">    publishEvent(<span class="keyword">new</span> <span class="title class_">ContextRefreshedEvent</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果处于活动状态，将自己注册到LiveBeans</span></span><br><span class="line">    LiveBeansView.registerApplicationContext(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Spring IoC Container时序图</p><p><img src="https://i.loli.net/2019/03/29/5c9dd9c73cbe4.jpg"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h1&gt;&lt;p&gt;Person实例&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>FastDFS 单机部署指南</title>
    <link href="https://blog.gcdd.top/p/56864/"/>
    <id>https://blog.gcdd.top/p/56864/</id>
    <published>2019-03-22T07:39:17.000Z</published>
    <updated>2023-08-30T04:52:53.898Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>FastDFS是一个开源的分布式文件系统，<a href="https://www.oschina.net/p/fastdfs">官方介绍</a>有详细的介绍，不多赘述。本文主要是FastDFS的搭建及采坑指南。</p><span id="more"></span><h1 id="Step-By-Step-Guide"><a href="#Step-By-Step-Guide" class="headerlink" title="Step By Step Guide"></a>Step By Step Guide</h1><h2 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h2><ul><li>阿里云ECS Ubuntu 16.04</li></ul><h2 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h2><p>按需安装，这里是针对新的ubuntu系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install git gcc gcc-c++ make automake autoconf libtool pcre pcre-devel zlib zlib-devel openssl-devel wget vim</span><br></pre></td></tr></table></figure><h2 id="磁盘目录"><a href="#磁盘目录" class="headerlink" title="磁盘目录"></a>磁盘目录</h2><table><thead><tr><th>说明</th><th>位置</th></tr></thead><tbody><tr><td>所有安装包</td><td>/usr/local/src</td></tr><tr><td>数据存储位置</td><td>/data/dfs/</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> /data/dfs <span class="comment">#创建数据存储目录（对于阿里云ECS，最好建立在数据盘上，是用来存放文件的）</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/local/src <span class="comment">#切换到安装目录准备下载安装包</span></span><br></pre></td></tr></table></figure><h2 id="安装libfatscommon"><a href="#安装libfatscommon" class="headerlink" title="安装libfatscommon"></a>安装libfatscommon</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/happyfish100/libfastcommon/archive/master.zip</span><br><span class="line">$ unzip master.zip</span><br><span class="line">$ <span class="built_in">cd</span> libfastcommon-1.0.39/</span><br><span class="line">$ ./make.sh &amp;&amp; ./make.sh install <span class="comment">#编译安装</span></span><br></pre></td></tr></table></figure><h2 id="安装FastDFS"><a href="#安装FastDFS" class="headerlink" title="安装FastDFS"></a>安装FastDFS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../ <span class="comment">#返回上一级目录</span></span><br><span class="line">$ wget https://github.com/happyfish100/fastdfs/archive/master.zip</span><br><span class="line">$ unzip master.zip</span><br><span class="line">$ <span class="built_in">cd</span> fastdfs-master/</span><br><span class="line">$ ./make.sh &amp;&amp; ./make.sh install <span class="comment">#编译安装</span></span><br><span class="line"><span class="comment">#配置文件准备</span></span><br><span class="line">$ <span class="built_in">cp</span> /etc/fdfs/tracker.conf.sample /etc/fdfs/tracker.conf</span><br><span class="line">$ <span class="built_in">cp</span> /etc/fdfs/storage.conf.sample /etc/fdfs/storage.conf</span><br><span class="line">$ <span class="built_in">cp</span> /etc/fdfs/client.conf.sample /etc/fdfs/client.conf <span class="comment">#客户端文件，测试用</span></span><br><span class="line">$ <span class="built_in">cp</span> /usr/local/src/fastdfs-master/conf/http.conf /etc/fdfs/ <span class="comment">#供nginx访问使用</span></span><br><span class="line">$ <span class="built_in">cp</span> /etc/nginx/mime.types /etc/fdfs/ <span class="comment">#供nginx访问使用</span></span><br></pre></td></tr></table></figure><h2 id="安装fastdfs-nginx-module"><a href="#安装fastdfs-nginx-module" class="headerlink" title="安装fastdfs-nginx-module"></a>安装fastdfs-nginx-module</h2><p>官网的文档，是针对没有安装过Nginx的机器，重新编译了一遍Nginx，把module直接编译进Nginx了。但是针对已经安装Nginx的服务器来说，显然是不好的。</p><p>根据<a href="https://www.nginx.com/blog/compiling-dynamic-modules-nginx-plus/">Nginx官方文档-编译第三方动态模块</a>，编译了<code>fastdfs-nginx-module</code>，以供已存在的Nginx使用。</p><p>我已经编译好了<code>fastdfs-nginx-module</code>，可以<a href="https://github.com/gcdd1993/fastDFS-ubuntu-guide/blob/master/ngx_http_fastdfs_module.so">直接下载</a>，并跳到<a href="#use-module">加载并使用模块</a>，如果想知其所以然，可以往下看。</p><h3 id="准备fastdfs-nginx-module源码包"><a href="#准备fastdfs-nginx-module源码包" class="headerlink" title="准备fastdfs-nginx-module源码包"></a>准备<code>fastdfs-nginx-module</code>源码包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../ <span class="comment">#返回上一级目录</span></span><br><span class="line">$ wget https://github.com/happyfish100/fastdfs-nginx-module/archive/master.zip</span><br><span class="line">$ unzip master.zip</span><br></pre></td></tr></table></figure><h3 id="获取对应版本的Nginx源码包"><a href="#获取对应版本的Nginx源码包" class="headerlink" title="获取对应版本的Nginx源码包"></a>获取对应版本的Nginx源码包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -v <span class="comment"># 确认服务器的Nginx版本</span></span><br><span class="line">nginx version: nginx/1.14.2</span><br><span class="line">$ wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">$ tar -xzvf nginx-1.14.2.tar.gz</span><br></pre></td></tr></table></figure><h3 id="编译动态模块"><a href="#编译动态模块" class="headerlink" title="编译动态模块"></a>编译动态模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> nginx-1.14.2/</span><br><span class="line">$ ./configure --with-compat --add-dynamic-module=/usr/local/src/fastdfs-nginx-module-master/src</span><br><span class="line">$ make modules</span><br></pre></td></tr></table></figure><h3 id="将模块库（-so文件）复制到-etc-nginx-modules"><a href="#将模块库（-so文件）复制到-etc-nginx-modules" class="headerlink" title="将模块库（.so文件）复制到/etc/nginx/modules"></a>将模块库（.so文件）复制到/etc/nginx/modules</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> ngx_http_fastdfs_module.so /etc/nginx/modules/</span><br></pre></td></tr></table></figure><h3 id="加载并使用模块"><a href="#加载并使用模块" class="headerlink" title="加载并使用模块"></a>加载并使用模块<a name="use-module"/></h3><p>Tips: 要将模块加载到Nginx,在nginx.conf文件开头添加<code>load_module</code>命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/nginx.conf</span><br><span class="line"><span class="comment"># 添加如下命令</span></span><br><span class="line">load_module modules/ngx_http_fastdfs_module.so;</span><br><span class="line"><span class="comment"># 保存退出</span></span><br></pre></td></tr></table></figure><h3 id="添加FastDFS配置使模块生效"><a href="#添加FastDFS配置使模块生效" class="headerlink" title="添加FastDFS配置使模块生效"></a>添加FastDFS配置使模块生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf.d/fastdfs.conf</span><br><span class="line"><span class="comment"># 添加如下配置</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8888;    <span class="comment">## 该端口为storage.conf中的http.server_port相同</span></span><br><span class="line">    server_name &#123;your_domain&#125;;</span><br><span class="line">    location ~/group[0-9]/ &#123;</span><br><span class="line">        ngx_fastdfs_module;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h2><p>这里只描述下单机环境的部署方式，集群在官方文档有，没有实际使用过。</p><h3 id="tracker配置"><a href="#tracker配置" class="headerlink" title="tracker配置"></a>tracker配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/fdfs/tracker.conf</span><br><span class="line"><span class="comment"># 建议修改以下内容</span></span><br><span class="line">bind_addr=&#123;你的内网IP&#125;</span><br><span class="line">base_path=/data/dfs <span class="comment"># 建议修改为数据盘位置</span></span><br><span class="line"><span class="comment"># 可选修改</span></span><br><span class="line">port=22122  <span class="comment"># tracker服务器端口</span></span><br></pre></td></tr></table></figure><h3 id="storage配置"><a href="#storage配置" class="headerlink" title="storage配置"></a>storage配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/fdfs/storage.conf</span><br><span class="line"><span class="comment"># 建议修改</span></span><br><span class="line">base_path=/data/dfs  <span class="comment"># 数据和日志文件存储根目录（建议修改为数据盘位置）</span></span><br><span class="line">store_path0=/data/dfs  <span class="comment"># 第一个存储目录（建议修改为数据盘位置）</span></span><br><span class="line">tracker_server=&#123;tracker.bind_addr&#125;:&#123;tracker.port&#125;  <span class="comment"># tracker服务器IP和端口</span></span><br><span class="line">http.server_port=8888  <span class="comment"># http访问文件的端口（默认8888,看情况修改,和nginx中保持一致）</span></span><br><span class="line"><span class="comment"># 可选修改</span></span><br><span class="line">port=23000  <span class="comment"># storage服务端口（默认23000,一般不修改）</span></span><br></pre></td></tr></table></figure><h3 id="client测试"><a href="#client测试" class="headerlink" title="client测试"></a>client测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/fdfs/client.conf</span><br><span class="line"><span class="comment"># 建议修改</span></span><br><span class="line">base_path=/data/dfs</span><br><span class="line">tracker_server=&#123;tracker.bind_addr&#125;:&#123;tracker.port&#125;  <span class="comment"># tracker服务器IP和端口</span></span><br><span class="line"><span class="comment"># 保存后测试</span></span><br><span class="line">$ fdfs_upload_file /etc/fdfs/client.conf /usr/local/src/nginx-1.14.2.tar.gz</span><br><span class="line">group1/M00/00/00/CgoKvlyUmi-AMVKDAA9-WL9wzEw.tar.gz <span class="comment"># 下载时通过该ID下载</span></span><br><span class="line"><span class="comment"># 返回ID表示成功 如：group1/M00/00/00/xx.tar.gz</span></span><br></pre></td></tr></table></figure><h3 id="配置nginx访问"><a href="#配置nginx访问" class="headerlink" title="配置nginx访问"></a>配置nginx访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"><span class="comment"># 建议修改</span></span><br><span class="line">tracker_server=&#123;tracker.bind_addr&#125;:&#123;tracker.port&#125;  <span class="comment"># tracker服务器IP和端口</span></span><br><span class="line">url_have_group_name=<span class="literal">true</span></span><br><span class="line">store_path0=/data/dfs</span><br><span class="line"><span class="comment"># 修改完保存</span></span><br><span class="line">$ nginx -s reload</span><br><span class="line">ngx_http_fastdfs_set pid=8364 <span class="comment"># 看见这条消息说明nginx模块启动成功了</span></span><br><span class="line">$ lsof -i:8888 <span class="comment"># 查看Nginx下载端口是否正常启动</span></span><br><span class="line">nginx   31061  root   10u  IPv4 20389985      0t0  TCP *:8888 (LISTEN)</span><br></pre></td></tr></table></figure><h3 id="测试下载"><a href="#测试下载" class="headerlink" title="测试下载"></a>测试下载</h3><p>在浏览器输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&#123;IP&#125;:8888/group1/M00/00/00/CgoKvlyUmi-AMVKDAA9-WL9wzEw.tar.gz?filename=nginx-1.14.2.tar.gz //刚才上传返回的ID</span><br></pre></td></tr></table></figure><p>弹出下载文件框，说明部署成功！</p><p><img src="https://i.loli.net/2019/03/22/5c94a6b526a52.png"></p><h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span>|<span class="built_in">disable</span></span><br></pre></td></tr></table></figure><h3 id="tracker"><a href="#tracker" class="headerlink" title="tracker"></a>tracker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/fdfs_trackerd start <span class="comment"># 启动tracker服务</span></span><br><span class="line">$ /etc/init.d/fdfs_trackerd restart <span class="comment"># 重启动tracker服务</span></span><br><span class="line">$ /etc/init.d/fdfs_trackerd stop <span class="comment"># 停止tracker服务</span></span><br><span class="line">$ update-rc.d fdfs_trackerd <span class="built_in">enable</span> <span class="comment"># 自启动tracker服务</span></span><br></pre></td></tr></table></figure><h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/fdfs_storaged start <span class="comment"># 启动storage服务</span></span><br><span class="line">$ /etc/init.d/fdfs_storaged restart <span class="comment"># 重动storage服务</span></span><br><span class="line">$ /etc/init.d/fdfs_storaged stop <span class="comment"># 停止动storage服务</span></span><br><span class="line">$ update-rc.d fdfs_storaged <span class="built_in">enable</span> <span class="comment"># 自启动storage服务</span></span><br></pre></td></tr></table></figure><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service nginx start <span class="comment"># 启动nginx</span></span><br><span class="line">$ nginx -s reload <span class="comment"># 重启nginx</span></span><br><span class="line">$ nginx -s stop <span class="comment"># 停止nginx</span></span><br></pre></td></tr></table></figure><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="执行nginx-s-reload-后，访问502"><a href="#执行nginx-s-reload-后，访问502" class="headerlink" title="执行nginx -s reload 后，访问502"></a>执行nginx -s reload 后，访问502</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看nginx日志</span></span><br><span class="line">$ vim /var/log/nginx/error.log</span><br></pre></td></tr></table></figure><p>如果发现错误日志：<code>include file &quot;http.conf&quot; not exists, line: &quot;#include http.conf&quot;</code>，fastdfs nginx模块缺少配置文件，执行以下命令补全配置文件即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> /usr/local/src/fastdfs-master/conf/http.conf /etc/fdfs/ <span class="comment">#供nginx访问使用</span></span><br><span class="line">$ <span class="built_in">cp</span> /etc/nginx/mime.types /etc/fdfs/ <span class="comment">#供nginx访问使用</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;FastDFS是一个开源的分布式文件系统，&lt;a href=&quot;https://www.oschina.net/p/fastdfs&quot;&gt;官方介绍&lt;/a&gt;有详细的介绍，不多赘述。本文主要是FastDFS的搭建及采坑指南。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="FastDFS" scheme="https://blog.gcdd.top/tags/FastDFS/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Framework-官方文档阅读（一）Spring IoC Container</title>
    <link href="https://blog.gcdd.top/p/433/"/>
    <id>https://blog.gcdd.top/p/433/</id>
    <published>2019-03-20T10:53:06.000Z</published>
    <updated>2023-08-30T04:52:53.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>通读Spring IoC容器官方文档，对IoC容器有一个大致的了解。</p><span id="more"></span><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul><li>JDK1.8</li><li>Spring Framework Version ：4.3.18.RELEASE</li></ul><h1 id="容器概述"><a href="#容器概述" class="headerlink" title="容器概述"></a>容器概述</h1><blockquote><p>接口<code>org.springframework.context.ApplicationContext</code>代表Spring IoC容器，负责实例化，配置和组装bean。<br>在独立应用程序中，通常会创建一个<code>ClassPathXmlApplicationContext</code>或者 <code>FileSystemXmlApplicationContext</code>的实例。</p></blockquote><!-- more --><p>Spring工作原理的高级视图<br><img src="https://i.loli.net/2019/03/21/5c9278544811e.png"></p><p>1.配置元数据<br>创建SimpleBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello Spring Bean!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>config.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;simple&quot;</span> <span class="attr">class</span>=<span class="string">&quot;base.SimpleBeanFactoryBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.实例化容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br></pre></td></tr></table></figure><p>3.使用容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检索Spring容器中的bean</span></span><br><span class="line"><span class="type">SimpleBean</span> <span class="variable">simpleBean</span> <span class="operator">=</span> context.getBean(SimpleBean.class);</span><br><span class="line"><span class="comment">// 使用bean</span></span><br><span class="line">simpleBean.send();</span><br></pre></td></tr></table></figure><p>还有更灵活的方式来从配置文件获取bean，使用<code>GenericApplicationContext</code>与<code>BeanDefinitionReader</code>结合，直接读取bean定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(context).loadBeanDefinitions(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">context.refresh();</span><br><span class="line"><span class="type">SimpleBean</span> <span class="variable">simpleBean</span> <span class="operator">=</span> (SimpleBean) context.getBean(<span class="string">&quot;simple&quot;</span>);</span><br><span class="line">simpleBean.send();</span><br></pre></td></tr></table></figure><h1 id="Bean概述"><a href="#Bean概述" class="headerlink" title="Bean概述"></a>Bean概述</h1><blockquote><p>Spring IoC容器管理一个或多个bean。这些bean是使用您提供给容器的配置元数据创建的，例如，以XML <code>&lt;bean/&gt;</code>定义的形式 。</p></blockquote><p>在容器本身内，这些bean定义表示为<code>BeanDefinition</code>对象。</p><p>除了创建配置好的bean之外，<code>ApplicationContext</code>还允许用户注册在容器外部创建的现有对象。通过<code>getBeanFactory()</code>获得<code>DefaultListableBeanFactory</code>，然后使用<code>registerSingleton()</code>或者<code>registerBeanDefinition()</code>来注册bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"><span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">user.setId(<span class="number">1L</span>);</span><br><span class="line">user.setName(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">beanFactory.registerSingleton(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">bean</span> <span class="operator">=</span> (User) applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">System.out.println(bean);</span><br></pre></td></tr></table></figure><p>或者是以下做法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassPathXmlApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line"><span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> (DefaultListableBeanFactory) applicationContext.getBeanFactory();</span><br><span class="line"><span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(User.class);</span><br><span class="line">builder.addPropertyValue(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">builder.addPropertyValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line"><span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> builder.getBeanDefinition();</span><br><span class="line">beanFactory.registerBeanDefinition(<span class="string">&quot;user&quot;</span>, beanDefinition);</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">bean</span> <span class="operator">=</span> (User) applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">System.out.println(bean);</span><br></pre></td></tr></table></figure><h2 id="命名bean"><a href="#命名bean" class="headerlink" title="命名bean"></a>命名bean</h2><p>每个bean都有一个或多个标识符。这些标识符在托管bean的容器中必须是唯一的。bean通常只有一个标识符，但如果它需要多个标识符，则额外的标识符可以被视为别名。</p><p>在基于XML的配置元数据中，使用id和/或name属性指定bean标识符。</p><h2 id="实例化bean"><a href="#实例化bean" class="headerlink" title="实例化bean"></a>实例化bean</h2><p>1.构造函数实例化</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;anotherExample&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBeanTwo&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>2.静态工厂方法实例化</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;examples.ClientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createInstance&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ClientService</span> <span class="variable">clientService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientService</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ClientService</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ClientService <span class="title function_">createInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.实例工厂方法实例化</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- the factory bean, which contains a method called createInstance() --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serviceLocator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.DefaultServiceLocator&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- the bean to be created via the factory bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">&quot;serviceLocator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createClientServiceInstance&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultServiceLocator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ClientService</span> <span class="variable">clientService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ClientService <span class="title function_">createClientServiceInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个工厂类也可以包含多个工厂方法:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serviceLocator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.DefaultServiceLocator&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">&quot;serviceLocator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createClientServiceInstance&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-bean</span>=<span class="string">&quot;serviceLocator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">factory-method</span>=<span class="string">&quot;createAccountServiceInstance&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultServiceLocator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ClientService</span> <span class="variable">clientService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AccountService</span> <span class="variable">accountService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ClientService <span class="title function_">createClientServiceInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AccountService <span class="title function_">createAccountServiceInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h1><h2 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h2><blockquote><p>基于构造函数的 DI由容器调用具有多个参数的构造函数来完成，每个参数表示一个依赖项。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleMovieLister</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SimpleMovieLister依赖于MovieFinder</span></span><br><span class="line">    <span class="keyword">private</span> MovieFinder movieFinder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个构造函数，以便Spring容器可以注入一个MovieFinder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleMovieLister</span><span class="params">(MovieFinder movieFinder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.movieFinder = movieFinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// business logic that actually uses the injected MovieFinder is omitted...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造函数参数解析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> x.y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Foo</span><span class="params">(Bar bar, Baz baz)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.Foo&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;bar&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;baz&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bar&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.Bar&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;baz&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.Baz&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>显式指定构造函数参数的类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;exampleBean&quot;</span> class=<span class="string">&quot;examples.ExampleBean&quot;</span>&gt;</span><br><span class="line">    &lt;constructor-arg type=<span class="string">&quot;int&quot;</span> value=<span class="string">&quot;7500000&quot;</span>/&gt;</span><br><span class="line">    &lt;constructor-arg type=<span class="string">&quot;java.lang.String&quot;</span> value=<span class="string">&quot;42&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><p>使用index属性显式指定构造函数参数的索引：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;42&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>或者指定构造函数参数名称：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;years&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;ultimateAnswer&quot;</span> <span class="attr">value</span>=<span class="string">&quot;42&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="setter注入"><a href="#setter注入" class="headerlink" title="setter注入"></a>setter注入</h2><blockquote><p>基于setter的 DI是在调用无参数构造函数或无参数static工厂方法来实例化bean之后，通过容器调用bean上的setter方法来完成的。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleMovieLister</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SimpleMovieLister依赖于MovieFinder</span></span><br><span class="line">    <span class="keyword">private</span> MovieFinder movieFinder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个setter方法，以便Spring容器可以注入一个MovieFinder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMovieFinder</span><span class="params">(MovieFinder movieFinder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.movieFinder = movieFinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// business logic that actually uses the injected MovieFinder is omitted...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>ApplicationContext</code>的依赖注入支持构造器注入和setter注入两种方式。在通过构造函数方法注入了一些依赖项之后，它还支持基于setter的依赖注入。可以用<code>BeanDefinition</code>与<code>PropertyEditor</code>实例结合使用的方式来配置依赖项。 不过，我们一般不直接使用<code>BeanDefinition</code>与<code>PropertyEditor</code>，而是用XML 定义bean或者是注解方式（<code>@Component</code>， <code>@Controller</code>等等），或者是直接编写@Configuration类。然后，这些类在内部转换为实例<code>BeanDefinition</code>并用于加载整个Spring IoC容器实例。</p><h2 id="解决循环依赖"><a href="#解决循环依赖" class="headerlink" title="解决循环依赖"></a>解决循环依赖</h2><p>如果主要使用构造函数注入，则可能出现无法解析的循环依赖关系场景。<br>例如：类A通过构造函数注入需要类B的实例，而类B通过构造函数注入类A的实例。如果将A类和B类的bean配置为相互注入，则Spring IoC容器会在运行时检测到此循环引用，并抛出<code>BeanCurrentlyInCreationException</code>异常。<br>一种可行的解决方案是仅使用setter注入。<br>与典型情况（没有循环依赖）不同，bean A和bean B之间的循环依赖强制其中一个bean在完全初始化之前被注入另一个bean（一个经典的鸡/蛋场景）。</p><h2 id="使用-depends-on"><a href="#使用-depends-on" class="headerlink" title="使用 depends-on"></a>使用 depends-on</h2><p><code>depends-on</code>可以在初始化bean之前，显式地强制初始化一个或多个bean。下面的例子，在初始化<code>beanOne</code>之前，将强制初始化<code>manager</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;beanOne&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ExampleBean&quot;</span> <span class="attr">depends-on</span>=<span class="string">&quot;manager&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;manager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ManagerBean&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="懒加载的bean"><a href="#懒加载的bean" class="headerlink" title="懒加载的bean"></a>懒加载的bean</h2><p>默认情况下，<code>ApplicationContext</code>会立即配置并初始化所有单例bean，但是我们可以使用<code>lazy-init=&quot;true&quot;</code>将其设置为按需加载。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;lazy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.foo.ExpensiveToCreateBean&quot;</span> <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;not.lazy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.foo.AnotherBean&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>注意：懒加载不要使用在数据库连接池上，因为无法立即获知数据库连接状态，将导致运行时创建连接池失败，不可预知的后果。</p><h2 id="自动装配协作者"><a href="#自动装配协作者" class="headerlink" title="自动装配协作者"></a>自动装配协作者</h2><p>Spring容器可以自动连接协作bean之间的关系。您可以通过检查<code>ApplicationContext</code>的内容，允许Spring自动为您的bean解析协作者（其他bean）。</p><p>自动装配模式</p><ul><li>no：无自动装配，必须使用ref来定义Bean引用。</li><li>byName：按属性名称自动装配。</li><li>byType：按属性类型自动装配，如果存在多个同类型Bean，则抛出致命异常。</li><li>constructor：类似于byType，如果容器中没有构造函数参数类型的一个bean，则抛出致命异常。</li></ul><h1 id="Bean-作用域"><a href="#Bean-作用域" class="headerlink" title="Bean 作用域"></a>Bean 作用域</h1><h2 id="singleton"><a href="#singleton" class="headerlink" title="singleton"></a>singleton</h2><blockquote><p>Spring IoC容器只创建该bean定义的对象的一个实例。此单个实例存储在此类单例bean的缓存中，并且该Bean的所有后续请求和引用都将返回缓存对象。</p></blockquote><p><img src="https://i.loli.net/2019/03/21/5c9278545f51f.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.foo.DefaultAccountService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- the following is equivalent, though redundant (singleton scope is the default) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.foo.DefaultAccountService&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="prototype"><a href="#prototype" class="headerlink" title="prototype"></a>prototype</h2><blockquote><p>和单例对立，通常，对所有有状态bean使用原型范围，对无状态bean使用单例范围。</p></blockquote><p><img src="https://i.loli.net/2019/03/21/5c92785478899.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.foo.DefaultAccountService&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Request-session-global-session-application-and-WebSocket"><a href="#Request-session-global-session-application-and-WebSocket" class="headerlink" title="Request, session, global session, application, and WebSocket"></a>Request, session, global session, application, and WebSocket</h2><blockquote><p>在web程序中使用，对应于HTTP请求作用域</p></blockquote><h1 id="自定义bean的性质"><a href="#自定义bean的性质" class="headerlink" title="自定义bean的性质"></a>自定义bean的性质</h1><h2 id="生命周期回调"><a href="#生命周期回调" class="headerlink" title="生命周期回调"></a>生命周期回调</h2><h2 id="初始化回调"><a href="#初始化回调" class="headerlink" title="初始化回调"></a>初始化回调</h2><p>实现<code>org.springframework.beans.factory.InitializingBean</code>接口，可以为bean设置初始化方法，该接口定义了一个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></table></figure><p>官方不建议使用该接口，因为会增加与Spring的耦合度。可以使用<code>@PostConstruct</code>或指定bean的初始化方法。</p><ul><li>使用xml配置文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleInitBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>使用Java @Bean注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(initMethod = &quot;init&quot;)</span></span><br></pre></td></tr></table></figure><h2 id="销毁回调"><a href="#销毁回调" class="headerlink" title="销毁回调"></a>销毁回调</h2><p>实现<code>org.springframework.beans.factory.DisposableBean</code>可以为bean设置销毁回调方法，该接口定义了一个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></table></figure><p>同样的，不建议实现该接口，可以使用<code>@PreDestroy</code>或指定bean的初始化方法。</p><ul><li>使用xml配置文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleInitBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;examples.ExampleBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;cleanup&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>使用Java @Bean注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(destroyMethod = &quot;cleanup&quot;)</span></span><br></pre></td></tr></table></figure><p>从Spring 2.5开始，您有三个控制bean生命周期行为的选项：</p><ul><li> <code>InitializingBean</code>和 <code>DisposableBean</code>回调接口</li><li> init()和destroy()方法</li><li> <code>@PostConstruct</code>和<code>@PreDestroy</code>注解</li></ul><p>如果为一个bean同时配置了上述方法，则执行方法顺序为：</p><ul><li><code>@PostConstruct</code>定义的方法</li><li><code>InitializingBean</code>回调接口定义的<code>afterPropertiesSet()</code></li><li>自定义配置的<code>init()</code>方法</li></ul><p>销毁：</p><ul><li><code>@PreDestroy</code>定义的方法</li><li><code>DisposableBean</code>回调接口 定义的<code>destroy()</code></li><li>自定义配置的<code>destroy()</code>方法</li></ul><h1 id="ApplicationContextAware和BeanNameAware"><a href="#ApplicationContextAware和BeanNameAware" class="headerlink" title="ApplicationContextAware和BeanNameAware"></a><code>ApplicationContextAware</code>和<code>BeanNameAware</code></h1><ul><li><code>ApplicationContextAware</code>：实现该接口，将注入<code>ApplicationContext</code>实例的引用</li><li><code>BeanNameAware</code>：实现该接口，将注入<code>BeanName</code></li></ul><p>除了<code>ApplicationContextAware</code>和<code>BeanNameAware</code>，Spring还提供了一系列Aware接口，这些接口将为实现类注入对应的实例。</p><ul><li>ApplicationContextAware：声明 ApplicationContext</li><li>ApplicationEventPublisherAware：ApplicationContext的事件发布者</li><li>BeanClassLoaderAware：用于加载bean类的类加载器。</li><li>BeanFactoryAware：声明 BeanFactory</li><li>BeanNameAware：声明bean的名称</li><li>BootstrapContextAware</li><li>LoadTimeWeaverAware</li><li>MessageSourceAware</li><li>NotificationPublisherAware：Spring JMX通知发布者</li><li>PortletConfigAware：当前PortletConfig容器</li><li>PortletContextAware：当前PortletContext容器</li><li>ResourceLoaderAware：配置的加载程序，用于对资源进行低级访问</li><li>ServletConfigAware：当前ServletConfig容器</li><li>ServletContextAware：当前ServletContext容器</li></ul><h1 id="Bean的继承"><a href="#Bean的继承" class="headerlink" title="Bean的继承"></a>Bean的继承</h1><p>在xml配置文件里，我们可以定义bean的继承体系，使用<code>parent</code>属性定义父类。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;inheritedTestBean&quot;</span> <span class="attr">abstract</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.TestBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;parent&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;inheritsWithDifferentClass&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.DerivedTestBean&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">parent</span>=<span class="string">&quot;inheritedTestBean&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initialize&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;override&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- the age property value of 1 will be inherited from parent --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在源码里，子类是通过<code>ChildBeanDefinition</code>来定义的。</p><h1 id="容器扩展点"><a href="#容器扩展点" class="headerlink" title="容器扩展点"></a>容器扩展点</h1><p>一般来说，我们不需要去继承<code>ApplicationContext</code>实现类，不过Spring预留了一些接口，让我们可以扩展Spring IoC容器。</p><h2 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="comment">//在每个bean初始化之前调用</span></span><br><span class="line">Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">    <span class="comment">//在每个bean初始化完毕后调用</span></span><br><span class="line">Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">可以定义多个`BeanPostProcessor`，然后实现`Ordered`接口并修改属性order来控制`BeanPostProcessor`的执行顺序。</span><br><span class="line"></span><br><span class="line">注意：`ConfigurableBeanFactory`提供</span><br><span class="line"></span><br><span class="line">​```java</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">addBeanPostProcessor</span><span class="params">(BeanPostProcessor beanPostProcessor)</span>;</span><br></pre></td></tr></table></figure><p>来手动注册<code>BeanPostProcessor</code>，这些<code>BeanPostProcessor</code>不需要遵循<code>Orderd</code>排序规则，总是在自动注入的<code>BeanPostProcessor</code>之前执行。</p><p>一个<code>BeanPostProcessor</code>的实现例子<code>RequiredAnnotationBeanPostProcessor</code></p><h2 id="使用BeanFactoryPostProcessor自定义配置元数据"><a href="#使用BeanFactoryPostProcessor自定义配置元数据" class="headerlink" title="使用BeanFactoryPostProcessor自定义配置元数据"></a>使用<code>BeanFactoryPostProcessor</code>自定义配置元数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似于<code>BeanPostProcessor</code>，不同的是，<code>BeanFactoryPostProcessor</code>操作配置元数据。也就是说，Spring容器允许<code>BeanFactoryPostProcessor</code>读取配置并更改。</p><p>这些<code>BeanPostProcessor</code>将在每个bean初始化时自动执行，以便将更改应用于定义容器的配置元数据。Spring包含许多预定义的<code>BeanPostProcessor</code>,例如<code>PropertyOverrideConfigurer</code>和<code>PropertyPlaceholderConfigurer</code>。</p><h2 id="使用FactoryBean自定义实例化逻辑"><a href="#使用FactoryBean自定义实例化逻辑" class="headerlink" title="使用FactoryBean自定义实例化逻辑"></a>使用<code>FactoryBean</code>自定义实例化逻辑</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// 自定义bean的初始化逻辑</span></span><br><span class="line">T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">Class&lt;?&gt; getObjectType();</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置实现<code>FactoryBean&lt;T&gt;</code>的bean是，返回的是<code>getObject()</code>生成的bean，如果要返回 FactoryBean实例本身，应该使用<code>getBean(&quot;&amp;myBean&quot;)</code></p><h1 id="基于注解的容器配置"><a href="#基于注解的容器配置" class="headerlink" title="基于注解的容器配置"></a>基于注解的容器配置</h1><ul><li>@Required</li><li>@Autowired</li><li>@Resource</li><li>@Qualifier</li><li>@PostConstruct and @PreDestroy</li></ul><h2 id="类路径扫描和托管组件"><a href="#类路径扫描和托管组件" class="headerlink" title="类路径扫描和托管组件"></a>类路径扫描和托管组件</h2><ul><li>@Component,@Controller,@Repository,@Service</li><li>@Scope,@SessionScope</li><li>@ComponentScan</li></ul><h2 id="JSR-330标准注解和Spring注解对照"><a href="#JSR-330标准注解和Spring注解对照" class="headerlink" title="JSR 330标准注解和Spring注解对照"></a>JSR 330标准注解和Spring注解对照</h2><table><thead><tr><th>Spring</th><th>javax.inject.*</th></tr></thead><tbody><tr><td>@Autowired</td><td>@Inject</td></tr><tr><td>@Component</td><td>@Named / @ManagedBean</td></tr><tr><td>@Scope(“singleton”)</td><td>@Singleton</td></tr><tr><td>@Qualifier</td><td>@Qualifier / @Named</td></tr><tr><td>@Value</td><td>-</td></tr><tr><td>@Required</td><td>-</td></tr><tr><td>@Lazy</td><td>-</td></tr><tr><td>ObjectFactory</td><td>Provider</td></tr></tbody></table><h1 id="Environment-抽象"><a href="#Environment-抽象" class="headerlink" title="Environment 抽象"></a>Environment 抽象</h1><p>主要包含两个方面：profiles（多环境） and properties（配置）.</p><h2 id="多环境配置"><a href="#多环境配置" class="headerlink" title="多环境配置"></a>多环境配置</h2><ol><li>代码方式</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AnnotationConfigApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">ctx.getEnvironment().setActiveProfiles(<span class="string">&quot;development&quot;</span>);</span><br><span class="line">ctx.register(SomeConfig.class, StandaloneDataConfig.class, JndiDataConfig.class);</span><br><span class="line">ctx.refresh();</span><br></pre></td></tr></table></figure><ol start="2"><li>配置方式</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active</span><br></pre></td></tr></table></figure><h2 id="配置抽象"><a href="#配置抽象" class="headerlink" title="配置抽象"></a>配置抽象</h2><p>代码演示下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line"><span class="type">Environment</span> <span class="variable">env</span> <span class="operator">=</span> ctx.getEnvironment();</span><br><span class="line"><span class="comment">// 是否包含foo的配置</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">containsFoo</span> <span class="operator">=</span> env.containsProperty(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Does my environment contain the &#x27;foo&#x27; property? &quot;</span> + containsFoo);</span><br><span class="line"><span class="comment">// 向环境中添加配置</span></span><br><span class="line"><span class="type">MutablePropertySources</span> <span class="variable">sources</span> <span class="operator">=</span> ctx.getEnvironment().getPropertySources();</span><br><span class="line">sources.addFirst(<span class="keyword">new</span> <span class="title class_">MyPropertySource</span>());</span><br></pre></td></tr></table></figure><p>使用<code>@PropertySource</code>添加配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:/com/myco/app.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TestBean <span class="title function_">testBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">testBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestBean</span>();</span><br><span class="line">        testBean.setName(env.getProperty(<span class="string">&quot;testbean.name&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> testBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="BeanFactory还是ApplicationContext？"><a href="#BeanFactory还是ApplicationContext？" class="headerlink" title="BeanFactory还是ApplicationContext？"></a>BeanFactory还是ApplicationContext？</h1><p>尽量使用<code>ApplicationContext</code>，因为<code>ApplicationContext</code>包含<code>BeanFactory</code>的所有功能：</p><table><thead><tr><th>功能</th><th>BeanFactory</th><th>ApplicationContext</th></tr></thead><tbody><tr><td>bean初始化/编辑</td><td>支持</td><td>支持</td></tr><tr><td>自动注册<code>BeanPostProcessor</code></td><td>不支持</td><td>支持</td></tr><tr><td>自动注册<code>BeanFactoryPostProcessor</code></td><td>不支持</td><td>支持</td></tr><tr><td>方便的MessageSource访问（适用于i18n）</td><td>不支持</td><td>支持</td></tr><tr><td>发布<code>ApplicationEvent</code></td><td>不支持</td><td>支持</td></tr></tbody></table><p>要使用BeanFactory实现显式注册bean后置处理器，您需要编写如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultListableBeanFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"><span class="comment">// populate the factory with bean definitions</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// now register any needed BeanPostProcessor instances</span></span><br><span class="line"><span class="type">MyBeanPostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBeanPostProcessor</span>();</span><br><span class="line">factory.addBeanPostProcessor(postProcessor);</span><br><span class="line"></span><br><span class="line"><span class="comment">// now start using the factory</span></span><br></pre></td></tr></table></figure><p>要使用<code>BeanFactory</code>实现时显式注册<code>BeanFactoryPostProcessor</code>，您必须编写如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultListableBeanFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line"><span class="type">XmlBeanDefinitionReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(factory);</span><br><span class="line">reader.loadBeanDefinitions(<span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;beans.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// bring in some property values from a Properties file</span></span><br><span class="line"><span class="type">PropertyPlaceholderConfigurer</span> <span class="variable">cfg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyPlaceholderConfigurer</span>();</span><br><span class="line">cfg.setLocation(<span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;jdbc.properties&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// now actually do the replacement</span></span><br><span class="line">cfg.postProcessBeanFactory(factory);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;通读Spring IoC容器官方文档，对IoC容器有一个大致的了解。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Starter 开发指南</title>
    <link href="https://blog.gcdd.top/p/20136/"/>
    <id>https://blog.gcdd.top/p/20136/</id>
    <published>2019-03-18T09:16:07.000Z</published>
    <updated>2023-08-30T04:52:53.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-Boot-Starter是什么？"><a href="#Spring-Boot-Starter是什么？" class="headerlink" title="Spring Boot Starter是什么？"></a>Spring Boot Starter是什么？</h1><p>依赖管理是任何复杂项目的关键部分。以手动的方式来实现依赖管理不太现实，你得花更多时间，同时你在项目的其他重要方面能付出的时间就会变得越少。</p><p>Spring Boot starter 就是为了解决这个问题而诞生的。Starter POM 是一组方便的依赖描述符，您可以将其包含在应用程序中。您可以获得所需的所有 Spring 和相关技术的一站式服务，无需通过示例代码搜索和复制粘贴依赖。</p><span id="more"></span><h1 id="揭开Spring-Boot自动装配的神秘面纱"><a href="#揭开Spring-Boot自动装配的神秘面纱" class="headerlink" title="揭开Spring Boot自动装配的神秘面纱"></a>揭开Spring Boot自动装配的神秘面纱</h1><h2 id="Auto-Configuration-类"><a href="#Auto-Configuration-类" class="headerlink" title="Auto Configuration 类"></a>Auto Configuration 类</h2><p>当Spring Boot启动时，它会在类路径中查找名为<code>spring.factories</code>的文件。该文件位于<code>META-INF</code>目录中。让我们看一下<code>spring-boot-autoconfigure</code>项目中这个文件的片段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration</span><br></pre></td></tr></table></figure><p>此文件定义了一些Spring Boot将尝试运行的自动装配类。例如以上的代码片段，Spring Boot将尝试运行RabbitMQ，Cassandra，MongoDB和Hibernate的所有配置类。这些类是否实际运行将取决于类路径上是否存在依赖类。例如，如果在类路径中找到<code>MongoDB</code>的类，则将运行<code>MongoAutoConfiguration</code>，并初始化所有与mongo相关的bean。此条件初始化由<code>@ConditionalOnClass</code>注释启用。让我们看一下<code>MongoAutoConfiguration</code>类的代码片段，看看它的用法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(MongoClient.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(MongoProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(type = &quot;org.springframework.data.mongodb.MongoDbFactory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">// configuration code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果存在<code>MongoClient</code>类，将运行该自动装配类初始化<code>MongoClient</code>相关bean。</p><h2 id="在application-properties自定义配置"><a href="#在application-properties自定义配置" class="headerlink" title="在application.properties自定义配置"></a>在<code>application.properties</code>自定义配置</h2><p>Spring Boot使用一些预先配置的默认值初始化bean。要覆盖这些默认值，我们通常会在<code>application.properties</code>文件中使用某个特定名称声明它们。Spring Boot容器会自动获取这些属性。<br>在<code>MongoAutoConfiguration</code>的代码片段中，<code>@EnableConfigurationProperties(MongoProperties.class)</code>表示，使用<code>MongoProperties</code>类来声明自定义属性：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.data.mongodb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoProperties</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// other fields with standard getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@ConfigurationProperties(prefix = &quot;spring.data.mongodb&quot;)</code>定义了配置前缀，我们可以在<code>application.properties</code>这样来使用它：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.data.mongodb.host = localhost</span><br></pre></td></tr></table></figure><p>这样，初始化的时候，<code>localhost</code>将被注入到<code>host</code>属性中</p><h1 id="自定义Spring-Boot-Starter"><a href="#自定义Spring-Boot-Starter" class="headerlink" title="自定义Spring Boot Starter"></a>自定义<code>Spring Boot Starter</code></h1><p>Spring Boot自动装配虽然神奇，但是编写起来却异常简单，我们只需要按部就班的执行以下两个流程：</p><ol><li>编写属性容器<code>*Properties</code>，并编写对应的<code>*AutoConfiguration</code>自动装配类</li><li>一个pom文件，用于定义引入库和自动装配类的依赖项</li></ol><h2 id="概念解析"><a href="#概念解析" class="headerlink" title="概念解析"></a>概念解析</h2><h3 id="用于-Properties的注解"><a href="#用于-Properties的注解" class="headerlink" title="用于*Properties的注解"></a>用于<code>*Properties</code>的注解</h3><ul><li><code>@ConfigurationProperties(prefix = &quot;spring.data.mongodb&quot;)</code> ：用于指定配置前缀</li></ul><h3 id="用于-AutoConfiguration的注解"><a href="#用于-AutoConfiguration的注解" class="headerlink" title="用于*AutoConfiguration的注解"></a>用于<code>*AutoConfiguration</code>的注解</h3><ul><li>@Configuration：标记为配置类，由Spring容器初始化并接管</li><li>@EnableConfigurationProperties：注入配置属性容器</li><li>@ConditionalOnBean：条件装配</li></ul><p>重点说下条件装配，以<code>@ConditionalOnBean</code>为例，当Spring容器中存在指定Bean的时候装配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Conditional(OnBeanCondition.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConditionalOnBean&#123;</span><br><span class="line">    <span class="comment">//properties</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Conditional(OnBeanCondition.class)</code>指定了实现条件装配的逻辑代码</p><p><code>OnBeanCondition</code>声明如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OnBeanCondition</span> <span class="keyword">extends</span> <span class="title class_">SpringBootCondition</span> <span class="keyword">implements</span> <span class="title class_">ConfigurationCondition</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>所以，我们自己也可以继承<code>SpringBootCondition</code>并实现<code>ConfigurationCondition</code>来自定义条件装配注解。</p><p>比较常用的几个条件装配注解：</p><ul><li>@ConditionalOnBean：当Spring容器中存在指定Bean时装配</li><li>@ConditionalOnClass：当存在指定Class时装配</li><li>@ConditionalOnMissingBean：当Spring容器中不存在指定Bean时装配</li><li>@ConditionalOnMissingClass：当不存在指定Class时装配</li></ul><h2 id="小试牛刀"><a href="#小试牛刀" class="headerlink" title="小试牛刀"></a>小试牛刀</h2><blockquote><p>我们将自动配置模块称为<code>greeter-spring-boot-autoconfigure</code>。该模块将有两个主要类，即<code>GreeterPropertie</code>s，它将通过<code>application.properties</code>文件和<code>GreeterAutoConfiguartion</code>设置自定义属性，并为greeter库创建bean。</p></blockquote><p>准备，创建假想的一个第三方工程：Greet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> GreetingConfig greetingConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Greeter</span><span class="params">(GreetingConfig greetingConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.greetingConfig = greetingConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">greet</span><span class="params">(LocalDateTime localDateTime)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> greetingConfig.getProperty(USER_NAME);</span><br><span class="line">        <span class="type">int</span> <span class="variable">hourOfDay</span> <span class="operator">=</span> localDateTime.getHour();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hourOfDay &gt;= <span class="number">5</span> &amp;&amp; hourOfDay &lt; <span class="number">12</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s, %s&quot;</span>, name, greetingConfig.get(MORNING_MESSAGE));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hourOfDay &gt;= <span class="number">12</span> &amp;&amp; hourOfDay &lt; <span class="number">17</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s, %s&quot;</span>, name, greetingConfig.get(AFTERNOON_MESSAGE));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hourOfDay &gt;= <span class="number">17</span> &amp;&amp; hourOfDay &lt; <span class="number">20</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s, %s&quot;</span>, name, greetingConfig.get(EVENING_MESSAGE));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s, %s&quot;</span>, name, greetingConfig.get(NIGHT_MESSAGE));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">greet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> greet(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterConfigParams</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_NAME</span> <span class="operator">=</span> <span class="string">&quot;user.name&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MORNING_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;morning.message&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AFTERNOON_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;afternoon.message&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVENING_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;evening.message&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NIGHT_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;night.message&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingConfig</span> <span class="keyword">extends</span> <span class="title class_">Properties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">5662570853707247891L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写Properties和AutoConfiguration：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;gcdd1993.greeter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String morningMessage;</span><br><span class="line">    <span class="keyword">private</span> String afternoonMessage;</span><br><span class="line">    <span class="keyword">private</span> String eveningMessage;</span><br><span class="line">    <span class="keyword">private</span> String nightMessage;</span><br><span class="line">    <span class="comment">// getter and setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Greeter.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(GreeterProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreeterProperties greeterProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> GreetingConfig <span class="title function_">greeterConfig</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> greeterProperties.getUserName() == <span class="literal">null</span></span><br><span class="line">                ? System.getProperty(<span class="string">&quot;user.name&quot;</span>)</span><br><span class="line">                : greeterProperties.getUserName();</span><br><span class="line">        <span class="type">GreetingConfig</span> <span class="variable">greetingConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GreetingConfig</span>();</span><br><span class="line">        greetingConfig.put(USER_NAME, userName);</span><br><span class="line">        <span class="keyword">if</span> (greeterProperties.getMorningMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            greetingConfig.put(MORNING_MESSAGE, greeterProperties.getMorningMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (greeterProperties.getAfternoonMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            greetingConfig.put(AFTERNOON_MESSAGE, greeterProperties.getAfternoonMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (greeterProperties.getEveningMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            greetingConfig.put(EVENING_MESSAGE, greeterProperties.getEveningMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (greeterProperties.getNightMessage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            greetingConfig.put(NIGHT_MESSAGE, greeterProperties.getNightMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> greetingConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> Greeter <span class="title function_">greeter</span><span class="params">(GreetingConfig greetingConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Greeter</span>(greetingConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在<code>src/main/resources/META-INF</code>目录下创建<code>spring.factories</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  com.gcdd.autoconfigure.GreeterAutoConfiguration</span><br></pre></td></tr></table></figure><p>测试一下：</p><ol><li>创建配置文件<code>application.properties</code>：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcdd1993.greeter.userName=gcdd1993</span><br><span class="line">gcdd1993.greeter.eveningMessage=good evening</span><br></pre></td></tr></table></figure><ol start="2"><li>使用Greeter bean</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterSampleApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Greeter greeter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GreeterSampleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> greeter.greet();</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行main方法，将会输出一行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello gcdd1993, good evening</span><br></pre></td></tr></table></figure><h1 id="为配置类添加提示"><a href="#为配置类添加提示" class="headerlink" title="为配置类添加提示"></a>为配置类添加提示</h1><p>我们知道，在Idea中，编写配置文件的时候，有智能提示</p><p><img src="https://i.loli.net/2019/08/06/MD7ZeTC6HVtYy3R.png"></p><p>其实这不是Idea搞的鬼，是由<code>META-INF/spring-configuration-metadata.json</code>文件配置好的，Idea只是负责解析这个文件，提供我们智能化的提示信息。</p><p>想要达到这个目的很简单，添加依赖<code>org.springframework.boot:spring-boot-configuration-processor</code>就行了。</p><p>Maven</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Gradle</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="keyword">group</span>: <span class="string">&#x27;org.springframework.boot&#x27;</span>, name: <span class="string">&#x27;spring-boot-configuration-processor&#x27;</span>, version: <span class="string">&#x27;2.1.6.RELEASE&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上就是<code>Spring Boot Starter</code>的全部内容了，如果要发布到maven仓库，供别人使用，可以使用<code>mvn install</code>打包发布至maven仓库。</p><p>👉 <a href="https://github.com/gcdd1993/Spring-Boot-Starter-Sample">本文代码地址</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Spring-Boot-Starter是什么？&quot;&gt;&lt;a href=&quot;#Spring-Boot-Starter是什么？&quot; class=&quot;headerlink&quot; title=&quot;Spring Boot Starter是什么？&quot;&gt;&lt;/a&gt;Spring Boot Starter是什么？&lt;/h1&gt;&lt;p&gt;依赖管理是任何复杂项目的关键部分。以手动的方式来实现依赖管理不太现实，你得花更多时间，同时你在项目的其他重要方面能付出的时间就会变得越少。&lt;/p&gt;
&lt;p&gt;Spring Boot starter 就是为了解决这个问题而诞生的。Starter POM 是一组方便的依赖描述符，您可以将其包含在应用程序中。您可以获得所需的所有 Spring 和相关技术的一站式服务，无需通过示例代码搜索和复制粘贴依赖。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring Boot" scheme="https://blog.gcdd.top/tags/Spring-Boot/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 安装MongoDB</title>
    <link href="https://blog.gcdd.top/p/49357/"/>
    <id>https://blog.gcdd.top/p/49357/</id>
    <published>2019-03-15T03:38:31.000Z</published>
    <updated>2023-08-30T04:52:53.905Z</updated>
    
    <content type="html"><![CDATA[<p>Ubuntu16.04安装MongoDB指南</p><span id="more"></span><h1 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt dist-upgrade</span><br><span class="line">$ sudo apt autoremove</span><br><span class="line">$ sudo apt clean</span><br></pre></td></tr></table></figure><h1 id="安装mongodb"><a href="#安装mongodb" class="headerlink" title="安装mongodb"></a>安装mongodb</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mongodb</span><br></pre></td></tr></table></figure><p>mongodb默认是监听在127.0.0.1端口的，要开启外网连接，需要修改mongodb配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mongodb.conf</span><br></pre></td></tr></table></figure><p><code>bind_ip = 127.0.0.1</code> 修改为<code>bind_ip = 0.0.0.0</code></p><h1 id="连接mongodb"><a href="#连接mongodb" class="headerlink" title="连接mongodb"></a>连接mongodb</h1><p>使用工具<a href="https://robomongo.org/">robo 3t</a>，添加连接信息</p><p><img src="https://i.loli.net/2019/03/15/5c8b2c0d28653.png"></p><h1 id="启用密码访问"><a href="#启用密码访问" class="headerlink" title="启用密码访问"></a>启用密码访问</h1><p>mongodb默认是不开启密码登录的，如果要开启，修改mongodb配置文件：</p><p>取消<code>#auth = true</code>前面的注释，并重启mongodb<code>service mongodb restart</code></p><p>添加用户信息:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use test_db;</span><br><span class="line">db.createUser(&#123;user:<span class="string">&#x27;cool&#x27;</span>, <span class="built_in">pwd</span>:<span class="string">&#x27;cool&#x27;</span>, roles: [ &#123; role: <span class="string">&quot;readWrite&quot;</span>, db: <span class="string">&quot;test_db&quot;</span> &#125; ]&#125;);</span><br></pre></td></tr></table></figure><h1 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h1><p>连接方式跟上面类似，唯一不同的是要添加authentication，指定database，username，password，以及选择Mongodb-CR验证方式<br><img src="https://i.loli.net/2019/03/15/5c8b2c0d0f52e.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Ubuntu16.04安装MongoDB指南&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="NoSql" scheme="https://blog.gcdd.top/tags/NoSql/"/>
    
    <category term="MongoDB" scheme="https://blog.gcdd.top/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Spring Event事件驱动</title>
    <link href="https://blog.gcdd.top/p/18285/"/>
    <id>https://blog.gcdd.top/p/18285/</id>
    <published>2019-03-14T05:15:01.000Z</published>
    <updated>2023-08-30T04:52:53.903Z</updated>
    
    <content type="html"><![CDATA[<p>Spring事件驱动模型，简单来说类似于Message-Queue消息队列中的Pub/Sub发布/订阅模式，也类似于Java设计模式中的观察者模式。</p><span id="more"></span><h1 id="自定义事件"><a href="#自定义事件" class="headerlink" title="自定义事件"></a>自定义事件</h1><p>Spring的事件接口位于<code>org.springframework.context.ApplicationEvent</code>，源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ApplicationEvent</span> <span class="keyword">extends</span> <span class="title class_">EventObject</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7099057708183571937L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> timestamp;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ApplicationEvent</span><span class="params">(Object source)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>(source);</span><br><span class="line"><span class="built_in">this</span>.timestamp = System.currentTimeMillis();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">getTimestamp</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.timestamp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继承了Java的事件对象<code>EventObject</code>，所以可以使用<code>getSource()</code>方法来获取到事件传播对象。</p><h2 id="自定义Spring事件"><a href="#自定义Spring事件" class="headerlink" title="自定义Spring事件"></a>自定义Spring事件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomSpringEvent</span><span class="params">(Object source, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(source);</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后定义事件监听器，该监听器实际上等同于消费者，需要交给Spring容器管理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;CustomSpringEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(CustomSpringEvent event)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Received spring custom event - &quot;</span> + event.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后定义事件发布者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventPublisher</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doStuffAndPublishAnEvent</span><span class="params">(<span class="keyword">final</span> String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Publishing custom event. &quot;</span>);</span><br><span class="line">        <span class="type">CustomSpringEvent</span> <span class="variable">customSpringEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomSpringEvent</span>(<span class="built_in">this</span>, message);</span><br><span class="line">        applicationEventPublisher.publishEvent(customSpringEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventPublisherTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomSpringEventPublisher publisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishStringEventTest</span><span class="params">()</span> &#123;</span><br><span class="line">        publisher.doStuffAndPublishAnEvent(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试类，可以看到控制台打印了两条重要信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//发布事件</span><br><span class="line">Publishing custom event. </span><br><span class="line">//监听器得到了事件，并相应处理</span><br><span class="line">Received spring custom event - 111</span><br></pre></td></tr></table></figure><p>由于Spring事件是发布/订阅的模式,而发布订阅模式有以下三种情况</p><ol><li>1生产者 - 1消费者</li><li>1生产者 - 多消费者</li><li>多生产者 - 多消费者</li></ol><p>上面举的例子是第一种情况，我们来试试其他两个情况</p><p>继续创建一个事件监听器作为消费者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventListener2</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;CustomSpringEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(CustomSpringEvent event)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringEventListener2 Received spring custom event - &quot;</span> + event.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试类后，可以观察到，控制台顺序打印了两条消费信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Publishing custom event. </span><br><span class="line">CustomSpringEventListener1 Received spring custom event - 111</span><br><span class="line">CustomSpringEventListener2 Received spring custom event - 111</span><br></pre></td></tr></table></figure><p>说明，Spring的发布订阅模式是广播模式，所有消费者都能接受到消息，并正常消费</p><p>再试试第三种多生产者 - 多消费者的情况</p><p>继续创建一个发布者，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventPublisher2</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doStuffAndPublishAnEvent</span><span class="params">(<span class="keyword">final</span> String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringEventPublisher2 Publishing custom event. &quot;</span>);</span><br><span class="line">        <span class="type">CustomSpringEvent</span> <span class="variable">customSpringEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomSpringEvent</span>(<span class="built_in">this</span>, message);</span><br><span class="line">        applicationEventPublisher.publishEvent(customSpringEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CustomSpringEventPublisher Publishing custom event. </span><br><span class="line">CustomSpringEventListener1 Received spring custom event - <span class="number">111</span></span><br><span class="line">CustomSpringEventListener2 Received spring custom event - <span class="number">111</span></span><br><span class="line">CustomSpringEventPublisher2 Publishing custom event. </span><br><span class="line">CustomSpringEventListener1 Received spring custom event - <span class="number">222</span></span><br><span class="line">CustomSpringEventListener2 Received spring custom event - <span class="number">222</span></span><br></pre></td></tr></table></figure><p>从以上输出内容，我们可以猜测到，Spring的事件发布订阅机制是同步进行的，也就是说，事件必须被所有消费者消费完成之后，发布者的代码才能继续往下走，这显然不是我们想要的效果，那有没有异步执行的事件呢？</p><h1 id="Spring中的异步事件"><a href="#Spring中的异步事件" class="headerlink" title="Spring中的异步事件"></a>Spring中的异步事件</h1><p>要使用Spring 的异步事件，我们需要自定义异步事件配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsynchronousSpringEventsConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;applicationEventMulticaster&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApplicationEventMulticaster <span class="title function_">simpleApplicationEventMulticaster</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SimpleApplicationEventMulticaster</span> <span class="variable">eventMulticaster</span></span><br><span class="line">                <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleApplicationEventMulticaster</span>();</span><br><span class="line"></span><br><span class="line">        eventMulticaster.setTaskExecutor(<span class="keyword">new</span> <span class="title class_">SimpleAsyncTaskExecutor</span>());</span><br><span class="line">        <span class="keyword">return</span> eventMulticaster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发布和订阅的代码不用变动，直接运行测试类，控制台将打印出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CustomSpringEventPublisher Publishing custom event. </span><br><span class="line">CustomSpringEventPublisher2 Publishing custom event. </span><br><span class="line">CustomSpringEventListener1 Received spring custom event - 111</span><br><span class="line">CustomSpringEventListener2 Received spring custom event - 111</span><br><span class="line">CustomSpringEventListener2 Received spring custom event - 222</span><br><span class="line">CustomSpringEventListener1 Received spring custom event - 222</span><br></pre></td></tr></table></figure><p>可以看到，两个发布者几乎同时运行，证明监听器是异步执行的，没有阻塞住发布者的代码。准确的说，监听器将在一个单独的线程中异步处理事件。</p><h1 id="Spring自带的事件类型"><a href="#Spring自带的事件类型" class="headerlink" title="Spring自带的事件类型"></a>Spring自带的事件类型</h1><p>事件驱动在Spring中是被广泛采用的，我们查看ApplicationEvent的子类可以发现许多Event事件，在此不赘述。</p><p><img src="https://i.loli.net/2019/03/14/5c8a206832ffd.png"></p><h1 id="注解驱动的监听器"><a href="#注解驱动的监听器" class="headerlink" title="注解驱动的监听器"></a>注解驱动的监听器</h1><p>从Spring 4.2开始，事件监听器不需要是实现<code>ApplicationListener</code>接口的bean，它可以通过<code>@EventListener</code>注解在任何被Spring容器管理的bean的公共方法上。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationDrivenContextStartedListener</span> &#123;</span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleContextStart</span><span class="params">(CustomSpringEvent cse)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling Custom Spring Event.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输出结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CustomSpringEventPublisher Publishing custom event.</span><br><span class="line">Handling Custom Spring Event.</span><br><span class="line">CustomSpringEventPublisher2 Publishing custom event. </span><br><span class="line">Handling Custom Spring Event.</span><br></pre></td></tr></table></figure><p>同样的，我们可以看出，这个事件监听器是同步执行的，如果要改为异步监听器，在事件方法上加上<code>@Async</code>，并且在Spring应用中开启异步支持(在<code>SpringBootApplication</code>上添加<code>@EnableAsync</code>)。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationDrivenContextStartedListener</span> &#123;</span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleContextStart</span><span class="params">(CustomSpringEvent cse)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling Custom Spring Event.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次运行测试类:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CustomSpringEventPublisher Publishing custom event. </span><br><span class="line">CustomSpringEventPublisher2 Publishing custom event. </span><br><span class="line">Handling Custom Spring Event.</span><br><span class="line">Handling Custom Spring Event.</span><br></pre></td></tr></table></figure><h1 id="泛型支持"><a href="#泛型支持" class="headerlink" title="泛型支持"></a>泛型支持</h1><p>创建一个通用泛型事件模型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericSpringEvent</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T message;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GenericSpringEvent</span><span class="params">(T what, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = what;</span><br><span class="line">        <span class="built_in">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意<code>GenericSpringEvent</code>和<code>CustomSpringEvent</code>之间的区别。我们现在可以灵活地发布任何任意事件，并且不再需要从<code>ApplicationEvent</code>扩展。</p><p>这样的话，我们无法像之前一样，通过继承<code>ApplicationListener</code>的方式来定义一个监听器，因为<code>ApplicationListener</code>定义了事件必须是<code>ApplicationEvent</code>的子类。所以，我们只能使用注解驱动的监听器。</p><p>通过在<code>@EventListener</code>注释上定义布尔SpEL表达式，也可以使事件监听器成为条件。在这种情况下，只会为成功的String的<code>GenericSpringEvent</code>调用事件处理程序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationDrivenEventListener</span> &#123;</span><br><span class="line">    <span class="meta">@EventListener(condition = &quot;#event.success&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleSuccessful</span><span class="params">(GenericSpringEvent&lt;String&gt; event)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Handling generic event (conditional).&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义具体类型的事件:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringGenericSpringEvent</span> <span class="keyword">extends</span> <span class="title class_">GenericSpringEvent</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StringGenericSpringEvent</span><span class="params">(String message, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义发布者：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringGenericSpringEventPublisher</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doStuffAndPublishAnEvent</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CustomSpringEventPublisher Publishing custom event. &quot;</span>);</span><br><span class="line">        <span class="type">StringGenericSpringEvent</span> <span class="variable">springEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringGenericSpringEvent</span>(message, success);</span><br><span class="line">        applicationEventPublisher.publishEvent(springEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringEventPublisherTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringGenericSpringEventPublisher publisher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishStringEventTest</span><span class="params">()</span> &#123;</span><br><span class="line">        publisher.doStuffAndPublishAnEvent(<span class="string">&quot;success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        publisher.doStuffAndPublishAnEvent(<span class="string">&quot;failed&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CustomSpringEventPublisher Publishing custom event. </span><br><span class="line">Handling generic event (conditional) success</span><br><span class="line">CustomSpringEventPublisher Publishing custom event. </span><br></pre></td></tr></table></figure><p>监听器只处理了成功的事件，成功忽略掉了失败的事件。这样的好处是，可以为同一个事件定义成功和失败不同的操作。</p><h1 id="Spring事件的事务绑定"><a href="#Spring事件的事务绑定" class="headerlink" title="Spring事件的事务绑定"></a>Spring事件的事务绑定</h1><p>从Spring 4.2开始，框架提供了一个新的<code>@TransactionalEventListener</code>注解，它是<code>@EventListener</code>的扩展，允许将事件的侦听器绑定到事务的一个阶段。绑定可以进行以下事务阶段：</p><ul><li>AFTER_COMMIT(默认的)：在事务成功后触发</li><li>AFTER_ROLLBACK:事务回滚时触发</li><li>AFTER_COMPLETION：事务完成后触发，不论是否成功</li><li>BEFORE_COMMIT：事务提交之前触发</li></ul><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol><li>Spring中处理事件的基础知识：创建一个简单的自定义事件，发布它，然后在监听器中处理它。</li><li>在配置中启用事件的异步处理。</li><li>Spring 4.2中引入的改进，例如注释驱动的侦听器，更好的泛型支持以及绑定到事务阶段的事件。</li></ol><p>👉 <a href="https://github.com/gcdd1993/spring-event-demo">本文代码地址</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Spring事件驱动模型，简单来说类似于Message-Queue消息队列中的Pub/Sub发布/订阅模式，也类似于Java设计模式中的观察者模式。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Spring的BeanFactory和FactoryBean</title>
    <link href="https://blog.gcdd.top/p/17046/"/>
    <id>https://blog.gcdd.top/p/17046/</id>
    <published>2019-03-12T09:01:29.000Z</published>
    <updated>2023-08-30T04:52:53.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="官方定义"><a href="#官方定义" class="headerlink" title="官方定义"></a>官方定义</h1><ul><li>BeanFactory：Spring Bean容器的根接口</li><li>FactoryBean：各个对象的工厂接口，如果bean实现了这个接口，它将被用作对象的工厂，而不是直接作为bean实例。</li></ul><span id="more"></span><h1 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h1><h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactory</span> &#123;</span><br><span class="line">    <span class="comment">//标注是获取FactoryBean的实现类，而不是调用getObject()获取的实例</span></span><br><span class="line"><span class="type">String</span> <span class="variable">FACTORY_BEAN_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;&amp;&quot;</span>;</span><br><span class="line">Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&lt;T&gt; T <span class="title function_">getBean</span><span class="params">(String name, Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">Object <span class="title function_">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; requiredType, Object... args)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">containsBean</span><span class="params">(String name)</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isPrototype</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTypeMatch</span><span class="params">(String name, ResolvableType typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isTypeMatch</span><span class="params">(String name, Class&lt;?&gt; typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line">Class&lt;?&gt; getType(String name) <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line">String[] getAliases(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源码的方法定义上，就可以看出，<code>BeanFactory</code>作为bean的容器管理器，提供了一系列获取bean以及获取bean属性的方法。</p><p>写一个小例子试验下：</p><p>SimpleBean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello Spring Bean!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring配置文件config.xml：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;simpleBean&quot;</span> class=<span class="string">&quot;base.SimpleBeanFactoryBean&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line">    <span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getAutowireCapableBeanFactory();</span><br><span class="line">    System.out.println(<span class="string">&quot;通过名称获取bean&quot;</span>);</span><br><span class="line">    <span class="type">SimpleBean</span> <span class="variable">simpleBean</span> <span class="operator">=</span> (SimpleBean) beanFactory.getBean(<span class="string">&quot;simpleBean&quot;</span>);</span><br><span class="line">    simpleBean.send();</span><br><span class="line">    System.out.println(<span class="string">&quot;通过名称和类型获取bean&quot;</span>);</span><br><span class="line">    simpleBean = beanFactory.getBean(<span class="string">&quot;simpleBean&quot;</span>, SimpleBean.class);</span><br><span class="line">    simpleBean.send();</span><br><span class="line">    System.out.println(<span class="string">&quot;通过类型获取bean&quot;</span>);</span><br><span class="line">    simpleBean = beanFactory.getBean(SimpleBean.class);</span><br><span class="line">    simpleBean.send();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">containsBean</span> <span class="operator">=</span> beanFactory.containsBean(<span class="string">&quot;simpleBean&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;是否包含 simpleBean ? &quot;</span> + containsBean);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">singleton</span> <span class="operator">=</span> beanFactory.isSingleton(<span class="string">&quot;simpleBean&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;是否是单例? &quot;</span> + singleton);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> beanFactory.isTypeMatch(<span class="string">&quot;simpleBean&quot;</span>, ResolvableType.forClass(SimpleBean.class));</span><br><span class="line">    System.out.println(<span class="string">&quot;是否是SimpleBean类型 ? &quot;</span> + match);</span><br><span class="line">    match = beanFactory.isTypeMatch(<span class="string">&quot;simpleBean&quot;</span>, SimpleBean.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;是否是SimpleBean类型 ? &quot;</span> + match);</span><br><span class="line">    Class&lt;?&gt; aClass = beanFactory.getType(<span class="string">&quot;simpleBean&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;simpleBean 的类型是 &quot;</span> + aClass.getName());</span><br><span class="line">    String[] aliases = beanFactory.getAliases(<span class="string">&quot;simpleBean&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;simpleBean 的别名 : &quot;</span> + Arrays.toString(aliases));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">通过名称获取bean</span><br><span class="line">Hello Spring Bean!</span><br><span class="line">通过名称和类型获取bean</span><br><span class="line">Hello Spring Bean!</span><br><span class="line">通过类型获取bean</span><br><span class="line">Hello Spring Bean!</span><br><span class="line">是否包含 simpleBean ? true</span><br><span class="line">是否是单例? true</span><br><span class="line">是否是SimpleBean类型 ? true</span><br><span class="line">是否是SimpleBean类型 ? true</span><br><span class="line">simpleBean 的类型是 base.SimpleBean</span><br><span class="line">simpleBean 的别名 : []</span><br></pre></td></tr></table></figure><h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FactoryBean</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取一个bean，如果配置了工厂bean，在getBean的时候，将会调用此方法，获取一个bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取bean的类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是单例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口是泛型，定义了三个方法，其中<code>getObject()</code>是工厂模式的体现，将会通过此方法返回一个bean的实例。</p><p>一个小例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBeanFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;SimpleBean&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SimpleBean <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyFactoryBean getObject&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyFactoryBean getObjectType&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> SimpleBean.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上可以修改为单例模式，可以做成线程安全的单例，可塑性较高。</p><p>配置文件config.xml:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;simple&quot;</span> class=<span class="string">&quot;base.SimpleBeanFactoryBean&quot;</span>/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>注意，我们在这里只配置了<code>SimpleBeanFactoryBean</code>，并没有配置<code>SimpleBean</code>，接下来看下<code>getBean</code>方法的输出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;config.xml&quot;</span>);</span><br><span class="line"><span class="type">SimpleBean</span> <span class="variable">simpleBean</span> <span class="operator">=</span> context.getBean(SimpleBean.class);</span><br><span class="line">simpleBean.send();</span><br></pre></td></tr></table></figure><p>控制台输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyFactoryBean getObjectType</span><br><span class="line">MyFactoryBean getObject</span><br><span class="line">Hello Spring Bean!</span><br></pre></td></tr></table></figure><p>由此我们可以看出<code>FactoryBean</code>的执行流程</p><ol><li>通过<code>getObjectType</code>获取bean的类型</li><li>调用<code>getObject</code>方法获取bean的实例</li></ol><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>BeanFactory</code>和<code>FactoryBean</code>其实没有关系，只是名称比较像而已。</p><ul><li><code>BeanFactory</code>是IOC最基本的容器，负责生产和管理bean，它为其他具体的IOC容器提供了最基本的规范。</li><li><code>FactoryBean</code>是一个接口，当在IOC容器中的Bean实现了<code>FactoryBean</code>后，通过<code>getBean(String BeanName)</code>获取到的Bean对象并不是<code>FactoryBean</code>的实现类对象，而是这个实现类中的<code>getObject()</code>方法返回的对象。要想获取<code>FactoryBean</code>的实现类，就要<code>getBean(&amp;BeanName)</code>，在<code>BeanName</code>之前加上&amp;。</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;官方定义&quot;&gt;&lt;a href=&quot;#官方定义&quot; class=&quot;headerlink&quot; title=&quot;官方定义&quot;&gt;&lt;/a&gt;官方定义&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;BeanFactory：Spring Bean容器的根接口&lt;/li&gt;
&lt;li&gt;FactoryBean：各个对象的工厂接口，如果bean实现了这个接口，它将被用作对象的工厂，而不是直接作为bean实例。&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Jackson使用指南</title>
    <link href="https://blog.gcdd.top/p/56384/"/>
    <id>https://blog.gcdd.top/p/56384/</id>
    <published>2019-01-21T12:12:32.000Z</published>
    <updated>2023-08-30T04:52:53.899Z</updated>
    
    <content type="html"><![CDATA[<p>从事JAVA开发工作以来,一直都离不开Jackson的序列化反序列化,对于Jackson的使用也一直处于够用但不深入的状态，下面是日常使用过程中对Jackson的总结。</p><span id="more"></span><h1 id="Jackson常用注解"><a href="#Jackson常用注解" class="headerlink" title="Jackson常用注解"></a>Jackson常用注解</h1><h2 id="序列化注解"><a href="#序列化注解" class="headerlink" title="序列化注解"></a>序列化注解</h2><h3 id="JsonAnyGetter"><a href="#JsonAnyGetter" class="headerlink" title="@JsonAnyGetter"></a>@JsonAnyGetter</h3><blockquote><p>像普通属性一样序列化Map</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtendableBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; properties;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonAnyGetter</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attr2&quot;</span><span class="punctuation">:</span><span class="string">&quot;val2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attr1&quot;</span><span class="punctuation">:</span><span class="string">&quot;val1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonGetter"><a href="#JsonGetter" class="headerlink" title="@JsonGetter"></a>@JsonGetter</h3><blockquote><p>将指定的方法标记为<code>getter</code>方法。可以用来代替<code>@JsonProperty</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonGetter(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTheName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonPropertyOrder"><a href="#JsonPropertyOrder" class="headerlink" title="@JsonPropertyOrder"></a>@JsonPropertyOrder</h3><blockquote><p>用在类上，在序列化的时候自定义属性输出顺序</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonPropertyOrder(&#123; &quot;name&quot;, &quot;id&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonRawValue"><a href="#JsonRawValue" class="headerlink" title="@JsonRawValue"></a>@JsonRawValue</h3><blockquote><p>完全按照原样序列化属性的值</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RawBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonRawValue</span></span><br><span class="line">    <span class="keyword">public</span> String json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RawBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RawBean</span>(<span class="string">&quot;My bean&quot;</span>, <span class="string">&quot;&#123;\&quot;attr\&quot;:false&#125;&quot;</span>);</span><br></pre></td></tr></table></figure><p>将序列化为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;json&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;attr&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>而不是：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;json&quot;</span><span class="punctuation">:</span><span class="string">&quot;&#123;\&quot;attr\&quot;:false&#125;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonValue"><a href="#JsonValue" class="headerlink" title="@JsonValue"></a>@JsonValue</h3><blockquote><p>定义整个实体的序列化方法，Jackson将会使用该方法的输出作为序列化输出。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TypeEnumWithValue</span> &#123;</span><br><span class="line">    TYPE1(<span class="number">1</span>, <span class="string">&quot;Type A&quot;</span>), TYPE2(<span class="number">2</span>, <span class="string">&quot;Type 2&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// standard constructors</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonValue</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Type 2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonRootName"><a href="#JsonRootName" class="headerlink" title="@JsonRootName"></a>@JsonRootName</h3><blockquote><p>如果需要将实体包装一层，可以使用<code>@JsonRootName</code>来指定根包装器的名称</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonRootName(value = &quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserWithRoot</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果不用该注解，将会序列化为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonSerialize"><a href="#JsonSerialize" class="headerlink" title="@JsonSerialize"></a>@JsonSerialize</h3><blockquote><p>用于指定自定义序列化器来序列化实体</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonSerialize(using = CustomDateSerializer.class)</span></span><br><span class="line">    <span class="keyword">public</span> Date eventDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义序列化器如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDateSerializer</span> <span class="keyword">extends</span> <span class="title class_">StdSerializer</span>&lt;Date&gt; &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SimpleDateFormat</span> <span class="variable">formatter</span> </span><br><span class="line">      <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;dd-MM-yyyy hh:mm:ss&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDateSerializer</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDateSerializer</span><span class="params">(Class&lt;Date&gt; t)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(t); </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(</span></span><br><span class="line"><span class="params">      Date value, JsonGenerator gen, SerializerProvider arg2)</span> </span><br><span class="line">      <span class="keyword">throws</span> IOException, JsonProcessingException &#123;</span><br><span class="line">        gen.writeString(formatter.format(value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;eventDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20-12-2014 02:30:00&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="反序列化注解"><a href="#反序列化注解" class="headerlink" title="反序列化注解"></a>反序列化注解</h2><h3 id="JsonCreator"><a href="#JsonCreator" class="headerlink" title="@JsonCreator"></a>@JsonCreator</h3><blockquote><p>指定反序列化使用的构造函数或方法</p></blockquote><p>待反序列化Json示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;theName&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithCreator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BeanWithCreator</span><span class="params">(<span class="meta">@JsonProperty(&quot;id&quot;)</span> <span class="type">int</span> id, <span class="meta">@JsonProperty(&quot;theName&quot;)</span> String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JacksonInject"><a href="#JacksonInject" class="headerlink" title="@JacksonInject"></a>@JacksonInject</h3><blockquote><p>指定某个字段从注入赋值，而不是从Json</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithInject</span> &#123;</span><br><span class="line">    <span class="meta">@JacksonInject</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例用法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;My bean\&quot;&#125;&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">InjectableValues</span> <span class="variable">inject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectableValues</span>.Std()</span><br><span class="line">  .addValue(<span class="type">int</span>.class, <span class="number">1</span>);</span><br><span class="line"><span class="type">BeanWithInject</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().reader(inject)</span><br><span class="line">  .forType(BeanWithInject.class)</span><br><span class="line">  .readValue(json);</span><br></pre></td></tr></table></figure><h3 id="JsonAnySetter"><a href="#JsonAnySetter" class="headerlink" title="@JsonAnySetter"></a>@JsonAnySetter</h3><blockquote><p>在反序列化时，将Map当成普通属性</p></blockquote><p>待反序列化Json：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;My bean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attr2&quot;</span><span class="punctuation">:</span><span class="string">&quot;val2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attr1&quot;</span><span class="punctuation">:</span><span class="string">&quot;val1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtendableBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; properties;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonAnySetter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        properties.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>properties</code>字段的值将会是由 <code>attr2 -&gt; val2,attr1 -&gt; val1</code>组成的键值对。</p><h3 id="JsonSetter"><a href="#JsonSetter" class="headerlink" title="@JsonSetter"></a>@JsonSetter</h3><blockquote><p>将方法标记为<code>setter</code>方法，可以指定属性名称</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonSetter(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTheName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonDeserialize"><a href="#JsonDeserialize" class="headerlink" title="@JsonDeserialize"></a>@JsonDeserialize</h3><blockquote><p>用于指定自定义反序列化器来反序列化实体</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonDeserialize(using = CustomDateDeserializer.class)</span></span><br><span class="line">    <span class="keyword">public</span> Date eventDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的反序列化器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDateDeserializer</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="title class_">StdDeserializer</span>&lt;Date&gt; &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SimpleDateFormat</span> <span class="variable">formatter</span></span><br><span class="line">      <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;dd-MM-yyyy hh:mm:ss&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDateDeserializer</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>); </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDateDeserializer</span><span class="params">(Class&lt;?&gt; vc)</span> &#123; </span><br><span class="line">        <span class="built_in">super</span>(vc); </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">deserialize</span><span class="params">(</span></span><br><span class="line"><span class="params">      JsonParser jsonparser, DeserializationContext context)</span> </span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">         </span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> jsonparser.getText();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> formatter.parse(date);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Jackson设置属性是否参与序列化"><a href="#Jackson设置属性是否参与序列化" class="headerlink" title="Jackson设置属性是否参与序列化"></a>Jackson设置属性是否参与序列化</h2><h3 id="JsonIgnoreProperties"><a href="#JsonIgnoreProperties" class="headerlink" title="@JsonIgnoreProperties"></a>@JsonIgnoreProperties</h3><blockquote><p>在类上指定要忽略的属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIgnoreProperties(&#123; &quot;id&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithIgnore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonIgnore"><a href="#JsonIgnore" class="headerlink" title="@JsonIgnore"></a>@JsonIgnore</h3><blockquote><p>在具体属性上忽略，使其不参与序列化过程</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithIgnore</span> &#123;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与<code>@JsonIgnoreProperties</code>是等效的。</p><h3 id="JsonIgnoreType"><a href="#JsonIgnoreType" class="headerlink" title="@JsonIgnoreType"></a>@JsonIgnoreType</h3><blockquote><p>用在类上，将忽略该类所有属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> Name name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonIgnoreType</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Name</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String firstName;</span><br><span class="line">        <span class="keyword">public</span> String lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonInclude"><a href="#JsonInclude" class="headerlink" title="@JsonInclude"></a>@JsonInclude</h3><blockquote><p>用于排除值为<code>empty/null/default</code>的属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonInclude(Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonAutoDetect"><a href="#JsonAutoDetect" class="headerlink" title="@JsonAutoDetect"></a>@JsonAutoDetect</h3><blockquote><p>强制序列化私有属性，不管它有没有<code>getter</code>方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonAutoDetect(fieldVisibility = Visibility.ANY)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivateBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Jackson处理多态"><a href="#Jackson处理多态" class="headerlink" title="Jackson处理多态"></a>Jackson处理多态</h2><p>一般都是组合起来使用，有下面三个注解：</p><ul><li>@JsonTypeInfo<blockquote><p>指定序列化中包含的类型信息的详细信息</p></blockquote></li><li>@JsonSubTypes<blockquote><p>指定带注释类型的子类型</p></blockquote></li><li>@JsonTypeName<blockquote><p>指定用于带注释的类的逻辑类型名称</p></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zoo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Animal animal;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonTypeInfo(</span></span><br><span class="line"><span class="meta">      use = JsonTypeInfo.Id.NAME, </span></span><br><span class="line"><span class="meta">      include = As.PROPERTY, </span></span><br><span class="line"><span class="meta">      property = &quot;type&quot;)</span></span><br><span class="line">    <span class="meta">@JsonSubTypes(&#123;</span></span><br><span class="line"><span class="meta">        @JsonSubTypes.Type(value = Dog.class, name = &quot;dog&quot;),</span></span><br><span class="line"><span class="meta">        @JsonSubTypes.Type(value = Cat.class, name = &quot;cat&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonTypeName(&quot;dog&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> barkVolume;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonTypeName(&quot;cat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Cat</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> likesCream;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> lives;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述例子中，指定属性<code>type</code>为判断具体子类的依据，例如：<code>type=dog</code>，将被序列化为<code>Dog</code>类型。</p><h2 id="Jackson通用注解（序列化反序列化都生效）"><a href="#Jackson通用注解（序列化反序列化都生效）" class="headerlink" title="Jackson通用注解（序列化反序列化都生效）"></a>Jackson通用注解（序列化反序列化都生效）</h2><h3 id="JsonProperty"><a href="#JsonProperty" class="headerlink" title="@JsonProperty"></a>@JsonProperty</h3><blockquote><p>指定JSON中的属性名称</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonProperty(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTheName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonProperty(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTheName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonFormat"><a href="#JsonFormat" class="headerlink" title="@JsonFormat"></a>@JsonFormat</h3><blockquote><p>用于在序列化日期/时间值时指定格式。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonFormat(</span></span><br><span class="line"><span class="meta">      shape = JsonFormat.Shape.STRING,</span></span><br><span class="line"><span class="meta">      pattern = &quot;dd-MM-yyyy hh:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Date eventDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonUnwrapped"><a href="#JsonUnwrapped" class="headerlink" title="@JsonUnwrapped"></a>@JsonUnwrapped</h3><blockquote><p>将对象中所有的属性与当前平级，不太好描述，简单说就是拆开包装。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnwrappedUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonUnwrapped</span></span><br><span class="line">    <span class="keyword">public</span> Name name;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Name</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String firstName;</span><br><span class="line">        <span class="keyword">public</span> String lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="string">&quot;Doe&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果不加<code>@JsonUnwrapped</code>注解，将被序列化为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span><span class="punctuation">:</span><span class="string">&quot;Doe&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="JsonView"><a href="#JsonView" class="headerlink" title="@JsonView"></a>@JsonView</h3><blockquote><p>指定视图，类似分组进行序列化/反序列化</p></blockquote><p>定义视图：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Views</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Public</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Internal</span> <span class="keyword">extends</span> <span class="title class_">Public</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义实体：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Item</span> &#123;</span><br><span class="line">    <span class="meta">@JsonView(Views.Public.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonView(Views.Public.class)</span></span><br><span class="line">    <span class="keyword">public</span> String itemName;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonView(Views.Internal.class)</span></span><br><span class="line">    <span class="keyword">public</span> String ownerName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>()</span><br><span class="line">  .writerWithView(Views.Public.class)</span><br><span class="line">  .writeValueAsString(item);</span><br></pre></td></tr></table></figure><p>这时，将只会序列化<code>id</code>和<code>itemName</code>字段</p><h3 id="JsonManagedReference-JsonBackReference"><a href="#JsonManagedReference-JsonBackReference" class="headerlink" title="@JsonManagedReference, @JsonBackReference"></a>@JsonManagedReference, @JsonBackReference</h3><blockquote><p>@JsonManagedReference和@JsonBackReference注释用于处理父/子关系并解决循环问题。</p></blockquote><p>例如，有两个相互引用的类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemWithRef</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String itemName;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonManagedReference</span></span><br><span class="line">    <span class="keyword">public</span> UserWithRef owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserWithRef</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@JsonBackReference</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemWithRef&gt; userItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不加注解，会循环调用，导致内存溢出，这时候可以使用<code>@JsonManagedReference</code>和<code>@JsonBackReference</code>来避免内存溢出。</p><h3 id="JsonIdentityInfo"><a href="#JsonIdentityInfo" class="headerlink" title="@JsonIdentityInfo"></a>@JsonIdentityInfo</h3><blockquote><p>用于指定在序列化/反序列化值时使用对象标识，例如，处理无限递归类型的问题。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIdentityInfo(</span></span><br><span class="line"><span class="meta">  generator = ObjectIdGenerators.PropertyGenerator.class,</span></span><br><span class="line"><span class="meta">  property = &quot;id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemWithIdentity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String itemName;</span><br><span class="line">    <span class="keyword">public</span> UserWithIdentity owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JsonFilter"><a href="#JsonFilter" class="headerlink" title="@JsonFilter"></a>@JsonFilter</h3><blockquote><p>指定序列化期间要使用的过滤器。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFilter(&quot;myFilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanWithFilter</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWithFilter</span>(<span class="number">1</span>, <span class="string">&quot;My bean&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">FilterProvider</span> <span class="variable">filters</span> </span><br><span class="line">  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleFilterProvider</span>().addFilter(</span><br><span class="line">    <span class="string">&quot;myFilter&quot;</span>, </span><br><span class="line">    SimpleBeanPropertyFilter.filterOutAllExcept(<span class="string">&quot;name&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>()</span><br><span class="line">  .writer(filters)</span><br><span class="line">  .writeValueAsString(bean);</span><br></pre></td></tr></table></figure><h2 id="自定义Jackson注解"><a href="#自定义Jackson注解" class="headerlink" title="自定义Jackson注解"></a>自定义Jackson注解</h2><p>可以使用@JacksonAnnotationsInside来开发自定义注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line">    <span class="meta">@JacksonAnnotationsInside</span></span><br><span class="line">    <span class="meta">@JsonInclude(Include.NON_NULL)</span></span><br><span class="line">    <span class="meta">@JsonPropertyOrder(&#123; &quot;name&quot;, &quot;id&quot;, &quot;dateCreated&quot; &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> CustomAnnotation &#123;&#125;</span><br></pre></td></tr></table></figure><p>如何使用自定义注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CustomAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithCustomAnnotation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> Date dateCreated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义注解可以<strong>增强代码复用</strong>，把一些通用的Jackson注解组合起来，形成一个新注解，新注解可以代替组合的注解。</p><h2 id="Jackson-MixIn-注解"><a href="#Jackson-MixIn-注解" class="headerlink" title="Jackson MixIn 注解"></a>Jackson MixIn 注解</h2><blockquote><p>动态地为某些类型增加统一的Jackson注解</p></blockquote><p>实体：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Item</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String itemName;</span><br><span class="line">    <span class="keyword">public</span> User owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MixIn类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIgnoreType</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMixInForIgnoreType</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>我们可以动态地让<code>User</code>类型不参与序列化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Item</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Item</span>(<span class="number">1</span>, <span class="string">&quot;book&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">mapper.addMixIn(User.class, MyMixInForIgnoreType.class);</span><br><span class="line">result = mapper.writeValueAsString(item);</span><br></pre></td></tr></table></figure><h2 id="禁用Jackson注解"><a href="#禁用Jackson注解" class="headerlink" title="禁用Jackson注解"></a>禁用Jackson注解</h2><p>假设我们有一个带Jackson注解的实体：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonInclude(Include.NON_NULL)</span></span><br><span class="line"><span class="meta">@JsonPropertyOrder(&#123; &quot;name&quot;, &quot;id&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以这样来禁用该实体上的所有Jackson注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">mapper.disable(MapperFeature.USE_ANNOTATIONS);</span><br></pre></td></tr></table></figure><h1 id="Jackson的ObjectMapper用法"><a href="#Jackson的ObjectMapper用法" class="headerlink" title="Jackson的ObjectMapper用法"></a>Jackson的<code>ObjectMapper</code>用法</h1><h2 id="java类-转换为-json"><a href="#java类-转换为-json" class="headerlink" title="java类 转换为 json"></a>java类 转换为 json</h2><p>可以直接序列化为Json字符串：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.writeValueAsString(car);</span><br></pre></td></tr></table></figure><p>或者，可以序列化到文件，文件内容是Json字符串：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.writeValue(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/car.json&quot;</span>), car);</span><br></pre></td></tr></table></figure><h2 id="json-转换为-java类"><a href="#json-转换为-java类" class="headerlink" title="json 转换为 java类"></a>json 转换为 java类</h2><p>从字符串：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;&quot;</span>;</span><br><span class="line">objectMapper.readValue(json, Car.class); </span><br></pre></td></tr></table></figure><p>从文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.readValue(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/json_car.json&quot;</span>), Car.class);</span><br></pre></td></tr></table></figure><p>从URL：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.readValue(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;target/json_car.json&quot;</span>), Car.class);</span><br></pre></td></tr></table></figure><h2 id="json转换为Jackson-JsonNode"><a href="#json转换为Jackson-JsonNode" class="headerlink" title="json转换为Jackson JsonNode"></a>json转换为Jackson JsonNode</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;&quot;</span>;</span><br><span class="line"><span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> objectMapper.readTree(json);</span><br><span class="line"><span class="type">String</span> <span class="variable">color</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;color&quot;</span>).asText();</span><br><span class="line"><span class="comment">// Output: color -&gt; Black</span></span><br></pre></td></tr></table></figure><h2 id="json-转换为-java集合"><a href="#json-转换为-java集合" class="headerlink" title="json 转换为 java集合"></a>json 转换为 java集合</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonCarArray</span> <span class="operator">=</span> </span><br><span class="line">  <span class="string">&quot;[&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;, &#123; \&quot;color\&quot; : \&quot;Red\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;]&quot;</span>;</span><br><span class="line">List&lt;Car&gt; listCar = objectMapper.readValue(jsonCarArray, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Car&gt;&gt;()&#123;&#125;);</span><br></pre></td></tr></table></figure><h2 id="json-转换为-Map"><a href="#json-转换为-Map" class="headerlink" title="json 转换为 Map"></a>json 转换为 Map</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;&quot;</span>;</span><br><span class="line">Map&lt;String, Object&gt; map = objectMapper.readValue(json, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String,Object&gt;&gt;()&#123;&#125;);</span><br></pre></td></tr></table></figure><h2 id="ObjectMapper的常用配置"><a href="#ObjectMapper的常用配置" class="headerlink" title="ObjectMapper的常用配置"></a><code>ObjectMapper</code>的常用配置</h2><p>忽略不识别的字段（json属性与目标实体存在属性上的差异）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>允许原始值为null：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>允许将枚举序列化/反序列化为数字：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.configure(DeserializationFeature.FAIL_ON_NUMBERS_FOR_ENUMS, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h2 id="配置自定义序列化-反序列化器"><a href="#配置自定义序列化-反序列化器" class="headerlink" title="配置自定义序列化/反序列化器"></a>配置自定义序列化/反序列化器</h2><p>假设有一个序列化器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCarSerializer</span> <span class="keyword">extends</span> <span class="title class_">StdSerializer</span>&lt;Car&gt; &#123;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCarSerializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCarSerializer</span><span class="params">(Class&lt;Car&gt; t)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(t);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(</span></span><br><span class="line"><span class="params">      Car car, JsonGenerator jsonGenerator, SerializerProvider serializer)</span> &#123;</span><br><span class="line">        jsonGenerator.writeStartObject();</span><br><span class="line">        jsonGenerator.writeStringField(<span class="string">&quot;car_brand&quot;</span>, car.getType());</span><br><span class="line">        jsonGenerator.writeEndObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个反序列化器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCarDeserializer</span> <span class="keyword">extends</span> <span class="title class_">StdDeserializer</span>&lt;Car&gt; &#123;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCarDeserializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCarDeserializer</span><span class="params">(Class&lt;?&gt; vc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(vc);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">deserialize</span><span class="params">(JsonParser parser, DeserializationContext deserializer)</span> &#123;</span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line">        <span class="type">ObjectCodec</span> <span class="variable">codec</span> <span class="operator">=</span> parser.getCodec();</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">node</span> <span class="operator">=</span> codec.readTree(parser);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// try catch block</span></span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">colorNode</span> <span class="operator">=</span> node.get(<span class="string">&quot;color&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">color</span> <span class="operator">=</span> colorNode.asText();</span><br><span class="line">        car.setColor(color);</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用<code>ObjectMapper</code>使用他们：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加自定义序列化器</span></span><br><span class="line"><span class="keyword">module</span>.addSerializer(Car.class, <span class="keyword">new</span> <span class="title class_">CustomCarSerializer</span>());</span><br><span class="line"><span class="comment">//添加自定义反序列化器</span></span><br><span class="line"><span class="keyword">module</span>.addDeserializer(Car.class, <span class="keyword">new</span> <span class="title class_">CustomCarDeserializer</span>());</span><br></pre></td></tr></table></figure><h2 id="处理日期格式化"><a href="#处理日期格式化" class="headerlink" title="处理日期格式化"></a>处理日期格式化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="type">DateFormat</span> <span class="variable">df</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm a z&quot;</span>);</span><br><span class="line">objectMapper.setDateFormat(df);</span><br></pre></td></tr></table></figure><h2 id="处理集合"><a href="#处理集合" class="headerlink" title="处理集合"></a>处理集合</h2><p>反序列化为数组：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonCarArray</span> <span class="operator">=</span> </span><br><span class="line">  <span class="string">&quot;[&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;, &#123; \&quot;color\&quot; : \&quot;Red\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;]&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">objectMapper.configure(DeserializationFeature.USE_JAVA_ARRAY_FOR_JSON_ARRAY, <span class="literal">true</span>);</span><br><span class="line">Car[] cars = objectMapper.readValue(jsonCarArray, Car[].class);</span><br></pre></td></tr></table></figure><p>反序列化为集合：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonCarArray</span> <span class="operator">=</span> </span><br><span class="line">  <span class="string">&quot;[&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;, &#123; \&quot;color\&quot; : \&quot;Red\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;]&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">List&lt;Car&gt; listCar = objectMapper.readValue(jsonCarArray, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Car&gt;&gt;()&#123;&#125;);</span><br></pre></td></tr></table></figure><h1 id="ObjectMapper的基本用法"><a href="#ObjectMapper的基本用法" class="headerlink" title="ObjectMapper的基本用法"></a><code>ObjectMapper</code>的基本用法</h1><h2 id="ObjectMapper可以通过configure方法设置全局序列化-反序列化行为，例如："><a href="#ObjectMapper可以通过configure方法设置全局序列化-反序列化行为，例如：" class="headerlink" title="ObjectMapper可以通过configure方法设置全局序列化/反序列化行为，例如："></a><code>ObjectMapper</code>可以通过<code>configure</code>方法设置全局序列化/反序列化行为，例如：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>常用的一些设置：</p><ol><li><code>DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</code>：忽略不识别的字段</li><li><code>DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES</code>：允许使用属性的默认值进行反序列化</li><li><code>DeserializationFeature.FAIL_ON_NUMBERS_FOR_ENUMS</code>：允许将枚举值序列化/反序列化为数字</li></ol><h2 id="注册自定义序列化-反序列化程序"><a href="#注册自定义序列化-反序列化程序" class="headerlink" title="注册自定义序列化/反序列化程序"></a>注册自定义序列化/反序列化程序</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个模块</span></span><br><span class="line"><span class="type">SimpleModule</span> <span class="variable">module</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleModule</span>(<span class="string">&quot;CustomCarSerializer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Version</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line"><span class="comment">//将自定义序列化/反序列化程序注册到模块</span></span><br><span class="line"><span class="keyword">module</span>.addSerializer(Car.class, <span class="keyword">new</span> <span class="title class_">CustomCarSerializer</span>());</span><br><span class="line"><span class="comment">//module.addDeserializer(Car.class, new CustomCarDeserializer());</span></span><br><span class="line"><span class="comment">//注册模块</span></span><br><span class="line">mapper.registerModule(<span class="keyword">module</span>);</span><br></pre></td></tr></table></figure><h2 id="处理日期格式"><a href="#处理日期格式" class="headerlink" title="处理日期格式"></a>处理日期格式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DateFormat</span> <span class="variable">df</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm a z&quot;</span>);</span><br><span class="line">mapper.setDateFormat(df);</span><br></pre></td></tr></table></figure><h2 id="处理集合-1"><a href="#处理集合-1" class="headerlink" title="处理集合"></a>处理集合</h2><h3 id="处理数组"><a href="#处理数组" class="headerlink" title="处理数组"></a>处理数组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonCarArray</span> <span class="operator">=</span> <span class="string">&quot;[&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;, &#123; \&quot;color\&quot; : \&quot;Red\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;]&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">objectMapper.configure(DeserializationFeature.USE_JAVA_ARRAY_FOR_JSON_ARRAY, <span class="literal">true</span>);</span><br><span class="line">Car[] cars = objectMapper.readValue(jsonCarArray, Car[].class);</span><br></pre></td></tr></table></figure><h3 id="处理集合-2"><a href="#处理集合-2" class="headerlink" title="处理集合"></a>处理集合</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonCarArray</span> <span class="operator">=</span> <span class="string">&quot;[&#123; \&quot;color\&quot; : \&quot;Black\&quot;, \&quot;type\&quot; : \&quot;BMW\&quot; &#125;, &#123; \&quot;color\&quot; : \&quot;Red\&quot;, \&quot;type\&quot; : \&quot;FIAT\&quot; &#125;]&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">List&lt;Car&gt; listCar = objectMapper.readValue(jsonCarArray, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Car&gt;&gt;()&#123;&#125;);</span><br></pre></td></tr></table></figure><h1 id="Jackson注解扩展"><a href="#Jackson注解扩展" class="headerlink" title="Jackson注解扩展"></a>Jackson注解扩展</h1><h2 id="JsonIdentityReference"><a href="#JsonIdentityReference" class="headerlink" title="@JsonIdentityReference"></a>@JsonIdentityReference</h2><blockquote><p>使用指定的标识来序列化Java对象，而不是序列化整个对象</p></blockquote><p>例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = &quot;id&quot;)</span></span><br><span class="line"><span class="meta">@JsonIdentityReference(alwaysAsId = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithoutIdentityReference</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将被序列化为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="JsonAppend"><a href="#JsonAppend" class="headerlink" title="@JsonAppend"></a>@JsonAppend</h2><blockquote><p>运行在序列化时添加额外的属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonAppend(attrs = &#123; </span></span><br><span class="line"><span class="meta">  @JsonAppend.Attr(value = &quot;version&quot;) </span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanWithAppend</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// constructor, getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如，我们在序列化时手动增加<code>version = 1.0</code>的属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanWithAppend</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWithAppend</span>(<span class="number">2</span>, <span class="string">&quot;Bean With Append Annotation&quot;</span>);</span><br><span class="line"><span class="type">ObjectWriter</span> <span class="variable">writer</span> <span class="operator">=</span> mapper.writerFor(BeanWithAppend.class).withAttribute(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> writer.writeValueAsString(bean);</span><br></pre></td></tr></table></figure><p>序列化结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bean With Append Annotation&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="JsonNaming"><a href="#JsonNaming" class="headerlink" title="@JsonNaming"></a>@JsonNaming</h2><blockquote><p>指定序列化的时候属性命名方式</p></blockquote><p>有四种选项：</p><ul><li><code>KEBAB_CASE</code><blockquote><p>由连字符分割，例如：kebab-case</p></blockquote></li><li><code>LOWER_CASE</code><blockquote><p>所有的字母都转换为小写，例如：lowercase</p></blockquote></li><li><code>SNAKE_CASE</code><blockquote><p>所有的字母都转换为小写，并且由下划线分割，例如：snake_case</p></blockquote></li><li><code>UPPER_CAMEL_CASE</code><blockquote><p>所有名称元素，包括第一个元素，都以大写字母开头，后跟小写字母，并且没有分隔符，例如：UpperCamelCase</p></blockquote></li></ul><p>使用举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonNaming(PropertyNamingStrategy.SnakeCaseStrategy.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NamingBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JsonPropertyDescription"><a href="#JsonPropertyDescription" class="headerlink" title="@JsonPropertyDescription"></a><code>@JsonPropertyDescription</code></h2><blockquote><p>用于生成字段的描述信息</p></blockquote><p>例如，有下面一个实体：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertyDescriptionBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="meta">@JsonPropertyDescription(&quot;This is a description of the name property&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以输出该类的信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SchemaFactoryWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaFactoryWrapper</span>();</span><br><span class="line">mapper.acceptJsonFormatVisitor(PropertyDescriptionBean.class, wrapper);</span><br><span class="line"><span class="type">JsonSchema</span> <span class="variable">jsonSchema</span> <span class="operator">=</span> wrapper.finalSchema();</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> mapper.writeValueAsString(jsonSchema);</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;urn:jsonschema:com:baeldung:jackson:annotation:extra:PropertyDescriptionBean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is a description of the name property&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> </span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="JsonPOJOBuilder"><a href="#JsonPOJOBuilder" class="headerlink" title="@JsonPOJOBuilder"></a>@JsonPOJOBuilder</h2><blockquote><p>自定义生成器类，来控制json的反序列化行为</p></blockquote><p><code>@JsonPOJOBuilder</code>有两个属性：</p><ul><li><code>buildMethodName</code><blockquote><p>将JSON字段绑定到bean的属性后，用于实例化预期bean的无参构造的名称。默认名称为<code>build</code>。</p></blockquote></li><li><code>withPrefix</code><blockquote><p>用于自动检测JSON和bean属性之间匹配的名称前缀。默认前缀为<code>with</code>。</p></blockquote></li></ul><p>假设我们要反序列化的json如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;POJO Builder Bean&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>对应的pojo：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonDeserialize(builder = BeanBuilder.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POJOBuilderBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> identity;</span><br><span class="line">    <span class="keyword">private</span> String beanName;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// constructor, getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的生成器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonPOJOBuilder(buildMethodName = &quot;createBean&quot;, withPrefix = &quot;construct&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> idValue;</span><br><span class="line">    <span class="keyword">private</span> String nameValue;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> BeanBuilder <span class="title function_">constructId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        idValue = id;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> BeanBuilder <span class="title function_">constructName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        nameValue = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> POJOBuilderBean <span class="title function_">createBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">POJOBuilderBean</span>(idValue, nameValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>ObjectMapper</code>反序列化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;id\&quot;:5,\&quot;name\&quot;:\&quot;POJO Builder Bean\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">POJOBuilderBean</span> <span class="variable">bean</span> <span class="operator">=</span> mapper.readValue(jsonString, POJOBuilderBean.class);</span><br></pre></td></tr></table></figure><hr><p>👉 <a href="https://github.com/gcdd1993/Jackson-Guide-With-Samples">代码仓库</a><br>👉 <a href="https://www.baeldung.com/jackson">Jackson JSON Tutorial</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;从事JAVA开发工作以来,一直都离不开Jackson的序列化反序列化,对于Jackson的使用也一直处于够用但不深入的状态，下面是日常使用过程中对Jackson的总结。&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Jackson" scheme="https://blog.gcdd.top/tags/Jackson/"/>
    
  </entry>
  
  <entry>
    <title>后端跨域的N种方法</title>
    <link href="https://blog.gcdd.top/p/34331/"/>
    <id>https://blog.gcdd.top/p/34331/</id>
    <published>2019-01-21T11:11:31.000Z</published>
    <updated>2023-08-30T04:52:53.909Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>简单来说，CORS是一种访问机制，英文全称是Cross-Origin Resource Sharing，即我们常说的跨域资源共享，通过在服务器端设置响应头，把发起跨域的原始域名添加到Access-Control-Allow-Origin 即可。</p></blockquote><span id="more"></span><h1 id="返回新的CorsFilter-全局跨域"><a href="#返回新的CorsFilter-全局跨域" class="headerlink" title="返回新的CorsFilter(全局跨域)"></a>返回新的CorsFilter(全局跨域)</h1><blockquote><p>在任意配置类，返回一个新的CorsFilter Bean，并添加映射路径和具体的CORS配置信息。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalCorsConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1.添加CORS配置信息</span></span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        <span class="comment">//放行哪些原始域</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//是否发送Cookie信息</span></span><br><span class="line">        config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//放行哪些原始域(请求方式)</span></span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//放行哪些原始域(头部信息)</span></span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//暴露哪些头部信息(因为跨域访问默认不能获取全部头部信息)</span></span><br><span class="line">        config.addExposedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.添加映射路径</span></span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">configSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        configSource.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.返回新的CorsFilter.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(configSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="使用注解-局部跨域"><a href="#使用注解-局部跨域" class="headerlink" title="使用注解(局部跨域)"></a>使用注解(局部跨域)</h1><h2 id="在方法上-RequestMapping-使用注解-CrossOrigin"><a href="#在方法上-RequestMapping-使用注解-CrossOrigin" class="headerlink" title="在方法上(@RequestMapping)使用注解 @CrossOrigin"></a>在方法上(@RequestMapping)使用注解 <code>@CrossOrigin</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@CrossOrigin(&quot;http://localhost:8080&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="在控制器-Controller-上使用注解-CrossOrigin"><a href="#在控制器-Controller-上使用注解-CrossOrigin" class="headerlink" title="在控制器(@Controller)上使用注解 @CrossOrigin"></a>在控制器(@Controller)上使用注解 <code>@CrossOrigin</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;http://domain.com&quot;, maxAge = 3600)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="手工设置响应头-局部跨域"><a href="#手工设置响应头-局部跨域" class="headerlink" title="手工设置响应头(局部跨域)"></a>手工设置响应头(局部跨域)</h2><blockquote><p>使用HttpServletResponse对象添加响应头（Access-Control-Allow-Origin）来授权原始域，这里Origin的值也可以设置为”*” ，表示全部放行。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">    response.addHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Nginx配置跨域"><a href="#Nginx配置跨域" class="headerlink" title="Nginx配置跨域"></a>Nginx配置跨域</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream server &#123;</span><br><span class="line">        server 127.0.0.1:8091;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name domain.com;</span><br><span class="line"></span><br><span class="line">        location ^~/api &#123;</span><br><span class="line">                //添加跨域请求头</span><br><span class="line">                proxy_set_header Access-Control-Allow-Origin *;</span><br><span class="line">                proxy_set_header Access-Control-Allow-Methods *;</span><br><span class="line">                proxy_set_header Access-Control-Allow-Headers *;</span><br><span class="line"></span><br><span class="line">                if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">                        return 204;</span><br><span class="line">                &#125;</span><br><span class="line">                rewrite ^/api/(.+?)$ /$1 break;</span><br><span class="line">                proxy_pass http://server;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;简单来说，CORS是一种访问机制，英文全称是Cross-Origin Resource Sharing，即我们常说的跨域资源共享，通过在服务器端设置响应头，把发起跨域的原始域名添加到Access-Control-Allow-Origin 即可。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="跨域" scheme="https://blog.gcdd.top/tags/%E8%B7%A8%E5%9F%9F/"/>
    
  </entry>
  
  <entry>
    <title>解决Spring Security自定义filter重复执行问题</title>
    <link href="https://blog.gcdd.top/p/356/"/>
    <id>https://blog.gcdd.top/p/356/</id>
    <published>2019-01-14T11:29:51.000Z</published>
    <updated>2023-08-30T04:52:53.912Z</updated>
    
    <content type="html"><![CDATA[<p>今天做项目的时候，发现每次拦截器日志都会打两遍，很纳闷，怀疑是Filter被执行了两遍。结果debug之后发现还真是！记录一下这个神奇的BUG！<span id="more"></span></p><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>项目中使用的是Spring-security作为权限框架，然后做了一个<code>JwtAuthenticationTokenFilter</code>作为拦截器拦截请求，校验Token，但是每次请求都会打两遍日志。下面是精简的源代码:</p><p>自定义的Filter类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(</span></span><br><span class="line"><span class="params">            HttpServletRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response,</span></span><br><span class="line"><span class="params">            FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//...省略</span></span><br><span class="line">        <span class="comment">//打出两遍日志的地方</span></span><br><span class="line">        log.info(<span class="string">&quot;User:&#123;&#125; request path:&#123;&#125;, method:&#123;&#125;, param:&#123;&#125;&quot;</span>, username, request.getServletPath(),</span><br><span class="line">                request.getMethod(), request.getParameterMap() == <span class="literal">null</span> ? <span class="literal">null</span> : OBJECT_MAPPER.writeValueAsString(request.getParameterMap()));</span><br><span class="line">        <span class="comment">//...省略</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WebSecurityConfig配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//...省略</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationTokenFilter <span class="title function_">authenticationTokenFilterBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationTokenFilter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//...省略</span></span><br><span class="line">        <span class="comment">//把JwtAuthenticationTokenFilter加入到RememberMeAuthenticationFilter之前</span></span><br><span class="line">        httpSecurity.addFilterBefore(authenticationTokenFilterBean(), RememberMeAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求日志如下:</p><p><img src="https://i.loli.net/2019/01/14/5c3c75bd6e40b.png"></p><h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><p>把自定义Filter<code>JwtAuthenticationTokenFilter</code>的<code>@Component</code>取消掉就可以了，不让它被Spring容器管理。</p><h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>在spring容器托管的OncePerRequestFilter的bean，都会自动加入到servlet的filter chain，而上面的定义，还额外把filter加入到了spring security的<br>ememberMeAuthenticationFilter之前。而spring security也是一系列的filter，在mvc的filter之前执行。因此在鉴权通过的情况下，就会先后各执行一次。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://segmentfault.com/a/1190000012173419">解决spring security自定义filter重复执行问题</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天做项目的时候，发现每次拦截器日志都会打两遍，很纳闷，怀疑是Filter被执行了两遍。结果debug之后发现还真是！记录一下这个神奇的BUG！</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring-Security" scheme="https://blog.gcdd.top/tags/Spring-Security/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud feign使用okhttp3</title>
    <link href="https://blog.gcdd.top/p/7382/"/>
    <id>https://blog.gcdd.top/p/7382/</id>
    <published>2019-01-13T16:13:04.000Z</published>
    <updated>2023-08-30T04:52:53.904Z</updated>
    
    <content type="html"><![CDATA[<p>spring cloud feign使用okhttp3<span id="more"></span></p><h1 id="指南"><a href="#指南" class="headerlink" title="指南"></a>指南</h1><p>maven</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign.httpclient.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">feign.okhttp.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><p>配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Feign.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore(FeignAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignOkHttpConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OkHttpLoggingInterceptor okHttpLoggingInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> okhttp3.OkHttpClient <span class="title function_">okHttpClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">okhttp3</span>.OkHttpClient.Builder()</span><br><span class="line">            .readTimeout(<span class="number">60</span>, TimeUnit.SECONDS) </span><br><span class="line">            .connectTimeout(<span class="number">60</span>, TimeUnit.SECONDS) </span><br><span class="line">            .writeTimeout(<span class="number">120</span>, TimeUnit.SECONDS) </span><br><span class="line">            .connectionPool(<span class="keyword">new</span> <span class="title class_">ConnectionPool</span>())</span><br><span class="line">            <span class="comment">// .addInterceptor();</span></span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>不需要额外编写FeignOkHttpConfig，feign本身已经存在FeignOkHttpAutoConfiguration了，不需要额外配置。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;spring cloud feign使用okhttp3</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring Cloud" scheme="https://blog.gcdd.top/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Cloud微服务踩坑记录</title>
    <link href="https://blog.gcdd.top/p/61811/"/>
    <id>https://blog.gcdd.top/p/61811/</id>
    <published>2019-01-13T16:08:58.000Z</published>
    <updated>2023-08-30T04:52:53.906Z</updated>
    
    <content type="html"><![CDATA[<p>记录在开发微服务过程中遇到的问题以及解决方案。<span id="more"></span></p><h1 id="No-Feign-Client-for-loadBalancing-defined-Did-you-forget-to-include-spring-cloud-starter-netflix-ribbon"><a href="#No-Feign-Client-for-loadBalancing-defined-Did-you-forget-to-include-spring-cloud-starter-netflix-ribbon" class="headerlink" title="No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?"></a>No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?</h1><h1 id="feignclient和-requestmapping混用的时候出错"><a href="#feignclient和-requestmapping混用的时候出错" class="headerlink" title="@feignclient和@requestmapping混用的时候出错"></a>@feignclient和@requestmapping混用的时候出错</h1><p>重写springmvc扫描controller时不带有@feignclient才实例化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;Feign.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebMvcRegistrations <span class="title function_">feignWebRegistrations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcRegistrationsAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">getRequestMappingHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FeignRequestMappingHandlerMapping</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FeignRequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title class_">RequestMappingHandlerMapping</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.isHandler(beanType) &amp;&amp;</span><br><span class="line">                    !AnnotatedElementUtils.hasAnnotation(beanType, FeignClient.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="SpringCloud使用Zuul出现“Forwarding-error”错误解决方法"><a href="#SpringCloud使用Zuul出现“Forwarding-error”错误解决方法" class="headerlink" title="SpringCloud使用Zuul出现“Forwarding error”错误解决方法"></a>SpringCloud使用Zuul出现“Forwarding error”错误解决方法</h1><p>在application.yml中添加ribbon的超时时间设置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span>  </span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">    <span class="attr">host:</span></span><br><span class="line">        <span class="attr">connect-timeout-millis:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">socket-timeout-millis:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">        <span class="attr">default:</span></span><br><span class="line">            <span class="attr">execution:</span></span><br><span class="line">                <span class="attr">isolation:</span></span><br><span class="line">                    <span class="attr">thread:</span></span><br><span class="line">                        <span class="attr">timeout-in-milliseconds:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;记录在开发微服务过程中遇到的问题以及解决方案。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring Cloud" scheme="https://blog.gcdd.top/tags/Spring-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>我的Java环境搭建</title>
    <link href="https://blog.gcdd.top/p/12106/"/>
    <id>https://blog.gcdd.top/p/12106/</id>
    <published>2019-01-12T17:15:13.000Z</published>
    <updated>2023-08-30T04:52:53.910Z</updated>
    
    <content type="html"><![CDATA[<p>每次重装系统后的开发环境搭建，总是会花费大量的时间精力，软件下载安装啦，配置修改啦等等，索性把这些流程记录一下，毕竟时间就是金钱。<span id="more"></span></p><h1 id="软件列表"><a href="#软件列表" class="headerlink" title="软件列表"></a>软件列表</h1><ul><li>JDK1.8</li><li>IntelliJ IDEA</li><li>Navicat数据库管理工具</li><li>Postman</li><li>Git</li><li>SourceTree</li><li>XShell5</li><li>DevCenter(cassandra数据库管理工具)</li><li>RedisDesktopManager(redis管理工具)</li></ul><p>这些工具已经可以满足我的日常工作了，什么印象笔记，markdownPad2等等不包含于此。<br>这些都可以在我的博客下载到 -&gt; <a href="https://gcdd1993.github.io/2019/01/08/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E9%9B%86%E5%90%88/#more">常用软件集合</a></p><h1 id="软件配置"><a href="#软件配置" class="headerlink" title="软件配置"></a>软件配置</h1><h2 id="IntelliJ-IDEA"><a href="#IntelliJ-IDEA" class="headerlink" title="IntelliJ IDEA"></a>IntelliJ IDEA</h2><h3 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h3><p><a href="http://idea.lanyus.com/">IntelliJ IDEA 注册码</a></p><h3 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h3><p>当然是选黑色主题了，毕竟提倡保护眼睛。</p><p><img src="https://i.imgur.com/wyJ25mS.png"></p><h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p>我一般使用默认字体+14号大小。</p><p><img src="https://i.imgur.com/4gl570N.png"></p><h3 id="设置编辑器的快捷键，也就是keymap"><a href="#设置编辑器的快捷键，也就是keymap" class="headerlink" title="设置编辑器的快捷键，也就是keymap"></a>设置编辑器的快捷键，也就是keymap</h3><p>由于以前用惯了Eclipse,所以还得改为Eclipse的快捷键</p><p><img src="https://i.imgur.com/GokNm9o.png"></p><h3 id="代码自动提示不区分大小写"><a href="#代码自动提示不区分大小写" class="headerlink" title="代码自动提示不区分大小写"></a>代码自动提示不区分大小写</h3><p>这个比较重要，毕竟谁也不可能无时无刻注意大小写，到时候不快捷提示就浪费太多时间了，也影响开发体验。</p><p><img src="https://i.loli.net/2019/01/13/5c3a2d475bb3b.png"></p><h3 id="自动导入包和导入包优化的设置"><a href="#自动导入包和导入包优化的设置" class="headerlink" title="自动导入包和导入包优化的设置"></a>自动导入包和导入包优化的设置</h3><p><img src="https://i.loli.net/2019/01/13/5c3a2d473806d.png"></p><h3 id="Java代码默认注释"><a href="#Java代码默认注释" class="headerlink" title="Java代码默认注释"></a>Java代码默认注释</h3><p>一般创建一个java类的时候，需要指定创建者以及创建时间</p><p><img src="https://i.loli.net/2019/01/13/5c3a2d473b94e.png"></p><p>注释代码可以自己决定，这里举个例子:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> $&#123;DATE&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p> 然后创建的类是这样的:</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gaochen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/31</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h3 id="IntelliJ-IDEA启动设置不默认打开前一个项目"><a href="#IntelliJ-IDEA启动设置不默认打开前一个项目" class="headerlink" title="IntelliJ IDEA启动设置不默认打开前一个项目"></a>IntelliJ IDEA启动设置不默认打开前一个项目</h3><p> <img src="https://i.loli.net/2019/01/14/5c3be5127420c.png"></p><h3 id="IntelliJ-IDEA常用插件"><a href="#IntelliJ-IDEA常用插件" class="headerlink" title="IntelliJ IDEA常用插件"></a>IntelliJ IDEA常用插件</h3><ul><li>.ignore:自动生成.ignore文件，并支持一键添加文件到.ignore列表</li><li>Grep Console:在控制台支持筛选，类似shell命令的cat 1.txt | grep ‘11’</li><li>Lombok plugin:使用lombok必须要装的一个插件</li><li>CodeGlance:代码编辑区迷你缩放图插件，非常好用</li><li>HighlightBracketPair:自动化高亮显示光标所在代码块对应的括号，可以定制颜色和形状，再也不怕看代码看到眼花了</li><li>Rainbow Brackets:彩色显示所有括号,有点类似上一个</li><li>Alibaba Java Coding Guidelines:阿里巴巴Java开发手册配套插件，一键扫描帮你优化代码。</li><li>Codota：让代码提示更加智能（只支持Java）</li></ul><h2 id="Navicat"><a href="#Navicat" class="headerlink" title="Navicat"></a>Navicat</h2><h3 id="破解-1"><a href="#破解-1" class="headerlink" title="破解"></a>破解</h3><p><a href="https://www.jianshu.com/p/42a33b0dda9c">Navicat Premium 12.0.18 / 12.0.24安装与激活</a></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://segmentfault.com/a/1190000013504412">Intellij IDEA插件推荐</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;每次重装系统后的开发环境搭建，总是会花费大量的时间精力，软件下载安装啦，配置修改啦等等，索性把这些流程记录一下，毕竟时间就是金钱。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>EntityManager的Clear方法的使用</title>
    <link href="https://blog.gcdd.top/p/12153/"/>
    <id>https://blog.gcdd.top/p/12153/</id>
    <published>2019-01-11T14:37:28.000Z</published>
    <updated>2023-08-30T04:52:53.898Z</updated>
    
    <content type="html"><![CDATA[<p>在日常开发中，如果使用hibernate的话，常常会被hibernate的事务搞得焦头烂额。今天解决了之前项目中一直存在的问题，记录一下。<span id="more"></span></p><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>有一张表TemplateCopy,如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateCopy</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;template&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;SubDomainWeightsCopy&gt; subDomainWeights;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;template&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;QuestionWeightsCopy&gt; questionWeights;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关联了两张表:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubDomainWeightsCopy</span> &#123;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;template_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> TemplateCopy template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;sub_domain_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> SubDomainCopy subDomain;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal weights; <span class="comment">//权重</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal score;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RelationId</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Integer template;</span><br><span class="line">        <span class="keyword">private</span> Integer subDomain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionWeightsCopy</span> <span class="keyword">implements</span> <span class="title class_">IWeightsValue</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;template_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> TemplateCopy template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;question_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> QuestionCopy question;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal weights;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal score;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RelationId</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Integer template;</span><br><span class="line">        <span class="keyword">private</span> Integer question;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单的看一下，TemplateCopy中有一堆SubDomainWeightsCopy，和一堆QuestionWeightsCopy，我们在保存TemplateCopy的时候，通常按照如下来保存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> templateCopy = save(TemplateCopy)</span><br><span class="line"><span class="number">2.</span> QuestionWeightsCopy.setTemplateCopy(templateCopy)</span><br><span class="line"><span class="number">3.</span> save(QuestionWeightsCopy)</span><br><span class="line"><span class="number">4.</span> SubDomainWeightsCopy.setTemplateCopy(templateCopy)</span><br><span class="line"><span class="number">5.</span> save(SubDomainWeightsCopy)</span><br></pre></td></tr></table></figure><p>到这就好了，数据库已经保存了关联关系。但是，这时候如果返回save好的templateCopy，subDomainWeights和questionWeights将会是null。</p><h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><h2 id="使用EntityManager的clear方法"><a href="#使用EntityManager的clear方法" class="headerlink" title="使用EntityManager的clear方法"></a>使用EntityManager的clear方法</h2><ol><li>保存完毕后，执行entityManager.clear();</li><li>然后再次查询该对象，即可完整返回该对象。</li></ol><h3 id="EntityManager-clear的作用？"><a href="#EntityManager-clear的作用？" class="headerlink" title="EntityManager clear的作用？"></a>EntityManager clear的作用？</h3><p>EntityManager clear方法会清空其关联的缓存，从而强制在事务中稍后执行新的数据库查询。</p><h3 id="什么时候使用EntityManager-clear"><a href="#什么时候使用EntityManager-clear" class="headerlink" title="什么时候使用EntityManager clear"></a>什么时候使用EntityManager clear</h3><ol><li>在进行批处理时，为了避免巨大的缓存占用内存并因长时间的脏检查而增加刷新的时间</li><li>在进行DML或SQL查询时，它将完全绕过实体管理器缓存。在这种情况下，由于缓存，将不会实际去数据库查，会直接将缓存返回。所以造成了数据库已经保存了，但是查出来还是未保存的状态。这时候需要清除缓存以避免这种不一致。(本案例就是这种情况的实际例子)</li></ol><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://stackoverflow.com/questions/13886608/when-to-use-entitymanager-clear" title="StackOverFlow大神回答">StackOverFlow大神回答</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在日常开发中，如果使用hibernate的话，常常会被hibernate的事务搞得焦头烂额。今天解决了之前项目中一直存在的问题，记录一下。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring" scheme="https://blog.gcdd.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Postman使用技巧</title>
    <link href="https://blog.gcdd.top/p/4537/"/>
    <id>https://blog.gcdd.top/p/4537/</id>
    <published>2019-01-11T06:13:35.000Z</published>
    <updated>2023-08-30T04:52:53.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Postman是什么"><a href="#Postman是什么" class="headerlink" title="Postman是什么"></a>Postman是什么</h1><p>Postman是chrome的一款插件,用于做接口请求测试,无论是前端,后台还是测试人员,都可以用postman来测试接口,用起来非常方便。<span id="more"></span></p><h1 id="Postman安装"><a href="#Postman安装" class="headerlink" title="Postman安装"></a>Postman安装</h1><h2 id="官网下载-翻墙"><a href="#官网下载-翻墙" class="headerlink" title="官网下载(翻墙)"></a>官网下载(翻墙)</h2><p><a href="https://www.getpostman.com/downloads/">https://www.getpostman.com/downloads/</a></p><h2 id="蓝奏云"><a href="#蓝奏云" class="headerlink" title="蓝奏云"></a>蓝奏云</h2><p><a href="https://www.lanzous.com/i2en5xc">https://www.lanzous.com/i2en5xc</a></p><h1 id="Postman常用功能"><a href="#Postman常用功能" class="headerlink" title="Postman常用功能"></a>Postman常用功能</h1><p>安装好之后，我们先打开Postman，可以看到界面分成左右两个部分，右边是我们后头要讲的collection，左边是现在要讲的request builder。在request builder中，我们可以通过Postman快速的随意组装出我们希望的request。一般来说，所有的HTTP Request都分成4个部分，URL, method, headers和body。而Postman针对这几部分都有针对性的工具。</p><p><img src="https://i.imgur.com/JHqfDbU.png"></p><h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>要组装一条Request, URL永远是你首先要填的内容，在Postman里面你曾输入过的URL是可以通过下拉自动补全的哦。如果你点击Params按钮，Postman会弹出一个键值编辑器，你可以在哪里输入URL的Parameter，Postman会帮你自动加入到URL当中，反之，如果你的URL当中已经有了参数，那Postman会在你打开键值编辑器的时候把参数自动载入</p><p><img src="https://i.imgur.com/OyiHdls.png"></p><h2 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h2><p>点击’Headers’按钮，Postman同样会弹出一个键值编辑器。在这里，你可以随意添加你想要的Header attribute，同样Postman为我们通过了很贴心的auto-complete功能，敲入一个字母，你可以从下拉菜单里选择你想要的标准atrribute</p><p><img src="https://i.imgur.com/N0KHlcZ.png"></p><h2 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h2><p>要选择Request的Method是很简单的，Postman支持所有的Method，而一旦你选择了Method，Postman的request body编辑器会根据的你选择，自动的发生改变。</p><p><img src="https://i.imgur.com/vJl711X.png"></p><h2 id="Request-Body"><a href="#Request-Body" class="headerlink" title="Request Body"></a>Request Body</h2><p>如果我们要创建的request是类似于POST，那我们就需要编辑Request Body，Postman根据body type的不同，提供了4中编辑方式：</p><ul><li>form-data</li><li>x-www-form-urlencoded</li><li>raw</li><li>binary</li></ul><p><img src="https://i.imgur.com/dgaY012.png"></p><p>（我们这里是可以传文件的哦）</p><h1 id="postman高级用法"><a href="#postman高级用法" class="headerlink" title="postman高级用法"></a>postman高级用法</h1><h2 id="colletions-接口集合"><a href="#colletions-接口集合" class="headerlink" title="colletions(接口集合)"></a>colletions(接口集合)</h2><p>在开发过程中，可能会遇到多项目同时开发维护的情况，Postman友好的提供了colletions功能，类似与项目文件夹一样，可以把归属于同一类的接口分类到一起，便于管理维护。</p><ol><li>点击NEW -&gt; 选择collection，创建一个项目空间。</li></ol><p><img src="https://i.imgur.com/RcYq3Ba.png"></p><ol start="2"><li>输入项目名称，点击create。</li></ol><p><img src="https://i.imgur.com/zGFYC1F.png"></p><h2 id="colletions-folder-集合中的文件夹"><a href="#colletions-folder-集合中的文件夹" class="headerlink" title="colletions folder(集合中的文件夹)"></a>colletions folder(集合中的文件夹)</h2><p>每个项目会有多个接口，有些是一类功能，例如，用户管理接口，文章列表接口，Postman提供folder目录来进行细致的分类。</p><ol><li>选择一个项目，点击Add Folder</li></ol><p><img src="https://i.imgur.com/v2qY1uW.png"></p><ol start="2"><li>输入目录名称，点击create</li></ol><p><img src="https://i.imgur.com/exymkyT.png"></p><p>每个接口都可以归类到某个项目，或某个项目的子目录中。</p><p><img src="https://i.imgur.com/pRltLVX.png"></p><h2 id="Environment-环境变量"><a href="#Environment-环境变量" class="headerlink" title="Environment(环境变量)"></a>Environment(环境变量)</h2><p>Postman允许定义自己的环境变量（Environment），最常见的是将测试 URL 进行定义成变量的形式，这样随着你的域名怎么变，URL 就不用变更，非常方便。除此之外，也可以将一些敏感的测试值定义为环境变量，比如密码。接下来，来看下怎么新建一组环境变量，如下操作打开环境变量的管理入口：</p><p><img src="https://i.imgur.com/G8b6kTl.png"></p><p>打开管理环境变量的窗口，输入名称，添加一组键值对，如下图所示：</p><p><img src="https://i.imgur.com/5oJhjWe.png"></p><p>环境变量要以双大括号的方式来引用，可以在右上方下拉框处选择相应的环境变量，我们实测一下刚才添加的Url的变量：</p><p><img src="https://i.imgur.com/FAc6qME.png"></p><h2 id="通过脚本设置变量"><a href="#通过脚本设置变量" class="headerlink" title="通过脚本设置变量"></a>通过脚本设置变量</h2><p>Postman允许用户自定义脚本，并提供了两种类型的脚本：</p><ul><li>Pre-request Script：执行request请求前先运行，可以在里面预先设置些所需变量</li><li>Tests：request返回后执行的,可以对返回信息进行提取过滤，或者执行一些验证操作</li></ul><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>获取如下返回信息中的user_id值:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设服务端返回的Body内容如下:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2079876912&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;26A90E317DBC1AD363B2E2CE53F76F2DD85CB172DF7D813099477BAACB69DC49C794BAECEDC68331&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;expires_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-06-22T12:46:51.637+0800&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;26A90E317DBC1AD3CD1556CF2B3923DD60AEBADDCBC1D9D899262A55D15273F735E407A6BEC56B84&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mac_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4FAhd4OpfC&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mac_algorithm&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hmac-sha-256&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-06-15T12:46:51.649+0800&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在Tests中对user_id值进行提取并赋值成全局变量:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 判断是否存在<span class="string">&#x27;user_id&#x27;</span>值</span><br><span class="line">tests[<span class="string">&quot;Body contains user_id&quot;</span>] = responseBody.has(<span class="string">&quot;user_id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(tests[<span class="string">&quot;Body contains user_id&quot;</span>])&#123;</span><br><span class="line">    // 将返回信息解析成对象</span><br><span class="line">    var responseData = JSON.parse(responseBody);</span><br><span class="line">    tests[<span class="string">&quot;value_user_id&quot;</span>]=responseData.token.user_id</span><br><span class="line">    // 设置全局变量</span><br><span class="line">    postman.setGlobalVariable(<span class="string">&quot;user_id&quot;</span>,tests[<span class="string">&quot;value_user_id&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    postman.setGlobalVariable(<span class="string">&quot;user_id&quot;</span>,<span class="string">&quot;默认user_id&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="实践案例"><a href="#实践案例" class="headerlink" title="实践案例"></a>实践案例</h1><h2 id="项目接口分类管理"><a href="#项目接口分类管理" class="headerlink" title="项目接口分类管理"></a>项目接口分类管理</h2><p><img src="https://i.imgur.com/LXxBYdq.png"></p><h2 id="登录获取token并设置为全局变量"><a href="#登录获取token并设置为全局变量" class="headerlink" title="登录获取token并设置为全局变量"></a>登录获取token并设置为全局变量</h2><p><img src="https://i.imgur.com/gIXLd5c.png"></p><h2 id="接口使用登录后的token"><a href="#接口使用登录后的token" class="headerlink" title="接口使用登录后的token"></a>接口使用登录后的token</h2><p><img src="https://i.imgur.com/1RCOliR.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Postman是什么&quot;&gt;&lt;a href=&quot;#Postman是什么&quot; class=&quot;headerlink&quot; title=&quot;Postman是什么&quot;&gt;&lt;/a&gt;Postman是什么&lt;/h1&gt;&lt;p&gt;Postman是chrome的一款插件,用于做接口请求测试,无论是前端,后台还是测试人员,都可以用postman来测试接口,用起来非常方便。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="工具技巧" scheme="https://blog.gcdd.top/tags/%E5%B7%A5%E5%85%B7%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>Java8新特性一览表</title>
    <link href="https://blog.gcdd.top/p/55630/"/>
    <id>https://blog.gcdd.top/p/55630/</id>
    <published>2019-01-09T12:16:58.000Z</published>
    <updated>2023-08-30T04:52:53.899Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul><li>forEach() method in Iterable interface(Iterable接口中的forEach()方法)</li><li>default and static methods in Interfaces(接口中的默认和静态方法)</li><li>Functional Interfaces and Lambda Expressions(function接口和Lambda表达式)</li><li>Java Stream API for Bulk Data Operations on Collections(用于集合上的批量数据操作的Java Stream API)</li><li>Java Time API</li><li>Collection API improvements</li><li>Concurrency API improvements</li><li>Java IO improvements</li></ul><span id="more"></span><h1 id="1-forEach-method-in-Iterable-interface-Iterable接口中的forEach-方法"><a href="#1-forEach-method-in-Iterable-interface-Iterable接口中的forEach-方法" class="headerlink" title="1.forEach() method in Iterable interface(Iterable接口中的forEach()方法)"></a>1.forEach() method in Iterable interface(Iterable接口中的forEach()方法)</h1><p>每当我们需要遍历Collection时，我们需要创建一个Iterator，其目的是迭代，然后我们在循环中为Collection中的每个元素提供业务逻辑。如果没有正确使用迭代器，会抛出异常ConcurrentModificationException。</p><p>Java 8在java.lang.Iterable接口中引入了forEach方法，这样在编写代码时我们只关注业务逻辑。 forEach方法将java.util.function.Consumer对象作为参数，因此它有助于将我们的业务逻辑放在我们可以重用的单独位置。让我们通过简单的例子看看每个用法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">List&lt;IntegermyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) myList.add(i);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用iterator</span></span><br><span class="line">Iterator&lt;Integeriterator = myList.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">next</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">    System.out.println(<span class="string">&quot;Iterator Value::&quot;</span> + next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//foreach + 匿名类</span></span><br><span class="line">myList.forEach(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Integer&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Integer t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;forEach anonymous class Value::&quot;</span>+t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用consumer 接口</span></span><br><span class="line"><span class="type">MyConsumer</span> <span class="variable">action</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyConsumer</span>();</span><br><span class="line">myList.forEach(action);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用lambda表达式</span></span><br><span class="line">myList.forEach(System.out::println);</span><br></pre></td></tr></table></figure><h1 id="2-default-and-static-methods-in-Interfaces-接口中的默认和静态方法"><a href="#2-default-and-static-methods-in-Interfaces-接口中的默认和静态方法" class="headerlink" title="2.default and static methods in Interfaces(接口中的默认和静态方法)"></a>2.default and static methods in Interfaces(接口中的默认和静态方法)</h1><p>jdk8之前，interface方法不能有实现，但是从Java 8开始，接口被增强为具有实现方法。我们可以使用default和static关键字来创建具有方法实现的接口。例如Iterable接口中的forEach方法实现是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">forEach</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> Taction)</span> &#123;</span><br><span class="line">    Objects.requireNonNull(action);</span><br><span class="line">    <span class="keyword">for</span> (T t : <span class="built_in">this</span>) &#123;</span><br><span class="line">        action.accept(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p>创建一个接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">showA</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是接口默认方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showB</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是接口静态方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建该接口实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> <span class="keyword">implements</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是实现方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认方法支持重写,不覆盖则执行接口的默认方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showA</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我覆盖了接口的默认方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//静态方法不可以重写</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyClass</span> <span class="variable">myClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">        myClass.show();</span><br><span class="line">        myClass.showA();</span><br><span class="line">        <span class="comment">//通过类名.方法名调用接口静态方法</span></span><br><span class="line">        MyInterface.showB();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-Functional-Interfaces-and-Lambda-Expressions（function接口和Lambda表达式）"><a href="#3-Functional-Interfaces-and-Lambda-Expressions（function接口和Lambda表达式）" class="headerlink" title="3.Functional Interfaces and Lambda Expressions（function接口和Lambda表达式）"></a>3.Functional Interfaces and Lambda Expressions（function接口和Lambda表达式）</h1><p>如果你注意到上面的接口代码，你会注意到@FunctionalInterface注释。功能接口是Java 8中引入的新概念。<strong>只有一个抽象方法的接口就变成了功能接口</strong>。我们不需要使用@FunctionalInterface注释将接口标记为功能接口。 @FunctionalInterface注释是一种避免在功能界面中意外添加抽象方法的工具。您可以将其视为@Override注释，并且最佳实践是使用它。实例：java8 的runnable run接口，带有一个抽象方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>功能接口的主要好处之一是可以使用lambda表达式来实例化它们。我们可以使用匿名类实例化一个接口，但代码看起来很笨重。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用匿名类实例化</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;My Runnable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由于功能接口只有一个方法，因此lambda表达式可以很容易地提供方法实现。我们只需要提供方法参数和业务逻辑。例如，我们可以使用lambda表达式将上面的实现编写为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用lambda表达式</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">runnable1</span> <span class="operator">=</span> () -System.out.println(<span class="string">&quot;My Runnable&quot;</span>);</span><br><span class="line">runnable.run();</span><br><span class="line">runnable1.run();</span><br></pre></td></tr></table></figure><p>如果在方法实现中有单个语句，我们也不需要花括号。例如，上面的Interface1匿名类可以使用lambda实例化，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Interface1</span> <span class="variable">interface1</span> <span class="operator">=</span> (s) -System.out.println(s);</span><br><span class="line">interface1.method1(<span class="string">&quot;interface1 method&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="lambda表达式扩展"><a href="#lambda表达式扩展" class="headerlink" title="lambda表达式扩展"></a>lambda表达式扩展</h2><h3 id="Java-中的-Lambda-表达式通常使用-argument-body-语法书写，例如："><a href="#Java-中的-Lambda-表达式通常使用-argument-body-语法书写，例如：" class="headerlink" title="Java 中的 Lambda 表达式通常使用 (argument) -(body) 语法书写，例如："></a>Java 中的 Lambda 表达式通常使用 (argument) -(body) 语法书写，例如：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(arg1, arg2...) -&gt; &#123; body &#125;</span><br><span class="line">(type1 arg1, type2 arg2...) -&gt; &#123; body &#125;</span><br></pre></td></tr></table></figure><h3 id="Lambda-表达式的结构"><a href="#Lambda-表达式的结构" class="headerlink" title="Lambda 表达式的结构"></a>Lambda 表达式的结构</h3><ul><li>一个Lambda表达式可以有零个或多个参数</li><li>参数的类型既可以明确声明，也可以根据上下文来推断。例如：<code>(int a)</code>与<code>(a)</code>效果相同</li><li>所有参数需包含在圆括号内，参数之间用逗号相隔。例如：<code>(a, b)</code> 或 <code>(int a, int b)</code> 或 <code>(String a, int b, float c)</code></li><li>空圆括号代表参数集为空。例如：<code>() -&gt; 42</code></li><li>当只有一个参数，且其类型可推导时，圆括号（）可省略。例如：<code>a -&gt; return a * a</code></li><li>Lambda表达式的主体可包含零条或多条语句</li><li>如果Lambda表达式的主体只有一条语句，花括号{}可省略。匿名函数的返回类型与该主体表达式一致</li><li>如果Lambda表达式的主体包含一条以上语句，则表达式必须包含在花括号{}中（形成代码块）。匿名函数的返回类型与代码块的返回类型一致，若没有返回则为空</li></ul><h2 id="函数式接口扩展"><a href="#函数式接口扩展" class="headerlink" title="函数式接口扩展"></a>函数式接口扩展</h2><p>函数式接口是只包含一个抽象方法声明的接口,可以使用<code>@FunctionalInterface</code>标记</p><h3 id="JDK8之前已有的函数式接口"><a href="#JDK8之前已有的函数式接口" class="headerlink" title="JDK8之前已有的函数式接口"></a>JDK8之前已有的函数式接口</h3><ul><li>java.lang.Runnable</li><li>java.util.concurrent.Callable</li><li>java.security.PrivilegedAction</li><li>java.util.Comparator</li><li>java.io.FileFilter</li><li>java.nio.file.PathMatcher</li><li>java.lang.reflect.InvocationHandler</li><li>java.beans.PropertyChangeListener</li><li>java.awt.event.ActionListener</li><li>javax.swing.event.ChangeListener</li></ul><h3 id="新定义的函数式接口"><a href="#新定义的函数式接口" class="headerlink" title="新定义的函数式接口"></a>新定义的函数式接口</h3><p>java.util.function中定义了几组类型的函数式接口以及针对基本数据类型的子接口。</p><ul><li>Predicate:传入一个参数，返回一个bool结果，方法为boolean test(T t)</li><li>Consumer:传入一个参数，无返回值，纯消费。方法为void accept(T t)</li><li>Function:传入一个参数，返回一个结果，方法为R apply(T t)</li><li>Supplier:无参数传入，返回一个结果，方法为T get()</li><li>UnaryOperator:一元操作符，继承Function,传入参数的类型和返回类型相同。</li><li>BinaryOperator:二元操作符，传入的两个参数的类型和返回类型相同，继承BiFunction。</li></ul><p>【示例】</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;Integer&gt; predicate = (i) -&gt; i &gt; <span class="number">0</span>;</span><br><span class="line">Consumer&lt;Integer&gt; consumer = (i) -&gt; System.out.println(<span class="string">&quot;consumer : &quot;</span> + i);</span><br><span class="line">Function&lt;Integer,Boolean&gt; function = (i) -&gt; i &gt; <span class="number">0</span>;</span><br><span class="line">Supplier&lt;Integer&gt; supplier = () -&gt; <span class="number">1</span>;</span><br><span class="line">UnaryOperator&lt;Integer&gt; unaryOperator = (i) -&gt; i * i;</span><br><span class="line">BinaryOperator&lt;Integer&gt; binaryOperator = (i1,i2) -&gt; i1 * i2;</span><br><span class="line"></span><br><span class="line">System.out.println(predicate.test(<span class="number">10</span>));</span><br><span class="line">consumer.accept(<span class="number">10</span>);</span><br><span class="line">System.out.println(function.apply(<span class="number">10</span>));</span><br><span class="line">System.out.println(supplier.get());</span><br><span class="line">System.out.println(unaryOperator.apply(<span class="number">100</span>));</span><br><span class="line">System.out.println(binaryOperator.apply(<span class="number">100</span>,<span class="number">200</span>));</span><br></pre></td></tr></table></figure><h1 id="4-Java-Stream-API-for-Bulk-Data-Operations-on-Collections-用于集合上的批量数据操作的Java-Stream-API"><a href="#4-Java-Stream-API-for-Bulk-Data-Operations-on-Collections-用于集合上的批量数据操作的Java-Stream-API" class="headerlink" title="4.Java Stream API for Bulk Data Operations on Collections(用于集合上的批量数据操作的Java Stream API)"></a>4.Java Stream API for Bulk Data Operations on Collections(用于集合上的批量数据操作的Java Stream API)</h1><h2 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从 Collection 和数组</span></span><br><span class="line">List&lt;Integerlist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123;</span><br><span class="line">    list.add(i);</span><br><span class="line">&#125;</span><br><span class="line">Stream&lt;Integerstream = list.stream(); <span class="comment">//串行流</span></span><br><span class="line">Stream&lt;Integerstream1 = list.parallelStream(); <span class="comment">//并行流</span></span><br><span class="line">Stream&lt;Integerstream2 = Arrays.stream(list.toArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">0</span>]));</span><br><span class="line">Stream&lt;Integerstream3 = Stream.of(list.toArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line"><span class="comment">//从 BufferedReader</span></span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;path&quot;</span>)));</span><br><span class="line">Stream&lt;Stringstream4 = bufferedReader.lines();</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态工厂</span></span><br><span class="line"><span class="type">IntStream</span> <span class="variable">stream5</span> <span class="operator">=</span> IntStream.rangeClosed(<span class="number">1</span>, <span class="number">100</span>);<span class="comment">//生成1-100 的int stream</span></span><br><span class="line">Stream&lt;Pathstream6 = Files.walk(Paths.get(<span class="string">&quot;path&quot;</span>), <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自己构建 通过StreamSupport辅助类从spliterator产生流</span></span><br><span class="line">Stream&lt;Integerstream7 = StreamSupport.stream(list.spliterator(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//其它</span></span><br><span class="line"><span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="type">IntStream</span> <span class="variable">stream8</span> <span class="operator">=</span> random.ints();</span><br><span class="line"></span><br><span class="line"><span class="type">BitSet</span> <span class="variable">bitSet</span> <span class="operator">=</span> BitSet.valueOf(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>&#125;);</span><br><span class="line"><span class="type">IntStream</span> <span class="variable">stream9</span> <span class="operator">=</span> bitSet.stream();</span><br><span class="line"></span><br><span class="line"><span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\d+&quot;</span>);</span><br><span class="line">Stream&lt;Stringstream10 = pattern.splitAsStream(<span class="string">&quot;111sda123sda&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">JarFile</span> <span class="variable">jarFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JarFile</span>(<span class="string">&quot;xxx.jar&quot;</span>);</span><br><span class="line">Stream&lt;JarEntrystream11 = jarFile.stream();</span><br></pre></td></tr></table></figure><h1 id="5-Java-Time-API-Java时间API"><a href="#5-Java-Time-API-Java时间API" class="headerlink" title="5.Java Time API(Java时间API)"></a>5.Java Time API(Java时间API)</h1><p>Java 8通过发布新的Date-Time API (JSR 310)来进一步加强对日期与时间的处理。对日期与时间的操作一直是Java程序员最痛苦的地方之一。标准的 java.util.Date以及后来的java.util.Calendar一点没有改善这种情况（可以这么说，它们一定程度上更加复杂）。</p><h2 id="Clock类"><a href="#Clock类" class="headerlink" title="Clock类"></a>Clock类</h2><p>它通过指定一个时区，然后就可以获取到当前的时刻，日期与时间。Clock可以替换System.currentTimeMillis()与TimeZone.getDefault()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the system clock as UTC offset </span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Clock</span> <span class="variable">clock</span> <span class="operator">=</span> Clock.systemUTC();</span><br><span class="line">System.out.println(clock.instant());</span><br><span class="line">System.out.println(clock.millis());</span><br></pre></td></tr></table></figure><p>下面是程序在控制台上的输出:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T14:<span class="number">52</span>:<span class="number">50.</span>111Z</span><br><span class="line"><span class="number">1547045570335</span></span><br></pre></td></tr></table></figure><h2 id="LocaleDate与LocalTime"><a href="#LocaleDate与LocalTime" class="headerlink" title="LocaleDate与LocalTime"></a>LocaleDate与LocalTime</h2><p>LocaleDate只持有ISO-8601格式且无时区信息的日期部分。相应的，LocaleTime只持有ISO-8601格式且无时区信息的时间部分。LocaleDate与LocalTime都可以从Clock中得到。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the local date and local time</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDate</span> <span class="variable">dateFromClock</span> <span class="operator">=</span> LocalDate.now(clock);</span><br><span class="line"></span><br><span class="line">System.out.println(date);</span><br><span class="line">System.out.println(dateFromClock);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the local date and local time</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalTime</span> <span class="variable">timeFromClock</span> <span class="operator">=</span> LocalTime.now(clock);</span><br><span class="line"></span><br><span class="line">System.out.println(time);</span><br><span class="line">System.out.println(timeFromClock);</span><br></pre></td></tr></table></figure><p>下面是程序在控制台上的输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09</span><br><span class="line"><span class="number">22</span>:<span class="number">52</span>:<span class="number">50.383</span></span><br><span class="line"><span class="number">14</span>:<span class="number">52</span>:<span class="number">50.383</span></span><br></pre></td></tr></table></figure><h2 id="LocaleDateTime"><a href="#LocaleDateTime" class="headerlink" title="LocaleDateTime"></a>LocaleDateTime</h2><p>LocaleDateTime把LocaleDate与LocaleTime的功能合并起来，它持有的是ISO-8601格式无时区信息的日期与时间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the local date/time</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDateTime</span> <span class="variable">datetime</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDateTime</span> <span class="variable">datetimeFromClock</span> <span class="operator">=</span> LocalDateTime.now(clock);</span><br><span class="line"></span><br><span class="line">System.out.println(datetime);</span><br><span class="line">System.out.println(datetimeFromClock);</span><br></pre></td></tr></table></figure><p>下面是程序在控制台上的输出:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T22:<span class="number">55</span>:<span class="number">05.194</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T14:<span class="number">55</span>:<span class="number">05.194</span></span><br></pre></td></tr></table></figure><h2 id="ZonedDateTime"><a href="#ZonedDateTime" class="headerlink" title="ZonedDateTime"></a>ZonedDateTime</h2><p>如果你需要特定时区的日期/时间，那么ZonedDateTime是你的选择。它持有ISO-8601格式具具有时区信息的日期与时间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the zoned date/time</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">ZonedDateTime</span> <span class="variable">zonedDatetime</span> <span class="operator">=</span> ZonedDateTime.now();</span><br><span class="line"><span class="keyword">final</span> <span class="type">ZonedDateTime</span> <span class="variable">zonedDatetimeFromClock</span> <span class="operator">=</span> ZonedDateTime.now(clock);</span><br><span class="line"><span class="keyword">final</span> <span class="type">ZonedDateTime</span> <span class="variable">zonedDatetimeFromZone</span> <span class="operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="string">&quot;America/Los_Angeles&quot;</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(zonedDatetime);</span><br><span class="line">System.out.println(zonedDatetimeFromClock);</span><br><span class="line">System.out.println(zonedDatetimeFromZone);</span><br></pre></td></tr></table></figure><p>下面是程序在控制台上的输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T22:<span class="number">56</span>:<span class="number">34.033</span>+08:<span class="number">00</span>[Asia/Shanghai]</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T14:<span class="number">56</span>:<span class="number">34.</span>033Z</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-09T06:<span class="number">56</span>:<span class="number">34.035</span>-08:<span class="number">00</span>[America/Los_Angeles]</span><br></pre></td></tr></table></figure><h2 id="Duration"><a href="#Duration" class="headerlink" title="Duration"></a>Duration</h2><p>在秒与纳秒级别上的一段时间。Duration使计算两个日期间的不同变的十分简单。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get duration between two dates</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDateTime</span> <span class="variable">from</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2018</span>, Month.APRIL, <span class="number">16</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">LocalDateTime</span> <span class="variable">to</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2019</span>, Month.APRIL, <span class="number">16</span>, <span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(from, to);</span><br><span class="line">System.out.println(<span class="string">&quot;Duration in days: &quot;</span> + duration.toDays());</span><br><span class="line">System.out.println(<span class="string">&quot;Duration in hours: &quot;</span> + duration.toHours());</span><br></pre></td></tr></table></figure><p>上面的例子计算了两个日期2018年4月16号与2019年4月16号之间的过程。下面是程序在控制台上的输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Duration in days: <span class="number">365</span></span><br><span class="line">Duration in hours: <span class="number">8783</span></span><br></pre></td></tr></table></figure><h1 id="Collection-API-improvements-集合API改进"><a href="#Collection-API-improvements-集合API改进" class="headerlink" title="Collection API improvements(集合API改进)"></a>Collection API improvements(集合API改进)</h1><p>上面已经展示了forEach()方法和Stream API在集合上的使用。java8的Collection API中添加了一些新方法：</p><h2 id="Iterator-default-method-forEachRemaining-Consumer-action"><a href="#Iterator-default-method-forEachRemaining-Consumer-action" class="headerlink" title="Iterator default method forEachRemaining(Consumer action)"></a>Iterator default method forEachRemaining(Consumer action)</h2><p>为每个元素执行给定操作，直到所有元素都已处理或操作引发异常。</p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; action)</span> &#123;</span><br><span class="line"><span class="comment">//传入一个非空消费者</span></span><br><span class="line">    Objects.requireNonNull(action);</span><br><span class="line"><span class="comment">//遍历执行消费者函数</span></span><br><span class="line">    <span class="keyword">while</span> (hasNext())</span><br><span class="line">        action.accept(next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>);</span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line"><span class="comment">//创建一个消费者</span></span><br><span class="line">Consumer&lt;Integer&gt; consumer = i -&gt; System.out.println(<span class="string">&quot;consumer print &quot;</span> + i);</span><br><span class="line"><span class="comment">//iterator的forEachRemaining将集合中的每个元素消费</span></span><br><span class="line">iterator.forEachRemaining(consumer);</span><br></pre></td></tr></table></figure><h3 id="控制台输出"><a href="#控制台输出" class="headerlink" title="控制台输出"></a>控制台输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">consumer print <span class="number">1</span></span><br><span class="line">consumer print <span class="number">2</span></span><br><span class="line">consumer print <span class="number">3</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Collection-default-method-removeIf-Predicate-filter"><a href="#Collection-default-method-removeIf-Predicate-filter" class="headerlink" title="Collection default method removeIf(Predicate filter)"></a>Collection default method removeIf(Predicate filter)</h2><p>删除满足给定条件的此集合的所有元素。</p><h3 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">removeIf</span><span class="params">(Predicate&lt;? <span class="built_in">super</span> E&gt; filter)</span> &#123;</span><br><span class="line"><span class="comment">//传入一个非空谓语</span></span><br><span class="line">    Objects.requireNonNull(filter);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">final</span> Iterator&lt;E&gt; each = iterator();</span><br><span class="line">    <span class="keyword">while</span> (each.hasNext()) &#123;</span><br><span class="line"><span class="comment">//遍历元素，执行谓语的校验，如果为真，则删除该元素</span></span><br><span class="line">        <span class="keyword">if</span> (filter.test(each.next())) &#123;</span><br><span class="line">            each.remove();</span><br><span class="line">            removed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line">list.add(<span class="number">4</span>);</span><br><span class="line">Predicate&lt;Integer&gt; predicate = i -&gt; i &gt; <span class="number">1</span>;</span><br><span class="line">list.removeIf(predicate);</span><br><span class="line">System.out.println(<span class="string">&quot;remove if left items : &quot;</span> + list);</span><br></pre></td></tr></table></figure><h3 id="控制台输出-1"><a href="#控制台输出-1" class="headerlink" title="控制台输出"></a>控制台输出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2,3,4满足条件被删除了</span></span><br><span class="line">remove <span class="keyword">if</span> left items : [<span class="number">1</span>]</span><br></pre></td></tr></table></figure><h2 id="Collection-spliterator"><a href="#Collection-spliterator" class="headerlink" title="Collection spliterator()"></a>Collection spliterator()</h2><p>返回Spliterator实例的方法，该实例可用于顺序或并行遍历元素。</p><h3 id="源码-2"><a href="#源码-2" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该方法是接口默认方法</span></span><br><span class="line"><span class="keyword">default</span> Spliterator&lt;E&gt; <span class="title function_">spliterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Spliterators.spliterator(<span class="built_in">this</span>, Spliterator.ORDERED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>);</span><br><span class="line">Spliterator&lt;Integer&gt; spliterator = list.spliterator();</span><br><span class="line"><span class="comment">//创建顺序流</span></span><br><span class="line">Stream&lt;Integer&gt; stream = StreamSupport.stream(spliterator, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//创建并行流</span></span><br><span class="line">Stream&lt;Integer&gt; parallelStream = StreamSupport.stream(spliterator, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="Map-replaceAll-compute-merge-methods"><a href="#Map-replaceAll-compute-merge-methods" class="headerlink" title="Map replaceAll(), compute(), merge() methods"></a>Map replaceAll(), compute(), merge() methods</h2><h3 id="replaceAll"><a href="#replaceAll" class="headerlink" title="replaceAll()"></a>replaceAll()</h3><p>替换Map中所有Entry的value值，这个值由旧的key和value计算得出，接收参数 (K, V) -&gt; V</p><h4 id="源码-3"><a href="#源码-3" class="headerlink" title="源码"></a>源码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">replaceAll</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> K, ? <span class="built_in">super</span> V, ? extends V&gt; function)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (function == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mc</span> <span class="operator">=</span> modCount;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line"><span class="comment">//使用给定的函数替换原来的value值，key不变</span></span><br><span class="line">                e.value = function.apply(e.key, e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (modCount != mc)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;4&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;5&quot;</span>, <span class="string">&quot;E&quot;</span>);</span><br><span class="line"><span class="comment">//replaceAll方法</span></span><br><span class="line">map.replaceAll((s, s2) -&gt; s + s2);</span><br><span class="line">System.out.println(map);</span><br></pre></td></tr></table></figure><h4 id="控制台输出-2"><a href="#控制台输出-2" class="headerlink" title="控制台输出"></a>控制台输出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原来的value由key + value替换掉了</span></span><br><span class="line">&#123;<span class="number">1</span>=1A, <span class="number">2</span>=2B, <span class="number">3</span>=3C, <span class="number">4</span>=<span class="number">4D</span>, <span class="number">5</span>=5E&#125;</span><br></pre></td></tr></table></figure><h3 id="compute"><a href="#compute" class="headerlink" title="compute()"></a>compute()</h3><p>是<code>computeIfPresent</code>和<code>computeIfAbsent</code>方法的组合体</p><ul><li>computeIfPresent:如果指定的key不存在，则通过指定的K -&gt; V计算出新的值设置为key的值。</li><li>computeIfPresent:如果指定的key存在，则根据旧的key和value计算新的值newValue, 如果newValue不为null，则设置key新的值为newValue, 如果newValue为null, 则删除该key的值。</li></ul><h4 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a>示例代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;4&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;5&quot;</span>, <span class="string">&quot;E&quot;</span>);</span><br><span class="line"><span class="comment">//key存在，根据旧的key和value计算新的值newValue</span></span><br><span class="line">map.compute(<span class="string">&quot;1&quot;</span>, (k, v) -&gt; v + <span class="string">&quot; computed&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;key存在&quot;</span> + map.get(<span class="string">&quot;1&quot;</span>));</span><br><span class="line"><span class="comment">//key不存在，通过指定的K -&gt; V计算出新的值设置为key的值</span></span><br><span class="line">map.compute(<span class="string">&quot;6&quot;</span>, (k, v) -&gt; <span class="string">&quot;F&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;key不存在&quot;</span> + map.get(<span class="string">&quot;6&quot;</span>));</span><br><span class="line"><span class="comment">//key存在，如果newValue为null, 则删除该key的值</span></span><br><span class="line">map.compute(<span class="string">&quot;1&quot;</span>, (k, v) -&gt; <span class="literal">null</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;key存在，设置为null &quot;</span> + map.get(<span class="string">&quot;1&quot;</span>));</span><br></pre></td></tr></table></figure><h4 id="控制台输出-3"><a href="#控制台输出-3" class="headerlink" title="控制台输出"></a>控制台输出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key存在A computed</span><br><span class="line">key不存在F</span><br><span class="line">key存在，设置为<span class="literal">null</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="merge"><a href="#merge" class="headerlink" title="merge()"></a>merge()</h3><p>如果指定的key不存在，则设置指定的value值，否则根据key的旧的值oldvalue，value计算出新的值newValue, 如果newValue为null, 则删除该key，否则设置key的新值newValue。</p><h4 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a>示例代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;4&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;5&quot;</span>, <span class="string">&quot;E&quot;</span>);</span><br><span class="line"><span class="comment">//存在key为1,输出 Amerge</span></span><br><span class="line">System.out.println(map.merge(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;merge&quot;</span>, (k, v) -&gt; k + v));</span><br><span class="line"><span class="comment">//新值为null，删除key，输出 null</span></span><br><span class="line">System.out.println(map.merge(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;merge&quot;</span>, (k, v) -&gt; <span class="literal">null</span>));</span><br><span class="line"><span class="comment">//不存在key为6，输出 &quot;merge&quot;</span></span><br><span class="line">System.out.println(map.merge(<span class="string">&quot;6&quot;</span>, <span class="string">&quot;merge&quot;</span>, (k, v) -&gt; k + v));</span><br></pre></td></tr></table></figure><h4 id="控制台输出-4"><a href="#控制台输出-4" class="headerlink" title="控制台输出"></a>控制台输出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Amerge</span><br><span class="line"><span class="literal">null</span></span><br><span class="line">merge</span><br></pre></td></tr></table></figure><h2 id="Performance-Improvement-for-HashMap-class-with-Key-Collisions"><a href="#Performance-Improvement-for-HashMap-class-with-Key-Collisions" class="headerlink" title="Performance Improvement for HashMap class with Key Collisions"></a>Performance Improvement for HashMap class with Key Collisions</h2><p>具有键冲突的HashMap类的性能改进</p><h1 id="Concurrency-API-improvements-并发API改进"><a href="#Concurrency-API-improvements-并发API改进" class="headerlink" title="Concurrency API improvements(并发API改进)"></a>Concurrency API improvements(并发API改进)</h1><h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p>JDK8提供的并发友好的HashMap</p><h2 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h2><p>提供了非常强大的 Future 的扩展功能，可以帮助我们简化异步编程的复杂性，并且提供了函数式编程的能力，可以通过回调的方式处理计算结果，也提供了转换和组合 CompletableFuture 的方法。</p><h2 id="Executors-newWorkStealingPool"><a href="#Executors-newWorkStealingPool" class="headerlink" title="Executors newWorkStealingPool()"></a>Executors newWorkStealingPool()</h2><p>创建持有足够线程的线程池来支持给定的并行级别，并通过使用多个队列，减少竞争，它需要传一个并行级别的参数，如果不传，则被设定为默认的CPU数量。</p><h1 id="Java-IO-improvements-Java-IO-API的改进"><a href="#Java-IO-improvements-Java-IO-API的改进" class="headerlink" title="Java IO improvements(Java IO API的改进)"></a>Java IO improvements(Java IO API的改进)</h1><h2 id="Files-list-Path-dir"><a href="#Files-list-Path-dir" class="headerlink" title="Files.list(Path dir)"></a>Files.list(Path dir)</h2><p>返回一个延迟填充的Stream，其中的元素是目录中的条目。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回目录下的元素集合流</span></span><br><span class="line">Stream&lt;Path&gt; list = Files.list(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\Administrator\\Desktop&quot;</span>).toPath());</span><br><span class="line">list.forEach(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="Files-lines-Path-path"><a href="#Files-lines-Path-path" class="headerlink" title="Files.lines(Path path)"></a>Files.lines(Path path)</h2><p>从文件中读取所有行作为流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回文件中的所有行数</span></span><br><span class="line">Stream&lt;String&gt; lines = Files.lines(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\Administrator\\Desktop\\new 3.txt&quot;</span>).toPath());</span><br><span class="line">lines.forEach(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="Files-find"><a href="#Files-find" class="headerlink" title="Files.find()"></a>Files.find()</h2><p>通过搜索以给定起始文件为根的文件树中的文件，返回使用Path延迟填充的Stream。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回符合判断条件的Path流</span></span><br><span class="line">Stream&lt;Path&gt; stream = Files.find(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\Administrator\\Desktop&quot;</span>).toPath(),</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        (path, basicFileAttributes) -&gt; basicFileAttributes.isDirectory());</span><br><span class="line">stream.forEach(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="BufferedReader-lines"><a href="#BufferedReader-lines" class="headerlink" title="BufferedReader.lines()"></a>BufferedReader.lines()</h2><p>返回一个Stream，其元素是从这个BufferedReader读取的行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回文件中的所有行数,类似Files.lines()</span></span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;C:\\Users\\Administrator\\Desktop\\new 3.txt&quot;</span>));</span><br><span class="line">Stream&lt;String&gt; stringStream = br.lines();</span><br><span class="line">stringStream.forEach(System.out::println);</span><br></pre></td></tr></table></figure><h1 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h1><ul><li><a href="https://www.journaldev.com/2389/java-8-features-with-examples#java8-collection">Java 8 Features with Examples</a></li><li><a href="https://www.cnblogs.com/yangming1996/p/8031199.html">为并发而生的 ConcurrentHashMap（Java 8）</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-cf-of-jdk8/index.html">通过实例理解 JDK8 的 CompletableFuture</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;forEach() method in Iterable interface(Iterable接口中的forEach()方法)&lt;/li&gt;
&lt;li&gt;default and static methods in Interfaces(接口中的默认和静态方法)&lt;/li&gt;
&lt;li&gt;Functional Interfaces and Lambda Expressions(function接口和Lambda表达式)&lt;/li&gt;
&lt;li&gt;Java Stream API for Bulk Data Operations on Collections(用于集合上的批量数据操作的Java Stream API)&lt;/li&gt;
&lt;li&gt;Java Time API&lt;/li&gt;
&lt;li&gt;Collection API improvements&lt;/li&gt;
&lt;li&gt;Concurrency API improvements&lt;/li&gt;
&lt;li&gt;Java IO improvements&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>PG数据库常用操作</title>
    <link href="https://blog.gcdd.top/p/59866/"/>
    <id>https://blog.gcdd.top/p/59866/</id>
    <published>2019-01-09T11:36:07.000Z</published>
    <updated>2023-08-30T04:52:53.901Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下，在开发过程中接触到的一些PG数据库常用操作，以备不时之需。<span id="more"></span></p><h1 id="全量迁移"><a href="#全量迁移" class="headerlink" title="全量迁移"></a>全量迁移</h1><ul><li>备份数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pg_dump -h 172.19.235.145 -U &lt;username&gt; -d &lt;database&gt; &gt; 20180704_dbpe.sql</span><br></pre></td></tr></table></figure><ul><li>正式迁移</li></ul><p>首先要修改备份文件*.sql的owner，防止权限出现错误。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ psql -h &lt;ip&gt; -U &lt;username&gt; -d &lt;database&gt; -f 20180704_dbpe.sql</span><br></pre></td></tr></table></figure><p>【注意点】该迁移操作会覆盖原来的数据库，所以最好创建一个新库。</p><h1 id="列出所有表名和数据库名"><a href="#列出所有表名和数据库名" class="headerlink" title="列出所有表名和数据库名"></a>列出所有表名和数据库名</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tablename <span class="keyword">from</span> pg_tables <span class="keyword">where</span> schemaname <span class="operator">=</span><span class="string">&#x27;public&#x27;</span>;</span><br></pre></td></tr></table></figure><h1 id="PostgreSQL-中-有时候想删除数据库（drop-database-swiftliveqaapi-），发现提示“ERROR-database-“xxxxxx”-is-being-accessed-by-other-users-DETAIL-There-are-30-other-sessions-using-the-database-”"><a href="#PostgreSQL-中-有时候想删除数据库（drop-database-swiftliveqaapi-），发现提示“ERROR-database-“xxxxxx”-is-being-accessed-by-other-users-DETAIL-There-are-30-other-sessions-using-the-database-”" class="headerlink" title="PostgreSQL 中 有时候想删除数据库（drop database swiftliveqaapi;），发现提示“ERROR:  database “xxxxxx” is being accessed by other users DETAIL:  There are 30 other sessions using the database.”"></a>PostgreSQL 中 有时候想删除数据库（drop database swiftliveqaapi;），发现提示“ERROR:  database “xxxxxx” is being accessed by other users DETAIL:  There are 30 other sessions using the database.”</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用psql 登录进入， 执行语句：</span><br><span class="line">SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname=<span class="string">&#x27;数据库名&#x27;</span> AND pid&lt;&gt;pg_backend_pid();</span><br><span class="line">然后就可以删除数据库了</span><br></pre></td></tr></table></figure><h1 id="修改表的序列为id最大值"><a href="#修改表的序列为id最大值" class="headerlink" title="修改表的序列为id最大值"></a>修改表的序列为id最大值</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT setval(<span class="string">&#x27;表名_id_seq&#x27;</span>, (SELECT MAX(<span class="built_in">id</span>) FROM 表名));</span><br></pre></td></tr></table></figure><h1 id="查询表结构"><a href="#查询表结构" class="headerlink" title="查询表结构"></a>查询表结构</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">COLUMN_NAME <span class="keyword">AS</span> 列名,</span><br><span class="line">DATA_TYPE <span class="keyword">AS</span> 字段类型,</span><br><span class="line">CHARACTER_MAXIMUM_LENGTH <span class="keyword">AS</span> 长度,</span><br><span class="line">IS_NULLABLE <span class="keyword">AS</span> 是否为空,</span><br><span class="line">COLUMN_DEFAULT <span class="keyword">AS</span> 默认值 </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">INFORMATION_SCHEMA.COLUMNS </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">table_schema <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span> </span><br><span class="line"><span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;表名&#x27;</span>;</span><br></pre></td></tr></table></figure><h1 id="PG-数据库状态，启动，停止"><a href="#PG-数据库状态，启动，停止" class="headerlink" title="PG 数据库状态，启动，停止"></a>PG 数据库状态，启动，停止</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pg_ctlcluster 9.5 main status</span><br><span class="line">$ pg_ctlcluster 9.5 main start</span><br><span class="line">$ pg_ctlcluster 9.5 main stop</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;记录一下，在开发过程中接触到的一些PG数据库常用操作，以备不时之需。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="数据库" scheme="https://blog.gcdd.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Spring-Security无法正常捕捉到UsernameNotFoundException异常</title>
    <link href="https://blog.gcdd.top/p/31514/"/>
    <id>https://blog.gcdd.top/p/31514/</id>
    <published>2019-01-08T13:25:54.000Z</published>
    <updated>2023-08-30T04:52:53.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在Web应用开发中,安全一直是非常重要的一个方面。在庞大的spring生态圈中，权限校验框架也是非常完善的。其中，spring security是非常好用的。今天记录一下在开发中遇到的一个spring-security相关的问题。<span id="more"></span></p><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>使用spring security进行授权登录的时候，发现登录接口无法正常捕捉UsernameNotFoundException异常，捕捉到的一直是BadCredentialsException异常。我们的预期是：</p><ul><li>UsernameNotFoundException -&gt; 用户名错误</li><li>BadCredentialsException -&gt; 密码错误</li></ul><p>贴几个比较重要的代码：</p><h2 id="1-登录业务逻辑"><a href="#1-登录业务逻辑" class="headerlink" title="1. 登录业务逻辑"></a>1. 登录业务逻辑</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationResponse <span class="title function_">login</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line"><span class="comment">//构造spring security需要的UsernamePasswordAuthenticationToken</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">upToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line"><span class="comment">//调用authenticationManager.authenticate(upToken)方法验证</span></span><br><span class="line"><span class="comment">//该方法将会执行UserDetailsService的loadUserByUsername验证用户名</span></span><br><span class="line"><span class="comment">//以及PasswordEncoder的matches方法验证密码</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(upToken);</span><br><span class="line">        <span class="type">JwtUser</span> <span class="variable">userDetails</span> <span class="operator">=</span> (JwtUser) authenticate.getPrincipal();</span><br><span class="line">        <span class="type">val</span> <span class="variable">token</span> <span class="operator">=</span> jwtTokenUtil.generateToken(userDetails);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationResponse</span>(token, userDetails.getId(), userDetails.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-spring-security-的UserDetailsService-实现类"><a href="#2-spring-security-的UserDetailsService-实现类" class="headerlink" title="2. spring security 的UserDetailsService 实现类"></a>2. spring security 的UserDetailsService 实现类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">AbstractUser</span> <span class="variable">abstractUser</span> <span class="operator">=</span> userRepository.findByUsername(username);</span><br><span class="line"><span class="comment">//如果通过用户名找不到用户，则抛出UsernameNotFoundException异常</span></span><br><span class="line">        <span class="keyword">if</span> (abstractUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(String.format(<span class="string">&quot;No abstractUser found with username &#x27;%s&#x27;.&quot;</span>, username));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JwtUserFactory.create(abstractUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-登录接口"><a href="#3-登录接口" class="headerlink" title="3. 登录接口"></a>3. 登录接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">JwtAuthenticationResponse</span> <span class="variable">jsonResponse</span> <span class="operator">=</span> authService.login(authenticationRequest.getUsername(), authenticationRequest.getPassword());</span><br><span class="line">    <span class="comment">//存入redis</span></span><br><span class="line">    redisService.setToken(jsonResponse.getToken());</span><br><span class="line">    <span class="keyword">return</span> ok(jsonResponse);</span><br><span class="line">&#125; <span class="keyword">catch</span> (BadCredentialsException e) &#123;</span><br><span class="line"><span class="comment">//捕捉到BadCredentialsException，密码不正确</span></span><br><span class="line">    <span class="keyword">return</span> forbidden(LOGIN_PASSWORD_ERROR, request);</span><br><span class="line">&#125; <span class="keyword">catch</span> (UsernameNotFoundException e) &#123;</span><br><span class="line"><span class="comment">//捕捉到UsernameNotFoundException，用户名不正确</span></span><br><span class="line">    <span class="keyword">return</span> forbidden(LOGIN_USERNAME_ERROR, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在上述代码中，如果用户名错误，应该执行"><a href="#在上述代码中，如果用户名错误，应该执行" class="headerlink" title="在上述代码中，如果用户名错误，应该执行"></a>在上述代码中，如果用户名错误，应该执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (UsernameNotFoundException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> forbidden(LOGIN_USERNAME_ERROR, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如果密码错误，应该执行"><a href="#如果密码错误，应该执行" class="headerlink" title="如果密码错误，应该执行"></a>如果密码错误，应该执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (BadCredentialsException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> forbidden(LOGIN_PASSWORD_ERROR, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上，不管是抛出什么错，最后抓到的都是BadCredentialsException</p><h1 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h1><h2 id="debug大法"><a href="#debug大法" class="headerlink" title="debug大法"></a>debug大法</h2><h3 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h3><p><img src="https://i.imgur.com/eRNlVGd.png"></p><h3 id="跟踪"><a href="#跟踪" class="headerlink" title="跟踪"></a>跟踪</h3><p>经过步进法跟踪代码，发现问题所在，位于</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractUserDetailsAuthenticationProvider</span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/7somN4i.png"></p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ol><li>loadUserByUsername方法确实抛出了UsernameNotFoundException</li><li>走到AbstractUserDetailsAuthenticationProvider的authenticate方法的时候，如果hideUserNotFoundExceptions = true，直接就覆盖了UsernameNotFoundException异常并抛出BadCredentialsException异常，这也就解释了，为什么总是捕捉到BadCredentialsException异常</li></ol><h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><p>既然已经找到了是因为<code>hideUserNotFoundExceptions = true</code>导致的问题，那把<code>hideUserNotFoundExceptions = false</code>不就完事了吗？</p><h2 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h2><p><a href="https://stackoverflow.com/questions/17439628/spring-security-custom-exception-message-from-userdetailsservice" title="参考stackoverflow大神回答">参考stackoverflow大神回答</a></p><h3 id="修改WebSecurityConfig配置，添加AuthenticationProvider-Bean"><a href="#修改WebSecurityConfig配置，添加AuthenticationProvider-Bean" class="headerlink" title="修改WebSecurityConfig配置，添加AuthenticationProvider Bean"></a>修改WebSecurityConfig配置，添加AuthenticationProvider Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationProvider <span class="title function_">daoAuthenticationProvider</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DaoAuthenticationProvider</span> <span class="variable">daoAuthenticationProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaoAuthenticationProvider</span>();</span><br><span class="line">    daoAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line">    daoAuthenticationProvider.setPasswordEncoder(passwordEncoder());</span><br><span class="line">    daoAuthenticationProvider.setHideUserNotFoundExceptions(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> daoAuthenticationProvider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置AuthenticationProvider-Bean"><a href="#配置AuthenticationProvider-Bean" class="headerlink" title="配置AuthenticationProvider Bean"></a>配置AuthenticationProvider Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureAuthentication</span><span class="params">(AuthenticationManagerBuilder authenticationManagerBuilder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    authenticationManagerBuilder</span><br><span class="line">            .authenticationProvider(daoAuthenticationProvider());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h2><p>由于以前项目中也是一样的技术栈，而且代码也差不多，登录这段逻辑可以说是完全相同，不过之前就一直都没有这个问题。反复查看之后发现，在login的代码有些不同</p><p>在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">val</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(upToken);</span><br></pre></td></tr></table></figure><p>前面还有一个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行UserDetailsService的loadUserByUsername验证用户名</span></span><br><span class="line">userDetailsService.loadUserByUsername(authenticationRequest.getUsername());</span><br></pre></td></tr></table></figure><p>该方法会直接抛出UsernameNotFoundException，而不走spring security的AbstractUserDetailsAuthenticationProvider，也就不存在被转换为BadCredentialsException了。</p><p>但是这个方案有个缺点，</p><p>如果验证用户名通过以后，再次调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">val</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(upToken);</span><br></pre></td></tr></table></figure><p>还会再执行一遍</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userDetailsService.loadUserByUsername(authenticationRequest.getUsername());</span><br></pre></td></tr></table></figure><p>该操作是冗余的，产生了不必要的数据库查询工作。</p><h2 id="推荐使用方案1"><a href="#推荐使用方案1" class="headerlink" title="推荐使用方案1"></a>推荐使用方案1</h2>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在Web应用开发中,安全一直是非常重要的一个方面。在庞大的spring生态圈中，权限校验框架也是非常完善的。其中，spring security是非常好用的。今天记录一下在开发中遇到的一个spring-security相关的问题。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Spring Security" scheme="https://blog.gcdd.top/tags/Spring-Security/"/>
    
  </entry>
  
  <entry>
    <title>常用软件集合</title>
    <link href="https://blog.gcdd.top/p/37491/"/>
    <id>https://blog.gcdd.top/p/37491/</id>
    <published>2019-01-08T08:37:14.000Z</published>
    <updated>2023-08-30T04:52:53.910Z</updated>
    
    <content type="html"><![CDATA[<p>常用软件工具收藏集，收藏了在工作生活中遇到的好用实用的软件。<span id="more"></span></p><h1 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h1><ul><li><a href="https://www.lanzous.com/i2eptwh">BeyondCompare破解版</a></li><li><a href="https://www.lanzous.com/i2eptrc">Navicat Premium 12破解版</a></li><li><a href="https://www.lanzous.com/b547205/">markdown pad2破解版</a> 密码:23w2</li><li><a href="https://www.lanzous.com/b539472/">RedisDesktopManager 免费版</a> 密码:ciq1</li><li><a href="https://www.lanzous.com/i2q4x3i">QTransate翻译工具</a></li><li><a href="https://www.lanzous.com/i2epu5g">正则表达式测试工具</a></li><li><a href="https://www.lanzous.com/i2epu2d">draw.io拓扑图工具</a></li><li><a href="https://www.lanzous.com/i2eptdi">DevCenter cassandra管理工具</a></li><li><a href="https://www.lanzous.com/i2en5xc">PostMan便携版</a></li><li><a href="https://www.lanzous.com/i2q4xyj">Git</a></li><li><a href="https://www.lanzous.com/i2q4y1c">SourceTree(Git Gui工具)</a></li><li><a href="https://www.lanzous.com/i2v3p2d">XShell5破解版</a></li></ul><h1 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h1><ul><li><a href="https://www.lanzous.com/i2q4y6h">RSS订阅工具(只限windows)</a></li><li><a href="https://www.lanzous.com/b539477">科学上网ShadowSocks</a></li><li><a href="https://www.lanzous.com/i2saiib">win10激活工具</a></li><li><a href="https://www.lanzous.com/i2t3ukj">Office安装工具</a></li><li><a href="https://www.lanzous.com/i2flrje">OCR文字识别工具</a></li><li><a href="https://www.lanzous.com/i2flr6b">GIF录制工具</a></li><li><a href="https://www.lanzous.com/i2fls4f">冰点文库下载器破解版</a></li></ul><h1 id="推荐工具"><a href="#推荐工具" class="headerlink" title="推荐工具"></a>推荐工具</h1><ul><li><a href="https://www.lanzous.com/i2zaiyj">现代化Markdown编辑工具</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;常用软件工具收藏集，收藏了在工作生活中遇到的好用实用的软件。</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="软件收藏" scheme="https://blog.gcdd.top/tags/%E8%BD%AF%E4%BB%B6%E6%94%B6%E8%97%8F/"/>
    
  </entry>
  
  <entry>
    <title>BigDecimal精确计算工具类</title>
    <link href="https://blog.gcdd.top/p/14256/"/>
    <id>https://blog.gcdd.top/p/14256/</id>
    <published>2019-01-08T07:28:49.000Z</published>
    <updated>2023-08-30T04:52:53.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在实际开发中，遇到例如货币，统计等商业计算的时候，一般需要采用java.math.BigDecimal类来进行精确计算。而这类操作通常都是可预知的，也就是通用的。所以，写了个工具类来方便以后的工作。<br>这是仓库地址：<a href="https://github.com/gcdd1993/Precise-calculation">仓库地址</a></p><span id="more"></span><h1 id="BigDecimal的构建"><a href="#BigDecimal的构建" class="headerlink" title="BigDecimal的构建"></a>BigDecimal的构建</h1><p>一般而言，我们主要从int,long,double,float来进行计算，在构建的时候推荐使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal <span class="title function_">BigDecimal</span><span class="params">(String s)</span>;</span><br></pre></td></tr></table></figure><p>因为通过double构造会损失精度，而String构造是固定的值。<br>创建以下方法作为通用BigDecimal转化器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Number -&gt; BigDecimal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Number</span>&gt; BigDecimal <span class="title function_">transform</span><span class="params">(T v)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Double) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Double.toString((Double) v));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Integer.toString((Integer) v));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Long.toString((Long) v));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Short) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Short.toString((Short) v));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Float) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(Float.toString((Float) v));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (BigDecimal) v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="BigDecimal方法"><a href="#BigDecimal方法" class="headerlink" title="BigDecimal方法"></a>BigDecimal方法</h1><p>计算类型加减乘除四种，BigDecimal提供的方法也是围绕这四种计算类型设计的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal <span class="title function_">add</span><span class="params">(BigDecimal augend)</span> <span class="comment">//加</span></span><br><span class="line">BigDecimal <span class="title function_">subtract</span><span class="params">(BigDecimal subtrahend)</span> <span class="comment">//减</span></span><br><span class="line">BigDecimal <span class="title function_">multiply</span><span class="params">(BigDecimal multiplicand)</span> <span class="comment">//乘</span></span><br><span class="line">BigDecimal <span class="title function_">divide</span><span class="params">(BigDecimal divisor, <span class="type">int</span> scale, RoundingMode roundingMode)</span> <span class="comment">//除</span></span><br></pre></td></tr></table></figure><p>工具类在加减乘除基础上，提供了</p><ol><li>链式计算，类似JDK8 lamada api，爽快丝滑的编程体验</li><li>支持集合求和、求平均</li><li>支持复合计算，例如2*(2+8)</li></ol><h1 id="BigDecimal精确计算工具类实用案例"><a href="#BigDecimal精确计算工具类实用案例" class="headerlink" title="BigDecimal精确计算工具类实用案例"></a>BigDecimal精确计算工具类实用案例</h1><h2 id="精确转换为BigDecimal，不指定精度"><a href="#精确转换为BigDecimal，不指定精度" class="headerlink" title="精确转换为BigDecimal，不指定精度"></a>精确转换为BigDecimal，不指定精度</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(PreciseCalculations.transform(<span class="number">121.11</span>)); <span class="comment">//转化double -&gt; 121.11</span></span><br><span class="line">System.out.println(PreciseCalculations.transform(Integer.MAX_VALUE)); <span class="comment">//转化int -&gt; 2147483647</span></span><br><span class="line">System.out.println(PreciseCalculations.transform(Short.MAX_VALUE)); <span class="comment">//转化Short -&gt; 32767</span></span><br><span class="line">System.out.println(PreciseCalculations.transform(Long.MAX_VALUE)); <span class="comment">//转化long -&gt; 9223372036854775807</span></span><br><span class="line">System.out.println(PreciseCalculations.transform(<span class="number">121.19F</span>)); <span class="comment">//转化float -&gt; 121.19</span></span><br></pre></td></tr></table></figure><h2 id="精确转换为BigDecimal，指定精度"><a href="#精确转换为BigDecimal，指定精度" class="headerlink" title="精确转换为BigDecimal，指定精度"></a>精确转换为BigDecimal，指定精度</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(PreciseCalculations.transform(<span class="number">121.1111111111</span>, <span class="number">5</span>)); <span class="comment">//精度大于指定精度 -&gt; 121.11111</span></span><br><span class="line">System.out.println(PreciseCalculations.transform(<span class="number">121.11</span>, <span class="number">5</span>)); <span class="comment">//精度小于指定精度，补零 -&gt; 121.11000</span></span><br></pre></td></tr></table></figure><h2 id="加减乘除"><a href="#加减乘除" class="headerlink" title="加减乘除"></a>加减乘除</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(PreciseCalculations.add(<span class="number">12.11</span>, <span class="number">12.11</span>)); <span class="comment">//加法 -&gt; 24.22</span></span><br><span class="line">System.out.println(PreciseCalculations.subtract(<span class="number">12.11</span>, <span class="number">12.11</span>)); <span class="comment">//减法 -&gt; 0.00</span></span><br><span class="line">System.out.println(PreciseCalculations.multiply(<span class="number">12.11</span>, <span class="number">12.11</span>)); <span class="comment">//乘法 -&gt; 146.6521</span></span><br><span class="line">System.out.println(PreciseCalculations.divide(<span class="number">12.11</span>, <span class="number">2.35</span>, <span class="number">5</span>)); <span class="comment">//除法 -&gt; 5.15319</span></span><br></pre></td></tr></table></figure><h2 id="负数计算"><a href="#负数计算" class="headerlink" title="负数计算"></a>负数计算</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -1.11 * 13 - 90 = -104.43</span></span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">PreciseCalculation</span>(-<span class="number">1.11</span>).multiply(<span class="number">13</span>).add(-<span class="number">90</span>).getValue()); </span><br><span class="line"><span class="comment">// -11.11111111 + 90 = 78.88888889</span></span><br><span class="line">System.out.println(PreciseCalculations.add(-<span class="number">11.11111111</span>,<span class="number">90</span>));</span><br></pre></td></tr></table></figure><h2 id="集合-求和-求平均值"><a href="#集合-求和-求平均值" class="headerlink" title="集合 求和 求平均值"></a>集合 求和 求平均值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Double&gt; list = Arrays.asList(<span class="number">12.11D</span>, <span class="number">13.11D</span>, <span class="number">14.11D</span>, <span class="number">15.321312D</span>);</span><br><span class="line">System.out.println(PreciseCalculations.sum(list)); <span class="comment">//求和 -&gt; Optional[54.651312]</span></span><br><span class="line">System.out.println(PreciseCalculations.average(list)); <span class="comment">//平均值 -&gt; Optional[13.66283]</span></span><br><span class="line">System.out.println(PreciseCalculations.average(Collections.emptyList())); <span class="comment">//空集合 -&gt; Optional.empty</span></span><br></pre></td></tr></table></figure><h2 id="复合计算"><a href="#复合计算" class="headerlink" title="复合计算"></a>复合计算</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算 121.11 * 13 / 60 + 100 - 12 = 114.24050</span></span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">PreciseCalculation</span>(<span class="number">121.11</span>).multiply(<span class="number">13</span>).divide(<span class="number">60</span>, <span class="number">5</span>).add(<span class="number">100</span>).subtract(<span class="number">12</span>).getValue());</span><br><span class="line"><span class="comment">//计算 121.11 * 128.59 / (100 + 12) - 100 = 39.04942</span></span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">PreciseCalculation</span>(<span class="number">121.11</span>).multiply(<span class="number">128.59</span>).divide(</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">PreciseCalculation</span>(<span class="number">100</span>).add(<span class="number">12</span>), <span class="number">5</span>).subtract(<span class="number">100</span>).getValue());</span><br></pre></td></tr></table></figure><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul><li>PreciseCalculation 核心类，提供加减乘除、集合精确计算方法，内部维护value值，每次计算该value都会改变。</li><li>PreciseCalculations 基于上述的工具类，方便简单计算时使用。</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在实际开发中，遇到例如货币，统计等商业计算的时候，一般需要采用java.math.BigDecimal类来进行精确计算。而这类操作通常都是可预知的，也就是通用的。所以，写了个工具类来方便以后的工作。&lt;br&gt;这是仓库地址：&lt;a href=&quot;https://github.com/gcdd1993/Precise-calculation&quot;&gt;仓库地址&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="个人笔记" scheme="https://blog.gcdd.top/categories/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://blog.gcdd.top/tags/Java/"/>
    
  </entry>
  
</feed>
